/* abcDE_full.js v5.0.55 */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=a.document,e=c.slice,f=c.concat,g=c.push,h=c.indexOf,i={},j=i.toString,k=i.hasOwnProperty,l={},m="1.12.0",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return e.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:e.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a){return n.each(this,a)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(e.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor()},push:g,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(e=arguments[h]))for(d in e)a=g[d],c=e[d],g!==c&&(j&&c&&(n.isPlainObject(c)||(b=n.isArray(c)))?(b?(b=!1,f=a&&n.isArray(a)?a:[]):f=a&&n.isPlainObject(a)?a:{},g[d]=n.extend(j,f,c)):void 0!==c&&(g[d]=c));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray||function(a){return"array"===n.type(a)},isWindow:function(a){return null!=a&&a==a.window},isNumeric:function(a){var b=a&&a.toString();return!n.isArray(a)&&b-parseFloat(b)+1>=0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==n.type(a)||a.nodeType||n.isWindow(a))return!1;try{if(a.constructor&&!k.call(a,"constructor")&&!k.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}if(!l.ownFirst)for(b in a)return k.call(a,b);for(b in a);return void 0===b||k.call(a,b)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?i[j.call(a)]||"object":typeof a},globalEval:function(b){b&&n.trim(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b){var c,d=0;if(s(a)){for(c=a.length;c>d;d++)if(b.call(a[d],d,a[d])===!1)break}else for(d in a)if(b.call(a[d],d,a[d])===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):g.call(c,a)),c},inArray:function(a,b,c){var d;if(b){if(h)return h.call(b,a,c);for(d=b.length,c=c?0>c?Math.max(0,d+c):c:0;d>c;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,b){var c=+b.length,d=0,e=a.length;while(c>d)a[e++]=b[d++];if(c!==c)while(void 0!==b[d])a[e++]=b[d++];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,e,g=0,h=[];if(s(a))for(d=a.length;d>g;g++)e=b(a[g],g,c),null!=e&&h.push(e);else for(g in a)e=b(a[g],g,c),null!=e&&h.push(e);return f.apply([],h)},guid:1,proxy:function(a,b){var c,d,f;return"string"==typeof b&&(f=a[b],b=a,a=f),n.isFunction(a)?(c=e.call(arguments,2),d=function(){return a.apply(b||this,c.concat(e.call(arguments)))},d.guid=a.guid=a.guid||n.guid++,d):void 0},now:function(){return+new Date},support:l}),"function"==typeof Symbol&&(n.fn[Symbol.iterator]=c[Symbol.iterator]),n.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(a,b){i["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=!!a&&"length"in a&&a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+1*new Date,v=a.document,w=0,x=0,y=ga(),z=ga(),A=ga(),B=function(a,b){return a===b&&(l=!0),0},C=1<<31,D={}.hasOwnProperty,E=[],F=E.pop,G=E.push,H=E.push,I=E.slice,J=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},K="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",N="\\["+L+"*("+M+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+M+"))|)"+L+"*\\]",O=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+N+")*)|.*)\\)|)",P=new RegExp(L+"+","g"),Q=new RegExp("^"+L+"+|((?:^|[^\\\\])(?:\\\\.)*)"+L+"+$","g"),R=new RegExp("^"+L+"*,"+L+"*"),S=new RegExp("^"+L+"*([>+~]|"+L+")"+L+"*"),T=new RegExp("="+L+"*([^\\]'\"]*?)"+L+"*\\]","g"),U=new RegExp(O),V=new RegExp("^"+M+"$"),W={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M+"|[*])"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+L+"*(even|odd|(([+-]|)(\\d*)n|)"+L+"*(?:([+-]|)"+L+"*(\\d+)|))"+L+"*\\)|)","i"),bool:new RegExp("^(?:"+K+")$","i"),needsContext:new RegExp("^"+L+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+L+"*((?:-\\d)?\\d*)"+L+"*\\)|)(?=[^-]|$)","i")},X=/^(?:input|select|textarea|button)$/i,Y=/^h\d$/i,Z=/^[^{]+\{\s*\[native \w/,$=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,_=/[+~]/,aa=/'|\\/g,ba=new RegExp("\\\\([\\da-f]{1,6}"+L+"?|("+L+")|.)","ig"),ca=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},da=function(){m()};try{H.apply(E=I.call(v.childNodes),v.childNodes),E[v.childNodes.length].nodeType}catch(ea){H={apply:E.length?function(a,b){G.apply(a,I.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function fa(a,b,d,e){var f,h,j,k,l,o,r,s,w=b&&b.ownerDocument,x=b?b.nodeType:9;if(d=d||[],"string"!=typeof a||!a||1!==x&&9!==x&&11!==x)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==x&&(o=$.exec(a)))if(f=o[1]){if(9===x){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(w&&(j=w.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(o[2])return H.apply(d,b.getElementsByTagName(a)),d;if((f=o[3])&&c.getElementsByClassName&&b.getElementsByClassName)return H.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+" "]&&(!q||!q.test(a))){if(1!==x)w=b,s=a;else if("object"!==b.nodeName.toLowerCase()){(k=b.getAttribute("id"))?k=k.replace(aa,"\\$&"):b.setAttribute("id",k=u),r=g(a),h=r.length,l=V.test(k)?"#"+k:"[id='"+k+"']";while(h--)r[h]=l+" "+qa(r[h]);s=r.join(","),w=_.test(a)&&oa(b.parentNode)||b}if(s)try{return H.apply(d,w.querySelectorAll(s)),d}catch(y){}finally{k===u&&b.removeAttribute("id")}}}return i(a.replace(Q,"$1"),b,d,e)}function ga(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function ha(a){return a[u]=!0,a}function ia(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ja(a,b){var c=a.split("|"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function ka(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||C)-(~a.sourceIndex||C);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function la(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function na(a){return ha(function(b){return b=+b,ha(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function oa(a){return a&&"undefined"!=typeof a.getElementsByTagName&&a}c=fa.support={},f=fa.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=fa.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener("unload",da,!1):e.attachEvent&&e.attachEvent("onunload",da)),c.attributes=ia(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=ia(function(a){return a.appendChild(n.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Z.test(n.getElementsByClassName),c.getById=ia(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if("undefined"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){var c="undefined"!=typeof a.getAttributeNode&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return"undefined"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return"undefined"!=typeof b.getElementsByClassName&&p?b.getElementsByClassName(a):void 0},r=[],q=[],(c.qsa=Z.test(n.querySelectorAll))&&(ia(function(a){o.appendChild(a).innerHTML="<a id='"+u+"'></a><select id='"+u+"-\r\\' msallowcapture=''><option selected=''></option></select>",a.querySelectorAll("[msallowcapture^='']").length&&q.push("[*^$]="+L+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||q.push("\\["+L+"*(?:value|"+K+")"),a.querySelectorAll("[id~="+u+"-]").length||q.push("~="),a.querySelectorAll(":checked").length||q.push(":checked"),a.querySelectorAll("a#"+u+"+*").length||q.push(".#.+[+~]")}),ia(function(a){var b=n.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&q.push("name"+L+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),q.push(",.*:")})),(c.matchesSelector=Z.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ia(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"[s!='']:x"),r.push("!=",O)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=Z.test(o.compareDocumentPosition),t=b||Z.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?J(k,a)-J(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?J(k,a)-J(k,b):0;if(e===f)return ka(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?ka(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},fa.matches=function(a,b){return fa(a,null,null,b)},fa.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(T,"='$1']"),c.matchesSelector&&p&&!A[b+" "]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return fa(b,n,null,[a]).length>0},fa.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},fa.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&D.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},fa.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},fa.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=fa.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=fa.selectors={cacheLength:50,createPseudo:ha,match:W,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ba,ca),a[3]=(a[3]||a[4]||a[5]||"").replace(ba,ca),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||fa.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&fa.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return W.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&U.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ba,ca).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+" "];return b||(b=new RegExp("(^|"+L+")"+a+"("+L+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!=typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=fa.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e.replace(P," ")+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||fa.error("unsupported pseudo: "+a);return e[u]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ha(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=J(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ha(function(a){var b=[],c=[],d=h(a.replace(Q,"$1"));return d[u]?ha(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ha(function(a){return function(b){return fa(a,b).length>0}}),contains:ha(function(a){return a=a.replace(ba,ca),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ha(function(a){return V.test(a||"")||fa.error("unsupported lang: "+a),a=a.replace(ba,ca).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Y.test(a.nodeName)},input:function(a){return X.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:na(function(){return[0]}),last:na(function(a,b){return[b-1]}),eq:na(function(a,b,c){return[0>c?c+b:c]}),even:na(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:na(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:na(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:na(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=la(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=ma(b);function pa(){}pa.prototype=d.filters=d.pseudos,d.setFilters=new pa,g=fa.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=R.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=S.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(Q," ")}),h=h.slice(c.length));for(g in d.filter)!(e=W[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?fa.error(a):z(a,i).slice(0)};function qa(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function ra(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j,k=[w,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(j=b[u]||(b[u]={}),i=j[b.uniqueID]||(j[b.uniqueID]={}),(h=i[d])&&h[0]===w&&h[1]===f)return k[2]=h[2];if(i[d]=k,k[2]=a(b,c,g))return!0}}}function sa(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function ta(a,b,c){for(var d=0,e=b.length;e>d;d++)fa(a,b[d],c);return c}function ua(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function va(a,b,c,d,e,f){return d&&!d[u]&&(d=va(d)),e&&!e[u]&&(e=va(e,f)),ha(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||ta(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:ua(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=ua(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?J(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=ua(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):H.apply(g,r)})}function wa(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[" "],i=g?1:0,k=ra(function(a){return a===b},h,!0),l=ra(function(a){return J(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];f>i;i++)if(c=d.relative[a[i].type])m=[ra(sa(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;f>e;e++)if(d.relative[a[e].type])break;return va(i>1&&sa(m),i>1&&qa(a.slice(0,i-1).concat({value:" "===a[i-2].type?"*":""})).replace(Q,"$1"),c,e>i&&wa(a.slice(i,e)),f>e&&wa(a=a.slice(e)),f>e&&qa(a))}m.push(c)}return sa(m)}function xa(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s="0",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG("*",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=F.call(i));u=ua(u)}H.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&fa.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ha(f):f}return h=fa.compile=function(a,b){var c,d=[],e=[],f=A[a+" "];if(!f){b||(b=g(a)),c=b.length;while(c--)f=wa(b[c]),f[u]?d.push(f):e.push(f);f=A(a,xa(e,d)),f.selector=a}return f},i=fa.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&"ID"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(ba,ca),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=W.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(ba,ca),_.test(j[0].type)&&oa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&qa(j),!a)return H.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||_.test(a)&&oa(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ia(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ia(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||ja("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&ia(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||ja("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),ia(function(a){return null==a.getAttribute("disabled")})||ja(K,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),fa}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.uniqueSort=n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&n(a).is(c))break;d.push(a)}return d},v=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},w=n.expr.match.needsContext,x=/^<([\w-]+)\s*\/?>(?:<\/\1>|)$/,y=/^.[^:#\[\.,]*$/;function z(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(y.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return n.inArray(a,b)>-1!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=[],d=this,e=d.length;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;e>b;b++)if(n.contains(d[b],this))return!0}));for(b=0;e>b;b++)n.find(a,d[b],c);return c=this.pushStack(e>1?n.unique(c):c),c.selector=this.selector?this.selector+" "+a:a,c},filter:function(a){return this.pushStack(z(this,a||[],!1))},not:function(a){return this.pushStack(z(this,a||[],!0))},is:function(a){return!!z(this,"string"==typeof a&&w.test(a)?n(a):a||[],!1).length}});var A,B=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=n.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||A,"string"==typeof a){if(e="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&a.length>=3?[null,a,null]:B.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),x.test(e[1])&&n.isPlainObject(b))for(e in b)n.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}if(f=d.getElementById(e[2]),f&&f.parentNode){if(f.id!==e[2])return A.find(a);this.length=1,this[0]=f}return this.context=d,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?"undefined"!=typeof c.ready?c.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};C.prototype=n.fn,A=n(d);var D=/^(?:parents|prev(?:Until|All))/,E={children:!0,contents:!0,next:!0,prev:!0};n.fn.extend({has:function(a){var b,c=n(a,this),d=c.length;return this.filter(function(){for(b=0;d>b;b++)if(n.contains(this,c[b]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=w.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.uniqueSort(f):f)},index:function(a){return a?"string"==typeof a?n.inArray(this[0],n(a)):n.inArray(a.jquery?a[0]:a,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.uniqueSort(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function F(a,b){do a=a[b];while(a&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return u(a,"parentNode")},parentsUntil:function(a,b,c){return u(a,"parentNode",c)},next:function(a){return F(a,"nextSibling")},prev:function(a){return F(a,"previousSibling")},nextAll:function(a){return u(a,"nextSibling")},prevAll:function(a){return u(a,"previousSibling")},nextUntil:function(a,b,c){return u(a,"nextSibling",c)},prevUntil:function(a,b,c){return u(a,"previousSibling",c)},siblings:function(a){return v((a.parentNode||{}).firstChild,a)},children:function(a){return v(a.firstChild)},contents:function(a){return n.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(E[a]||(e=n.uniqueSort(e)),D.test(a)&&(e=e.reverse())),this.pushStack(e)}});var G=/\S+/g;function H(a){var b={};return n.each(a.match(G)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?H(a):n.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stopOnFalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:"")},j={add:function(){return f&&(c&&!b&&(h=f.length-1,g.push(c)),function d(b){n.each(b,function(b,c){n.isFunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&"string"!==n.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return n.each(arguments,function(a,b){var c;while((c=n.inArray(b,f,c))>-1)f.splice(c,1),h>=c&&h--}),this},has:function(a){return a?n.inArray(a,f)>-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c="",this},disabled:function(){return!f},lock:function(){return e=!0,c||j.disable(),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().progress(c.notify).done(c.resolve).fail(c.reject):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=e.call(arguments),d=c.length,f=1!==d||a&&n.isFunction(a.promise)?d:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(d){b[a]=this,c[a]=arguments.length>1?e.call(arguments):d,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(d>1)for(i=new Array(d),j=new Array(d),k=new Array(d);d>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().progress(h(b,j,i)).done(h(b,k,c)).fail(g.reject):--f;return f||g.resolveWith(k,c),g.promise()}});var I;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){(a===!0?--n.readyWait:n.isReady)||(n.isReady=!0,a!==!0&&--n.readyWait>0||(I.resolveWith(d,[n]),n.fn.triggerHandler&&(n(d).triggerHandler("ready"),n(d).off("ready"))))}});function J(){d.addEventListener?(d.removeEventListener("DOMContentLoaded",K),a.removeEventListener("load",K)):(d.detachEvent("onreadystatechange",K),a.detachEvent("onload",K))}function K(){(d.addEventListener||"load"===a.event.type||"complete"===d.readyState)&&(J(),n.ready())}n.ready.promise=function(b){if(!I)if(I=n.Deferred(),"complete"===d.readyState)a.setTimeout(n.ready);else if(d.addEventListener)d.addEventListener("DOMContentLoaded",K),a.addEventListener("load",K);else{d.attachEvent("onreadystatechange",K),a.attachEvent("onload",K);var c=!1;try{c=null==a.frameElement&&d.documentElement}catch(e){}c&&c.doScroll&&!function f(){if(!n.isReady){try{c.doScroll("left")}catch(b){return a.setTimeout(f,50)}J(),n.ready()}}()}return I.promise(b)},n.ready.promise();var L;for(L in n(l))break;l.ownFirst="0"===L,l.inlineBlockNeedsLayout=!1,n(function(){var a,b,c,e;c=d.getElementsByTagName("body")[0],c&&c.style&&(b=d.createElement("div"),e=d.createElement("div"),e.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(e).appendChild(b),"undefined"!=typeof b.style.zoom&&(b.style.cssText="display:inline;margin:0;border:0;padding:1px;width:1px;zoom:1",l.inlineBlockNeedsLayout=a=3===b.offsetWidth,a&&(c.style.zoom=1)),c.removeChild(e))}),function(){var a=d.createElement("div");l.deleteExpando=!0;try{delete a.test}catch(b){l.deleteExpando=!1}a=null}();var M=function(a){var b=n.noData[(a.nodeName+" ").toLowerCase()],c=+a.nodeType||1;return 1!==c&&9!==c?!1:!b||b!==!0&&a.getAttribute("classid")===b},N=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function P(a,b,c){if(void 0===c&&1===a.nodeType){var d="data-"+b.replace(O,"-$1").toLowerCase();if(c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?n.parseJSON(c):c}catch(e){}n.data(a,b,c)}else c=void 0}return c}function Q(a){var b;for(b in a)if(("data"!==b||!n.isEmptyObject(a[b]))&&"toJSON"!==b)return!1;
return!0}function R(a,b,d,e){if(M(a)){var f,g,h=n.expando,i=a.nodeType,j=i?n.cache:a,k=i?a[h]:a[h]&&h;if(k&&j[k]&&(e||j[k].data)||void 0!==d||"string"!=typeof b)return k||(k=i?a[h]=c.pop()||n.guid++:h),j[k]||(j[k]=i?{}:{toJSON:n.noop}),("object"==typeof b||"function"==typeof b)&&(e?j[k]=n.extend(j[k],b):j[k].data=n.extend(j[k].data,b)),g=j[k],e||(g.data||(g.data={}),g=g.data),void 0!==d&&(g[n.camelCase(b)]=d),"string"==typeof b?(f=g[b],null==f&&(f=g[n.camelCase(b)])):f=g,f}}function S(a,b,c){if(M(a)){var d,e,f=a.nodeType,g=f?n.cache:a,h=f?a[n.expando]:n.expando;if(g[h]){if(b&&(d=c?g[h]:g[h].data)){n.isArray(b)?b=b.concat(n.map(b,n.camelCase)):b in d?b=[b]:(b=n.camelCase(b),b=b in d?[b]:b.split(" ")),e=b.length;while(e--)delete d[b[e]];if(c?!Q(d):!n.isEmptyObject(d))return}(c||(delete g[h].data,Q(g[h])))&&(f?n.cleanData([a],!0):l.deleteExpando||g!=g.window?delete g[h]:g[h]=void 0)}}}n.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(a){return a=a.nodeType?n.cache[a[n.expando]]:a[n.expando],!!a&&!Q(a)},data:function(a,b,c){return R(a,b,c)},removeData:function(a,b){return S(a,b)},_data:function(a,b,c){return R(a,b,c,!0)},_removeData:function(a,b){return S(a,b,!0)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=n.data(f),1===f.nodeType&&!n._data(f,"parsedAttrs"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),P(f,d,e[d])));n._data(f,"parsedAttrs",!0)}return e}return"object"==typeof a?this.each(function(){n.data(this,a)}):arguments.length>1?this.each(function(){n.data(this,a,b)}):f?P(f,a,n.data(f,a)):void 0},removeData:function(a){return this.each(function(){n.removeData(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=n._data(a,b),c&&(!d||n.isArray(c)?d=n._data(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return n._data(a,c)||n._data(a,c,{empty:n.Callbacks("once memory").add(function(){n._removeData(a,b+"queue"),n._removeData(a,c)})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=n._data(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}}),function(){var a;l.shrinkWrapBlocks=function(){if(null!=a)return a;a=!1;var b,c,e;return c=d.getElementsByTagName("body")[0],c&&c.style?(b=d.createElement("div"),e=d.createElement("div"),e.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(e).appendChild(b),"undefined"!=typeof b.style.zoom&&(b.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:1px;width:1px;zoom:1",b.appendChild(d.createElement("div")).style.width="5px",a=3!==b.offsetWidth),c.removeChild(e),a):void 0}}();var T=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,U=new RegExp("^(?:([+-])=|)("+T+")([a-z%]*)$","i"),V=["Top","Right","Bottom","Left"],W=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)};function X(a,b,c,d){var e,f=1,g=20,h=d?function(){return d.cur()}:function(){return n.css(a,b,"")},i=h(),j=c&&c[3]||(n.cssNumber[b]?"":"px"),k=(n.cssNumber[b]||"px"!==j&&+i)&&U.exec(n.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do f=f||".5",k/=f,n.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return c&&(k=+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var Y=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)Y(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},Z=/^(?:checkbox|radio)$/i,$=/<([\w:-]+)/,_=/^$|\/(?:java|ecma)script/i,aa=/^\s+/,ba="abbr|article|aside|audio|bdi|canvas|data|datalist|details|dialog|figcaption|figure|footer|header|hgroup|main|mark|meter|nav|output|picture|progress|section|summary|template|time|video";function ca(a){var b=ba.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}!function(){var a=d.createElement("div"),b=d.createDocumentFragment(),c=d.createElement("input");a.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",l.leadingWhitespace=3===a.firstChild.nodeType,l.tbody=!a.getElementsByTagName("tbody").length,l.htmlSerialize=!!a.getElementsByTagName("link").length,l.html5Clone="<:nav></:nav>"!==d.createElement("nav").cloneNode(!0).outerHTML,c.type="checkbox",c.checked=!0,b.appendChild(c),l.appendChecked=c.checked,a.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!a.cloneNode(!0).lastChild.defaultValue,b.appendChild(a),c=d.createElement("input"),c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),a.appendChild(c),l.checkClone=a.cloneNode(!0).cloneNode(!0).lastChild.checked,l.noCloneEvent=!!a.addEventListener,a[n.expando]=1,l.attributes=!a.getAttribute(n.expando)}();var da={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:l.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]};da.optgroup=da.option,da.tbody=da.tfoot=da.colgroup=da.caption=da.thead,da.th=da.td;function ea(a,b){var c,d,e=0,f="undefined"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||"*"):"undefined"!=typeof a.querySelectorAll?a.querySelectorAll(b||"*"):void 0;if(!f)for(f=[],c=a.childNodes||a;null!=(d=c[e]);e++)!b||n.nodeName(d,b)?f.push(d):n.merge(f,ea(d,b));return void 0===b||b&&n.nodeName(a,b)?n.merge([a],f):f}function fa(a,b){for(var c,d=0;null!=(c=a[d]);d++)n._data(c,"globalEval",!b||n._data(b[d],"globalEval"))}var ga=/<|&#?\w+;/,ha=/<tbody/i;function ia(a){Z.test(a.type)&&(a.defaultChecked=a.checked)}function ja(a,b,c,d,e){for(var f,g,h,i,j,k,m,o=a.length,p=ca(b),q=[],r=0;o>r;r++)if(g=a[r],g||0===g)if("object"===n.type(g))n.merge(q,g.nodeType?[g]:g);else if(ga.test(g)){i=i||p.appendChild(b.createElement("div")),j=($.exec(g)||["",""])[1].toLowerCase(),m=da[j]||da._default,i.innerHTML=m[1]+n.htmlPrefilter(g)+m[2],f=m[0];while(f--)i=i.lastChild;if(!l.leadingWhitespace&&aa.test(g)&&q.push(b.createTextNode(aa.exec(g)[0])),!l.tbody){g="table"!==j||ha.test(g)?"<table>"!==m[1]||ha.test(g)?0:i:i.firstChild,f=g&&g.childNodes.length;while(f--)n.nodeName(k=g.childNodes[f],"tbody")&&!k.childNodes.length&&g.removeChild(k)}n.merge(q,i.childNodes),i.textContent="";while(i.firstChild)i.removeChild(i.firstChild);i=p.lastChild}else q.push(b.createTextNode(g));i&&p.removeChild(i),l.appendChecked||n.grep(ea(q,"input"),ia),r=0;while(g=q[r++])if(d&&n.inArray(g,d)>-1)e&&e.push(g);else if(h=n.contains(g.ownerDocument,g),i=ea(p.appendChild(g),"script"),h&&fa(i),c){f=0;while(g=i[f++])_.test(g.type||"")&&c.push(g)}return i=null,p}!function(){var b,c,e=d.createElement("div");for(b in{submit:!0,change:!0,focusin:!0})c="on"+b,(l[b]=c in a)||(e.setAttribute(c,"t"),l[b]=e.attributes[c].expando===!1);e=null}();var ka=/^(?:input|select|textarea)$/i,la=/^key/,ma=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,na=/^(?:focusinfocus|focusoutblur)$/,oa=/^([^.]*)(?:\.(.+)|)/;function pa(){return!0}function qa(){return!1}function ra(){try{return d.activeElement}catch(a){}}function sa(a,b,c,d,e,f){var g,h;if("object"==typeof b){"string"!=typeof c&&(d=d||c,c=void 0);for(h in b)sa(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&("string"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=qa;else if(!e)return a;return 1===f&&(g=e,e=function(a){return n().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=n.guid++)),a.each(function(){n.event.add(this,b,e,d,c)})}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n._data(a);if(r){c.handler&&(i=c,c=i.handler,e=i.selector),c.guid||(c.guid=n.guid++),(g=r.events)||(g=r.events={}),(k=r.handle)||(k=r.handle=function(a){return"undefined"==typeof n||a&&n.event.triggered===a.type?void 0:n.event.dispatch.apply(k.elem,arguments)},k.elem=a),b=(b||"").match(G)||[""],h=b.length;while(h--)f=oa.exec(b[h])||[],o=q=f[1],p=(f[2]||"").split(".").sort(),o&&(j=n.event.special[o]||{},o=(e?j.delegateType:j.bindType)||o,j=n.event.special[o]||{},l=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},i),(m=g[o])||(m=g[o]=[],m.delegateCount=0,j.setup&&j.setup.call(a,d,p,k)!==!1||(a.addEventListener?a.addEventListener(o,k,!1):a.attachEvent&&a.attachEvent("on"+o,k))),j.add&&(j.add.call(a,l),l.handler.guid||(l.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,l):m.push(l),n.event.global[o]=!0);a=null}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n.hasData(a)&&n._data(a);if(r&&(k=r.events)){b=(b||"").match(G)||[""],j=b.length;while(j--)if(h=oa.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=k[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),i=f=m.length;while(f--)g=m[f],!e&&q!==g.origType||c&&c.guid!==g.guid||h&&!h.test(g.namespace)||d&&d!==g.selector&&("**"!==d||!g.selector)||(m.splice(f,1),g.selector&&m.delegateCount--,l.remove&&l.remove.call(a,g));i&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete k[o])}else for(o in k)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(k)&&(delete r.handle,n._removeData(a,"events"))}},trigger:function(b,c,e,f){var g,h,i,j,l,m,o,p=[e||d],q=k.call(b,"type")?b.type:b,r=k.call(b,"namespace")?b.namespace.split("."):[];if(i=m=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!na.test(q+n.event.triggered)&&(q.indexOf(".")>-1&&(r=q.split("."),q=r.shift(),r.sort()),h=q.indexOf(":")<0&&"on"+q,b=b[n.expando]?b:new n.Event(q,"object"==typeof b&&b),b.isTrigger=f?2:3,b.namespace=r.join("."),b.rnamespace=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=e),c=null==c?[b]:n.makeArray(c,[b]),l=n.event.special[q]||{},f||!l.trigger||l.trigger.apply(e,c)!==!1)){if(!f&&!l.noBubble&&!n.isWindow(e)){for(j=l.delegateType||q,na.test(j+q)||(i=i.parentNode);i;i=i.parentNode)p.push(i),m=i;m===(e.ownerDocument||d)&&p.push(m.defaultView||m.parentWindow||a)}o=0;while((i=p[o++])&&!b.isPropagationStopped())b.type=o>1?j:l.bindType||q,g=(n._data(i,"events")||{})[b.type]&&n._data(i,"handle"),g&&g.apply(i,c),g=h&&i[h],g&&g.apply&&M(i)&&(b.result=g.apply(i,c),b.result===!1&&b.preventDefault());if(b.type=q,!f&&!b.isDefaultPrevented()&&(!l._default||l._default.apply(p.pop(),c)===!1)&&M(e)&&h&&e[q]&&!n.isWindow(e)){m=e[h],m&&(e[h]=null),n.event.triggered=q;try{e[q]()}catch(s){}n.event.triggered=void 0,m&&(e[h]=m)}return b.result}},dispatch:function(a){a=n.event.fix(a);var b,c,d,f,g,h=[],i=e.call(arguments),j=(n._data(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())(!a.rnamespace||a.rnamespace.test(g.namespace))&&(a.handleObj=g,a.data=g.data,d=((n.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==d&&(a.result=d)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&("click"!==a.type||isNaN(a.button)||a.button<1))for(;i!=this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?n(e,this).index(i)>-1:n.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},fix:function(a){if(a[n.expando])return a;var b,c,e,f=a.type,g=a,h=this.fixHooks[f];h||(this.fixHooks[f]=h=ma.test(f)?this.mouseHooks:la.test(f)?this.keyHooks:{}),e=h.props?this.props.concat(h.props):this.props,a=new n.Event(g),b=e.length;while(b--)c=e[b],a[c]=g[c];return a.target||(a.target=g.srcElement||d),3===a.target.nodeType&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,h.filter?h.filter(a,g):a},props:"altKey bubbles cancelable ctrlKey currentTarget detail eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,e,f,g=b.button,h=b.fromElement;return null==a.pageX&&null!=b.clientX&&(e=a.target.ownerDocument||d,f=e.documentElement,c=e.body,a.pageX=b.clientX+(f&&f.scrollLeft||c&&c.scrollLeft||0)-(f&&f.clientLeft||c&&c.clientLeft||0),a.pageY=b.clientY+(f&&f.scrollTop||c&&c.scrollTop||0)-(f&&f.clientTop||c&&c.clientTop||0)),!a.relatedTarget&&h&&(a.relatedTarget=h===a.target?b.toElement:h),a.which||void 0===g||(a.which=1&g?1:2&g?3:4&g?2:0),a}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==ra()&&this.focus)try{return this.focus(),!1}catch(a){}},delegateType:"focusin"},blur:{trigger:function(){return this===ra()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return n.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c){var d=n.extend(new n.Event,c,{type:a,isSimulated:!0});n.event.trigger(d,null,b),d.isDefaultPrevented()&&c.preventDefault()}},n.removeEvent=d.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)}:function(a,b,c){var d="on"+b;a.detachEvent&&("undefined"==typeof a[d]&&(a[d]=null),a.detachEvent(d,c))},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?pa:qa):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={constructor:n.Event,isDefaultPrevented:qa,isPropagationStopped:qa,isImmediatePropagationStopped:qa,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=pa,a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=pa,a&&!this.isSimulated&&(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=pa,a&&a.stopImmediatePropagation&&a.stopImmediatePropagation(),this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!n.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),l.submit||(n.event.special.submit={setup:function(){return n.nodeName(this,"form")?!1:void n.event.add(this,"click._submit keypress._submit",function(a){var b=a.target,c=n.nodeName(b,"input")||n.nodeName(b,"button")?n.prop(b,"form"):void 0;c&&!n._data(c,"submit")&&(n.event.add(c,"submit._submit",function(a){a._submitBubble=!0}),n._data(c,"submit",!0))})},postDispatch:function(a){a._submitBubble&&(delete a._submitBubble,this.parentNode&&!a.isTrigger&&n.event.simulate("submit",this.parentNode,a))},teardown:function(){return n.nodeName(this,"form")?!1:void n.event.remove(this,"._submit")}}),l.change||(n.event.special.change={setup:function(){return ka.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(n.event.add(this,"propertychange._change",function(a){"checked"===a.originalEvent.propertyName&&(this._justChanged=!0)}),n.event.add(this,"click._change",function(a){this._justChanged&&!a.isTrigger&&(this._justChanged=!1),n.event.simulate("change",this,a)})),!1):void n.event.add(this,"beforeactivate._change",function(a){var b=a.target;ka.test(b.nodeName)&&!n._data(b,"change")&&(n.event.add(b,"change._change",function(a){!this.parentNode||a.isSimulated||a.isTrigger||n.event.simulate("change",this.parentNode,a)}),n._data(b,"change",!0))})},handle:function(a){var b=a.target;return this!==b||a.isSimulated||a.isTrigger||"radio"!==b.type&&"checkbox"!==b.type?a.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return n.event.remove(this,"._change"),!ka.test(this.nodeName)}}),l.focusin||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a))};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=n._data(d,b);e||d.addEventListener(a,c,!0),n._data(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=n._data(d,b)-1;e?n._data(d,b,e):(d.removeEventListener(a,c,!0),n._removeData(d,b))}}}),n.fn.extend({on:function(a,b,c,d){return sa(this,a,b,c,d)},one:function(a,b,c,d){return sa(this,a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=qa),this.each(function(){n.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}});var ta=/ jQuery\d+="(?:null|\d+)"/g,ua=new RegExp("<(?:"+ba+")[\\s/>]","i"),va=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi,wa=/<script|<style|<link/i,xa=/checked\s*(?:[^=]|=\s*.checked.)/i,ya=/^true\/(.*)/,za=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Aa=ca(d),Ba=Aa.appendChild(d.createElement("div"));function Ca(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function Da(a){return a.type=(null!==n.find.attr(a,"type"))+"/"+a.type,a}function Ea(a){var b=ya.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function Fa(a,b){if(1===b.nodeType&&n.hasData(a)){var c,d,e,f=n._data(a),g=n._data(b,f),h=f.events;if(h){delete g.handle,g.events={};for(c in h)for(d=0,e=h[c].length;e>d;d++)n.event.add(b,c,h[c][d])}g.data&&(g.data=n.extend({},g.data))}}function Ga(a,b){var c,d,e;if(1===b.nodeType){if(c=b.nodeName.toLowerCase(),!l.noCloneEvent&&b[n.expando]){e=n._data(b);for(d in e.events)n.removeEvent(b,d,e.handle);b.removeAttribute(n.expando)}"script"===c&&b.text!==a.text?(Da(b).text=a.text,Ea(b)):"object"===c?(b.parentNode&&(b.outerHTML=a.outerHTML),l.html5Clone&&a.innerHTML&&!n.trim(b.innerHTML)&&(b.innerHTML=a.innerHTML)):"input"===c&&Z.test(a.type)?(b.defaultChecked=b.checked=a.checked,b.value!==a.value&&(b.value=a.value)):"option"===c?b.defaultSelected=b.selected=a.defaultSelected:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}}function Ha(a,b,c,d){b=f.apply([],b);var e,g,h,i,j,k,m=0,o=a.length,p=o-1,q=b[0],r=n.isFunction(q);if(r||o>1&&"string"==typeof q&&!l.checkClone&&xa.test(q))return a.each(function(e){var f=a.eq(e);r&&(b[0]=q.call(this,e,f.html())),Ha(f,b,c,d)});if(o&&(k=ja(b,a[0].ownerDocument,!1,a,d),e=k.firstChild,1===k.childNodes.length&&(k=e),e||d)){for(i=n.map(ea(k,"script"),Da),h=i.length;o>m;m++)g=k,m!==p&&(g=n.clone(g,!0,!0),h&&n.merge(i,ea(g,"script"))),c.call(a[m],g,m);if(h)for(j=i[i.length-1].ownerDocument,n.map(i,Ea),m=0;h>m;m++)g=i[m],_.test(g.type||"")&&!n._data(g,"globalEval")&&n.contains(j,g)&&(g.src?n._evalUrl&&n._evalUrl(g.src):n.globalEval((g.text||g.textContent||g.innerHTML||"").replace(za,"")));k=e=null}return a}function Ia(a,b,c){for(var d,e=b?n.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||n.cleanData(ea(d)),d.parentNode&&(c&&n.contains(d.ownerDocument,d)&&fa(ea(d,"script")),d.parentNode.removeChild(d));return a}n.extend({htmlPrefilter:function(a){return a.replace(va,"<$1></$2>")},clone:function(a,b,c){var d,e,f,g,h,i=n.contains(a.ownerDocument,a);if(l.html5Clone||n.isXMLDoc(a)||!ua.test("<"+a.nodeName+">")?f=a.cloneNode(!0):(Ba.innerHTML=a.outerHTML,Ba.removeChild(f=Ba.firstChild)),!(l.noCloneEvent&&l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(d=ea(f),h=ea(a),g=0;null!=(e=h[g]);++g)d[g]&&Ga(e,d[g]);if(b)if(c)for(h=h||ea(a),d=d||ea(f),g=0;null!=(e=h[g]);g++)Fa(e,d[g]);else Fa(a,f);return d=ea(f,"script"),d.length>0&&fa(d,!i&&ea(a,"script")),d=h=e=null,f},cleanData:function(a,b){for(var d,e,f,g,h=0,i=n.expando,j=n.cache,k=l.attributes,m=n.event.special;null!=(d=a[h]);h++)if((b||M(d))&&(f=d[i],g=f&&j[f])){if(g.events)for(e in g.events)m[e]?n.event.remove(d,e):n.removeEvent(d,e,g.handle);j[f]&&(delete j[f],k||"undefined"==typeof d.removeAttribute?d[i]=void 0:d.removeAttribute(i),c.push(f))}}}),n.fn.extend({domManip:Ha,detach:function(a){return Ia(this,a,!0)},remove:function(a){return Ia(this,a)},text:function(a){return Y(this,function(a){return void 0===a?n.text(this):this.empty().append((this[0]&&this[0].ownerDocument||d).createTextNode(a))},null,a,arguments.length)},append:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.appendChild(a)}})},prepend:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++){1===a.nodeType&&n.cleanData(ea(a,!1));while(a.firstChild)a.removeChild(a.firstChild);a.options&&n.nodeName(a,"select")&&(a.options.length=0)}return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return Y(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a)return 1===b.nodeType?b.innerHTML.replace(ta,""):void 0;if("string"==typeof a&&!wa.test(a)&&(l.htmlSerialize||!ua.test(a))&&(l.leadingWhitespace||!aa.test(a))&&!da[($.exec(a)||["",""])[1].toLowerCase()]){a=n.htmlPrefilter(a);try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(ea(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=[];return Ha(this,arguments,function(b){var c=this.parentNode;n.inArray(this,a)<0&&(n.cleanData(ea(this)),c&&c.replaceChild(b,this))},a)}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=0,e=[],f=n(a),h=f.length-1;h>=d;d++)c=d===h?this:this.clone(!0),n(f[d])[b](c),g.apply(e,c.get());return this.pushStack(e)}});var Ja,Ka={HTML:"block",BODY:"block"};function La(a,b){var c=n(b.createElement(a)).appendTo(b.body),d=n.css(c[0],"display");return c.detach(),d}function Ma(a){var b=d,c=Ka[a];return c||(c=La(a,b),"none"!==c&&c||(Ja=(Ja||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=(Ja[0].contentWindow||Ja[0].contentDocument).document,b.write(),b.close(),c=La(a,b),Ja.detach()),Ka[a]=c),c}var Na=/^margin/,Oa=new RegExp("^("+T+")(?!px)[a-z%]+$","i"),Pa=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e},Qa=d.documentElement;!function(){var b,c,e,f,g,h,i=d.createElement("div"),j=d.createElement("div");if(j.style){j.style.cssText="float:left;opacity:.5",l.opacity="0.5"===j.style.opacity,l.cssFloat=!!j.style.cssFloat,j.style.backgroundClip="content-box",j.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===j.style.backgroundClip,i=d.createElement("div"),i.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",j.innerHTML="",i.appendChild(j),l.boxSizing=""===j.style.boxSizing||""===j.style.MozBoxSizing||""===j.style.WebkitBoxSizing,n.extend(l,{reliableHiddenOffsets:function(){return null==b&&k(),f},boxSizingReliable:function(){return null==b&&k(),e},pixelMarginRight:function(){return null==b&&k(),c},pixelPosition:function(){return null==b&&k(),b},reliableMarginRight:function(){return null==b&&k(),g},reliableMarginLeft:function(){return null==b&&k(),h}});function k(){var k,l,m=d.documentElement;m.appendChild(i),j.style.cssText="-webkit-box-sizing:border-box;box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",b=e=h=!1,c=g=!0,a.getComputedStyle&&(l=a.getComputedStyle(j),b="1%"!==(l||{}).top,h="2px"===(l||{}).marginLeft,e="4px"===(l||{width:"4px"}).width,j.style.marginRight="50%",c="4px"===(l||{marginRight:"4px"}).marginRight,k=j.appendChild(d.createElement("div")),k.style.cssText=j.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",k.style.marginRight=k.style.width="0",j.style.width="1px",g=!parseFloat((a.getComputedStyle(k)||{}).marginRight),j.removeChild(k)),j.style.display="none",f=0===j.getClientRects().length,f&&(j.style.display="",j.innerHTML="<table><tr><td></td><td>t</td></tr></table>",k=j.getElementsByTagName("td"),k[0].style.cssText="margin:0;border:0;padding:0;display:none",f=0===k[0].offsetHeight,f&&(k[0].style.display="",k[1].style.display="none",f=0===k[0].offsetHeight)),m.removeChild(i)}}}();var Ra,Sa,Ta=/^(top|right|bottom|left)$/;a.getComputedStyle?(Ra=function(b){var c=b.ownerDocument.defaultView;return c.opener||(c=a),c.getComputedStyle(b)},Sa=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Ra(a),g=c?c.getPropertyValue(b)||c[b]:void 0,c&&(""!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),!l.pixelMarginRight()&&Oa.test(g)&&Na.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0===g?g:g+""}):Qa.currentStyle&&(Ra=function(a){return a.currentStyle},Sa=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Ra(a),g=c?c[b]:void 0,null==g&&h&&h[b]&&(g=h[b]),Oa.test(g)&&!Ta.test(b)&&(d=h.left,e=a.runtimeStyle,f=e&&e.left,f&&(e.left=a.currentStyle.left),h.left="fontSize"===b?"1em":g,g=h.pixelLeft+"px",h.left=d,f&&(e.left=f)),void 0===g?g:g+""||"auto"});function Ua(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}var Va=/alpha\([^)]*\)/i,Wa=/opacity\s*=\s*([^)]*)/i,Xa=/^(none|table(?!-c[ea]).+)/,Ya=new RegExp("^("+T+")(.*)$","i"),Za={position:"absolute",visibility:"hidden",display:"block"},$a={letterSpacing:"0",fontWeight:"400"},_a=["Webkit","O","Moz","ms"],ab=d.createElement("div").style;function bb(a){if(a in ab)return a;var b=a.charAt(0).toUpperCase()+a.slice(1),c=_a.length;while(c--)if(a=_a[c]+b,a in ab)return a}function cb(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=n._data(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&W(d)&&(f[g]=n._data(d,"olddisplay",Ma(d.nodeName)))):(e=W(d),(c&&"none"!==c||!e)&&n._data(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}function db(a,b,c){var d=Ya.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function eb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+V[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+V[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+V[f]+"Width",!0,e))):(g+=n.css(a,"padding"+V[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+V[f]+"Width",!0,e)));return g}function fb(b,c,e){var f=!0,g="width"===c?b.offsetWidth:b.offsetHeight,h=Ra(b),i=l.boxSizing&&"border-box"===n.css(b,"boxSizing",!1,h);if(d.msFullscreenElement&&a.top!==a&&b.getClientRects().length&&(g=Math.round(100*b.getBoundingClientRect()[c])),0>=g||null==g){if(g=Sa(b,c,h),(0>g||null==g)&&(g=b.style[c]),Oa.test(g))return g;f=i&&(l.boxSizingReliable()||g===b.style[c]),g=parseFloat(g)||0}return g+eb(b,c,e||(i?"border":"content"),f,h)+"px"}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Sa(a,"opacity");return""===c?"1":c}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":l.cssFloat?"cssFloat":"styleFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;if(b=n.cssProps[h]||(n.cssProps[h]=bb(h)||h),g=n.cssHooks[b]||n.cssHooks[h],void 0===c)return g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b];if(f=typeof c,"string"===f&&(e=U.exec(c))&&e[1]&&(c=X(a,b,e),f="number"),null!=c&&c===c&&("number"===f&&(c+=e&&e[3]||(n.cssNumber[h]?"":"px")),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),!(g&&"set"in g&&void 0===(c=g.set(a,c,d)))))try{i[b]=c}catch(j){}}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=bb(h)||h),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(f=g.get(a,!0,c)),void 0===f&&(f=Sa(a,b,d)),"normal"===f&&b in $a&&(f=$a[b]),""===c||c?(e=parseFloat(f),c===!0||isFinite(e)?e||0:f):f}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?Xa.test(n.css(a,"display"))&&0===a.offsetWidth?Pa(a,Za,function(){return fb(a,b,d)}):fb(a,b,d):void 0},set:function(a,c,d){var e=d&&Ra(a);return db(a,c,d?eb(a,b,d,l.boxSizing&&"border-box"===n.css(a,"boxSizing",!1,e),e):0)}}}),l.opacity||(n.cssHooks.opacity={get:function(a,b){return Wa.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=n.isNumeric(b)?"alpha(opacity="+100*b+")":"",f=d&&d.filter||c.filter||"";c.zoom=1,(b>=1||""===b)&&""===n.trim(f.replace(Va,""))&&c.removeAttribute&&(c.removeAttribute("filter"),""===b||d&&!d.filter)||(c.filter=Va.test(f)?f.replace(Va,e):f+" "+e)}}),n.cssHooks.marginRight=Ua(l.reliableMarginRight,function(a,b){return b?Pa(a,{display:"inline-block"},Sa,[a,"marginRight"]):void 0}),n.cssHooks.marginLeft=Ua(l.reliableMarginLeft,function(a,b){return b?(parseFloat(Sa(a,"marginLeft"))||(n.contains(a.ownerDocument,a)?a.getBoundingClientRect().left-Pa(a,{
marginLeft:0},function(){return a.getBoundingClientRect().left}):0))+"px":void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+V[d]+b]=f[d]||f[d-2]||f[0];return e}},Na.test(a)||(n.cssHooks[a+b].set=db)}),n.fn.extend({css:function(a,b){return Y(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=Ra(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)},a,b,arguments.length>1)},show:function(){return cb(this,!0)},hide:function(){return cb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){W(this)?n(this).show():n(this).hide()})}});function gb(a,b,c,d,e){return new gb.prototype.init(a,b,c,d,e)}n.Tween=gb,gb.prototype={constructor:gb,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||n.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=gb.propHooks[this.prop];return a&&a.get?a.get(this):gb.propHooks._default.get(this)},run:function(a){var b,c=gb.propHooks[this.prop];return this.options.duration?this.pos=b=n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):gb.propHooks._default.set(this),this}},gb.prototype.init.prototype=gb.prototype,gb.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0)},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[n.cssProps[a.prop]]&&!n.cssHooks[a.prop]?a.elem[a.prop]=a.now:n.style(a.elem,a.prop,a.now+a.unit)}}},gb.propHooks.scrollTop=gb.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:"swing"},n.fx=gb.prototype.init,n.fx.step={};var hb,ib,jb=/^(?:toggle|show|hide)$/,kb=/queueHooks$/;function lb(){return a.setTimeout(function(){hb=void 0}),hb=n.now()}function mb(a,b){var c,d={height:a},e=0;for(b=b?1:0;4>e;e+=2-b)c=V[e],d["margin"+c]=d["padding"+c]=a;return b&&(d.opacity=d.width=a),d}function nb(a,b,c){for(var d,e=(qb.tweeners[b]||[]).concat(qb.tweeners["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function ob(a,b,c){var d,e,f,g,h,i,j,k,m=this,o={},p=a.style,q=a.nodeType&&W(a),r=n._data(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,m.always(function(){m.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[p.overflow,p.overflowX,p.overflowY],j=n.css(a,"display"),k="none"===j?n._data(a,"olddisplay")||Ma(a.nodeName):j,"inline"===k&&"none"===n.css(a,"float")&&(l.inlineBlockNeedsLayout&&"inline"!==Ma(a.nodeName)?p.zoom=1:p.display="inline-block")),c.overflow&&(p.overflow="hidden",l.shrinkWrapBlocks()||m.always(function(){p.overflow=c.overflow[0],p.overflowX=c.overflow[1],p.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],jb.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(q?"hide":"show")){if("show"!==e||!r||void 0===r[d])continue;q=!0}o[d]=r&&r[d]||n.style(a,d)}else j=void 0;if(n.isEmptyObject(o))"inline"===("none"===j?Ma(a.nodeName):j)&&(p.display=j);else{r?"hidden"in r&&(q=r.hidden):r=n._data(a,"fxshow",{}),f&&(r.hidden=!q),q?n(a).show():m.done(function(){n(a).hide()}),m.done(function(){var b;n._removeData(a,"fxshow");for(b in o)n.style(a,b,o[b])});for(d in o)g=nb(q?r[d]:0,d,m),d in r||(r[d]=g.start,q&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function pb(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function qb(a,b,c){var d,e,f=0,g=qb.prefilters.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=hb||lb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{},easing:n.easing._default},c),originalProperties:b,originalOptions:c,startTime:hb||lb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?(h.notifyWith(a,[j,1,0]),h.resolveWith(a,[j,b])):h.rejectWith(a,[j,b]),this}}),k=j.props;for(pb(k,j.opts.specialEasing);g>f;f++)if(d=qb.prefilters[f].call(j,a,k,j.opts))return n.isFunction(d.stop)&&(n._queueHooks(j.elem,j.opts.queue).stop=n.proxy(d.stop,d)),d;return n.map(k,nb,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(qb,{tweeners:{"*":[function(a,b){var c=this.createTween(a,b);return X(c.elem,a,U.exec(b),c),c}]},tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.match(G);for(var c,d=0,e=a.length;e>d;d++)c=a[d],qb.tweeners[c]=qb.tweeners[c]||[],qb.tweeners[c].unshift(b)},prefilters:[ob],prefilter:function(a,b){b?qb.prefilters.unshift(a):qb.prefilters.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(W).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=qb(this,n.extend({},a),f);(e||n._data(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=n._data(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&kb.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=n._data(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(mb(b,!0),a,d,e)}}),n.each({slideDown:mb("show"),slideUp:mb("hide"),slideToggle:mb("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=n.timers,c=0;for(hb=n.now();c<b.length;c++)a=b[c],a()||b[c]!==a||b.splice(c--,1);b.length||n.fx.stop(),hb=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){ib||(ib=a.setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){a.clearInterval(ib),ib=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(b,c){return b=n.fx?n.fx.speeds[b]||b:b,c=c||"fx",this.queue(c,function(c,d){var e=a.setTimeout(c,b);d.stop=function(){a.clearTimeout(e)}})},function(){var a,b=d.createElement("input"),c=d.createElement("div"),e=d.createElement("select"),f=e.appendChild(d.createElement("option"));c=d.createElement("div"),c.setAttribute("className","t"),c.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=c.getElementsByTagName("a")[0],b.setAttribute("type","checkbox"),c.appendChild(b),a=c.getElementsByTagName("a")[0],a.style.cssText="top:1px",l.getSetAttribute="t"!==c.className,l.style=/top/.test(a.getAttribute("style")),l.hrefNormalized="/a"===a.getAttribute("href"),l.checkOn=!!b.value,l.optSelected=f.selected,l.enctype=!!d.createElement("form").enctype,e.disabled=!0,l.optDisabled=!f.disabled,b=d.createElement("input"),b.setAttribute("value",""),l.input=""===b.getAttribute("value"),b.value="t",b.setAttribute("type","radio"),l.radioValue="t"===b.value}();var rb=/\r/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(rb,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){var b=n.find.attr(a,"value");return null!=b?b:n.trim(n.text(a))}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],(c.selected||i===e)&&(l.optDisabled?!c.disabled:null===c.getAttribute("disabled"))&&(!c.parentNode.disabled||!n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)if(d=e[g],n.inArray(n.valHooks.option.get(d),f)>=0)try{d.selected=c=!0}catch(h){d.scrollHeight}else d.selected=!1;return c||(a.selectedIndex=-1),e}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>-1:void 0}},l.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var sb,tb,ub=n.expr.attrHandle,vb=/^(?:checked|selected)$/i,wb=l.getSetAttribute,xb=l.input;n.fn.extend({attr:function(a,b){return Y(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return"undefined"==typeof a.getAttribute?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),e=n.attrHooks[b]||(n.expr.match.bool.test(b)?tb:sb)),void 0!==c?null===c?void n.removeAttr(a,b):e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+""),c):e&&"get"in e&&null!==(d=e.get(a,b))?d:(d=n.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(G);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)?xb&&wb||!vb.test(c)?a[d]=!1:a[n.camelCase("default-"+c)]=a[d]=!1:n.attr(a,c,""),a.removeAttribute(wb?c:d)}}),tb={set:function(a,b,c){return b===!1?n.removeAttr(a,c):xb&&wb||!vb.test(c)?a.setAttribute(!wb&&n.propFix[c]||c,c):a[n.camelCase("default-"+c)]=a[c]=!0,c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=ub[b]||n.find.attr;xb&&wb||!vb.test(b)?ub[b]=function(a,b,d){var e,f;return d||(f=ub[b],ub[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,ub[b]=f),e}:ub[b]=function(a,b,c){return c?void 0:a[n.camelCase("default-"+b)]?b.toLowerCase():null}}),xb&&wb||(n.attrHooks.value={set:function(a,b,c){return n.nodeName(a,"input")?void(a.defaultValue=b):sb&&sb.set(a,b,c)}}),wb||(sb={set:function(a,b,c){var d=a.getAttributeNode(c);return d||a.setAttributeNode(d=a.ownerDocument.createAttribute(c)),d.value=b+="","value"===c||b===a.getAttribute(c)?b:void 0}},ub.id=ub.name=ub.coords=function(a,b,c){var d;return c?void 0:(d=a.getAttributeNode(b))&&""!==d.value?d.value:null},n.valHooks.button={get:function(a,b){var c=a.getAttributeNode(b);return c&&c.specified?c.value:void 0},set:sb.set},n.attrHooks.contenteditable={set:function(a,b,c){sb.set(a,""===b?!1:b,c)}},n.each(["width","height"],function(a,b){n.attrHooks[b]={set:function(a,c){return""===c?(a.setAttribute(b,"auto"),c):void 0}}})),l.style||(n.attrHooks.style={get:function(a){return a.style.cssText||void 0},set:function(a,b){return a.style.cssText=b+""}});var yb=/^(?:input|select|textarea|button|object)$/i,zb=/^(?:a|area)$/i;n.fn.extend({prop:function(a,b){return Y(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return a=n.propFix[a]||a,this.each(function(){try{this[a]=void 0,delete this[a]}catch(b){}})}}),n.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&n.isXMLDoc(a)||(b=n.propFix[b]||b,e=n.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=n.find.attr(a,"tabindex");return b?parseInt(b,10):yb.test(a.nodeName)||zb.test(a.nodeName)&&a.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),l.hrefNormalized||n.each(["href","src"],function(a,b){n.propHooks[b]={get:function(a){return a.getAttribute(b,4)}}}),l.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex),null}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this}),l.enctype||(n.propFix.enctype="encoding");var Ab=/[\t\r\n\f]/g;function Bb(a){return n.attr(a,"class")||""}n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,Bb(this)))});if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=Bb(c),d=1===c.nodeType&&(" "+e+" ").replace(Ab," ")){g=0;while(f=b[g++])d.indexOf(" "+f+" ")<0&&(d+=f+" ");h=n.trim(d),e!==h&&n.attr(c,"class",h)}}return this},removeClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,Bb(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=Bb(c),d=1===c.nodeType&&(" "+e+" ").replace(Ab," ")){g=0;while(f=b[g++])while(d.indexOf(" "+f+" ")>-1)d=d.replace(" "+f+" "," ");h=n.trim(d),e!==h&&n.attr(c,"class",h)}}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):n.isFunction(a)?this.each(function(c){n(this).toggleClass(a.call(this,c,Bb(this),b),b)}):this.each(function(){var b,d,e,f;if("string"===c){d=0,e=n(this),f=a.match(G)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(void 0===a||"boolean"===c)&&(b=Bb(this),b&&n._data(this,"__className__",b),n.attr(this,"class",b||a===!1?"":n._data(this,"__className__")||""))})},hasClass:function(a){var b,c,d=0;b=" "+a+" ";while(c=this[d++])if(1===c.nodeType&&(" "+Bb(c)+" ").replace(Ab," ").indexOf(b)>-1)return!0;return!1}}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}});var Cb=a.location,Db=n.now(),Eb=/\?/,Fb=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;n.parseJSON=function(b){if(a.JSON&&a.JSON.parse)return a.JSON.parse(b+"");var c,d=null,e=n.trim(b+"");return e&&!n.trim(e.replace(Fb,function(a,b,e,f){return c&&b&&(d=0),0===d?a:(c=e||b,d+=!f-!e,"")}))?Function("return "+e)():n.error("Invalid JSON: "+b)},n.parseXML=function(b){var c,d;if(!b||"string"!=typeof b)return null;try{a.DOMParser?(d=new a.DOMParser,c=d.parseFromString(b,"text/xml")):(c=new a.ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(b))}catch(e){c=void 0}return c&&c.documentElement&&!c.getElementsByTagName("parsererror").length||n.error("Invalid XML: "+b),c};var Gb=/#.*$/,Hb=/([?&])_=[^&]*/,Ib=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Jb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Kb=/^(?:GET|HEAD)$/,Lb=/^\/\//,Mb=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,Nb={},Ob={},Pb="*/".concat("*"),Qb=Cb.href,Rb=Mb.exec(Qb.toLowerCase())||[];function Sb(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(G)||[];if(n.isFunction(c))while(d=f[e++])"+"===d.charAt(0)?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Tb(a,b,c,d){var e={},f=a===Ob;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function Ub(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(d in b)void 0!==b[d]&&((e[d]?a:c||(c={}))[d]=b[d]);return c&&n.extend(!0,a,c),a}function Vb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===e&&(e=a.mimeType||b.getResponseHeader("Content-Type"));if(e)for(g in h)if(h[g]&&h[g].test(e)){i.unshift(g);break}if(i[0]in c)f=i[0];else{for(g in c){if(!i[0]||a.converters[g+" "+i[0]]){f=g;break}d||(d=g)}f=f||d}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function Wb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Qb,type:"GET",isLocal:Jb.test(Rb[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Pb,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Ub(Ub(a,n.ajaxSettings),b):Ub(n.ajaxSettings,a)},ajaxPrefilter:Sb(Nb),ajaxTransport:Sb(Ob),ajax:function(b,c){"object"==typeof b&&(c=b,b=void 0),c=c||{};var d,e,f,g,h,i,j,k,l=n.ajaxSetup({},c),m=l.context||l,o=l.context&&(m.nodeType||m.jquery)?n(m):n.event,p=n.Deferred(),q=n.Callbacks("once memory"),r=l.statusCode||{},s={},t={},u=0,v="canceled",w={readyState:0,getResponseHeader:function(a){var b;if(2===u){if(!k){k={};while(b=Ib.exec(g))k[b[1].toLowerCase()]=b[2]}b=k[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===u?g:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return u||(a=t[c]=t[c]||a,s[a]=b),this},overrideMimeType:function(a){return u||(l.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>u)for(b in a)r[b]=[r[b],a[b]];else w.always(a[w.status]);return this},abort:function(a){var b=a||v;return j&&j.abort(b),y(0,b),this}};if(p.promise(w).complete=q.add,w.success=w.done,w.error=w.fail,l.url=((b||l.url||Qb)+"").replace(Gb,"").replace(Lb,Rb[1]+"//"),l.type=c.method||c.type||l.method||l.type,l.dataTypes=n.trim(l.dataType||"*").toLowerCase().match(G)||[""],null==l.crossDomain&&(d=Mb.exec(l.url.toLowerCase()),l.crossDomain=!(!d||d[1]===Rb[1]&&d[2]===Rb[2]&&(d[3]||("http:"===d[1]?"80":"443"))===(Rb[3]||("http:"===Rb[1]?"80":"443")))),l.data&&l.processData&&"string"!=typeof l.data&&(l.data=n.param(l.data,l.traditional)),Tb(Nb,l,c,w),2===u)return w;i=n.event&&l.global,i&&0===n.active++&&n.event.trigger("ajaxStart"),l.type=l.type.toUpperCase(),l.hasContent=!Kb.test(l.type),f=l.url,l.hasContent||(l.data&&(f=l.url+=(Eb.test(f)?"&":"?")+l.data,delete l.data),l.cache===!1&&(l.url=Hb.test(f)?f.replace(Hb,"$1_="+Db++):f+(Eb.test(f)?"&":"?")+"_="+Db++)),l.ifModified&&(n.lastModified[f]&&w.setRequestHeader("If-Modified-Since",n.lastModified[f]),n.etag[f]&&w.setRequestHeader("If-None-Match",n.etag[f])),(l.data&&l.hasContent&&l.contentType!==!1||c.contentType)&&w.setRequestHeader("Content-Type",l.contentType),w.setRequestHeader("Accept",l.dataTypes[0]&&l.accepts[l.dataTypes[0]]?l.accepts[l.dataTypes[0]]+("*"!==l.dataTypes[0]?", "+Pb+"; q=0.01":""):l.accepts["*"]);for(e in l.headers)w.setRequestHeader(e,l.headers[e]);if(l.beforeSend&&(l.beforeSend.call(m,w,l)===!1||2===u))return w.abort();v="abort";for(e in{success:1,error:1,complete:1})w[e](l[e]);if(j=Tb(Ob,l,c,w)){if(w.readyState=1,i&&o.trigger("ajaxSend",[w,l]),2===u)return w;l.async&&l.timeout>0&&(h=a.setTimeout(function(){w.abort("timeout")},l.timeout));try{u=1,j.send(s,y)}catch(x){if(!(2>u))throw x;y(-1,x)}}else y(-1,"No Transport");function y(b,c,d,e){var k,s,t,v,x,y=c;2!==u&&(u=2,h&&a.clearTimeout(h),j=void 0,g=e||"",w.readyState=b>0?4:0,k=b>=200&&300>b||304===b,d&&(v=Vb(l,w,d)),v=Wb(l,v,w,k),k?(l.ifModified&&(x=w.getResponseHeader("Last-Modified"),x&&(n.lastModified[f]=x),x=w.getResponseHeader("etag"),x&&(n.etag[f]=x)),204===b||"HEAD"===l.type?y="nocontent":304===b?y="notmodified":(y=v.state,s=v.data,t=v.error,k=!t)):(t=y,(b||!y)&&(y="error",0>b&&(b=0))),w.status=b,w.statusText=(c||y)+"",k?p.resolveWith(m,[s,y,w]):p.rejectWith(m,[w,y,t]),w.statusCode(r),r=void 0,i&&o.trigger(k?"ajaxSuccess":"ajaxError",[w,l,k?s:t]),q.fireWith(m,[w,y]),i&&(o.trigger("ajaxComplete",[w,l]),--n.active||n.event.trigger("ajaxStop")))}return w},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax(n.extend({url:a,type:b,dataType:e,data:c,success:d},n.isPlainObject(a)&&a))}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){if(n.isFunction(a))return this.each(function(b){n(this).wrapAll(a.call(this,b))});if(this[0]){var b=n(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&1===a.firstChild.nodeType)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){return n.isFunction(a)?this.each(function(b){n(this).wrapInner(a.call(this,b))}):this.each(function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}});function Xb(a){return a.style&&a.style.display||n.css(a,"display")}function Yb(a){while(a&&1===a.nodeType){if("none"===Xb(a)||"hidden"===a.type)return!0;a=a.parentNode}return!1}n.expr.filters.hidden=function(a){return l.reliableHiddenOffsets()?a.offsetWidth<=0&&a.offsetHeight<=0&&!a.getClientRects().length:Yb(a)},n.expr.filters.visible=function(a){return!n.expr.filters.hidden(a)};var Zb=/%20/g,$b=/\[\]$/,_b=/\r?\n/g,ac=/^(?:submit|button|image|reset|file)$/i,bc=/^(?:input|select|textarea|keygen)/i;function cc(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||$b.test(a)?d(a,e):cc(a+"["+("object"==typeof e&&null!=e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)cc(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)cc(c,a[c],b,e);return d.join("&").replace(Zb,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&bc.test(this.nodeName)&&!ac.test(a)&&(this.checked||!Z.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(_b,"\r\n")}}):{name:b.name,value:c.replace(_b,"\r\n")}}).get()}}),n.ajaxSettings.xhr=void 0!==a.ActiveXObject?function(){return this.isLocal?hc():d.documentMode>8?gc():/^(get|post|head|put|delete|options)$/i.test(this.type)&&gc()||hc()}:gc;var dc=0,ec={},fc=n.ajaxSettings.xhr();a.attachEvent&&a.attachEvent("onunload",function(){for(var a in ec)ec[a](void 0,!0)}),l.cors=!!fc&&"withCredentials"in fc,fc=l.ajax=!!fc,fc&&n.ajaxTransport(function(b){if(!b.crossDomain||l.cors){var c;return{send:function(d,e){var f,g=b.xhr(),h=++dc;if(g.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(f in b.xhrFields)g[f]=b.xhrFields[f];b.mimeType&&g.overrideMimeType&&g.overrideMimeType(b.mimeType),b.crossDomain||d["X-Requested-With"]||(d["X-Requested-With"]="XMLHttpRequest");for(f in d)void 0!==d[f]&&g.setRequestHeader(f,d[f]+"");g.send(b.hasContent&&b.data||null),c=function(a,d){var f,i,j;if(c&&(d||4===g.readyState))if(delete ec[h],c=void 0,g.onreadystatechange=n.noop,d)4!==g.readyState&&g.abort();else{j={},f=g.status,"string"==typeof g.responseText&&(j.text=g.responseText);try{i=g.statusText}catch(k){i=""}f||!b.isLocal||b.crossDomain?1223===f&&(f=204):f=j.text?200:404}j&&e(f,i,j,g.getAllResponseHeaders())},b.async?4===g.readyState?a.setTimeout(c):g.onreadystatechange=ec[h]=c:c()},abort:function(){c&&c(void 0,!0)}}}});function gc(){try{return new a.XMLHttpRequest}catch(b){}}function hc(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}n.ajaxPrefilter(function(a){a.crossDomain&&(a.contents.script=!1)}),n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c=d.head||n("head")[0]||d.documentElement;return{send:function(e,f){b=d.createElement("script"),b.async=!0,a.scriptCharset&&(b.charset=a.scriptCharset),b.src=a.url,b.onload=b.onreadystatechange=function(a,c){(c||!b.readyState||/loaded|complete/.test(b.readyState))&&(b.onload=b.onreadystatechange=null,b.parentNode&&b.parentNode.removeChild(b),b=null,c||f(200,"success"))},c.insertBefore(b,c.firstChild)},abort:function(){b&&b.onload(void 0,!0)}}}});var ic=[],jc=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=ic.pop()||n.expando+"_"+Db++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(jc.test(b.url)?"url":"string"==typeof b.data&&0===(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&jc.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(jc,"$1"+e):b.jsonp!==!1&&(b.url+=(Eb.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?n(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,ic.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),l.createHTMLDocument=function(){if(!d.implementation.createHTMLDocument)return!1;var a=d.implementation.createHTMLDocument("");return a.body.innerHTML="<form></form><form></form>",2===a.body.childNodes.length}(),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||(l.createHTMLDocument?d.implementation.createHTMLDocument(""):d);var e=x.exec(a),f=!c&&[];return e?[b.createElement(e[1])]:(e=ja([a],b,f),f&&f.length&&n(f).remove(),n.merge([],e.childNodes))};var kc=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&kc)return kc.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>-1&&(d=n.trim(a.slice(h,a.length)),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&n.ajax({url:a,type:e||"GET",dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(g,f||[a.responseText,b,a])})}),this},n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};function lc(a){return n.isWindow(a)?a:9===a.nodeType?a.defaultView||a.parentWindow:!1}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&n.inArray("auto",[f,i])>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,n.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d={top:0,left:0},e=this[0],f=e&&e.ownerDocument;if(f)return b=f.documentElement,n.contains(b,e)?("undefined"!=typeof e.getBoundingClientRect&&(d=e.getBoundingClientRect()),c=lc(f),{top:d.top+(c.pageYOffset||b.scrollTop)-(b.clientTop||0),left:d.left+(c.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}):d},position:function(){if(this[0]){var a,b,c={top:0,left:0},d=this[0];return"fixed"===n.css(d,"position")?b=d.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(c=a.offset()),c.top+=n.css(a[0],"borderTopWidth",!0)-a.scrollTop(),c.left+=n.css(a[0],"borderLeftWidth",!0)-a.scrollLeft()),{top:b.top-c.top-n.css(d,"marginTop",!0),left:b.left-c.left-n.css(d,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&!n.nodeName(a,"html")&&"static"===n.css(a,"position"))a=a.offsetParent;return a||Qa})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c=/Y/.test(b);n.fn[a]=function(d){return Y(this,function(a,d,e){var f=lc(a);return void 0===e?f?b in f?f[b]:f.document.documentElement[d]:a[d]:void(f?f.scrollTo(c?n(f).scrollLeft():e,c?e:n(f).scrollTop()):a[d]=e)},a,d,arguments.length,null)}}),n.each(["top","left"],function(a,b){
n.cssHooks[b]=Ua(l.pixelPosition,function(a,c){return c?(c=Sa(a,b),Oa.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return Y(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}}),n.fn.size=function(){return this.length},n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var mc=a.jQuery,nc=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=nc),b&&a.jQuery===n&&(a.jQuery=mc),n},b||(a.jQuery=a.$=n),n});const abc2svg={version:"1.4.9",vdate:"2016-01-18"};function Abc(user){var wpsobj,svgobj;this.user=user;const BAR=0,CLEF=1,CUSTOS=2,FORMAT=3,GRACE=4,KEY=5,METER=6,MREST=7,NOTE=8,PART=9,REST=10,SPACE=11,STAVES=12,STBRK=13,TEMPO=14,TUPLET=15,BLOCK=16;SL_ABOVE=1,SL_BELOW=2,SL_AUTO=3,SL_HIDDEN=4,SL_DOTTED=8,OPEN_BRACE=1,CLOSE_BRACE=2,OPEN_BRACKET=4,CLOSE_BRACKET=8,OPEN_PARENTH=16,CLOSE_PARENTH=32,STOP_BAR=64,FL_VOICE=128,OPEN_BRACE2=256,CLOSE_BRACE2=512,OPEN_BRACKET2=1024,CLOSE_BRACKET2=2048,MASTER_VOICE=4096,BASE_LEN=1536,CM=37.8,IN=96,YSTEP=128;var glovar={clef:{type:CLEF,clef_auto:true,clef_type:"a"},meter:{type:METER,wmeasure:1,a_meter:[]}},info={},parse={ctx:{},prefix:"%",state:0};function clone(obj){if(!obj)return obj;var tmp=new obj.constructor;for(var k in obj)tmp[k]=obj[k];return tmp}function errbld(sev,txt,fn,idx){var i,j,l,c,h;if(user.errbld){switch(sev){case 0:sev="warn";break;case 1:sev="error";break;default:sev="fatal";break}user.errbld(sev,txt,fn,idx);return}if(idx!=undefined&&idx>=0){l=0;i=-1;c=0;while(1){j=parse.file.indexOf("\n",i+1);if(j<0){i=parse.file.length-1;break}if(j>idx)break;l++;i=j}c=idx-i}h="";if(fn){h=fn;if(l)h+=":"+(l+1)+":"+(c+1);h+=" "}switch(sev){case 0:h+="Warning: ";break;case 1:h+="Error: ";break;default:h+="Internal bug: ";break}txt=txt.replace(/&/g,"&amp;");txt=txt.replace(/</g,"&lt;");txt=txt.replace(/>/g,"&gt;");user.errmsg(h+txt,l,c)}function error(sev,s,msg){if(s&&s.ctx)errbld(sev,msg,s.ctx.fname,s.istart);else errbld(sev,msg)}function scanBuf(){this.index=0;this.char=function(){if(this.index>=this.buffer.length)return undefined;return this.buffer[this.index]};this.next_char=function(){if(this.index>=this.buffer.length)return undefined;return this.buffer[++this.index]};this.advance=function(){if(this.index<this.buffer.length)this.index++};this.get_int=function(){var val=0,c=this.buffer[this.index];while(c>="0"&&c<="9"){val=val*10+Number(c);c=this.next_char()}return val};this.get_float=function(){var txt="",c;while(1){c=this.buffer[this.index];if("0123456789.-".indexOf(c)<0)break;txt+=c;this.index++}return parseFloat(txt)};this.error=function(txt){errbld(1,txt,parse.ctx.fname,this.index+parse.bol-1)}}function syntax(sev,txt){errbld(sev,txt,parse.ctx.fname,parse.istart)}function abc2svg_init(){font_init();init_tune()}var dd_tb={},a_de=[];const std_deco_tb=["dot 0 stc 5 1 1","tenuto 0 emb 5 2 2","slide 1 sld 3 7 0","arpeggio 2 arp 12 10 0","roll 3 cpu 7 6 6","fermata 3 hld 12 7 7","emphasis 3 accent 7 4 4","lowermordent 3 lmrd 10 2 2","coda 3 coda 24 10 10","uppermordent 3 umrd 10 2 2","segno 3 sgno 20 4 4","trill 3 trl 14 4 4","upbow 3 upb 10 5 5","downbow 3 dnb 9 5 5","gmark 3 grm 6 5 5","wedge 3 wedge 8 1 1","turnx 3 turnx 10 0 5","breath 3 brth 0 1 20","longphrase 3 lphr 0 1 1","mediumphrase 3 mphr 0 1 1","shortphrase 3 sphr 0 1 1","invertedfermata 3 hld 12 7 7","invertedturn 3 turn 10 0 5","invertedturnx 3 turnx 10 0 5","0 3 fng 8 3 3 0","1 3 fng 8 3 3 1","2 3 fng 8 3 3 2","3 3 fng 8 3 3 3","4 3 fng 8 3 3 4","5 3 fng 8 3 3 5","plus 3 dplus 7 3 3","+ 3 dplus 7 3 3","accent 3 accent 6 4 4","> 3 accent 6 4 4","marcato 3 marcato 9 3 3","^ 3 marcato 9 3 3","mordent 3 lmrd 10 2 2","open 3 opend 10 2 2","snap 3 snap 14 3 3","thumb 3 thumb 14 2 2","D.C. 3 dacs 16 10 10 D.C.","D.S. 3 dacs 16 10 10 D.S.","fine 3 dacs 16 10 10 FINE","f 6 pf 18 1 7","ff 6 pf 18 2 10","fff 6 pf 18 4 13","ffff 6 pf 18 6 16","mf 6 pf 18 6 13","mp 6 pf 18 6 16","p 6 pf 18 2 8","pp 6 pf 18 5 14","ppp 6 pf 18 8 20","pppp 6 pf 18 10 25","pralltriller 3 umrd 10 2 2",'sfz 6 sfz 18 4 10 ""',"turn 3 turn 10 0 5","trill( 5 ltr 8 0 0","trill) 5 ltr 8 0 0","crescendo( 7 cresc 18 0 0","crescendo) 7 cresc 18 0 0","<( 7 cresc 18 0 0","<) 7 cresc 18 0 0","diminuendo( 7 dim 18 0 0","diminuendo) 7 dim 18 0 0",">( 7 dim 18 0 0",">) 7 dim 18 0 0","invisible 32 0 0 0 0","beamon 33 0 0 0 0","trem1 34 0 0 0 0","trem2 34 0 0 0 0","trem3 34 0 0 0 0","trem4 34 0 0 0 0","xstem 35 0 0 0 0","beambr1 36 0 0 0 0","beambr2 36 0 0 0 0","rbstop 37 0 0 0 0","/ 38 0 0 6 6","// 38 0 0 6 6","/// 38 0 0 6 6","beam-accel 39 0 0 0 0","beam-rall 39 0 0 0 0","stemless 40 0 0 0 0","rbend 41 0 0 0 0"];var user_deco_tb,first_note;function y_get(st,up,x,w){var y,p_staff=staff_tb[st],i=Math.floor(x/realwidth*YSTEP),j=Math.floor((x+w)/realwidth*YSTEP);if(i<0)i=0;if(j>=YSTEP){j=YSTEP-1;if(i>j)i=j}if(up){y=p_staff.top[i++];while(i<=j){if(y<p_staff.top[i])y=p_staff.top[i];i++}}else{y=p_staff.bot[i++];while(i<=j){if(y>p_staff.bot[i])y=p_staff.bot[i];i++}}return y}function y_set(st,up,x,w,y){var p_staff=staff_tb[st],i=Math.floor(x/realwidth*YSTEP),j=Math.floor((x+w)/realwidth*YSTEP);if(i<0)i=0;if(j>=YSTEP){j=YSTEP-1;if(i>j)i=j}if(up){while(i<=j){if(p_staff.top[i]<y)p_staff.top[i]=y;i++}}else{while(i<=j){if(p_staff.bot[i]>y)p_staff.bot[i]=y;i++}}}function set_str(de,str){var a=str.match(/^@([0-9.-]+),([0-9.-]+)/);if(a){de.x+=Number(a[1]);de.dy=Number(a[2]);de.str=str.replace(a[0],"")}else{de.str=str;de.dy=0}}function up_p(s,pos){switch(pos){case SL_ABOVE:return true;case SL_BELOW:return false}if(s.multi&&s.multi!=0)return s.multi>0;if(!voice_tb[s.v].have_ly)return false;return s.pos.voc!=SL_ABOVE}function d_arp(de){var m,h,dx,s=de.s,dd=de.dd,xc=0;for(m=0;m<=s.nhd;m++){if(s.notes[m].acc){dx=5+s.notes[m].shac}else{dx=6-s.notes[m].shhd;switch(s.head){case"square":case"oval":dx+=2.5;break}}if(dx>xc)xc=dx}h=3*(s.notes[s.nhd].pit-s.notes[0].pit)+4;m=dd.h;if(h<m)h=m;de.flags.val=true;de.val=h;de.x=s.x-xc;de.y=3*(s.notes[0].pit-18)-3}function d_cresc(de){if(de.flags.ldst)return;var s,dd,dd2,up,x,dx,x2,i,s2=de.s,de2=de.start,de2_prev;if(de2){s=de2.s;x=s.x+3;i=de2.ix;if(i>0)de2_prev=a_de[i-1]}else{s=first_note;x=s.x-s.wl-4}de.st=s2.st;de.flags.lden=false;de.flags.val=true;up=up_p(s2,s2.pos.dyn);if(up)de.flags.up=true;if(de2_prev&&de2_prev.s==s&&(de.flags.up&&!de2_prev.flags.up||!de.flags.up&&de2_prev.flags.up)){dd2=de2_prev.dd;if(dd2.func>=6){x2=de2_prev.x+de2_prev.val+4;if(x2>x)x=x2}}if(de.defl.noen){dx=de.x-x;if(dx<20){x=de.x-20-3;dx=20}}else{x2=s2.x;if(de.next&&de.next.s==s&&(de.flags.up&&!de.next.flags.up||!de.flags.up&&de.next.flags.up)){dd2=de.next.dd;if(dd2.func>=6)x2-=5}dx=x2-x-4;if(dx<20){x-=(20-dx)*.5;if(!de.start)x-=(20-dx)*.5;dx=20}}de.val=dx;de.x=x;dd=de.dd;de.y=y_get(de.st,up,x,dx);if(!up)de.y-=dd.h}function d_near(de){var y,up,s=de.s,dd=de.dd;if(dd.str){de.x=s.x;de.y=s.y;set_str(de,dd.str);return}if(s.multi)up=s.multi>0;else up=s.stem<0;if(up)y=Math.floor(s.ymx);else y=Math.floor(s.ymn-dd.h);if(y>-6&&y<24){if(up)y+=3;y=Math.floor((y+6)/6)*6-6}if(up)s.ymx=y+dd.h;else s.ymn=y;de.y=y;de.x=s.x+s.notes[s.stem>=0?0:s.nhd].shhd;if(dd.name[0]=="d"&&s.nflags>=-1){if(up){if(s.stem>0)de.x+=3.5}else{if(s.stem<0)de.x-=3.5}}}function d_pf(de){var dd2,x2,str,x,up,s=de.s,dd=de.dd,de_prev;de.val=dd.wl+dd.wr;up=up_p(s,s.pos.vol);if(up)de.flags.up=true;x=s.x-dd.wl;if(de.ix>0){de_prev=a_de[de.ix-1];if(de_prev.s==s&&(de.flags.up&&!de_prev.flags.up||!de.flags.up&&de_prev.flags.up)){dd2=de_prev.dd;if(dd2.func>=6){x2=de_prev.x+de_prev.val+4;if(x2>x)x=x2}}}de.x=x;de.y=y_get(s.st,up,x,de.val);if(!up)de.y-=dd.h;if(dd.str)set_str(de,dd.str);else if(dd.name!="sfz")de.str=dd.name}function d_slide(de){var m,dx,s=de.s,yc=s.notes[0].pit,xc=5;for(m=0;m<=s.nhd;m++){if(s.notes[m].acc){dx=4+s.notes[m].shac}else{dx=5-s.notes[m].shhd;switch(s.head){case"square":case"oval":dx+=2.5;break}}if(s.notes[m].pit<=yc+3&&dx>xc)xc=dx}de.x=s.x-xc;de.y=3*(yc-18)}function d_trill(de){if(de.flags.ldst)return;var s,dd,st,up,x,y,w,s2=de.s;if(de.start){s=de.start.s;x=s.x;if(s.type==NOTE&&s.a_dd&&s.a_dd.length>1)x+=10}else{s=first_note;x=s.x-s.wl-4}de.st=st=s2.st;up=s2.multi>=0;if(de.defl.noen){w=de.x-x;if(w<20){x=de.x-20-3;w=20}}else{w=s2.x-x-6;if(s2.type==NOTE)w-=6;if(w<20){x-=(20-w)*.5;if(!de.start)x-=(20-w)*.5;w=20}}dd=de.dd;y=y_get(st,up,x,w);if(up){var stafft=staff_tb[s.st].topbar+2;if(y<stafft)y=stafft}else{y-=dd.h;var staffb=staff_tb[s.st].botbar-2;if(y>staffb)y=staffb}de.flags.lden=undefined;de.flags.val=true;de.val=w;de.x=x;de.y=y;if(up)y+=dd.h;y_set(st,up,x,w,y);if(up)s.ymx=s2.ymx=y;else s.ymn=s2.ymn=y}function d_upstaff(de){var yc,up,inv,s=de.s,dd=de.dd,x=s.x,w=dd.wl+dd.wr,stafft=staff_tb[s.st].topbar+2,staffb=staff_tb[s.st].botbar-2;if(s.nhd)x+=s.notes[s.stem>=0?0:s.nhd].shhd;up=-1;if(dd.func!=4){switch(s.pos.orn){case SL_ABOVE:up=1;break;case SL_BELOW:up=0;break}}switch(dd.glyph){case"accent":case"cpu":if(!up||up<0&&(s.multi<0||!s.multi&&s.stem>0)){yc=y_get(s.st,false,s.x-dd.wl,w);if(yc>staffb)yc=staffb;yc-=dd.h;y_set(s.st,false,s.x,0,yc);inv=true;s.ymn=yc}else{yc=y_get(s.st,true,s.x,0);if(yc<stafft)yc=stafft;y_set(s.st,true,s.x-dd.wl,w,yc+dd.h);s.ymx=yc+dd.h}break;case"brth":case"lphr":case"mphr":case"sphr":yc=stafft+1;for(s=s.ts_next;s;s=s.ts_next)if(s.shrink)break;if(s)x+=(s.x-x)*.4;else x+=(realwidth-x)*.4;break;default:if(dd.name.indexOf("invert")==0)inv=true;if(dd.name!="invertedfermata"&&(up>0||up<0&&s.multi>=0)){yc=y_get(s.st,true,s.x-dd.wl,w);if(yc<stafft)yc=stafft;y_set(s.st,true,s.x-dd.wl,w,yc+dd.h);s.ymx=yc+dd.h}else{yc=y_get(s.st,false,s.x-dd.wl,w);if(yc>staffb)yc=staffb;yc-=dd.h;y_set(s.st,false,s.x-dd.wl,w,yc);if(dd.name=="fermata")inv=true;s.ymn=yc}break}if(inv){yc+=dd.h;de.flags.inv=true}de.x=x;de.y=yc;if(dd.str)set_str(de,dd.str)}const func_tb=[d_near,d_slide,d_arp,d_upstaff,d_upstaff,d_trill,d_pf,d_cresc];function deco_add(param){if(!user_deco_tb)user_deco_tb=[];user_deco_tb.push(param)}function deco_build(text){var dd,dd2,c,i,elts,str;a=text.match(/(.+)\s+(\d+)\s+(.+?)\s+([0-9.]+)\s+([0-9.]+)\s+([0-9.]+)/);if(!a){error(1,null,"Invalid decoration '"+text+"'");return undefined}var c_func=Number(a[2]),h=parseFloat(a[4]),wl=parseFloat(a[5]),wr=parseFloat(a[6]);if(isNaN(c_func)){error(1,null,"%%deco: bad C function value '"+a[2]+"'");return undefined}if((c_func<0||c_func>=func_tb.length)&&(c_func<32||c_func>41)){error(1,null,"%%deco: bad C function index '"+c_func+"'");return undefined}if(h<0||wl<0||wr<0){error(1,null,"%%deco: cannot have a negative value '"+text+"'");return undefined}if(h>50||wl>80||wr>80){error(1,null,"%%deco: abnormal h/wl/wr value "+text+"'");return undefined}dd=dd_tb[a[1]];if(!dd){dd={name:a[1]};dd_tb[a[1]]=dd}dd.func=c_func;dd.glyph=a[3];dd.h=h;dd.wl=wl;dd.wr=wr;str=text.replace(a[0],"").trim();if(str){if(str[0]=='"')str=str.slice(1,-1);dd.str=str}c=dd.name[dd.name.length-1];if(c=="("||c==")"&&dd.name.indexOf("(")<0){if(c=="(")dd.ldst=true;else dd.lden=true;name2=dd.name.slice(0,-1)+(c=="("?")":"(");dd2=dd_tb[name2];if(dd2){if(c=="(")dd.ld_en_dd=dd2;else dd2.ld_en_dd=dd}}return dd}function deco_cnv(a_dcn,s,prev){var i,j,dd,dcn,note,n=a_dcn.length;for(i=0;i<n;i++){dcn=a_dcn[i];dd=dd_tb[dcn];if(!dd){dd=deco_def(dcn);if(!dd){if(cfmt.decoerr)error(1,s,"Unknown decoration '"+dcn+"'");continue}}switch(dd.func){default:if(dd.name.slice(0,5)=="head-"){if(!s.notes){error(1,s,"!"+dd.name+"! must be on a note or rest");break}for(j=0;j<=s.nhd;j++){note=s.notes[j];if(!note.a_dcn)note.a_dcn=[];note.a_dcn.push(dd.name)}}else{if(!s.a_dd)s.a_dd=[];s.a_dd.push(dd)}break;case 32:s.invisible=true;break;case 33:if(s.type!=BAR){error(1,s,"!beamon! must be on a bar");break}s.beam_on=true;break;case 34:if(s.type!=NOTE||!prev||prev.type!=NOTE){error(1,s,"!"+dd.name+"! must be on the last of a couple of notes");break}s.trem2=true;s.beam_end=true;prev.trem2=true;prev.beam_st=true;s.ntrem=prev.ntrem=Number(dd.name[4]);s.nflags--;prev.nflags--;if(s.nflags>0){s.nflags+=s.ntrem;prev.nflags+=s.ntrem}else{if(s.nflags<=-2){s.stemless=true;prev.stemless=true}s.nflags=s.ntrem;prev.nflags=s.ntrem}for(j=0;j<=s.nhd;j++)s.notes[j].dur*=2;for(j=0;j<=prev.nhd;j++)prev.notes[j].dur*=2;break;case 35:if(s.type!=NOTE){error(1,s,"!xstem! must be on a note");break}s.xstem=true;s.nflags=0;break;case 36:if(s.type!=NOTE){error(1,s,"!"+dd.name+"! must be on a note");break}if(dd.name[6]=="1")s.beam_br1=true;else s.beam_br2=true;break;case 37:s.rbstop=1;break;case 38:if(s.type!=NOTE){error(1,s,"!"+dd.name+"! must be on a note");break}s.trem1=true;s.ntrem=dd.name.length;if(s.nflags>0)s.nflags+=s.ntrem;else s.nflags=s.ntrem;break;case 39:if(s.type!=NOTE){error(1,s,"!"+dd.name+"! must be on a note");break}s.feathered_beam=dd.name[5]=="a"?1:-1;break;case 40:s.stemless=true;break;case 41:s.rbstop=2;break}}}function deco_def(name){var i,n,dn=name+" ";if(user_deco_tb){n=user_deco_tb.length;for(i=0;i<n;i++){if(user_deco_tb[i].indexOf(dn)==0)return deco_build(user_deco_tb[i])}}n=std_deco_tb.length;for(i=0;i<n;i++){if(std_deco_tb[i].indexOf(dn)==0)return deco_build(std_deco_tb[i])}return undefined}function deco_update(s,dx){var i,de,n=a_de.length;for(i=0;i<n;i++){de=a_de[i];if(de.s==s)de.x+=dx}}function deco_width(s){var dd,i,wl=0,a_dd=s.a_dd,n=a_dd.length;for(i=i=0;i<n;i++){dd=a_dd[i];switch(dd.func){case 1:if(wl<7)wl=7;break;case 2:if(wl<14)wl=14;break}}if(wl!=0&&s.prev&&s.prev.type==BAR)wl-=3;return wl}function draw_all_deco(){if(a_de.length==0)return;var de,de2,dd,f,st,x,y,y2,ym,uf,i,ymid=[];if(!cfmt.dynalign){st=nstaff;y=staff_tb[st].y;while(--st>=0){y2=staff_tb[st].y;ymid[st]=(y+24+y2)*.5;y=y2}}while(1){de=a_de.shift();if(!de)break;dd=de.dd;if(dd.ldst&&dd.ld_en_dd)continue;f=dd.glyph;i=f.indexOf("/");if(i>0){if(de.s.stem>=0)f=f.slice(0,i);else f=f.slice(i+1)}st=de.st;y=de.y+staff_tb[st].y;if(dd.func>=6&&!cfmt.dynalign&&(de.flags.up&&st>0||!de.flags.up&&st<nstaff)){if(de.flags.up)ym=ymid[--st];else ym=ymid[st++];ym-=dd.h*.5;if(de.flags.up&&y<ym||!de.flags.up&&y>ym){y2=y_get(st,!de.flags.up,de.x,de.val)+staff_tb[st].y;if(de.flags.up)y2-=dd.h;if(de.flags.up&&y2>ym||!de.flags.up&&y2<ym){y=ym;y_set(st,de.flags.up,de.x,de.val,(de.flags.up?y+dd.h:y)-staff_tb[st].y)}}}set_scale(de.s);x=de.x;uf=user[f];if(uf&&typeof uf=="function"){uf(x,y,de);continue}if(psdeco(f,x,y,de))continue;if(de.flags.grace){output.push('<g transform="translate(');out_sxsy(x,",",y);if(de.flags.inv)output.push(') scale(0.7, -0.7)">\n');else output.push(') scale(0.7)">\n');stv_g.trans=true;x=y=0}else if(de.flags.inv){output.push('<g transform="translate(');out_sxsy(x,",",y);output.push(') scale(1, -1)">\n');stv_g.trans=true;x=y=0}if(de.flags.val){if(dd.func!=2||stv_g.st<0)out_deco_val(x,y,f,de.val/stv_g.scale,de.defl);else out_deco_val(x,y,f,de.val,de.defl)}else if(de.str){out_deco_str(x,y+de.dy+dd.h*.2,f,de.str)}else{xygl(x,y,f)}if(stv_g.trans){stv_g.trans=false;output.push("</g>\n")}}}function draw_deco_head(dcn,x,y,stem){var f,str,uf,dd=dd_tb[dcn],de;if(!dd){dd=deco_def(dcn);if(!dd){error(1,null,"Unknown decoration '"+dcn+"'");return false}}f=dd.glyph;if(pshdeco(f,x,y,dd))return dd.name.indexOf("head-")==0;if(dd.str){de={x:x};set_str(de,dd.str);out_deco_str(de.x,y+de.dy,f,de.str)}else{switch(dd.func){default:xygl(x,y,f);break;case 2:case 5:case 7:error(1,null,"Cannot have !"+dd.name+"! on a head");break;case 3:case 4:xygl(x,y,f);break}}return dd.name.indexOf("head-")==0}function create_deco(s){var dd,k,l,pos,de,n=s.a_dd.length;for(k=0;k<n;k++){dd=s.a_dd[k];switch(dd.func){default:pos=0;break;case 3:case 4:case 5:pos=s.pos.orn;break;case 6:pos=s.pos.vol;break;case 7:pos=s.pos.dyn;break}if(pos==SL_HIDDEN)continue;if(dd.name.indexOf("head-")==0){switch(s.type){case NOTE:case REST:break;default:error(1,s,"Cannot have !"+dd.name+"! on a bar");break}continue}de={s:s,dd:dd,st:s.st,ix:a_de.length,flags:{},defl:{},dy:0};a_de.push(de);if(s.grace)de.flags.grace=true;if(dd.ldst){de.flags.ldst=true}else if(dd.lden){de.flags.lden=true;de.defl.nost=true}if(dd.func>=3)continue;if(s.type!=NOTE){error(1,s,"Cannot have !"+dd.name+"! on a rest or a bar");continue}func_tb[dd.func](de)}}function draw_deco_near(){var s,g,dd,first;for(s=tsfirst;s;s=s.ts_next){switch(s.type){case BAR:case MREST:break;case NOTE:case REST:case SPACE:if(!first)first=s;break;case GRACE:for(g=s.extra;g;g=g.next){if(!g.a_dd)continue;create_deco(g)}continue;default:continue}if(s.a_dd)create_deco(s)}first_note=first}function draw_deco_note(){var i,j,n_dede,de2,dd,dd2,f,t,st,v;n_de=a_de.length;for(i=0;i<n_de;i++){de=a_de[i];if(!de.flags.ldst)continue;dd=de.dd;dd2=dd.ld_en_dd;if(!dd2){dd2={name:dd.name.slice(0,-1)+")",func:dd.func,glyph:dd.glyph,h:dd.h};dd.ld_en_dd=dd2}v=de.s.v;for(j=i+1;j<n_de;j++){de2=a_de[j];if(de2.dd==dd2&&de2.s.v==v)break}if(j==n_de){st=de.s.st;for(j=i+1;j<n_de;j++){de2=a_de[j];if(de2.dd==dd2&&de2.s.st==st)break}}if(j==n_de){de2={s:de.s,st:de.st,dd:dd2,ix:a_de.length-1,x:realwidth-6,y:de.s.y,flags:{lden:true},defl:{noen:true}};a_de.push(de2)}de2.start=de;delete de2.defl.nost}for(i=0;i<n_de;i++){de=a_de[i];dd=de.dd;f=dd.func;if(f<3||f>=6)continue;func_tb[f](de)}}function draw_deco_staff(){var s,first_gchord,p_voice,x,y,w,i,n,v,de,dd,gch,gch2,ix,minmax=new Array(nstaff);function draw_repbra(p_voice){var s,s1,y,y2,i,p,w,first_repeat;y=staff_tb[p_voice.st].topbar+6+20;for(s=p_voice.sym;s;s=s.next){if(s.type!=BAR)continue;if(!s.rbstart||s.norepbra)continue;if(!s.next)break;if(!first_repeat)first_repeat=s;s1=s;for(;;){if(!s.next)break;s=s.next;if(s.rbstop)break}y2=y_get(p_voice.st,true,s1.x,s.x-s1.x);if(y<y2)y=y2;if(s1.text){w=strw(s1.text);y2=y_get(p_voice.st,true,s1.x+4,w);y2+=gene.curfont.size+2;if(y<y2)y=y2}if(s.rbstart)s=s.prev}s=first_repeat;if(!s)return;set_dscale(p_voice.st);set_font("repeat");y2=y*staff_tb[p_voice.st].staffscale;for(;s;s=s.next){if(!s.rbstart||s.norepbra)continue;s1=s;for(;;){if(!s.next)break;s=s.next;if(s.rbstop)break}if(s1==s)break;x=s1.x;if(s.type!=BAR){if(s.rbstop)w=0;else w=s.x-realwidth+4}else if(s.bar_type.length>1&&s.bar_type!="[]"||s.bar_type=="]"){if(s1.st>0&&!(cur_sy.staves[s1.st-1].flags&STOP_BAR)){w=s.wl}else if(s.bar_type[s.bar_type.length-1]==":"){w=12}else if(s.bar_type[0]!=":"||s.bar_type=="]"){w=0}else{w=8}}else{w=8}w=(s.x-x-w)/staff_tb[p_voice.st].staffscale;if(!s.next&&!s.rbstop&&!p_voice.bar_start){p_voice.bar_start=clone(s);p_voice.bar_start.bar_type="[";p_voice.bar_start.text=undefined;p_voice.bar_start.rbstart=1;delete p_voice.bar_start.a_gch}if(s1.text)xy_str(x+4,y2-gene.curfont.size*.9,s1.text);xypath(x,y2);if(s1.rbstart==2)output.push("m0 20v-20");output.push("h");output.push(w.toFixed(2));if(s.rbstop==2)output.push("v20");output.push('"/>\n');y_set(s1.st,true,x,w,y+2);if(s.rbstart)s=s.prev}}for(i=0;i<=nstaff;i++)minmax[i]={ymin:0,ymax:24};for(s=tsfirst;s;s=s.ts_next){if(!s.a_gch)continue;if(!first_gchord)first_gchord=s;n=s.a_gch.length;for(ix=0;ix<n;ix++){gch=s.a_gch[ix];if(gch.type!="g")continue;gch2=gch;if(gch.y<0)break}if(gch2){w=gch2.w;if(gch2.y>=0){y=y_get(s.st,true,s.x,w);if(y>minmax[s.st].ymax)minmax[s.st].ymax=y}else{y=y_get(s.st,false,s.x,w);if(y<minmax[s.st].ymin)minmax[s.st].ymin=y}}}if(first_gchord){for(i=0;i<=nstaff;i++){var bot=staff_tb[i].botbar;minmax[i].ymin-=3;if(minmax[i].ymin>bot-10)minmax[i].ymin=bot-10;var top=staff_tb[i].topbar;minmax[i].ymax+=3;if(minmax[i].ymax<top+10)minmax[i].ymax=top+10}set_sscale(-1);for(s=first_gchord;s;s=s.ts_next){if(!s.a_gch)continue;switch(s.type){case NOTE:case REST:case SPACE:case MREST:break;case BAR:if(s.text==undefined)break;default:continue}draw_gchord(s,minmax[s.st].ymin,minmax[s.st].ymax)}}n=voice_tb.length;for(v=0;v<n;v++){p_voice=voice_tb[v];if(p_voice.second||!p_voice.sym)continue;draw_repbra(p_voice)}for(i=0;i<=nstaff;i++)minmax[i]={ymin:0,ymax:0};n=a_de.length;for(i=0;i<n;i++){de=a_de[i];dd=de.dd;if(dd.func<6)continue;func_tb[dd.func](de);if(dd.ldst)continue;if(cfmt.dynalign){if(de.flags.up){if(de.y>minmax[de.st].ymax)minmax[de.st].ymax=de.y}else{if(de.y<minmax[de.st].ymin)minmax[de.st].ymin=de.y}}}for(i=0;i<n;i++){de=a_de[i];dd=de.dd;if(dd.ldst||dd.func<6)continue;if(cfmt.dynalign){if(de.flags.up)y=minmax[de.st].ymax;else y=minmax[de.st].ymin;de.y=y}else{y=de.y}if(de.flags.up)y+=dd.h;y_set(de.st,de.flags.up,de.x,de.val,y)}}function draw_measnb(){var s,st,bar_num,x,y,w,h,any_nb,font_size,sy=cur_sy;for(st=0;st<=nstaff;st++){if(!sy.staves[st].empty)break}if(st>nstaff)return;set_dscale(st);if(staff_tb[st].staffscale!=1){font_size=get_font("measure").size;param_set_font("measurefont","* "+(font_size/staff_tb[st].staffscale).toString())}set_font("measure");s=tsfirst;bar_num=gene.nbar;if(bar_num>1){if(cfmt.measurenb==0){any_nb=true;y=y_get(st,true,0,20);if(y<staff_tb[st].topbar+14)y=staff_tb[st].topbar+14;xy_str(0,y,bar_num.toString());y_set(st,true,0,20,y+gene.curfont.size+2)}else if(bar_num%cfmt.measurenb==0){for(;;s=s.ts_next){switch(s.type){case METER:case CLEF:case KEY:case FORMAT:case STBRK:continue}break}while(s.st!=st)s=s.ts_next;if(s.prev.type!=CLEF)s=s.prev;x=s.x-s.wl;any_nb=true;w=cwid("0")*gene.curfont.swfac;if(bar_num>=10){if(bar_num>=100)w*=3;else w*=2}if(cfmt.measurebox)w+=4;y=y_get(st,true,x,w);if(y<staff_tb[st].topbar+6)y=staff_tb[st].topbar+6;y+=2;xy_str(x,y,bar_num.toString());if(cfmt.measurebox){h=gene.curfont.size+3;w+=3;xybox(x-1,y-3+h,w,h)}y+=gene.curfont.size;y_set(st,true,x,w,y);s.ymx=y}}for(;s;s=s.ts_next){if(s.new_sy){sy=sy.next;for(st=0;st<nstaff;st++){if(!sy.staves[st].empty)break}set_sscale(st)}if(s.type!=BAR||!s.bar_num)continue;bar_num=s.bar_num;if(cfmt.measurenb==0||bar_num%cfmt.measurenb!=0||!s.next)continue;if(!any_nb)any_nb=true;w=cwid("0")*gene.curfont.swfac;if(bar_num>=10){if(bar_num>=100)w*=3;else w*=2}if(cfmt.measurebox)w+=4;x=s.x-w*.4;y=y_get(st,true,x,w);if(y<staff_tb[st].topbar+6)y=staff_tb[st].topbar+6;if(s.next.type==NOTE){if(s.next.stem>0){if(y<s.next.ys-gene.curfont.size)y=s.next.ys-gene.curfont.size}else{if(y<s.next.y)y=s.next.y}}y+=2;xy_str(x,y,bar_num.toString());if(cfmt.measurebox){h=gene.curfont.size+3;w+=3;xybox(x-1,y-3+h,w,h)}y+=gene.curfont.size;y_set(st,true,x,w,y);s.ymx=y}gene.nbar=bar_num;if(font_size)param_set_font("measurefont","* "+font_size.toString())}function draw_notempo(s,x,y,dur,sc){var dx,p,dotx,elts=identify_note(s,dur),head=elts[0],dots=elts[1],nflags=elts[2];if(stv_g.started){output.push("</g>\n");stv_g.started=false}output.push('<g transform="translate(');out_sxsy(x+8,",",y+3);output.push(") scale("+sc+')">\n');switch(head){case"oval":p="HD";break;case"empty":p="Hd";break;default:p="hd";break}xygl(-posx,posy,p);dx=4;if(dots){dotx=8;if(nflags>0)dotx+=4;switch(head){case"square":case"oval":dotx+=2;break;case"empty":dotx+=1;break}dx=dotx*dots;dotx-=posx;while(--dots>=0){out_dot(dotx,posy);dotx+=3.5}}if(dur<BASE_LEN){if(nflags<=0){out_stem(-posx,posy,21)}else{out_stem(-posx,posy,21,false,nflags);if(dx<6)dx=6}}output.push("\n</g>\n");return(dx+15)*sc}function tempo_width(s){var i,n,w=0;set_font("tempo");if(s.tempo_str1)w=strw(s.tempo_str1);if(s.tempo_value){i=1;n=s.tempo_notes.length;while(i<n){w+=10;i++}w+=6+cwid(" ")*gene.curfont.swfac*6+10+10}if(s.tempo_str2)w+=strw(s.tempo_str2);return w}function write_tempo(s,x,y,sc){var j,n,top,bot,dx,res;set_font("tempo");if(s.tempo_str1){xy_str(x,y,s.tempo_str1);x+=strw(s.tempo_str1)+6}if(s.tempo_value){sc*=.7*gene.curfont.size/15;n=s.tempo_notes.length;for(j=0;j<n;j++)x+=draw_notempo(s,x,y,s.tempo_notes[j],sc);x+=5;xy_str(x,y,"=");x+=strw("= ")+5;if(s.tempo_value.indexOf("/")<0){xy_str(x,y,s.tempo_value.toString());dx=cwid("0")*gene.curfont.swfac;x+=dx+5;if(s.tempo_value>=10){x+=dx;if(s.tempo_value>=100)x+=dx}}else{res=s.tempo_value.split("/");if(res.length==2&&Number(res[1])>0)draw_notempo(s,x,y,res[0]*BASE_LEN/res[1],sc)}}if(s.tempo_str2)xy_str(x,y,s.tempo_str2)}function draw_partempo(st,top){var s,g,some_part,some_tempo,h,w,y,dy=0,ht=0;var ymin=staff_tb[st].topbar+12,dosh=0,shift=1,x=0;for(s=tsfirst;s;s=s.ts_next){g=s.extra;if(!g)continue;for(;g;g=g.next)if(g.type==TEMPO)break;if(!g)continue;if(!some_tempo)some_tempo=true;w=tempo_width(g);y=y_get(st,true,s.x-5,w)+2;if(y>ymin)ymin=y;if(x>=s.x-5&&!(dosh&shift>>1))dosh|=shift;shift<<=1;x=s.x-5+w}if(some_tempo){set_font("tempo");ht=gene.curfont.size+2+2;y=2-ht;h=y-ht;if(dosh!=0)ht*=2;if(top<ymin+ht)dy=ymin+ht-top;for(s=tsfirst;s;s=s.ts_next){if(!s.seqst)continue;g=s.extra;for(;g;g=g.next)if(g.type==TEMPO&&!g.deleted)break;if(!g)continue;if(user.anno_start||user.anno_stop){g.x=s.x;g.wl=5;g.wr=40;g.ymn=dosh&1?h:y;g.ymx=g.ymn+14;if(user.anno_start)anno_start(g)}write_tempo(g,s.x-5,dosh&1?h:y,1);if(user.anno_stop)anno_stop(g);dosh>>=1}}ymin=staff_tb[st].topbar+14;for(s=tsfirst;s;s=s.ts_next){g=s.extra;if(!g)continue;for(;g;g=g.next)if(g.type==PART)break;if(!g)continue;if(!some_part){some_part=true;set_font("parts");h=gene.curfont.size+2+2}w=strw(g.text);y=y_get(st,true,s.x-10,w+15)+5;if(ymin<y)ymin=y}if(some_part){if(top<ymin+h+ht)dy=ymin+h+ht-top;for(s=tsfirst;s;s=s.ts_next){g=s.extra;if(!g)continue;for(;g;g=g.next)if(g.type==PART)break;if(!g)continue;if(user.anno_start||user.anno_stop){g.x=s.x-10;w=strw(g.text);g.wl=0;g.wr=w;g.ymn=2-ht-h;g.ymx=g.ymn+h;if(user.anno_start)anno_start(g)}xy_str(s.x-10,2-ht-h,g.text);if(cfmt.partsbox){w=strw(g.text)+4;xybox(s.x-10-2,2-ht-4,w,h)}if(user.anno_stop)anno_stop(g)}}return dy}const STEM_MIN=16,STEM_MIN2=14,STEM_MIN3=12,STEM_MIN4=10,STEM_CH_MIN=14,STEM_CH_MIN2=10,STEM_CH_MIN3=9,STEM_CH_MIN4=9,BEAM_DEPTH=3.2,BEAM_OFFSET=.25,BEAM_SHIFT=5,BEAM_FLATFAC=.6,BEAM_THRESH=.06,BEAM_SLOPE=.5,BEAM_STUB=6,SLUR_SLOPE=1,GSTEM=14,GSTEM_XOFF=1.6;function b_pos(grace,stem,nflags,b){var top,bot,d1,d2,shift=!grace?BEAM_SHIFT:3,depth=!grace?BEAM_DEPTH:1.7;function rnd6(y){var iy=Math.round((y+12)/6)*6-12;return iy-y}if(stem>0){bot=b-(nflags-1)*shift-depth;if(bot>26)return 0;top=b}else{top=b+(nflags-1)*shift+depth;if(top<-2)return 0;bot=b}d1=rnd6(top-BEAM_OFFSET);d2=rnd6(bot+BEAM_OFFSET);if(d1*d1>d2*d2)return d2;return d1}function sym_dup(s_orig){var m,note,s=clone(s_orig);s.invisible=true;delete s.text;delete s.a_gch;delete s.a_ly;delete s.a_dd;s.notes=clone(s_orig.notes);for(m=0;m<=s.nhd;m++){note=s.notes[m]=clone(s_orig.notes[m]);delete note.a_dcn}return s}const min_tb=[[STEM_MIN,STEM_MIN,STEM_MIN2,STEM_MIN3,STEM_MIN4,STEM_MIN4],[STEM_CH_MIN,STEM_CH_MIN,STEM_CH_MIN2,STEM_CH_MIN3,STEM_CH_MIN4,STEM_CH_MIN4]];function calculate_beam(bm,s1){var s,s2,notes,nflags,st,v,two_staves,two_dir,hh,x,y,ys,a,b,stem_err,max_stem_err,sx,sy,sxx,sxy,syy,a0,stem_xoff,scale;if(!s1.beam_st){s=sym_dup(s1);s.prev=s1.prev;if(s.prev)s.prev.next=s;else voice_tb[s.v].sym=s;s1.prev=s;s.next=s1;s1.ts_prev.ts_next=s;s.ts_prev=s1.ts_prev;s1.ts_prev=s;s.ts_next=s1;s.x-=12;if(s.x>s1.prev.x+12)s.x=s1.prev.x+12;s.beam_st=true;delete s.beam_end;s.tmp=true;s.slur_start=0;delete s.slur_end;s1=s}notes=nflags=0;two_staves=two_dir=false;st=s1.st;v=s1.v;stem_xoff=s1.grace?GSTEM_XOFF:3.5;for(s2=s1;;s2=s2.next){if(s2.type==NOTE){if(s2.nflags>nflags)nflags=s2.nflags;notes++;if(s2.st!=st)two_staves=true;if(s2.stem!=s1.stem)two_dir=true;if(s2.beam_end)break}if(!s2.next){for(;;s2=s2.prev){if(s2.type==NOTE)break}s=sym_dup(s2);s.next=s2.next;if(s.next)s.next.prev=s;s2.next=s;s.prev=s2;s.ts_next=s2.ts_next;if(s.ts_next)s.ts_next.ts_prev=s;s2.ts_next=s;s.ts_prev=s2;delete s.beam_st;s.beam_end=true;s.tmp=true;delete s.slur_start;delete s.slur_end;s.x+=12;if(s.x<realwidth-12)s.x=realwidth-12;s2=s;notes++;break}}bm.s2=s2;if(staff_tb[st].y==0){if(two_staves)return false}else{if(!two_staves){bm.s1=s1;bm.a=(s1.ys-s2.ys)/(s1.xs-s2.xs);bm.b=s1.ys-s1.xs*bm.a+staff_tb[st].y;bm.nflags=nflags;return true}}sx=sy=sxx=sxy=syy=0;for(s=s1;;s=s.next){if(s.type!=NOTE)continue;if((scale=voice_tb[s.v].scale)==1)scale=staff_tb[s.st].staffscale;if(s.stem>=0)x=stem_xoff+s.notes[0].shhd;else x=-stem_xoff+s.notes[s.nhd].shhd;x*=scale;x+=s.x;s.xs=x;y=s.ys+staff_tb[s.st].y;sx+=x;sy+=y;sxx+=x*x;sxy+=x*y;syy+=y*y;if(s==s2)break}a=(sxy*notes-sx*sy)/(sxx*notes-sx*sx);b=(sy-a*sx)/notes;if(!s1.grace){if(notes>=3){hh=syy-a*sxy-b*sy;if(hh>0&&hh/(notes-2)>.5)a*=BEAM_FLATFAC}if(a>=0)a=BEAM_SLOPE*a/(BEAM_SLOPE+a);else a=BEAM_SLOPE*a/(BEAM_SLOPE-a)}else{if(a>BEAM_SLOPE)a=BEAM_SLOPE;else if(a<-BEAM_SLOPE)a=-BEAM_SLOPE}a0=a*(s2.xs-s1.xs)/(20*(notes-1));if(a0*a0<BEAM_THRESH*BEAM_THRESH)a=0;b=(sy-a*sx)/notes;if(cfmt.flatbeams){if(!s1.grace)b=-11+staff_tb[st].y;else b=35+staff_tb[st].y;a=0}max_stem_err=0;s=s1;if(two_dir){if(!s1.grace)ys=BEAM_SHIFT;else ys=3;ys*=nflags-1;ys+=BEAM_DEPTH;ys*=.5;if(s1.stem!=s2.stem&&s1.nflags<s2.nflags)ys*=s2.stem;else ys*=s1.stem;b+=ys}else if(!s1.grace){var beam_h=BEAM_DEPTH+BEAM_SHIFT*(nflags-1);while(s.ts_prev&&s.ts_prev.type==NOTE&&s.ts_prev.time==s.time&&s.ts_prev.x>s1.xs)s=s.ts_prev;for(;s&&s.time<=s2.time;s=s.ts_next){if(s.type!=NOTE||s.invisible||s.st!=st&&s.v!=v){continue}x=s.v==v?s.xs:s.x;ys=a*x+b-staff_tb[s.st].y;if(s.v==v){if(s.nhd==0)stem_err=min_tb[0][s.nflags];else stem_err=min_tb[1][s.nflags];if(s.stem>0){if(s.notes[s.nhd].pit>26){stem_err-=2;if(s.notes[s.nhd].pit>28)stem_err-=2}stem_err-=ys-3*(s.notes[s.nhd].pit-18)}else{if(s.notes[0].pit<18){stem_err-=2;if(s.notes[0].pit<16)stem_err-=2}stem_err-=3*(s.notes[0].pit-18)-ys}stem_err+=BEAM_DEPTH+BEAM_SHIFT*(s.nflags-1)}else{if(s1.stem>0){if(s.stem>0){if(s.ymn>ys+4||s.ymx<ys-beam_h-2)continue;if(s.v>v)stem_err=s.ymx-ys;else stem_err=s.ymn+8-ys}else{stem_err=s.ymx-ys}}else{if(s.stem<0){if(s.ymx<ys-4||s.ymn>ys-beam_h-2)continue;if(s.v<v)stem_err=ys-s.ymn;else stem_err=ys-s.ymx+8}else{stem_err=ys-s.ymn}}stem_err+=2+beam_h}if(stem_err>max_stem_err)max_stem_err=stem_err}}else{for(;;s=s.next){ys=a*s.xs+b-staff_tb[s.st].y;stem_err=GSTEM-2;if(s.stem>0)stem_err-=ys-3*(s.notes[s.nhd].pit-18);else stem_err+=ys-3*(s.notes[0].pit-18);stem_err+=3*(s.nflags-1);if(stem_err>max_stem_err)max_stem_err=stem_err;if(s==s2)break}}if(max_stem_err>0)b+=s1.stem*max_stem_err;if(!two_staves&&!two_dir)for(s=s1.next;;s=s.next){var g;switch(s.type){case REST:g=s.ts_next;if(!g||g.st!=st||g.type!=NOTE&&g.type!=REST)break;case BAR:if(s.invisible)break;case CLEF:y=a*s.x+b;if(s1.stem>0){y=s.ymx-y+BEAM_DEPTH+BEAM_SHIFT*(nflags-1)+2;if(y>0)b+=y}else{y=s.ymn-y-BEAM_DEPTH-BEAM_SHIFT*(nflags-1)-2;if(y<0)b+=y}break;case GRACE:g=s.extra;for(;g;g=g.next){if(g.type!=NOTE)continue;y=a*g.x+b;if(s1.stem>0){y=g.ymx-y+BEAM_DEPTH+BEAM_SHIFT*(nflags-1)+2;if(y>0)b+=y}else{y=g.ymn-y-BEAM_DEPTH-BEAM_SHIFT*(nflags-1)-2;if(y<0)b+=y}}break}if(s==s2)break}if(a==0)b+=b_pos(s1.grace,s1.stem,nflags,b-staff_tb[st].y);for(s=s1;;s=s.next){var dy;switch(s.type){case NOTE:s.ys=a*s.xs+b-staff_tb[s.st].y;if(s.stem>0){s.ymx=s.ys+2.5;if(s.ts_prev&&s.ts_prev.stem>0&&s.ts_prev.st==s.st&&s.ts_prev.ymn<s.ymx&&s.ts_prev.x==s.x&&s.notes[0].shhd==0){s.ts_prev.x-=5;s.ts_prev.xs-=5}}else{s.ymn=s.ys-2.5}break;case REST:y=a*s.x+b-staff_tb[s.st].y;dy=BEAM_DEPTH+BEAM_SHIFT*(nflags-1)+(s.head!="full"?4:9);if(s1.stem>0){y-=dy;if(s1.multi==0&&y>12)y=12;if(s.y<=y)break}else{y+=dy;if(s1.multi==0&&y<12)y=12;if(s.y>=y)break}if(s.head!="full")y=Math.floor((y+3+12)/6)*6-12;s.y=y;break}if(s==s2)break}if(staff_tb[st].y==0)return false;bm.s1=s1;bm.a=a;bm.b=b;bm.nflags=nflags;return true}function draw_beams(bm){var s,i,beam_dir,shift,bshift,bstub,bh,da,k,k1,k2,x1,s1=bm.s1,s2=bm.s2;function draw_beam(x1,x2,dy,h,bm,n){var y1,dy2,s=bm.s1,nflags=s.nflags;if(s.ntrem)nflags-=s.ntrem;if(s.trem2&&n>nflags){if(s.dur>=BASE_LEN/2){x1=s.x+6;x2=bm.s2.x-6}else if(s.dur<BASE_LEN/4){x1+=5;x2-=6}}y1=bm.a*x1+bm.b-dy;x2-=x1;x2/=stv_g.scale;
dy2=bm.a*x2*stv_g.scale;xypath(x1,y1,true);output.push("l"+x2.toFixed(2)+" "+(-dy2).toFixed(2)+"v"+h.toFixed(2)+"l"+(-x2).toFixed(2)+" "+dy2.toFixed(2)+'"/>\n')}if(!s1.grace){bshift=BEAM_SHIFT;bstub=BEAM_STUB;shift=.34;bh=BEAM_DEPTH}else{bshift=3;bstub=3.2;shift=.29;bh=1.6}beam_dir=s1.stem;if(s1.stem!=s2.stem&&s1.nflags<s2.nflags)beam_dir=s2.stem;if(beam_dir<0)bh=-bh;draw_beam(s1.xs-shift,s2.xs+shift,0,bh,bm,1);da=0;for(s=s1;;s=s.next){if(s.type==NOTE&&s.stem!=beam_dir)s.ys=bm.a*s.xs+bm.b-staff_tb[s.st].y+bshift*(s.nflags-1)*s.stem-bh;if(s==s2)break}if(s1.feathered_beam){da=bshift/(s2.xs-s1.xs);if(s1.feathered_beam>0){da=-da;bshift=da*s1.xs}else{bshift=da*s2.xs}da=da*beam_dir}shift=0;for(i=2;i<=bm.nflags;i++){shift+=bshift;if(da!=0)bm.a+=da;for(s=s1;;s=s.next){if(s.type!=NOTE||s.nflags<i){if(s==s2)break;continue}if(s.trem1&&i>s.nflags-s.ntrem){if(s.dur>=BASE_LEN/2)x1=s.x;else x1=s.xs;draw_beam(x1-5,x1+5,(shift+2.5)*beam_dir,bh,bm,i);if(s==s2)break;continue}k1=s;while(1){if(s==s2)break;k=s.next;if(k.type==NOTE||k.type==REST){if(k.trem1){if(k.nflags-k.ntrem<i)break}else if(k.nflags<i){break}}if(k.beam_br1||k.beam_br2&&i>2)break;s=k}k2=s;while(k2.type!=NOTE)k2=k2.prev;x1=k1.xs;if(k1==k2){if(k1==s1){x1+=bstub}else if(k1==s2){x1-=bstub}else if(k1.beam_br1||k1.beam_br2&&i>2){x1+=bstub}else{k=k1.next;while(k.type!=NOTE)k=k.next;if(k.beam_br1||k.beam_br2&&i>2){x1-=bstub}else{k1=k1.prev;while(k1.type!=NOTE)k1=k1.prev;if(k1.nflags<k.nflags||k1.nflags==k.nflags&&k1.dots<k.dots)x1+=bstub;else x1-=bstub}}}draw_beam(x1,k2.xs,shift*beam_dir,bh,bm,i);if(s==s2)break}}if(s1.tmp)unlksym(s1);else if(s2.tmp)unlksym(s2)}function draw_lstaff(x){if(cfmt.alignbars)return;var i,j,yb,h,nst=cur_sy.nstaff,l=0;function draw_sysbra(x,st,flag){var i,st_end,yt,yb;while(cur_sy.staves[st].empty){if(cur_sy.staves[st].flags&flag)return;st++}i=st_end=st;while(1){if(!cur_sy.staves[i].empty)st_end=i;if(cur_sy.staves[i].flags&flag)break;i++}yt=staff_tb[st].y+staff_tb[st].topbar*staff_tb[st].staffscale;yb=staff_tb[st_end].y+staff_tb[st_end].botbar*staff_tb[st_end].staffscale;if(flag&(CLOSE_BRACE|CLOSE_BRACE2))out_brace(x,yb,yt-yb);else out_bracket(x,yt,yt-yb)}for(i=0;;i++){if(cur_sy.staves[i].flags&(OPEN_BRACE|OPEN_BRACKET))l++;if(!cur_sy.staves[i].empty)break;if(cur_sy.staves[i].flags&(CLOSE_BRACE|CLOSE_BRACKET))l--;if(i==nst)break}for(j=nst;j>i;j--){if(!cur_sy.staves[j].empty)break}if(i==j&&l==0)return;yb=staff_tb[j].y+staff_tb[j].botbar*staff_tb[j].staffscale;h=staff_tb[i].y+staff_tb[i].topbar*staff_tb[i].staffscale-yb;xypath(x,yb);output.push("v"+(-h).toFixed(2)+'"/>\n');for(i=0;i<=nst;i++){if(cur_sy.staves[i].flags&OPEN_BRACE)draw_sysbra(x,i,CLOSE_BRACE);if(cur_sy.staves[i].flags&OPEN_BRACKET)draw_sysbra(x,i,CLOSE_BRACKET);if(cur_sy.staves[i].flags&OPEN_BRACE2)draw_sysbra(x-6,i,CLOSE_BRACE2);if(cur_sy.staves[i].flags&OPEN_BRACKET2)draw_sysbra(x-6,i,CLOSE_BRACKET2)}}function draw_meter(x,s){if(!s.a_meter)return;var dx,i,st=s.st,y=staff_tb[st].y;x-=s.wl;for(i=0;i<s.a_meter.length;i++){var meter=s.a_meter[i],f;if(meter.top=="C|")dx=13;else dx=13*meter.top.length;if(meter.bot){if(meter.bot.length>meter.top.length)dx=13*meter.bot.length;output.push('<g style="font:bold 16px serif"\n	transform="translate(');out_sxsy(x+dx*.5,",",y);output.push(') scale(1.2,1)">\n	<text y="-12" text-anchor="middle">'+meter.top+'</text>\n	<text text-anchor="middle">'+meter.bot+"</text>\n</g>\n")}else{switch(meter.top[0]){case"C":f=meter.top[1]!="|"?"csig":"ctsig";x-=5;y+=12;break;case"c":f=meter.top[1]!="."?"imsig":"iMsig";break;case"o":f=meter.top[1]!="."?"pmsig":"pMsig";break;default:output.push('<g style="font:bold 18px serif"\n	transform="translate(');out_sxsy(x+dx*.5,",",y);output.push(') scale(1.2,1)">\n	<text y="-6" text-anchor="middle">'+meter.top+"</text>\n</g>\n");break}}if(f)xygl(x+dx*.5,y,f);x+=dx}}function draw_acc(x,y,acc,micro_n,micro_d){if(micro_n){if(micro_n==micro_d){if(acc==-1)acc=-2;else acc=2}else if(micro_n*2!=micro_d){xygl(x,y,"acc"+acc+"_"+micro_n+"_"+micro_d);return}}xygl(x,y,"acc"+acc)}function draw_hl(x,yl,yu,st,hltype){var i,p_staff=staff_tb[st],staffb=p_staff.y,stafflines=p_staff.stafflines,top=(stafflines.length-1)*2*3;if(top-p_staff.botline<4)return;yl=Math.ceil(yl/6)*6;for(;yl<p_staff.botline;yl+=6)xygl(x,staffb+yl,hltype);yu-=yu%6;for(;yu>top;yu-=6)xygl(x,staffb+yu,hltype)}const sharp_cl=[24,9,15,21,6,12,18],flat_cl=[12,18,24,9,15,21,6],sharp1=[-9,12,-9,-9,12,-9],sharp2=[12,-9,12,-9,12,-9],flat1=[9,-12,9,-12,9,-12],flat2=[-12,9,-12,9,-12,9];function draw_keysig(p_voice,x,s){if(s.k_none)return;var old_sf=s.k_old_sf,st=p_voice.st,staffb=staff_tb[st].y,i,shift,p_seq,clef_ix=s.k_y_clef;if(clef_ix&1)clef_ix+=7;clef_ix/=2;while(clef_ix<0)clef_ix+=7;clef_ix%=7;if(!s.k_a_acc){if(cfmt.cancelkey||s.k_sf==0){if(s.k_sf==0||old_sf*s.k_sf<0){shift=sharp_cl[clef_ix];p_seq=shift>9?sharp1:sharp2;for(i=0;i<old_sf;i++){xygl(x,staffb+shift,"acc3");shift+=p_seq[i];x+=5.5}shift=flat_cl[clef_ix];p_seq=shift<18?flat1:flat2;for(i=0;i>old_sf;i--){xygl(x,staffb+shift,"acc3");shift+=p_seq[-i];x+=5.5}if(s.k_sf!=0)x+=3}}if(s.k_sf>0){shift=sharp_cl[clef_ix];p_seq=shift>9?sharp1:sharp2;for(i=0;i<s.k_sf;i++){xygl(x,staffb+shift,"acc1");shift+=p_seq[i];x+=5.5}if(cfmt.cancelkey&&i<old_sf){x+=2;for(;i<old_sf;i++){xygl(x,staffb+shift,"acc3");shift+=p_seq[i];x+=5.5}}}if(s.k_sf<0){shift=flat_cl[clef_ix];p_seq=shift<18?flat1:flat2;for(i=0;i>s.k_sf;i--){xygl(x,staffb+shift,"acc-1");shift+=p_seq[-i];x+=5.5}if(cfmt.cancelkey&&s.k_sf>old_sf){x+=2;for(;i>old_sf;i--){xygl(x,staffb+shift,"acc3");shift+=p_seq[-i];x+=5.5}}}}else{var acc,last_acc=s.k_a_acc[0].acc,last_shift=100;for(i=0;i<s.k_a_acc.length;i++){acc=s.k_a_acc[i];shift=(s.k_y_clef+acc.pit-18)*3;if(i!=0&&(shift>last_shift+18||shift<last_shift-18))x-=5.5;else if(acc.acc!=last_acc)x+=3;last_acc=acc.acc;draw_hl(x,shift,shift,st,"hl");last_shift=shift;draw_acc(x,staffb+shift,acc.acc,acc.micro_n,acc.micro_d);x+=5.5}}}function bar_cnv(bar_type){switch(bar_type){case"[":case"[]":return"";case":":return"|";case"|:":case"|::":case"|:::":return"["+bar_type;case":|":case"::|":case":::|":return bar_type+"]";case"::":return cfmt.dblrepbar}return bar_type}function draw_bar(s,bot,h){var i,yb,st=s.st,x=s.x;if(s.bar_mrep){yb=staff_tb[st].y;set_scale(s);if(s.bar_mrep==1){for(var s2=s.prev;s2.type!=REST;s2=s2.prev);xygl(s2.x,yb,"mrep")}else{xygl(x,yb,"mrep2");if(s.v==cur_sy.top_voice){set_font("annotation");xy_str(x,yb+staff_tb[st].topbar+4,s.bar_mrep.toString(),"c")}}}if(st!=0&&s.ts_prev&&(s.ts_prev.type!=BAR||s.ts_prev.st!=st-1))h=staff_tb[st].topbar*staff_tb[st].staffscale;var dotted=s.bar_dotted||s.bar_type==":",bar_type=bar_cnv(s.bar_type);if(!bar_type)return;for(i=bar_type.length;--i>=0;){switch(bar_type[i]){case"|":set_sscale(-1);if(dotted)out_dotbar(x,bot,h);else out_bar(x,bot,h);break;default:x-=3;set_sscale(-1);out_thbar(x,bot,h);break;case":":x-=2;set_sscale(st);xygl(x+1,staff_tb[st].y,"rdots");break}x-=3}}const rest_tb=["r128","r64","r32","r16","r8","r4","r2","r1","r0","r00"];function draw_rest(s){var s2,i,j,k,x,y,dotx,staffb,yb,yt,p_staff=staff_tb[s.st];if(p_staff.empty)return;if(s.dur==voice_tb[s.v].meter.wmeasure){s2=s.ts_next;while(s2&&s2.time!=s.time+s.dur)s2=s2.ts_next;if(s2)x=s2.x;else x=realwidth;s2=s;while(!s2.seqst)s2=s2.ts_prev;s2=s2.ts_prev;x=(x+s2.x)/2;if(s.a_dd)deco_update(s,x-s.x);s.x=x}else{x=s.x;if(s.notes[0].shhd)x+=s.notes[0].shhd*stv_g.scale}if(s.invisible)return;staffb=p_staff.y;if(s.repeat_n){if(s.repeat_n<0){xygl(x,staffb,"srep")}else{xygl(x,staffb,"mrep");if(s.repeat_n>2&&s.v==cur_sy.top_voice){set_font("annotation");xy_str(x,staffb+24+4,s.repeat_n.toString(),"c")}}return}y=s.y;if(s.notes[0].a_dcn){for(k=0;k<note.a_dcn.length;k++){draw_deco_head(s.notes[0].a_dcn[k],x,y+staffb,s.stem)}return}i=5-s.nflags;if(i==7&&y==12&&p_staff.stafflines.length<=2)y-=6;xygl(x,y+staffb,rest_tb[i]);if(i>=6){j=y/6;switch(i){case 6:if(p_staff.stafflines[j]!="|")xygl(x,y+staffb,"hl");break;case 7:if(p_staff.stafflines[j+1]!="|")xygl(x,y+6+staffb,"hl");break;default:if(p_staff.stafflines[j+1]!="|")xygl(x,y+6+staffb,"hl");if(i==9){y-=6;j--}if(p_staff.stafflines[j]!="|")xygl(x,y+staffb,"hl");break}}x+=8;y+=staffb-3;for(i=0;i<s.dots;i++){out_dot(x,y);x+=3.5}}function draw_gracenotes(s){var yy,x0,y0,x1,y1,x2,y2,x3,y3,bet1,bet2,dy1,dy2,g,last,note,bm={};for(g=s.extra;g;g=g.next){if(g.type!=NOTE)continue;if(user.anno_start)anno_start(s);if(g.beam_st&&!g.beam_end){if(calculate_beam(bm,g))draw_beams(bm)}draw_note(g,!bm.s2);if(g==bm.s2)bm.s2=undefined;if(g.sappo){if(!g.next){x1=9;y1=g.stem>0?5:-5}else{x1=(g.next.x-g.x)*.5+4;y1=(g.ys+g.next.ys)*.5-g.y;if(g.stem>0)y1-=1;else y1+=1}note=g.notes[g.stem<0?0:g.nhd];out_acciac(x_head(g,note),y_head(g,note),x1,y1,g.stem>0)}if(user.anno_stop)anno_stop(s);if(!g.next)break}if(voice_tb[s.v].key.k_bagpipe||!cfmt.graceslurs||s.slur_start||!s.next||s.next.type!=NOTE)return;last=g;if(last.stem>=0){yy=127;for(g=s.extra;g;g=g.next){if(g.type!=NOTE)continue;if(g.y<yy){yy=g.y;last=g}}x0=last.x;y0=last.y-5;if(s.extra!=last){x0-=4;y0+=1}s=s.next;x3=s.x-1;if(s.stem<0)x3-=4;y3=3*(s.notes[0].pit-18)-5;dy1=(x3-x0)*.4;if(dy1>3)dy1=3;dy2=dy1;bet1=.2;bet2=.8;if(y0>y3+7){x0=last.x-1;y0+=.5;y3+=6.5;x3=s.x-5.5;dy1=(y0-y3)*.8;dy2=(y0-y3)*.2;bet1=0}else if(y3>y0+4){y3=y0+4;x0=last.x+2;y0=last.y-4}}else{yy=-127;for(g=s.extra;g;g=g.next){if(g.type!=NOTE)continue;if(g.y>yy){yy=g.y;last=g}}x0=last.x;y0=last.y+5;if(s.extra!=last){x0-=4;y0-=1}s=s.next;x3=s.x-1;if(s.stem>=0)x3-=2;y3=3*(s.notes[s.nhd].pit-18)+5;dy1=(x0-x3)*.4;if(dy1<-3)dy1=-3;dy2=dy1;bet1=.2;bet2=.8;if(y0<y3-7){x0=last.x-1;y0-=.5;y3-=6.5;x3=s.x-5.5;dy1=(y0-y3)*.8;dy2=(y0-y3)*.2;bet1=0}else if(y3<y0-4){y3=y0-4;x0=last.x+2;y0=last.y+4}}x1=bet1*x3+(1-bet1)*x0-x0;y1=bet1*y3+(1-bet1)*y0-dy1-y0;x2=bet2*x3+(1-bet2)*x0-x0;y2=bet2*y3+(1-bet2)*y0-dy2-y0;xypath(x0,y0+staff_tb[s.st].y);output.push("c"+x1.toFixed(2)+" "+(-y1).toFixed(2)+" "+x2.toFixed(2)+" "+(-y2).toFixed(2)+" "+(x3-x0).toFixed(2)+" "+(-y3+y0).toFixed(2)+'"/>\n')}function setdoty(s,y_tb){var m,m1,y;for(m=0;m<=s.nhd;m++){y=3*(s.notes[m].pit-18);if(y%6==0){if(s.dot_low)y-=3;else y+=3}y_tb[m]=y}for(m=0;m<s.nhd;m++){if(y_tb[m+1]>y_tb[m])continue;m1=m;while(m1>0){if(y_tb[m1]>y_tb[m1-1]+6)break;m1--}if(3*(s.notes[m1].pit-18)-y_tb[m1]<y_tb[m+1]-3*(s.notes[m+1].pit-18)){while(m1<=m)y_tb[m1++]-=6}else{y_tb[m+1]=y_tb[m]+6}}}function x_head(s,note){return s.x+note.shhd}function y_head(s,note){return staff_tb[s.st].y+3*(note.pit-18)}function draw_basic_note(x,s,m,y_tb){var i,k,y,p,yy,no_head,dotx,doty,old_color=false,note=s.notes[m];staffb=staff_tb[s.st].y,y=3*(note.pit-18),shhd=note.shhd*stv_g.scale;x_note=x+shhd;y_note=y+staffb;no_head=0;if(note.a_dcn){for(k=0;k<note.a_dcn.length;k++){no_head|=draw_deco_head(note.a_dcn[k],x+shhd,y+staffb,s.stem)}}if(s.invisible)return;if(s.nohdi1!=undefined&&m>=s.nohdi1&&m<s.nohdi2)return;var elts=identify_note(s,note.dur),head=elts[0],dots=elts[1],nflags=elts[2];if(y%6==0&&shhd!=(s.stem>0?s.notes[0].shhd:s.notes[s.nhd].shhd)){yy=0;if(y>=30){yy=y;if(yy%6)yy-=3}else if(y<=-6){yy=y;if(yy%6)yy+=3}if(yy)xygl(x_note,yy+staffb,"hl")}if(no_head){}else if(note.map&&note.map[0]){i=-s.nflags;if(i<0)i=0;p=note.map[0][i];if(!p)p=note.map[0][note.map[0].length-1];i=p.indexOf("/");if(i>=0){if(s.stem>=0)p=p.slice(0,i);else p=p.slice(i+1)}}else if(s.grace){p="ghd";x_note-=4.5*stv_g.scale}else if(s.type==CUSTOS){p="custos"}else{switch(head){case"oval":if(note.dur<BASE_LEN*2){p="HD";break}if(s.head!="square"){p="HDD";break}case"square":p=note.dur<BASE_LEN*4?"breve":"longa";if(!tsnext&&s.next&&s.next.type==BAR&&!s.next.next)dots=0;break;case"empty":p="Hd";break;default:p="hd";break}}if(note.map&&note.map[2])old_color=set_color(note.map[2]);if(p)xygl(x_note,y_note,p);if(dots){dotx=x+(7.7+s.xmx)*stv_g.scale;if(y_tb[m]==undefined){y_tb[m]=3*(s.notes[m].pit-18);if((s.notes[m].pit&1)==0)y_tb[m]+=3}doty=y_tb[m]+staffb;while(--dots>=0){out_dot(dotx,doty);dotx+=3.5}}if(note.acc){x-=note.shac*stv_g.scale;if(!s.grace){draw_acc(x,y+staffb,note.acc,note.micro_n,note.micro_d)}else{output.push('<g transform="translate(');out_sxsy(x,",",y+staffb);output.push(') scale(.7)">\n');stv_g.trans=true;draw_acc(0,0,note.acc,note.micro_n,note.micro_d);stv_g.trans=false;output.push("</g>\n")}}if(old_color!=false)set_color(old_color)}function draw_note(s,fl){var s2,i,m,y,staffb,slen,c,hltype,nflags,x,y,note,y_tb=new Array(s.nhd+1);if(s.dots)setdoty(s,y_tb);note=s.notes[s.stem<0?s.nhd:0];x=x_head(s,note);staffb=staff_tb[s.st].y;if(!s.invisible){if(s.grace){hltype="ghl"}else{switch(s.head){default:hltype="hl";break;case"oval":hltype="hl1";break;case"square":hltype="hl2";break}}draw_hl(x,3*(s.notes[0].pit-18),3*(s.notes[s.nhd].pit-18),s.st,hltype)}y=y_head(s,note);if(!s.invisible&&!s.stemless){slen=s.ys-s.y;nflags=s.nflags;if(s.ntrem)nflags-=s.ntrem;if(!fl||nflags<=0){if(s.nflags>0){if(s.stem>=0)slen-=1;else slen+=1}out_stem(x,y,slen,s.grace)}else{out_stem(x,y,slen,s.grace,nflags,cfmt.straightflags)}}else if(s.xstem){s2=s.ts_prev;slen=(s2.stem>0?s2.y:s2.ys)-s.y;slen+=staff_tb[s2.st].y-staffb;slen/=voice_tb[s.v].scale;out_stem(x,y,slen)}if(!s.invisible&&fl&&s.trem1){var ntrem=s.ntrem?s.ntrem:0,x1=x;slen=3*(s.notes[s.stem>0?s.nhd:0].pit-18);if(s.head=="full"||s.head=="empty"){x1+=(s.grace?GSTEM_XOFF:3.5)*s.stem;if(s.stem>0)slen+=6+5.4*ntrem;else slen-=6+5.4}else{if(s.stem>0)slen+=5+5.4*ntrem;else slen-=5+5.4}slen/=voice_tb[s.v].scale;out_trem(x1,staffb+slen,ntrem)}x=s.x;for(m=0;m<=s.nhd;m++)draw_basic_note(x,s,m,y_tb)}function next_scut(s){var prev=s;for(s=s.next;s;s=s.next){if(s.type==BAR&&(s.bar_type[0]==":"||s.bar_type=="|]"||s.bar_type=="[|"||s.text&&s.text[0]!="1"))return s;prev=s}return prev}function prev_scut(s){while(s.prev){s=s.prev;if(s.type==BAR&&(s.bar_type[0]==":"||s.bar_type=="|]"||s.bar_type=="[|"||s.text&&s.text[0]!="1"))return s}s=voice_tb[s.v].sym;while(s.type!=CLEF)s=s.ts_prev;if(s.next.type==KEY)s=s.next;if(s.next.type==METER)return s.next;return s}function slur_direction(k1,k2){var s,some_upstem,low;for(s=k1;;s=s.next){if(s.type==NOTE){if(!s.stemless){if(s.stem<0)return 1;some_upstem=true}if(s.notes[0].pit<22)low=true}if(s==k2)break}if(!some_upstem&&!low)return 1;return-1}function slur_out(x1,y1,x2,y2,dir,height,dotted){var dx,dy,dz,alfa=.3,beta=.45;dy=y2-y1;if(dy<0)dy=-dy;dx=x2-x1;if(dx>40&&dy/dx<.7){alfa=.3+.002*(dx-40);if(alfa>.7)alfa=.7}var mx=.5*(x1+x2),my=.5*(y1+y2),xx1=mx+alfa*(x1-mx),yy1=my+alfa*(y1-my)+height;xx1=x1+beta*(xx1-x1);yy1=y1+beta*(yy1-y1);var xx2=mx+alfa*(x2-mx),yy2=my+alfa*(y2-my)+height;xx2=x2+beta*(xx2-x2);yy2=y2+beta*(yy2-y2);dx=.03*(x2-x1);dy=2*dir;dz=.2+.001*(x2-x1);if(dz>.6)dz=.6;dz*=dir;var scale_y=stv_g.v?stv_g.scale:1;if(!dotted)output.push('<path class="fill" d="M');else output.push('<path class="stroke" stroke-dasharray="5,5" d="M');out_sxsy(x1," ",y1);output.push("c"+((xx1-x1)/stv_g.scale).toFixed(2)+" "+((y1-yy1)/scale_y).toFixed(2)+" "+((xx2-x1)/stv_g.scale).toFixed(2)+" "+((y1-yy2)/scale_y).toFixed(2)+" "+((x2-x1)/stv_g.scale).toFixed(2)+" "+((y1-y2)/scale_y).toFixed(2));if(!dotted)output.push("\n	v"+(-dz).toFixed(2)+"c"+((xx2-dx-x2)/stv_g.scale).toFixed(2)+" "+((y2+dz-yy2-dy)/scale_y).toFixed(2)+" "+((xx1+dx-x2)/stv_g.scale).toFixed(2)+" "+((y2+dz-yy1-dy)/scale_y).toFixed(2)+" "+((x1-x2)/stv_g.scale).toFixed(2)+" "+((y2+dz-y1)/scale_y).toFixed(2));output.push('"/>\n')}function slur_multi(k1,k2){while(1){if(k1.multi)return k1.multi;if(k1==k2)break;k1=k1.next}return 0}function draw_slur(k1_o,k2,m1,m2,slur_type){var k1=k1_o,k,g,x1,y1,x2,y2,height,addy,a,y,z,h,dx,dy,dir;while(k1.v!=k2.v)k1=k1.ts_next;switch(slur_type&7){case SL_ABOVE:dir=1;break;case SL_BELOW:dir=-1;break;default:dir=slur_multi(k1,k2);if(!dir)dir=slur_direction(k1,k2);break}var nn=1,upstaff=k1.st,two_staves=false;if(k1!=k2){k=k1.next;while(1){if(k.type==NOTE||k.type==REST){nn++;if(k.st!=upstaff){two_staves=true;if(k.st<upstaff)upstaff=k.st}}if(k==k2)break;k=k.next}}if(two_staves)error(2,k1,"*** multi-staves slurs not treated yet");x1=k1_o.x;if(k1_o.notes&&k1_o.notes[0].shhd)x1+=k1_o.notes[0].shhd;if(k1_o!=k2){x2=k2.x;if(k2.notes)x2+=k2.notes[0].shhd}else{for(k=k2.ts_next;k;k=k.ts_next)if(k.new_sy)break;if(!k)x2=realwidth;else x2=k.x}if(m1>=0){y1=3*(k1.notes[m1].pit-18)+5*dir}else{y1=dir>0?k1.ymx+2:k1.ymn-2;if(k1.type==NOTE){if(dir>0){if(k1.stem>0){x1+=5;if(k1.beam_end&&k1.nflags>=-1&&!k1.in_tuplet){if(k1.nflags>0){x1+=2;y1=k1.ys-3}else{y1=k1.ys-6}}else{y1=k1.ys+3}}else{y1=k1.y+8}}else{if(k1.stem<0){x1-=1;if(k1.beam_end&&k1.nflags>=-1&&(!k1.in_tuplet||k1.ys<y1+3)){if(k1.nflags>0){x1+=2;y1=k1.ys+3}else{y1=k1.ys+6}}else{y1=k1.ys-3}}else{y1=k1.y-8}}}}if(m2>=0){y2=3*(k2.notes[m2].pit-18)+5*dir}else{y2=dir>0?k2.ymx+2:k2.ymn-2;if(k2.type==NOTE){if(dir>0){if(k2.stem>0){x2+=1;if(k2.beam_st&&k2.nflags>=-1&&!k2.in_tuplet)y2=k2.ys-6;else y2=k2.ys+3}else{y2=k2.y+8}}else{if(k2.stem<0){x2-=5;if(k2.beam_st&&k2.nflags>=-1&&!k2.in_tuplet)y2=k2.ys+6;else y2=k2.ys-3}else{y2=k2.y-8}}}}if(k1.type!=NOTE){y1=y2+1.2*dir;x1=k1.x+k1.wr*.5;if(x1>x2-12)x1=x2-12}if(k2.type!=NOTE){if(k1.type==NOTE)y2=y1+1.2*dir;else y2=y1;if(k1!=k2)x2=k2.x-k2.wl*.3}if(nn>=3){if(k1.next.type!=BAR&&k1.next.x<x1+48){if(dir>0){y=k1.next.ymx-2;if(y1<y)y1=y}else{y=k1.next.ymn+2;if(y1>y)y1=y}}if(k2.prev&&k2.prev.type!=BAR&&k2.prev.x>x2-48){if(dir>0){y=k2.prev.ymx-2;if(y2<y)y2=y}else{y=k2.prev.ymn+2;if(y2>y)y2=y}}}a=(y2-y1)/(x2-x1);if(a>SLUR_SLOPE||a<-SLUR_SLOPE){a=a>SLUR_SLOPE?SLUR_SLOPE:-SLUR_SLOPE;if(a*dir>0)y1=y2-a*(x2-x1);else y2=y1+a*(x2-x1)}y=y2-y1;if(y>8)y=8;else if(y<-8)y=-8;z=y;if(z<0)z=-z;dx=.5*z;dy=.3*y;if(y*dir>0){x2-=dx;y2-=dy}else{x1+=dx;y1+=dy}if(k1.grace)x1=k1.x-GSTEM_XOFF*.5;if(k2.grace)x2=k2.x+GSTEM_XOFF*1.5;h=0;a=(y2-y1)/(x2-x1);if(k1!=k2&&k1.v==k2.v){addy=y1-a*x1;for(k=k1.next;k!=k2;k=k.next){if(k.st!=upstaff)continue;switch(k.type){case NOTE:case REST:if(dir>0){y=3*(k.notes[k.nhd].pit-18)+6;if(y<k.ymx)y=k.ymx;y-=a*k.x+addy;if(y>h)h=y}else{y=3*(k.notes[0].pit-18)-6;if(y>k.ymn)y=k.ymn;y-=a*k.x+addy;if(y<h)h=y}break;case GRACE:for(g=k.extra;g;g=g.next){if(g.type!=NOTE)continue;if(dir>0){y=3*(g.notes[g.nhd].pit-18)+6;if(y<g.ymx)y=g.ymx;y-=a*g.x+addy;if(y>h)h=y}else{y=3*(g.notes[0].pit-18)-6;if(y>g.ymn)y=g.ymn;y-=a*g.x+addy;if(y<h)h=y}}break}}y1+=.45*h;y2+=.45*h;h*=.65}if(nn>3)height=(.08*(x2-x1)+12)*dir;else height=(.03*(x2-x1)+8)*dir;if(dir>0){if(height<3*h)height=3*h;if(height>40)height=40}else{if(height>3*h)height=3*h;if(height<-40)height=-40}y=y2-y1;if(y<0)y=-y;if(dir>0){if(height<.8*y)height=.8*y}else{if(height>-.8*y)height=-.8*y}height*=cfmt.slurheight;slur_out(x1,y1,x2,y2,dir,height,slur_type&SL_DOTTED);dx=x2-x1;a=(y2-y1)/dx;addy=y1-a*x1+.4*height;if(k1.v==k2.v)for(k=k1;k!=k2;k=k.next){if(k.st!=upstaff)continue;y=a*k.x+addy;if(k.ymx<y)k.ymx=y;else if(k.ymn>y)k.ymn=y;if(k.next==k2){dx=x2;if(k2.sl1)dx-=5}else{dx=k.next.x}if(k!=k1)x1=k.x;dx-=x1;y_set(upstaff,dir>0,x1,dx,y)}return(dir>0?SL_ABOVE:SL_BELOW)|slur_type&SL_DOTTED}function draw_slurs(first,last){var s1,k,gr1,gr2,i,m1,m2,slur_type,cont,s=first;while(1){if(!s||s==last){if(!gr1||!(s=gr1.next)||s==last)break;gr1=null}if(s.type==GRACE){gr1=s;s=s.extra;continue}if(s.type!=NOTE&&s.type!=REST&&s.type!=SPACE||!s.slur_start&&!s.sl1){s=s.next;continue}k=null;s1=s.next;var gr1_out=false;while(1){if(!s1){if(gr2){s1=gr2.next;gr2=null;continue}if(!gr1||gr1_out)break;s1=gr1.next;gr1_out=true;continue}if(s1.type==GRACE){gr2=s1;s1=s1.extra;continue}if(s1.type==BAR&&(s1.bar_type[0]==":"||s1.bar_type=="|]"||s1.bar_type=="[|"||s1.text&&s1.text[0]!="1")){k=s1;break}if(s1.type!=NOTE&&s1.type!=REST&&s1.type!=SPACE){s1=s1.next;continue}if(s1.slur_end||s1.sl2){k=s1;break}if(s1.slur_start||s1.sl1){if(gr2){for(k=s1;k.next;k=k.next);k.next=gr2.next;if(gr2.next)gr2.next.prev=k;k=null}draw_slurs(s1,last);if(gr2&&gr2.next){delete gr2.next.prev.next;gr2.next.prev=gr2}}if(s1==last)break;s1=s1.next}if(!s1){k=next_scut(s)}else if(!k){s=s1;if(s==last)break;continue}if(gr1){for(s1=s;s1.next;s1=s1.next);s1.next=gr1.next;if(gr1.next)gr1.next.prev=s1;gr1.slur_start=SL_AUTO}if(gr2){gr2.prev.next=gr2.extra;gr2.extra.prev=gr2.prev;gr2.slur_start=SL_AUTO}if(s.slur_start){slur_type=s.slur_start&15;s.slur_start>>=4;m1=-1}else{for(m1=0;m1<=s.nhd;m1++)if(s.notes[m1].sl1)break;slur_type=s.notes[m1].sl1&15;s.notes[m1].sl1>>=4;s.sl1--}m2=-1;cont=0;if((k.type==NOTE||k.type==REST||k.type==SPACE)&&(k.slur_end||k.sl2)){if(k.slur_end){k.slur_end--}else{for(m2=0;m2<=k.nhd;m2++)if(k.notes[m2].sl2)break;k.notes[m2].sl2--;k.sl2--}}else{if(k.type!=BAR||k.bar_type[0]!=":"&&k.bar_type!="|]"&&k.bar_type!="[|"&&(!k.text||k.text[0]=="1"))cont=1}slur_type=draw_slur(s,k,m1,m2,slur_type);if(cont){voice_tb[k.v].slur_start<<=4;voice_tb[k.v].slur_start+=slur_type}if(gr1&&gr1.next){delete gr1.next.prev.next;gr1.next.prev=gr1}if(gr2){gr2.prev.next=gr2;delete gr2.extra.prev}if(s.slur_start||s.sl1)continue;if(s==last)break;s=s.next}}function draw_tuplet(t,s){var s1,s2,s3,g,r,upstaff,nb_only,some_slur,x1,x2,y1,y2,xm,ym,a,s0,yy,yx,dy,a,b,next=s;if(t.tuplet_f[0]==1)return next;for(g=t.next;g;g=g.next){if(g.type==TUPLET){s3=draw_tuplet(g,s);if(s3.time>next.time)next=s3}}r=t.tuplet_r;upstaff=s.st;for(s2=s;s2;s2=s2.next){if(s2!=s&&s2.in_tuplet){for(g=s2.extra;g;g=g.next){if(g.type==TUPLET){s3=draw_tuplet(g,s2);if(s3.time>next.time)next=s3}}}if(s2.type!=NOTE&&s2.type!=REST){if(s2.type==GRACE){for(g=s2.extra;g;g=g.next){if(g.type!=NOTE)continue;if(g.slur_start||g.sl1)some_slur=true}}continue}if(s2.slur_start||s2.slur_end||s2.sl1||s2.sl2)some_slur=true;if(s2.st<upstaff)upstaff=s2.st;if(!s1)s1=s2;if(--r<=0)break}if(!s2)return next;if(s2.time>next.time)next=s2;if(s1==s2){nb_only=true}else if(t.tuplet_f[1]==1){nb_only=true;draw_slur(s1,s2,-1,-1,s1.stem>0?SL_ABOVE:SL_BELOW)}else{if(t.tuplet_f[0]==2||s1.type!=NOTE||s2.type!=NOTE){nb_only=false}else{nb_only=true;for(s3=s1;;s3=s3.next){if(s3.type!=NOTE&&s3.type!=REST){if(s3.type==GRACE||s3.type==SPACE)continue;nb_only=false;break}if(s3==s2)break;if(s3.beam_end){nb_only=false;break}}if(nb_only&&!s1.beam_st&&!s1.beam_br1&&!s1.beam_br2){for(s3=s1.prev;s3;s3=s3.prev){if(s3.type==NOTE||s3.type==REST){if(s3.nflags>=s1.nflags)nb_only=false;break}}}if(nb_only&&!s2.beam_end){for(s3=s2.next;s3;s3=s3.next){if(s3.type==NOTE||s3.type==REST){if(!s3.beam_br1&&!s3.beam_br2&&s3.nflags>=s2.nflags)nb_only=false;break}}}}}if(nb_only){if(t.tuplet_f[2]==1)return next;xm=(s2.x+s1.x)*.5;if(s1==s2)a=0;else a=(s2.ys-s1.ys)/(s2.x-s1.x);b=s1.ys-a*s1.x;yy=a*xm+b;if(s1.stem>0){ym=y_get(upstaff,1,xm-3,6);if(ym>yy)b+=ym-yy;b+=2}else{ym=y_get(upstaff,0,xm-3,6);if(ym<yy)b+=ym-yy;b-=10}for(s3=s1;;s3=s3.next){if(s3.x>=xm)break}if(s1.stem*s2.stem>0){if(s1.stem>0)xm+=1.5;else xm-=1.5}ym=a*xm+b;if(t.tuplet_f[2]==0)out_bnum(xm,ym,t.tuplet_p);else out_bnum(xm,ym,t.tuplet_p+":"+t.tuplet_q);if(s1.stem>0){ym+=10;if(s3.ymx<ym)s3.ymx=ym;y_set(upstaff,true,xm-3,6,ym)}else{if(s3.ymn>ym)s3.ymn=ym;y_set(upstaff,false,xm-3,6,ym)}s.in_tuplet=false;return next}if(some_slur){draw_slurs(s1,s2);if(s1.slur_start||s1.sl1)return next;for(s3=s1.next;s3!=s2;s3=s3.next){if(s3.slur_start||s3.slur_end||s3.sl1||s3.sl2)return next}if(s2.slur_end||s2.sl2)return next}if(t.tuplet_f[1]!=0)error(2,t,"'what' value of %%tuplets not yet coded");if(s1.multi>=0){x1=s1.x-4;y1=24;if(s1.st==upstaff){s3=s1;if(s3.type!=NOTE){for(s3=s3.next;s3!=s2;s3=s3.next)if(s3.type==NOTE)break}ym=y_get(upstaff,1,s3.x,0);if(ym>y1)y1=ym;if(s1.stem>0)x1+=3}y2=24;if(s2.st==upstaff){s3=s2;if(s3.type!=NOTE){for(s3=s3.prev;s3!=s1;s3=s3.prev)if(s3.type==NOTE)break}ym=y_get(upstaff,1,s3.x,0);if(ym>y2)y2=ym}if(s2.dur>s2.prev.dur){if(s2.next)x2=s2.next.x-s2.next.wl-5;else x2=realwidth-6}else{x2=s2.x+4;r=s2.stem>=0?0:s2.nhd;if(s2.notes[r].shhd>0)x2+=s2.notes[r].shhd;if(s2.st==upstaff&&s2.stem>0)x2+=3.5}xm=.5*(x1+x2);ym=.5*(y1+y2);a=(y2-y1)/(x2-x1);s0=3*(s2.notes[s2.nhd].pit-s1.notes[s1.nhd].pit)/(x2-x1);if(s0>0){if(a<0)a=0;else if(a>s0)a=s0}else{if(a>0)a=0;else if(a<s0)a=s0}if(a*a<.1*.1)a=0;dy=0;for(s3=s1;;s3=s3.next){if(!s3.dur||s3.st!=upstaff){if(s3==s2)break;continue}yy=ym+(s3.x-xm)*a;yx=y_get(upstaff,1,s3.x,0);if(yx-yy>dy)dy=yx-yy;if(s3==s2)break}ym+=dy+2;y1=ym+a*(x1-xm);y2=ym+a*(x2-xm);out_tubr(x1,y1+4,x2-x1,y2-y1,true);ym+=8;for(s3=s1;;s3=s3.next){if(s3.st==upstaff){yy=ym+(s3.x-xm)*a;if(s3.ymx<yy)s3.ymx=yy;if(s3==s2)break;y_set(upstaff,true,s3.x,s3.next.x-s3.x,yy)}else if(s3==s2){break}}}else{x1=s1.x-7;if(s2.dur>s2.prev.dur){if(s2.next)x2=s2.next.x-s2.next.wl-8;else x2=realwidth-6}else{x2=s2.x+2;if(s2.notes[s2.nhd].shhd>0)x2+=s2.notes[s2.nhd].shhd}if(s1.st==upstaff){s3=s1;if(s3.type!=NOTE){for(s3=s3.next;s3!=s2;s3=s3.next)if(s3.type==NOTE)break}y1=y_get(upstaff,0,s3.x,0)}else{y1=0}if(s2.st==upstaff){s3=s2;if(s3.type!=NOTE){for(s3=s3.prev;s3!=s1;s3=s3.prev)if(s3.type==NOTE)break}y2=y_get(upstaff,0,s3.x,0)}else{y2=0}xm=.5*(x1+x2);ym=.5*(y1+y2);a=(y2-y1)/(x2-x1);s0=3*(s2.notes[0].pit-s1.notes[0].pit)/(x2-x1);if(s0>0){if(a<0)a=0;else if(a>s0)a=s0}else{if(a>0)a=0;else if(a<s0)a=s0}if(a*a<.1*.1)a=0;dy=0;for(s3=s1;;s3=s3.next){if(!s3.dur||s3.st!=upstaff){if(s3==s2)break;continue}yy=ym+(s3.x-xm)*a;yx=y_get(upstaff,0,s3.x,0);if(yx-yy<dy)dy=yx-yy;if(s3==s2)break}ym+=dy-10;y1=ym+a*(x1-xm);y2=ym+a*(x2-xm);out_tubr(x1,y1+4,x2-x1,y2-y1);ym-=2;for(s3=s1;;s3=s3.next){if(s3.st==upstaff){if(s3==s2)break;yy=ym+(s3.x-xm)*a;if(s3.ymn>yy)s3.ymn=yy;y_set(upstaff,false,s3.x,s3.next.x-s3.x,yy)}if(s3==s2)break}}if(t.tuplet_f[2]==1){s.in_tuplet=false;return next}yy=.5*(y1+y2);if(t.tuplet_f[2]==0)out_bnum(xm,yy,t.tuplet_p,true);else out_bnum(xm,yy,t.tuplet_p+":"+t.tuplet_q,true);if(s1.multi>=0){yy+=9;y_set(upstaff,true,xm-3,6,yy)}else{y_set(upstaff,false,xm-3,6,yy)}s.in_tuplet=false;return next}function draw_note_ties(k1,k2,mhead1,mhead2,job){var i,dir,m1,m2,p,p1,p2,y,st,k,x1,x2,h,sh;for(i=0;i<mhead1.length;i++){m1=mhead1[i];p1=k1.notes[m1].pit;m2=mhead2[i];p2=k2.notes[m2].pit;dir=(k1.notes[m1].ti1&7)==SL_ABOVE?1:-1;x1=k1.x;sh=k1.notes[m1].shhd;if(dir>0){if(m1<k1.nhd&&p1+1==k1.notes[m1+1].pit)if(k1.notes[m1+1].shhd>sh)sh=k1.notes[m1+1].shhd}else{if(m1>0&&p1==k1.notes[m1-1].pit+1)if(k1.notes[m1-1].shhd>sh)sh=k1.notes[m1-1].shhd}x1+=sh*.6;x2=k2.x;sh=k2.notes[m2].shhd;if(dir>0){if(m2<k2.nhd&&p2+1==k2.notes[m2+1].pit)if(k2.notes[m2+1].shhd<sh)sh=k2.notes[m2+1].shhd}else{if(m2>0&&p2==k2.notes[m2-1].pit+1)if(k2.notes[m2-1].shhd<sh)sh=k2.notes[m2-1].shhd}x2+=sh*.6;st=k1.st;switch(job){case 0:if(p1==p2||p1&1)p=p1;else p=p2;break;case 1:case 3:x1=k1.x;if(x1>x2-20)x1=x2-20;p=p2;st=k2.st;if(job==3)dir=-dir;break;default:if(k1!=k2){x2-=k2.wl}else{for(k=k2.ts_next;k;k=k.ts_next)if(k.new_sy)break;if(!k)x2=realwidth;else x2=k.x}if(x2<x1+16)x2=x1+16;p=p1;break}if(x2-x1>20){x1+=3.5;x2-=3.5}y=3*(p-18);if(job!=1&&job!=3){if(p&1)y+=2*dir;if(dir>0){if(!(p&1)&&k1.dots>0)y=3*(p-18)+6}}else{if(p&1)y+=2*dir}h=(.04*(x2-x1)+10)*dir;slur_out(x1,staff_tb[st].y+y,x2,staff_tb[st].y+y,dir,h,k1.notes[m1].ti1&SL_DOTTED)}}function draw_ties(k1,k2,job){var k3,i,j,m1,pit,tie2,mhead1=[],mhead2=[],mhead3=[],nh1=k1.nhd,time=k1.time+k1.dur;if(k1.type==GRACE){k3=k1.extra;while(k3){if(k3.type==NOTE)k1=k3;k3=k3.next}}if(k2&&k2.type==GRACE){k3=k2.extra;while(k3){if(k3.type==NOTE){k2=k3;if(job==2)job=0;break}k3=k3.next}}if(job==2){for(i=0;i<=nh1;i++){if(k1.notes[i].ti1)mhead3.push(i)}draw_note_ties(k1,k2||k1,mhead3,mhead3,job);return}for(i=0;i<=nh1;i++){if(!k1.notes[i].ti1)continue;tie2=-1;pit=k1.notes[i].apit;for(m1=k2.nhd;m1>=0;m1--){switch(k2.notes[m1].apit-pit){case 1:case-1:if(k1.notes[i].acc!=k2.notes[m1].acc)tie2=m1;default:continue;case 0:tie2=m1;break}break}if(tie2>=0){mhead1.push(i);mhead2.push(tie2)}else{mhead3.push(i)}}draw_note_ties(k1,k2,mhead1,mhead2,job);if(mhead3.length==0)return;k3=k1.ts_next;while(k3&&k3.time<time)k3=k3.ts_next;while(k3&&k3.time==time){if(k3.type!=NOTE||k3.st!=k1.st){k3=k3.ts_next;continue}mhead1.length=0;mhead2.length=0;for(i=mhead3.length;--i>=0;){j=mhead3[i];pit=k1.notes[j].apit;for(m1=k3.nhd;m1>=0;m1--){if(k3.notes[m1].apit==pit){mhead1.push(j);mhead2.push(m1);mhead3[i]=mhead3.pop();break}}}if(mhead1.length>0){draw_note_ties(k1,k3,mhead1,mhead2,job==1?1:0);if(mhead3.length==0)return}k3=k3.ts_next}if(mhead3.length!=0)error(1,k1,"Bad tie")}function tie_comb(s){var s1,time,st;time=s.time+s.dur;st=s.st;for(s1=s.ts_next;s1;s1=s1.ts_next){if(s1.st!=st)continue;if(s1.time==time){if(s1.type==NOTE)return s1;continue}if(s1.time>time)return s}return null}function draw_all_ties(p_voice){var s1,s2,s3,clef_chg,time,s_rtie,s_tie,x,dx;for(s1=p_voice.sym;s1;s1=s1.next){switch(s1.type){case CLEF:case KEY:case METER:continue}break}s_rtie=p_voice.s_rtie;for(s2=s1;s2;s2=s2.next){if(s2.dur||s2.type==GRACE)break;if(s2.type!=BAR||!s2.text)continue;if(s2.text[0]=="1")s_rtie=p_voice.s_tie;else p_voice.s_tie=s_rtie}if(!s2)return;if(p_voice.s_tie){p_voice.s_tie.x=s1.x+s1.wr;s1=p_voice.s_tie;delete p_voice.s_tie;s1.st=s2.st;s1.ts_next=s2.ts_next;s1.time=s2.time-s1.dur;draw_ties(s1,s2,1)}while(1){for(s1=s2;s1;s1=s1.next){if(s1.ti1)break;if(!s_rtie)continue;if(s1.type!=BAR||!s1.text)continue;if(s1.text[0]=="1"){s_rtie=null;continue}if(s1.bar_type=="|")continue;for(s2=s1.next;s2;s2=s2.next)if(s2.type==NOTE)break;if(!s2){s1=null;break}s_tie=clone(s_rtie);s_tie.x=s1.x+s1.wr;s_tie.next=s2;s_tie.st=s2.st;s_tie.time=s2.time-s_tie.dur;draw_ties(s_tie,s2,1)}if(!s1)break;time=s1.time+s1.dur;for(s2=s1.next;s2;s2=s2.next){if(s2.dur)break}if(!s2){for(s2=s1.ts_next;s2;s2=s2.ts_next){if(s2.st!=s1.st)continue;if(s2.time<time)continue;if(s2.time>time){s2=null;break}if(s2.dur)break}if(!s2){draw_ties(s1,null,2);p_voice.s_tie=s1;break}}else{if(s2.type!=NOTE){error(1,s1,"Bad tie");continue}if(s2.time!=time)s2=tie_comb(s1)}for(s3=s1.ts_next;s3;s3=s3.ts_next){if(s3.st!=s1.st)continue;if(s3.time>time)break;if(s3.type==CLEF){clef_chg=true;continue}if(s3.type==BAR){if(s3.bar_type[0]==":"||s3.bar_type=="|]"||s3.bar_type=="[|"){s2=s3;break}if(!s3.text)continue;if(s3.text[0]!="1"){s2=s3;break}s_rtie=s1}}if(clef_chg||s1.st!=s2.st){clef_chg=false;dx=(s2.x-s1.x)*.4;x=s2.x;s2.x-=dx;if(s2.x>s1.x+32)s2.x=s1.x+32;draw_ties(s1,s2,2);s2.x=x;x=s1.x;s1.x+=dx;if(s1.x<s2.x-24)s1.x=s2.x-24;draw_ties(s1,s2,3);s1.x=x;continue}draw_ties(s1,s2,s2.type==NOTE?0:2)}p_voice.s_rtie=s_rtie}function draw_all_slurs(p_voice){var k,i,m2,slur_type,s=p_voice.sym;if(!s)return;var slur_st=0;slur_type=p_voice.slur_start;if(slur_type){while(slur_type!=0){slur_st<<=4;slur_st|=slur_type&15;slur_type>>=4}}delete p_voice.slur_start;draw_slurs(s,undefined);for(;s;s=s.next){if(s.type!=NOTE&&s.type!=REST&&s.type!=SPACE)continue;while(s.slur_end||s.sl2){if(s.slur_end){s.slur_end--;m2=-1}else{for(m2=0;m2<=s.nhd;m2++)if(s.notes[m2].sl2)break;s.notes[m2].sl2--;s.sl2--}slur_type=slur_st&15;k=prev_scut(s);draw_slur(k,s,-1,m2,slur_type);if(k.type!=BAR||k.bar_type[0]!=":"&&k.bar_type!="|]"&&k.bar_type!="[|"&&(!k.text||k.text[0]=="1"))slur_st>>=4}}s=p_voice.sym;while(slur_st!=0){slur_type=slur_st&15;slur_st>>=4;k=next_scut(s);draw_slur(s,k,-1,-1,slur_type);if(k.type!=BAR||k.bar_type[0]!=":"&&k.bar_type!="|]"&&k.bar_type!="[|"&&(!k.text||k.text[0]=="1")){p_voice.slur_start<<=4;p_voice.slur_start+=slur_type}}}function draw_sym_near(){var p_voice,p_st,s,v,st,y,g,w,top,bot,i,st;for(v=0;v<voice_tb.length;v++){var bm={},first_note=true;p_voice=voice_tb[v];for(s=p_voice.sym;s;s=s.next){for(g=s.extra;g;g=g.next){if(g.type!=NOTE)continue;if(g.beam_st&&!g.beam_end)calculate_beam(bm,g)}if(s.type!=NOTE)continue;if(s.beam_st&&!s.beam_end||first_note&&!s.beam_st){first_note=false;calculate_beam(bm,s)}}}for(st=0;st<=nstaff;st++){p_st=staff_tb[st];if(!p_st.top){p_st.top=[];p_st.bot=[]}for(i=0;i<YSTEP;i++){p_st.top[i]=0;p_st.bot[i]=24}}set_tie_room();draw_deco_near();for(s=tsfirst;s;s=s.ts_next){if(s.invisible)continue;if(s.type==GRACE){for(g=s.extra;g;g=g.next){y_set(s.st,true,g.x-2,4,g.ymx+1);y_set(s.st,false,g.x-2,4,g.ymn-1)}continue}if(s.type!=MREST){y_set(s.st,true,s.x-s.wl,s.wl+s.wr,s.ymx+2);y_set(s.st,false,s.x-s.wl,s.wl+s.wr,s.ymn-2)}else{y_set(s.st,true,s.x-16,32,s.ymx+2)}if(s.type!=NOTE)continue;if(s.notes[s.nhd].acc){y=s.y+8;if(s.ymx<y)s.ymx=y;y_set(s.st,true,s.x,0,y)}if(s.notes[0].acc){y=s.y;if(s.notes[0].acc==1||s.notes[0].acc==3)y-=7;else y-=5;
if(s.ymn>y)s.ymn=y;y_set(s.st,false,s.x,0,y)}}if(cfmt.measurenb>=0)draw_measnb();draw_deco_note();for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];s=p_voice.sym;if(!s)continue;st=p_voice.st;set_dscale(st);for(;s;s=s.next){if(!s.in_tuplet)continue;for(g=s.extra;g;g=g.next){if(g.type==TUPLET){s=draw_tuplet(g,s);break}}}draw_all_slurs(p_voice);for(s=p_voice.sym;s;s=s.next){if(!s.in_tuplet)continue;for(g=s.extra;g;g=g.next){if(g.type==TUPLET){s=draw_tuplet(g,s);break}}}}for(st=0;st<=nstaff;st++){p_st=staff_tb[st];top=p_st.topbar+2;bot=p_st.botbar-2;for(i=0;i<YSTEP;i++){if(top>p_st.top[i])p_st.top[i]=top;if(bot<p_st.bot[i])p_st.bot[i]=bot}}for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(p_voice.have_ly){draw_all_lyrics();break}}draw_deco_staff();set_sscale(-1)}function draw_vname(indent){var p_voice,n,st,v,a_p,p,y,staff_d=[];for(st=cur_sy.nstaff;st>=0;st--){if(!cur_sy.staves[st].empty)break}if(st<0)return;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(!p_voice.sym)continue;st=cur_sy.voices[v].st;if(!cur_sy.staves[st])continue;if(cur_sy.staves[st].empty)continue;if(p_voice.new_name){delete p_voice.new_name;p=p_voice.nm}else{p=p_voice.snm}if(!p)continue;if(cur_sy.staves[st].flags&CLOSE_BRACE2){while(!(cur_sy.staves[st].flags&OPEN_BRACE2))st--}else if(cur_sy.staves[st].flags&CLOSE_BRACE){while(!(cur_sy.staves[st].flags&OPEN_BRACE))st--}if(!staff_d[st])staff_d[st]=p;else staff_d[st]+="\\n"+p}if(staff_d.length==0)return;set_font("voice");indent=-indent*.5;for(st=0;st<staff_d.length;st++){if(!staff_d[st])continue;a_p=staff_d[st].split("\\n");y=staff_tb[st].y+staff_tb[st].topbar*.5*staff_tb[st].staffscale+9*(a_p.length-1)-gene.curfont.size*.3;n=st;if(cur_sy.staves[st].flags&OPEN_BRACE2){while(!(cur_sy.staves[n].flags&CLOSE_BRACE2))n++}else if(cur_sy.staves[st].flags&OPEN_BRACE){while(!(cur_sy.staves[n].flags&CLOSE_BRACE))n++}if(n!=st)y-=(staff_tb[st].y-staff_tb[n].y)*.5;for(n=0;n<a_p.length;n++){p=a_p[n];xy_str(indent,y,p,"c");y-=18}}}function set_staff(){var s,sy,i,st,prev_staff,v,y,staffsep,dy,maxsep,mbot,val,p_voice,p_staff,empty=[];for(st=0;st<=nstaff;st++){staff_tb[st].empty=false;empty[st]=true}sy=cur_sy;for(st=0;st<sy.staves.length;st++){if(!sy.staves[st].empty)empty[st]=false}for(s=tsfirst;s;s=s.ts_next){if(!s.new_sy)continue;sy=sy.next;for(st=0;st<sy.staves.length;st++){if(!sy.staves[st].empty)empty[st]=false}}for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(p_voice.scale!=1)p_voice.scale_str='transform="scale('+p_voice.scale.toFixed(2)+')"'}for(st=0;st<=nstaff;st++){if(!empty[st])break;staff_tb[st].empty=true}y=0;if(st>nstaff){st--}else{p_staff=staff_tb[st];for(i=0;i<YSTEP;i++){val=p_staff.top[i];if(y<val)y=val}}y+=draw_partempo(st,y);if(empty[st])return y;staffsep=cfmt.staffsep*.5+staff_tb[st].topbar*staff_tb[st].staffscale;if(y<staffsep)y=staffsep;p_staff.y=-y;prev_staff=st;var sy_staff_prev=sy.staves[prev_staff];for(st++;st<=nstaff;st++){p_staff=staff_tb[st];if(empty[st]){p_staff.empty=true;continue}if(sy_staff_prev.sep)staffsep=sy_staff_prev.sep;else staffsep=cfmt.sysstaffsep;if(sy_staff_prev.maxsep)maxsep=sy_staff_prev.maxsep;else maxsep=cfmt.maxsysstaffsep;dy=0;if(p_staff.staffscale==staff_tb[prev_staff].staffscale){for(i=0;i<YSTEP;i++){val=p_staff.top[i]-staff_tb[prev_staff].bot[i];if(dy<val)dy=val}dy*=p_staff.staffscale}else{for(i=0;i<YSTEP;i++){val=p_staff.top[i]*p_staff.staffscale-staff_tb[prev_staff].bot[i]*staff_tb[prev_staff].staffscale;if(dy<val)dy=val}}staffsep+=p_staff.topbar*p_staff.staffscale;if(dy<staffsep)dy=staffsep;maxsep+=p_staff.topbar*p_staff.staffscale;if(dy>maxsep)dy=maxsep;y+=dy;p_staff.y=-y;prev_staff=st;sy_staff_prev=sy.staves[prev_staff]}mbot=0;for(i=0;i<YSTEP;i++){val=staff_tb[prev_staff].bot[i];if(mbot>val)mbot=val}mbot*=staff_tb[prev_staff].staffscale;for(st=0;st<=nstaff;st++){p_staff=staff_tb[st];dy=p_staff.y;if(p_staff.staffscale!=1){p_staff.scale_str='transform="translate(0,'+(posy-dy).toFixed(2)+") "+"scale("+p_staff.staffscale.toFixed(2)+')"';p_staff.y_delayed=0}else{p_staff.y_delayed=posy-dy}}if(mbot==0){for(st=nstaff;st>=0;st--){if(!empty[st])break}if(st<0)return y}dy=-mbot;staffsep=cfmt.staffsep*.5;if(dy<staffsep)dy=staffsep;maxsep=cfmt.maxstaffsep*.5;if(dy>maxsep)dy=maxsep;y+=dy;if(y>cfmt.maxstaffsep)y=cfmt.maxstaffsep;return y}function bar_set(bar_bot,bar_height){var st,staffscale,top,bot,dy=0;for(st=0;st<=cur_sy.nstaff;st++){if(cur_sy.staves[st].empty){bar_bot[st]=bar_height[st]=0;continue}staffscale=staff_tb[st].staffscale;top=staff_tb[st].topbar*staffscale;bot=staff_tb[st].botbar*staffscale;if(dy==0)dy=staff_tb[st].y+top;bar_height[st]=dy-staff_tb[st].y-bot;bar_bot[st]=staff_tb[st].y+bot;if(cur_sy.staves[st].flags&STOP_BAR)dy=0;else dy=bar_bot[st]}}function draw_systems(indent){var next_sy,s,s2,st,x,x2,res,xstaff=[],bar_bot=[],bar_height=[];function draw_staff(st,x1,x2){var w,i,dx,y=staff_tb[st].y,stafflines=staff_tb[st].stafflines;if(stafflines[stafflines.length-1]==".")return;set_sscale(st);w=(x2-x1)/stv_g.scale;for(i=0;i<stafflines.length;i++){if(stafflines[i]!=".")break;y+=6}xypath(x1,y);output.push("h"+w.toFixed(2));y=0;for(i++;i<stafflines.length;i++){y-=6;if(stafflines[i]!="."){output.push("m-"+w.toFixed(2)+" "+y);output.push("h"+w.toFixed(2));y=0}}output.push('"/>\n')}draw_vname(indent);for(st=0;st<=nstaff;st++)xstaff[st]=!cur_sy.staves[st]||cur_sy.staves[st].empty?-1:0;bar_set(bar_bot,bar_height);draw_lstaff(0);for(s=tsfirst;s;s=s.ts_next){if(s.new_sy){next_sy=cur_sy.next;for(st=0;st<=nstaff;st++){x=xstaff[st];if(x<0){if(next_sy.staves[st]&&!next_sy.staves[st].empty){if(s.type==BAR)xstaff[st]=s.x;else xstaff[st]=s.x-s.wl-2}continue}if(s.ts_prev.type==BAR)x2=s.ts_prev.x;else x2=s.x-s.wl-2;if(!next_sy.staves[st]||next_sy.staves[st].empty)xstaff[st]=-1;else if(next_sy.staves[st].stafflines==cur_sy.staves[st].stafflines)continue;else xstaff[st]=x2;draw_staff(st,x,x2)}cur_sy=next_sy;res=bar_set();bar_bot=res[0];bar_height=res[1]}st=s.st;switch(s.type){case BAR:if(s.second||cur_sy.staves[st].empty)s.invisible=true;if(s.invisible)break;if(user.anno_start)anno_start(s);draw_bar(s,bar_bot[st],bar_height[st]);if(user.anno_stop)anno_stop(s);break;case STBRK:if(cur_sy.voices[s.v].range==0){if(s.xmx>14){var nvoice=0;for(var i=0;i<voice_tb.length;i++){if(cur_sy.voices[i].range>0)nvoice++}for(s2=s.ts_next;s2;s2=s2.ts_next){if(s2.type!=STBRK)break;nvoice--}if(nvoice==0)draw_lstaff(s.x)}}s2=s.prev;if(!s2)break;x2=s2.x;if(s2.type!=BAR)x2+=s2.wr;st=s.st;x=xstaff[st];if(x>=0){if(x>=x2)continue;draw_staff(st,x,x2)}xstaff[st]=s.x;break;default:break}}for(st=0;st<=nstaff;st++){if((x=xstaff[st])<0)continue;draw_staff(st,x,realwidth)}}function draw_symbols(p_voice){var bm={},s,g,x,y,st,first_note;first_note=true;for(s=p_voice.sym;s;s=s.next){if(s.extra){for(g=s.extra;g;g=g.next){if(g.type==FORMAT&&g.fmt_type=="voicecolor"){p_voice.color=g.color;set_color(p_voice.color)}}}if(s.invisible&&s.type!=NOTE&&s.type!=REST&&s.type!=GRACE)continue;x=s.x;switch(s.type){case NOTE:set_color(p_voice.color);set_scale(s);if(s.beam_st&&!s.beam_end||first_note&&!s.beam_st){first_note=false;if(calculate_beam(bm,s))draw_beams(bm)}if(user.anno_start)anno_start(s);draw_note(s,!bm.s2);if(user.anno_stop)anno_stop(s);if(s==bm.s2)bm.s2=null;break;case REST:set_color(p_voice.color);set_scale(s);if(user.anno_start)anno_start(s);draw_rest(s);if(user.anno_stop)anno_stop(s);break;case BAR:break;case CLEF:st=s.st;if(s.second)break;if(s.invisible||staff_tb[st].empty)break;set_color(undefined);set_sscale(st);if(user.anno_start)anno_start(s);y=staff_tb[st].y;if(s.clef_name)xygl(x,y+s.y,s.clef_name);else if(!s.clef_small)xygl(x,y+s.y,s.clef_type+"clef");else xygl(x,y+s.y,"s"+s.clef_type+"clef");if(s.clef_octave){if(s.clef_octave>0){y+=s.ymx-10;if(s.clef_small)y-=1}else{y+=s.ymn+2;if(s.clef_small)y+=1}xygl(x-2,y,"oct")}if(user.anno_stop)anno_stop(s);break;case METER:p_voice.meter=s;if(s.second||staff_tb[s.st].empty)break;if(cfmt.alignbars&&s.st!=0)break;set_color(undefined);set_sscale(s.st);if(user.anno_start)anno_start(s);draw_meter(x,s);if(user.anno_stop)anno_stop(s);break;case KEY:p_voice.key=s;if(s.second||staff_tb[s.st].empty)break;set_color(undefined);set_sscale(s.st);if(user.anno_start)anno_start(s);draw_keysig(p_voice,x,s);if(user.anno_stop)anno_stop(s);break;case MREST:set_color(p_voice.color);set_scale(s);xygl(x,staff_tb[s.st].y+12,"mrest");output.push('<text style="font:bold 15px serif"\n	x ="');out_sxsy(x,'" y="',staff_tb[s.st].y+28);output.push('" text-anchor="middle">'+s.nmes+"</text>\n");break;case GRACE:set_color(p_voice.color);set_scale(s);draw_gracenotes(s);break;case SPACE:case STBRK:case FORMAT:break;case CUSTOS:set_color(p_voice.color);set_scale(s);s.stemless=true;draw_note(s,0);break;default:error(2,s,"draw_symbols - Cannot draw symbol "+s.type);break}}set_color(p_voice.color);set_scale(p_voice.sym);draw_all_ties(p_voice);set_color(undefined)}function draw_all_sym(){var p_voice,s,v,n=voice_tb.length;for(v=0;v<n;v++){p_voice=voice_tb[v];if(p_voice.sym)draw_symbols(p_voice)}for(s=tsfirst;s;s=s.ts_next){if(s.type==CLEF)staff_tb[s.st].clef=s}}function set_tie_dir(sym){var s,i,ntie,dir,sec,pit,ti;for(s=sym;s;s=s.next){if(!s.ti1)continue;if(s.multi!=0){dir=s.multi>0?SL_ABOVE:SL_BELOW;for(i=0;i<=s.nhd;i++){ti=s.notes[i].ti1;if(!((ti&7)==SL_AUTO))continue;s.notes[i].ti1=ti&SL_DOTTED|dir}continue}sec=ntie=0;pit=128;for(i=0;i<=s.nhd;i++){if(s.notes[i].ti1){ntie++;if(pit<128&&s.notes[i].pit<=pit+1)sec++;pit=s.notes[i].pit}}if(ntie<=1){dir=s.stem<0?SL_ABOVE:SL_BELOW;for(i=0;i<=s.nhd;i++){ti=s.notes[i].ti1;if(ti){if((ti&7)==SL_AUTO)s.notes[i].ti1=ti&SL_DOTTED|dir;break}}continue}if(sec==0){if(ntie&1){ntie=(ntie-1)/2;dir=SL_BELOW;for(i=0;i<=s.nhd;i++){ti=s.notes[i].ti1;if(ti==0)continue;if(ntie==0){if(s.notes[i].pit>=22)dir=SL_ABOVE}if((ti&7)==SL_AUTO)s.notes[i].ti1=ti&SL_DOTTED|dir;if(ntie--==0)dir=SL_ABOVE}continue}ntie/=2;dir=SL_BELOW;for(i=0;i<=s.nhd;i++){ti=s.notes[i].ti1;if(ti==0)continue;if((ti&7)==SL_AUTO)s.notes[i].ti1=ti&SL_DOTTED|dir;if(--ntie==0)dir=SL_ABOVE}continue}pit=128;for(i=0;i<=s.nhd;i++){if(s.notes[i].ti1){if(pit<128&&s.notes[i].pit<=pit+1){ntie=i;break}pit=s.notes[i].pit}}dir=SL_BELOW;for(i=0;i<=s.nhd;i++){ti=s.notes[i].ti1;if(ti==0)continue;if(ntie==i)dir=SL_ABOVE;if((ti&7)==SL_AUTO)s.notes[i].ti1=ti&SL_DOTTED|dir}}}function set_tie_room(){var p_voice,s,s2,v,dx,y,dy;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];s=p_voice.sym;if(!s)continue;s=s.next;if(!s)continue;set_tie_dir(s);for(;s;s=s.next){if(!s.ti1)continue;if(s.notes[0].pit<20&&(s.notes[0].ti1&7)==SL_BELOW);else if(s.notes[s.nhd].pit>24&&(s.notes[s.nhd].ti1&7)==SL_ABOVE);else continue;s2=s.next;while(s2&&s2.type!=NOTE)s2=s2.next;if(s2){if(s2.st!=s.st)continue;dx=s2.x-s.x-10}else{dx=realwidth-s.x-10}if(dx<100)dy=9;else if(dx<300)dy=12;else dy=16;if(s.notes[s.nhd].pit>24){y=3*(s.notes[s.nhd].pit-18)+dy;if(s.ymx<y)s.ymx=y;if(s2&&s2.ymx<y)s2.ymx=y;y_set(s.st,true,s.x+5,dx,y)}if(s.notes[0].pit<20){y=3*(s.notes[0].pit-18)-dy;if(s.ymn>y)s.ymn=y;if(s2&&s2.ymn>y)s2.ymn=y;y_set(s.st,false,s.x+5,dx,y)}}}}var defined_font={},font_tb={},fid=1,font_scale_tb={serif:1.05,serifBold:1.05,"sans-serif":1.1,"sans-serifBold":1.15,Palatino:1.1,Mono:1.35},lock={};var cfmt={aligncomposer:1,breaklimit:.7,breakoneoln:true,composerspace:6,dblrepbar:":][:",decoerr:true,dynalign:true,fullsvg:"",gracespace:[6.5,8,12],graceslurs:true,hyphencont:true,indent:0,infoname:'R "Rhythm: "\nB "Book: "\nS "Source: "\nD "Discography: "\nN "Notes: "\nZ "Transcription: "\nH "History: "',infospace:0,keywarn:true,leftmargin:.7*IN,lineskipfac:1.1,linewarn:true,maxshrink:.65,maxstaffsep:2e3,maxsysstaffsep:2e3,measurefirst:1,measurenb:-1,musicspace:6,parskipfac:.4,partsspace:8,pagewidth:21*CM,pos:{dyn:0,gch:0,gst:0,orn:0,ste:0,voc:0,vol:0},rightmargin:.7*IN,rbmax:4,rbmin:2,scale:1,slurheight:1,staffnonote:1,staffsep:46,stemheight:21,stretchlast:.25,stretchstaff:true,subtitlespace:3,sysstaffsep:34,textspace:14,titlespace:6,titletrim:true,transpose:0,topspace:22,tuplets:[0,0,0],vocalspace:23,voicecombine:0,voicescale:1,writefields:"CMOPQTWw",wordsspace:5};function get_bool(param){return!param.match(/^(0|n|f)/i)}function get_int(param){var v=parseInt(param);if(isNaN(v)){parse.line.error("Bad integer value\n");v=1}return v}function get_font_scale(param){var a=param.split(/\s+/);if(a.length<=1)return;var scale=parseFloat(a[a.length-1]);if(isNaN(scale)||a<=0){parse.line.error("Bad scale value in %%font");return}font_scale_tb[a[0]]=scale;for(var fn in font_tb){var font=font_tb[fn];if(font.name==a[0])font.swfac=font.size*scale}}function param_set_font(xxxfont,param){var font,fn,old_fn,n,a,new_name,new_fn,new_size,scale;if(xxxfont[xxxfont.length-2]=="-"){n=xxxfont[xxxfont.length-1];if(n<"1"||n>"9")return;xxxfont="u"+n+"font"}fn=cfmt[xxxfont];if(fn){font=font_tb[fn];if(font)old_fn=font.name+"."+font.size}a=param.split(/\s+/);new_name=a[0];if(new_name=="*"&&font){new_name=font.name}else{new_name=new_name.replace("Times-Roman","serif");new_name=new_name.replace("Times","serif");new_name=new_name.replace("Helvetica","sans-serif");new_name=new_name.replace("Courier","monospace")}if(a.length>1){new_size=a[a.length-1];if(new_size=="*")new_size=font.size}else{new_size=font.size}new_fn=new_name+"."+new_size;if(new_fn==old_fn)return;font=font_tb[new_fn];if(!font){scale=font_scale_tb[new_name];if(!scale)scale=1.1;font={name:new_name,size:Number(new_size),swfac:new_size*scale};font_tb[new_fn]=font}cfmt[xxxfont]=new_fn}function get_unit(param){var v=parseFloat(param);switch(param.slice(-2)){case"CM":case"cm":v*=28.35;break;case"IN":case"in":v*=72;break}return v}function get_unitp(param){var v=parseFloat(param);switch(param.slice(-2)){case"CM":case"cm":v*=CM;break;case"IN":case"in":v*=IN;break}return v}function set_infoname(param){var tmp=cfmt.infoname.split("\n"),letter=param[0];for(var i=0;i<tmp.length;i++){var infoname=tmp[i];if(infoname[0]!=letter)continue;if(param.length==1)tmp.splice(i,1);else tmp[i]=param;cfmt.infoname=tmp.join("\n");return}cfmt.infoname+="\n"+param}const textopt={align:"j",center:"c",fill:"f",justify:"j",ragged:"f",right:"r",skip:"s"};function get_textopt(param){return textopt[param]}const posval={above:SL_ABOVE,below:SL_BELOW,down:SL_BELOW,hidden:SL_HIDDEN,opposite:SL_HIDDEN,up:SL_ABOVE};function set_pos(k,a){var v,val,pos;if(a[0]>="0"&&a[0]<="3")val=parseInt(a);else val=posval[a]||0;switch(k[0]){case"d":k="dyn";break;case"g":if(k[1]=="c")k="gch";else k="gst";break;case"o":k="orn";break;case"s":k="ste";break;case"v":if(k[2]=="c")k="voc";else k="vol";break;default:return}pos=curvoice?curvoice.pos:cfmt.pos;pos[k]=val;if(!curvoice){for(v=0;v<voice_tb.length;v++)voice_tb[v].pos[k]=val}}function set_writefields(param){var c,i,a=param.split(/\s+/);if(get_bool(a[1])){for(i=0;i<a[0].length;i++){c=a[0][i];if(cfmt.writefields.indexOf(c)<0)cfmt.writefields+=c}}else{for(i=0;i<a[0].length;i++){c=a[0][i];if(cfmt.writefields.indexOf(c)>=0)cfmt.writefields=cfmt.writefields.replace(c,"")}}}function set_format(cmd,param,lock){var f,f2,v,box;function set_v_param(k,v){if(curvoice){curvoice[k]=v;return}if(parse.state==0){cfmt["voice"+k]=v;return}if(!parse.voice_param)parse.voice_param={};parse.voice_param[k]=v}if(lock){lock[cmd]=true}else if(lock[cmd])return;if(cmd.match(/.+font$/)||cmd.match(/.+font-[\d]$/)){if(param.slice(-4)==" box"){box=true;param=param.slice(0,-4)}param_set_font(cmd,param);if(box){switch(cmd){case"gchordfont":cfmt.gchordbox=box;break;case"measurefont":cfmt.measurebox=box;break;case"partsfont":cfmt.partsbox=box;break}}return}switch(cmd){case"aligncomposer":case"barsperstaff":case"infoline":case"measurefirst":case"measurenb":case"rbmax":case"rbmin":case"shiftunison":case"staffnonote":cfmt[cmd]=get_int(param);break;case"microscale":f=get_int(param);if(f<4||f>256||f%1){parse.line.error("Bad value for "+cmd);break}cfmt.microscale=f;if(parse.state==0)break;if(parse.state==1){for(v=0;v<voice_tb.length;v++)voice_tb[v].microscale=cfmt.microscale}else{if(parse.state==2)goto_tune();curvoice.microscale=cfmt.microscale}break;case"bgcolor":case"dblrepbar":case"titleformat":cfmt[cmd]=param;break;case"breaklimit":case"lineskipfac":case"maxshrink":case"pagescale":case"parskipfac":case"scale":case"slurheight":case"stemheight":case"stretchlast":f=parseFloat(param);if(!f){parse.line.error("Bad value for "+cmd);break}if(cmd=="scale")f/=.75;else if(cmd=="pagescale")cmd="scale";cfmt[cmd]=f;break;case"bstemdown":case"breakoneoln":case"cancelkey":case"custos":case"decoerr":case"dynalign":case"flatbeams":case"gchordbox":case"graceslurs":case"hyphencont":case"keywarn":case"linewarn":case"measurebox":case"partsbox":case"singleline":case"squarebreve":case"straightflags":case"stretchstaff":case"timewarn":case"titlecaps":case"titleleft":case"titletrim":cfmt[cmd]=get_bool(param);break;case"composerspace":case"indent":case"infospace":case"maxstaffsep":case"maxsysstaffsep":case"musicspace":case"partsspace":case"staffsep":case"subtitlespace":case"sysstaffsep":case"textspace":case"titlespace":case"topspace":case"vocalspace":case"wordsspace":cfmt[cmd]=get_unit(param);break;case"leftmargin":case"pagewidth":case"rightmargin":cfmt[cmd]=get_unitp(param);break;case"contbarnb":cfmt.contbarnb=get_int(param);break;case"writefields":set_writefields(param);break;case"dynamic":case"gchord":case"gstemdir":case"ornament":case"stemdir":case"vocal":case"volume":set_pos(cmd,param);break;case"font":get_font_scale(param);break;case"fullsvg":if(parse.state!=0){parse.line.error("Cannot have 'fullsvg' inside a tune");break}cfmt[cmd]=param;break;case"gracespace":case"tuplets":cfmt[cmd]=param.split(/\s+/);break;case"infoname":set_infoname(param);break;case"notespacingfactor":f=parseFloat(param);if(!f||f<1||f>2){parse.line.error("Bad value for notespacingfactor");break}i=5;f2=space_tb[i];for(;--i>=0;){f2/=f;space_tb[i]=f2}i=5;f2=space_tb[i];for(;++i<space_tb.length;){f2*=f;space_tb[i]=f2}break;case"pos":cmd=param.match(/(\w|-)+/);cmd=cmd[0];param=param.replace(cmd,"").trim();set_pos(cmd,param);break;case"staffwidth":v=cfmt.pagewidth-get_unitp(param)-cfmt.leftmargin;if(v<0)parse.line.error("'staffwidth' too big");else cfmt.rightmargin=v;break;case"textoption":cfmt[cmd]=get_textopt(param);break;case"combinevoices":case"voicecombine":v=parseInt(param);if(isNaN(v)||v<-1||v>2){parse.line.error("Bad value in %%voicecombine");return}if(curvoice&&cmd=="combinevoices"){for(f=0;f<voice_tb.length;f++)voice_tb[f].combine=v}set_v_param("combine",v);break;case"voicemap":set_v_param("map",param);break;case"voicescale":v=parseFloat(param);if(isNaN(v)||v<.6||v>1.5){parse.line.error("Bad %%voicescale value");return}set_v_param("scale",v);break}}function font_init(){param_set_font("annotationfont","sans-serif 12");param_set_font("composerfont","serifItalic 14");param_set_font("gchordfont","sans-serif 12");param_set_font("historyfont","serif 16");param_set_font("infofont","serifItalic 14");param_set_font("measurefont","serifItalic 14");param_set_font("partsfont","serif 15");param_set_font("repeatfont","serif 13");param_set_font("subtitlefont","serif 16");param_set_font("tempofont","serifBold 15");param_set_font("textfont","serif 16");param_set_font("titlefont","serif 20");param_set_font("vocalfont","serifBold 13");param_set_font("voicefont","serifBold 13");param_set_font("wordsfont","serif 16")}function style_add_font(font){var name=font.name,i=name.indexOf("Italic"),j=100,o=name.indexOf("Oblique"),b=name.indexOf("Bold");font_style+="\n.f"+font.fid+cfmt.fullsvg+" {font:";if(b>0){font_style+="bold ";j=b}if(i>0||o>0){if(i>0){font_style+="italic ";if(i<j)j=i}if(o>0){font_style+="oblique ";if(o<j)j=o}}if(j!=100){if(name[j-1]=="-")j--;name=name.slice(0,j)}font_style+=font.size+"px "+name+"}"}function use_font(font){if(!defined_font[font.fid]){defined_font[font.fid]=true;style_add_font(font)}}function get_font(xxx){xxx+="font";var fn=cfmt[xxx],font=font_tb[fn];if(!font){parse.line.error("Unknown font "+xxx);return null}if(!font.fid)font.fid=fid++;use_font(font);return font}var abc_utf={"`A":"","`E":"","`I":"","`O":"","`U":"","`a":" ","`e":"","`i":"","`o":"","`u":"","'A":"","'E":"","'I":"","'O":"","'U":"","'Y":"","'a":"","'e":"","'i":"","'o":"","'u":"","'y":"","'S":"","'Z":"","'s":"","'z":"","'R":"","'L":"","'C":"","'N":"","'r":"","'l":"","'c":"","'n":"","^A":"","^E":"","^I":"","^O":"","^U":"","^a":"","^e":"","^i":"","^o":"","^u":"","^H":"","^J":"","^h":"","^j":"","^C":"","^G":"","^S":"","^c":"","^g":"","^s":"",",C":"",",c":"",",S":"",",s":"",",T":"",",t":"",",R":"",",L":"",",G":"",",r":"",",l":"",",g":"",",N":"",",K":"",",n":"",",k":"",'"A':"",'"E':"",'"I':"",'"O':"",'"U':"",'"Y':"",'"a':"",'"e':"",'"i':"",'"o':"",'"u':"",'"y':"","~A":"","~N":"","~O":"","~a":"","~n":"","~o":"","~I":"","~i":"","~U":"","~u":"",oA:"",oa:"",oU:"",ou:"","=A":"","=D":"","=E":"","=H":"","=I":"","=O":"","=T":"","=U":"","=a":"","=d":"","=e":"","=h":"","=i":"","=o":"","=t":"","=u":"","/O":"","/o":"","/D":"","/d":"","/L":"","/l":"",";A":"",";E":"",";I":"",";U":"",";a":"",";e":"",";i":"",";u":"",vL:"",vS:" ",vT:"",vZ:"",vl:"",vs:"",vt:"",vz:"",vC:"",vE:"",vD:"",vN:"",vR:"",vc:"",ve:"",vd:"",vn:"",vr:"",uA:"",ua:"",uE:"",ue:"",uG:"",ug:"",uI:"",ui:"",uO:"",uo:"",uU:"",uu:"",":O":"",":U":"",":o":"",":u":"",".Z":"",".z":"",".I":"",".i":"",".C":"",".c":"",".G":" ",".g":"",".E":"",".e":"",AA:"",aa:"",AE:"",ae:"",cc:"",cC:"",DH:"",dh:"",ng:"",OE:"",oe:"",ss:"",TH:"",th:""};function cnv_escape(src){var c,c2,dst="",i,j=0,codeUnits;while(1){i=src.indexOf("\\",j);if(i<0)break;dst+=src.slice(j,i);c=src[++i];if(c==undefined)return dst+"\\";switch(c){case"0":case"2":if(src[i+1]=="0"){switch(src[i+2]){case"1":dst+="";j=i+3;continue;case"2":dst+="";j=i+3;continue;case"3":dst+="";j=i+3;continue;case"4":codeUnits=[55348,56618];dst+=String.fromCharCode.apply(null,codeUnits);j=i+3;continue;case"5":codeUnits=[55348,56619];dst+=String.fromCharCode.apply(null,codeUnits);j=i+3;continue}}case"1":case"3":if(src[i+1]>="0"&&src[i+1]<="7"&&src[i+2]>="0"&&src[i+2]<="7"){j=parseInt(src.slice(i,i+3),8);dst+=String.fromCharCode(j);j=i+3;continue}break;case"u":codeUnits=[];j=parseInt(src.slice(i+1,i+5),16);codeUnits.push(j);if(j>=55296&&j<=57343){j=parseInt(src.slice(i+7,i+11),16);codeUnits.push(j);j=i+11}else{j=i+5}dst+=String.fromCharCode.apply(null,codeUnits);continue;default:c2=abc_utf[src.slice(i,i+2)];if(c2){dst+=c2;j=i+2;continue}break}dst+="\\"+c;j=i+1}return dst+src.slice(j)}var include=2;function do_include(fname){var file,parse_sav;if(!user.read_file){syntax(1,"No read_file support");return}if(include<=0){syntax(1,"Too many include levels");return}include--;file=user.read_file(fname);if(!file){error(1,undefined,"Cannot read file '"+fname+"'");return}parse_sav=clone(parse);tosvg(fname,file);parse=parse_sav;include++}function tosvg(in_fname,file){var i,c,bol,eol,boc,eoc,end,ext,select,line0,line1,last_info,opt,text,a,b,s,cfmt_sav,info_sav,char_tb_sav,glovar_sav,maps_sav,pscom,txt_add="\n",eof=file.length;function set_boc(){boc=bol;while(boc<eol){c=file[boc];if(c!=" "&&c!="	")break;boc++}}function set_eoc(){eoc=eol-1;while(eoc>bol){c=file[eoc];if(c!=" "&&c!="	")break;eoc--}eoc++}function tune_selected(){var i=file.indexOf("K:",bol);if(i<0){return false}i=file.indexOf("\n",i);if(parse.select.test(file.slice(bol,i)))return true;eol=file.indexOf("\n\n",i);if(eol<0)eol=eof-1;else eol++;return false}function uncomment(src,do_escape){var i,j,c,l;if(do_escape&&src.indexOf("\\")>=0)src=cnv_escape(src);l=src.length;for(i=0;i<l;i++){c=src[i];switch(c){case"\\":i++;continue;case"%":return src.slice(0,i).replace(/\s+$/,"");case'"':break;default:continue}j=i+1;for(;;){j=src.indexOf('"',j);if(j<0)break;if(src[j-1]!="\\")break}if(j<0)break;i=j}src=src.replace(/\s+$/,"");return src.replace(/\\%/g,"%")}function end_tune(){gen_ly(false);put_history();blk_out();blk_flush();parse.state=0;cfmt=cfmt_sav;posx=cfmt.leftmargin/cfmt.scale;info=info_sav;char_tb=char_tb_sav;glovar=glovar_sav;maps=maps_sav;init_tune()}parse.file=file;parse.ctx={fname:in_fname};line=new scanBuf;parse.line=line;line.buffer=file;line.index=0;bol=0;for(bol=0;;bol=eol+1){if(bol>=eof)break;eol=file.indexOf("\n",bol);if(eol<0)eol=eof;if(eol==bol){if(parse.state==1){parse.istart=bol;syntax(1,"Empty line in tune header - ignored")}else if(parse.state>=2)end_tune();continue}parse.istart=parse.bol=bol;parse.iend=parse.eol=eol;line0=file[bol];line1=file[bol+1];if(line0=="%"){if(parse.prefix.indexOf(line1)<0)continue;if(file[bol+2]=="a"&&file[bol+3]=="b"&&file[bol+4]=="c"&&file[bol+5]==" "){bol+=6;line0=file[bol];line1=file[bol+1]}else{pscom=true}}else if(line0=="I"&&line1==":"){pscom=true}if(pscom){pscom=false;bol+=2;set_boc();set_eoc();text=file.slice(boc,eoc);if(!text||text[0]=="%")continue;a=text.split(/\s+/,2);if(!a[0])a.shift();switch(a[0]){case"abcm2ps":parse.prefix=a[1];continue;case"abc-include":ext=a[1].match(/.*\.(.*)/);if(!ext)continue;switch(ext[1]){case"abc":do_include(a[1]);break}continue}b=a[0].match(/begin(.*)/);if(b){end="\n"+line0+line1+"end"+b[1];i=file.indexOf(end,eol);if(i<0){syntax(1,"No "+end.slice(1)+" after %%"+b[0]);eol=eof;continue}do_begin_end(b[1],a[1],parse.file.slice(eol+1,i).replace(new RegExp("^"+line0+line1,"gm"),""));eol=file.indexOf("\n",i+6);if(eol<0)eol=eof;continue}switch(a[0]){case"select":if(parse.state!=0){syntax(1,"%%select ignored");continue}select=uncomment(text.slice(7).trim(),false);if(select[0]=='"')select=select.slice(1,-1);select=select.replace(/\(/g,"\\(");select=select.replace(/\)/g,"\\)");parse.select=new RegExp(select,"m");continue;case"tune":syntax(1,"%%tune not treated yet");continue;case"voice":if(parse.state!=0){syntax(1,"%%voice ignored");continue}select=uncomment(text.slice(6).trim(),false);if(!select){if(parse.cur_tune_opts)parse.cur_tune_opts.voice_opts=null;else parse.voice_opts=null;continue}if(select=="end")continue;if(parse.cur_tune_opts){if(!parse.cur_tune_opts.voice_opts)parse.cur_tune_opts.voice_opts={};opt=parse.cur_tune_opts.voice_opts}else{if(!parse.voice_opts)parse.voice_opts={};opt=parse.voice_opts}opt[select]=[];while(1){bol=++eol;if(file[bol]!="%")break;eol=file.indexOf("\n",eol);if(file[bol+1]!=line1)continue;bol+=2;if(eol<0)text=file.slice(bol);else text=file.slice(bol,eol);a=text.split(/\s+/,1);switch(a[0]){default:opt[select].push(uncomment(text.trim(),true));continue;case"score":case"staves":case"tune":case"voice":bol-=2;break}break}eol=bol-1;continue}do_pscom(uncomment(text.trim(),true));continue}if(line1!=":"){last_info=undefined;if(parse.state!=3){if(parse.state!=2)continue;goto_tune()}parse_music_line();continue}text=file.slice(bol+2,eol);text=uncomment(text.trim(),true);if(line0=="+"&&line1==":"){if(!last_info){syntax(1,"No previous info field");continue}txt_add=" ";line0=last_info}switch(line0){case"X":if(parse.state!=0){syntax(1,"X: found in tune - ignored");continue}if(parse.select&&!tune_selected())continue;cfmt_sav=clone(cfmt);cfmt.pos=clone(cfmt.pos);info_sav=clone(info);char_tb_sav=clone(char_tb);glovar_sav=clone(glovar);maps_sav=maps;info.X=text;parse.state=1;continue;case"T":if(parse.state==0)continue;curvoice=voice_tb[0];if(!curvoice){if(info.T==undefined)info.T=text;else info.T+="\n"+text;continue}s={type:BLOCK,subtype:"title",text:text};sym_link(s);continue;case"K":if(parse.state==0)continue;if(parse.state==1)info.K=text;else if(parse.state==2)goto_tune();parse.line.buffer=text;parse.line.index=0;do_info(line0,text);if(parse.state!=1)continue;parse.state=2;if(!glovar.ulen)glovar.ulen=BASE_LEN/8;continue;case"W":if(parse.state==0||cfmt.writefields.indexOf("W")<0)break;if(!info.W)info.W=text;else info.W+=txt_add+text;break;case"s":if(parse.state!=3)break;break;case"w":if(parse.state!=3||cfmt.writefields.indexOf("w")<0)break;get_lyrics(text,txt_add==" ");if(text[text.length-1]=="\\"){txt_add=" ";last_info=line0;continue}break;case"|":if(parse.state!=3){if(parse.state!=2)continue;goto_tune()}parse_music_line();continue;default:if("ABCDFGHOSZ".indexOf(line0)>=0){if(parse.state>=2){syntax(1,line0+": in tune - ignored");continue}if(!info[line0])info[line0]=text;else info[line0]+=txt_add+text;break}parse.line.buffer=text;parse.line.index=0;do_info(line0,text);continue}txt_add="\n";last_info=line0}if(parse.state>=2)end_tune();blk_flush();parse.state=0}Abc.prototype.tosvg=tosvg;var gene,staff_tb,tsnext,realwidth,insert_meter,beta_last;var space_tb=[7,10,14.15,20,28.3,40,56.6,80,113,150],smallest_duration;const dx_tb={full:9,empty:10,oval:12,square:15.3};function set_head_shift(s){var i,i1,i2,d,ps,dx,dx_head=dx_tb[s.head],dir=s.stem,n=s.nhd;if(s.dur>=BASE_LEN*2&&s.head=="oval")dx_head=15.8;if(n==0){if(s.notes[0].acc){if(s.grace)dx_head*=.7;s.notes[0].shac=dx_head}return}dx=dx_head*.78;if(s.grace)dx*=.5;if(dir>=0){i1=1;i2=n+1;ps=s.notes[0].pit}else{dx=-dx;i1=n-1;i2=-1;ps=s.notes[n].pit}var shift=false,dx_max=0;for(i=i1;i!=i2;i+=dir){d=s.notes[i].pit-ps;ps=s.notes[i].pit;if(d==0){if(shift){var new_dx=s.notes[i].shhd=s.notes[i-dir].shhd+dx;if(dx_max<new_dx)dx_max=new_dx;continue}if(i+dir!=i2&&ps+dir==s.notes[i+dir].pit){s.notes[i].shhd=-dx;if(dx_max<-dx)dx_max=-dx;continue}}if(d<0)d=-d;if(d>3||d>=2&&s.head!="square"){shift=false}else{shift=!shift;if(shift){s.notes[i].shhd=dx;if(dx_max<dx)dx_max=dx}}}s.xmx=dx_max}function set_acc_shft(){var s,s2,st,i,acc,st,t,dx_head;function acc_shift(notes,dx_head){var i,i1,dx,dx1,ps,p1,acc,n=notes.length;for(i=n-1;--i>=0;){dx=notes[i].shhd;if(!dx||dx>0)continue;dx=dx_head-dx;ps=notes[i].pit;for(i1=n;--i1>=0;){if(!notes[i1].acc)continue;p1=notes[i1].pit;if(p1<ps-3)break;if(p1>ps+3)continue;if(notes[i1].shac<dx)notes[i1].shac=dx}}for(i=n;--i>=0;){acc=notes[i].acc;if(!acc)continue;dx=notes[i].shac;if(!dx){dx=notes[i].shhd;if(dx<0)dx=dx_head-dx;else dx=dx_head}ps=notes[i].pit;for(i1=n;--i1>i;){if(!notes[i1].acc)continue;p1=notes[i1].pit;if(p1>=ps+4){if(p1>ps+4||acc<0||notes[i1].acc<0)continue}if(dx>notes[i1].shac-6){dx1=notes[i1].shac+7;if(dx1>dx)dx=dx1}}notes[i].shac=dx}}s=tsfirst;while(s){if(s.type!=NOTE||s.invisible){s=s.ts_next;continue}st=s.st;t=s.time;acc=false;for(s2=s;s2;s2=s2.ts_next){if(s2.time!=t||s2.type!=NOTE||s2.st!=st)break;if(acc)continue;for(i=0;i<=s2.nhd;i++){if(s2.notes[i].acc){acc=true;break}}}if(!acc){s=s2;continue}dx_head=dx_tb[s.head];if(s.dur>=BASE_LEN*2&&s.head=="oval")dx_head=15.8;st={notes:[]};for(;s!=s2;s=s.ts_next)st.notes=st.notes.concat(s.notes);sort_pitch(st);acc_shift(st.notes,dx_head)}}function unlksym(s){if(!s.next){if(s.extra){s.type=FORMAT;s.fmt_type=undefined;return}}else{s.next.prev=s.prev;if(s.extra){var g=s.next.extra;if(!g){s.next.extra=s.extra}else{for(;g.next;g=g.next);g.next=s.extra}}}if(s.prev)s.prev.next=s.next;else voice_tb[s.v].sym=s.next;if(s.ts_next){if(s.seqst&&!s.ts_next.seqst){s.ts_next.seqst=true;s.ts_next.shrink=s.shrink;s.ts_next.space=s.space}if(s.new_sy)s.ts_next.new_sy=true;s.ts_next.ts_prev=s.ts_prev}if(s.ts_prev)s.ts_prev.ts_next=s.ts_next;if(tsfirst==s)tsfirst=s.ts_next;if(tsnext==s)tsnext=s.ts_next}function may_combine(s){var nhd2,s2=s.ts_next;if(!s2||s2.type!=NOTE&&s2.type!=REST)return false;if(s2.v==s.v||s2.st!=s.st||s2.time!=s.time||s2.dur!=s.dur)return false;if(s.combine<=0&&s2.type!=s.type)return false;if(s.a_gch&&s2.a_gch)return false;if(s.type==REST){if(s.type==s2.type&&s.invisible&&!s2.invisible)return false;return true}if(s2.a_ly||s2.sl1||s2.sl2||s2.slur_start||s2.slur_end)return false;if(s2.beam_st!=s.beam_st||s2.beam_end!=s.beam_end)return false;nhd2=s2.nhd;if(s.combine<=1&&s.notes[0].pit<=s2.notes[nhd2].pit+1)return false;return true}function combine_notes(s,s2){var nhd,type,m;s.notes=s.notes.concat(s2.notes);s.nhd=nhd=s.notes.length-1;sort_pitch(s);if(s.combine>=3){for(m=nhd;m>0;m--){if(s.notes[m].pit==s.notes[m-1].pit&&s.notes[m].acc==s.notes[m-1].acc)s.notes.splice(m,1);
}s.nhd=nhd=s.notes.length-1}s.ymx=3*(s.notes[nhd].pit-18)+4;s.ymn=3*(s.notes[0].pit-18)-4;s.yav=(s.ymx+s.ymn)/2;if(s.a_dd){if(s2.a_dd)s.a_dd=s.a_dd.concat(s2.a_dd)}else{s.a_dd=s2.a_dd}type=s.notes[0].ti1;if((type&15)==SL_AUTO)s.notes[0].ti1=SL_BELOW|type&~SL_DOTTED;type=s.notes[nhd].ti1;if((type&15)==SL_AUTO)s.notes[nhd].ti1=SL_ABOVE|type&~SL_DOTTED}function do_combine(s){var s2,nhd,nhd2,type;while(1){nhd=s.nhd;s2=s.ts_next;nhd2=s2.nhd;delete s2.extra;if(s.type!=s2.type){if(s2.type!=REST){s2=s;s=s2.ts_next}}else if(s.type==REST){if(s.invisible&&!s2.invisible)delete s.invisible}else{combine_notes(s,s2)}if(s2.text&&!s.text){s.text=s2.text;s.a_gch=s2.a_gch}unlksym(s2);if(s.in_tuplet||!may_combine(s))break}}function combine_voices(){var s,s2,g,i,r;for(s=tsfirst;s.ts_next;s=s.ts_next){if(s.combine<0)continue;if(s.combine==0&&s.type!=REST)continue;if(s.in_tuplet){g=s.extra;if(!g)continue;r=0;for(;g;g=g.next){if(g.type==TUPLET&&g.tuplet_r>r)r=g.tuplet_r}if(r==0)continue;i=r;for(s2=s;s2;s2=s2.next){if(!s2.ts_next)break;if(s2.type!=NOTE&&s2.type!=REST)continue;if(!may_combine(s2))break;if(--i<=0)break}if(i>0)continue;for(s2=s;;s2=s2.next){if(s2.type!=NOTE&&s2.type!=REST)continue;do_combine(s2);if(--r<=0)break}continue}if(s.type!=NOTE){if(s.type==REST){if(may_combine(s))do_combine(s)}continue}if(!s.beam_st)continue;if(s.beam_end){if(may_combine(s))do_combine(s);continue}s2=s;while(1){if(!may_combine(s2)){s2=null;break}if(s2.beam_end)break;do{s2=s2.next}while(s2.type!=NOTE&&s2.type!=REST)}if(!s2)continue;s2=s;while(1){do_combine(s2);if(s2.beam_end)break;do{s2=s2.next}while(s2.type!=NOTE&&s2.type!=REST)}}}function insert_clef(s,clef_type,clef_line){var p_voice=voice_tb[s.v],new_s,st=s.st;if(s.type==BAR&&s.prev&&s.prev.type==BAR)s=s.prev;p_voice.last_sym=s.prev;if(!p_voice.last_sym)p_voice.sym=null;p_voice.time=s.time;new_s=sym_add(p_voice);new_s.type=CLEF;new_s.next=s;s.prev=new_s;new_s.clef_type=clef_type;new_s.clef_line=clef_line;new_s.st=st;new_s.clef_small=true;new_s.second=undefined;new_s.notes=[];new_s.notes[0]={pit:s.notes[0].pit};new_s.nhd=0;while(!s.seqst)s=s.ts_prev;if(s.ts_prev.type!=CLEF)new_s.seqst=true;new_s.ts_prev=s.ts_prev;new_s.ts_prev.ts_next=new_s;new_s.ts_next=s;s.ts_prev=new_s;return new_s}function set_float(){var p_voice,st,staff_chg,v,s,s1,up,down;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(!p_voice.floating)continue;staff_chg=false;st=p_voice.st;for(s=p_voice.sym;s;s=s.next){if(s.type!=NOTE){if(staff_chg)s.st++;continue}if(!s.floating){staff_chg=false;continue}if(s.notes[0].pit>=19){staff_chg=false;continue}if(s.notes[s.nhd].pit<=12){staff_chg=true;s.st++;continue}up=127;for(s1=s.ts_prev;s1;s1=s1.ts_prev){if(s1.st!=st||s1.v==s.v)break;if(s1.type==NOTE)if(s1.notes[0].pit<up)up=s1.notes[0].pit}if(up==127){if(staff_chg)s.st++;continue}if(s.notes[s.nhd].pit>up-3){staff_chg=false;continue}down=-127;for(s1=s.ts_next;s1;s1=s1.ts_next){if(s1.st!=st+1||s1.v==s.v)break;if(s1.type==NOTE)if(s1.notes[s1.nhd].pit>down)down=s1.notes[s1.nhd].pit}if(down==-127){if(staff_chg)s.st++;continue}if(s.notes[0].pit<down+3){staff_chg=true;s.st++;continue}up-=s.notes[s.nhd].pit;down=s.notes[0].pit-down;if(!staff_chg){if(up<down+3)continue;staff_chg=true}else{if(up<down-3){staff_chg=false;continue}}s.st++}}}function set_graceoffs(s){var g,next,m,xx,gspleft,gspinside,gspright;gspleft=Number(cfmt.gracespace[0]);gspinside=Number(cfmt.gracespace[1]);gspright=Number(cfmt.gracespace[2]);xx=0;for(g=s.extra;;g=g.next){if(g.type==NOTE)break}g.beam_st=true;for(;;g=g.next){if(g.type!=NOTE){if(!g.next)break;continue}set_head_shift(g);for(m=g.nhd;m>=0;m--){if(g.notes[m].acc){xx+=5;if(g.notes[m].micro)xx+=2;break}}g.x=xx;if(g.nflags<=0){g.beam_st=true;g.beam_end=true}next=g.next;if(!next){g.beam_end=true;break}if(next.nflags<=0)g.beam_end=true;if(g.beam_end){next.beam_st=true;xx+=gspinside/4}if(g.nflags<=0)xx+=gspinside/4;if(g.y>next.y+8)xx-=1.5;xx+=gspinside}xx+=gspleft+gspright;next=s.next;if(next&&next.type==NOTE){if(g.y>=3*(next.notes[next.nhd].pit-18))xx-=1;else if(g.beam_st&&g.y<3*(next.notes[0].pit-18)-7)xx+=2}return xx}function gchord_width(s,wlnote,wlw){var s2,gch,w,wl,lspc=0,rspc=0;for(var ix=0;ix<s.a_gch.length;ix++){gch=s.a_gch[ix];switch(gch.type){default:wl=-gch.x;if(wl>lspc)lspc=wl;w=gch.w+2-wl;if(w>rspc)rspc=w;break;case"<":w=gch.w+wlnote;if(w>lspc)lspc=w;break;case">":w=gch.w+s.wr;if(w>rspc)rspc=w;break}}s2=s.prev;if(s2&&s2.a_gch){for(s2=s.ts_prev;;s2=s2.ts_prev){if(s2==s.prev){if(wlw<lspc)wlw=lspc;break}if(s2.seqst)lspc-=s2.shrink}}s2=s.next;if(s2&&s2.a_gch){for(s2=s.ts_next;;s2=s2.ts_next){if(s2==s.next){if(s.wr<rspc)s.wr=rspc;break}if(s2.seqst)rspc-=8}}return wlw}function set_width(s){var s2,i,m,xx,w,wlnote,wlw,acc;switch(s.type){case NOTE:case REST:switch(s.head){default:wlnote=8;break;case"oval":wlnote=6;break;case"empty":wlnote=5;break;case"full":wlnote=4.5;break}s.wr=wlnote;if(s.xmx>0)s.wr+=s.xmx+4;s2=s.prev;if(s2){switch(s2.type){case BAR:case CLEF:case KEY:case METER:wlnote+=3;break}}for(m=0;m<=s.nhd;m++){xx=s.notes[m].shhd;if(xx<0){if(wlnote<-xx+5)wlnote=-xx+5}if(s.notes[m].acc){var tmp=s.notes[m].shac+(s.notes[m].micro?6.5:4.5);if(wlnote<tmp)wlnote=tmp}}if(s2){switch(s2.type){case BAR:case CLEF:case KEY:case METER:wlnote-=3;break}}if(s.a_dd)wlnote+=deco_width(s);if(s.beam_st&&s.beam_end&&s.stem>0&&s.nflags>0){if(s.wr<s.xmx+9)s.wr=s.xmx+9}if(s.dots>0){switch(s.head){case"square":case"oval":s.xmx+=2;break;case"empty":s.xmx+=1;break}if(s.wr<s.xmx+12)s.wr=s.xmx+12;if(s.dots>=2)s.wr+=3.5*(s.dots-1)}if(s.trem2&&s.beam_end&&wlnote<20)wlnote=20;wlw=wlnote;if(s2){switch(s2.type){case NOTE:if(s2.stem>0&&s.stem<0){if(wlw<7)wlw=7}if(s.y>27&&s2.y>27||s.y<-3&&s2.y<-3){if(wlw<6)wlw=6}if(s2.ti1){if(wlw<14)wlw=14}break;case CLEF:if(s2.second||s2.clef_small)break;wlw+=8;break;case KEY:wlw+=4;break}}if(s.a_gch)wlw=gchord_width(s,wlnote,wlw);if(s.a_ly)wlw=ly_width(s,wlw);if(s2&&s2.type==GRACE)s.wl=wlnote-4.5;else s.wl=wlw;return;case SPACE:xx=s.width/2;s.wr=xx;if(s.a_gch)xx=gchord_width(s,xx,xx);if(s.a_dd)xx+=deco_width(s);s.wl=xx;return;case BAR:if(s.norepbra)break;if(!s.invisible){var bar_type=s.bar_type;switch(bar_type){case"|":w=5+3;break;case"|:":case":|":w=5+3+3+5;break;case"::":w=5+5+3+3+3+5;break;default:if(!bar_type)break;w=5+3*bar_type.length;for(i=0;i<bar_type.length;i++){switch(bar_type[i]){case"[":case"]":w+=3;break;case":":w+=2;break}}break}s.wl=w;if(s.next&&s.next.type!=METER)s.wr=8;else s.wr=5}else{s.wl=s.wr=0}if(s.a_dd)s.wl+=deco_width(s);if(s.a_gch&&s.a_gch[0].text.length<4)s.wl=gchord_width(s,s.wl,s.wl);return;case CLEF:if(s.invisible)break;s.wl=12;s.wr=s.clef_small?10:12;return;case KEY:var n1,n2,esp;s.wl=3;esp=4;if(!s.k_a_acc){n1=s.k_sf;if(s.k_old_sf&&(cfmt.cancelkey||n1==0))n2=s.k_old_sf;else n2=0;if(n1*n2>=0){if(n1<0)n1=-n1;if(n2<0)n2=-n2;if(n2>n1)n1=n2}else{n1-=n2;if(n1<0)n1=-n1;esp+=3}}else{n1=n2=s.k_a_acc.length;var last_acc=s.k_a_acc[0].acc;for(i=1;i<n2;i++){acc=s.k_a_acc[i];if(acc.pit>s.k_a_acc[i-1].pit+6||acc.pit<s.k_a_acc[i-1].pit-6)n1--;else if(acc.acc!=last_acc)esp+=3;last_acc=acc.acc}}s.wr=5.5*n1+esp;return;case METER:w=0;for(i=0;i<s.a_meter.length;i++){var meter=s.a_meter[i];if(meter.top=="C|"){w+=6.5}else{if(!meter.bot||meter.top.length>meter.bot.length)w+=6.5*meter.top.length;else w+=6.5*meter.bot.length}}s.wl=w;s.wr=w+7;return;case MREST:s.wl=40/2+16;s.wr=40/2+16;return;case GRACE:s.wl=set_graceoffs(s);s.wr=0;return;case STBRK:s.wl=s.xmx;if(s.next&&s.next.type==CLEF){s.wr=2;delete s.next.clef_small}else{s.wr=8}return;case FORMAT:s.wl=6;s.wr=0;return;default:error(2,s,"set_width - Cannot set width for symbol "+s.type);break}s.wl=s.wr=0}function set_space(s){var s2,i,l,space,prev_time=s.ts_prev.time,len=s.time-prev_time;if(len==0){switch(s.type){case MREST:return s.wl+16;case NOTE:case REST:if(s.ts_prev.type==BAR){if(s.nflags<-2)return space_tb[0];return space_tb[2]}break}return 0}if(s.ts_prev.type==MREST)return s.ts_prev.wr+16+3;if(smallest_duration>=BASE_LEN/2){if(smallest_duration>=BASE_LEN)len/=4;else len/=2}if(len>=BASE_LEN/4){if(len<BASE_LEN/2)i=5;else if(len<BASE_LEN)i=6;else if(len<BASE_LEN*2)i=7;else if(len<BASE_LEN*4)i=8;else i=9}else{if(len>=BASE_LEN/8)i=4;else if(len>=BASE_LEN/16)i=3;else if(len>=BASE_LEN/32)i=2;else if(len>=BASE_LEN/64)i=1;else i=0}l=len-(BASE_LEN/16/8<<i);space=space_tb[i];if(l!=0){if(l<0){space=space_tb[0]*len/(BASE_LEN/16/8)}else{if(i>=9)i=8;space+=(space_tb[i+1]-space_tb[i])*l/len}}if(!s.dur){switch(s.type){case BAR:if(s.bar_type.length>1)space*=.8;else space*=.7;break;case CLEF:space-=s.wl;break}return space}if(!s.beam_st)space*=.9;if(s.type==NOTE&&s.nflags>=-1&&s.stem>0){var stemdir=true;for(s2=s.ts_prev;s2&&s2.time==prev_time;s2=s2.ts_prev){if(s2.type==NOTE&&(s2.nflags<-1||s2.stem>0)){stemdir=false;break}}if(stemdir){for(s2=s.ts_next;s2&&s2.time==s.time;s2=s2.ts_next){if(s2.type==NOTE&&(s2.nflags<-1||s2.stem<0)){stemdir=false;break}}if(stemdir)space*=.9}}return space}function set_allsymwidth(last_s){var p_voice,s2,s3,i,v,shrink,space;var new_val=0,s=tsfirst;while(1){set_width(s);if(new_val<s.wl)new_val=s.wl;s=s.ts_next;if(s==last_s||s.seqst)break}tsfirst.shrink=new_val;tsfirst.space=0;if(s==last_s)return;while(1){s2=s;shrink=space=0;do{var ymx1,ymn1,ymx2,ymn2,wl;set_width(s2);if(s2.type==BAR){ymx1=50;ymn1=-50}else{ymx1=s2.ymx;ymn1=s2.ymn}wl=s2.wl;new_val=0;for(s3=s.ts_prev;s3;s3=s3.ts_prev){if(new_val<s3.wr&&(s3.type==NOTE||s3.type==REST)&&(s2.type==NOTE||s2.type==REST))new_val=s3.wr;if(s3.st==s2.st&&(!s3.invisible||s3.v==s2.v)&&new_val<s3.wr+wl){switch(s3.type){case NOTE:case REST:if(s2.type==NOTE||s2.type==REST){new_val=s3.wr+wl;break}default:ymx2=s3.ymx;ymn2=s3.ymn;if(ymn1>ymx2||ymx1<ymn2)break;case SPACE:case BAR:case CLEF:case METER:case KEY:new_val=s3.wr+wl;break}}if(s3.seqst){if(new_val!=0)break;wl-=s3.shrink;if(wl<0)break}}if(shrink<new_val)shrink=new_val;new_val=set_space(s2);if(space<new_val)space=new_val;if((s2=s2.ts_next)==last_s)break}while(!s2.seqst);if(shrink==0&&space==0&&s.type==CLEF){delete s.seqst;s.time=s.ts_prev.time}s.shrink=shrink;s.space=space;if((s=s2)==last_s)break}}function to_rest(s){s.type=REST;delete s.in_tuplet;delete s.sl1;delete s.sl2;delete s.a_dd;delete s.a_gch;delete s.extra;s.slur_start=s.slur_end=0}function set_repeat(g,s){var s2,s3,i,j,n,dur,st=s.st,v=s.v;if((n=g.repeat_n)<0){n=-n;i=n;for(s3=s.prev;s3;s3=s3.prev){if(!s3.dur){if(s3.type==BAR){error(1,s3,"Bar in sequence to repeat");g.fmt_type=undefined;return}continue}if(--i<=0)break}if(!s3){error(1,s,"Not enough symbols to repeat");g.fmt_type=undefined;return}i=g.repeat_k*n;for(s2=s;s2;s2=s2.next){if(!s2.dur){if(s2.type==BAR){error(1,s2,"Bar in repeat sequence");g.fmt_type=undefined;return}continue}if(--i<=0)break}if(!s2||!s2.next){error(1,s,"Not enough symbols after repeat sequence");g.fmt_type=undefined;return}for(s2=s.prev;s2!=s3;s2=s2.prev){if(s2.type==NOTE){s2.beam_end=true;break}}s3=s;for(j=g.repeat_k;--j>=0;){i=n;if(s3.dur)i--;s2=s3.ts_next;while(i>0){if(s2.st!=st)continue;if(s2.v==v&&s2.dur)i--;delete s2.extra;unlksym(s2);s2=s2.ts_next}to_rest(s3);s3.dur=s3.notes[0].dur=s2.time-s3.time;s3.repeat_n=-1;s3.beam_st=true;set_width(s3);if(s3.seqst)s3.space=set_space(s3);s3.head="square";s3=s2}g.fmt_type=undefined;return}i=n;for(s2=s.prev.prev;s2;s2=s2.prev){if(s2.type==BAR||s2.time==tsfirst.time){if(--i<=0)break}}if(!s2){error(1,s,"Not enough measures to repeat");g.fmt_type=undefined;return}dur=s.time-s2.time;if(n==1)i=g.repeat_k;else i=n;for(s2=s;s2;s2=s2.next){if(s2.type==BAR){if(--i<=0)break}}if(!s2){error(1,s,"Not enough bars after repeat measure");g.fmt_type=undefined;return}i=g.repeat_k;if(n==2&&i>1){s2=s2.next;if(!s2){error(1,s,"Not enough bars after repeat measure");g.fmt_type=undefined;return}g.repeat_k=1;s=clone(g);s.next=s2.extra;if(s.next)s.next.prev=s;delete s.prev;s2.extra=s;s.repeat_k=--i}dur/=n;if(n==2){s3=s;for(s2=s.ts_next;;s2=s2.ts_next){if(s2.st!=st)continue;if(s2.v==v&&s2.type==BAR)break;delete s2.extra;unlksym(s2)}to_rest(s3);s3.dur=s3.notes[0].dur=dur;s3.invisible=true;if(s3.seqst)s3.space=set_space(s3);s2.bar_mrep=2;if(s2.seqst)s2.space=set_space(s2);s3=s2.next;s2=s3.next;while(1){if(s2.type==BAR||s2.type==CLEF)break;delete s2.extra;unlksym(s2);s2=s2.next}to_rest(s3);s3.dur=s3.notes[0].dur=dur;s3.invisible=true;set_width(s3);if(s3.seqst)s3.space=set_space(s3);if(s2.seqst)s2.space=set_space(s2);return}s3=s;for(j=g.repeat_k;--j>=0;){for(s2=s3.ts_next;;s2=s2.ts_next){if(s2.st!=st)continue;if(s2.v==v&&s2.type==BAR)break;delete s2.extra;unlksym(s2)}to_rest(s3);s3.dur=s3.notes[0].dur=dur;s3.beam_st=true;if(s3.seqst)s3.space=set_space(s3);if(s2.seqst)s2.space=set_space(s2);if(g.repeat_k==1){s3.repeat_n=1;break}s3.repeat_n=g.repeat_k-j+1;s3=s2.next}}function custos_add(s){var p_voice,new_s,i,s2=s;while(1){if(s2.type==NOTE)break;s2=s2.next;if(!s2)return}p_voice=voice_tb[s.v];p_voice.last_sym=s.prev;p_voice.time=s.time;new_s=sym_add(p_voice);new_s.type=CUSTOS;new_s.next=s;s.prev=new_s;new_s.ts_prev=s.ts_prev;new_s.ts_prev.ts_next=new_s;new_s.ts_next=s;s.ts_prev=new_s;new_s.seqst=true;new_s.wl=8;new_s.wr=4;new_s.shrink=s.shrink;if(new_s.shrink<8+4)new_s.shrink=8+4;new_s.space=s2.space;new_s.nhd=s2.nhd;new_s.notes=[];for(i=0;i<s.notes.length;i++){new_s.notes[i]={pit:s2.notes[i].pit,shhd:0,dur:BASE_LEN/4}}new_s.stemless=true}function set_nl(s){var s2,p_voice,cut_here,new_sy,extra,done;function set_eol(s){if(cfmt.custos&&voice_tb.length==1){custos_add(s)}else{s2=s.ts_prev;switch(s2.type){case BAR:case FORMAT:case CLEF:case KEY:case METER:break;default:p_voice=voice_tb[s2.v];p_voice.last_sym=s2;p_voice.time=s.time;s2=s2.next;extra=sym_add(p_voice);extra.type=FORMAT;extra.next=s2;if(s2)s2.prev=extra;extra.ts_prev=extra.prev;extra.ts_prev.ts_next=extra;extra.ts_next=s;s.ts_prev=extra;extra.seqst=true;extra.wl=6;extra.shrink=s.shrink;extra.space=s.space;if(s.x)extra.x=s.x;break}}s.nl=true}function set_eol_next(s){s=s.next;if(!s)return s;while(!s.seqst)s=s.ts_prev;set_eol(s);return s}if(s.eoln&&!cfmt.keywarn&&!cfmt.timewarn)return set_eol_next(s);switch(s.type){case CLEF:case BAR:break;case KEY:if(cfmt.keywarn&&!s.k_none)break;return set_eol_next(s);case METER:if(cfmt.timewarn)break;return set_eol_next(s);case GRACE:s=s.next;if(!s)return s;default:return set_eol_next(s)}for(;s;s=s.ts_prev){if(!s.seqst)continue;switch(s.type){case KEY:case CLEF:case METER:continue}break}done=0;for(;;s=s.ts_next){if(!s)return s;if(s.new_sy){new_sy=true;s.new_sy=false}if(!s.seqst)continue;if(done<0)break;switch(s.type){case BAR:if(done||!s.bar_num&&s.next&&s.bar_type[s.bar_type.length-1]==":"&&s.bar_type[0]!=":")cut_here=true;else done=1;break;case STBRK:if(!s.stbrk_forced){unlksym(s);break}done=-1;break;case METER:if(!cfmt.timewarn)cut_here=true;break;case CLEF:if(done)cut_here=true;break;case KEY:if(!cfmt.keywarn||s.k_none)cut_here=true;break;default:if(!done||s.prev&&s.prev.type==GRACE)break;cut_here=true;break}if(cut_here)break;if(s.extra){if(!extra)extra=s;else error(2,s,"Extra symbol may be misplaced")}}if(extra&&extra!=s){s2=extra.extra;while(s2.next)s2=s2.next;s2.next=s.extra;s.extra=extra.extra;delete extra.extra}if(new_sy){s.new_sy=true}set_eol(s);return s}function get_ck_width(){var v,p_voice,nv=voice_tb.length;for(v=0;v<nv;v++){p_voice=voice_tb[v];if(p_voice.clef)break}set_width(p_voice.clef);set_width(p_voice.key);if(!cfmt.singleline)return p_voice.clef.wl+p_voice.clef.wr+p_voice.key.wl+p_voice.key.wr;set_width(p_voice.meter);return p_voice.clef.wl+p_voice.clef.wr+p_voice.key.wl+p_voice.key.wr+p_voice.meter.wl+p_voice.meter.wr}function get_width(first,last,w){var s,shrink,space,sp_fac=1-cfmt.maxshrink;for(s=first;s!=last;s=s.ts_next){if(!s.seqst)continue;s.x=w;shrink=s.shrink;if((space=s.space)<shrink)w+=shrink;else w+=shrink*cfmt.maxshrink+space*sp_fac}return w}function set_lines(first,last,lwidth,indent){var s,s2,s3,x,xmin,xmax,wwidth,shrink,space,nlines,cut_here;wwidth=get_width(first,last,indent);s=first;while(1){nlines=Math.ceil(wwidth/lwidth);if(nlines<=1){if(last)last=set_nl(last);return last}s2=first=s;xmin=s.x+wwidth/nlines*cfmt.breaklimit;xmax=s.x+lwidth;cut_here=false;for(;s!=last;s=s.ts_next){x=s.x;if(!x)continue;if(x>xmax)break;if(s.type!=BAR)continue;if(x>xmin){cut_here=true;break}s2=s}if(s==last)return last;if(!cut_here){var beam=s2.dur&&!s2.beam_st&&!s2.beam_end?1:0,bar_time=s2.time;s=s2;s2=s3=null;xmax-=6;for(;s!=last;s=s.ts_next){if(s.beam_st){if(!s.beam_end){beam++;continue}}else if(s.beam_end){beam--}x=s.x;if(!x||x<xmin)continue;if(x+x.shrink>=xmax)break;if(beam!=0)continue;s2=s;if((s.time-bar_time)%(BASE_LEN/8)==0)s3=s}if(s3)s2=s3;if(s2)s=s2;while(!s.x||s.x+s.shrink*2>=xmax)s=s.ts_prev}if(s.nl){error(0,s,"Line split problem - "+"adjust maxshrink and/or breaklimit");nlines=2;for(s=s.ts_next;s!=last;s=s.ts_next){if(!s.x)continue;if(--nlines<=0)break}}s=set_nl(s);if(!s||last&&s.time>=last.time)break;wwidth-=s.x-first.x}return s}function cut_tune(lwidth,indent){var s,s2,i,xmin,s=tsfirst;lwidth-=get_ck_width();if(cfmt.custos&&voice_tb.length==1)lwidth-=12;if(cfmt.barsperstaff){i=cfmt.barsperstaff;s2=s;for(;s;s=s.ts_next){if(s.type!=BAR||!s.bar_num)continue;if(--i>0)continue;s.eoln=true;i=cfmt.barsperstaff}s=s2}xmin=indent;s2=s;for(;s;s=s.ts_next){if(!s.seqst&&!s.eoln)continue;xmin+=s.shrink;if(xmin>lwidth){for(;s;s=s.ts_next){if(s.eoln)break}s=s2=set_lines(s2,s,lwidth,indent);if(!s)break;xmin=s.shrink;indent=0;continue}if(!s.eoln)continue;s2=set_nl(s);delete s.eoln;s=s2;if(!s)break;xmin=s.shrink;indent=0}}function set_yval(s){switch(s.type){case CLEF:if(s.second||s.invisible){s.ymx=s.ymn=12;break}s.y=(s.clef_line-1)*6;switch(s.clef_type){default:s.ymx=s.y+28;s.ymn=s.y-14;break;case"c":s.ymx=s.y+13;s.ymn=s.y-11;break;case"b":s.ymx=s.y+7;s.ymn=s.y-12;break}if(s.clef_small){s.ymx-=2;s.ymn+=2}if(s.ymx<26)s.ymx=26;if(s.ymn>-1)s.ymn=-1;if(s.clef_octave){if(s.clef_octave>0)s.ymx+=12;else s.ymn-=12}break;case KEY:if(s.k_sf>2)s.ymx=24+10;else if(s.k_sf>0)s.ymx=24+6;else s.ymx=24+2;s.ymn=-2;break;default:s.ymx=24+2;s.ymn=-2;break}}function set_auto_clef(st,s_start,clef_type_start){var s,min,max,time,s2,s3;max=12;min=20;for(s=s_start;s;s=s.ts_next){if(s.new_sy&&s!=s_start)break;if(s.st!=st)continue;if(s.type!=NOTE){if(s.type==CLEF){if(s.clef_type!="a")break;unlksym(s)}continue}if(s.notes[0].pit<min)min=s.notes[0].pit;else if(s.notes[s.nhd].pit>max)max=s.notes[s.nhd].pit}if(min>=19||min>=13&&clef_type_start!="b")return"t";if(max<=13||max<=19&&clef_type_start!="t")return"b";if(clef_type_start=="a"){if((max+min)/2>=16)clef_type_start="t";else clef_type_start="b"}var clef_type=clef_type_start,s_last=s,s_last_chg=null;for(s=s_start;s!=s_last;s=s.ts_next){if(s.new_sy&&s!=s_start)break;if(s.st!=st||s.type!=NOTE)continue;time=s.time;if(clef_type=="t"){if(s.notes[0].pit>12||s.notes[s.nhd].pit>20){if(s.notes[0].pit>20)s_last_chg=s;continue}s2=s.ts_prev;if(s2&&s2.time==time&&s2.st==st&&s2.type==NOTE&&s2.notes[0].pit>=19)continue;s2=s.ts_next;if(s2&&s2.st==st&&s2.time==time&&s2.type==NOTE&&s2.notes[0].pit>=19)continue}else{if(s.notes[0].pit<12||s.notes[s.nhd].pit<20){if(s.notes[s.nhd].pit<12)s_last_chg=s;continue}s2=s.ts_prev;if(s2&&s2.time==time&&s2.st==st&&s2.type==NOTE&&s2.notes[0].pit<=13)continue;s2=s.ts_next;if(s2&&s2.st==st&&s2.time==time&&s2.type==NOTE&&s2.notes[0].pit<=13)continue}if(!s_last_chg){clef_type=clef_type_start=clef_type=="t"?"b":"t";s_last_chg=s;continue}s3=s;for(s2=s.ts_prev;s2!=s_last_chg;s2=s2.ts_prev){if(s2.st!=st)continue;if(s2.type==BAR&&s2.v==s.v){s3=s2;break}if(s2.type!=NOTE)continue;if(s2.beam_st&&!voice_tb[s2.v].second)s3=s2}if(s3.time==s_last_chg.time){s_last_chg=s;continue}s_last_chg=s;clef_type=clef_type=="t"?"b":"t";s2=insert_clef(s3,clef_type,clef_type=="t"?2:4);s2.clef_auto=true}return clef_type_start}function set_clefs(){var s,s2,st,v,p_voice,g,new_type,new_line,p_staff,staff_clef=new Array(nstaff),sy=cur_sy;staff_tb=new Array(nstaff);for(st=0;st<=nstaff;st++){staff_clef[st]={autoclef:true};staff_tb[st]={output:[]}}for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(sy.voices[v].range<0)continue;st=sy.voices[v].st;if(!sy.voices[v].second){if(p_voice.stafflines!=undefined)sy.staves[st].stafflines=p_voice.stafflines;if(p_voice.staffscale)sy.staves[st].staffscale=p_voice.staffscale;if(sy.voices[v].sep)sy.staves[st].sep=sy.voices[v].sep;if(sy.voices[v].maxsep)sy.staves[st].maxsep=sy.voices[v].maxsep}if(!sy.voices[v].second&&!p_voice.clef.clef_auto)staff_clef[st].autoclef=false}for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(sy.voices[v].range<0||sy.voices[v].second)continue;st=sy.voices[v].st;s=p_voice.clef;if(staff_clef[st].autoclef){s.clef_type=set_auto_clef(st,tsfirst,s.clef_type);s.clef_line=s.clef_type=="t"?2:4}staff_clef[st].clef=staff_tb[st].clef=s}for(s=tsfirst;s;s=s.ts_next){for(g=s.extra;g;g=g.next){if(g.type==FORMAT&&g.fmt_type=="repeat"){set_repeat(g,s);break}}if(s.new_sy){sy=sy.next;for(st=0;st<=nstaff;st++)staff_clef[st].autoclef=true;for(v=0;v<voice_tb.length;v++){if(sy.voices[v].range<0)continue;p_voice=voice_tb[v];st=sy.voices[v].st;if(!sy.voices[v].second){if(p_voice.stafflines!=undefined)sy.staves[st].stafflines=p_voice.stafflines;if(p_voice.staffscale)sy.staves[st].staffscale=p_voice.staffscale;if(sy.voices[v].sep)sy.staves[st].sep=sy.voices[v].sep;if(sy.voices[v].maxsep)sy.staves[st].maxsep=sy.voices[v].maxsep}s2=p_voice.clef;if(!s2.clef_auto)staff_clef[st].autoclef=false}for(v=0;v<voice_tb.length;v++){if(sy.voices[v].range<0||sy.voices[v].second)continue;p_voice=voice_tb[v];st=sy.voices[v].st;s2=p_voice.clef;if(s2.clef_auto){new_type=set_auto_clef(st,s,staff_clef[st].clef?staff_clef[st].clef.clef_type:"a");new_line=new_type=="t"?2:4}else{new_type=s2.clef_type;new_line=s2.clef_line}if(!staff_clef[st].clef){if(s2.clef_auto){if(s2.type!="a")p_voice.clef=clone(p_voice.clef);p_voice.clef.clef_type=new_type;p_voice.clef.clef_line=new_line}staff_tb[st].clef=staff_clef[st].clef=p_voice.clef;continue}if(new_type==staff_clef[st].clef.clef_type&&new_line==staff_clef[st].clef.clef_line)continue;g=s;while(g.v!=v)g=g.ts_next;if(g.type!=CLEF){g=insert_clef(g,new_type,new_line);if(s2.clef_auto)g.clef_auto=true}staff_clef[st].clef=p_voice.clef=g}}if(s.type!=CLEF)continue;p_voice=voice_tb[s.v];p_voice.clef=s;if(s.second){unlksym(s);continue}st=s.st;if(staff_clef[st].clef){if(s.clef_type==staff_clef[st].clef.clef_type&&s.clef_line==staff_clef[st].clef.clef_line&&!s.new_sy){continue}}else{staff_tb[st].clef=s}staff_clef[st].clef=s}sy=cur_sy;for(v=0;v<voice_tb.length;v++){if(sy.voices[v].range<0)continue;s2=voice_tb[v].sym;if(!s2||s2.notes[0].pit!=127)continue;st=sy.voices[v].st;switch(staff_tb[st].clef.clef_type){default:pitch=22;break;case"c":pitch=16;break;case"b":pitch=10;break}for(s=s2;s;s=s.next)s.notes[0].pit=pitch}}const delta_tb={t:0-2*2,c:6-3*2,b:12-4*2,p:0-3*2};const rest_sp=[[18,18],[12,18],[12,12],[8,12],[6,8],[10,10],[6,4],[10,0],[10,4],[10,10]];function set_pitch(last_s){var s,s2,g,st,delta,m,pitch,dur,note,staff_delta=new Array(nstaff),sy=cur_sy;for(st=0;st<=nstaff;st++){s=staff_tb[st].clef;staff_delta[st]=delta_tb[s.clef_type]+s.clef_line*2;if(s.clef_oct_transp)staff_delta[st]-=s.clef_octave}dur=BASE_LEN;for(s=tsfirst;s!=last_s;s=s.ts_next){st=s.st;switch(s.type){case CLEF:staff_delta[st]=delta_tb[s.clef_type]+s.clef_line*2;if(s.clef_oct_transp)staff_delta[st]-=s.clef_octave;set_yval(s);break;case GRACE:for(g=s.extra;g;g=g.next){if(g.type!=NOTE)continue;delta=staff_delta[g.st];if(delta!=0&&!voice_tb[s.v].key.k_drum){for(m=0;m<=g.nhd;m++){note=g.notes[m];note.pit+=delta}}g.ymn=3*(g.notes[0].pit-18)-2;g.ymx=3*(g.notes[g.nhd].pit-18)+2}set_yval(s);break;case KEY:s.k_y_clef=staff_delta[st];default:set_yval(s);break;case MREST:if(s.invisible)break;s.y=12;s.ymx=24+15;s.ymn=-2;break;case REST:if(voice_tb.length==1){s.y=12;s.ymx=24;s.ymn=0;break}case NOTE:delta=staff_delta[st];if(delta!=0&&!voice_tb[s.v].key.k_drum){for(m=s.nhd;m>=0;m--)s.notes[m].pit+=delta}if(s.type==NOTE){s.ymx=3*(s.notes[s.nhd].pit-18)+4;s.ymn=3*(s.notes[0].pit-18)-4;s.yav=(s.ymx+s.ymn)/2}else{s.y=Math.floor((s.notes[0].pit-18)/2)*6;s.ymx=s.y+rest_sp[5-s.nflags][0];s.ymn=s.y-rest_sp[5-s.nflags][1]}if(s.dur<dur)dur=s.dur;break}}smallest_duration=dur}function set_stem_dir(){var t,u,i,st,rvoice,v,v_s,st_v,vobj,v_st_tb,st_v_tb=[],s=tsfirst,sy=cur_sy,nst=sy.nstaff;while(s){for(st=0;st<=nst;st++)st_v_tb[st]=[];v_st_tb=[];for(u=s;u;u=u.ts_next){if(u.type==BAR)break;if(u.new_sy){if(u!=s)break;sy=sy.next;for(st=nst;st<=sy.nstaff;st++)st_v_tb[st]=[];nst=sy.nstaff}if(u.type!=NOTE&&u.type!=REST||u.invisible)continue;st=u.st;if(st>nst){var msg="*** fatal set_stem_dir(): bad staff number "+st+" max "+nst;error(2,null,msg);throw new Error(msg)}v=u.v;v_st=v_st_tb[v];if(!v_st){v_st={st1:-1,st2:-1};v_st_tb[v]=v_st}if(v_st.st1<0){v_st.st1=st}else if(v_st.st1!=st){if(st>v_st.st1){if(st>v_st.st2)v_st.st2=st}else{if(v_st.st1>v_st.st2)v_st.st2=v_st.st1;v_st.st1=st}}st_v=st_v_tb[st];rvoice=sy.voices[v].range;for(i=st_v.length;--i>=0;){vobj=st_v[i];if(vobj.v==rvoice)break}if(i<0){vobj={v:rvoice,ymx:0,ymn:24};for(i=0;i<st_v.length;i++){if(rvoice<st_v[i].v){st_v.splice(i,0,vobj);break}}if(i==st_v.length)st_v.push(vobj)}if(u.type!=NOTE)continue;if(u.ymx>vobj.ymx)vobj.ymx=u.ymx;if(u.ymn<vobj.ymn)vobj.ymn=u.ymn;if(u.xstem){if(u.ts_prev.st!=st-1||u.ts_prev.type!=NOTE){error(1,s,"Bad +xstem+");delete u.xstem}else{u.ts_prev.multi=1;u.multi=1;u.stemless=true}}}for(;s!=u;s=s.ts_next){if(s.multi)continue;if(s.type!=NOTE&&s.type!=REST&&s.type!=GRACE)continue;st=s.st;v=s.v;v_st=v_st_tb[v];st_v=st_v_tb[st];if(v_st&&v_st.st2>=0){if(st==v_st.st1)s.multi=-1;else if(st==v_st.st2)s.multi=1;continue}if(st_v.length<=1){if(s.floating){if(st==voice_tb[v].st)s.multi=-1;else s.multi=1}continue}rvoice=sy.voices[v].range;for(i=st_v.length;--i>=0;){if(st_v[i].v==rvoice)break}if(i<0)continue;if(i==st_v.length-1){s.multi=-1}else{s.multi=1;if(i!=0&&i+2==st_v.length){if(st_v[i].ymn-cfmt.stemheight>st_v[i+1].ymx)s.multi=-1;t=s.ts_next;if(s.ts_prev&&s.ts_prev.time==s.time&&s.ts_prev.st==s.st&&s.notes[s.nhd].pit==s.ts_prev.notes[0].pit&&s.beam_st&&s.beam_end&&(!t||t.st!=s.st||t.time!=s.time))s.multi=-1}}}while(s&&s.type==BAR){if(s.new_sy){sy=sy.next;nst=sy.nstaff}s=s.ts_next}}}function set_rest_offset(){var s,s2,v,end_time,not_alone,v_s,y,ymax,ymin,shift,dots,dx,v_s_tb=[],sy=cur_sy;for(s=tsfirst;s;s=s.ts_next){if(s.invisible)continue;if(s.new_sy)sy=sy.next;switch(s.type){default:continue;case NOTE:case REST:break}v_s=v_s_tb[s.v];if(!v_s){v_s={};v_s_tb[s.v]=v_s}v_s.s=s;v_s.st=s.st;v_s.end_time=s.time+s.dur;if(s.type!=REST)continue;ymin=-127;ymax=127;not_alone=dots=false;for(v=0;v<=v_s_tb.length;v++){v_s=v_s_tb[v];if(!v_s||!v_s.s||v_s.st!=s.st||v==s.v)continue;if(v_s.end_time<=s.time)continue;not_alone=true;s2=v_s.s;if(sy.voices[v].range<sy.voices[s.v].range){if(s2.ymn<ymax){if(s2.time==s.time){ymax=s2.ymn;if(s2.dots)dots=true}else{ymax=(s2.ymx+s2.ymn)/2}}}else{if(s2.ymx>ymin){if(s2.time==s.time){ymin=s2.ymx;if(s2.dots)dots=true}else{ymin=(s2.ymx+s2.ymn)/2}}}}end_time=s.time+s.dur;for(s2=s.ts_next;s2;s2=s2.ts_next){if(s2.time>=end_time)break;if(s2.st!=s.st||s2.type!=NOTE&&s2.type!=REST||s2.invisible)continue;not_alone=true;if(sy.voices[s2.v].range<sy.voices[s.v].range){if(s2.ymn<ymax){if(s2.time==s.time){ymax=s2.ymn;if(s2.dots)dots=true}else{ymax=(s2.ymx+s2.ymn)/2}}}else{if(s2.ymx>ymin){if(s2.time==s.time){ymin=s2.ymx;if(s2.dots)dots=true}else{ymin=(s2.ymx+s2.ymn)/2}}}}shift=ymax-s.ymx;if(shift<0){shift=Math.ceil(-shift/6)*6;if(s.ymn-shift>=ymin){s.y-=shift;s.ymx-=shift;s.ymn-=shift;continue}dx=dots?15:10;s.notes[0].shhd=dx;s.xmx=dx;continue}shift=ymin-s.ymn;if(shift>0){shift=Math.ceil(shift/6)*6;if(s.ymx+shift<=ymax){s.y+=shift;s.ymx+=shift;s.ymn+=shift;continue}dx=dots?15:10;s.notes[0].shhd=dx;s.xmx=dx;continue}if(!not_alone){s.y=12;s.ymx=24;s.ymn=0}}}function new_sym(type,p_voice,last_s){s={type:type,ctx:last_s.ctx,v:p_voice.v,st:p_voice.st,time:last_s.time,next:p_voice.last_sym.next};if(s.next)s.next.prev=s;p_voice.last_sym.next=s;s.prev=p_voice.last_sym;p_voice.last_sym=s;s.ts_next=last_s;s.ts_prev=last_s.ts_prev;s.ts_prev.ts_next=s;if(s.ts_prev.type!=type)s.seqst=true;last_s.ts_prev=s;if(last_s.type==type&&s.v!=last_s.v){delete last_s.seqst;last_s.shrink=0}return s}function init_music_line(){var p_voice,s,last_s,v,st,nv=voice_tb.length;for(v=0;v<nv;v++){p_voice=voice_tb[v];if(cur_sy.voices[v].range<0)continue;p_voice.second=cur_sy.voices[v].second;st=cur_sy.voices[v].st;while(st<nstaff&&cur_sy.staves[st].empty)st++;p_voice.st=st}last_s=tsfirst;for(s=last_s.extra;s;s=s.next){if(s.type!=BLOCK)continue;switch(s.subtype){case"center":write_text(s.text,"c");break;case"sep":vskip(s.sk1);output.push('<path class="stroke"\n	d="M');out_sxsy(s.x," ",0);output.push("h"+s.l.toFixed(2)+'"/>\n');vskip(s.sk2);blk_out();break;case"ml":svg_flush();user.img_out(s.text);break;case"text":write_text(s.text,s.opt);break;case"title":write_title(s.text,true);break;case"vskip":vskip(s.sk);blk_out();break}}while(last_s.type==CLEF){v=last_s.v;p_voice=voice_tb[v];if(cur_sy.voices[v].range>=0&&!cur_sy.voices[v].second){delete last_s.clef_small;p_voice.last_sym=p_voice.sym=last_s}last_s=last_s.ts_next}for(v=0;v<nv;v++){p_voice=voice_tb[v];if(p_voice.sym&&p_voice.sym.type==CLEF)continue;if(cur_sy.voices[v].range<0||cur_sy.voices[v].second&&!p_voice.bar_start)continue;st=cur_sy.voices[v].st;if(!staff_tb[st]||!staff_tb[st].clef)continue;s=clone(staff_tb[st].clef);s.v=v;s.st=st;s.time=last_s.time;s.prev=null;s.next=p_voice.sym;if(s.next)s.next.prev=s;p_voice.sym=s;p_voice.last_sym=s;s.ts_next=last_s;s.ts_prev=last_s.ts_prev;if(!s.ts_prev){tsfirst=s;s.seqst=true}else{s.ts_prev.ts_next=s;delete s.seqst}last_s.ts_prev=s;if(last_s.type==CLEF)delete last_s.seqst;delete s.clef_small;s.second=cur_sy.voices[v].second;if(cur_sy.staves[st].empty)s.invisible=true}for(v=0;v<nv;v++){if(cur_sy.voices[v].range<0||cur_sy.voices[v].second||cur_sy.staves[cur_sy.voices[v].st].empty)continue;p_voice=voice_tb[v];if(last_s.v==v&&last_s.type==KEY){p_voice.last_sym=last_s;last_s=last_s.ts_next;continue}if(p_voice.key.k_sf||p_voice.key.k_a_acc){s=new_sym(KEY,p_voice,last_s);s.k_sf=p_voice.key.k_sf;s.k_old_sf=p_voice.key.k_sf;s.k_a_acc=p_voice.key.k_a_acc;s.istart=p_voice.key.istart;s.iend=p_voice.key.iend;if(p_voice.key.k_bagpipe){s.k_bagpipe=p_voice.key.k_bagpipe;if(s.k_bagpipe=="p")s.k_old_sf=3}}}if(insert_meter&1){for(v=0;v<nv;v++){p_voice=voice_tb[v];if(cur_sy.voices[v].range<0||cur_sy.voices[v].second||cur_sy.staves[cur_sy.voices[v].st].empty||p_voice.meter.a_meter.length==0)continue;if(last_s.v==v&&last_s.type==METER){p_voice.last_sym=last_s;last_s=last_s.ts_next;continue}s=new_sym(METER,p_voice,last_s);s.istart=p_voice.meter.istart;s.iend=p_voice.meter.iend;s.wmeasure=p_voice.meter.wmeasure;s.a_meter=p_voice.meter.a_meter}}for(v=0;v<nv;v++){p_voice=voice_tb[v];if(!p_voice.bar_start||cur_sy.voices[v].range<0||cur_sy.staves[cur_sy.voices[v].st].empty)continue;s=new_sym(BAR,p_voice,last_s);s.istart=p_voice.bar_start.istart;s.iend=p_voice.bar_start.iend;s.bar_type=p_voice.bar_start.bar_type;if(p_voice.bar_start.invisible)s.invisible=true;if(p_voice.bar_start.norepbra)s.norepbra=true;s.text=p_voice.bar_start.text;s.a_gch=p_voice.bar_start.a_gch;if(p_voice.bar_start.rbstart)s.rbstart=p_voice.bar_start.rbstart;delete p_voice.bar_start}set_pitch(last_s);s=last_s;if(s){for(;s;s=s.ts_next)if(s.seqst)break}if(s){for(s=s.ts_next;s;s=s.ts_next)if(s.seqst)break}set_allsymwidth(s)}function set_words(p_voice){var s,pitch,start_flag,nflags,lastnote;for(s=p_voice.sym;s;s=s.next){if(s.type==NOTE){pitch=s.notes[0].pit;break}}if(!s)pitch=127;start_flag=true;for(s=p_voice.sym;s;s=s.next){switch(s.type){case MREST:start_flag=true;break;case BAR:if(!s.beam_on)start_flag=true;if(!s.next&&s.prev&&s.prev.type==NOTE&&s.prev.dur>=BASE_LEN*2)s.prev.head="square";break;case NOTE:case REST:if(s.trem2)break;nflags=s.nflags;if(s.ntrem)nflags+=s.ntrem;if(s.type==REST&&s.beam_end){s.beam_end=false;start_flag=true}if(start_flag||nflags<=0){if(lastnote){lastnote.beam_end=true;lastnote=null}if(nflags<=0){s.beam_st=true;s.beam_end=true}else if(s.type==NOTE){s.beam_st=true;
start_flag=false}}if(s.beam_end)start_flag=true;if(s.type==NOTE)lastnote=s;break}if(s.type==NOTE){if(s.nhd!=0)sort_pitch(s);pitch=s.notes[0].pit;if(s.prev&&s.prev.type!=NOTE){s.prev.notes[0].pit=(s.prev.notes[0].pit+pitch)/2}}else{if(!s.notes){s.notes=[];s.notes[0]={};s.nhd=0}s.notes[0].pit=pitch}}if(lastnote)lastnote.beam_end=true}function set_rb(p_voice){var s2,mx,n,s=p_voice.sym;while(s){if(s.type!=BAR||!s.rbstart){s=s.next;continue}mx=cfmt.rbmax;if(s.text&&s.text[0]=="1"){n=0;s2=null;for(s=s.next;s;s=s.next){if(s.type!=BAR)continue;n++;if(s.rbstop){if(n<=cfmt.rbmax){mx=n;s2=null}break}if(n==cfmt.rbmin)s2=s}if(s2){s2.rbstop=1;mx=cfmt.rbmin}}while(s){if(s.rbstart!=2){s=s.next;if(!s)break;if(s.rbstart!=2){s=s.next;if(!s)break;if(s.rbstart!=2)break}}n=0;s2=null;for(s=s.next;s;s=s.next){if(s.type!=BAR)continue;n++;if(s.rbstop)break;if(n==mx)s.rbstop=1}}}}const delpit=[0,-7,-14,0];function set_global(){var s,p_voice,st,v,nv;var sy=cur_sy;st=sy.nstaff;while(1){sy=sy.next;if(!sy)break;if(sy.nstaff>st)st=sy.nstaff}nstaff=st;nv=voice_tb.length;for(v=0;v<nv;v++){p_voice=voice_tb[v];set_words(p_voice);if(!p_voice.second&&!p_voice.norepbra)set_rb(p_voice)}set_float();set_clefs();set_pitch(null)}function set_indent(){var st,v,w,p_voice,p,i,j,font,nv=voice_tb.length,maxw=0;for(v=0;v<nv;v++){p_voice=voice_tb[v];if(cur_sy.voices[v].range<0)continue;st=cur_sy.voices[v].st;if(cur_sy.staves[st].empty)continue;p=p_voice.new_name?p_voice.nm:p_voice.snm;if(!p)continue;if(!font){font=get_font("voice");gene.curfont=gene.deffont=font}i=0;while(1){j=p.indexOf("\\n",i);if(j<0)w=strw(p.slice(i));else w=strw(p.slice(i,j));if(w>maxw)maxw=w;if(j<0)break;i=j+1}}if(maxw!=0){w=0;for(st=0;st<=cur_sy.nstaff;st++){if(cur_sy.staves[st].flags&(OPEN_BRACE2|OPEN_BRACKET2)){w=20;break}if(cur_sy.staves[st].flags&(OPEN_BRACE|OPEN_BRACKET)&&w==0)w=10}maxw+=4*cwid(" ")*font.swfac+w}if(insert_meter&2)maxw+=cfmt.indent;return maxw}function set_beams(sym){var s,t,g,beam,s_opp,dy,laststem=-1,lasty=0;for(s=sym;s;s=s.next){if(s.type!=NOTE){if(s.type!=GRACE)continue;g=s.extra;while(g.type!=NOTE)g=g.next;if(g.stem==2){s_opp=s;continue}if(!s.stem&&(s.stem=s.multi)==0)s.stem=1;for(;g;g=g.next){g.stem=s.stem;g.multi=s.multi}continue}if(!s.stem&&(s.stem=s.multi)==0){if(beam){s.stem=laststem}else if(s.beam_st&&!s.beam_end){var avg=s.yav,n=12;for(t=s.next;t;t=t.next){if(t.type==NOTE){if(t.multi){avg=n-t.multi;break}avg+=t.yav;n+=12}if(t.beam_end)break}if(avg<n)laststem=1;else if(avg>n||cfmt.bstemdown)laststem=-1;beam=true;s.stem=laststem}else{s.stem=s.yav>=12?-1:1;if(s.yav==12&&!cfmt.bstemdown){if(!s.prev||s.prev.type==BAR){for(t=s.next;t;t=t.next){if(t.type==NOTE||t.type==BAR)break}if(t&&t.type==NOTE&&t.yav<12)s.stem=1}else{dy=s.yav-lasty;if(dy>-7&&dy<7)s.stem=laststem}}}}else{if(s.beam_st&&!s.beam_end)beam=true}if(s.beam_end)beam=false;laststem=s.stem;lasty=s.yav;if(s_opp){for(g=s_opp.extra;g;g=g.next)g.stem=-laststem;s_opp.stem=-laststem;s_opp=null}}}function same_head(s1,s2){var i1,i2,l1,l2,head,i11,i12,i21,i22,sh1,sh2;if(s1.shiftunison&&s1.shiftunison>=3)return false;if((l1=s1.dur)>=BASE_LEN)return false;if((l2=s2.dur)>=BASE_LEN)return false;if(s1.stemless&&s2.stemless)return false;if(s1.dots!=s2.dots){if(s1.shiftunison&&s1.shiftunison&1||s1.dots*s2.dots!=0)return false}if(s1.stem*s2.stem>0)return false;i1=i2=0;if(s1.notes[0].pit>s2.notes[0].pit){if(s1.stem<0)return false;while(s2.notes[i2].pit!=s1.notes[0].pit){if(++i2>s2.nhd)return false}}else if(s1.notes[0].pit<s2.notes[0].pit){if(s2.stem<0)return false;while(s2.notes[0].pit!=s1.notes[i1].pit){if(++i1>s1.nhd)return false}}if(s2.notes[i2].acc!=s1.notes[i1].acc)return false;i11=i1;i21=i2;sh1=s1.notes[i1].shhd;sh2=s2.notes[i2].shhd;do{i1++;i2++;if(i1>s1.nhd){break}if(i2>s2.nhd){break}if(s2.notes[i2].acc!=s1.notes[i1].acc)return false;if(sh1<s1.notes[i1].shhd)sh1=s1.notes[i1].shhd;if(sh2<s2.notes[i2].shhd)sh2=s2.notes[i2].shhd}while(s2.notes[i2].pit==s1.notes[i1].pit);if(i1<=s1.nhd){if(i2<=s2.nhd)return false;if(s2.stem>0)return false}else if(i2<=s2.nhd){if(s1.stem>0)return false}i12=i1;i22=i2;head=0;if(l1!=l2){if(l1<l2){l1=l2;l2=s1.dur}if(l1<BASE_LEN/2){if(s2.dots>0)head=2;else if(s1.dots>0)head=1}else if(l2<BASE_LEN/4){if(s1.shiftunison&&s1.shiftunison&2)return false;head=s2.dur>=BASE_LEN/2?2:1}else{return false}}if(head==0)head=voice_tb[s1.v].scale<voice_tb[s2.v].scale?2:1;if(head==1){s2.nohdi1=i21;s2.nohdi2=i22;for(i2=i21;i2<i22;i2++)delete s2.notes[i2].acc;for(i2=0;i2<=s2.nhd;i2++)s2.notes[i2].shhd+=sh1}else{s1.nohdi1=i11;s1.nohdi2=i12;for(i1=i11;i1<i12;i1++)delete s1.notes[i1].acc;for(i1=0;i1<=s1.nhd;i1++)s1.notes[i1].shhd+=sh2}return true}const w_note={full:3.5,empty:3.7,oval:5,square:7};function unison_acc(s1,s2,i1,i2){var m,d;if(!s2.notes[i2].acc){d=w_note[s2.head]*2+s2.xmx+s1.notes[i1].shac+2;if(s1.notes[i1].micro)d+=2;if(s2.dots)d+=6;for(m=0;m<=s1.nhd;m++){s1.notes[m].shhd+=d;s1.notes[m].shac-=d}s1.xmx+=d}else{d=w_note[s1.head]*2+s1.xmx+s2.notes[i2].shac+2;if(s2.notes[i2].micro)d+=2;if(s1.dots)d+=6;for(m=0;m<=s2.nhd;m++){s2.notes[m].shhd+=d;s2.notes[m].shac-=d}s2.xmx+=d}}const MAXPIT=48*2;function set_left(s,left){var m,i,j,w,shift,w_base=w_note[s.head];for(i=0;i<MAXPIT;i++)left[i]=-100;w=w_base;if(s.stem>0){w=-w;i=s.notes[0].pit*2;j=(Math.ceil((s.ymx-2)/3)+18)*2}else{i=(Math.ceil((s.ymn+2)/3)+18)*2;j=s.notes[s.nhd].pit*2}if(i<0)i=0;for(;i<MAXPIT&&i<=j;i++)left[i]=w;shift=s.notes[s.stem>0?0:s.nhd].shhd;for(m=0;m<=s.nhd;m++){w=-s.notes[m].shhd+w_base+shift;i=s.notes[m].pit*2;if(i<0)i=0;else if(i>=MAXPIT-1)i=MAXPIT-2;if(w>left[i])left[i]=w;if(s.head!="square")w-=1;if(w>left[i-1])left[i-1]=w;if(w>left[i+1])left[i+1]=w}}function set_right(s,right){var m,i,j,k,flags,w,shift,w_base=w_note[s.head];for(i=0;i<MAXPIT;i++)right[i]=-100;flags=s.nflags>0&&s.beam_st&&s.beam_end;w=w_base;if(s.stem<0){w=-w;i=(Math.ceil((s.ymn+2)/3)+18)*2;j=s.notes[s.nhd].pit*2;k=i+4}else{i=s.notes[0].pit*2;j=(Math.ceil((s.ymx-2)/3)+18)*2}if(i<0)i=0;for(;i<MAXPIT&&i<j;i++)right[i]=w;if(flags){if(s.stem>0){if(s.xmx==0)i=s.notes[s.nhd].pit*2;else i=s.notes[0].pit*2;i+=4;if(i<0)i=0;for(;i<MAXPIT&&i<=j-4;i++)right[i]=11}else{i=k;if(i<0)i=0;for(;i<MAXPIT&&i<=s.notes[0].pit*2-4;i++)right[i]=3.5}}shift=s.notes[s.stem>0?0:s.nhd].shhd;for(m=0;m<=s.nhd;m++){w=s.notes[m].shhd+w_base-shift;i=s.notes[m].pit*2;if(i<0)i=0;else if(i>=MAXPIT-1)i=MAXPIT-2;if(w>right[i])right[i]=w;if(s.head!="square")w-=1;if(w>right[i-1])right[i-1]=w;if(w>right[i+1])right[i+1]=w}}function set_overlap(){var s,s1,s2,i,i1,i2,m,sd,t,dp,d,d2,dr,dr2,dx,left1=[],right1=[],left2=[],right2=[],pl,pr;function v_invert(){s1=s2;s2=s;d=d2;pl=left1;pr=right1;dr2=dr}for(s=tsfirst;s;s=s.ts_next){if(s.type!=NOTE||s.invisible)continue;if(s.xstem&&s.ts_prev.stem<0){s2=s.ts_prev;for(m=0;m<=s2.nhd;m++){s2.notes[m].shhd+=3.5*2;s2.notes[m].shac-=3.5*2}s2.xmx+=3.5*2}s2=s;for(;;){s2=s2.ts_next;if(!s2)break;if(s2.time!=s.time){s2=null;break}if(s2.type==NOTE&&!s2.invisible&&s2.st==s.st)break}if(!s2)continue;s1=s;if(cur_sy.voices[s1.v].range<cur_sy.voices[s2.v].range)s2.dot_low=true;else s1.dot_low=true;if(s1.ymn>s2.ymx||s1.ymx<s2.ymn)continue;if(same_head(s1,s2))continue;set_right(s1,right1);set_left(s2,left2);d=-10;for(i=0;i<MAXPIT;i++){if(left2[i]+right1[i]>d)d=left2[i]+right1[i]}if(d<-3){if(!s1.dots||!s2.dots||!s2.dot_low||s1.stem>0||s2.stem<0||s1.notes[s1.nhd].pit+2!=s2.notes[0].pit||s2.notes[0].pit&1)continue}set_right(s2,right2);set_left(s1,left1);d2=dr=dr2=-100;for(i=0;i<MAXPIT;i++){if(left1[i]+right2[i]>d2)d2=left1[i]+right2[i];if(right2[i]>dr2)dr2=right2[i];if(right1[i]>dr)dr=right1[i]}t=0;i1=s1.nhd;i2=s2.nhd;for(;;){dp=s1.notes[i1].pit-s2.notes[i2].pit;switch(dp){case 0:if(s1.notes[i1].acc!=s2.notes[i2].acc){t=-1;break}if(s2.notes[i2].acc)s2.notes[i2].acc=0;if(s1.dots&&s2.dots&&s1.notes[i1].pit&1)t=1;break;case-1:if(s1.dots&&s2.dots){if(s1.notes[i1].pit&1){s1.dot_low=false;s2.dot_low=false}else{s1.dot_low=true;s2.dot_low=true}}break;case-2:if(s1.dots&&s2.dots&&!(s1.notes[i1].pit&1)){s1.dot_low=false;s2.dot_low=false;break}break}if(t<0)break;if(dp>=0){if(--i1<0)break}if(dp<=0){if(--i2<0)break}}if(t<0){unison_acc(s1,s2,i1,i2);continue}sd=0;if(s1.dots){if(s2.dots){if(!t)sd=1}}else if(s2.dots){if(d2+dr<d+dr2)sd=1}pl=left2;pr=right2;if(d2+dr<d+dr2)v_invert();d+=3;if(d<0)d=0;m=s1.stem>=0?0:s1.nhd;d+=s1.notes[m].shhd;m=s2.stem>=0?0:s2.nhd;d-=s2.notes[m].shhd;if(s1.dots){dx=7.7+s1.xmx+3.5*s1.dots-3.5+3;if(!sd){d2=-100;for(i1=0;i1<=s1.nhd;i1++){i=s1.notes[i1].pit;if(!(i&1)){if(!s1.dot_low)i++;else i--}i*=2;if(i<1)i=1;else if(i>=MAXPIT-1)i=MAXPIT-2;if(pl[i]>d2)d2=pl[i];if(pl[i-1]+1>d2)d2=pl[i-1]+1;if(pl[i+1]+1>d2)d2=pl[i+1]+1}if(dx+d2+2>d)d=dx+d2+2}else{if(dx<d+dr2+s2.xmx){d2=0;for(i1=0;i1<=s1.nhd;i1++){i=s1.notes[i1].pit;if(!(i&1)){if(!s1.dot_low)i++;else i--}i*=2;if(i<1)i=1;else if(i>=MAXPIT-1)i=MAXPIT-2;if(pr[i]>d2)d2=pr[i];if(pr[i-1]+1>d2)d2=pr[i-1]=1;if(pr[i+1]+1>d2)d2=pr[i+1]+1}if(d2>4.5&&7.7+s1.xmx+2<d+d2+s2.xmx)s2.xmx=d2+3-7.7}}}for(m=s2.nhd;m>=0;m--){s2.notes[m].shhd+=d}s2.xmx+=d;if(sd)s1.xmx=s2.xmx}}function set_stems(){var s,s2,g,slen,scale,ymn,ymx,nflags,ymin,ymax;for(s=tsfirst;s;s=s.ts_next){if(s.type!=NOTE){if(s.type!=GRACE)continue;ymin=ymax=12;for(g=s.extra;g;g=g.next){if(g.type!=NOTE)continue;slen=GSTEM;if(g.nflags>1)slen+=1.2*(g.nflags-1);ymn=3*(g.notes[0].pit-18);ymx=3*(g.notes[g.nhd].pit-18);if(s.stem>=0){g.y=ymn;g.ys=ymx+slen;ymx=Math.round(g.ys)}else{g.y=ymx;g.ys=ymn-slen;ymn=Math.round(g.ys)}ymx+=2;ymn-=2;if(ymn<ymin)ymin=ymn;else if(ymx>ymax)ymax=ymx;g.ymx=ymx;g.ymn=ymn}s.ymx=ymax;s.ymn=ymin;continue}set_head_shift(s);nflags=s.nflags;if(s.beam_st&&!s.beam_end){if(s.feathered_beam)nflags=++s.nflags;for(s2=s.next;;s2=s2.next){if(s2.type==NOTE){if(s.feathered_beam)s2.nflags++;if(s2.beam_end)break}}if(s2.nflags>nflags)nflags=s2.nflags}else if(!s.beam_st&&s.beam_end){for(s2=s.prev;;s2=s2.prev){if(s2.beam_st)break}if(s2.nflags>nflags)nflags=s2.nflags}slen=cfmt.stemheight;switch(nflags){case 2:slen+=2;break;case 3:slen+=5;break;case 4:slen+=10;break;case 5:slen+=16;break}if((scale=voice_tb[s.v].scale)!=1)slen*=(scale+1)*.5;ymn=3*(s.notes[0].pit-18);if(s.nhd>0){slen-=2;ymx=3*(s.notes[s.nhd].pit-18)}else{ymx=ymn}if(s.ntrem)slen+=2*s.ntrem;if(s.stemless){if(s.stem>=0){s.y=ymn;s.ys=ymx}else{s.ys=ymn;s.y=ymx}if(nflags==-4)ymn-=6;s.ymx=ymx+4;s.ymn=ymn-4}else if(s.stem>=0){if(nflags>=2)slen-=1;if(s.notes[s.nhd].pit>26&&(nflags<=0||!s.beam_st||!s.beam_end)){slen-=2;if(s.notes[s.nhd].pit>28)slen-=2}s.y=ymn;if(s.notes[0].ti1)ymn-=3;s.ymn=ymn-4;s.ys=ymx+slen;if(s.ys<12)s.ys=12;s.ymx=s.ys+2.5}else{if(s.notes[0].pit<18&&(nflags<=0||!s.beam_st||!s.beam_end)){slen-=2;if(s.notes[0].pit<16)slen-=2}s.ys=ymn-slen;if(s.ys>12)s.ys=12;s.ymn=s.ys-2.5;s.y=ymx;if(s.notes[s.nhd].ti1)ymx+=3;s.ymx=ymx+4}}}function check_bar(s){var bar_type,i,b1,b2,p_voice=voice_tb[s.v];while(s.type==CLEF||s.type==KEY||s.type==METER){if(s.type==METER&&s.time>p_voice.sym.time)insert_meter|=1;s=s.prev;if(!s)return}if(s.type!=BAR)return;if(s.text!=undefined){p_voice.bar_start=clone(s);p_voice.bar_start.bar_type="[";delete s.text;delete s.a_gch}bar_type=s.bar_type;if(bar_type==":")return;if(bar_type[bar_type.length-1]!=":")return;if(!p_voice.bar_start)p_voice.bar_start=clone(s);if(bar_type[0]!=":"){p_voice.bar_start.bar_type=bar_type;if(s.prev&&s.prev.type==BAR)unlksym(s);else s.bar_type="|";return}if(bar_type=="::"){p_voice.bar_start.bar_type="|:";s.bar_type=":|";return}i=0;while(bar_type[i]==":")i++;if(i<bar_type.length){s.bar_type=bar_type.slice(0,i)+"|";i=bar_type.length-1;while(bar_type[i]==":")i--;p_voice.bar_start.bar_type="|"+bar_type.slice(i+1)}else{i=Math.floor(bar_type.length/2);s.bar_type=bar_type.slice(0,i)+"|";p_voice.bar_start.bar_type="|"+bar_type.slice(i)}}function sym_staff_move(st,s,sy){while(1){if(s.st==st&&s.type!=CLEF){s.st++;s.invisible=true}s=s.ts_next;if(s==tsnext||s.new_sy)break}}function set_piece(){var s,p_voice,st,v,nst,nv,empty=[],sy=cur_sy;function reset_staff(st){var p_staff=staff_tb[st],sy_staff=sy.staves[st];if(!p_staff)p_staff=staff_tb[st]={};p_staff.y=0;p_staff.stafflines=sy_staff.stafflines;p_staff.staffscale=sy_staff.staffscale;empty[st]=true}function set_empty(sy){var st,i,empty_fl,n=sy.staves.length;for(st=0;st<n;st++){if(!(sy.staves[st].flags&(OPEN_BRACE|OPEN_BRACE2)))continue;empty_fl=0;i=st;while(st<n){empty_fl|=sy.staves[st].empty?1:2;if(sy.staves[st].flags&(CLOSE_BRACE|CLOSE_BRACE2))break;st++}if(empty_fl==3){while(i<=st)sy.staves[i++].empty=false}}}function set_top_bot(){var st,p_staff,i,l,hole;for(st=0;st<=nstaff;st++){p_staff=staff_tb[st];if(empty[st]){p_staff.botbar=p_staff.topbar=0;continue}l=p_staff.stafflines.length;p_staff.topbar=6*(l-1);for(i=0;i<l-1;i++)if(p_staff.stafflines[i]!=".")break;p_staff.botline=p_staff.botbar=i*6;if(i>=l-2){p_staff.botbar-=6;p_staff.topbar+=6}}}nstaff=nst=sy.nstaff;for(st=0;st<=nst;st++)reset_staff(st);for(s=tsfirst;s;s=s.ts_next){if(s.nl)break;if(s.new_sy){for(st=0;st<=nstaff;st++){sy.staves[st].empty=empty[st];empty[st]=true}set_empty(sy);for(;st<=nst;st++)sy.staves[st].empty=true;sy=sy.next;nst=sy.nstaff;if(nst>nstaff)nstaff=nst;for(;st<=nst;st++)reset_staff(st)}if(s.st>nstaff){unlksym(s);continue}if(!empty[s.st])continue;switch(s.type){case GRACE:empty[s.st]=false;break;case NOTE:case REST:case SPACE:case MREST:if(cfmt.staffnonote>1){empty[s.st]=false}else if(!s.invisible){if(cfmt.staffnonote!=0||s.type==NOTE)empty[s.st]=false}break}}tsnext=s;for(st=0;st<=nstaff;st++)sy.staves[st].empty=empty[st];set_empty(sy);set_top_bot();sy=cur_sy;for(st=0;st<nstaff;st++){if(sy.staves[st].empty)sym_staff_move(st,tsfirst,sy)}if(sy.next){for(s=tsfirst;s;s=s.ts_next){if(s.nl)break;if(s.new_sy){sy=sy.next;for(st=0;st<sy.nstaff;st++){if(sy.staves[st].empty)sym_staff_move(st,s,sy)}if(!sy.next)break}}}if(empty[nstaff])staff_tb[nstaff].topbar=0;init_music_line();if(!empty[nstaff])insert_meter&=~1;if(!tsnext)return;s=tsnext;s.nl=false;s=s.ts_prev;s.ts_next=null;nv=voice_tb.length;for(v=0;v<nv;v++){if(voice_tb[v].sym&&voice_tb[v].sym.time<=tsnext.time){for(s=tsnext.ts_prev;s;s=s.ts_prev){if(s.v==v){voice_tb[v].s_next=s.next;s.next=null;check_bar(s);break}}if(s)continue}voice_tb[v].s_next=voice_tb[v].sym;voice_tb[v].sym=null}}function set_sym_glue(width){var space,beta0,alfa,beta,min,g,spafac;var some_grace,s=tsfirst,xmin=0,x=0,xmax=0;while(1){if(s.type==GRACE)some_grace=true;if(s.seqst){space=s.space;xmin+=s.shrink;if(space<s.shrink)space=s.shrink;x+=space}if(!s.ts_next)break;s=s.ts_next}xmax=x;if(cfmt.stretchstaff)xmax*=1.8;beta0=1;if(tsnext){if(x>=width){beta_last=0}else{beta_last=(width-x)/(xmax-x);if(beta_last>beta0){if(cfmt.stretchstaff){if(cfmt.linewarn){error(0,s,"Line underfull ("+(beta0*xmax+(1-beta0)*x).toFixed(2)+"pt of "+width.toFixed(2)+"pt)")}}else{width=x;beta_last=0}}}}else{if(x<width){beta=(width-x)/(xmax-x);if(beta>=beta_last){beta=beta_last*xmax+(1-beta_last)*x;if(beta<width*(1-cfmt.stretchlast))width=beta}}}spafac=width/x;x=xmax=0;s=tsfirst;while(1){if(s.seqst){space=s.shrink;if(s.space!=0){if(space<s.space*spafac)space=s.space*spafac;xmax+=s.space*spafac*1.8}x+=space;xmax+=space;s.x=x;s.xmax=xmax}if(!s.ts_next)break;s=s.ts_next}switch(s.type){case BAR:break;case FORMAT:break;case CUSTOS:x+=s.wr;xmin+=s.wr;xmax+=s.wr;break;default:min=s.wr;while(!s.seqst){s=s.ts_prev;if(s.wr>min)min=s.wr}xmin+=min+3;if(tsnext&&tsnext.space*.8>s.wr+4){x+=tsnext.space*.8*spafac;xmax+=tsnext.space*.8*spafac*1.8}else{x+=min+4;xmax+=min+4}break}if(x>=width){beta=0;if(x==xmin){alfa=1}else{alfa=(x-width)/(x-xmin);if(alfa>1){error(0,s,"Line too much shrunk "+xmin.toFixed(2)+" "+x.toFixed(2)+" "+width.toFixed(2))}}realwidth=xmin*alfa+x*(1-alfa)}else{alfa=0;if(xmax>x)beta=(width-x)/(xmax-x);else beta=1;if(beta>beta0){if(!cfmt.stretchstaff)beta=0}realwidth=xmax*beta+x*(1-beta)}s=tsfirst;if(alfa!=0){if(alfa<1){x=xmin=0;for(;s;s=s.ts_next){if(s.seqst){xmin+=s.shrink*alfa;x=xmin+s.x*(1-alfa)}s.x=x}}else{alfa=realwidth/x;x=0;for(;s;s=s.ts_next){if(s.seqst)x=s.x*alfa;s.x=x}}}else{x=0;for(;s;s=s.ts_next){if(s.seqst)x=s.xmax*beta+s.x*(1-beta);s.x=x}}if(some_grace){for(s=tsfirst;s;s=s.ts_next){if(s.type!=GRACE)continue;x=s.x-s.wl+Number(cfmt.gracespace[0]);for(g=s.extra;g;g=g.next)if(g.type==NOTE)g.x+=x}}}function new_music_line(){var p_voice,s,v,nv=voice_tb.length;for(v=0;v<nv;v++){p_voice=voice_tb[v];s=p_voice.s_next;p_voice.sym=s;if(s)s.prev=null}}function gen_init(){for(var s=tsfirst;s;s=s.ts_next){if(s.new_sy){s.new_sy=false;cur_sy=cur_sy.next}switch(s.type){case CLEF:case KEY:case METER:continue;case FORMAT:if(!s.extra){unlksym(s);if(!tsfirst)return}break}return}tsfirst=null}function output_music(){var output_sav,v,lwidth,indent,line_height;if(user.get_abcmodel)user.get_abcmodel(tsfirst,voice_tb,anno_type,info);if(!user.img_out)return;gen_init();if(!tsfirst)return;set_global();if(voice_tb.length>1){combine_voices();set_stem_dir()}for(v=0;v<voice_tb.length;v++)set_beams(voice_tb[v].sym);set_stems();if(voice_tb.length>1){set_rest_offset();set_overlap()}set_acc_shft();set_allsymwidth(null);indent=set_indent();if(cfmt.singleline){lwidth=get_ck_width()+get_width(tsfirst,null,indent);cfmt.pagewidth=(lwidth+cfmt.leftmargin+cfmt.rightmargin)*cfmt.scale}else{lwidth=(cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/cfmt.scale;if(lwidth<50){error(1,null,"Bad page width "+lwidth);lwidth=10*CM}cut_tune(lwidth,indent)}beta_last=0;while(1){set_piece();indent=set_indent();set_sym_glue(lwidth-indent);if(indent!=0)posx+=indent;output_sav=output;output=undefined;draw_sym_near();output=output_sav;line_height=set_staff();delayed_update();draw_systems(indent);draw_all_sym();draw_all_deco();set_sscale(-1);vskip(line_height);if(indent!=0){posx-=indent;insert_meter&=~2}tsfirst=tsnext;if(!tsnext)break;gen_init();if(!tsfirst)break;blk_out();tsfirst.ts_prev=null;new_music_line()}}function reset_gen(){insert_meter=cfmt.writefields.indexOf("M")>=0?3:2}var gchord,a_dcn,multicol,maps;const not_ascii="Not an ASCII character";function new_clef(clef_def){var s={type:CLEF,ctx:parse.ctx,istart:parse.istart,iend:parse.iend,clef_line:2,clef_type:"t"},i=1;switch(clef_def[0]){case'"':i=clef_def.indexOf('"');s.clef_name=clef_def.slice(1,i);i++;break;case"a":if(clef_def[1]=="u"){s.clef_type="a";s.clef_auto=true;i=4;break}i=4;case"C":s.clef_type="c";s.clef_line=3;break;case"b":i=4;case"F":s.clef_type="b";s.clef_line=4;break;case"n":i=4;s.invisible=true;break;case"t":if(clef_def[1]=="e"){s.clef_type="c";s.clef_line=4;break}i=6;case"G":break;case"p":i=4;case"P":s.clef_type="p";s.clef_line=3;break;default:parse.line.error("unknown clef '"+clef_def+"'");delete s;return undefined}if(clef_def[i]>="1"&&clef_def[i]<="9"){s.clef_line=Number(clef_def[i]);i++}if(clef_def[i+1]!="8")return s;switch(clef_def[i]){case"^":s.clef_oct_transp=true;case"+":s.clef_octave=7;break;case"_":s.clef_oct_transp=true;case"-":s.clef_octave=-7;break;default:return s}return s}var pit_st=[0,2,4,5,7,9,11];function get_transp(param){var val,tmp,note,pit=[];if(param[0]=="0")return 0;if("123456789-+".indexOf(param[0])>=0){val=parseInt(param)*3;if(isNaN(val)||val<-108||val>108){parse.line.error("Bad %%transpose value");return}switch(param[param.length-1]){default:return val;case"#":val++;break;case"b":val+=2;break}if(val>0)return val;return val-3}tmp=new scanBuf;tmp.buffer=param;tmp.index=0;tmp.ctx=parse.ctx;for(i=0;i<2;i++){note=parse_acc_pit(tmp);if(!note){parse.line.error("Bad %%transpose value");return}note.pit+=126-2;val=Math.floor(note.pit/7)*12+pit_st[note.pit%7];if(note.acc&&note.acc!=3)val+=note.acc;pit[i]=val}val=(pit[1]-pit[0])*3;switch(note.acc){default:return val;case 2:case 1:val++;break;case-1:case-2:val+=2;break}if(val>0)return val;return val-3}function set_linebreak(param){var i,item;for(i=0;i<128;i++){if(char_tb[i]=="\n"){char_tb[i]=nil;break}}param=param.split(/\s+/);for(i=0;i<param.length;i++){item=param[i];switch(item){case"!":case"$":case"*":case";":case"?":case"@":break;case"<none>":continue;break;case"<EOL>":item="\n";break;default:parse.line.error("Bad value '"+item+"' in %%linebreak - ignored");continue}char_tb[item.charCodeAt(0)]="\n"}}function set_user(param){var j,k,val,c=param[0],c2="!",i=param.indexOf("!");if(i<0){i=param.indexOf('"');if(i<0){parse.line.error('Lack of starting ! or " in U:/%%user');return}c2='"'}j=param.indexOf(c2,i+1);if(j<0){parse.line.error("Lack of ending "+c2+" in U:/%%user");return}if(c=="\\"){c=param[1];if(c=="t")c="	"}k=c.charCodeAt(0);if(k>=128){parse.line.error(not_ascii);return}switch(char_tb[k][0]){case"0":case"d":case"i":case" ":break;case'"':case"!":if(char_tb[k].length>1)break;default:parse.line.error("Bad user character '"+c+"'");return}val=param.slice(i,j+1);switch(val){case"!beambreak!":val=" ";break;case"!ignore!":val="i";break;case"!nil!":case"!none!":val="d";break}char_tb[k]=val}function get_st_lines(param){var n,val;if(param[0]=="|"||param[0]==".")return param;n=parseInt(param);switch(n){case 0:return"...";case 1:return"..|";case 2:return".||";case 3:return"|||."}if(isNaN(n)||n<0||n>16)return undefined;val="|";while(--n>0)val+="|";return val}function new_block(subtype){if(parse.state==2)goto_tune();var s={type:BLOCK,subtype:subtype};curvoice=voice_tb[0];if(curvoice.last_sym)curvoice.last_sym.eoln=true;sym_link(s);return s}function do_pscom(text){var h1,val,s,cmd,param,n,k,lock=false;if(text.match(/ lock$/)){lock=true;text=text.slice(0,-5).trim()}cmd=text.match(/(\w|-)+/);if(!cmd)return;cmd=cmd[0];param=text.replace(cmd,"").trim();switch(cmd){case"break":return;case"center":if(parse.state>=2){s=new_block("center");s.text=cnv_escape(param);return}write_text(cnv_escape(param),"c");return;case"clef":if(parse.state>=2){if(parse.state==2)goto_tune();s=new_clef(param);if(s)get_clef(s)}return;case"clip":return;case"deco":deco_add(param);return;case"linebreak":set_linebreak(param);return;case"map":get_map(param);return;case"maxsysstaffsep":if(parse.state==3){par_sy.voices[curvoice.v].maxsep=get_unit(param);return}break;case"multicol":generate();switch(param){case"start":blk_out();multicol={posy:posy,maxy:posy,lmarg:cfmt.leftmargin,rmarg:cfmt.rightmargin,state:parse.state};break;case"new":if(!multicol){parse.line.error("%%multicol new without start");break}if(posy>multicol.maxy)multicol.maxy=posy;cfmt.leftmargin=multicol.lmarg;posx=cfmt.leftmargin/cfmt.scale;cfmt.rightmargin=multicol.rmarg;posy=multicol.posy;break;case"end":if(!multicol){parse.line.error("%%multicol end without start");break}cfmt.leftmargin=multicol.lmarg;posx=cfmt.leftmargin/cfmt.scale;cfmt.rightmargin=multicol.rmarg;if(posy<multicol.maxy)posy=multicol.maxy;multicol=undefined;blk_out();break;default:parse.line.error("Unknown keyword '"+param+"' in %%multicol");break}return;case"repbra":if(parse.state>=2){if(parse.state==2)goto_tune();curvoice.norepbra=!get_bool(param)}return;case"repeat":if(parse.state!=3){if(parse.state!=2)return;goto_tune()}if(!curvoice.last_sym){parse.line.error("%%repeat cannot start a tune");return}if(!param.length){n=1;k=1}else{var b=param.split(/\s+/);n=parseInt(b[0]);k=parseInt(b[1]);if(isNaN(n)||n<1||curvoice.last_sym.type==BAR&&n>2){parse.line.error("Incorrect 1st value in %%repeat");return}if(isNaN(k)){k=1}else{if(k<1){parse.line.error("Incorrect 2nd value in repeat");return}}}s={type:FORMAT,fmt_type:"repeat",repeat_k:k};if(curvoice.last_sym.type==BAR)s.repeat_n=n;else s.repeat_n=-n;sym_link(s);return;case"sep":lwidth=cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin;var h2,len;h1=h2=len=0;if(param){var values=param.split(/\s+/);h1=get_unit(values[0]);if(values[1]){h2=get_unit(values[1]);if(values[2])len=get_unit(values[2])}}if(h1<1)h1=14;if(h2<1)h2=h1;if(len<1)len=90;if(parse.state>=2){s=new_block("sep");s.x=(lwidth-len)/2/cfmt.scale;s.l=len/cfmt.scale;s.sk1=h1;s.sk2=h2;return}vskip(h1);output.push('<path class="stroke"\n	d="M');out_sxsy((lwidth-len)/2/cfmt.scale," ",0);output.push("h"+(len/cfmt.scale).toFixed(2)+'"/>\n');vskip(h2);blk_out();return;case"setbarnb":val=parseInt(param);if(isNaN(val)){parse.line.error("Bad %%setbarnb value");return}if(parse.state>=2)glovar.new_nbar=val;else cfmt.measurefirst=val;return;case"staff":if(parse.state!=3){if(parse.state!=2)return;goto_tune()}val=parseInt(param);if(isNaN(val)){parse.line.error("Bad %%staff value '"+param+"'");return}var st;if(param[0]=="+"||param[0]=="-")st=curvoice.cst+val;else st=val-1;if(st<0||st>nstaff){parse.line.error("Bad %%staff number "+st+" cur "+curvoice.cst+" max "+nstaff);return}delete curvoice.floating;curvoice.cst=st;return;case"staffbreak":if(parse.state!=3){if(parse.state!=2)return;goto_tune()}s={type:STBRK};if(param[0]>="0"&&param[0]<="9"){s.xmx=get_unit(param);if(param[param.length-1]=="f")s.stbrk_forced=true}else{s.xmx=14;if(param[0]=="f")s.stbrk_forced=true}sym_link(s);return;case"stafflines":val=get_st_lines(param);if(!val){parse.line.error("Bad %%stafflines value");return}if(!curvoice){glovar.stafflines=val;return}curvoice.stafflines=val;return;case"staffscale":val=parseFloat(param);if(isNaN(val)||val<.3||val>2){parse.line.error("Bad %%staffscale value");return}if(!curvoice){glovar.staffscale=val;return}curvoice.staffscale=val;return;case"staves":case"score":if(parse.state==0)return;get_staves(cmd,param);return;case"sysstaffsep":if(parse.state==3){par_sy.voices[curvoice.v].sep=get_unit(param);return}break;case"text":if(parse.state>=2){s=new_block("text");s.text=cnv_escape(param);s.opt=cfmt.textoption;return}write_text(cnv_escape(param),cfmt.textoption);return;case"transpose":if(parse.state==2)goto_tune();val=get_transp(param);if(!curvoice){if(parse.state==0)cfmt.transpose=val;else cfmt.transpose+=val;return}if(curvoice.ckey.k_bagpipe||curvoice.ckey.k_drum)return;curvoice.transpose=val+cfmt.transpose;s=curvoice.sym;if(!s){curvoice.key=clone(curvoice.okey);key_transp(curvoice.key,curvoice.transpose);curvoice.ckey=clone(curvoice.key);if(curvoice.key.k_none)curvoice.key.k_sf=0;return}for(;;){if(s.type==KEY)break;if(s.time==curvoice.time){s=s.prev;if(s)continue}s=sym_add(curvoice);s.type=KEY;s.k_old_sf=curvoice.key.k_sf;break}s.k_sf=curvoice.okey.k_sf;if(curvoice.okey.k_none)s.k_none=curvoice.okey.k_none;if(curvoice.okey.k_a_acc)s.k_a_acc=curvoice.okey.k_a_acc;key_transp(s,curvoice.transpose);curvoice.ckey=clone(s);if(curvoice.key.k_none)s.k_sf=0;return;case"tune":return;case"user":set_user(param);return;case"voicecolor":if(parse.state<2)return;if(parse.state==2)goto_tune();s={type:FORMAT,fmt_type:"voicecolor"};if(param!="#000000"&&param!="black")s.color=param;sym_link(s);return;case"vskip":val=get_unit(param);if(val<0){parse.line.error("%%vskip cannot be negative");return}if(parse.state>=2){s=new_block("vskip");s.sk=val;return}vskip(val);blk_out();return;case"newpage":case"leftmargin":case"rightmargin":case"scale":if(parse.state==2)goto_tune();if(parse.state==3){generate();blk_out()}if(cmd=="newpage"){block.newpage=true;return}set_format(cmd,param,lock);posx=cfmt.leftmargin/cfmt.scale;return}set_format(cmd,param,lock)}function do_begin_end(type,opt,text){var i,j,action,s;switch(type){default:case"ps":if(wpsobj){wpsobj.parse(text);output.push(svgbuf)}break;case"js":eval(text);break;case"ml":if(parse.state>=2){s=new_block("ml");s.text=text}else{svg_flush();user.img_out(text)}break;case"svg":j=0;while(1){i=text.indexOf('<style type="text/css">\n',j);if(i>=0){j=text.indexOf("</style>",i);if(j<0){parse.line.error("No </style> in %%beginsvg sequence");break}style+=text.slice(i+23,j);continue}i=text.indexOf("<defs>",j);if(i>=0){j=text.indexOf("</defs>",i);if(j<0){parse.line.error("No </defs> in %%beginsvg sequence");break}defs_add(text.slice(i+6,j));continue}break}break;case"text":action=get_textopt(opt);if(parse.state>=2){s=new_block("text");s.text=text;s.opt=get_textopt(opt);break}write_text(text,action);break}}function next_word(param,i){while(param[i]&&param[i]!=" ")i++;while(param[i]==" ")i++;return i}function parse_kv_args(a){var s,item,voice_param=curvoice;if(!voice_param)voice_param=parse.voice_param={};while(1){item=a.shift();if(!item)break;switch(item){case"clef=":s=new_clef(a.shift());break;case"octave=":voice_param.octave=Number(a.shift());break;case"map=":voice_param.map=a.shift();break;case"cue=":voice_param.scale=a.shift()=="on"?.7:1;break;case"stafflines=":item=get_st_lines(a.shift());if(!item){parse.line.error("Bad stafflines= value");break}voice_param.stafflines=item;break;default:switch(item.slice(0,4)){case"treb":case"bass":case"alto":case"teno":case"perc":s=new_clef(item);break;default:if("GFC".indexOf(item[0])>=0)s=new_clef(item);else if(item[item.length-1]=="=")a.shift();break}break}}return s}function new_key(param){var i,clef,key_end,c,tmp,s={type:KEY,ctx:parse.ctx,istart:parse.istart,iend:parse.iend,k_delta:0};if(!param.length)return[s,null];i=1;switch(param[0]){case"A":s.k_sf=3;break;case"B":s.k_sf=5;break;case"C":s.k_sf=0;break;case"D":s.k_sf=2;break;case"E":s.k_sf=4;break;case"F":s.k_sf=-1;break;case"G":s.k_sf=1;break;case"H":switch(param[1]){case"P":s.k_bagpipe="P";i++;break;case"p":s.k_bagpipe="p";s.k_sf=2;i++;break;default:parse.line.error("Unknown bagpipe-like key");break}key_end=true;break;case"P":s.k_drum=true;key_end=true;break;case"n":if(param.slice(0,4)=="none"){s.k_sf=0;s.k_none=true;i=4}default:key_end=true;break}if(!key_end){switch(param[i]){case"#":s.k_sf+=7;i++;break;case"b":s.k_sf-=7;i++;break}param=param.slice(i).trim();switch(param.slice(0,3).toLowerCase()){case"aeo":case"m":case"min":s.k_sf-=3;break;case"dor":s.k_sf-=2;break;case"ion":case"maj":break;case"loc":s.k_sf-=5;break;case"lyd":s.k_sf+=1;break;case"mix":s.k_sf-=1;break;case"phr":s.k_sf-=4;break;default:if(param[0]=="m"&&(param[1]==" "||param[1]=="	"||param[1]=="\n")){s.k_sf-=3;break}key_end=true;break}if(!key_end)param=param.replace(/\w+\s*/,"");if(param.slice(0,4)=="exp "){param=param.replace(/\w+\s*/,"");if(!param)parse.line.error("no accidental after 'exp'");s.k_exp=true}c=param[0];if(c=="^"||c=="_"||c=="="){s.k_a_acc=[];tmp=new scanBuf;tmp.buffer=param;tmp.index=0;tmp.ctx=parse.ctx;do{var note=parse_acc_pit(tmp);if(!note)return[s,null];var acc={pit:note.pit,acc:note.acc};s.k_a_acc.push(acc);c=tmp.char();while(c==" ")c=tmp.next_char()}while(c=="^"||c=="_"||c=="=");param=param.slice(tmp.index)}else if(s.k_exp&&param.slice(0,4)=="none"){s.k_sf=0;param=param.replace(/\w+\s*/,"")}}s.k_delta=(cgd2cde[(s.k_sf+7)%7]+14)%7;if(!param)return[s,null];return[s,parse_kv_args(info_split(param,0))]}function get_map(text){if(!text)return;var i,note,notes,map,tmp,ns,a=info_split(text,2);if(a.length<3){parse.line.error("Not enough parameters");return}ns=a[1];if(ns.slice(0,7)=="octave,"||ns.slice(0,4)=="key,"){ns=ns.replace(/[,']+$/m,"").toLowerCase();if(ns[0]=="k")ns=ns.replace(/[_=^]+/,"")}else if(ns[0]=="*"||ns.slice(0,3)=="all"){ns="all"}else{tmp=new scanBuf;tmp.buffer=a[1];tmp.index=0;tmp.ctx=parse.ctx;note=parse_acc_pit(tmp);if(!note){parse.line.error("Bad note in %%map");return}ns="abcdefg"[(note.pit+77)%7];if(note.acc)ns=["__","_","","^","^^","="][note.acc+2]+ns;for(i=note.pit;i>=28;i-=7)ns+="'";for(i=note.pit;i<21;i+=7)ns+=","}if(!maps)maps={};notes=maps[a[0]];if(!notes)maps[a[0]]=notes={};map=notes[ns];if(!map)notes[ns]=map=[];if(!a[2])return;i=2;if(a[2].indexOf("=")<0){if(a[2][0]!="*"){tmp=new scanBuf;tmp.buffer=a[2];tmp.index=0;tmp.ctx=parse.ctx;map[1]=parse_acc_pit(tmp)}if(!a[3])return;i++;if(a[3].indexOf("=")<0){map[0]=a[3].split(",");i++}}for(;i<a.length;i++){switch(a[i]){case"heads=":map[0]=a[++i].split(",");break;case"print=":tmp=new scanBuf;tmp.buffer=a[++i];tmp.index=0;tmp.ctx=parse.ctx;map[1]=parse_acc_pit(tmp);break;case"color=":map[2]=a[++i];break}}}function new_meter(text){var s={type:METER,ctx:parse.ctx,istart:parse.istart,iend:parse.iend,a_meter:[]},meter={},val,v,m1=0,m2,i=0,j,wmeasure,p=text,in_parenth;if(p.indexOf("none")==0){i=4;wmeasure=1}else{wmeasure=0;while(i<text.length){if(p[i]=="=")break;switch(p[i]){case"C":meter.top=p[i++];if(p[i]=="|")meter.top+=p[i++];m1=4;m2=4;break;case"c":case"o":if(p[i]=="c")m1=4;else m1=3;m2=4;meter.top=p[i++];if(p[i]==".")meter.top+=p[i++];break;case"(":if(p[i+1]=="("){in_parenth=true;meter.top=p[i++];s.a_meter.push(meter);meter={}}j=i+1;while(j<text.length){
if(p[j]==")"||p[j]=="/")break;j++}if(p[j]==")"&&p[j+1]=="/"){i++;continue}case")":in_parenth=p[i]=="(";meter.top=p[i++];s.a_meter.push(meter);meter={};continue;default:if(p[i]<="0"||p[i]>"9"){parse.line.error("Bad char '"+p[i]+"' in M:");return}m2=2;meter.top=p[i++];for(;;){while(p[i]>="0"&&p[i]<="9")meter.top+=p[i++];if(p[i]==")"){if(p[i+1]!="/")break;i++}if(p[i]=="/"){i++;if(p[i]<="0"||p[i]>"9"){parse.line.error("Bad char '"+p[i]+"' in M:");return}meter.bot=p[i++];while(p[i]>="0"&&p[i]<="9")meter.bot+=p[i++];break}if(p[i]!=" "&&p[i]!="+")break;if(i>=text.length||p[i+1]=="(")break;meter.top+=p[i++]}m1=parseInt(meter.top);break}if(!in_parenth){if(meter.bot)m2=parseInt(meter.bot);wmeasure+=m1*BASE_LEN/m2}s.a_meter.push(meter);meter={};while(p[i]==" ")i++;if(p[i]=="+"){meter.top=p[i++];s.a_meter.push(meter);meter={}}}}if(p[i]=="="){val=p.substring(++i);if(!val.match(/^(\d|\/)+$/)){parse.line.error("Bad duration '"+val+"' in M:");return}wmeasure=BASE_LEN*eval(val)}s.wmeasure=wmeasure;if(parse.state!=3){info.M=text;glovar.meter=s;if(parse.state>=1){if(!glovar.ulen){if(wmeasure<=1||wmeasure>=BASE_LEN*3/4)glovar.ulen=BASE_LEN/8;else glovar.ulen=BASE_LEN/16}for(v=0;v<voice_tb.length;v++){voice_tb[v].meter=s;voice_tb[v].wmeasure=wmeasure}}}else{curvoice.wmeasure=wmeasure;if(is_voice_sig()){curvoice.meter=s;reset_gen()}else{sym_link(s)}}}function new_tempo(text){if(cfmt.writefields.indexOf("Q")<0)return;var i=0,j,c,nd,tmp,s={type:TEMPO,ctx:parse.ctx,istart:parse.istrt,iend:parse.iend};if(text[0]=='"'){i=text.indexOf('"',1);if(i<0){parse.line.error("Unterminated string in Q:");return}s.tempo_str1=text.slice(1,i);i++;while(text[i]==" ")i++}tmp=new scanBuf;tmp.buffer=text;tmp.index=i;while(1){c=tmp.char();if(c==undefined||c<="0"||c>"9")break;nd=parse_dur(tmp);if(!s.tempo_notes)s.tempo_notes=[];s.tempo_notes.push(BASE_LEN*nd[0]/nd[1]);while(1){c=tmp.char();if(c!=" ")break;tmp.advance()}}if(c=="="){c=tmp.next_char();while(c==" ")c=tmp.next_char();s.tempo_value="";while(c&&c!='"'){s.tempo_value+=c;c=tmp.next_char()}s.tempo_value=s.tempo_value.replace(/\s+$/,"")}if(c=='"'){tmp.advance();i=text.indexOf('"',tmp.index+1);if(i<0){parse.line.error("Unterminated string in Q:");return}s.tempo_str2=text.slice(tmp.index,i)}if(parse.state!=3){if(parse.state==1){info.Q=text;glovar.tempo=s;return}goto_tune()}if(curvoice.v!=par_sy.top_voice)return;sym_link(s)}function do_info(info_type,text){switch(info_type){case"I":do_pscom(text);break;case"L":if(text.match(/^\d*\/\d*$/)){text=BASE_LEN*eval(text)}else if(text=="auto"){text=-1}else{parse.line.error("Bad L: value");break}if(parse.state==2)goto_tune();if(parse.state!=3)glovar.ulen=Number(text);else curvoice.ulen=Number(text);break;case"M":new_meter(text);break;case"U":set_user(text);break;case"P":if(parse.state==0)break;if(parse.state==1){info.P=text;break}if(parse.state==2)goto_tune();if(cfmt.writefields.indexOf("P")<0)break;var s={type:PART,ctx:parse.ctx,istart:parse.istart,iend:parse.iend,text:text};var p_voice=voice_tb[par_sy.top_voice];if(curvoice.v!=p_voice.v){if(curvoice.time!=p_voice.time)break;if(p_voice.last_sym&&p_voice.last_sym.type==PART)break;var curvoice_sav=curvoice;curvoice=p_voice;sym_link(s);curvoice=curvoice_sav}else{sym_link(s)}break;case"Q":if(parse.state==0)break;new_tempo(text);break;case"V":if(parse.state==0)break;if(parse.state==2)goto_tune();get_voice(text);if(!curvoice.last_sym&&parse.voice_opts)voice_filter();break;case"K":get_key_clef(new_key(text));break;case"k":parse.line.error("k: is obsolete - use %%map instead");get_map(text);break;case"N":case"R":if(!info[info_type])info[info_type]=text;else info[info_type]+="\n"+text;break;default:parse.line.error("'"+info_type+":' line ignored");break}}function adjust_dur(s){var s2,time,auto_time,i,res;s2=curvoice.last_sym;if(!s2)return;if(s2.type==MREST||s2.type==BAR)return;while(s2.type!=BAR&&s2.prev)s2=s2.prev;time=s2.time;auto_time=curvoice.time-time;if(time==0){while(s2&&!s2.dur)s2=s2.next;if(s2&&s2.type==REST&&s2.invisible){time+=s2.dur*curvoice.wmeasure/auto_time;if(s2.prev)s2.prev.next=s2.next;else curvoice.sym=s2.next;if(s2.next)s2.next.prev=s2.prev;s2=s2.next}}if(curvoice.wmeasure==auto_time)return;for(;s2;s2=s2.next){s2.time=time;if(!s2.dur||s2.grace)continue;s2.dur=s2.dur*curvoice.wmeasure/auto_time;s2.dur_orig=s2.dur_orig*curvoice.wmeasure/auto_time;time+=s2.dur;if(s2.type!=NOTE&&s2.type!=REST)continue;for(i=0;i<=s2.nhd;i++)s2.notes[i].dur=s2.notes[i].dur*curvoice.wmeasure/auto_time;res=identify_note(s2,s2.dur_orig);s2.head=res[0];s2.dots=res[1];s2.nflags=res[2];if(s2.nflags<=-2)s2.stemless=true;else delete s2.stemless}curvoice.time=s.time=time}function new_bar(){var line=parse.line,s={type:BAR,ctx:parse.ctx,multi:0},s2,c,bar_type;s.istart=parse.bol+line.index;if(vover&&vover.bar)get_vover("|");if(glovar.new_nbar){s.bar_num=glovar.new_nbar;delete glovar.new_nbar}bar_type=line.char();if(bar_type==":")s.rbstop=2;while(1){c=line.next_char();switch(c){case"|":case"[":case"]":case":":bar_type+=c;continue}break}if(gchord){gch_build(s);gchord=null}if(a_dcn){deco_cnv(a_dcn,s);a_dcn=null}if(c>"0"&&c<="9"){s.text=c;while(1){c=line.next_char();if("0123456789,.-".indexOf(c)<0)break;s.text+=c}s.rbstop=2;s.rbstart=2}else if(c=='"'&&bar_type=="["){s.text="";while(1){c=line.next_char();if(!c){line.error("No end of repeat string");return}if(c=='"'){line.advance();break}if(c=="\\")c=line.next_char();s.text+=c}s.text=cnv_escape(s.text);s.rbstop=2;s.rbstart=2}switch(bar_type[bar_type.length-1]){case"[":if(!s.rbstart){bar_type=bar_type.slice(0,-1);line.index--}break;case":":s.rbstop=2;break}if(bar_type[0]=="]"){s.rbstop=2;if(bar_type.length!=1)bar_type=bar_type.slice(1);else s.invisible=true}s.iend=parse.bol+line.index;if(s.rbstart&&curvoice.norepbra&&!curvoice.second)s.norepbra=true;if(curvoice.ulen<0)adjust_dur(s);s2=curvoice.last_sym;if(s2&&s2.type==BAR){if(bar_type=="["&&!s2.text&&!s2.a_gch&&(curvoice.st==0||par_sy.staves[curvoice.st-1].flags&STOP_BAR||s.norepbra)){if(s.text)s2.text=s.text;if(s.a_gch)s2.a_gch=s.a_gch;if(s.norepbra)s2.norepbra=s.norepbra;if(s.rbstart)s2.rbstart=s.rbstart;if(s.rbstop)s2.rbstop=s.rbstop;return}if(bar_type=="|:"&&!s.text&&s2.bar_type==":|"){s2.bar_type="::";s2.rbstop=2;return}}switch(bar_type){case"[":s.rbstop=2;case"[]":case"[|]":s.invisible=true;bar_type="[]";break;case":|:":case":||:":bar_type="::";break}s.bar_type=bar_type;if(!curvoice.lyric_restart)curvoice.lyric_restart=s;if(s2&&s2.type==KEY){curvoice.last_sym=s2.prev;if(!curvoice.last_sym)curvoice.sym=null;sym_link(s);s.next=s2;s2.prev=s;curvoice.last_sym=s2}else{sym_link(s)}s.st=curvoice.st;if(s.rbstart&&!curvoice.norepbra&&curvoice.st>0&&!(par_sy.staves[curvoice.st-1].flags&STOP_BAR)){s2={type:BAR,ctx:s.ctx,istart:s.istart,iend:s.iend,bar_type:"[",multi:0,invisible:true,text:s.text,rbstart:2};sym_link(s2);s2.st=curvoice.st;s.text=undefined;s.rbstart=0}}function parse_staves(param){var v,p_flags,a_flags=[],err=false,flags=0,brace=0,bracket=0,parenth=0,flags_st=0,p=param,i=0;while(i<p.length){switch(p[i]){case" ":case"	":break;case"[":if(parenth||brace+bracket>=2){parse.line.error("Misplaced '[' in %%staves");err=true;break}if(brace+bracket==0)flags|=OPEN_BRACKET;else flags|=OPEN_BRACKET2;bracket++;flags_st<<=8;flags_st|=OPEN_BRACKET;break;case"{":if(parenth||brace||bracket>=2){parse.line.error("Misplaced '{' in %%staves");err=true;break}if(bracket==0)flags|=OPEN_BRACE;else flags|=OPEN_BRACE2;brace++;flags_st<<=8;flags_st|=OPEN_BRACE;break;case"(":if(parenth){parse.line.error("Misplaced '(' in %%staves");err=true;break}flags|=OPEN_PARENTH;parenth++;flags_st<<=8;flags_st|=OPEN_PARENTH;break;case"*":if(brace&&!parenth&&!(flags&(OPEN_BRACE|OPEN_BRACE2)))flags|=FL_VOICE;break;case"+":flags|=MASTER_VOICE;break;default:if(!p[i].match(/\w/)){parse.line.error("Bad voice ID in %%staves");err=true;break}var voice_id="";while(i<p.length){if(" 	()[]{}|*".indexOf(p[i])>=0)break;voice_id+=p[i++]}p_flags={v:new_voice(voice_id).v};for(;i<p.length;i++){switch(p[i]){case" ":case"	":continue;case"]":if(!(flags_st&OPEN_BRACKET)){parse.line.error("Misplaced ']' in %%staves");err=true;break}bracket--;if(brace+bracket==0)flags|=CLOSE_BRACKET;else flags|=CLOSE_BRACKET2;flags_st>>=8;continue;case"}":if(!(flags_st&OPEN_BRACE)){parse.line.error("Misplaced '}' in %%staves");err=true;break}brace--;if(bracket==0)flags|=CLOSE_BRACE;else flags|=CLOSE_BRACE2;flags&=~FL_VOICE;flags_st>>=8;continue;case")":if(!(flags_st&OPEN_PARENTH)){parse.line.error("Misplaced ')' in %%staves");err=true;break}parenth--;flags|=CLOSE_PARENTH;flags_st>>=8;continue;case"|":flags|=STOP_BAR;continue}break}p_flags.flags=flags;a_flags.push(p_flags);flags=0;continue}i++}if(flags_st!=0){parse.line.error("'}', ')' or ']' missing in %%staves");err=true}if(err)a_flags=null;return a_flags}function info_split(text,start){var a=[],item="",i,j,n=text.length;for(i=0;i<n;i++){switch(text[i]){case"=":if(!item){item="=";break}item+="=";if(a.length<start)break;a.push(item);item="";break;case" ":case"	":if(!item)break;a.push(item);item="";break;case'"':if(item){a.push(item);item=""}j=++i;while(i<n){if(text[i]=='"')break;if(text[i]=="\\")i++;i++}if(text[i]!='"'){parse.line.error("Unterminated string");break}a.push(text.slice(j,i));break;case"\\":item+=text[i++];default:item+=text[i];break}}if(item)a.push(item);return a}function parse_voice(param){var v,a=info_split(param,1),item=a.shift();curvoice=new_voice(item);if(curvoice.time==undefined){curvoice.time=0;if(parse.state==3&&staves_found<0){v=curvoice.v;curvoice.st=curvoice.cst=++nstaff;par_sy.nstaff=nstaff;par_sy.voices[v].st=nstaff;par_sy.voices[v].range=v;par_sy.staves[nstaff]={stafflines:"|||||",staffscale:1}}}for(var i=0;i<a.length;i++){switch(a[i]){case"name=":case"nm=":curvoice.nm=a[++i];curvoice.new_name=true;break;case"subname=":case"sname=":case"snm=":curvoice.snm=a[++i];break;case"stem=":set_pos("stem",a[++i]);break;default:if(a[i][a[i].length-1]=="=")i++;break}}return parse_kv_args(a)}function identify_note(s,dur){var head,dots,flags;if(dur%12!=0)parse.line.error("Invalid note duration "+dur);dur/=12;if(dur==0)parse.line.error("Note too short");for(flags=5;dur!=0;dur>>=1,flags--){if(dur&1)break}dur>>=1;switch(dur){case 0:dots=0;break;case 1:dots=1;break;case 3:dots=2;break;case 7:dots=3;break;default:dots=3;break}flags-=dots;if(flags>=0){head="full"}else switch(flags){default:parse.line.error("Note too long");flags=-4;case-4:head="square";break;case-3:head=cfmt.squarebreve?"square":"oval";break;case-2:head="oval";break;case-1:head="empty";break}return[head,dots,flags]}function parse_dur(line){var num,den;c=line.char();if(c>"0"&&c<="9"){num=line.get_int();c=line.char()}else{num=1}if(c=="/"){den=2;c=line.next_char();if(c=="/"){do{den*=2;c=line.next_char()}while(c=="/")}else if(c>"0"&&c<="9"){den=line.get_int()}}else{den=1}return[num,den]}function parse_acc_pit(line){var acc,micro_n,micro_d,pit,c=line.char();switch(c){case"^":c=line.next_char();if(c=="^"){acc=2;c=line.next_char()}else{acc=1}break;case"=":acc=3;c=line.next_char();break;case"_":c=line.next_char();if(c=="_"){acc=-2;c=line.next_char()}else{acc=-1}break}if(acc&&(c>="1"&&c<="9")||c=="/"){nd=parse_dur(line);micro_n=nd[0];micro_d=nd[1];if(micro_d==1)micro_d=curvoice.microscale;else micro_d*=2;c=line.char()}pit="CDEFGABcdefgab".indexOf(c)+16;c=line.next_char();if(pit<16){line.error("'"+line.buffer[line.index-1]+"' is not a note");return undefined}while(c=="'"){pit+=7;c=line.next_char()}while(c==","){pit-=7;c=line.next_char()}note={pit:pit,apit:pit,shhd:0,shac:0,ti1:0};if(acc){note.acc=acc;if(micro_n){note.micro_n=micro_n;note.micro_d=micro_d}}return note}function set_map(note){var bn,an,nn,i,map=maps[curvoice.map];bn="abcdefg"[(note.pit+77)%7];if(note.acc)an=["__","_","","^","^^","="][note.acc+2];else an="";nn=an+bn;for(i=note.pit;i>=28;i-=7)nn+="'";for(i=note.pit;i<21;i+=7)nn+=",";if(map[nn]){note.map=map[nn];if(note.map[1]){note.apit=note.pit=note.map[1].pit;note.acc=note.map[1].acc}}else{nn="octave,"+an+bn;if(!map[nn]){nn="key,"+an+"abcdefg"[(note.pit+77-curvoice.ckey.k_delta)%7];if(!map[nn]){nn="all";if(!map[nn])return}}note.map=map[nn]}}function parse_basic_note(line,ulen){var nd,c,note=parse_acc_pit(line);if(!note)return null;if(line.char()=="0"){parse.stemless=true;line.advance()}nd=parse_dur(line);note.dur=ulen*nd[0]/nd[1];return note}function parse_vpos(){var c,line=parse.line,ti1=0;if(line.buffer[line.index-1]=="."&&!a_dcn)ti1=SL_DOTTED;c=line.next_char();if(c=="'"){ti1+=SL_ABOVE;line.index++}else if(c==","){ti1+=SL_BELOW;line.index++}else{ti1+=SL_AUTO}return ti1}function sort_pitch(s){function pitch_compare(n1,n2){return n1.pit-n2.pit}s.notes=s.notes.sort(pitch_compare)}function new_note(grace,tuplet_fact){var note,s,in_chord,c,dcn,i,n,s2,nd,res,num,dur,sl1=0,line=parse.line,a_dcn_sav=a_dcn;a_dcn=undefined;parse.stemless=false;s={type:NOTE,ctx:parse.ctx,stem:0,multi:0,nhd:0,xmx:0};s.istart=parse.bol+line.index;if(grace){s.grace=true}else{if(gchord){gch_build(s);gchord=undefined}}c=line.char();switch(c){case"X":s.invisible=true;case"Z":s.type=MREST;c=line.next_char();if(c>"0"&&c<="9")s.nmes=line.get_int();else s.nmes=1;s.dur=curvoice.wmeasure*s.nmes;if(curvoice.second){curvoice.time+=s.dur;return null}break;case"y":s.type=SPACE;s.invisible=true;c=line.next_char();if(c>="0"&&c<="9")s.width=line.get_int();else s.width=10;break;case"x":s.invisible=true;case"z":s.type=REST;line.advance();nd=parse_dur(line);s.dur=s.dur_orig=(curvoice.ulen<0?BASE_LEN/4:curvoice.ulen)*nd[0]/nd[1];s.notes=[{pit:18,dur:s.dur}];break;case"[":in_chord=true;c=line.next_char();default:if(curvoice.microscale)s.microscale=curvoice.microscale;s.notes=[];while(1){if(in_chord){while(1){if(!c)break;i=c.charCodeAt(0);if(i>=128){line.error(not_ascii);return null}type=char_tb[i];switch(type[0]){case"(":sl1<<=4;sl1+=parse_vpos();c=line.char();continue;case"!":if(!a_dcn)a_dcn=[];if(type.length>1){a_dcn.push(type.slice(1,-1))}else{dcn="";while(1){c=line.next_char();if(c=="!")break;dcn+=c}a_dcn.push(dcn)}c=line.next_char();continue}break}}note=parse_basic_note(line,s.grace||curvoice.ulen<0?BASE_LEN/4:curvoice.ulen);if(!note)return null;if(curvoice.octave)note.apit=note.pit+=curvoice.octave*7;if(sl1){note.sl1=sl1;if(s.sl1)s.sl1++;else s.sl1=1;sl1=0}if(a_dcn){note.a_dcn=a_dcn;a_dcn=null}s.notes.push(note);if(!in_chord)break;c=line.char();while(1){switch(c){case")":if(note.sl2)note.sl2++;else note.sl2=1;if(s.sl2)s.sl2++;else s.sl2=1;c=line.next_char();continue;case"-":note.ti1=parse_vpos();s.ti1=true;c=line.char();continue;case".":c=line.next_char();if(c!="-"){line.error("Misplaced dot");break}continue}break}if(c=="]"){line.advance();nd=parse_dur(line);s.nhd=s.notes.length-1;for(i=0;i<=s.nhd;i++){note=s.notes[i];note.dur=note.dur*nd[0]/nd[1]}break}}s.dur=s.dur_orig=s.notes[0].dur}if(s.grace&&s.type!=NOTE){line.error("Not a note in grace note sequence");return null}if(s.notes){if(s.type==NOTE&&curvoice.transpose)note_transp(s);if(!s.grace){switch(curvoice.pos.ste){case SL_ABOVE:s.stem=1;break;case SL_BELOW:s.stem=-1;break}s.combine=curvoice.combine;if(tuplet_fact)s.dur*=tuplet_fact;num=curvoice.brk_rhythm;if(num){s2=curvoice.last_note;if(num>0){n=num*2-1;s.dur=s.dur*n/num;s.dur_orig=s.dur_orig*n/num;for(i=0;i<=s.nhd;i++)s.notes[i].dur=s.notes[i].dur*n/num;s2.dur/=num;s2.dur_orig/=num;for(i=0;i<=s2.nhd;i++)s2.notes[i].dur/=num}else{num=-num;n=num*2-1;s.dur/=num;s.dur_orig/=num;for(i=0;i<=s.nhd;i++)s.notes[i].dur/=num;s2.dur=s2.dur*n/num;s2.dur_orig=s2.dur_orig*n/num;for(i=0;i<=s2.nhd;i++)s2.notes[i].dur=s2.notes[i].dur*n/num}curvoice.time=s2.time+s2.dur;res=identify_note(s2,s2.dur_orig);s2.head=res[0];s2.dots=res[1];s2.nflags=res[2];curvoice.brk_rhythm=0;if(s2.nflags<=-2)s2.stemless=true;else delete s2.stemless}}else{var div=curvoice.key.k_bagpipe?8:4;for(i=0;i<=s.nhd;i++)s.notes[i].dur/=div;s.dur/=div;s.dur_orig/=div;switch(curvoice.pos.gst){case SL_ABOVE:s.stem=1;break;case SL_BELOW:s.stem=-1;break;case SL_HIDDEN:s.stem=2;break}}if(s.type==NOTE){res=identify_note(s,s.dur_orig);s.head=res[0];s.dots=res[1];s.nflags=res[2];if(s.xstem)s.nflags=0;if(s.nflags<=-2)s.stemless=true;if(curvoice.map&&maps[curvoice.map]){for(i=0;i<=s.nhd;i++)set_map(s.notes[i])}}else{dur=s.dur_orig;if(dur==curvoice.wmeasure){if(dur<BASE_LEN*2)dur=BASE_LEN;else if(dur<BASE_LEN*4)dur=BASE_LEN*2;else dur=BASE_LEN*4}res=identify_note(s,dur);s.head=res[0];s.dots=res[1];s.nflags=res[2]}curvoice.last_note=s}sym_link(s);if(cfmt.shiftunison)s.shiftunison=cfmt.shiftunison;if(!curvoice.lyric_restart)curvoice.lyric_restart=s;if(a_dcn_sav)deco_cnv(a_dcn_sav,s,s.prev);if(parse.stemless)s.stemless=true;s.iend=parse.bol+line.index;return s}var nil="0";var char_tb=[nil,nil,nil,nil,nil,nil,nil,nil,nil," ","\n",nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil," ","!",'"',nil,"\n",nil,"&",nil,"(",")",nil,nil,nil,"-","!dot!",nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,"|",nil,"<","n","<",nil,nil,"n","n","n","n","n","n","n","!fermata!","d","d","d","!emphasis!","!lowermordent!","d","!coda!","!uppermordent!","d","d","!segno!","!trill!","d","d","d","n","d","n","[","\\","|","n","n","i","n","n","n","n","n","n","n","d","d","d","d","d","d","d","d","d","d","d","d","d","!upbow!","!downbow!","d","n","n","n","{","|","}","!roll!",nil];function parse_music_line(){var slur_start=0,s,grace,sappo,dcn,i,c,idx,type,last_note_sav,a_dcn_sav,s_tuplet,s_tuplet_up,tuplet_fact=1,tuplet_fact_up;var line=parse.line;line.buffer=parse.file.slice(parse.bol,parse.eol);line.index=0;while(1){c=line.char();if(!c||c=="%")break;if(c=="."){switch(line.buffer[line.index+1]){case"(":case"-":case"|":c=line.next_char();break}}idx=c.charCodeAt(0);if(idx>=128){line.error(not_ascii);line.advance();continue}type=char_tb[idx];switch(type[0]){case" ":if(curvoice.last_note)curvoice.last_note.beam_end=true;break;case"\n":if(cfmt.barsperstaff)break;if(par_sy.voices[curvoice.v].range==0&&curvoice.last_sym)curvoice.last_sym.eoln=true;break;case"&":c=line.next_char();if(c==")"){get_vover(")");break}get_vover("&");continue;case"(":c=line.next_char();if(c>"0"&&c<="9"){var pplet=line.get_int(),qplet=[0,1,3,2,3,0,2,0,3,0][pplet],rplet=pplet,c=line.char();if(c==":"){c=line.next_char();if(c>"0"&&c<="9"){qplet=line.get_int();c=line.char()}if(c==":"){c=line.next_char();if(c>"0"&&c<="9"){rplet=line.get_int();c=line.char()}else{line.error("Invalid 'r' in tuplet");continue}}}else{if(qplet==0)qplet=curvoice.wmeasure%9==0?3:2}s={type:TUPLET,tuplet_p:pplet,tuplet_q:qplet,tuplet_r:rplet,tuplet_n:rplet,tuplet_f:clone(cfmt.tuplets)};sym_link(s);s_tuplet_up=s_tuplet;tuplet_fact_up=tuplet_fact;s_tuplet=s;tuplet_fact*=qplet/pplet;continue}if(c=="&"){get_vover("(");break}slur_start<<=4;line.index--;slur_start+=parse_vpos();continue;case")":if(curvoice.ignore)break;s=curvoice.last_sym;if(s){switch(s.type){case NOTE:case REST:case SPACE:break;default:s=null;break}}if(!s){line.error("Bad character ')'");break}if(s.slur_end)s.slur_end++;else s.slur_end=1;break;case"!":if(!a_dcn)a_dcn=[];if(type.length>1){a_dcn.push(type.slice(1,-1));break}dcn="";i=line.index;while(1){c=line.next_char();if(!c)break;if(c=="!")break;dcn+=c}if(!c){line.index=i;line.error("No end of decoration");break}a_dcn.push(dcn);break;case'"':parse_gchord(type);break;case"-":var tie_pos=0;if(!curvoice.last_note||curvoice.last_note.type!=NOTE){line.error("No note before '-'");break}tie_pos=parse_vpos();s=curvoice.last_note;for(i=0;i<=s.nhd;i++){if(!s.notes[i].ti1)s.notes[i].ti1=tie_pos;else if(s.nhd==0)line.error("Too many ties")}s.ti1=true;continue;case"[":var c_next=line.buffer[line.index+1];if('|[]: "'.indexOf(c_next)>=0||c_next>="1"&&c_next<="9"){if(grace){line.error("Cannot have a bar in grace notes");break}new_bar();continue}if(line.buffer[line.index+2]==":"){parse.istart=parse.bol+line.index;line.index++;i=line.buffer.indexOf("]",line.index);if(i<0){line.error("Lack of ']'");break}var text=line.buffer.slice(line.index+2,i).trim();line.index=i+1;parse.iend=parse.bol+line.index;var err=do_info(c_next,text);if(err)line.error(err);continue}case"n":s=new_note(grace,tuplet_fact);if(!s)continue;if(s.type==NOTE){s.slur_start=slur_start;slur_start=0;if(sappo){s.sappo=true;sappo=false}}if(grace){if(s_tuplet)s.in_tuplet=true}else if(s_tuplet&&s.notes){s.in_tuplet=true;s_tuplet.tuplet_n--;if(s_tuplet_up)s_tuplet_up.tuplet_n--;if(s_tuplet.tuplet_n==0){s_tuplet=s_tuplet_up;tuplet_fact=tuplet_fact_up;if(s_tuplet){s_tuplet_up=null;tuplet_fact_up=1;if(s_tuplet.tuplet_n==0){s_tuplet=null;tuplet_fact=1;curvoice.time=Math.round(curvoice.time);s.dur=curvoice.time-s.time}}else{curvoice.time=Math.round(curvoice.time);s.dur=curvoice.time-s.time}}}continue;case"<":if(!curvoice.last_note){line.error("No note before '"+c+"'");break}var n=c=="<"?1:-1;while(c=="<"||c==">"){n*=2;c=line.next_char()}curvoice.brk_rhythm=n;continue;case"d":line.error("Bad character '"+c+"'");break;case"i":break;case"{":if(grace){line.error("'{' in grace note");break}last_note_sav=curvoice.last_note;curvoice.last_note=null;a_dcn_sav=a_dcn;a_dcn=undefined;grace=true;c=line.next_char();if(c=="/"){sappo=true;break}continue;case"|":c=line.buffer[line.index-1];new_bar();if(c==".")curvoice.last_sym.bar_dotted=true;continue;case"}":s=curvoice.last_note;if(!grace||!s){line.error("Bad character '}'");break}s.gr_end=true;grace=false;if((!s.prev||!s.prev.grace)&&!curvoice.key.k_bagpipe){for(i=0;i<=s.nhd;i++)s.notes[i].dur*=2;s.dur*=2;s.dur_orig*=2;var res=identify_note(s,s.dur_orig);s.head=res[0];s.dots=res[1];s.nflags=res[2]}curvoice.last_note=last_note_sav;a_dcn=a_dcn_sav;break;case"\\":if(line.index==line.buffer.length-1)return;for(i=line.index+1;;i++){c=line.buffer[i];if(!c||c=="%")return;if(c!=" "&&c!="	")break}default:line.error("Bad character '"+c+"'");break}line.advance()}if(cfmt.breakoneoln&&curvoice.last_note)curvoice.last_note.beam_end=true;if(cfmt.barsperstaff)return;if(char_tb["\n".charCodeAt(0)]=="\n"&&par_sy.voices[curvoice.v].range==0&&curvoice.last_sym)curvoice.last_sym.eoln=true}var cw_tb=[.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.25,.333,.408,.5,.5,.833,.778,.333,.333,.333,.5,.564,.25,.564,.25,.278,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.278,.278,.564,.564,.564,.444,.921,.722,.667,.667,.722,.611,.556,.722,.722,.333,.389,.722,.611,.889,.722,.722,.556,.722,.667,.556,.611,.722,.722,.944,.722,.722,.611,.333,.278,.333,.469,.5,.333,.444,.5,.444,.5,.444,.333,.5,.5,.278,.278,.5,.278,.778,.5,.5,.5,.5,.333,.389,.278,.5,.5,.722,.5,.5,.444,.48,.2,.48,.541,.5];function cwid(c){var i=c.charCodeAt(0);if(i>=128)i=97;return cw_tb[i]}function strw(str){var swfac=gene.curfont.swfac,w=0,i,j,c,n=str.length;for(i=0;i<n;i++){c=str[i];switch(c){case"$":c=str[i+1];if(c=="0"){gene.curfont=gene.deffont}else if(c>="1"&&c<="9"){gene.curfont=get_font("u"+c)}else{w+=cwid("$")*swfac;break}i++;swfac=gene.curfont.swfac;continue;case"&":j=str.indexOf(";",i);if(j>0&&j-i<10){i=j;c="a"}break}w+=cwid(c)*swfac}return w}function set_font(xxx){gene.curfont=gene.deffont=get_font(xxx)}function out_str(str){var i,c,n_font,o_font=gene.curfont,c_font=o_font;for(i=0;i<str.length;i++){c=str[i];switch(c){case"<":c="&lt;";break;case">":c="&gt;";break;case"'":c="&apos;";break;case'"':c="&quot;";break;case"&":if(str[i+1]=="#")break;if(str[i+2]=="t"&&str[i+3]==";"&&(str[i+1]=="l"||str[i+1]=="g"))break;if(str[i+1]=="a"&&str[i+2]=="p"&&str[i+3]=="o"&&str[i+4]=="s"&&str[i+5]==";")break;if(str[i+1]=="q"&&str[i+2]=="u"&&str[i+3]=="o"&&str[i+4]=="t"&&str[i+5]==";")break;if(str[i+1]=="a"&&str[i+2]=="m"&&str[i+3]=="p"&&str[i+4]==";")break;c="&amp;";break;case"$":c=str[++i];if(c=="0"){n_font=gene.deffont}else if(c>="1"&&c<="9"){n_font=get_font("u"+c);if(!n_font){output.push("$"+c);continue}}else{output.push("$"+c);continue}if(n_font==c_font)continue;if(c_font!=o_font)output.push("</tspan>");c_font=n_font;if(c_font==o_font)continue;c='<tspan\n	class="f'+n_font.fid+cfmt.fullsvg+'">';break}output.push(c)}if(c_font!=o_font)output.push("</tspan>")}function xy_str(x,y,str,action,dx){output.push('<text class="f'+gene.curfont.fid+cfmt.fullsvg+'" x="');out_sxsy(x,'" y="',y);if(action=="c")output.push('" text-anchor="middle">');else if(action=="j")output.push('" textLength="'+dx.toFixed(2)+'">');else if(action=="r")output.push('" text-anchor="end">');else output.push('">');out_str(str);output.push("</text>\n")}function trim_title(title,is_subtitle){var i;if(cfmt.titletrim){i=title.lastIndexOf(", ");if(i<0||title[i+2]<"A"||title[i+2]>"Z"||i<title.length-7||title.indexOf(" ",i+3)>=0)i=0}if(!is_subtitle&&cfmt.writefields.indexOf("X")>=0)title=info.X+".  "+title;if(i)title=title.slice(i+2).trim()+" "+title.slice(0,i);if(cfmt.titlecaps)return title.toUpperCase();return title}function write_title(title,is_subtitle){var font,sz;if(!title)return;title=trim_title(title,is_subtitle);if(is_subtitle){set_font("subtitle");sz=gene.curfont.size;vskip(cfmt.subtitlespace+sz)}else{set_font("title");sz=gene.curfont.size;vskip(cfmt.titlespace+sz)}if(cfmt.titleleft)xy_str(0,sz*.2,title);else xy_str((cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/2/cfmt.scale,sz*.2,title,"c")}function put_inf2r(x,y,str1,str2,action){if(!str1){str1=str2;str2=null}if(!str2)xy_str(x,y,str1,action);else xy_str(x,y,str1+" ("+str2+")",action)}function write_text(text,action){if(action=="s")return;set_font("text");var strlw=(cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/cfmt.scale,lineskip=gene.curfont.size*cfmt.lineskipfac,parskip=gene.curfont.size*cfmt.parskipfac,i,j,x;switch(action){default:switch(action){case"c":x=strlw/2;break;case"r":x=strlw;break;default:x=0;break}j=0;while(1){i=text.indexOf("\n",j);if(i<0){vskip(lineskip);xy_str(x,0,text.slice(j),action);break}if(i==j){vskip(parskip);blk_out();while(text[i+1]=="\n"){vskip(lineskip);i++}if(i==text.length)break}else{vskip(lineskip);xy_str(x,0,text.slice(j,i),action)}j=i+1}vskip(parskip);blk_out();break;case"f":case"j":var words;j=0;while(1){i=text.indexOf("\n\n",j);if(i<0)words=text.slice(j);else words=text.slice(j,i);words=words.split(/\s+/);var w=0,k=0;for(j=0;j<words.length;j++){w+=strw(words[j]+" ");if(w>=strlw){vskip(lineskip);xy_str(0,0,words.slice(k,j).join(" "),action,strlw);k=j;w=0}}if(w!=0){vskip(lineskip);xy_str(0,0,words.slice(k).join(" "))}vskip(parskip);blk_out();if(i<0)break;while(text[i+2]=="\n"){vskip(lineskip);i++}if(i==text.length)break;j=i+2}break}}function put_wline(p,x,right){var i=0,j,k;while(p[i]==" ")i++;if(p[i]=="$"&&p[i+1]>="0"&&p[i+1]<="9")i+=2;k=0;j=i;if(p[i]>="0"&&p[i]<="9"||p[i+1]=="."){while(i<p.length){i++;if(p[i]==" "||p[i-1]==":"||p[i-1]==".")break}k=i;while(p[i]==" ")i++}if(k!=0)xy_str(x,0,p.slice(j,k),"r");if(i<p.length)xy_str(x+5,0,p.slice(i),"l");return i>p.length&&k==0}function put_words(words){var p,i,j,n,nw,i2,i_end,have_text;blk_out();set_font("words");var middle=.5*(cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/cfmt.scale;var max2col=(middle-45)/(cwid("a")*gene.curfont.swfac);n=0;words=words.split("\n");nw=words.length;for(i=0;i<nw;i++){p=words[i];if(p.length>max2col){n=0;break}if(!p){if(have_text){n++;have_text=false}}else{have_text=true}}if(n>0){n++;n/=2;i=n;have_text=false;for(i_end=0;i_end<nw;i_end++){p=words[i_end];j=0;while(p[j]==" ")j++;if(j==p.length){if(have_text&&--i<=0)break;have_text=false}else{have_text=true}}i2=i_end+1}else{i2=i_end=nw}vskip(cfmt.wordsspace);for(i=0;i<i_end||i2<nw;i++){var desc=gene.curfont.size*.2;if(i<i_end&&words[i].length==0)blk_out();vskip(cfmt.lineskipfac*gene.curfont.size-desc);if(i<i_end)put_wline(words[i],45,0);if(i2<nw){if(put_wline(words[i2],20+middle,1)){if(--n==0){if(i<i_end){n++}else if(i2<words.length-1){middle*=.6}}}i2++}vskip(desc)}}function put_history(){var i,j,c,str,font,h,w,names=cfmt.infoname.split("\n"),n=names.length;for(i=0;i<n;i++){c=names[i][0];if(cfmt.writefields.indexOf(c)<0)continue;str=info[c];if(!str)continue;if(!font){font=true;set_font("history");vskip(cfmt.textspace);h=gene.curfont.size*cfmt.lineskipfac}head=names[i].slice(2);if(head[0]='"')head=head.slice(1,-1);vskip(h);xy_str(0,0,head);w=strw(head);str=str.split("\n");xy_str(w,0,str[0]);for(j=1;j<str.length;j++){vskip(h);xy_str(w,0,str[j])}vskip(h*.3);blk_out()}}var info_font_init={A:"info",C:"composer",O:"composer",P:"parts",Q:"tempo",R:"info",T:"title",X:"title"};function write_headform(lwidth){var c,font,font_name,align,x,y,sz,info_val={},info_font=clone(info_font_init),info_sz={A:cfmt.infospace,C:cfmt.composerspace,O:cfmt.composerspace,R:cfmt.infospace},info_nb={};var fmt="",p=cfmt.titleformat,j=0,i=0;while(1){while(p[i]==" ")i++;if(i>=p.length)break;c=p[i++];if(c<"A"||c>"Z"){if(c=="+"){if(fmt.lenth==0||fmt[fmt.length-1]=="+")continue;fmt=fmt.slice(0,-1)+"+"}else if(c==","){if(fmt[fmt.length-1]=="+")fmt=fmt.slice(0,-1)+"l";fmt+="\n"}continue}if(!info_val[c]){if(!info[c])continue;info_val[c]=info[c].split("\n");info_nb[c]=1}else{info_nb[c]++}fmt+=c;switch(p[i]){case"-":fmt+="l";i++;break;case"0":fmt+="c";i++;break;case"1":fmt+="r";i++;break;default:fmt+="c";break}}if(fmt[fmt.length-1]=="+")fmt=fmt.slice(0,-1)+"l";fmt+="\n";var ya={l:cfmt.titlespace,c:cfmt.titlespace,r:cfmt.titlespace},xa={l:0,c:lwidth*.5,r:lwidth},yb={},str;p=fmt;i=0;while(1){yb.l=yb.c=yb.r=y=0;j=i;while(1){c=p[j++];if(c=="\n")break;align=p[j++];if(align=="+")align=p[j+1];else if(yb[align]!=0)continue;str=info_val[c];if(!str)continue;font_name=info_font[c];if(!font_name)font_name="history";font=get_font(font_name);sz=font.size*1.1;if(info_sz[c])sz+=info_sz[c];if(y<sz)y=sz;yb[align]=sz}ya.l+=y-yb.l;ya.c+=y-yb.c;ya.r+=y-yb.r;while(1){c=p[i++];if(c=="\n")break;align=p[i++];if(info_val[c].length==0)continue;str=info_val[c].shift();if(align=="+"){info_nb[c]--;c=p[i++];align=p[i++];if(info_val[c].length>0){if(str)str+=" "+info_val[c].shift();else str=" "+info_val[c].shift()}}font_name=info_font[c];if(!font_name)font_name="history";font=get_font(font_name);sz=font.size*1.1;if(info_sz[c])sz+=info_sz[c];set_font(font_name);x=xa[align];y=ya[align]+sz;if(c=="Q"){if(align!="l"){var w=tempo_width(glovar.tempo);if(align=="c")w*=.5;x-=w}write_tempo(glovar.tempo,x,-y,.75);glovar.tempo.deleted=true}else if(str){xy_str(x,-y,str,align)}if(c=="T"){font_name=info_font.T="subtitle";info_sz.T=cfmt.subtitlespace}if(info_nb[c]<=1){if(c=="T"){font=get_font(font_name);sz=font.size*1.1;if(info_sz[c])sz+=info_sz[c];set_font(font_name)}while(info_val[c].length>0){y+=sz;str=info_val[c].shift();xy_str(x,-y,str,align)}}info_nb[c]--;ya[align]=y}if(ya.c>ya.l)ya.l=ya.c;if(ya.r>ya.l)ya.l=ya.r;if(i>=fmt.length)break;ya.c=ya.r=ya.l}vskip(ya.l)}function write_heading(){var i,j,area,composer,origin,rhythm,down1,down2,lwidth=(cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/cfmt.scale;if(cfmt.titleformat&&cfmt.titleformat.length>0){write_headform(lwidth);vskip(cfmt.musicspace);return}if(info.T&&cfmt.writefields.indexOf("T")>=0){i=0;while(1){j=info.T.indexOf("\n",i);if(j<0){write_title(info.T.substring(i),i!=0);break}write_title(info.T.slice(i,j),i!=0);i=j+1}}set_font("composer");down1=cfmt.composerspace+gene.curfont.size;if(parse.ckey.k_bagpipe&&!cfmt.infoline&&cfmt.writefields.indexOf("R")>=0)rhythm=info.R;if(rhythm){xy_str(0,-cfmt.composerspace,rhythm);down1=cfmt.composerspace}area=info.A;if(cfmt.writefields.indexOf("C")>=0)composer=info.C;if(cfmt.writefields.indexOf("O")>=0)origin=info.O;if(composer||origin||cfmt.infoline){var xcomp,align;vskip(cfmt.composerspace);if(cfmt.aligncomposer<0){xcomp=0;align=" "}else if(cfmt.aligncomposer==0){xcomp=lwidth*.5;align="c"}else{xcomp=lwidth;align="r"}down2=down1;if(composer||origin){if(cfmt.aligncomposer>=0&&down1!=down2)vskip(down1-down2);i=0;while(1){vskip(gene.curfont.size);if(composer)j=composer.indexOf("\n",i);else j=-1;if(j<0){put_inf2r(xcomp,0,composer?composer.substring(i):null,origin,align);break}xy_str(xcomp,0,composer.slice(i,j),align);down1+=gene.curfont.size;i=j+1}if(down2>down1)vskip(down2-down1)}rhythm=rhythm?null:info.R;if((rhythm||area)&&cfmt.infoline){set_font("info");vskip(gene.curfont.size+cfmt.infospace);put_inf2r(lwidth,0,rhythm,area,"r");down1+=gene.curfont.size+cfmt.infospace}down2=0}else{down2=cfmt.composerspace;
}if(info.P&&cfmt.writefields.indexOf("P")>=0){set_font("parts");down1=cfmt.partsspace+gene.curfont.size-down1;if(down1>0)down2+=down1;if(down2>.01)vskip(down2);xy_str(0,0,info.P);down2=0}vskip(down2+cfmt.musicspace)}var output=[],style="\n.fill {fill: currentColor}\n.stroke {stroke: currentColor; fill: none}",font_style="",posy=0,posx=cfmt.leftmargin/cfmt.scale,defined_glyph={},defs="",stv_g={scale:1,dy:0,st:-1,v:0},block={};var glyphs={brace:'<path id="brace" class="fill" transform="scale(0.0235)"\n	d="M-20 -515v-2\n	c35 -16 53 -48 53 -91\n	c0 -34 -11 -84 -35 -150\n	c-13 -41 -18 -76 -18 -109\n	c0 -69 29 -121 87 -160\n	c-44 35 -63 77 -63 125\n	c0 26 8 56 21 91\n	c27 71 37 130 37 174\n	c0 62 -26 105 -77 121\n	c52 16 77 63 77 126\n	c0 46 -10 102 -37 172\n	c-13 35 -21 68 -21 94\n	c0 48 19 89 63 124\n	c-58 -39 -87 -91 -87 -160\n	c0 -33 5 -68 18 -109\n	c24 -66 35 -116 35 -150\n	c0 -44 -18 -80 -53 -96z"/>',utclef:'<path id="utclef" class="fill" transform="scale(0.045)"\n	d="m-50 44\n	c-72 -41 -72 -158 52 -188\n	150 -10 220 188 90 256\n	-114 52 -275 0 -293 -136\n	-15 -181 93 -229 220 -334\n	88 -87 79 -133 62 -210\n	-51 33 -94 105 -89 186\n	17 267 36 374 49 574\n	6 96 -19 134 -77 135\n	-80 1 -126 -93 -61 -133\n	85 -41 133 101 31 105\n	23 17 92 37 90 -92\n	-10 -223 -39 -342 -50 -617\n	0 -90 0 -162 96 -232\n	56 72 63 230 22 289\n	-74 106 -257 168 -255 316\n	9 153 148 185 252 133\n	86 -65 29 -192 -80 -176\n	-71 12 -105 67 -59 124"/>',tclef:'<use id="tclef" xlink:href="#utclef"/>',stclef:'<use id="stclef" transform="scale(0.8)"\n	xlink:href="#utclef"/>',ubclef:'<path id="ubclef" class="fill" transform="scale(0.045)"\n	d="m-200 312\n	c124 -35 222 -78 254 -236\n	43 -228 -167 -246 -192 -103\n	59 -80 157 22 92 78\n	-62 47 -115 -22 -106 -88\n	21 -141 270 -136 274 52\n	-1 175 -106 264 -322 297\n	m357 -250\n	c0 -36 51 -34 51 0\n	0 37 -51 36 -51 0\n	m-2 -129\n	c0 -36 51 -34 51 0\n	0 38 -51 37 -51 0"/>',bclef:'<use id="bclef" xlink:href="#ubclef"/>',sbclef:'<use id="sbclef" transform="scale(0.8)"\n	xlink:href="#ubclef"/>',ucclef:'<path id="ucclef" class="fill" transform="scale(0.045)"\n	d="m-51 3\n	v262\n	h-13\n	v-529\n	h13\n	v256\n	c25 -20 41 -36 63 -109\n	14 31 13 51 56 70\n	90 34 96 -266 -41 -185\n	52 19 27 80 -11 77\n	-90 -38 33 -176 139 -69\n	72 79 1 241 -134 186\n	l-16 39 16 38\n	c135 -55 206 107 134 186\n	-106 108 -229 -31 -139 -69\n	38 -3 63 58 11 77\n	137 81 131 -219 41 -185\n	-43 19 -45 30 -56 64\n	-22 -73 -38 -89 -63 -109\n	m-99 -267\n	h57\n	v529\n	h-57\n	v-529"/>',cclef:'<use id="cclef" xlink:href="#ucclef"/>',scclef:'<use id="scclef" transform="scale(0.8)"\n	xlink:href="#ucclef"/>',pclef:'<path id="pclef" class="stroke" stroke-width="1.4"\n	d="m-4 10h5.4v-20h-5.4v20"/>',hd:'<ellipse id="hd" rx="4.1" ry="2.9"\n	transform="rotate(-20)" class="fill"/>',Hd:'<path id="Hd" class="fill" d="m3 -1.6\n	c-1 -1.8 -7 1.4 -6 3.2\n	1 1.8 7 -1.4 6 -3.2\n	m0.5 -0.3\n	c2 3.8 -5 7.6 -7 3.8\n	-2 -3.8 5 -7.6 7 -3.8"/>',HD:'<path id="HD" class="fill" d="m-2.7 -1.4\n	c1.5 -2.8 6.9 0 5.3 2.7\n	-1.5 2.8 -6.9 0 -5.3 -2.7\n	m8.3 1.4\n	c0 -1.5 -2.2 -3 -5.6 -3\n	-3.4 0 -5.6 1.5 -5.6 3\n	0 1.5 2.2 3 5.6 3\n	3.4 0 5.6 -1.5 5.6 -3"/>',HDD:'<g id="HDD">\n	<use xlink:href="#HD"/>\n	<path d="m-6 -4v8m12 0v-8" class="stroke"/>\n</g>',breve:'<g id="breve" class="stroke">\n	<path d="m-6 -2.7h12m0 5.4h-12" stroke-width="2.5"/>\n	<path d="m-6 -5v10m12 0v-10"/>\n</g>',longa:'<g id="longa" class="stroke">\n	<path d="m-6 2.7h12m0 -5.4h-12" stroke-width="2.5"/>\n	<path d="m-6 5v-10m12 0v16"/>\n</g>',ghd:'<use id="ghd" transform="translate(4.5,0) scale(0.5)" xlink:href="#hd"/>',r00:'<rect id="r00" class="fill"\n	x="-1.6" y="-6" width="3" height="12"/>',r0:'<rect id="r0" class="fill"\n	x="-1.6" y="-6" width="3" height="6"/>',r1:'<rect id="r1" class="fill"\n	x="-3.5" y="-6" width="7" height="3"/>',r2:'<rect id="r2" class="fill"\n	x="-3.5" y="-3" width="7" height="3"/>',r4:'<path id="r4" class="fill" d="m-1 -8.5\n	l3.6 5.1 -2.1 5.2 2.2 4.3\n	c-2.6 -2.3 -5.1 0 -2.4 2.6\n	-4.8 -3 -1.5 -6.9 1.4 -4.1\n	l-3.1 -4.5 1.9 -5.1 -1.5 -3.5"/>',r8e:'<path id="r8e" class="fill" d="m 0 0\n	c-1.5 1.5 -2.4 2 -3.6 2\n	2.4 -2.8 -2.8 -4 -2.8 -1.2\n	0 2.7 4.3 2.4 5.9 0.6"/>',r8:'<g id="r8">\n	<path d="m3.3 -4l-3.4 9.6" class="stroke"/>\n	<use x="3.4" y="-4" xlink:href="#r8e"/>\n</g>',r16:'<g id="r16">\n	<path d="m3.3 -4l-4 15.6" class="stroke"/>\n	<use x="3.4" y="-4" xlink:href="#r8e"/>\n	<use x="1.9" y="2" xlink:href="#r8e"/>\n</g>',r32:'<g id="r32">\n	<path d="m4.8 -10l-5.5 21.6" class="stroke"/>\n	<use x="4.9" y="-10" xlink:href="#r8e"/>\n	<use x="3.4" y="-4" xlink:href="#r8e"/>\n	<use x="1.9" y="2" xlink:href="#r8e"/>\n</g>',r64:'<g id="r64">\n	<path d="m4.8 -10 l-7 27.6" class="stroke"/>\n	<use x="4.9" y="-10" xlink:href="#r8e"/>\n	<use x="3.4" y="-4" xlink:href="#r8e"/>\n	<use x="1.9" y="2" xlink:href="#r8e"/>\n	<use x="0.4" y="8" xlink:href="#r8e"/>\n</g>',r128:'<g id="r128">\n	<path d="m5.8 -16 l-8.5 33.6" class="stroke"/>\n	<use x="5.9" y="-16" xlink:href="#r8e"/>\n	<use x="4.4" y="-10" xlink:href="#r8e"/>\n	<use x="2.9" y="-4" xlink:href="#r8e"/>\n	<use x="1.4" y="2" xlink:href="#r8e"/>\n	<use x="0.1" y="8" xlink:href="#r8e"/>\n</g>',mrest:'<g id="mrest" class="stroke">\n	<path d="m-10 6v-12m20 0v12"/>\n	<path d="m-10 0h20" stroke-width="5"/>\n</g>',usharp:'<path id="usharp" class="fill" d="m136 -702\n	v890\n	h32\n	v-890\n	m128 840\n	h32\n	v-888\n	h-32\n	m-232 286\n	v116\n	l338 -96\n	v-116\n	m-338 442\n	v116\n	l338 -98\n	v-114"/>',uflat:'<path id="uflat" class="fill" d="m100 -746\n	h32\n	v734\n	l-32 4\n	m32 -332\n	c46 -72 152 -90 208 -20\n	100 110 -120 326 -208 348\n	m0 -28\n	c54 0 200 -206 130 -290\n	-50 -60 -130 -4 -130 34"/>',unat:'<path id="unat" class="fill" d="m96 -750\n	h-32\n	v716\n	l32 -8\n	l182 -54\n	v282\n	h32\n	v-706\n	l-34 10\n	l-180 50\n	v-290\n	m0 592\n	v-190\n	l182 -52\n	v188"/>',udblesharp:'<path id="udblesharp" class="fill" d="m240 -282\n	c40 -38 74 -68 158 -68\n	v-96\n	h-96\n	c0 84 -30 118 -68 156\n	-40 -38 -70 -72 -70 -156\n	h-96\n	v96\n	c86 0 120 30 158 68\n	-38 38 -72 68 -158 68\n	v96\n	h96\n	c0 -84 30 -118 70 -156\n	38 38 68 72 68 156\n	h96\n	v-96\n	c-84 0 -118 -30 -158 -68"/>',udbleflat:'<path id="udbleflat" class="fill" d="m20 -746\n	h24\n	v734\n	l-24 4\n	m24 -332\n	c34 -72 114 -90 156 -20\n	75 110 -98 326 -156 348\n	m0 -28\n	c40 0 150 -206 97 -290\n	-37 -60 -97 -4 -97 34\n	m226 -450\n	h24\n	v734\n	l-24 4\n	m24 -332\n	c34 -72 114 -90 156 -20\n	75 110 -98 326 -156 348\n	m0 -28\n	c40 0 150 -206 97 -290\n	-37 -60 -97 -4 -97 34"/>',acc1:'<use id="acc1" transform="translate(-4,5) scale(0.018)" xlink:href="#usharp"/>',"acc-1":'<use id="acc-1" transform="translate(-3.5,3.5) scale(0.018)" xlink:href="#uflat"/>',acc3:'<use id="acc3" transform="translate(-3,5) scale(0.018)" xlink:href="#unat"/>',acc2:'<use id="acc2" transform="translate(-4,5) scale(0.018)"\n	xlink:href="#udblesharp"/>',"acc-2":'<use id="acc-2" transform="translate(-4,3.5) scale(0.018)"\n	xlink:href="#udbleflat"/>',acc1_1_4:'<g id="acc1_1_4">\n	<path d="m0 7.8v-15.4" class="stroke"/>\n	<path class="fill" d="M-1.8 2.7l3.6 -1.1v2.2l-3.6 1.1v-2.2z\n		M-1.8 -3.7l3.6 -1.1v2.2l-3.6 1.1v-2.2"/>\n</g>',acc1_3_4:'<g id="acc1_3_4">\n	<path d="m-2.5 8.7v-15.4M0 7.8v-15.4M2.5 6.9v-15.4" class="stroke"/>\n	<path class="fill" d="m-3.7 3.1l7.4 -2.2v2.2l-7.4 2.2v-2.2z\n		M-3.7 -3.2l7.4 -2.2v2.2l-7.4 2.2v-2.2"/>\n</g>',"acc-1_1_4":'<g id="acc-1_1_4" transform="scale(-1,1)">\n	<use xlink:href="#acc-1"/>\n</g>',"acc-1_3_4":'<g id="acc-1_3_4">\n    <path class="fill" d="m0.6 -2.7\n	c-5.7 -3.1 -5.7 3.6 0 6.7c-3.9 -4 -4 -7.6 0 -5.8\n	M1 -2.7c5.7 -3.1 5.7 3.6 0 6.7c3.9 -4 4 -7.6 0 -5.8"/>\n    <path d="m1.6 3.5v-13M0 3.5v-13" class="stroke" stroke-width=".6"/>\n</g>',pshhd:'<use id="pshhd" xlink:href="#acc2"/>',pfthd:'<g id="pfthd">\n	<use xlink:href="#acc2"/>\n	<circle r="4" class="stroke"/>\n</g>',csig:'<path id="csig" class="fill" transform="scale(0.0235, 0.0235)"\n	d="M303 -161\n	c8 1 12 2 18 3\n	c3 -4 4 -9 4 -13\n	c0 -28 -52 -54 -91 -54\n	c-61 2 -115 58 -115 210\n	c0 76 7 151 39 193\n	c23 29 49 42 81 42\n	c26 0 55 -10 83 -34\n	s47 -64 70 -112\n	c0 3 18 6 17 9\n	c-33 103 -76 164 -198 166\n	c-50 0 -100 -20 -138 -57\n	c-39 -38 -60 -91 -63 -159\n	c0 -4 -1 -43 -1 -47\n	c0 -168 88 -231 219 -232\n	c52 0 97 27 117 50\n	s34 49 34 75\n	c0 47 -25 94 -64 94\n	c-45 0 -73 -39 -73 -74\n	c2 -26 23 -60 60 -60h1z"/>',ctsig:'<g id="ctsig">\n	<use xlink:href="#csig"/>\n	<path d="m5 8v-16" class="stroke"/>\n</g>',pmsig:'<path id="pmsig" class="stroke" stroke-width="0.8"\n	d="m0 -7a5 5 0 0 1 0 -10a5 5 0 0 1 0 10"/>',pMsig:'<g id="pMsig">\n	<use xlink:href="#pmsig"/>\n	<path class="fill" d="m0 -10a2 2 0 0 1 0 -4a2 2 0 0 1 0 4"/>\n</g>',imsig:'<path id="imsig" class="stroke" stroke-width="0.8"\n	d="m0 -7a5 5 0 1 1 0 -10"/>',iMsig:'<g id="iMsig">\n	<use xlink:href="#imsig"/>\n	<path class="fill" d="m0 -10a2 2 0 0 1 0 -4a2 2 0 0 1 0 4"/>\n</g>',hl:'<path id="hl" class="stroke" d="m-6 0h12"/>',hl1:'<path id="hl1" class="stroke" d="m-7 0h14"/>',hl2:'<path id="hl2" class="stroke" d="m-9 0h18"/>',ghl:'<path id="ghl" class="stroke" d="m-3 0h6"/>',rdots:'<g id="rdots" class="fill">\n	<circle cx="0" cy="-9" r="1.2"/>\n	<circle cx="0" cy="-15" r="1.2"/>\n</g>',srep:'<path id="srep" class="fill" d="m-1 -6l11 -12h3l-11 12h-3"/>',mrep:'<path id="mrep" class="fill"\n    d="m-5 -16.5a1.5 1.5 0 0 1 0 3a1.5 1.5 0 0 1 0 -3\n	M4.5 -10a1.5 1.5 0 0 1 0 3a1.5 1.5 0 0 1 0 -3\n	M-7 -6l11 -12h3l-11 12h-3"/>',mrep2:'<g id="mrep2">\n    <path d="m-5.5 -19.5a1.5 1.5 0 0 1 0 3a1.5 1.5 0 0 1 0 -3\n	M5 -7.5a1.5 1.5 0 0 1 0 3a1.5 1.5 0 0 1 0 -3" class="fill"/>\n    <path d="m-7 -4l14 -10m-14 4l14 -10" class="stroke" stroke-width="1.8"/>\n</g>',accent:'<g id="accent" class="stroke">\n	<path d="m-4 0l8 -2l-8 -2" stroke-width="1.2"/>\n</g>',marcato:'<path id="marcato" d="m-3 0l3 -7l3 7l-1.5 0l-1.8 -4.2l-1.7 4.2"/>',umrd:'<path id="umrd" class="fill" d="m0 -4\n	l2.2 -2.2 2.1 2.9 0.7 -0.7 0.2 0.2\n	-2.2 2.2 -2.1 -2.9 -0.7 0.7\n	-2.2 2.2 -2.1 -2.9 -0.7 0.7 -0.2 -0.2\n	2.2 -2.2 2.1 2.9 0.7 -0.7"/>',lmrd:'<g id="lmrd">\n	<use xlink:href="#umrd"/>\n	<line x1="0" y1="0" x2="0" y2="-8" class="stroke" stroke-width=".6"/>\n</g>',grm:'<path id="grm" class="fill" d="m-5 -2.5\n	c5 -8.5 5.5 4.5 10 -2\n	-5 8.5 -5.5 -4.5 -10 2"/>',stc:'<circle id="stc" class="fill" cx="0" cy="-3" r="1.2"/>',sld:'<path id="sld" class="fill" d="m-7.2 4.8\n	c1.8 0.7 4.5 -0.2 7.2 -4.8\n	-2.1 5 -5.4 6.8 -7.6 6"/>',emb:'<path id="emb" class="stroke" stroke-width="1.2" stroke-linecap="round"\n	d="m-2.5 -3h5"/>',hld:'<g id="hld" class="fill">\n    <circle cx="0" cy="-3" r="1.3"/>\n    <path d="m-7.5 -1.5\n	c0 -11.5 15 -11.5 15 0\n	h-0.25\n	c-1.25 -9 -13.25 -9 -14.5 0"/>\n</g>',brth:'<text id="brth" y="-6" style="font:bold italic 30px serif">,</text>',cpu:'<path id="cpu" class="fill" d="m-6 0\n	c0.4 -7.3 11.3 -7.3 11.7 0\n	-1.3 -6 -10.4 -6 -11.7 0"/>',upb:'<path id="upb" class="stroke" d="m-2.6 -9.4\n	l2.6 8.8\n	l2.6 -8.8"/>',dnb:'<g id="dnb">\n	<path d="M-3.2 -2v-7.2m6.4 0v7.2" class="stroke"/>\n	<path d="M-3.2 -6.8v-2.4l6.4 0v2.4" class="fill"/>\n</g>',sgno:'<g id="sgno">\n    <path class="fill" d="m0 -3\n	c1.5 1.7 6.4 -0.3 3 -3.7\n	-10.4 -7.8 -8 -10.6 -6.5 -11.9\n	4 -1.9 5.9 1.7 4.2 2.6\n	-1.3 0.7 -2.9 -1.3 -0.7 -2\n	-1.5 -1.7 -6.4 0.3 -3 3.7\n	10.4 7.8 8 10.6 6.5 11.9\n	-4 1.9 -5.9 -1.7 -4.2 -2.6\n	1.3 -0.7 2.9 1.3 0.7 2"/>\n    <line x1="-6" y1="-4.2" x2="6.6" y2="-16.8" class="stroke"/>\n    <circle cx="-6" cy="-10" r="1.2"/>\n    <circle cx="6" cy="-11" r="1.2"/>\n</g>',coda:'<g id="coda" class="stroke">\n	<path d="m0 -2v-20m-10 10h20"/>\n	<circle cx="0" cy="-12" r="6" stroke-width="1.7"/>\n</g>',dplus:'<path id="dplus" class="stroke" stroke-width="1.7"\n	d="m0 -0.5v-6m-3 3h6"/>',lphr:'<path id="lphr" class="stroke" stroke-width="1.2"\n	d="m0 0v18"/>',mphr:'<path id="mphr" class="stroke" stroke-width="1.2"\n	d="m0 0v12"/>',sphr:'<path id="sphr" class="stroke" stroke-width="1.2"\n	d="m0 0v6"/>',sfz:'<text id="sfz" x="-5" y="-7" style="font:italic 14px serif">\n	s<tspan font-size="16" font-weight="bold">f</tspan>z</text>',trl:'<text id="trl" x="-2" y="-4"\n	style="font:bold italic 16px serif">tr</text>',opend:'<circle id="opend" class="stroke"\n	cx="0" cy="-3" r="2.5"/>',snap:'<path id="snap" class="stroke" d="m-3 -6\n	c0 -5 6 -5 6 0\n	0 5 -6 5 -6 0\n	M0 -5v6"/>',thumb:'<path id="thumb" class="stroke" d="m-2.5 -7\n	c0 -6 5 -6 5 0\n	0 6 -5 6 -5 0\n	M-2.5 -9v4"/>',turn:'<path id="turn" class="fill" d="m5.2 -8\n	c1.4 0.5 0.9 4.8 -2.2 2.8\n	l-4.8 -3.5\n	c-3 -2 -5.8 1.8 -3.6 4.4\n	1 1.1 2 0.8 2.1 -0.1\n	0.1 -0.9 -0.7 -1.2 -1.9 -0.6\n	-1.4 -0.5 -0.9 -4.8 2.2 -2.8\n	l4.8 3.5\n	c3 2 5.8 -1.8 3.6 -4.4\n	-1 -1.1 -2 -0.8 -2.1 0.1\n	-0.1 0.9 0.7 1.2 1.9 0.6"/>',turnx:'<g id="turnx">\n	<use xlink:href="#turn"/>\n	<path d="m0 -1.5v-9" class="stroke"/>\n</g>',wedge:'<path id="wedge" class="fill" d="m0 -1l-1.5 -5h3l-1.5 5"/>',ltr:'<path id="ltr" class="fill"\n	d="m0 -0.4c2 -1.5 3.4 -1.9 3.9 0.4\n	c0.2 0.8 0.7 0.7 2.1 -0.4\n	v0.8c-2 1.5 -3.4 1.9 -3.9 -0.4\n	c-0.2 -0.8 -0.7 -0.7 -2.1 0.4z"/>',custos:'<g id="custos">\n	<path d="m-4 0l2 2.5 2 -2.5 2 2.5 2 -2.5\n		-2 -2.5 -2 2.5 -2 -2.5 -2 2.5" class="fill"/>\n	<path d="m3.5 0l5 -7" class="stroke"/>\n</g>',oct:'<text id="oct" style="font:12px serif">8</text>i'};function def_use(gl){var i,j,g;if(defined_glyph[gl])return;defined_glyph[gl]=true;g=glyphs[gl];if(!g){error(1,null,"unknown glyph: "+gl);return}j=0;while(1){i=g.indexOf('xlink:href="#',j);if(i<0)break;i+=13;j=g.indexOf('"',i);def_use(g.slice(i,j))}defs+="\n"+g}function defs_add(text){var i,j,gl,tag,is,ie=0;while(1){is=text.indexOf("<",ie);if(is<0)break;if(text.slice(is,is+4)=="<!--"){ie=text.indexOf("-->",is+4);if(ie<0)break;continue}i=text.indexOf('id="',is);if(i<0)break;i+=4;j=text.indexOf('"',i);if(j<0)break;gl=text.slice(i,j);ie=text.indexOf(">",j);if(ie<0)break;if(text[ie-1]=="/"){ie++}else{i=text.indexOf(" ",is);if(i<0)break;tag=text.slice(is+1,i);ie=text.indexOf("</"+tag+">",ie);if(ie<0)break;ie+=3+tag.length}glyphs[gl]=text.slice(is,ie)}}function set_g(){if(stv_g.started){stv_g.started=false;output.push("</g>\n")}if(stv_g.scale==1&&!stv_g.color)return;output.push("<g ");if(stv_g.scale!=1){if(stv_g.st>=0){if(staff_tb[stv_g.st].y==0)output.push("!S"+stv_g.st+"!");else output.push(staff_tb[stv_g.st].scale_str)}else{if(staff_tb[0].y==0)output.push("!V"+stv_g.v+"!");else output.push(voice_tb[stv_g.v].scale_str)}}if(stv_g.color){if(stv_g.scale!=1)output.push(" ");output.push('style="color:'+stv_g.color+'"')}output.push(">\n");stv_g.started=true}function set_color(color){var old_color=stv_g.color;if(color!=stv_g.color){stv_g.color=color;set_g()}return old_color}function set_sscale(st){var new_scale,dy;if(st!=stv_g.st&&stv_g.scale!=1)stv_g.scale=0;if(st>=0)new_scale=staff_tb[st].staffscale;else new_scale=1;if(st>=0&&new_scale!=1)dy=staff_tb[st].y;else dy=posy;if(new_scale==stv_g.scale&&dy==stv_g.dy)return;stv_g.scale=new_scale;stv_g.dy=dy;stv_g.st=st;set_g()}function set_scale(s){var new_scale=voice_tb[s.v].scale;if(new_scale==1){set_sscale(s.st);return}if(new_scale==stv_g.scale&&stv_g.dy==posy)return;stv_g.scale=new_scale;stv_g.dy=posy;stv_g.st=-1;stv_g.v=s.v;set_g()}function set_dscale(st){output=staff_tb[st].output;stv_g.scale=staff_tb[st].staffscale;stv_g.st=-1}function delayed_update(){var st,new_out,text;function SV_upd(new_out){var i=0,j,k,res,v,y;while(1){j=new_out.indexOf("!",i);if(j<0)break;output.push(new_out.slice(i,j));if(new_out[j+1]=="S"){k=new_out.indexOf("!",j+2);v=Number(new_out.slice(j+2,k));output.push(staff_tb[v].scale_str);i=k+1}else if(new_out[j+1]=="V"){k=new_out.indexOf("!",j+2);v=Number(new_out.slice(j+2,k));output.push(voice_tb[v].scale_str);i=k+1}else{output.push("!");i=j+1}}output.push(new_out.slice(i))}for(st=0;st<=nstaff;st++){if(staff_tb[st].output.length==0)continue;output.push('<g transform="translate(0,'+(-staff_tb[st].y).toFixed(2));if(staff_tb[st].staffscale!=1)output.push(") scale("+staff_tb[st].staffscale.toFixed(2));output.push(')">\n');SV_upd(staff_tb[st].output.join(""));output.push("</g>\n");staff_tb[st].output=[]}}var anno_type=["bar","clef","custos","format","grace","key","meter","Zrest","note","part","rest","yspace","staves","Break","tempo","tuplet","block"];function anno_start(s){if(s.istart==undefined)return;var type=s.type,h=s.ymx-s.ymn+4;if(s.grace)type=GRACE;if(stv_g.started){stv_g.started=false;output.push("</g>\n")}user.anno_start(anno_type[s.type],s.istart,s.iend,s.x-s.wl-2,staff_tb[s.st].y+s.ymn+h-2,s.wl+s.wr+4,s.ymx-s.ymn+4);set_g()}function anno_stop(s){if(s.istart==undefined)return;var type=s.type,h=s.ymx-s.ymn+4;if(s.grace)type=GRACE;if(stv_g.started){stv_g.started=false;output.push("</g>\n")}user.anno_stop(anno_type[s.type],s.istart,s.iend,s.x-s.wl-2,staff_tb[s.st].y+s.ymn+h-2,s.wl+s.wr+4,s.ymx-s.ymn+4);set_g()}function out_svg(str){output.push(str)}Abc.prototype.out_svg=out_svg;function sx(x){return(x+posx)/stv_g.scale}Abc.prototype.sx=sx;function sy(y){if(stv_g.scale==1)return posy-y;if(stv_g.st<0)return(posy-y)/stv_g.scale;return stv_g.dy-y}Abc.prototype.sy=sy;function out_sxsy(x,sep,y){if(!stv_g.trans){x=(posx+x)/stv_g.scale;if(stv_g.scale!=1){if(stv_g.st<0)y=(posy-y)/stv_g.scale;else y=stv_g.dy-y}else{y=posy-y}}output.push(x.toFixed(2)+sep+y.toFixed(2))}Abc.prototype.out_sxsy=out_sxsy;function xypath(x,y,fill){if(fill)output.push('<path class="fill" d="m');else output.push('<path class="stroke" d="m');out_sxsy(x," ",y);output.push("\n")}Abc.prototype.xypath=xypath;function xybox(x,y,w,h){output.push('<rect class="stroke" stroke-width="0.6"\n	x="');out_sxsy(x,'" y="',y);output.push('" width="'+w.toFixed(2)+'" height="'+h.toFixed(2)+'"/>\n')}function xygl(x,y,gl){if(psxygl(x,y,gl))return;def_use(gl);output.push('<use x="');out_sxsy(x,'" y="',y);output.push('" xlink:href="#'+gl+'"/>\n')}function out_acciac(x,y,dx,dy,up){if(up){x-=1;y+=4}else{x-=5;y-=4}output.push('<path class="stroke" d="m');out_sxsy(x," ",y);output.push("l"+dx.toFixed(2)+" "+(-dy).toFixed(2)+'"/>\n')}function out_bar(x,y,h){x+=posx;y=posy-y;output.push('<path class="stroke" stroke-width="1" d="m'+x.toFixed(2)+" "+y.toFixed(2)+"v"+(-h).toFixed(2)+'"/>\n')}function out_bnum(x,y,str,erase){str=str.toString();if(erase){var i,w=.6;for(i=0;i<str.length;i++)w+=cwid(str[i]);w*=12;output.push('<rect fill="white" x="');out_sxsy(x-w/2,'" y="',y+10);output.push('" width="'+w.toFixed(2)+'" height="12"/>\n')}output.push('<text style="font:italic 12px serif"\n	x="');out_sxsy(x,'" y="',y);output.push('" text-anchor="middle">'+str+'</text>\n"')}function out_brace(x,y,h){def_use("brace");x+=posx-6;y=posy-y;h/=24;output.push('<use transform="translate('+x.toFixed(2)+","+y.toFixed(2)+") scale(2.5,"+h.toFixed(2)+')" xlink:href="#brace"/>')}function out_bracket(x,y,h){x+=posx-5;y=posy-y-3;h+=2;output.push('<path class="fill"\n	d="m'+x.toFixed(2)+" "+y.toFixed(2)+"\n	c10.5 1 12 -4.5 12 -3.5c0 1 -3.5 5.5 -8.5 5.5\n	v"+h.toFixed(2)+'\n	c5 0 8.5 4.5 8.5 5.5c0 1 -1.5 -4.5 -12 -3.5"/>\n')}function out_dot(x,y){output.push('<circle class="fill" cx="');out_sxsy(x,'" cy="',y);output.push('" r="1.2"/>\n')}function out_dotbar(x,y,h){x+=posx;y=posy-y;output.push('<path class="stroke" stroke-dasharray="5,5"\n	d="m'+x.toFixed(2)+" "+y.toFixed(2)+"v"+(-h).toFixed(2)+'"/>\n')}function out_hyph(x,y,w){var n,a_y,d=25+Math.floor(w/20)*3;if(w>15)n=Math.floor((w-15)/d);else n=0;x+=(w-d*n-5)/2;output.push('<path class="stroke" stroke-width="1.2"\n	stroke-dasharray="5,');output.push(Math.round((d-5)/stv_g.scale));output.push('"\n	d="m');out_sxsy(x," ",y+3);output.push("h"+(d*n+5).toFixed(2)+'"/>\n')}function out_stem(x,y,h,grace,nflags,straight){var dx=grace?GSTEM_XOFF:3.5,slen=-h;if(h<0)dx=-dx;x+=dx*stv_g.scale;output.push('<path class="stroke" d="m');out_sxsy(x," ",y);if(stv_g.st<0)slen/=stv_g.scale;output.push("v"+slen.toFixed(2)+'"/>\n');if(!nflags)return;output.push('<path class="fill"\n	d="');y+=h;if(h>0){if(!straight){if(!grace){if(nflags==1){output.push("M");out_sxsy(x," ",y);output.push("c0.6 5.6 9.6 9 5.6 18.4\n"+"	c1.6 -6 -1.3 -11.6 -5.6 -12.8\n")}else{while(--nflags>=0){output.push("M");out_sxsy(x," ",y);output.push("c0.9 3.7 9.1 6.4 6 12.4\n	c1 -5.4 -4.2 -8.4 -6 -8.4\n");y-=5.4}}}else{if(nflags==1){output.push("M");out_sxsy(x," ",y);output.push("c0.6 3.4 5.6 3.8 3 10\n	c1.2 -4.4 -1.4 -7 -3 -7\n")}else{while(--nflags>=0){output.push("M");out_sxsy(x," ",y);output.push("c1 3.2 5.6 2.8 3.2 8\n	c1.4 -4.8 -2.4 -5.4 -3.2 -5.2\n");y-=3.5}}}}else{if(!grace){y+=1;while(--nflags>=0){output.push("M");out_sxsy(x," ",y);output.push("l7 3.2 0 3.2 -7 -3.2z\n");y-=5.4}}else{while(--nflags>=0){output.push("M");out_sxsy(x," ",y);output.push("l3 1.5 0 2 -3 -1.5z\n");y-=3}}}}else{if(!straight){if(!grace){if(nflags==1){output.push("M");out_sxsy(x," ",y);output.push("c0.6 -5.6 9.6 -9 5.6 -18.4\n	c1.6 6 -1.3 11.6 -5.6 12.8\n")}else{while(--nflags>=0){output.push("M");out_sxsy(x," ",y);output.push("c0.9 -3.7 9.1 -6.4 6 -12.4\n	c1 5.4 -4.2 8.4 -6 8.4\n");y+=5.4}}}else{if(nflags==1){output.push("M");out_sxsy(x," ",y);output.push("c0.6 -3.4 5.6 -3.8 3 -10\n	c1.2 4.4 -1.4 7 -3 7\n")}else{while(--nflags>=0){output.push("M");out_sxsy(x," ",y);output.push("c1 -3.2 5.6 -2.8 3.2 -8\n	c1.4 4.8 -2.4 5.4 -3.2 5.2\n");y+=3.5}}}}else{if(!grace){y+=1;while(--nflags>=0){output.push("M");out_sxsy(x," ",y);output.push("l7 -3.2 0 -3.2 -7 3.2z\n");y+=5.4}}}}output.push('"/>\n')}function out_thbar(x,y,h){x+=posx+1.5;y=posy-y;output.push('<path class="stroke" stroke-width="3"\n	d="m'+x.toFixed(2)+" "+y.toFixed(2)+"v"+(-h).toFixed(2)+'"/>\n')}function out_trem(x,y,ntrem){output.push('<path class="fill" d="m');out_sxsy(x-4.5," ",y);output.push("\n	");while(1){output.push("l9 -3v3l-9 3z");if(--ntrem<=0)break;output.push("m0 5.4")}output.push('"/>\n')}function out_tubr(x,y,dx,dy,up){var h;if(up){h=-3;y-=3}else{h=3;y+=3}dx/=stv_g.scale;output.push('<path class="stroke" d="m');out_sxsy(x," ",y);output.push("v"+h.toFixed(2)+"l"+dx.toFixed(2)+" "+(-dy).toFixed(2)+"v"+(-h).toFixed(2)+'"/>\n')}function out_wln(x,y,w){output.push('<path class="stroke" stroke-width="0.8"\n	d="m');out_sxsy(x," ",y);output.push("h"+w.toFixed(2)+'"/>\n')}const deco_str_style={crdc:{dx:0,dy:5,style:'style="font:italic 14px serif"'},dacs:{dx:0,dy:3,style:'style="font:16px serif" text-anchor="middle"'},fng:{dx:-3,dy:1,style:'style="font:8px Bookman"'},pf:{dx:0,dy:5,style:'style="font:bold italic 16px serif"'}};function out_deco_str(x,y,name,str){var a,f,a_deco=deco_str_style[name];if(!a_deco){a_deco={dx:0,dy:0,style:'style="font:14px serif"'}}x+=a_deco.dx;y+=a_deco.dy;output.push("<text "+a_deco.style+'\n	x="');out_sxsy(x,'" y="',y);output.push('">');set_font("annotation");out_str(str);output.push("</text>\n")}function out_arp(x,y,val){output.push('<g transform="translate(');out_sxsy(x,",",y);output.push(') rotate(270)">\n');stv_g.trans=true;x=0;y=-4;val=Math.ceil(val/6);while(--val>=0){xygl(x,y,"ltr");x+=6}stv_g.trans=false;output.push("</g>\n")}function out_cresc(x,y,val,defl){output.push('<path class="stroke" d="m');if(defl.nost){out_sxsy(x," ",y+3.2);output.push("l"+val.toFixed(2)+" -2.2m0 8l"+(-val).toFixed(2)+' -2.2"/>\n')}else{out_sxsy(x," ",y+5);output.push("l"+val.toFixed(2)+" -4m0 8l"+(-val).toFixed(2)+' -4"/>\n')}}function out_dim(x,y,val,defl){output.push('<path class="stroke"\n	d="m');out_sxsy(x," ",y+5);output.push("l"+val.toFixed(2));if(defl.noen)output.push(" -2.2m0 -3.6l"+(-val).toFixed(2)+' -2.2"/>\n');else output.push(" -4l"+(-val).toFixed(2)+' -4"/>\n')}function out_ltr(x,y,val){y+=4;val=Math.ceil(val/6);while(--val>=0){xygl(x,y,"ltr");x+=6}}var deco_val_tb={arp:out_arp,cresc:out_cresc,dim:out_dim,ltr:out_ltr};function out_deco_val(x,y,name,val,defl){if(deco_val_tb[name])deco_val_tb[name](x,y,val,defl);else error(1,null,"No function for decoration '"+name+"'")}function vskip(h){posy+=h}function svg_flush(){var img_title;if(multicol||!output||!user.img_out)return;if(info.X){img_title=info.X+".";if(info.T)img_title+=" "+info.T.split("\n")[0];img_title=img_title.replace(/&/g,"&amp;");img_title=img_title.replace(/</g,"&lt;");img_title=img_title.replace(/>/g,"&gt;")}else{img_title="noname"}posy*=cfmt.scale;if(user.imagesize){user.img_out('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n	xmlns:xlink="http://www.w3.org/1999/xlink"\n	xml:space="preserve" color="black"\n'+user.imagesize+' viewBox="0 0 '+cfmt.pagewidth.toFixed(0)+" "+posy.toFixed(0)+'">\n<title>abc2svg - '+img_title+"</title>")}else{user.img_out('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n	xmlns:xlink="http://www.w3.org/1999/xlink"\n	xml:space="preserve" color="black"\n	width="'+cfmt.pagewidth.toFixed(0)+'px" height="'+posy.toFixed(0)+'px">\n<title>abc2svg - '+img_title+"</title>")}if(style||font_style)user.img_out('<style type="text/css">'+style+font_style+"\n</style>");if(defs)user.img_out("<defs>"+defs+"\n</defs>");if(cfmt.bgcolor)user.img_out('<rect width="100%" height="100%" fill="'+cfmt.bgcolor+'"/>');if(cfmt.scale==1)user.img_out('<g stroke-width=".7">');else user.img_out('<g stroke-width=".7"> transform="scale('+cfmt.scale.toFixed(2)+')">');if(svgobj){svgobj.setg(0);output.push(svgbuf);svgbuf=""}user.img_out(output.join("")+"</g>\n</svg>");output=[];font_style="";if(cfmt.fullsvg){defined_glyph={};defined_font={}}else{style="";defs=""}posy=0}var block_started;function blk_out(){if(multicol||!output||!user.img_out)return;if(user.page_format&&!block.started){block.started=true;if(block.newpage){block.newpage=false;user.img_out('<div class="nobrk newpage">')}else{user.img_out('<div class="nobrk">')}}svg_flush()}Abc.prototype.blk_out=blk_out;function blk_flush(){if(block.started&&user.img_out){block.started=false;user.img_out("</div>")}}Abc.prototype.blk_flush=blk_flush;var par_sy,cur_sy,voice_tb,curvoice,staves_found,vover,tsfirst;const weight_tb=[3,1,6,0,2,4,5,9,9,0,9,2,0,6,0,7,0];function voice_filter(){var opt,sel,tmp,i;for(opt in parse.voice_opts){sel=new RegExp(opt);if(sel.test(curvoice.id)||sel.test(curvoice.nm)){for(i=0;i<parse.voice_opts[opt].length;i++)do_pscom(parse.voice_opts[opt][i])}}}function sym_link(s){if(!curvoice.ignore){parse.last_sym=s;s.prev=curvoice.last_sym;if(curvoice.last_sym)curvoice.last_sym.next=s;else curvoice.sym=s;curvoice.last_sym=s}s.v=curvoice.v;s.st=curvoice.cst;s.time=curvoice.time;if(s.dur&&!s.grace)curvoice.time+=s.dur;s.pos=clone(curvoice.pos);if(curvoice.second)s.second=true;if(curvoice.floating)s.floating=true}function sym_add(p_voice){var s={},s2,p_voice2=curvoice;curvoice=p_voice;sym_link(s);curvoice=p_voice2;s2=s.prev;if(!s2)s2=s.next;if(s2){s.ctx=s2.ctx;s.istart=s2.istart;s.iend=s2.iend}return s}function mrest_expand(s){var p_voice,s2,next,nb=s.nmes,dur=s.dur/nb;var a_dd=s.a_dd;s.type=REST;s.dur=dur;s.head="full";s.nflags=-2;next=s.next;p_voice=voice_tb[s.v];p_voice.last_sym=s;p_voice.time=s.time+dur;p_voice.cst=s.st;s2=s;while(--nb>0){s2=sym_add(p_voice);s2.type=BAR;s2.bar_type="|";s2=sym_add(p_voice);s2.type=REST;if(s.invisible)s2.invisible=true;s2.dur=dur;s2.head="full";s2.nflags=-2;p_voice.time+=dur}s2.next=next;if(next)next.prev=s2;s2.a_dd=a_dd}function sort_all(){var s,s2,p_voice,v,time,w,wmin,ir,multi,prev,new_sy,fl,nb,nv=voice_tb.length,vtb=[],vn=[],mrest_time=-1;for(v=0;v<nv;v++)vtb.push(voice_tb[v].sym);var sy=cur_sy,set_sy=true;while(1){if(set_sy){set_sy=false;fl=1;multi=-1;for(v=0;v<nv;v++){if(!sy.voices[v]){sy.voices[v]={range:-1};continue}ir=sy.voices[v].range;if(ir<0)continue;vn[ir]=v;multi++}}wmin=time=1e6;for(ir=0;ir<vn.length;ir++){v=vn[ir];if(v==undefined)break;s=vtb[v];if(!s||s.time>time)continue;w=weight_tb[s.type];if(s.time<time){time=s.time;wmin=w}else if(w<wmin){wmin=w}if(s.type==MREST){if(s.nmes==1)mrest_expand(s);else if(multi>0)mrest_time=time}}if(wmin>127)break;if(time==mrest_time){nb=0;for(ir=0;ir<vn.length;ir++){v=vn[ir];if(v==undefined)break;s=vtb[v];if(!s||s.time!=time||weight_tb[s.type]!=wmin)continue;if(s.type!=MREST){mrest_time=-1;break}if(nb==0){nb=s.nmes}else if(nb!=s.nmes){mrest_time=-1;break}}if(mrest_time<0){for(ir=0;ir<vn.length;ir++){v=vn[ir];if(v==undefined)break;s=vtb[v];if(s&&s.type==MREST)mrest_expand(s)}}}for(ir=0;ir<vn.length;ir++){v=vn[ir];if(v==undefined)break;s=vtb[v];if(!s||s.time!=time||weight_tb[s.type]!=wmin)continue;if(s.type==STAVES){sy=sy.next;set_sy=new_sy=true;if(s.prev)s.prev.next=s.next;else voice_tb[v].sym=s.next;if(s.next)s.next.prev=s.prev}else{if(fl){fl=0;s.seqst=true}if(new_sy){new_sy=false;s.new_sy=true}s.ts_prev=prev;if(prev){prev.ts_next=s}else{tsfirst=s}prev=s}vtb[v]=s.next}fl=wmin}if(!prev)return;if(prev.type!=BAR&&prev.type!=FORMAT||new_sy){p_voice=voice_tb[prev.v];p_voice.last_sym=prev;s=sym_add(p_voice);s.type=FORMAT;s.time=prev.time+prev.dur;s.seqst=true;if(new_sy)s.new_sy=true;prev.ts_next=s;s.ts_prev=prev;while(1){delete prev.eoln;if(prev.seqst)break;prev=prev.ts_prev}}s2=glovar.tempo;if(!s2)return;s=tsfirst.extra;while(s){if(s.type==TEMPO)return;s=s.next}s=tsfirst;s2.v=s.v;s2.st=s.st;s2.time=s.time;if(s.extra){s2.next=s.extra;s2.next.prev=s2}s.extra=s2}function compr_voice(){var p_voice,s,s2,ns,v;function set_feathered_beam(s1){var s,s2,t,d,b,i,a,d=s1.dur,n=1;for(s=s1;s;s=s.next){if(s.beam_end||!s.next)break;n++}if(n<=1){delete s1.feathered_beam;return}s2=s;b=d/2;a=d/(n-1);t=s1.time;if(s1.feathered_beam>0){for(s=s1,i=n-1;s!=s2;s=s.next,i--){d=Math.floor(a*i)+b;s.dur=d;s.time=t;t+=d}}else{for(s=s1,i=0;s!=s2;s=s.next,i++){d=Math.floor(a*i)+b;s.dur=d;s.time=t;t+=d}}s.dur=s.time+s.dur-t;s.time=t}for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(p_voice.ignore)p_voice.ignore=false;for(s=p_voice.sym;s;s=s.next){if(s.time>=staves_found)break}ns=null;for(;s;s=s.next){switch(s.type){case FORMAT:s2=s.extra;if(s2){if(!ns)ns=s2;if(s.prev){s.prev.next=s2;s2.prev=s.prev}if(!s.next){ns=null;break}while(s2.next)s2=s2.next;s.next.prev=s2;s2.next=s.next}case TEMPO:case PART:case TUPLET:case BLOCK:if(!ns)ns=s;continue;case MREST:if(!ns)continue;s2={type:SPACE,width:-1,invisible:true,v:s.v,st:s.st,time:s.time};s2.next=s;s2.prev=s.prev;s2.prev.next=s2;s.prev=s2;s=s2;break}if(s.feathered_beam)set_feathered_beam(s);if(s.grace){if(!ns)ns=s;while(!s.gr_end)s=s.next;s2=clone(s);s2.type=GRACE;s2.dur=0;delete s2.notes;s2.next=s.next;if(s2.next)s2.next.prev=s2;else p_voice.last_sym=s2;s2.prev=s;s.next=s2;s=s2}if(!ns)continue;s.extra=ns;delete s.prev.next;s.prev=ns.prev;if(s.prev)s.prev.next=s;else p_voice.sym=s;delete ns.prev;ns=null}if(ns){s=sym_add(p_voice);s.type=FORMAT;s.extra=ns;delete s.prev.next;s.prev=ns.prev;if(s.prev)s.prev.next=s;else p_voice.sym=s;delete ns.prev}}}function dupl_voice(){var p_voice,p_voice2,s,s2,g,g2,v,i;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];p_voice2=p_voice.clone;if(!p_voice2)continue;p_voice.clone=null;for(s=p_voice.sym;s;s=s.next){if(s.time>=staves_found)break}p_voice2.clef=clone(p_voice.clef);curvoice=p_voice2;for(;s;s=s.next){s2=clone(s);if(s.notes){s2.notes=[];for(i=0;i<=s.nhd;i++)s2.notes.push(clone(s.notes[i]))}sym_link(s2);if(p_voice2.second)s2.second=true;else delete s2.second;if(p_voice2.floating)s2.floating=true;else delete s2.floating;delete s2.a_ly;g=s2.extra;if(!g)continue;g2=clone(g);s2.extra=g2;s2=g2;s2.v=v;s2.st=p_voice2.st;for(g=g.next;g;g=g.next){g2=clone(g);if(g.notes){g2.notes=[];for(i=0;i<=g.nhd;i++)g2.notes.push(clone(g.notes[i]))}s2.next=g2;g2.prev=s2;s2=g2;s2.v=v;s2.st=p_voice2.st}}}}function new_system(){var st,v,sy_new={voices:[],staves:[],top_voice:0};if(!par_sy){cur_sy=par_sy=sy_new}else{for(v=0;v<voice_tb.length;v++){st=par_sy.voices[v].st;var sy_staff=par_sy.staves[st];var p_voice=voice_tb[v];if(p_voice.stafflines!=undefined)sy_staff.stafflines=p_voice.stafflines;if(p_voice.staffscale)sy_staff.staffscale=p_voice.staffscale;sy_new.voices[v]=clone(par_sy.voices[v]);sy_new.voices[v].range=-1;delete sy_new.voices[v].second}for(st=0;st<par_sy.staves.length;st++){sy_new.staves[st]=clone(par_sy.staves[st]);sy_new.staves[st].flags=0}par_sy.next=sy_new;par_sy=sy_new}}function go_global_time(s,symsel){var s2,bar_time,seq;if(symsel.bar<=1){if(symsel.bar==1){for(s2=s;s2;s2=s2.ts_next){if(s2.type==BAR&&s2.time!=0)break;
}if(s2.time<voice_tb[cur_sy.top_voice].meter.wmeasure)s=s2}}else{for(;s;s=s.ts_next){if(s.type==BAR&&s.bar_num>=symsel.bar)break}if(!s)return null;if(symsel.seq!=0){seq=symsel.seq;for(s=s.ts_next;s;s=s.ts_next){if(s.type==BAR&&s.bar_num==symsel.bar){if(--seq==0)break}}if(!s)return null}}if(symsel.time==0)return s;bar_time=s.time+symsel.time;while(s.time<bar_time){s=s.ts_next;if(!s)return s}do{s=s.ts_prev}while(!s.seqst);return s}function do_clip(){var s,s2,sy,p_voice,v;s=tsfirst;if(clip_start.bar>0||clip_start.time>0){s=go_global_time(s,clip_start);if(!s){tsfirst=null;return}sy=cur_sy;for(s2=tsfirst;s2!=s;s2=s2.ts_next){if(s2.new_sy)sy=sy.next;switch(s2.type){case CLEF:voice_tb[s2.v].clef=s2;break;case KEY:voice_tb[s2.v].key=clone(s2.as.u.key);break;case METER:voice_tb[s2.v].meter=clone(s2.as.u.meter);break}}cur_sy=sy;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];for(s2=s;s2;s2=s2.ts_next){if(s2.v==v){delete s2.prev;break}}p_voice.sym=s2}tsfirst=s;delete s.ts_prev}s=go_global_time(s,clip_end);if(!s)return;do{s=s.ts_next;if(!s)return}while(!s.seqst);for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];for(s2=s.ts_prev;s2;s2=s2.ts_prev){if(s2.v==v){delete s2.next;break}}if(!s2)p_voice.sym=null}delete s.ts_prev.ts_next}function set_bar_num(){var s,s2,s3,tim,v=cur_sy.top_voice,wmeasure=voice_tb[v].meter.wmeasure,bar_rep=gene.nbar;for(s=tsfirst;;s=s.ts_next){if(!s)return;switch(s.type){case METER:case CLEF:case KEY:case FORMAT:case STBRK:continue;case BAR:if(s.bar_num){gene.nbar=s.bar_num;break}if(s.text&&!cfmt.contbarnb){if(s.text[0]=="1"){bar_rep=gene.nbar}else{gene.nbar=bar_rep;s.bar_num=gene.nbar}}break}break}var bar_time=s.time+wmeasure,bar_num=gene.nbar;for(;s;s=s.ts_next){switch(s.type){case CLEF:if(s.new_sy)break;for(s2=s.ts_prev;s2;s2=s2.ts_prev){if(s2.new_sy){s2=undefined;break}switch(s2.type){case BAR:if(s2.seqst)break;continue;case MREST:case NOTE:case REST:case SPACE:case STBRK:case TUPLET:s2=undefined;break;default:continue}break}if(!s2)break;s.next.prev=s.prev;s.prev.next=s.next;s.ts_next.ts_prev=s.ts_prev;s.ts_prev.ts_next=s.ts_next;s.next=s2;s.prev=s2.prev;s.prev.next=s;s2.prev=s;s.ts_next=s2;s.ts_prev=s2.ts_prev;s.ts_prev.ts_next=s;s2.ts_prev=s;s3=s.extra;if(s3){if(s.ts_next.extra){while(s3.next)s3=s3.next;s3.next=s.ts_next.extra;s.ts_next.extra=s.extra}else{s.ts_next.extra=s3}s.extra=undefined}s=s2;break;case METER:wmeasure=s.wmeasure;if(s.time<bar_time)bar_time=s.time+wmeasure;break;case MREST:bar_num+=s.nmes-1;while(s.ts_next&&s.ts_next.type!=BAR)s=s.ts_next;break;case BAR:if(s.bar_num){bar_num=s.bar_num;if(s.time<bar_time){delete s.bar_num;break}}else{if(s.time<bar_time)break;bar_num++}tim=s.time;s2=s;do{if(s2.type==BAR&&s2.text&&!cfmt.contbarnb){if(s2.text[0]=="1")bar_rep=bar_num;else bar_num=bar_rep;break}s2=s2.next}while(s2&&s2.time==tim);s.bar_num=bar_num;bar_time=s.time+wmeasure;break}}if(cfmt.measurenb<0)gene.nbar=bar_num}function generate(){var v,p_voice;compr_voice();dupl_voice();sort_all();if(!tsfirst)return;set_bar_num();if(!tsfirst)return;output_music();for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];p_voice.time=0;p_voice.sym=p_voice.last_sym=null;p_voice.st=cur_sy.voices[v].st;p_voice.second=cur_sy.voices[v].second;p_voice.clef.time=0;delete p_voice.have_ly;p_voice.hy_st=0;delete p_voice.bar_start;delete p_voice.slur_st;delete p_voice.s_tie;delete p_voice.s_rtie}staves_found=0}function gen_ly(eob){generate();if(info.W){put_words(info.W);delete info.W}if(eob)blk_out()}function key_transp(s_key,transpose){var sf,t;if(transpose>0)t=Math.floor(transpose/3);else t=-Math.floor(-transpose/3);sf=(t&~1)+(t&1)*7+s_key.k_sf;switch((transpose+210)%3){case 1:sf=(sf+4+12*4)%12-4;break;case 2:sf=(sf+7+12*4)%12-7;break;default:sf=(sf+5+12*4)%12-5;break}s_key.k_sf=sf}function set_k_acc(s){var i,j,n,nacc,p_acc,accs=[],pits=[];if(s.k_sf>0){for(nacc=0;nacc<s.k_sf;nacc++){accs[nacc]=1;pits[nacc]=[26,23,27,24,21,25,22][nacc]}}else{for(nacc=0;nacc<-s.k_sf;nacc++){accs[nacc]=-1;pits[nacc]=[22,25,21,24,20,23,26][nacc]}}n=s.k_a_acc.length;for(i=0;i<n;i++){p_acc=s.k_a_acc[i];for(j=0;j<nacc;j++){if(pits[j]==p_acc.pit){accs[j]=p_acc.acc;break}}if(j==nacc){accs[j]=p_acc.acc;pits[j]=p_acc.pit;nacc++}}for(i=0;i<nacc;i++){p_acc=s.k_a_acc[i];if(!p_acc)p_acc=s.k_a_acc[i]={};p_acc.acc=accs[i];p_acc.pit=pits[i]}}function acc_same_pitch(pitch){var i,time;s=curvoice.last_sym;if(!s)return undefined;time=s.time;for(;s;s=s.prev){switch(s.type){case BAR:if(s.time<time)return undefined;while(1){s=s.prev;if(!s)return undefined;if(s.type==NOTE){if(s.time+s.dur==time)break;return undefined}if(s.time<time)return undefined}for(i=0;i<=s.nhd;i++){if(s.notes[i].pit==pitch&&s.notes[i].ti1)return s.notes[i].acc}return undefined;case NOTE:for(i=0;i<=s.nhd;i++){if(s.notes[i].pit==pitch)return s.notes[i].acc}break}}return undefined}const cde2fcg=[0,2,4,-1,1,3,5],cgd2cde=[0,4,1,5,2,6,3],acc2=[-2,-1,3,1,2];function note_transp(s){var i,j,n,d,a,acc,i1,i3,i4,note,m=s.nhd,sf_old=curvoice.okey.k_sf,i2=curvoice.ckey.k_sf-sf_old,dp=cgd2cde[(i2+4*7)%7],t=curvoice.transpose;if(t>0){dp+=Math.floor(t/3/12)*7}else{if(dp!=0)dp-=7;dp-=Math.floor(-t/3/12)*7}for(i=0;i<=m;i++){note=s.notes[i];n=note.pit;note.pit+=dp;note.apit=note.pit;i1=cde2fcg[(n+5+16*7)%7];a=note.acc;if(!a){if(!curvoice.okey.a_acc){if(sf_old>0){if(i1<sf_old-1)a=1}else if(sf_old<0){if(i1>=sf_old+6)a=-1}}else{for(j=0;j<curvoice.okey.a_acc.length;j++){acc=curvoice.okey.a_acc[j];if((n+16*7-acc.pit)%7==0){a=acc.acc;break}}}}i3=i1+i2;if(a&&a!=3)i3+=a*7;i1=(Math.floor((i3+1+21)/7)+2-3+32*5)%5;a=acc2[i1];if(note.acc){}else if(curvoice.ckey.k_none){if(a==3||acc_same_pitch(note.pit))continue}else if(curvoice.ckey.a_acc){i4=cgd2cde[(i3+16*7)%7];for(j=0;j<curvoice.ckey.a_acc.length;j++){if((i4+16*7-curvoice.ckey.a_acc[j].pits)%7==0)break}if(j<curvoice.ckey.a_acc.length)continue}else{continue}i1=note.acc;d=note.micro_d;if(d&&i1!=a){n=note.micro_n;switch(a){case 3:if(n>d/2){n-=d/2;note.micro_n=n;a=i1}else{a=-i1}break;case 2:if(n>d/2){note.pit+=1;note.apit=note.pit;n-=d/2}else{n+=d/2}a=i1;note.micro_n=n;break;case-2:if(n>=d/2){note.pit-=1;note.apit=note.pit;n-=d/2}else{n+=d/2}a=i1;note.micro_n=n;break}}note.acc=a}}function get_staves(cmd,param){var s,p_voice,p_voice2,i,flags,v,st,p_flags,a_flags,range;compr_voice();dupl_voice();var maxtime=0,no_sym=true;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(p_voice.time>maxtime)maxtime=p_voice.time;if(p_voice.sym)no_sym=false}if(no_sym||maxtime==0&&staves_found<0){for(v=0;v<par_sy.voices.length;v++)par_sy.voices[v].range=-1}else if(staves_found!=maxtime){for(v=0;v<par_sy.voices.length;v++){if(par_sy.voices[v].range>=0){curvoice=voice_tb[v];break}}curvoice.time=maxtime;s={type:STAVES};sym_link(s);par_sy.nstaff=nstaff;new_system()}staves_found=maxtime;a_flags=parse_staves(param);if(!a_flags)return;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];delete p_voice.second;delete p_voice.ignore;p_voice.time=maxtime}range=0;par_sy.top_voice=a_flags[0].v;for(i=0;i<a_flags.length;i++){p_flags=a_flags[i];v=p_flags.v;p_voice=voice_tb[v];if(par_sy.voices[v].range>=0){p_voice2=clone(p_voice);par_sy.voices[voice_tb.length]=clone(par_sy.voices[v]);v=voice_tb.length;p_voice2.v=v;p_voice2.sym=p_voice2.last_sym=null;p_voice2.time=maxtime;voice_tb.push(p_voice2);delete p_voice2.clone;while(p_voice.clone)p_voice=p_voice.clone;p_voice.clone=p_voice2;p_voice=p_voice2;p_flags.v=v}par_sy.voices[v].range=range++}if(cmd[1]=="t"){for(i=0;i<a_flags.length;i++){p_flags=a_flags[i];flags=p_flags.flags;if(!(flags&(OPEN_BRACE|OPEN_BRACE2)))continue;if((flags&(OPEN_BRACE|CLOSE_BRACE))==(OPEN_BRACE|CLOSE_BRACE)||(flags&(OPEN_BRACE2|CLOSE_BRACE2))==(OPEN_BRACE2|CLOSE_BRACE2))continue;if(a_flags[i+1].flags!=0)continue;if(flags&OPEN_PARENTH||a_flags[i+2].flags&OPEN_PARENTH)continue;if(a_flags[i+2].flags&(CLOSE_BRACE|CLOSE_BRACE2)){a_flags[i+1].flags|=FL_VOICE}else if(a_flags[i+2].flags==0&&a_flags[i+3].flags&(CLOSE_BRACE|CLOSE_BRACE2)){p_flags.flags|=OPEN_PARENTH;a_flags[i+1].flags|=CLOSE_PARENTH;a_flags[i+2].flags|=OPEN_PARENTH;a_flags[i+3].flags|=CLOSE_PARENTH}}}st=-1;for(i=0;i<a_flags.length;i++){p_flags=a_flags[i];flags=p_flags.flags;if((flags&(OPEN_PARENTH|CLOSE_PARENTH))==(OPEN_PARENTH|CLOSE_PARENTH)){flags&=~(OPEN_PARENTH|CLOSE_PARENTH);p_flags.flags=flags}v=p_flags.v;p_voice=voice_tb[v];if(flags&FL_VOICE){p_voice.floating=true;p_voice.second=true}else{st++;if(!par_sy.staves[st]){par_sy.staves[st]={stafflines:"|||||",staffscale:1}}par_sy.staves[st].flags=0}p_voice.st=p_voice.cst=par_sy.voices[v].st=st;par_sy.staves[st].flags|=flags;if(flags&OPEN_PARENTH){p_voice2=p_voice;while(i<a_flags.length-1){p_flags=a_flags[++i];v=p_flags.v;p_voice=voice_tb[v];if(p_flags.flags&MASTER_VOICE){p_voice2.second=true;p_voice2=p_voice}else{p_voice.second=true}p_voice.st=p_voice.cst=par_sy.voices[v].st=st;if(p_flags.flags&CLOSE_PARENTH)break}par_sy.staves[st].flags|=p_flags.flags}}if(st<0)st=0;par_sy.nstaff=nstaff=st;if(cmd[1]=="c"){for(st=0;st<=nstaff;st++)par_sy.staves[st].flags^=STOP_BAR}for(v=0;v<voice_tb.length;v++){if(par_sy.voices[v].range<0)continue;p_voice=voice_tb[v];par_sy.voices[v].second=p_voice.second;st=p_voice.st;if(st>0&&!p_voice.norepbra&&!(par_sy.staves[st-1].flags&STOP_BAR))p_voice.norepbra=true}curvoice=voice_tb[par_sy.top_voice]}function get_vover(type){function clone_voice(id){var v,p_voice;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(p_voice.id==id)return p_voice}p_voice=clone(curvoice);p_voice.v=voice_tb.length;p_voice.id=id;p_voice.pos=clone(curvoice.pos);p_voice.sym=p_voice.last_sym=null;p_voice.nm=null;p_voice.snm=null;p_voice.lyric_restart=p_voice.lyric_restart=p_voice.lyric_cont=null;voice_tb.push(p_voice);return p_voice}var line=parse.line,p_voice2,p_voice3,range,v,v2,v3;if(curvoice.ignore)return;if(type=="|"||type==")"){curvoice.last_sym.beam_end=true;if(!vover){line.error("Erroneous end of voice overlap");return}if(curvoice.time!=vover.mxtime)line.error("Wrong duration in voice overlay");curvoice=vover.p_voice;vover=null;return}if(type=="("){if(vover){line.error("Voice overlay already started");return}vover={time:curvoice.time};return}if(!curvoice.last_note){line.error("No note before start of voice overlay");return}curvoice.last_note.beam_end=true;p_voice2=curvoice.voice_down;if(!p_voice2){p_voice2=clone_voice(curvoice.id+"o");curvoice.voice_down=p_voice2;p_voice2.time=0;p_voice2.second=true;v2=p_voice2.v;par_sy.voices[v2]={st:curvoice.st,second:true,scale:curvoice.scale,transpose:curvoice.transpose,key:curvoice.key,ckey:curvoice.ckey,okey:curvoice.okey,pos:p_voice2.pos};var f_clone=curvoice.clone!=undefined?1:0;range=par_sy.voices[curvoice.v].range;for(v=0;v<par_sy.voices.length;v++){if(par_sy.voices[v].range>range)par_sy.voices[v].range+=f_clone+1}par_sy.voices[v2].range=range+1;if(f_clone){p_voice3=clone_voice(p_voice2.id+"c");p_voice3.second=true;v3=p_voice3.v;par_sy.voices[v3]={second:true,scale:curvoice.clone.scale,range:range+2};p_voice2.clone=p_voice3}}p_voice2.ulen=curvoice.ulen;if(curvoice.microscale)p_voice2.microscale=curvoice.microscale;if(!vover){vover={bar:true,mxtime:curvoice.time,p_voice:curvoice};var time=p_voice2.time;for(s=curvoice.last_sym;;s=s.prev){if(s.type==BAR||s.time<=time)break}vover.time=s.time}else{if(!vover.p_voice){vover.mxtime=curvoice.time;vover.p_voice=curvoice}else if(curvoice.time!=vover.mxtime){line.error("Wrong duration in voice overlay")}}p_voice2.time=vover.time;curvoice=p_voice2}function is_voice_sig(){if(!curvoice.sym)return true;if(curvoice.time!=0)return false;for(s=curvoice.sym;s;s=s.next){switch(s.type){case TEMPO:case PART:case FORMAT:break;default:return false}}return true}function get_clef(s){if(is_voice_sig()){curvoice.clef=s}else{s2=curvoice.last_sym;if(s2&&s2.prev&&(s2.type==KEY&&!s2.k_none||s2.type==BAR)){for(s3=s2;s3.prev;s3=s3.prev){switch(s3.prev.type){case KEY:case BAR:continue}break}curvoice.last_sym=s3.prev;sym_link(s);s.next=s3;s3.prev=s;curvoice.last_sym=s2}else{sym_link(s)}s.clef_small=true}}function set_voice_param(p_voice){var k;if(cfmt.microscale)p_voice.microscale=cfmt.microscale;if(glovar.stafflines!=undefined&&p_voice.stafflines==undefined)p_voice.stafflines=glovar.stafflines;if(glovar.staffscale)p_voice.staffscale=glovar.staffscale;if(cfmt.transpose&&!p_voice.transpose)p_voice.transpose=cfmt.transpose;for(k in parse.voice_param)p_voice[k]=parse.voice_param[k];if(!p_voice.wmeasure)p_voice.wmeasure=p_voice.meter.wmeasure}function get_key_clef(kc){var v,p_voice,s2,s_key=kc[0],o_key=clone(s_key),s_clef=kc[1];if(s_key.k_sf){if(!s_key.k_exp&&s_key.k_a_acc)set_k_acc(s_key)}if(parse.state==1){if(s_key.k_sf==undefined&&!s_key.k_a_acc)s_key.k_sf=0;if(cfmt.transpose)key_transp(s_key,cfmt.transpose);for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];p_voice.ckey=s_key;p_voice.key=clone(s_key);p_voice.okey=o_key;p_voice.clef=s_clef||clone(glovar.clef);if(s_key.k_none)p_voice.key.k_sf=0}parse.okey=o_key;parse.ckey=s_key;if(s_clef){glovar.clef=s_clef}else{glovar.clef.ctx=s_key.ctx;glovar.clef.istart=s_key.istart;glovar.clef.iend=s_key.iend}vskip(cfmt.topspace);write_heading();reset_gen();gene.nbar=cfmt.measurefirst;return}if(curvoice.transpose)key_transp(s_key,curvoice.transpose);if(s_clef)get_clef(s_clef);if(is_voice_sig()){if(s_key.k_sf!=undefined||s_key.k_a_acc){curvoice.ckey=s_key;curvoice.key=clone(s_key);if(s_key.k_none)curvoice.key.k_sf=0}curvoice.okey=o_key;return}if(s_key.k_sf==undefined&&!s_key.k_a_acc)return;s_key.k_old_sf=curvoice.ckey.k_sf;curvoice.okey=o_key;curvoice.ckey=s_key;s2=curvoice.last_sym;if(s2&&s2.type==METER){curvoice.last_sym=s2.prev;if(!curvoice.last_sym)curvoice.sym=null;sym_link(s_key);s_key.next=s2;s2.prev=s_key;curvoice.last_sym=s2}else{sym_link(s_key)}}function new_voice(id){var p_voice,v,n=voice_tb.length;if(n==1&&voice_tb[0].default){delete voice_tb[0].default;if(!voice_tb[0].last_sym){p_voice=voice_tb[0];p_voice.id=id;return p_voice}}for(v=0;v<n;v++){p_voice=voice_tb[v];if(p_voice.id==id)return p_voice}p_voice={v:v,id:id,pos:clone(cfmt.pos),scale:cfmt.voicescale,combine:cfmt.voicecombine,ulen:glovar.ulen,key:clone(parse.ckey),ckey:clone(parse.ckey),okey:clone(parse.okey),meter:clone(glovar.meter),clef:clone(glovar.clef),hy_st:0};if(cfmt.voicemap)p_voice.map=cfmt.voicemap;if(parse.state==3)set_voice_param(p_voice);voice_tb.push(p_voice);par_sy.voices[v]={range:-1};return p_voice}function init_tune(){nstaff=-1;voice_tb=[];curvoice=null;par_sy=null;new_system();staves_found=-1;parse.voice_param=null;gene={}}function get_voice(text){var s_clef=parse_voice(text),v=curvoice.v;if(par_sy.voices[v].range<0){if(cfmt.alignbars){parse.line.error("V: does not work with %%alignbars")}if(staves_found>=0)curvoice.ignore=true}if(s_clef)get_clef(s_clef)}function goto_tune(){var v,p_voice;if(voice_tb.length==0){curvoice=new_voice("1");curvoice.clef.istart=curvoice.key.istart;curvoice.clef.iend=curvoice.key.iend;nstaff=0;curvoice.time=0;curvoice.default=true}else if(staves_found<0){curvoice=voice_tb[0]}else{curvoice=voice_tb[par_sy.top_voice]}for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];p_voice.ulen=glovar.ulen;if(p_voice.key.k_bagpipe&&p_voice.pos.ste==0)p_voice.pos.ste=SL_BELOW;if(p_voice.key.k_none)p_voice.key.k_sf=0;set_voice_param(p_voice)}if(staves_found<0){nstaff=voice_tb.length-1;for(v=0;v<=nstaff;v++){p_voice=voice_tb[v];p_voice.st=p_voice.cst=v;par_sy.voices[v].st=v;par_sy.voices[v].range=v;par_sy.staves[v]={stafflines:"|||||",staffscale:1}}par_sy.nstaff=nstaff}parse.state=3;if(!curvoice.last_sym&&parse.voice_opts)voice_filter()}function get_lyrics(text,cont){var s,word,p,i,ly;if(curvoice.ignore)return;if(curvoice.pos.voc!=SL_HIDDEN)curvoice.have_ly=true;if(cont){s=curvoice.lyric_cont;if(!s){parse.line.error("+: lyric without music");return}}else{set_font("vocal");if(curvoice.lyric_restart){curvoice.lyric_start=s=curvoice.lyric_restart;curvoice.lyric_restart=null;curvoice.lyric_line=0}else{curvoice.lyric_line++;s=curvoice.lyric_start}if(!s)s=curvoice.sym;if(!s){parse.line.error("w: without music");return}}p=text;i=0;while(1){while(p[i]==" "||p[i]=="	")i++;if(!p[i])break;switch(p[i]){case"|":while(s&&s.type!=BAR)s=s.next;if(!s){parse.line.error("Not enough bar lines for lyric line");return}s=s.next;i++;continue;case"-":word="-\n";break;case"_":word="_\n";break;case"*":word=null;break;default:if(p[i]=="\\"&&i==p.length-1){curvoice.lyric_cont=s;return}word="";while(1){if(!p[i])break;switch(p[i]){case"_":case"*":case"|":i--;case" ":case"	":break;case"~":word+=" ";i++;continue;case"-":word+="\n";break;case"\\":word+=p[++i];i++;continue;default:word+=p[i];i++;continue}break}break}while(s&&(s.type!=NOTE||s.grace))s=s.next;if(!s){parse.line.error("Too many words in lyric line");return}if(word&&s.pos.voc!=SL_HIDDEN){if(word.match(/^\$\d/)){if(word[1]=="0")set_font("vocal");else set_font("u"+word[1]);word=word.slice(2)}ly={t:word,font:gene.curfont,w:strw(word)};if(!s.a_ly)s.a_ly=[];s.a_ly[curvoice.lyric_line]=ly}s=s.next;i++}curvoice.lyric_cont=s}function ly_width(s,wlw){var ly,sz,swfac,align,xx,w,i,j,k,shift,p,a_ly=s.a_ly;align=0;for(i=0;i<a_ly.length;i++){ly=a_ly[i];if(!ly)continue;p=ly.t;w=ly.w;swfac=ly.font.swfac;xx=w+2*cwid(" ")*swfac;if(p[0]>="0"&&p[0]<="9"&&p.length>2||p[1]==":"||p[0]=="("||p[0]==")"){if(p[0]=="("){sz=cwid("(")*swfac}else{j=p.indexOf(" ");gene.curfont=gene.deffont=ly.font;if(j>0)sz=strw(p.slice(0,j));else sz=w}shift=(w-sz+2*cwid(" ")*swfac)*.4;if(shift>20)shift=20;shift+=sz;if(ly.t[0]>="0"&&ly.t[0]<="9"){if(shift>align)align=shift}}else if(p=="-\n"||p=="_\n"){shift=0}else{shift=xx*.4;if(shift>20)shift=20}ly.shift=shift;if(wlw<shift)wlw=shift;xx-=shift;shift=2*cwid(" ")*swfac;for(k=s.next;k;k=k.next){switch(k.type){case NOTE:case REST:if(!k.a_ly||!k.a_ly[i]||k.a_ly[i].w==0)xx-=9;else if(k.a_ly[i].t=="-\n"||k.a_ly[i].t=="_\n")xx-=shift;else break;if(xx<=0)break;continue;case CLEF:case METER:case KEY:xx-=10;continue;default:xx-=5;break}break}if(xx>s.wr)s.wr=xx}if(align>0){for(i=0;i<a_ly.length;i++){ly=a_ly[i];if(ly.t[0]>="0"&&ly.t[0]<="9")ly.shift=align}}return wlw}function draw_lyrics(p_voice,nly,y,incr){var j,l,p,lastx,w,lskip,s,f,ly,lyl,hyflag,lflag,x0,Y,top,font,shift,desc;set_font("vocal");font=gene.curfont;if(incr>0){j=0;y-=font.size;if(y>-cfmt.vocalspace)y=-cfmt.vocalspace}else{top=staff_tb[p_voice.st].topbar;j=nly-1;nly=-1;if(y<top+cfmt.vocalspace-font.size)y=top+cfmt.vocalspace-font.size}desc=font.size*.25;for(;j!=nly;j+=incr){Y=y+desc;if(p_voice.hy_st&1<<j){hyflag=true;p_voice.hy_st&=~(1<<j)}for(s=p_voice.sym;;s=s.next)if(s.type!=CLEF&&s.type!=KEY&&s.type!=METER)break;if(s.prev)lastx=s.prev.x;else tsfirst.x;x0=0;lskip=font.size*1.1;for(;s;s=s.next){if(s.a_ly)ly=s.a_ly[j];else ly=null;if(!ly){switch(s.type){case REST:case MREST:if(lflag){out_wln(lastx+3,Y,x0-lastx);lflag=false;lastx=s.x+s.wr}}continue}if(ly.font!=font){gene.curfont=font=ly.font;if(lskip<font.size*1.1)lskip=font.size*1.1}p=ly.t;w=ly.w;shift=ly.shift;if(hyflag){if(p=="_\n"){p="-\n"}else if(p!="-\n"){out_hyph(lastx,Y,s.x-shift-lastx);hyflag=false;lastx=s.x+s.wr}}if(lflag&&p!="_\n"){out_wln(lastx+3,Y,x0-lastx+3);lflag=false;lastx=s.x+s.wr}if(p=="-\n"||p=="_\n"){if(x0==0&&lastx>s.x-18)lastx=s.x-18;if(p[0]=="-")hyflag=true;else lflag=true;x0=s.x-shift;continue}x0=s.x-shift;l=p.length-1;if(p[l]=="\n"){p=p.slice(0,l);hyflag=true}xy_str(x0,Y,p);lastx=x0+w}if(hyflag){hyflag=false;x0=realwidth-10;if(x0<lastx+10)x0=lastx+10;out_hyph(lastx,Y,x0-lastx);if(cfmt.hyphencont)p_voice.hy_st|=1<<j}for(p_voice.s_next;s;s=s.next){if(s.type==NOTE){if(!s.a_ly)break;ly=s.a_ly[j];if(ly&&ly.t=="_\n"){lflag=true;x0=realwidth-15;if(x0<lastx+12)x0=lastx+12}break}}if(lflag){out_wln(lastx+3,Y,x0-lastx+3);lflag=false}if(incr>0)y-=lskip;else y+=lskip}if(incr>0)y+=lskip;return y}function draw_all_lyrics(){var p_voice,s,v,nly,i,x,y,w,lyst_tb=new Array(nstaff),nly_tb=new Array(voice_tb.length),above_tb=new Array(voice_tb.length),rv_tb=new Array(voice_tb.length),top=0,bot=0,st=-1;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(!p_voice.sym)continue;if(p_voice.st!=st){top=0;bot=0;st=p_voice.st}nly=0;if(p_voice.have_ly){for(s=p_voice.sym;s;s=s.next){var a_ly=s.a_ly;if(!a_ly||!a_ly[0])continue;x=s.x;if(a_ly[0].w!=0){x-=a_ly[0].shift;w=a_ly[0].w}else{w=10}y=y_get(p_voice.st,1,x,w);if(top<y)top=y;y=y_get(p_voice.st,0,x,w);if(bot>y)bot=y;if(nly<a_ly.length)nly=a_ly.length}}else{y=y_get(p_voice.st,1,0,realwidth);if(top<y)top=y;y=y_get(p_voice.st,0,0,realwidth);if(bot>y)bot=y}if(!lyst_tb[st])lyst_tb[st]={};lyst_tb[st].top=top;lyst_tb[st].bot=bot;nly_tb[v]=nly;if(nly==0)continue;if(p_voice.pos.voc!=0)above_tb[v]=p_voice.pos.voc==SL_ABOVE;else if(voice_tb[p_voice.v+1]&&voice_tb[p_voice.v+1].st==st&&voice_tb[p_voice.v+1].have_ly)above_tb[v]=true;else above_tb[v]=false;if(above_tb[v])lyst_tb[st].a=true;else lyst_tb[st].b=true}i=0;for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(!p_voice.sym)continue;if(!p_voice.have_ly)continue;if(above_tb[v]){rv_tb[i++]=v;continue}st=p_voice.st;set_dscale(st);if(nly_tb[v]>0)lyst_tb[st].bot=draw_lyrics(p_voice,nly_tb[v],lyst_tb[st].bot,1)}while(--i>=0){v=rv_tb[i];p_voice=voice_tb[v];st=p_voice.st;set_dscale(st);lyst_tb[st].top=draw_lyrics(p_voice,nly_tb[v],lyst_tb[st].top,-1)}for(v=0;v<voice_tb.length;v++){p_voice=voice_tb[v];if(!p_voice.sym)continue;st=p_voice.st;if(lyst_tb[st].a){top=lyst_tb[st].top+2;for(s=p_voice.sym.next;s;s=s.next){if(s.a_ly){y_set(st,1,s.x-2,10,top)}}}if(lyst_tb[st].b){bot=lyst_tb[st].bot-2;if(nly_tb[p_voice.v]>0){for(s=p_voice.sym.next;s;s=s.next){if(s.a_ly){y_set(st,0,s.x-2,10,bot)}}}else{y_set(st,0,0,realwidth,bot)}}}}function parse_gchord(type){var c,text,line=parse.line;if(type.length>1){text=type.slice(1,-1)}else{text="";while(1){c=line.next_char();if(c==undefined){line.error("No end of guitar chord");return}if(c=='"')break;text+=c}}if(!gchord)gchord=cnv_escape(text);else gchord+="\n"+cnv_escape(text)}function gch_acc(str,c_gch,acc){var i=1,i2;while(1){i=str.indexOf(c_gch,i);if(i<0)break;if(str[i-1]=="\\"){if(i==2||str[i-3]=="/"){str=str.slice(0,i-1)+str.slice(i)}else{str=str.slice(0,i-1)+acc+str.slice(i+1)}}else if(i==1||str[i-2]=="/"){str=str.slice(0,i)+acc+str.slice(i+1)}i++}return str}const note_names="CDEFGAB",latin_names=["Do","R","Mi","Fa","Sol","La","Si"],acc_name=["bb","b","","#","##"];function gch_tr1(p){var new_txt,l,latin,n,i1,i2,i3,i4,ix,a,ip,ip2;latin=0;switch(p[0]){case"A":case"B":n=p.charCodeAt(0)-"A".charCodeAt(0)+5;break;case"C":case"E":case"G":n=p.charCodeAt(0)-"C".charCodeAt(0);break;case"D":if(p[1]=="o"){latin=1;n=0;break}n=1;break;case"F":if(p[1]=="a")latin=1;n=3;break;case"L":latin=1;n=5;break;case"M":latin=1;n=2;break;case"R":latin=1;if(p[1]!="e")latin++;n=1;break;case"S":latin=1;if(p[1]=="o"){latin++;n=4}else{n=6}break;default:return p}a=0;ip=latin+1;if(p[ip]=="#"){a++;ip++;if(p[ip]=="#"){a++;ip++}}else if(p[ip]=="b"){a--;ip++;if(p[ip]=="b"){a--;ip++}}else if(p[ip]=="="){ip++}i2=curvoice.ckey.k_sf-curvoice.okey.k_sf;i3=cde2fcg[n]+i2+a*7;i4=cgd2cde[(i3+16*7)%7];i1=(Math.floor((i3+1+21)/7)+2-3+32*5)%5;if(!latin)new_txt=note_names[i4]+acc_name[i1];else new_txt=latin_names[i4]+acc_name[i1];ip2=p.indexOf("/",ip);if(ip2<0)return new_txt+p.slice(ip);n=note_names.indexOf(p[++ip2]);if(n<0)return new_txt+p.slice(ip);new_txt+=p.slice(ip,ip2);if(p[++ip2]=="#"){a=1;ip2++}else if(p[ip2]=="b"){a=-1;ip2++}else{a=0}i3=cde2fcg[n]+i2+a*7;i4=cgd2cde[(i3+16*7)%7];i1=(Math.floor((i3+1+21)/7)+2-3+32*5)%5;return note_names[i4]+acc_name[i1]+p.slice(ip2)}function gch_transp(s){var gch,p,i=0;while(1){gch=s.a_gch[i++];if(!gch)return;if(gch.type=="g")break}p=gch.text;i=p.indexOf("	");if(i>=0){i++;p=p.slice(0,i)+gch_tr1(p.slice(i))}gch.text=gch_tr1(p,0)}function gch_build(s){if(curvoice.pos.gch==SL_HIDDEN)return;var src,gch,w,xspc,x_abs,y_abs,ix,n,pos=curvoice.pos.gch==SL_BELOW?-1:1,gch_font=get_font("gchord"),ann_font=get_font("annotation"),h_gch=gch_font.size,h_ann=ann_font.size,y_above=0,y_below=0,y_left=0,y_right=0,box=cfmt.gchordbox,sep="\n";s.a_gch=[];src=new scanBuf;src.buffer=gchord;src.index=0;while(1){c=src.char();if(!c)break;gch={text:""};if(sep!="n"&&"^_<>@".indexOf(c)>=0){antype=c;c=src.next_char();if(antype=="@"){x_abs=src.get_float();c=src.char();if(c!=","){error(1,s,'Error in annotation "@"');y_abs=0}else{src.advance();y_abs=src.get_float();c=src.char();if(c==" ")c=src.next_char()}}}else if(sep=="\n"){antype="g"}if(antype=="g"){gch.font=gch_font;gch.box=box}else{gch.font=ann_font}gch.type=antype;switch(antype){default:if(pos<0)break;y_above+=h_gch;if(box)y_above+=2;break;case"^":y_above+=h_ann;break;case"_":break;case"<":y_left+=h_ann*.5;break;case">":y_right+=h_ann*.5;break;case"@":gch.x=x_abs;gch.y=y_abs;y_abs-=h_ann;break}for(;;){switch(c){case"\\":c=src.next_char();if(c=="n")break;gch.text+="\\";default:gch.text+=c;c=src.next_char();continue;case"&":while(1){gch.text+=c;c=src.next_char();switch(c){default:continue;case";":case undefined:case"\n":case"\\":break}break}if(c==";"){gch.text+=c;c=src.next_char();continue}break;case undefined:case";":case"\n":break}break}s.a_gch.push(gch);if(!c)break;sep=c;src.advance()}if(curvoice.transpose)gch_transp(s);const GCHPRE=.4;n=s.a_gch.length;for(ix=0;ix<n;ix++){gch=s.a_gch[ix];if(gch.type=="g"){if(gch.text.indexOf("#"))gch.text=gch_acc(gch.text,"#","");if(gch.text.indexOf("b"))gch.text=gch_acc(gch.text,"b","");if(gch.text.indexOf("="))gch.text=gch_acc(gch.text,"=","")}if(gch.type=="@"&&!user.anno_start)continue;gene.curfont=gch.font;w=strw(gch.text);gch.w=w;switch(gch.type){case"@":break;case"_":xspc=w*GCHPRE;if(xspc>8)xspc=8;gch.x=-xspc;y_below-=h_ann;gch.y=y_below;break;case"^":xspc=w*GCHPRE;if(xspc>8)xspc=8;gch.x=-xspc;y_above-=h_ann;gch.y=y_above;break;default:xspc=w*GCHPRE;if(xspc>8)xspc=8;gch.x=-xspc;if(pos<0){y_below-=h_gch;gch.y=y_below;if(box){y_below-=2;gch.y-=1}}else{y_above-=h_gch;gch.y=y_above;if(box){y_above-=2;gch.y-=1}}break;case"<":gch.x=-(w+6);y_left-=h_ann;gch.y=y_left;break;case">":gch.x=6;y_right-=h_ann;gch.y=y_right;break}}}function draw_gchord(s,gchy_min,gchy_max){var gch,gch2,text,ix,x,y,i,j,box,hbox,xboxl,xboxr,yboxh,yboxl;var w=s.a_gch[0].w,y_above=y_get(s.st,1,s.x-2,w),y_below=y_get(s.st,0,s.x-2,w),n=s.a_gch.length,yav=s.yav||0;for(ix=0;ix<n;ix++){gch=s.a_gch[ix];if(gch.type!="g")continue;gch2=gch;if(gch.y<0)break}if(gch2){if(gch2.y>=0){if(y_above<gchy_max)y_above=gchy_max}else{if(y_below>gchy_min)y_below=gchy_min}}set_dscale(s.st);xboxr=xboxl=s.x;yboxh=-100;yboxl=100;box=0;for(ix=0;ix<n;ix++){gch=s.a_gch[ix];use_font(gch.font);gene.curfont=gene.deffont=gch.font;h=gch.font.size;w=gch.w;x=s.x+gch.x;text=gch.text;switch(gch.type){case"_":y=gch.y+y_below;y_set(s.st,0,x,w,y-h*.2-2);break;case"^":y=gch.y+y_above;y_set(s.st,1,x,w,y+h*.8+2);break;default:hbox=gch.box?3:2;if(gch.y>=0){y=gch.y+y_above;y_set(s.st,true,x,w,y+h+hbox)}else{y=gch.y+y_below;y_set(s.st,false,x,w,y-hbox)}if(gch.box){if(xboxl>x)xboxl=x;w+=x;if(xboxr<w)xboxr=w;if(yboxl>y)yboxl=y;if(yboxh<y+h)yboxh=y+h;box++}i=text.indexOf("	");if(i>=0){x=realwidth;for(var next=s.next;next;next=next.next){switch(next.type){default:continue;case NOTE:case REST:case BAR:x=next.x;break}break}j=2;for(;;){i=text.indexOf("	",i+1);if(i<0)break;j++}var expdx=(x-s.x)/j;x=s.x;if(user.anno_start)user.anno_start("gchord",s.istart,s.iend,x-2,y+h+2,w+4,h+4);i=0;j=i;for(;;){i=text.indexOf("	",j);if(i<0)break;xy_str(x,y+h*.2,text.slice(j,i),"c");x+=expdx;j=i+1}xy_str(x,y+h*.2,text.slice(j),"c");if(user.anno_stop)user.anno_stop("annot",s.istart,s.iend,s.x-2,y+h+2,w+4,h+4);continue}break;case"<":if(s.notes[0].acc)x-=s.notes[0].shac;y=gch.y+yav;break;case">":x+=s.xmx;if(s.dots>0)x+=1.5+3.5*s.dots;y=gch.y+yav;break;case"@":y=gch.y+yav;if(y>0)y_set(s.st,1,x,1,y+h*.8+3);else y_set(s.st,0,x,1,y-h*.2);break}if(user.anno_start)user.anno_start("annot",s.istart,s.iend,x-2,y+h+2,w+4,h+4);xy_str(x,y+h*.2,text);if(user.anno_stop)user.anno_stop("annot",s.istart,s.iend,x-2,y+h+2,w+4,h+4)}if(xboxr!=xboxl){xboxl-=2;w=xboxr-xboxl;h=yboxh-yboxl+3;xybox(xboxl,yboxl-1+h,w,h)}}function psdeco(f,x,y,de){return false}function pshdeco(f,x,y,dd){return false}function psxygl(x,y,gl){return false}abc2svg_init();return this}var Abcdf_Parser=function(){"use strict";function peg$subclass(child,parent){function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor}function peg$SyntaxError(message,expected,found,location){this.message=message;this.expected=expected;this.found=found;this.location=location;this.name="SyntaxError";if(typeof Error.captureStackTrace==="function"){Error.captureStackTrace(this,peg$SyntaxError)}}peg$subclass(peg$SyntaxError,Error);function peg$parse(input){var options=arguments.length>1?arguments[1]:{},parser=this,peg$FAILED={},peg$startRuleFunctions={sequence:peg$parsesequence},peg$startRuleFunction=peg$parsesequence,peg$c0="@",peg$c1={type:"literal",value:"@",description:'"@"'},peg$c2=function(upper,lower){var map={upper:upper};if(lower){map["lower"]=lower[1]}return map},peg$c3="&",peg$c4={type:"literal",value:"&",description:'"&"'},peg$c5="",peg$c6=function(score_fingerings){return{score_fingerings:score_fingerings}},peg$c7="/",peg$c8={type:"literal",value:"/",description:'"/"'},peg$c9=function(orn,alt_orn){var map={first:orn,last:null};if(alt_orn){map.last=alt_orn[1]}return map},peg$c10=function(pf,alt_pf){var map={first:pf,last:null};if(alt_pf){map.last=alt_pf[1]}return map},peg$c11=function(p,alt_p){var map={first:p,last:null};if(alt_p){map.last=alt_p[1]}return map},peg$c12="(",peg$c13={type:"literal",value:"(",description:'"("'},peg$c14=")",peg$c15={type:"literal",value:")",description:'")"'},peg$c16=function(ornaments){ornaments.pop();ornaments.shift();return{ornaments:ornaments}},peg$c17=function(soft,fingering,damper){return{soft:soft,fingering:fingering,damper:damper}},peg$c18="x",peg$c19={type:"literal",value:"x",description:'"x"'},peg$c20=function(soft,damper){var fingering={strike:null,release:null};return{soft:soft,fingering:fingering,damper:damper}},peg$c21=",",peg$c22={type:"literal",value:",",description:'","'},peg$c23=function(strike,release){var map={strike:strike,release:null};if(release){map["release"]=release[1]}return map},peg$c24=function(hand,digit){return{hand:hand,digit:digit}},peg$c25=/^[_\^]/,peg$c26={type:"class",value:"[_^]",description:"[_^]"},peg$c27=/^[pf]/,peg$c28={type:"class",value:"[pf]",description:"[pf]"},peg$c29=/^[<>]/,peg$c30={type:"class",value:"[<>]",description:"[<>]"},peg$c31=/^[1-5]/,peg$c32={type:"class",value:"[1-5]",description:"[1-5]"},peg$currPos=0,peg$savedPos=0,peg$posDetailsCache=[{line:1,column:1,seenCR:false}],peg$maxFailPos=0,peg$maxFailExpected=[],peg$silentFails=0,peg$result;if("startRule"in options){if(!(options.startRule in peg$startRuleFunctions)){throw new Error("Can't start parsing from rule \""+options.startRule+'".')}peg$startRuleFunction=peg$startRuleFunctions[options.startRule]}function text(){return input.substring(peg$savedPos,peg$currPos)}function location(){return peg$computeLocation(peg$savedPos,peg$currPos)}function expected(description){throw peg$buildException(null,[{type:"other",description:description}],input.substring(peg$savedPos,peg$currPos),peg$computeLocation(peg$savedPos,peg$currPos))}function error(message){throw peg$buildException(message,null,input.substring(peg$savedPos,peg$currPos),peg$computeLocation(peg$savedPos,peg$currPos))}function peg$computePosDetails(pos){var details=peg$posDetailsCache[pos],p,ch;if(details){return details}else{p=pos-1;while(!peg$posDetailsCache[p]){p--}details=peg$posDetailsCache[p];details={line:details.line,column:details.column,seenCR:details.seenCR};while(p<pos){ch=input.charAt(p);if(ch==="\n"){if(!details.seenCR){details.line++}details.column=1;details.seenCR=false}else if(ch==="\r"||ch==="\u2028"||ch==="\u2029"){details.line++;details.column=1;details.seenCR=true}else{details.column++;details.seenCR=false}p++}peg$posDetailsCache[pos]=details;return details}}function peg$computeLocation(startPos,endPos){var startPosDetails=peg$computePosDetails(startPos),endPosDetails=peg$computePosDetails(endPos);return{start:{offset:startPos,line:startPosDetails.line,column:startPosDetails.column
},end:{offset:endPos,line:endPosDetails.line,column:endPosDetails.column}}}function peg$fail(expected){if(peg$currPos<peg$maxFailPos){return}if(peg$currPos>peg$maxFailPos){peg$maxFailPos=peg$currPos;peg$maxFailExpected=[]}peg$maxFailExpected.push(expected)}function peg$buildException(message,expected,found,location){function cleanupExpected(expected){var i=1;expected.sort(function(a,b){if(a.description<b.description){return-1}else if(a.description>b.description){return 1}else{return 0}});while(i<expected.length){if(expected[i-1]===expected[i]){expected.splice(i,1)}else{i++}}}function buildMessage(expected,found){function stringEscape(s){function hex(ch){return ch.charCodeAt(0).toString(16).toUpperCase()}return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(ch){return"\\x0"+hex(ch)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(ch){return"\\x"+hex(ch)}).replace(/[\u0100-\u0FFF]/g,function(ch){return"\\u0"+hex(ch)}).replace(/[\u1000-\uFFFF]/g,function(ch){return"\\u"+hex(ch)})}var expectedDescs=new Array(expected.length),expectedDesc,foundDesc,i;for(i=0;i<expected.length;i++){expectedDescs[i]=expected[i].description}expectedDesc=expected.length>1?expectedDescs.slice(0,-1).join(", ")+" or "+expectedDescs[expected.length-1]:expectedDescs[0];foundDesc=found?'"'+stringEscape(found)+'"':"end of input";return"Expected "+expectedDesc+" but "+foundDesc+" found."}if(expected!==null){cleanupExpected(expected)}return new peg$SyntaxError(message!==null?message:buildMessage(expected,found),expected,found,location)}function peg$parsesequence(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$parsestaff();if(s1!==peg$FAILED){s2=peg$currPos;if(input.charCodeAt(peg$currPos)===64){s3=peg$c0;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c1)}}if(s3!==peg$FAILED){s4=peg$parsestaff();if(s4!==peg$FAILED){s3=[s3,s4];s2=s3}else{peg$currPos=s2;s2=peg$FAILED}}else{peg$currPos=s2;s2=peg$FAILED}if(s2===peg$FAILED){s2=null}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c2(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parsestaff(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parseline();if(s1!==peg$FAILED){if(input.charCodeAt(peg$currPos)===38){s2=peg$c3;peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c4)}}if(s2!==peg$FAILED){s3=peg$parsestaff();if(s3!==peg$FAILED){s1=[s1,s2,s3];s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$parseline();if(s0===peg$FAILED){s0=peg$c5}}return s0}function peg$parseline(){var s0,s1,s2;s0=peg$currPos;s1=[];s2=peg$parsescore_fingering();while(s2!==peg$FAILED){s1.push(s2);s2=peg$parsescore_fingering()}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c6(s1)}s0=s1;return s0}function peg$parsescore_fingering(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$parseornamental();if(s1!==peg$FAILED){s2=peg$currPos;if(input.charCodeAt(peg$currPos)===47){s3=peg$c7;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c8)}}if(s3!==peg$FAILED){s4=peg$parseornamental();if(s4!==peg$FAILED){s3=[s3,s4];s2=s3}else{peg$currPos=s2;s2=peg$FAILED}}else{peg$currPos=s2;s2=peg$FAILED}if(s2===peg$FAILED){s2=null}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c9(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parsepedaled_fingering();if(s1!==peg$FAILED){s2=peg$currPos;if(input.charCodeAt(peg$currPos)===47){s3=peg$c7;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c8)}}if(s3!==peg$FAILED){s4=peg$parsepedaled_fingering();if(s4!==peg$FAILED){s3=[s3,s4];s2=s3}else{peg$currPos=s2;s2=peg$FAILED}}else{peg$currPos=s2;s2=peg$FAILED}if(s2===peg$FAILED){s2=null}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c10(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}if(s0===peg$FAILED){s0=peg$currPos;s1=peg$parsepedaling();if(s1!==peg$FAILED){s2=peg$currPos;if(input.charCodeAt(peg$currPos)===47){s3=peg$c7;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c8)}}if(s3!==peg$FAILED){s4=peg$parsepedaling();if(s4!==peg$FAILED){s3=[s3,s4];s2=s3}else{peg$currPos=s2;s2=peg$FAILED}}else{peg$currPos=s2;s2=peg$FAILED}if(s2===peg$FAILED){s2=null}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c11(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}}return s0}function peg$parseornamental(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$currPos;if(input.charCodeAt(peg$currPos)===40){s2=peg$c12;peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c13)}}if(s2!==peg$FAILED){s3=[];s4=peg$parsepedaled_fingering();if(s4!==peg$FAILED){while(s4!==peg$FAILED){s3.push(s4);s4=peg$parsepedaled_fingering()}}else{s3=peg$FAILED}if(s3!==peg$FAILED){if(input.charCodeAt(peg$currPos)===41){s4=peg$c14;peg$currPos++}else{s4=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c15)}}if(s4!==peg$FAILED){s2=[s2,s3,s4];s1=s2}else{peg$currPos=s1;s1=peg$FAILED}}else{peg$currPos=s1;s1=peg$FAILED}}else{peg$currPos=s1;s1=peg$FAILED}if(s1!==peg$FAILED){peg$savedPos=s0;s1=peg$c16(s1)}s0=s1;return s0}function peg$parsepedaled_fingering(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parsesoft();if(s1===peg$FAILED){s1=null}if(s1!==peg$FAILED){s2=peg$parsefingering();if(s2!==peg$FAILED){s3=peg$parsedamper();if(s3===peg$FAILED){s3=null}if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c17(s1,s2,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parsepedaling(){var s0,s1,s2,s3;s0=peg$currPos;s1=peg$parsesoft();if(s1===peg$FAILED){s1=null}if(s1!==peg$FAILED){if(input.charCodeAt(peg$currPos)===120){s2=peg$c18;peg$currPos++}else{s2=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c19)}}if(s2!==peg$FAILED){s3=peg$parsedamper();if(s3===peg$FAILED){s3=null}if(s3!==peg$FAILED){peg$savedPos=s0;s1=peg$c20(s1,s3);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parsefingering(){var s0,s1,s2,s3,s4;s0=peg$currPos;s1=peg$parsefinger();if(s1!==peg$FAILED){s2=peg$currPos;if(input.charCodeAt(peg$currPos)===44){s3=peg$c21;peg$currPos++}else{s3=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c22)}}if(s3!==peg$FAILED){s4=peg$parsefinger();if(s4!==peg$FAILED){s3=[s3,s4];s2=s3}else{peg$currPos=s2;s2=peg$FAILED}}else{peg$currPos=s2;s2=peg$FAILED}if(s2===peg$FAILED){s2=null}if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c23(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parsefinger(){var s0,s1,s2;s0=peg$currPos;s1=peg$parsehand();if(s1===peg$FAILED){s1=null}if(s1!==peg$FAILED){s2=peg$parsedigit();if(s2!==peg$FAILED){peg$savedPos=s0;s1=peg$c24(s1,s2);s0=s1}else{peg$currPos=s0;s0=peg$FAILED}}else{peg$currPos=s0;s0=peg$FAILED}return s0}function peg$parsedamper(){var s0;if(peg$c25.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c26)}}return s0}function peg$parsesoft(){var s0;if(peg$c27.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c28)}}return s0}function peg$parsehand(){var s0;if(peg$c29.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c30)}}return s0}function peg$parsedigit(){var s0;if(peg$c31.test(input.charAt(peg$currPos))){s0=input.charAt(peg$currPos);peg$currPos++}else{s0=peg$FAILED;if(peg$silentFails===0){peg$fail(peg$c32)}}return s0}peg$result=peg$startRuleFunction();if(peg$result!==peg$FAILED&&peg$currPos===input.length){return peg$result}else{if(peg$result!==peg$FAILED&&peg$currPos<input.length){peg$fail({type:"end",description:"end of input"})}throw peg$buildException(null,peg$maxFailExpected,peg$maxFailPos<input.length?input.charAt(peg$maxFailPos):null,peg$maxFailPos<input.length?peg$computeLocation(peg$maxFailPos,peg$maxFailPos+1):peg$computeLocation(peg$maxFailPos,peg$maxFailPos))}}return{SyntaxError:peg$SyntaxError,parse:peg$parse}}();(function(){Downloadify=window.Downloadify={queue:{},uid:(new Date).getTime(),getTextForSave:function(a){var b=Downloadify.queue[a];if(b)return b.getData();return""},getFileNameForSave:function(a){var b=Downloadify.queue[a];if(b)return b.getFilename();return""},getDataTypeForSave:function(a){var b=Downloadify.queue[a];if(b)return b.getDataType();return""},saveComplete:function(a){var b=Downloadify.queue[a];if(b)b.complete();return true},saveCancel:function(a){var b=Downloadify.queue[a];if(b)b.cancel();return true},saveError:function(a){var b=Downloadify.queue[a];if(b)b.error();return true},addToQueue:function(a){Downloadify.queue[a.queue_name]=a},getUID:function(a){if(a.id=="")a.id="downloadify_"+Downloadify.uid++;return a.id}};Downloadify.create=function(a,b){var c=typeof a=="string"?document.getElementById(a):a;return new Downloadify.Container(c,b)};Downloadify.Container=function(d,e){var f=this;f.el=d;f.enabled=true;f.dataCallback=null;f.filenameCallback=null;f.data=null;f.filename=null;var g=function(){f.options=e;if(!f.options.append)f.el.innerHTML="";f.flashContainer=document.createElement("span");f.el.appendChild(f.flashContainer);f.queue_name=Downloadify.getUID(f.flashContainer);if(typeof f.options.filename==="function")f.filenameCallback=f.options.filename;else if(f.options.filename)f.filename=f.options.filename;if(typeof f.options.data==="function")f.dataCallback=f.options.data;else if(f.options.data)f.data=f.options.data;var a={queue_name:f.queue_name,width:f.options.width,height:f.options.height};var b={allowScriptAccess:"always"};var c={id:f.flashContainer.id,name:f.flashContainer.id};if(f.options.enabled===false)f.enabled=false;if(f.options.transparent===true)b.wmode="transparent";if(f.options.downloadImage)a.downloadImage=f.options.downloadImage;swfobject.embedSWF(f.options.swf,f.flashContainer.id,f.options.width,f.options.height,"10",null,a,b,c);Downloadify.addToQueue(f)};f.enable=function(){var a=document.getElementById(f.flashContainer.id);a.setEnabled(true);f.enabled=true};f.disable=function(){var a=document.getElementById(f.flashContainer.id);a.setEnabled(false);f.enabled=false};f.getData=function(){if(!f.enabled)return"";if(f.dataCallback)return f.dataCallback();else if(f.data)return f.data;else return""};f.getFilename=function(){if(f.filenameCallback)return f.filenameCallback();else if(f.filename)return f.filename;else return""};f.getDataType=function(){if(f.options.dataType)return f.options.dataType;return"string"};f.complete=function(){if(typeof f.options.onComplete==="function")f.options.onComplete()};f.cancel=function(){if(typeof f.options.onCancel==="function")f.options.onCancel()};f.error=function(){if(typeof f.options.onError==="function")f.options.onError()};g()};Downloadify.defaultOptions={swf:"media/downloadify.swf",downloadImage:"images/download.png",width:100,height:30,transparent:true,append:false,dataType:"string"}})();if(typeof jQuery!="undefined"){(function($){$.fn.downloadify=function(b){return this.each(function(){b=$.extend({},Downloadify.defaultOptions,b);var a=Downloadify.create(this,b);$(this).data("Downloadify",a)})}})(jQuery)}if(typeof MooTools!="undefined"){Element.implement({downloadify:function(a){a=$merge(Downloadify.defaultOptions,a);return this.store("Downloadify",Downloadify.create(this,a))}})}!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.JSZip=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){"use strict";var _keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";exports.encode=function(input,utf8){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+_keyStr.charAt(enc1)+_keyStr.charAt(enc2)+_keyStr.charAt(enc3)+_keyStr.charAt(enc4)}return output};exports.decode=function(input,utf8){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(i<input.length){enc1=_keyStr.indexOf(input.charAt(i++));enc2=_keyStr.indexOf(input.charAt(i++));enc3=_keyStr.indexOf(input.charAt(i++));enc4=_keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}return output}},{}],2:[function(_dereq_,module,exports){"use strict";function CompressedObject(){this.compressedSize=0;this.uncompressedSize=0;this.crc32=0;this.compressionMethod=null;this.compressedContent=null}CompressedObject.prototype={getContent:function(){return null},getCompressedContent:function(){return null}};module.exports=CompressedObject},{}],3:[function(_dereq_,module,exports){"use strict";exports.STORE={magic:"\x00\x00",compress:function(content,compressionOptions){return content},uncompress:function(content){return content},compressInputType:null,uncompressInputType:null};exports.DEFLATE=_dereq_("./flate")},{"./flate":8}],4:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("./utils");var table=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];module.exports=function crc32(input,crc){if(typeof input==="undefined"||!input.length){return 0}var isArray=utils.getTypeOf(input)!=="string";if(typeof crc=="undefined"){crc=0}var x=0;var y=0;var b=0;crc=crc^-1;for(var i=0,iTop=input.length;i<iTop;i++){b=isArray?input[i]:input.charCodeAt(i);y=(crc^b)&255;x=table[y];crc=crc>>>8^x}return crc^-1}},{"./utils":21}],5:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("./utils");function DataReader(data){this.data=null;this.length=0;this.index=0}DataReader.prototype={checkOffset:function(offset){this.checkIndex(this.index+offset)},checkIndex:function(newIndex){if(this.length<newIndex||newIndex<0){throw new Error("End of data reached (data length = "+this.length+", asked index = "+newIndex+"). Corrupted zip ?")}},setIndex:function(newIndex){this.checkIndex(newIndex);this.index=newIndex},skip:function(n){this.setIndex(this.index+n)},byteAt:function(i){},readInt:function(size){var result=0,i;this.checkOffset(size);for(i=this.index+size-1;i>=this.index;i--){result=(result<<8)+this.byteAt(i)}this.index+=size;return result},readString:function(size){return utils.transformTo("string",this.readData(size))},readData:function(size){},lastIndexOfSignature:function(sig){},readDate:function(){var dostime=this.readInt(4);return new Date((dostime>>25&127)+1980,(dostime>>21&15)-1,dostime>>16&31,dostime>>11&31,dostime>>5&63,(dostime&31)<<1)}};module.exports=DataReader},{"./utils":21}],6:[function(_dereq_,module,exports){"use strict";exports.base64=false;exports.binary=false;exports.dir=false;exports.createFolders=false;exports.date=null;exports.compression=null;exports.compressionOptions=null;exports.comment=null;exports.unixPermissions=null;exports.dosPermissions=null},{}],7:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("./utils");exports.string2binary=function(str){return utils.string2binary(str)};exports.string2Uint8Array=function(str){return utils.transformTo("uint8array",str)};exports.uint8Array2String=function(array){return utils.transformTo("string",array)};exports.string2Blob=function(str){var buffer=utils.transformTo("arraybuffer",str);return utils.arrayBuffer2Blob(buffer)};exports.arrayBuffer2Blob=function(buffer){return utils.arrayBuffer2Blob(buffer)};exports.transformTo=function(outputType,input){return utils.transformTo(outputType,input)};exports.getTypeOf=function(input){return utils.getTypeOf(input)};exports.checkSupport=function(type){return utils.checkSupport(type)};exports.MAX_VALUE_16BITS=utils.MAX_VALUE_16BITS;exports.MAX_VALUE_32BITS=utils.MAX_VALUE_32BITS;exports.pretty=function(str){return utils.pretty(str)};exports.findCompression=function(compressionMethod){return utils.findCompression(compressionMethod)};exports.isRegExp=function(object){return utils.isRegExp(object)}},{"./utils":21}],8:[function(_dereq_,module,exports){"use strict";var USE_TYPEDARRAY=typeof Uint8Array!=="undefined"&&typeof Uint16Array!=="undefined"&&typeof Uint32Array!=="undefined";var pako=_dereq_("pako");exports.uncompressInputType=USE_TYPEDARRAY?"uint8array":"array";exports.compressInputType=USE_TYPEDARRAY?"uint8array":"array";exports.magic="\b\x00";exports.compress=function(input,compressionOptions){return pako.deflateRaw(input,{level:compressionOptions.level||-1})};exports.uncompress=function(input){return pako.inflateRaw(input)}},{pako:24}],9:[function(_dereq_,module,exports){"use strict";var base64=_dereq_("./base64");function JSZip(data,options){if(!(this instanceof JSZip))return new JSZip(data,options);this.files={};this.comment=null;this.root="";if(data){this.load(data,options)}this.clone=function(){var newObj=new JSZip;for(var i in this){if(typeof this[i]!=="function"){newObj[i]=this[i]}}return newObj}}JSZip.prototype=_dereq_("./object");JSZip.prototype.load=_dereq_("./load");JSZip.support=_dereq_("./support");JSZip.defaults=_dereq_("./defaults");JSZip.utils=_dereq_("./deprecatedPublicUtils");JSZip.base64={encode:function(input){return base64.encode(input)},decode:function(input){return base64.decode(input)}};JSZip.compressions=_dereq_("./compressions");module.exports=JSZip},{"./base64":1,"./compressions":3,"./defaults":6,"./deprecatedPublicUtils":7,"./load":10,"./object":13,"./support":17}],10:[function(_dereq_,module,exports){"use strict";var base64=_dereq_("./base64");var ZipEntries=_dereq_("./zipEntries");module.exports=function(data,options){var files,zipEntries,i,input;options=options||{};if(options.base64){data=base64.decode(data)}zipEntries=new ZipEntries(data,options);files=zipEntries.files;for(i=0;i<files.length;i++){input=files[i];this.file(input.fileName,input.decompressed,{binary:true,optimizedBinaryString:true,date:input.date,dir:input.dir,comment:input.fileComment.length?input.fileComment:null,unixPermissions:input.unixPermissions,dosPermissions:input.dosPermissions,createFolders:options.createFolders})}if(zipEntries.zipComment.length){this.comment=zipEntries.zipComment}return this}},{"./base64":1,"./zipEntries":22}],11:[function(_dereq_,module,exports){(function(Buffer){"use strict";module.exports=function(data,encoding){return new Buffer(data,encoding)};module.exports.test=function(b){return Buffer.isBuffer(b)}}).call(this,typeof Buffer!=="undefined"?Buffer:undefined)},{}],12:[function(_dereq_,module,exports){"use strict";var Uint8ArrayReader=_dereq_("./uint8ArrayReader");function NodeBufferReader(data){this.data=data;this.length=this.data.length;this.index=0}NodeBufferReader.prototype=new Uint8ArrayReader;NodeBufferReader.prototype.readData=function(size){this.checkOffset(size);var result=this.data.slice(this.index,this.index+size);this.index+=size;return result};module.exports=NodeBufferReader},{"./uint8ArrayReader":18}],13:[function(_dereq_,module,exports){"use strict";var support=_dereq_("./support");var utils=_dereq_("./utils");var crc32=_dereq_("./crc32");var signature=_dereq_("./signature");var defaults=_dereq_("./defaults");var base64=_dereq_("./base64");var compressions=_dereq_("./compressions");var CompressedObject=_dereq_("./compressedObject");var nodeBuffer=_dereq_("./nodeBuffer");var utf8=_dereq_("./utf8");var StringWriter=_dereq_("./stringWriter");var Uint8ArrayWriter=_dereq_("./uint8ArrayWriter");var getRawData=function(file){if(file._data instanceof CompressedObject){file._data=file._data.getContent();file.options.binary=true;file.options.base64=false;if(utils.getTypeOf(file._data)==="uint8array"){var copy=file._data;file._data=new Uint8Array(copy.length);if(copy.length!==0){file._data.set(copy,0)}}}return file._data};var getBinaryData=function(file){var result=getRawData(file),type=utils.getTypeOf(result);if(type==="string"){if(!file.options.binary){if(support.nodebuffer){return nodeBuffer(result,"utf-8")}}return file.asBinary()}return result};var dataToString=function(asUTF8){var result=getRawData(this);if(result===null||typeof result==="undefined"){return""}if(this.options.base64){result=base64.decode(result)}if(asUTF8&&this.options.binary){result=out.utf8decode(result)}else{result=utils.transformTo("string",result)}if(!asUTF8&&!this.options.binary){result=utils.transformTo("string",out.utf8encode(result))}return result};var ZipObject=function(name,data,options){this.name=name;this.dir=options.dir;this.date=options.date;this.comment=options.comment;this.unixPermissions=options.unixPermissions;this.dosPermissions=options.dosPermissions;this._data=data;this.options=options;this._initialMetadata={dir:options.dir,date:options.date}};ZipObject.prototype={asText:function(){return dataToString.call(this,true)},asBinary:function(){return dataToString.call(this,false)},asNodeBuffer:function(){var result=getBinaryData(this);return utils.transformTo("nodebuffer",result)},asUint8Array:function(){var result=getBinaryData(this);return utils.transformTo("uint8array",result)},asArrayBuffer:function(){return this.asUint8Array().buffer}};var decToHex=function(dec,bytes){var hex="",i;for(i=0;i<bytes;i++){hex+=String.fromCharCode(dec&255);dec=dec>>>8}return hex};var extend=function(){var result={},i,attr;for(i=0;i<arguments.length;i++){for(attr in arguments[i]){if(arguments[i].hasOwnProperty(attr)&&typeof result[attr]==="undefined"){result[attr]=arguments[i][attr]}}}return result};var prepareFileAttrs=function(o){o=o||{};if(o.base64===true&&(o.binary===null||o.binary===undefined)){o.binary=true}o=extend(o,defaults);o.date=o.date||new Date;if(o.compression!==null)o.compression=o.compression.toUpperCase();return o};var fileAdd=function(name,data,o){var dataType=utils.getTypeOf(data),parent;o=prepareFileAttrs(o);if(typeof o.unixPermissions==="string"){o.unixPermissions=parseInt(o.unixPermissions,8)}if(o.unixPermissions&&o.unixPermissions&16384){o.dir=true}if(o.dosPermissions&&o.dosPermissions&16){o.dir=true}if(o.dir){name=forceTrailingSlash(name)}if(o.createFolders&&(parent=parentFolder(name))){folderAdd.call(this,parent,true)}if(o.dir||data===null||typeof data==="undefined"){o.base64=false;o.binary=false;data=null;dataType=null}else if(dataType==="string"){if(o.binary&&!o.base64){if(o.optimizedBinaryString!==true){data=utils.string2binary(data)}}}else{o.base64=false;o.binary=true;if(!dataType&&!(data instanceof CompressedObject)){throw new Error("The data of '"+name+"' is in an unsupported format !")}if(dataType==="arraybuffer"){data=utils.transformTo("uint8array",data)}}var object=new ZipObject(name,data,o);this.files[name]=object;return object};var parentFolder=function(path){if(path.slice(-1)=="/"){path=path.substring(0,path.length-1)}var lastSlash=path.lastIndexOf("/");return lastSlash>0?path.substring(0,lastSlash):""};var forceTrailingSlash=function(path){if(path.slice(-1)!="/"){path+="/"}return path};var folderAdd=function(name,createFolders){createFolders=typeof createFolders!=="undefined"?createFolders:false;name=forceTrailingSlash(name);if(!this.files[name]){fileAdd.call(this,name,null,{dir:true,createFolders:createFolders})}return this.files[name]};var generateCompressedObjectFrom=function(file,compression,compressionOptions){var result=new CompressedObject,content;if(file._data instanceof CompressedObject){result.uncompressedSize=file._data.uncompressedSize;result.crc32=file._data.crc32;if(result.uncompressedSize===0||file.dir){compression=compressions["STORE"];result.compressedContent="";result.crc32=0}else if(file._data.compressionMethod===compression.magic){result.compressedContent=file._data.getCompressedContent()}else{content=file._data.getContent();result.compressedContent=compression.compress(utils.transformTo(compression.compressInputType,content),compressionOptions)}}else{content=getBinaryData(file);if(!content||content.length===0||file.dir){compression=compressions["STORE"];content=""}result.uncompressedSize=content.length;result.crc32=crc32(content);result.compressedContent=compression.compress(utils.transformTo(compression.compressInputType,content),compressionOptions)}result.compressedSize=result.compressedContent.length;result.compressionMethod=compression.magic;return result};var generateUnixExternalFileAttr=function(unixPermissions,isDir){var result=unixPermissions;if(!unixPermissions){result=isDir?16893:33204}return(result&65535)<<16};var generateDosExternalFileAttr=function(dosPermissions,isDir){return(dosPermissions||0)&63};var generateZipParts=function(name,file,compressedObject,offset,platform){var data=compressedObject.compressedContent,utfEncodedFileName=utils.transformTo("string",utf8.utf8encode(file.name)),comment=file.comment||"",utfEncodedComment=utils.transformTo("string",utf8.utf8encode(comment)),useUTF8ForFileName=utfEncodedFileName.length!==file.name.length,useUTF8ForComment=utfEncodedComment.length!==comment.length,o=file.options,dosTime,dosDate,extraFields="",unicodePathExtraField="",unicodeCommentExtraField="",dir,date;if(file._initialMetadata.dir!==file.dir){dir=file.dir}else{dir=o.dir}if(file._initialMetadata.date!==file.date){date=file.date}else{date=o.date}var extFileAttr=0;var versionMadeBy=0;if(dir){extFileAttr|=16}if(platform==="UNIX"){versionMadeBy=798;extFileAttr|=generateUnixExternalFileAttr(file.unixPermissions,dir)}else{versionMadeBy=20;extFileAttr|=generateDosExternalFileAttr(file.dosPermissions,dir)}dosTime=date.getHours();dosTime=dosTime<<6;dosTime=dosTime|date.getMinutes();dosTime=dosTime<<5;dosTime=dosTime|date.getSeconds()/2;dosDate=date.getFullYear()-1980;dosDate=dosDate<<4;dosDate=dosDate|date.getMonth()+1;dosDate=dosDate<<5;dosDate=dosDate|date.getDate();if(useUTF8ForFileName){unicodePathExtraField=decToHex(1,1)+decToHex(crc32(utfEncodedFileName),4)+utfEncodedFileName;extraFields+="up"+decToHex(unicodePathExtraField.length,2)+unicodePathExtraField}if(useUTF8ForComment){unicodeCommentExtraField=decToHex(1,1)+decToHex(this.crc32(utfEncodedComment),4)+utfEncodedComment;extraFields+="uc"+decToHex(unicodeCommentExtraField.length,2)+unicodeCommentExtraField}var header="";header+="\n\x00";header+=useUTF8ForFileName||useUTF8ForComment?"\x00\b":"\x00\x00";header+=compressedObject.compressionMethod;header+=decToHex(dosTime,2);header+=decToHex(dosDate,2);header+=decToHex(compressedObject.crc32,4);header+=decToHex(compressedObject.compressedSize,4);header+=decToHex(compressedObject.uncompressedSize,4);header+=decToHex(utfEncodedFileName.length,2);header+=decToHex(extraFields.length,2);var fileRecord=signature.LOCAL_FILE_HEADER+header+utfEncodedFileName+extraFields;var dirRecord=signature.CENTRAL_FILE_HEADER+decToHex(versionMadeBy,2)+header+decToHex(utfEncodedComment.length,2)+"\x00\x00"+"\x00\x00"+decToHex(extFileAttr,4)+decToHex(offset,4)+utfEncodedFileName+extraFields+utfEncodedComment;return{fileRecord:fileRecord,dirRecord:dirRecord,compressedObject:compressedObject}};var out={load:function(stream,options){throw new Error("Load method is not defined. Is the file jszip-load.js included ?")},filter:function(search){var result=[],filename,relativePath,file,fileClone;for(filename in this.files){if(!this.files.hasOwnProperty(filename)){continue}file=this.files[filename];fileClone=new ZipObject(file.name,file._data,extend(file.options));relativePath=filename.slice(this.root.length,filename.length);if(filename.slice(0,this.root.length)===this.root&&search(relativePath,fileClone)){result.push(fileClone)}}return result},file:function(name,data,o){if(arguments.length===1){if(utils.isRegExp(name)){var regexp=name;return this.filter(function(relativePath,file){return!file.dir&&regexp.test(relativePath)})}else{return this.filter(function(relativePath,file){return!file.dir&&relativePath===name})[0]||null}}else{name=this.root+name;fileAdd.call(this,name,data,o)}return this},folder:function(arg){if(!arg){return this}if(utils.isRegExp(arg)){return this.filter(function(relativePath,file){return file.dir&&arg.test(relativePath)})}var name=this.root+arg;var newFolder=folderAdd.call(this,name);var ret=this.clone();ret.root=newFolder.name;return ret},remove:function(name){name=this.root+name;var file=this.files[name];if(!file){if(name.slice(-1)!="/"){name+="/"}file=this.files[name]}if(file&&!file.dir){delete this.files[name]}else{var kids=this.filter(function(relativePath,file){
return file.name.slice(0,name.length)===name});for(var i=0;i<kids.length;i++){delete this.files[kids[i].name]}}return this},generate:function(options){options=extend(options||{},{base64:true,compression:"STORE",compressionOptions:null,type:"base64",platform:"DOS",comment:null,mimeType:"application/zip"});utils.checkSupport(options.type);if(options.platform==="darwin"||options.platform==="freebsd"||options.platform==="linux"||options.platform==="sunos"){options.platform="UNIX"}if(options.platform==="win32"){options.platform="DOS"}var zipData=[],localDirLength=0,centralDirLength=0,writer,i,utfEncodedComment=utils.transformTo("string",this.utf8encode(options.comment||this.comment||""));for(var name in this.files){if(!this.files.hasOwnProperty(name)){continue}var file=this.files[name];var compressionName=file.options.compression||options.compression.toUpperCase();var compression=compressions[compressionName];if(!compression){throw new Error(compressionName+" is not a valid compression method !")}var compressionOptions=file.options.compressionOptions||options.compressionOptions||{};var compressedObject=generateCompressedObjectFrom.call(this,file,compression,compressionOptions);var zipPart=generateZipParts.call(this,name,file,compressedObject,localDirLength,options.platform);localDirLength+=zipPart.fileRecord.length+compressedObject.compressedSize;centralDirLength+=zipPart.dirRecord.length;zipData.push(zipPart)}var dirEnd="";dirEnd=signature.CENTRAL_DIRECTORY_END+"\x00\x00"+"\x00\x00"+decToHex(zipData.length,2)+decToHex(zipData.length,2)+decToHex(centralDirLength,4)+decToHex(localDirLength,4)+decToHex(utfEncodedComment.length,2)+utfEncodedComment;var typeName=options.type.toLowerCase();if(typeName==="uint8array"||typeName==="arraybuffer"||typeName==="blob"||typeName==="nodebuffer"){writer=new Uint8ArrayWriter(localDirLength+centralDirLength+dirEnd.length)}else{writer=new StringWriter(localDirLength+centralDirLength+dirEnd.length)}for(i=0;i<zipData.length;i++){writer.append(zipData[i].fileRecord);writer.append(zipData[i].compressedObject.compressedContent)}for(i=0;i<zipData.length;i++){writer.append(zipData[i].dirRecord)}writer.append(dirEnd);var zip=writer.finalize();switch(options.type.toLowerCase()){case"uint8array":case"arraybuffer":case"nodebuffer":return utils.transformTo(options.type.toLowerCase(),zip);case"blob":return utils.arrayBuffer2Blob(utils.transformTo("arraybuffer",zip),options.mimeType);case"base64":return options.base64?base64.encode(zip):zip;default:return zip}},crc32:function(input,crc){return crc32(input,crc)},utf8encode:function(string){return utils.transformTo("string",utf8.utf8encode(string))},utf8decode:function(input){return utf8.utf8decode(input)}};module.exports=out},{"./base64":1,"./compressedObject":2,"./compressions":3,"./crc32":4,"./defaults":6,"./nodeBuffer":11,"./signature":14,"./stringWriter":16,"./support":17,"./uint8ArrayWriter":19,"./utf8":20,"./utils":21}],14:[function(_dereq_,module,exports){"use strict";exports.LOCAL_FILE_HEADER="PK";exports.CENTRAL_FILE_HEADER="PK";exports.CENTRAL_DIRECTORY_END="PK";exports.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK";exports.ZIP64_CENTRAL_DIRECTORY_END="PK";exports.DATA_DESCRIPTOR="PK\b"},{}],15:[function(_dereq_,module,exports){"use strict";var DataReader=_dereq_("./dataReader");var utils=_dereq_("./utils");function StringReader(data,optimizedBinaryString){this.data=data;if(!optimizedBinaryString){this.data=utils.string2binary(this.data)}this.length=this.data.length;this.index=0}StringReader.prototype=new DataReader;StringReader.prototype.byteAt=function(i){return this.data.charCodeAt(i)};StringReader.prototype.lastIndexOfSignature=function(sig){return this.data.lastIndexOf(sig)};StringReader.prototype.readData=function(size){this.checkOffset(size);var result=this.data.slice(this.index,this.index+size);this.index+=size;return result};module.exports=StringReader},{"./dataReader":5,"./utils":21}],16:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("./utils");var StringWriter=function(){this.data=[]};StringWriter.prototype={append:function(input){input=utils.transformTo("string",input);this.data.push(input)},finalize:function(){return this.data.join("")}};module.exports=StringWriter},{"./utils":21}],17:[function(_dereq_,module,exports){(function(Buffer){"use strict";exports.base64=true;exports.array=true;exports.string=true;exports.arraybuffer=typeof ArrayBuffer!=="undefined"&&typeof Uint8Array!=="undefined";exports.nodebuffer=typeof Buffer!=="undefined";exports.uint8array=typeof Uint8Array!=="undefined";if(typeof ArrayBuffer==="undefined"){exports.blob=false}else{var buffer=new ArrayBuffer(0);try{exports.blob=new Blob([buffer],{type:"application/zip"}).size===0}catch(e){try{var Builder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;var builder=new Builder;builder.append(buffer);exports.blob=builder.getBlob("application/zip").size===0}catch(e){exports.blob=false}}}}).call(this,typeof Buffer!=="undefined"?Buffer:undefined)},{}],18:[function(_dereq_,module,exports){"use strict";var DataReader=_dereq_("./dataReader");function Uint8ArrayReader(data){if(data){this.data=data;this.length=this.data.length;this.index=0}}Uint8ArrayReader.prototype=new DataReader;Uint8ArrayReader.prototype.byteAt=function(i){return this.data[i]};Uint8ArrayReader.prototype.lastIndexOfSignature=function(sig){var sig0=sig.charCodeAt(0),sig1=sig.charCodeAt(1),sig2=sig.charCodeAt(2),sig3=sig.charCodeAt(3);for(var i=this.length-4;i>=0;--i){if(this.data[i]===sig0&&this.data[i+1]===sig1&&this.data[i+2]===sig2&&this.data[i+3]===sig3){return i}}return-1};Uint8ArrayReader.prototype.readData=function(size){this.checkOffset(size);if(size===0){return new Uint8Array(0)}var result=this.data.subarray(this.index,this.index+size);this.index+=size;return result};module.exports=Uint8ArrayReader},{"./dataReader":5}],19:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("./utils");var Uint8ArrayWriter=function(length){this.data=new Uint8Array(length);this.index=0};Uint8ArrayWriter.prototype={append:function(input){if(input.length!==0){input=utils.transformTo("uint8array",input);this.data.set(input,this.index);this.index+=input.length}},finalize:function(){return this.data}};module.exports=Uint8ArrayWriter},{"./utils":21}],20:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("./utils");var support=_dereq_("./support");var nodeBuffer=_dereq_("./nodeBuffer");var _utf8len=new Array(256);for(var i=0;i<256;i++){_utf8len[i]=i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1}_utf8len[254]=_utf8len[254]=1;var string2buf=function(str){var buf,c,c2,m_pos,i,str_len=str.length,buf_len=0;for(m_pos=0;m_pos<str_len;m_pos++){c=str.charCodeAt(m_pos);if((c&64512)===55296&&m_pos+1<str_len){c2=str.charCodeAt(m_pos+1);if((c2&64512)===56320){c=65536+(c-55296<<10)+(c2-56320);m_pos++}}buf_len+=c<128?1:c<2048?2:c<65536?3:4}if(support.uint8array){buf=new Uint8Array(buf_len)}else{buf=new Array(buf_len)}for(i=0,m_pos=0;i<buf_len;m_pos++){c=str.charCodeAt(m_pos);if((c&64512)===55296&&m_pos+1<str_len){c2=str.charCodeAt(m_pos+1);if((c2&64512)===56320){c=65536+(c-55296<<10)+(c2-56320);m_pos++}}if(c<128){buf[i++]=c}else if(c<2048){buf[i++]=192|c>>>6;buf[i++]=128|c&63}else if(c<65536){buf[i++]=224|c>>>12;buf[i++]=128|c>>>6&63;buf[i++]=128|c&63}else{buf[i++]=240|c>>>18;buf[i++]=128|c>>>12&63;buf[i++]=128|c>>>6&63;buf[i++]=128|c&63}}return buf};var utf8border=function(buf,max){var pos;max=max||buf.length;if(max>buf.length){max=buf.length}pos=max-1;while(pos>=0&&(buf[pos]&192)===128){pos--}if(pos<0){return max}if(pos===0){return max}return pos+_utf8len[buf[pos]]>max?pos:max};var buf2string=function(buf){var str,i,out,c,c_len;var len=buf.length;var utf16buf=new Array(len*2);for(out=0,i=0;i<len;){c=buf[i++];if(c<128){utf16buf[out++]=c;continue}c_len=_utf8len[c];if(c_len>4){utf16buf[out++]=65533;i+=c_len-1;continue}c&=c_len===2?31:c_len===3?15:7;while(c_len>1&&i<len){c=c<<6|buf[i++]&63;c_len--}if(c_len>1){utf16buf[out++]=65533;continue}if(c<65536){utf16buf[out++]=c}else{c-=65536;utf16buf[out++]=55296|c>>10&1023;utf16buf[out++]=56320|c&1023}}if(utf16buf.length!==out){if(utf16buf.subarray){utf16buf=utf16buf.subarray(0,out)}else{utf16buf.length=out}}return utils.applyFromCharCode(utf16buf)};exports.utf8encode=function utf8encode(str){if(support.nodebuffer){return nodeBuffer(str,"utf-8")}return string2buf(str)};exports.utf8decode=function utf8decode(buf){if(support.nodebuffer){return utils.transformTo("nodebuffer",buf).toString("utf-8")}buf=utils.transformTo(support.uint8array?"uint8array":"array",buf);var result=[],k=0,len=buf.length,chunk=65536;while(k<len){var nextBoundary=utf8border(buf,Math.min(k+chunk,len));if(support.uint8array){result.push(buf2string(buf.subarray(k,nextBoundary)))}else{result.push(buf2string(buf.slice(k,nextBoundary)))}k=nextBoundary}return result.join("")}},{"./nodeBuffer":11,"./support":17,"./utils":21}],21:[function(_dereq_,module,exports){"use strict";var support=_dereq_("./support");var compressions=_dereq_("./compressions");var nodeBuffer=_dereq_("./nodeBuffer");exports.string2binary=function(str){var result="";for(var i=0;i<str.length;i++){result+=String.fromCharCode(str.charCodeAt(i)&255)}return result};exports.arrayBuffer2Blob=function(buffer,mimeType){exports.checkSupport("blob");mimeType=mimeType||"application/zip";try{return new Blob([buffer],{type:mimeType})}catch(e){try{var Builder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;var builder=new Builder;builder.append(buffer);return builder.getBlob(mimeType)}catch(e){throw new Error("Bug : can't construct the Blob.")}}};function identity(input){return input}function stringToArrayLike(str,array){for(var i=0;i<str.length;++i){array[i]=str.charCodeAt(i)&255}return array}function arrayLikeToString(array){var chunk=65536;var result=[],len=array.length,type=exports.getTypeOf(array),k=0,canUseApply=true;try{switch(type){case"uint8array":String.fromCharCode.apply(null,new Uint8Array(0));break;case"nodebuffer":String.fromCharCode.apply(null,nodeBuffer(0));break}}catch(e){canUseApply=false}if(!canUseApply){var resultStr="";for(var i=0;i<array.length;i++){resultStr+=String.fromCharCode(array[i])}return resultStr}while(k<len&&chunk>1){try{if(type==="array"||type==="nodebuffer"){result.push(String.fromCharCode.apply(null,array.slice(k,Math.min(k+chunk,len))))}else{result.push(String.fromCharCode.apply(null,array.subarray(k,Math.min(k+chunk,len))))}k+=chunk}catch(e){chunk=Math.floor(chunk/2)}}return result.join("")}exports.applyFromCharCode=arrayLikeToString;function arrayLikeToArrayLike(arrayFrom,arrayTo){for(var i=0;i<arrayFrom.length;i++){arrayTo[i]=arrayFrom[i]}return arrayTo}var transform={};transform["string"]={string:identity,array:function(input){return stringToArrayLike(input,new Array(input.length))},arraybuffer:function(input){return transform["string"]["uint8array"](input).buffer},uint8array:function(input){return stringToArrayLike(input,new Uint8Array(input.length))},nodebuffer:function(input){return stringToArrayLike(input,nodeBuffer(input.length))}};transform["array"]={string:arrayLikeToString,array:identity,arraybuffer:function(input){return new Uint8Array(input).buffer},uint8array:function(input){return new Uint8Array(input)},nodebuffer:function(input){return nodeBuffer(input)}};transform["arraybuffer"]={string:function(input){return arrayLikeToString(new Uint8Array(input))},array:function(input){return arrayLikeToArrayLike(new Uint8Array(input),new Array(input.byteLength))},arraybuffer:identity,uint8array:function(input){return new Uint8Array(input)},nodebuffer:function(input){return nodeBuffer(new Uint8Array(input))}};transform["uint8array"]={string:arrayLikeToString,array:function(input){return arrayLikeToArrayLike(input,new Array(input.length))},arraybuffer:function(input){return input.buffer},uint8array:identity,nodebuffer:function(input){return nodeBuffer(input)}};transform["nodebuffer"]={string:arrayLikeToString,array:function(input){return arrayLikeToArrayLike(input,new Array(input.length))},arraybuffer:function(input){return transform["nodebuffer"]["uint8array"](input).buffer},uint8array:function(input){return arrayLikeToArrayLike(input,new Uint8Array(input.length))},nodebuffer:identity};exports.transformTo=function(outputType,input){if(!input){input=""}if(!outputType){return input}exports.checkSupport(outputType);var inputType=exports.getTypeOf(input);var result=transform[inputType][outputType](input);return result};exports.getTypeOf=function(input){if(typeof input==="string"){return"string"}if(Object.prototype.toString.call(input)==="[object Array]"){return"array"}if(support.nodebuffer&&nodeBuffer.test(input)){return"nodebuffer"}if(support.uint8array&&input instanceof Uint8Array){return"uint8array"}if(support.arraybuffer&&input instanceof ArrayBuffer){return"arraybuffer"}};exports.checkSupport=function(type){var supported=support[type.toLowerCase()];if(!supported){throw new Error(type+" is not supported by this browser")}};exports.MAX_VALUE_16BITS=65535;exports.MAX_VALUE_32BITS=-1;exports.pretty=function(str){var res="",code,i;for(i=0;i<(str||"").length;i++){code=str.charCodeAt(i);res+="\\x"+(code<16?"0":"")+code.toString(16).toUpperCase()}return res};exports.findCompression=function(compressionMethod){for(var method in compressions){if(!compressions.hasOwnProperty(method)){continue}if(compressions[method].magic===compressionMethod){return compressions[method]}}return null};exports.isRegExp=function(object){return Object.prototype.toString.call(object)==="[object RegExp]"}},{"./compressions":3,"./nodeBuffer":11,"./support":17}],22:[function(_dereq_,module,exports){"use strict";var StringReader=_dereq_("./stringReader");var NodeBufferReader=_dereq_("./nodeBufferReader");var Uint8ArrayReader=_dereq_("./uint8ArrayReader");var utils=_dereq_("./utils");var sig=_dereq_("./signature");var ZipEntry=_dereq_("./zipEntry");var support=_dereq_("./support");var jszipProto=_dereq_("./object");function ZipEntries(data,loadOptions){this.files=[];this.loadOptions=loadOptions;if(data){this.load(data)}}ZipEntries.prototype={checkSignature:function(expectedSignature){var signature=this.reader.readString(4);if(signature!==expectedSignature){throw new Error("Corrupted zip or bug : unexpected signature "+"("+utils.pretty(signature)+", expected "+utils.pretty(expectedSignature)+")")}},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2);this.diskWithCentralDirStart=this.reader.readInt(2);this.centralDirRecordsOnThisDisk=this.reader.readInt(2);this.centralDirRecords=this.reader.readInt(2);this.centralDirSize=this.reader.readInt(4);this.centralDirOffset=this.reader.readInt(4);this.zipCommentLength=this.reader.readInt(2);this.zipComment=this.reader.readString(this.zipCommentLength);this.zipComment=jszipProto.utf8decode(this.zipComment)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8);this.versionMadeBy=this.reader.readString(2);this.versionNeeded=this.reader.readInt(2);this.diskNumber=this.reader.readInt(4);this.diskWithCentralDirStart=this.reader.readInt(4);this.centralDirRecordsOnThisDisk=this.reader.readInt(8);this.centralDirRecords=this.reader.readInt(8);this.centralDirSize=this.reader.readInt(8);this.centralDirOffset=this.reader.readInt(8);this.zip64ExtensibleData={};var extraDataSize=this.zip64EndOfCentralSize-44,index=0,extraFieldId,extraFieldLength,extraFieldValue;while(index<extraDataSize){extraFieldId=this.reader.readInt(2);extraFieldLength=this.reader.readInt(4);extraFieldValue=this.reader.readString(extraFieldLength);this.zip64ExtensibleData[extraFieldId]={id:extraFieldId,length:extraFieldLength,value:extraFieldValue}}},readBlockZip64EndOfCentralLocator:function(){this.diskWithZip64CentralDirStart=this.reader.readInt(4);this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8);this.disksCount=this.reader.readInt(4);if(this.disksCount>1){throw new Error("Multi-volumes zip are not supported")}},readLocalFiles:function(){var i,file;for(i=0;i<this.files.length;i++){file=this.files[i];this.reader.setIndex(file.localHeaderOffset);this.checkSignature(sig.LOCAL_FILE_HEADER);file.readLocalPart(this.reader);file.handleUTF8();file.processAttributes()}},readCentralDir:function(){var file;this.reader.setIndex(this.centralDirOffset);while(this.reader.readString(4)===sig.CENTRAL_FILE_HEADER){file=new ZipEntry({zip64:this.zip64},this.loadOptions);file.readCentralPart(this.reader);this.files.push(file)}},readEndOfCentral:function(){var offset=this.reader.lastIndexOfSignature(sig.CENTRAL_DIRECTORY_END);if(offset===-1){var isGarbage=true;try{this.reader.setIndex(0);this.checkSignature(sig.LOCAL_FILE_HEADER);isGarbage=false}catch(e){}if(isGarbage){throw new Error("Can't find end of central directory : is this a zip file ? "+"If it is, see http://stuk.github.io/jszip/documentation/howto/read_zip.html")}else{throw new Error("Corrupted zip : can't find end of central directory")}}this.reader.setIndex(offset);this.checkSignature(sig.CENTRAL_DIRECTORY_END);this.readBlockEndOfCentral();if(this.diskNumber===utils.MAX_VALUE_16BITS||this.diskWithCentralDirStart===utils.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===utils.MAX_VALUE_16BITS||this.centralDirRecords===utils.MAX_VALUE_16BITS||this.centralDirSize===utils.MAX_VALUE_32BITS||this.centralDirOffset===utils.MAX_VALUE_32BITS){this.zip64=true;offset=this.reader.lastIndexOfSignature(sig.ZIP64_CENTRAL_DIRECTORY_LOCATOR);if(offset===-1){throw new Error("Corrupted zip : can't find the ZIP64 end of central directory locator")}this.reader.setIndex(offset);this.checkSignature(sig.ZIP64_CENTRAL_DIRECTORY_LOCATOR);this.readBlockZip64EndOfCentralLocator();this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir);this.checkSignature(sig.ZIP64_CENTRAL_DIRECTORY_END);this.readBlockZip64EndOfCentral()}},prepareReader:function(data){var type=utils.getTypeOf(data);if(type==="string"&&!support.uint8array){this.reader=new StringReader(data,this.loadOptions.optimizedBinaryString)}else if(type==="nodebuffer"){this.reader=new NodeBufferReader(data)}else{this.reader=new Uint8ArrayReader(utils.transformTo("uint8array",data))}},load:function(data){this.prepareReader(data);this.readEndOfCentral();this.readCentralDir();this.readLocalFiles()}};module.exports=ZipEntries},{"./nodeBufferReader":12,"./object":13,"./signature":14,"./stringReader":15,"./support":17,"./uint8ArrayReader":18,"./utils":21,"./zipEntry":23}],23:[function(_dereq_,module,exports){"use strict";var StringReader=_dereq_("./stringReader");var utils=_dereq_("./utils");var CompressedObject=_dereq_("./compressedObject");var jszipProto=_dereq_("./object");var MADE_BY_DOS=0;var MADE_BY_UNIX=3;function ZipEntry(options,loadOptions){this.options=options;this.loadOptions=loadOptions}ZipEntry.prototype={isEncrypted:function(){return(this.bitFlag&1)===1},useUTF8:function(){return(this.bitFlag&2048)===2048},prepareCompressedContent:function(reader,from,length){return function(){var previousIndex=reader.index;reader.setIndex(from);var compressedFileData=reader.readData(length);reader.setIndex(previousIndex);return compressedFileData}},prepareContent:function(reader,from,length,compression,uncompressedSize){return function(){var compressedFileData=utils.transformTo(compression.uncompressInputType,this.getCompressedContent());var uncompressedFileData=compression.uncompress(compressedFileData);if(uncompressedFileData.length!==uncompressedSize){throw new Error("Bug : uncompressed data size mismatch")}return uncompressedFileData}},readLocalPart:function(reader){var compression,localExtraFieldsLength;reader.skip(22);this.fileNameLength=reader.readInt(2);localExtraFieldsLength=reader.readInt(2);this.fileName=reader.readString(this.fileNameLength);reader.skip(localExtraFieldsLength);if(this.compressedSize==-1||this.uncompressedSize==-1){throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory "+"(compressedSize == -1 || uncompressedSize == -1)")}compression=utils.findCompression(this.compressionMethod);if(compression===null){throw new Error("Corrupted zip : compression "+utils.pretty(this.compressionMethod)+" unknown (inner file : "+this.fileName+")")}this.decompressed=new CompressedObject;this.decompressed.compressedSize=this.compressedSize;this.decompressed.uncompressedSize=this.uncompressedSize;this.decompressed.crc32=this.crc32;this.decompressed.compressionMethod=this.compressionMethod;this.decompressed.getCompressedContent=this.prepareCompressedContent(reader,reader.index,this.compressedSize,compression);this.decompressed.getContent=this.prepareContent(reader,reader.index,this.compressedSize,compression,this.uncompressedSize);if(this.loadOptions.checkCRC32){this.decompressed=utils.transformTo("string",this.decompressed.getContent());if(jszipProto.crc32(this.decompressed)!==this.crc32){throw new Error("Corrupted zip : CRC32 mismatch")}}},readCentralPart:function(reader){this.versionMadeBy=reader.readInt(2);this.versionNeeded=reader.readInt(2);this.bitFlag=reader.readInt(2);this.compressionMethod=reader.readString(2);this.date=reader.readDate();this.crc32=reader.readInt(4);this.compressedSize=reader.readInt(4);this.uncompressedSize=reader.readInt(4);this.fileNameLength=reader.readInt(2);this.extraFieldsLength=reader.readInt(2);this.fileCommentLength=reader.readInt(2);this.diskNumberStart=reader.readInt(2);this.internalFileAttributes=reader.readInt(2);this.externalFileAttributes=reader.readInt(4);this.localHeaderOffset=reader.readInt(4);if(this.isEncrypted()){throw new Error("Encrypted zip are not supported")}this.fileName=reader.readString(this.fileNameLength);this.readExtraFields(reader);this.parseZIP64ExtraField(reader);this.fileComment=reader.readString(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null;this.dosPermissions=null;var madeBy=this.versionMadeBy>>8;this.dir=this.externalFileAttributes&16?true:false;if(madeBy===MADE_BY_DOS){this.dosPermissions=this.externalFileAttributes&63}if(madeBy===MADE_BY_UNIX){this.unixPermissions=this.externalFileAttributes>>16&65535}if(!this.dir&&this.fileName.slice(-1)==="/"){this.dir=true}},parseZIP64ExtraField:function(reader){if(!this.extraFields[1]){return}var extraReader=new StringReader(this.extraFields[1].value);if(this.uncompressedSize===utils.MAX_VALUE_32BITS){this.uncompressedSize=extraReader.readInt(8)}if(this.compressedSize===utils.MAX_VALUE_32BITS){this.compressedSize=extraReader.readInt(8)}if(this.localHeaderOffset===utils.MAX_VALUE_32BITS){this.localHeaderOffset=extraReader.readInt(8)}if(this.diskNumberStart===utils.MAX_VALUE_32BITS){this.diskNumberStart=extraReader.readInt(4)}},readExtraFields:function(reader){var start=reader.index,extraFieldId,extraFieldLength,extraFieldValue;this.extraFields=this.extraFields||{};while(reader.index<start+this.extraFieldsLength){extraFieldId=reader.readInt(2);extraFieldLength=reader.readInt(2);extraFieldValue=reader.readString(extraFieldLength);this.extraFields[extraFieldId]={id:extraFieldId,length:extraFieldLength,value:extraFieldValue}}},handleUTF8:function(){if(this.useUTF8()){this.fileName=jszipProto.utf8decode(this.fileName);this.fileComment=jszipProto.utf8decode(this.fileComment)}else{var upath=this.findExtraFieldUnicodePath();if(upath!==null){this.fileName=upath}var ucomment=this.findExtraFieldUnicodeComment();if(ucomment!==null){this.fileComment=ucomment}}},findExtraFieldUnicodePath:function(){var upathField=this.extraFields[28789];if(upathField){var extraReader=new StringReader(upathField.value);if(extraReader.readInt(1)!==1){return null}if(jszipProto.crc32(this.fileName)!==extraReader.readInt(4)){return null}return jszipProto.utf8decode(extraReader.readString(upathField.length-5))}return null},findExtraFieldUnicodeComment:function(){var ucommentField=this.extraFields[25461];if(ucommentField){var extraReader=new StringReader(ucommentField.value);if(extraReader.readInt(1)!==1){return null}if(jszipProto.crc32(this.fileComment)!==extraReader.readInt(4)){return null}return jszipProto.utf8decode(extraReader.readString(ucommentField.length-5))}return null}};module.exports=ZipEntry},{"./compressedObject":2,"./object":13,"./stringReader":15,"./utils":21}],24:[function(_dereq_,module,exports){"use strict";var assign=_dereq_("./lib/utils/common").assign;var deflate=_dereq_("./lib/deflate");var inflate=_dereq_("./lib/inflate");var constants=_dereq_("./lib/zlib/constants");var pako={};assign(pako,deflate,inflate,constants);module.exports=pako},{"./lib/deflate":25,"./lib/inflate":26,"./lib/utils/common":27,"./lib/zlib/constants":30}],25:[function(_dereq_,module,exports){"use strict";var zlib_deflate=_dereq_("./zlib/deflate.js");var utils=_dereq_("./utils/common");var strings=_dereq_("./utils/strings");var msg=_dereq_("./zlib/messages");var zstream=_dereq_("./zlib/zstream");var Z_NO_FLUSH=0;var Z_FINISH=4;var Z_OK=0;var Z_STREAM_END=1;var Z_DEFAULT_COMPRESSION=-1;var Z_DEFAULT_STRATEGY=0;var Z_DEFLATED=8;var Deflate=function(options){this.options=utils.assign({level:Z_DEFAULT_COMPRESSION,method:Z_DEFLATED,chunkSize:16384,windowBits:15,memLevel:8,strategy:Z_DEFAULT_STRATEGY,to:""},options||{});var opt=this.options;if(opt.raw&&opt.windowBits>0){opt.windowBits=-opt.windowBits}else if(opt.gzip&&opt.windowBits>0&&opt.windowBits<16){opt.windowBits+=16}this.err=0;this.msg="";this.ended=false;this.chunks=[];this.strm=new zstream;this.strm.avail_out=0;var status=zlib_deflate.deflateInit2(this.strm,opt.level,opt.method,opt.windowBits,opt.memLevel,opt.strategy);if(status!==Z_OK){throw new Error(msg[status])}if(opt.header){zlib_deflate.deflateSetHeader(this.strm,opt.header)}};Deflate.prototype.push=function(data,mode){var strm=this.strm;var chunkSize=this.options.chunkSize;var status,_mode;if(this.ended){return false}_mode=mode===~~mode?mode:mode===true?Z_FINISH:Z_NO_FLUSH;if(typeof data==="string"){strm.input=strings.string2buf(data)}else{strm.input=data}strm.next_in=0;strm.avail_in=strm.input.length;do{if(strm.avail_out===0){strm.output=new utils.Buf8(chunkSize);strm.next_out=0;strm.avail_out=chunkSize}status=zlib_deflate.deflate(strm,_mode);if(status!==Z_STREAM_END&&status!==Z_OK){this.onEnd(status);this.ended=true;return false}if(strm.avail_out===0||strm.avail_in===0&&_mode===Z_FINISH){if(this.options.to==="string"){this.onData(strings.buf2binstring(utils.shrinkBuf(strm.output,strm.next_out)))}else{this.onData(utils.shrinkBuf(strm.output,strm.next_out))}}}while((strm.avail_in>0||strm.avail_out===0)&&status!==Z_STREAM_END);if(_mode===Z_FINISH){status=zlib_deflate.deflateEnd(this.strm);this.onEnd(status);this.ended=true;return status===Z_OK}return true};Deflate.prototype.onData=function(chunk){this.chunks.push(chunk)};Deflate.prototype.onEnd=function(status){if(status===Z_OK){if(this.options.to==="string"){this.result=this.chunks.join("")}else{this.result=utils.flattenChunks(this.chunks)}}this.chunks=[];this.err=status;this.msg=this.strm.msg};function deflate(input,options){var deflator=new Deflate(options);deflator.push(input,true);if(deflator.err){throw deflator.msg}return deflator.result}function deflateRaw(input,options){options=options||{};options.raw=true;return deflate(input,options)}function gzip(input,options){options=options||{};options.gzip=true;return deflate(input,options)}exports.Deflate=Deflate;exports.deflate=deflate;exports.deflateRaw=deflateRaw;exports.gzip=gzip},{"./utils/common":27,"./utils/strings":28,"./zlib/deflate.js":32,"./zlib/messages":37,"./zlib/zstream":39}],26:[function(_dereq_,module,exports){"use strict";var zlib_inflate=_dereq_("./zlib/inflate.js");var utils=_dereq_("./utils/common");var strings=_dereq_("./utils/strings");var c=_dereq_("./zlib/constants");var msg=_dereq_("./zlib/messages");var zstream=_dereq_("./zlib/zstream");var gzheader=_dereq_("./zlib/gzheader");var Inflate=function(options){this.options=utils.assign({chunkSize:16384,windowBits:0,to:""},options||{});var opt=this.options;if(opt.raw&&opt.windowBits>=0&&opt.windowBits<16){opt.windowBits=-opt.windowBits;if(opt.windowBits===0){opt.windowBits=-15}}if(opt.windowBits>=0&&opt.windowBits<16&&!(options&&options.windowBits)){opt.windowBits+=32}if(opt.windowBits>15&&opt.windowBits<48){if((opt.windowBits&15)===0){opt.windowBits|=15}}this.err=0;this.msg="";this.ended=false;this.chunks=[];this.strm=new zstream;this.strm.avail_out=0;var status=zlib_inflate.inflateInit2(this.strm,opt.windowBits);if(status!==c.Z_OK){throw new Error(msg[status])}this.header=new gzheader;zlib_inflate.inflateGetHeader(this.strm,this.header)};Inflate.prototype.push=function(data,mode){var strm=this.strm;var chunkSize=this.options.chunkSize;var status,_mode;var next_out_utf8,tail,utf8str;if(this.ended){return false}_mode=mode===~~mode?mode:mode===true?c.Z_FINISH:c.Z_NO_FLUSH;if(typeof data==="string"){strm.input=strings.binstring2buf(data)}else{strm.input=data}strm.next_in=0;strm.avail_in=strm.input.length;do{if(strm.avail_out===0){strm.output=new utils.Buf8(chunkSize);strm.next_out=0;strm.avail_out=chunkSize}status=zlib_inflate.inflate(strm,c.Z_NO_FLUSH);if(status!==c.Z_STREAM_END&&status!==c.Z_OK){this.onEnd(status);this.ended=true;return false}if(strm.next_out){if(strm.avail_out===0||status===c.Z_STREAM_END||strm.avail_in===0&&_mode===c.Z_FINISH){if(this.options.to==="string"){next_out_utf8=strings.utf8border(strm.output,strm.next_out);tail=strm.next_out-next_out_utf8;utf8str=strings.buf2string(strm.output,next_out_utf8);strm.next_out=tail;strm.avail_out=chunkSize-tail;if(tail){utils.arraySet(strm.output,strm.output,next_out_utf8,tail,0)}this.onData(utf8str)}else{this.onData(utils.shrinkBuf(strm.output,strm.next_out))}}}}while(strm.avail_in>0&&status!==c.Z_STREAM_END);if(status===c.Z_STREAM_END){_mode=c.Z_FINISH}if(_mode===c.Z_FINISH){status=zlib_inflate.inflateEnd(this.strm);this.onEnd(status);this.ended=true;return status===c.Z_OK}return true};Inflate.prototype.onData=function(chunk){this.chunks.push(chunk)};Inflate.prototype.onEnd=function(status){if(status===c.Z_OK){if(this.options.to==="string"){this.result=this.chunks.join("")}else{this.result=utils.flattenChunks(this.chunks)}}this.chunks=[];this.err=status;this.msg=this.strm.msg};function inflate(input,options){var inflator=new Inflate(options);inflator.push(input,true);if(inflator.err){throw inflator.msg}return inflator.result}function inflateRaw(input,options){options=options||{};options.raw=true;return inflate(input,options)}exports.Inflate=Inflate;exports.inflate=inflate;exports.inflateRaw=inflateRaw;exports.ungzip=inflate},{"./utils/common":27,"./utils/strings":28,"./zlib/constants":30,"./zlib/gzheader":33,"./zlib/inflate.js":35,"./zlib/messages":37,"./zlib/zstream":39}],27:[function(_dereq_,module,exports){"use strict";var TYPED_OK=typeof Uint8Array!=="undefined"&&typeof Uint16Array!=="undefined"&&typeof Int32Array!=="undefined";exports.assign=function(obj){var sources=Array.prototype.slice.call(arguments,1);while(sources.length){var source=sources.shift();if(!source){continue}if(typeof source!=="object"){throw new TypeError(source+"must be non-object")}for(var p in source){if(source.hasOwnProperty(p)){obj[p]=source[p]}}}return obj};exports.shrinkBuf=function(buf,size){if(buf.length===size){return buf}if(buf.subarray){return buf.subarray(0,size)}buf.length=size;return buf};var fnTyped={arraySet:function(dest,src,src_offs,len,dest_offs){if(src.subarray&&dest.subarray){dest.set(src.subarray(src_offs,src_offs+len),dest_offs);return}for(var i=0;i<len;i++){dest[dest_offs+i]=src[src_offs+i]}},flattenChunks:function(chunks){var i,l,len,pos,chunk,result;len=0;for(i=0,l=chunks.length;i<l;i++){len+=chunks[i].length}result=new Uint8Array(len);pos=0;for(i=0,l=chunks.length;i<l;i++){chunk=chunks[i];result.set(chunk,pos);pos+=chunk.length}return result}};var fnUntyped={arraySet:function(dest,src,src_offs,len,dest_offs){for(var i=0;i<len;i++){dest[dest_offs+i]=src[src_offs+i]}},flattenChunks:function(chunks){return[].concat.apply([],chunks);
}};exports.setTyped=function(on){if(on){exports.Buf8=Uint8Array;exports.Buf16=Uint16Array;exports.Buf32=Int32Array;exports.assign(exports,fnTyped)}else{exports.Buf8=Array;exports.Buf16=Array;exports.Buf32=Array;exports.assign(exports,fnUntyped)}};exports.setTyped(TYPED_OK)},{}],28:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("./common");var STR_APPLY_OK=true;var STR_APPLY_UIA_OK=true;try{String.fromCharCode.apply(null,[0])}catch(__){STR_APPLY_OK=false}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(__){STR_APPLY_UIA_OK=false}var _utf8len=new utils.Buf8(256);for(var i=0;i<256;i++){_utf8len[i]=i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1}_utf8len[254]=_utf8len[254]=1;exports.string2buf=function(str){var buf,c,c2,m_pos,i,str_len=str.length,buf_len=0;for(m_pos=0;m_pos<str_len;m_pos++){c=str.charCodeAt(m_pos);if((c&64512)===55296&&m_pos+1<str_len){c2=str.charCodeAt(m_pos+1);if((c2&64512)===56320){c=65536+(c-55296<<10)+(c2-56320);m_pos++}}buf_len+=c<128?1:c<2048?2:c<65536?3:4}buf=new utils.Buf8(buf_len);for(i=0,m_pos=0;i<buf_len;m_pos++){c=str.charCodeAt(m_pos);if((c&64512)===55296&&m_pos+1<str_len){c2=str.charCodeAt(m_pos+1);if((c2&64512)===56320){c=65536+(c-55296<<10)+(c2-56320);m_pos++}}if(c<128){buf[i++]=c}else if(c<2048){buf[i++]=192|c>>>6;buf[i++]=128|c&63}else if(c<65536){buf[i++]=224|c>>>12;buf[i++]=128|c>>>6&63;buf[i++]=128|c&63}else{buf[i++]=240|c>>>18;buf[i++]=128|c>>>12&63;buf[i++]=128|c>>>6&63;buf[i++]=128|c&63}}return buf};function buf2binstring(buf,len){if(len<65537){if(buf.subarray&&STR_APPLY_UIA_OK||!buf.subarray&&STR_APPLY_OK){return String.fromCharCode.apply(null,utils.shrinkBuf(buf,len))}}var result="";for(var i=0;i<len;i++){result+=String.fromCharCode(buf[i])}return result}exports.buf2binstring=function(buf){return buf2binstring(buf,buf.length)};exports.binstring2buf=function(str){var buf=new utils.Buf8(str.length);for(var i=0,len=buf.length;i<len;i++){buf[i]=str.charCodeAt(i)}return buf};exports.buf2string=function(buf,max){var i,out,c,c_len;var len=max||buf.length;var utf16buf=new Array(len*2);for(out=0,i=0;i<len;){c=buf[i++];if(c<128){utf16buf[out++]=c;continue}c_len=_utf8len[c];if(c_len>4){utf16buf[out++]=65533;i+=c_len-1;continue}c&=c_len===2?31:c_len===3?15:7;while(c_len>1&&i<len){c=c<<6|buf[i++]&63;c_len--}if(c_len>1){utf16buf[out++]=65533;continue}if(c<65536){utf16buf[out++]=c}else{c-=65536;utf16buf[out++]=55296|c>>10&1023;utf16buf[out++]=56320|c&1023}}return buf2binstring(utf16buf,out)};exports.utf8border=function(buf,max){var pos;max=max||buf.length;if(max>buf.length){max=buf.length}pos=max-1;while(pos>=0&&(buf[pos]&192)===128){pos--}if(pos<0){return max}if(pos===0){return max}return pos+_utf8len[buf[pos]]>max?pos:max}},{"./common":27}],29:[function(_dereq_,module,exports){"use strict";function adler32(adler,buf,len,pos){var s1=adler&65535|0,s2=adler>>>16&65535|0,n=0;while(len!==0){n=len>2e3?2e3:len;len-=n;do{s1=s1+buf[pos++]|0;s2=s2+s1|0}while(--n);s1%=65521;s2%=65521}return s1|s2<<16|0}module.exports=adler32},{}],30:[function(_dereq_,module,exports){module.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],31:[function(_dereq_,module,exports){"use strict";function makeTable(){var c,table=[];for(var n=0;n<256;n++){c=n;for(var k=0;k<8;k++){c=c&1?3988292384^c>>>1:c>>>1}table[n]=c}return table}var crcTable=makeTable();function crc32(crc,buf,len,pos){var t=crcTable,end=pos+len;crc=crc^-1;for(var i=pos;i<end;i++){crc=crc>>>8^t[(crc^buf[i])&255]}return crc^-1}module.exports=crc32},{}],32:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("../utils/common");var trees=_dereq_("./trees");var adler32=_dereq_("./adler32");var crc32=_dereq_("./crc32");var msg=_dereq_("./messages");var Z_NO_FLUSH=0;var Z_PARTIAL_FLUSH=1;var Z_FULL_FLUSH=3;var Z_FINISH=4;var Z_BLOCK=5;var Z_OK=0;var Z_STREAM_END=1;var Z_STREAM_ERROR=-2;var Z_DATA_ERROR=-3;var Z_BUF_ERROR=-5;var Z_DEFAULT_COMPRESSION=-1;var Z_FILTERED=1;var Z_HUFFMAN_ONLY=2;var Z_RLE=3;var Z_FIXED=4;var Z_DEFAULT_STRATEGY=0;var Z_UNKNOWN=2;var Z_DEFLATED=8;var MAX_MEM_LEVEL=9;var MAX_WBITS=15;var DEF_MEM_LEVEL=8;var LENGTH_CODES=29;var LITERALS=256;var L_CODES=LITERALS+1+LENGTH_CODES;var D_CODES=30;var BL_CODES=19;var HEAP_SIZE=2*L_CODES+1;var MAX_BITS=15;var MIN_MATCH=3;var MAX_MATCH=258;var MIN_LOOKAHEAD=MAX_MATCH+MIN_MATCH+1;var PRESET_DICT=32;var INIT_STATE=42;var EXTRA_STATE=69;var NAME_STATE=73;var COMMENT_STATE=91;var HCRC_STATE=103;var BUSY_STATE=113;var FINISH_STATE=666;var BS_NEED_MORE=1;var BS_BLOCK_DONE=2;var BS_FINISH_STARTED=3;var BS_FINISH_DONE=4;var OS_CODE=3;function err(strm,errorCode){strm.msg=msg[errorCode];return errorCode}function rank(f){return(f<<1)-(f>4?9:0)}function zero(buf){var len=buf.length;while(--len>=0){buf[len]=0}}function flush_pending(strm){var s=strm.state;var len=s.pending;if(len>strm.avail_out){len=strm.avail_out}if(len===0){return}utils.arraySet(strm.output,s.pending_buf,s.pending_out,len,strm.next_out);strm.next_out+=len;s.pending_out+=len;strm.total_out+=len;strm.avail_out-=len;s.pending-=len;if(s.pending===0){s.pending_out=0}}function flush_block_only(s,last){trees._tr_flush_block(s,s.block_start>=0?s.block_start:-1,s.strstart-s.block_start,last);s.block_start=s.strstart;flush_pending(s.strm)}function put_byte(s,b){s.pending_buf[s.pending++]=b}function putShortMSB(s,b){s.pending_buf[s.pending++]=b>>>8&255;s.pending_buf[s.pending++]=b&255}function read_buf(strm,buf,start,size){var len=strm.avail_in;if(len>size){len=size}if(len===0){return 0}strm.avail_in-=len;utils.arraySet(buf,strm.input,strm.next_in,len,start);if(strm.state.wrap===1){strm.adler=adler32(strm.adler,buf,len,start)}else if(strm.state.wrap===2){strm.adler=crc32(strm.adler,buf,len,start)}strm.next_in+=len;strm.total_in+=len;return len}function longest_match(s,cur_match){var chain_length=s.max_chain_length;var scan=s.strstart;var match;var len;var best_len=s.prev_length;var nice_match=s.nice_match;var limit=s.strstart>s.w_size-MIN_LOOKAHEAD?s.strstart-(s.w_size-MIN_LOOKAHEAD):0;var _win=s.window;var wmask=s.w_mask;var prev=s.prev;var strend=s.strstart+MAX_MATCH;var scan_end1=_win[scan+best_len-1];var scan_end=_win[scan+best_len];if(s.prev_length>=s.good_match){chain_length>>=2}if(nice_match>s.lookahead){nice_match=s.lookahead}do{match=cur_match;if(_win[match+best_len]!==scan_end||_win[match+best_len-1]!==scan_end1||_win[match]!==_win[scan]||_win[++match]!==_win[scan+1]){continue}scan+=2;match++;do{}while(_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&_win[++scan]===_win[++match]&&scan<strend);len=MAX_MATCH-(strend-scan);scan=strend-MAX_MATCH;if(len>best_len){s.match_start=cur_match;best_len=len;if(len>=nice_match){break}scan_end1=_win[scan+best_len-1];scan_end=_win[scan+best_len]}}while((cur_match=prev[cur_match&wmask])>limit&&--chain_length!==0);if(best_len<=s.lookahead){return best_len}return s.lookahead}function fill_window(s){var _w_size=s.w_size;var p,n,m,more,str;do{more=s.window_size-s.lookahead-s.strstart;if(s.strstart>=_w_size+(_w_size-MIN_LOOKAHEAD)){utils.arraySet(s.window,s.window,_w_size,_w_size,0);s.match_start-=_w_size;s.strstart-=_w_size;s.block_start-=_w_size;n=s.hash_size;p=n;do{m=s.head[--p];s.head[p]=m>=_w_size?m-_w_size:0}while(--n);n=_w_size;p=n;do{m=s.prev[--p];s.prev[p]=m>=_w_size?m-_w_size:0}while(--n);more+=_w_size}if(s.strm.avail_in===0){break}n=read_buf(s.strm,s.window,s.strstart+s.lookahead,more);s.lookahead+=n;if(s.lookahead+s.insert>=MIN_MATCH){str=s.strstart-s.insert;s.ins_h=s.window[str];s.ins_h=(s.ins_h<<s.hash_shift^s.window[str+1])&s.hash_mask;while(s.insert){s.ins_h=(s.ins_h<<s.hash_shift^s.window[str+MIN_MATCH-1])&s.hash_mask;s.prev[str&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=str;str++;s.insert--;if(s.lookahead+s.insert<MIN_MATCH){break}}}}while(s.lookahead<MIN_LOOKAHEAD&&s.strm.avail_in!==0)}function deflate_stored(s,flush){var max_block_size=65535;if(max_block_size>s.pending_buf_size-5){max_block_size=s.pending_buf_size-5}for(;;){if(s.lookahead<=1){fill_window(s);if(s.lookahead===0&&flush===Z_NO_FLUSH){return BS_NEED_MORE}if(s.lookahead===0){break}}s.strstart+=s.lookahead;s.lookahead=0;var max_start=s.block_start+max_block_size;if(s.strstart===0||s.strstart>=max_start){s.lookahead=s.strstart-max_start;s.strstart=max_start;flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}if(s.strstart-s.block_start>=s.w_size-MIN_LOOKAHEAD){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}s.insert=0;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.strstart>s.block_start){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_NEED_MORE}function deflate_fast(s,flush){var hash_head;var bflush;for(;;){if(s.lookahead<MIN_LOOKAHEAD){fill_window(s);if(s.lookahead<MIN_LOOKAHEAD&&flush===Z_NO_FLUSH){return BS_NEED_MORE}if(s.lookahead===0){break}}hash_head=0;if(s.lookahead>=MIN_MATCH){s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH-1])&s.hash_mask;hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=s.strstart}if(hash_head!==0&&s.strstart-hash_head<=s.w_size-MIN_LOOKAHEAD){s.match_length=longest_match(s,hash_head)}if(s.match_length>=MIN_MATCH){bflush=trees._tr_tally(s,s.strstart-s.match_start,s.match_length-MIN_MATCH);s.lookahead-=s.match_length;if(s.match_length<=s.max_lazy_match&&s.lookahead>=MIN_MATCH){s.match_length--;do{s.strstart++;s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH-1])&s.hash_mask;hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=s.strstart}while(--s.match_length!==0);s.strstart++}else{s.strstart+=s.match_length;s.match_length=0;s.ins_h=s.window[s.strstart];s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+1])&s.hash_mask}}else{bflush=trees._tr_tally(s,0,s.window[s.strstart]);s.lookahead--;s.strstart++}if(bflush){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}s.insert=s.strstart<MIN_MATCH-1?s.strstart:MIN_MATCH-1;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.last_lit){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_BLOCK_DONE}function deflate_slow(s,flush){var hash_head;var bflush;var max_insert;for(;;){if(s.lookahead<MIN_LOOKAHEAD){fill_window(s);if(s.lookahead<MIN_LOOKAHEAD&&flush===Z_NO_FLUSH){return BS_NEED_MORE}if(s.lookahead===0){break}}hash_head=0;if(s.lookahead>=MIN_MATCH){s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH-1])&s.hash_mask;hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=s.strstart}s.prev_length=s.match_length;s.prev_match=s.match_start;s.match_length=MIN_MATCH-1;if(hash_head!==0&&s.prev_length<s.max_lazy_match&&s.strstart-hash_head<=s.w_size-MIN_LOOKAHEAD){s.match_length=longest_match(s,hash_head);if(s.match_length<=5&&(s.strategy===Z_FILTERED||s.match_length===MIN_MATCH&&s.strstart-s.match_start>4096)){s.match_length=MIN_MATCH-1}}if(s.prev_length>=MIN_MATCH&&s.match_length<=s.prev_length){max_insert=s.strstart+s.lookahead-MIN_MATCH;bflush=trees._tr_tally(s,s.strstart-1-s.prev_match,s.prev_length-MIN_MATCH);s.lookahead-=s.prev_length-1;s.prev_length-=2;do{if(++s.strstart<=max_insert){s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+MIN_MATCH-1])&s.hash_mask;hash_head=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h];s.head[s.ins_h]=s.strstart}}while(--s.prev_length!==0);s.match_available=0;s.match_length=MIN_MATCH-1;s.strstart++;if(bflush){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}else if(s.match_available){bflush=trees._tr_tally(s,0,s.window[s.strstart-1]);if(bflush){flush_block_only(s,false)}s.strstart++;s.lookahead--;if(s.strm.avail_out===0){return BS_NEED_MORE}}else{s.match_available=1;s.strstart++;s.lookahead--}}if(s.match_available){bflush=trees._tr_tally(s,0,s.window[s.strstart-1]);s.match_available=0}s.insert=s.strstart<MIN_MATCH-1?s.strstart:MIN_MATCH-1;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.last_lit){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_BLOCK_DONE}function deflate_rle(s,flush){var bflush;var prev;var scan,strend;var _win=s.window;for(;;){if(s.lookahead<=MAX_MATCH){fill_window(s);if(s.lookahead<=MAX_MATCH&&flush===Z_NO_FLUSH){return BS_NEED_MORE}if(s.lookahead===0){break}}s.match_length=0;if(s.lookahead>=MIN_MATCH&&s.strstart>0){scan=s.strstart-1;prev=_win[scan];if(prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]){strend=s.strstart+MAX_MATCH;do{}while(prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&prev===_win[++scan]&&scan<strend);s.match_length=MAX_MATCH-(strend-scan);if(s.match_length>s.lookahead){s.match_length=s.lookahead}}}if(s.match_length>=MIN_MATCH){bflush=trees._tr_tally(s,1,s.match_length-MIN_MATCH);s.lookahead-=s.match_length;s.strstart+=s.match_length;s.match_length=0}else{bflush=trees._tr_tally(s,0,s.window[s.strstart]);s.lookahead--;s.strstart++}if(bflush){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}s.insert=0;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.last_lit){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_BLOCK_DONE}function deflate_huff(s,flush){var bflush;for(;;){if(s.lookahead===0){fill_window(s);if(s.lookahead===0){if(flush===Z_NO_FLUSH){return BS_NEED_MORE}break}}s.match_length=0;bflush=trees._tr_tally(s,0,s.window[s.strstart]);s.lookahead--;s.strstart++;if(bflush){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}}s.insert=0;if(flush===Z_FINISH){flush_block_only(s,true);if(s.strm.avail_out===0){return BS_FINISH_STARTED}return BS_FINISH_DONE}if(s.last_lit){flush_block_only(s,false);if(s.strm.avail_out===0){return BS_NEED_MORE}}return BS_BLOCK_DONE}var Config=function(good_length,max_lazy,nice_length,max_chain,func){this.good_length=good_length;this.max_lazy=max_lazy;this.nice_length=nice_length;this.max_chain=max_chain;this.func=func};var configuration_table;configuration_table=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)];function lm_init(s){s.window_size=2*s.w_size;zero(s.head);s.max_lazy_match=configuration_table[s.level].max_lazy;s.good_match=configuration_table[s.level].good_length;s.nice_match=configuration_table[s.level].nice_length;s.max_chain_length=configuration_table[s.level].max_chain;s.strstart=0;s.block_start=0;s.lookahead=0;s.insert=0;s.match_length=s.prev_length=MIN_MATCH-1;s.match_available=0;s.ins_h=0}function DeflateState(){this.strm=null;this.status=0;this.pending_buf=null;this.pending_buf_size=0;this.pending_out=0;this.pending=0;this.wrap=0;this.gzhead=null;this.gzindex=0;this.method=Z_DEFLATED;this.last_flush=-1;this.w_size=0;this.w_bits=0;this.w_mask=0;this.window=null;this.window_size=0;this.prev=null;this.head=null;this.ins_h=0;this.hash_size=0;this.hash_bits=0;this.hash_mask=0;this.hash_shift=0;this.block_start=0;this.match_length=0;this.prev_match=0;this.match_available=0;this.strstart=0;this.match_start=0;this.lookahead=0;this.prev_length=0;this.max_chain_length=0;this.max_lazy_match=0;this.level=0;this.strategy=0;this.good_match=0;this.nice_match=0;this.dyn_ltree=new utils.Buf16(HEAP_SIZE*2);this.dyn_dtree=new utils.Buf16((2*D_CODES+1)*2);this.bl_tree=new utils.Buf16((2*BL_CODES+1)*2);zero(this.dyn_ltree);zero(this.dyn_dtree);zero(this.bl_tree);this.l_desc=null;this.d_desc=null;this.bl_desc=null;this.bl_count=new utils.Buf16(MAX_BITS+1);this.heap=new utils.Buf16(2*L_CODES+1);zero(this.heap);this.heap_len=0;this.heap_max=0;this.depth=new utils.Buf16(2*L_CODES+1);zero(this.depth);this.l_buf=0;this.lit_bufsize=0;this.last_lit=0;this.d_buf=0;this.opt_len=0;this.static_len=0;this.matches=0;this.insert=0;this.bi_buf=0;this.bi_valid=0}function deflateResetKeep(strm){var s;if(!strm||!strm.state){return err(strm,Z_STREAM_ERROR)}strm.total_in=strm.total_out=0;strm.data_type=Z_UNKNOWN;s=strm.state;s.pending=0;s.pending_out=0;if(s.wrap<0){s.wrap=-s.wrap}s.status=s.wrap?INIT_STATE:BUSY_STATE;strm.adler=s.wrap===2?0:1;s.last_flush=Z_NO_FLUSH;trees._tr_init(s);return Z_OK}function deflateReset(strm){var ret=deflateResetKeep(strm);if(ret===Z_OK){lm_init(strm.state)}return ret}function deflateSetHeader(strm,head){if(!strm||!strm.state){return Z_STREAM_ERROR}if(strm.state.wrap!==2){return Z_STREAM_ERROR}strm.state.gzhead=head;return Z_OK}function deflateInit2(strm,level,method,windowBits,memLevel,strategy){if(!strm){return Z_STREAM_ERROR}var wrap=1;if(level===Z_DEFAULT_COMPRESSION){level=6}if(windowBits<0){wrap=0;windowBits=-windowBits}else if(windowBits>15){wrap=2;windowBits-=16}if(memLevel<1||memLevel>MAX_MEM_LEVEL||method!==Z_DEFLATED||windowBits<8||windowBits>15||level<0||level>9||strategy<0||strategy>Z_FIXED){return err(strm,Z_STREAM_ERROR)}if(windowBits===8){windowBits=9}var s=new DeflateState;strm.state=s;s.strm=strm;s.wrap=wrap;s.gzhead=null;s.w_bits=windowBits;s.w_size=1<<s.w_bits;s.w_mask=s.w_size-1;s.hash_bits=memLevel+7;s.hash_size=1<<s.hash_bits;s.hash_mask=s.hash_size-1;s.hash_shift=~~((s.hash_bits+MIN_MATCH-1)/MIN_MATCH);s.window=new utils.Buf8(s.w_size*2);s.head=new utils.Buf16(s.hash_size);s.prev=new utils.Buf16(s.w_size);s.lit_bufsize=1<<memLevel+6;s.pending_buf_size=s.lit_bufsize*4;s.pending_buf=new utils.Buf8(s.pending_buf_size);s.d_buf=s.lit_bufsize>>1;s.l_buf=(1+2)*s.lit_bufsize;s.level=level;s.strategy=strategy;s.method=method;return deflateReset(strm)}function deflateInit(strm,level){return deflateInit2(strm,level,Z_DEFLATED,MAX_WBITS,DEF_MEM_LEVEL,Z_DEFAULT_STRATEGY)}function deflate(strm,flush){var old_flush,s;var beg,val;if(!strm||!strm.state||flush>Z_BLOCK||flush<0){return strm?err(strm,Z_STREAM_ERROR):Z_STREAM_ERROR}s=strm.state;if(!strm.output||!strm.input&&strm.avail_in!==0||s.status===FINISH_STATE&&flush!==Z_FINISH){return err(strm,strm.avail_out===0?Z_BUF_ERROR:Z_STREAM_ERROR)}s.strm=strm;old_flush=s.last_flush;s.last_flush=flush;if(s.status===INIT_STATE){if(s.wrap===2){strm.adler=0;put_byte(s,31);put_byte(s,139);put_byte(s,8);if(!s.gzhead){put_byte(s,0);put_byte(s,0);put_byte(s,0);put_byte(s,0);put_byte(s,0);put_byte(s,s.level===9?2:s.strategy>=Z_HUFFMAN_ONLY||s.level<2?4:0);put_byte(s,OS_CODE);s.status=BUSY_STATE}else{put_byte(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(!s.gzhead.extra?0:4)+(!s.gzhead.name?0:8)+(!s.gzhead.comment?0:16));put_byte(s,s.gzhead.time&255);put_byte(s,s.gzhead.time>>8&255);put_byte(s,s.gzhead.time>>16&255);put_byte(s,s.gzhead.time>>24&255);put_byte(s,s.level===9?2:s.strategy>=Z_HUFFMAN_ONLY||s.level<2?4:0);put_byte(s,s.gzhead.os&255);if(s.gzhead.extra&&s.gzhead.extra.length){put_byte(s,s.gzhead.extra.length&255);put_byte(s,s.gzhead.extra.length>>8&255)}if(s.gzhead.hcrc){strm.adler=crc32(strm.adler,s.pending_buf,s.pending,0)}s.gzindex=0;s.status=EXTRA_STATE}}else{var header=Z_DEFLATED+(s.w_bits-8<<4)<<8;var level_flags=-1;if(s.strategy>=Z_HUFFMAN_ONLY||s.level<2){level_flags=0}else if(s.level<6){level_flags=1}else if(s.level===6){level_flags=2}else{level_flags=3}header|=level_flags<<6;if(s.strstart!==0){header|=PRESET_DICT}header+=31-header%31;s.status=BUSY_STATE;putShortMSB(s,header);if(s.strstart!==0){putShortMSB(s,strm.adler>>>16);putShortMSB(s,strm.adler&65535)}strm.adler=1}}if(s.status===EXTRA_STATE){if(s.gzhead.extra){beg=s.pending;while(s.gzindex<(s.gzhead.extra.length&65535)){if(s.pending===s.pending_buf_size){if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}flush_pending(strm);beg=s.pending;if(s.pending===s.pending_buf_size){break}}put_byte(s,s.gzhead.extra[s.gzindex]&255);s.gzindex++}if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}if(s.gzindex===s.gzhead.extra.length){s.gzindex=0;s.status=NAME_STATE}}else{s.status=NAME_STATE}}if(s.status===NAME_STATE){if(s.gzhead.name){beg=s.pending;do{if(s.pending===s.pending_buf_size){if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}flush_pending(strm);beg=s.pending;if(s.pending===s.pending_buf_size){val=1;break}}if(s.gzindex<s.gzhead.name.length){val=s.gzhead.name.charCodeAt(s.gzindex++)&255}else{val=0}put_byte(s,val)}while(val!==0);if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}if(val===0){s.gzindex=0;s.status=COMMENT_STATE}}else{s.status=COMMENT_STATE}}if(s.status===COMMENT_STATE){if(s.gzhead.comment){beg=s.pending;do{if(s.pending===s.pending_buf_size){if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}flush_pending(strm);beg=s.pending;if(s.pending===s.pending_buf_size){val=1;break}}if(s.gzindex<s.gzhead.comment.length){val=s.gzhead.comment.charCodeAt(s.gzindex++)&255}else{val=0}put_byte(s,val)}while(val!==0);if(s.gzhead.hcrc&&s.pending>beg){strm.adler=crc32(strm.adler,s.pending_buf,s.pending-beg,beg)}if(val===0){s.status=HCRC_STATE}}else{s.status=HCRC_STATE}}if(s.status===HCRC_STATE){if(s.gzhead.hcrc){if(s.pending+2>s.pending_buf_size){flush_pending(strm)}if(s.pending+2<=s.pending_buf_size){put_byte(s,strm.adler&255);put_byte(s,strm.adler>>8&255);strm.adler=0;s.status=BUSY_STATE}}else{s.status=BUSY_STATE}}if(s.pending!==0){flush_pending(strm);if(strm.avail_out===0){s.last_flush=-1;return Z_OK}}else if(strm.avail_in===0&&rank(flush)<=rank(old_flush)&&flush!==Z_FINISH){return err(strm,Z_BUF_ERROR)}if(s.status===FINISH_STATE&&strm.avail_in!==0){return err(strm,Z_BUF_ERROR)}if(strm.avail_in!==0||s.lookahead!==0||flush!==Z_NO_FLUSH&&s.status!==FINISH_STATE){var bstate=s.strategy===Z_HUFFMAN_ONLY?deflate_huff(s,flush):s.strategy===Z_RLE?deflate_rle(s,flush):configuration_table[s.level].func(s,flush);if(bstate===BS_FINISH_STARTED||bstate===BS_FINISH_DONE){s.status=FINISH_STATE}if(bstate===BS_NEED_MORE||bstate===BS_FINISH_STARTED){if(strm.avail_out===0){s.last_flush=-1}return Z_OK}if(bstate===BS_BLOCK_DONE){if(flush===Z_PARTIAL_FLUSH){trees._tr_align(s)}else if(flush!==Z_BLOCK){trees._tr_stored_block(s,0,0,false);if(flush===Z_FULL_FLUSH){zero(s.head);if(s.lookahead===0){s.strstart=0;s.block_start=0;s.insert=0}}}flush_pending(strm);if(strm.avail_out===0){s.last_flush=-1;return Z_OK}}}if(flush!==Z_FINISH){return Z_OK}if(s.wrap<=0){return Z_STREAM_END}if(s.wrap===2){put_byte(s,strm.adler&255);put_byte(s,strm.adler>>8&255);put_byte(s,strm.adler>>16&255);put_byte(s,strm.adler>>24&255);put_byte(s,strm.total_in&255);put_byte(s,strm.total_in>>8&255);put_byte(s,strm.total_in>>16&255);put_byte(s,strm.total_in>>24&255)}else{putShortMSB(s,strm.adler>>>16);putShortMSB(s,strm.adler&65535)}flush_pending(strm);if(s.wrap>0){s.wrap=-s.wrap}return s.pending!==0?Z_OK:Z_STREAM_END}function deflateEnd(strm){var status;if(!strm||!strm.state){return Z_STREAM_ERROR}status=strm.state.status;if(status!==INIT_STATE&&status!==EXTRA_STATE&&status!==NAME_STATE&&status!==COMMENT_STATE&&status!==HCRC_STATE&&status!==BUSY_STATE&&status!==FINISH_STATE){return err(strm,Z_STREAM_ERROR)}strm.state=null;return status===BUSY_STATE?err(strm,Z_DATA_ERROR):Z_OK}exports.deflateInit=deflateInit;exports.deflateInit2=deflateInit2;exports.deflateReset=deflateReset;exports.deflateResetKeep=deflateResetKeep;exports.deflateSetHeader=deflateSetHeader;exports.deflate=deflate;exports.deflateEnd=deflateEnd;exports.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":27,"./adler32":29,"./crc32":31,"./messages":37,"./trees":38}],33:[function(_dereq_,module,exports){"use strict";function GZheader(){this.text=0;this.time=0;this.xflags=0;this.os=0;this.extra=null;this.extra_len=0;this.name="";this.comment="";this.hcrc=0;this.done=false}module.exports=GZheader},{}],34:[function(_dereq_,module,exports){"use strict";var BAD=30;var TYPE=12;module.exports=function inflate_fast(strm,start){var state;var _in;var last;var _out;var beg;var end;var dmax;var wsize;var whave;var wnext;var window;var hold;var bits;var lcode;var dcode;var lmask;var dmask;var here;var op;var len;var dist;var from;var from_source;var input,output;state=strm.state;_in=strm.next_in;input=strm.input;last=_in+(strm.avail_in-5);_out=strm.next_out;output=strm.output;beg=_out-(start-strm.avail_out);end=_out+(strm.avail_out-257);dmax=state.dmax;wsize=state.wsize;whave=state.whave;wnext=state.wnext;window=state.window;hold=state.hold;bits=state.bits;lcode=state.lencode;dcode=state.distcode;lmask=(1<<state.lenbits)-1;dmask=(1<<state.distbits)-1;top:do{if(bits<15){hold+=input[_in++]<<bits;bits+=8;hold+=input[_in++]<<bits;bits+=8}here=lcode[hold&lmask];dolen:for(;;){op=here>>>24;hold>>>=op;bits-=op;op=here>>>16&255;if(op===0){output[_out++]=here&65535}else if(op&16){len=here&65535;op&=15;if(op){if(bits<op){hold+=input[_in++]<<bits;bits+=8}len+=hold&(1<<op)-1;hold>>>=op;bits-=op}if(bits<15){hold+=input[_in++]<<bits;bits+=8;hold+=input[_in++]<<bits;bits+=8}here=dcode[hold&dmask];dodist:for(;;){op=here>>>24;hold>>>=op;bits-=op;op=here>>>16&255;if(op&16){dist=here&65535;op&=15;if(bits<op){hold+=input[_in++]<<bits;bits+=8;if(bits<op){hold+=input[_in++]<<bits;bits+=8}}dist+=hold&(1<<op)-1;if(dist>dmax){strm.msg="invalid distance too far back";state.mode=BAD;break top}hold>>>=op;bits-=op;op=_out-beg;if(dist>op){op=dist-op;if(op>whave){if(state.sane){strm.msg="invalid distance too far back";state.mode=BAD;break top}}from=0;from_source=window;if(wnext===0){from+=wsize-op;if(op<len){len-=op;do{output[_out++]=window[from++]}while(--op);from=_out-dist;from_source=output}}else if(wnext<op){from+=wsize+wnext-op;op-=wnext;if(op<len){len-=op;do{output[_out++]=window[from++]}while(--op);from=0;if(wnext<len){op=wnext;len-=op;do{output[_out++]=window[from++]}while(--op);from=_out-dist;from_source=output}}}else{from+=wnext-op;if(op<len){len-=op;do{output[_out++]=window[from++]}while(--op);from=_out-dist;from_source=output}}while(len>2){output[_out++]=from_source[from++];output[_out++]=from_source[from++];output[_out++]=from_source[from++];len-=3}if(len){output[_out++]=from_source[from++];if(len>1){output[_out++]=from_source[from++]}}}else{from=_out-dist;do{output[_out++]=output[from++];output[_out++]=output[from++];output[_out++]=output[from++];len-=3}while(len>2);if(len){output[_out++]=output[from++];if(len>1){output[_out++]=output[from++]}}}}else if((op&64)===0){here=dcode[(here&65535)+(hold&(1<<op)-1)];continue dodist}else{strm.msg="invalid distance code";state.mode=BAD;break top}break}}else if((op&64)===0){here=lcode[(here&65535)+(hold&(1<<op)-1)];continue dolen}else if(op&32){state.mode=TYPE;break top}else{strm.msg="invalid literal/length code";state.mode=BAD;break top}break}}while(_in<last&&_out<end);len=bits>>3;_in-=len;bits-=len<<3;hold&=(1<<bits)-1;strm.next_in=_in;strm.next_out=_out;strm.avail_in=_in<last?5+(last-_in):5-(_in-last);strm.avail_out=_out<end?257+(end-_out):257-(_out-end);state.hold=hold;state.bits=bits;return}},{}],35:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("../utils/common");var adler32=_dereq_("./adler32");var crc32=_dereq_("./crc32");var inflate_fast=_dereq_("./inffast");var inflate_table=_dereq_("./inftrees");var CODES=0;var LENS=1;var DISTS=2;var Z_FINISH=4;var Z_BLOCK=5;var Z_TREES=6;var Z_OK=0;var Z_STREAM_END=1;var Z_NEED_DICT=2;var Z_STREAM_ERROR=-2;var Z_DATA_ERROR=-3;var Z_MEM_ERROR=-4;var Z_BUF_ERROR=-5;var Z_DEFLATED=8;var HEAD=1;var FLAGS=2;var TIME=3;var OS=4;var EXLEN=5;var EXTRA=6;var NAME=7;var COMMENT=8;var HCRC=9;var DICTID=10;var DICT=11;var TYPE=12;var TYPEDO=13;var STORED=14;var COPY_=15;var COPY=16;var TABLE=17;var LENLENS=18;var CODELENS=19;var LEN_=20;var LEN=21;var LENEXT=22;var DIST=23;var DISTEXT=24;var MATCH=25;var LIT=26;var CHECK=27;var LENGTH=28;var DONE=29;var BAD=30;var MEM=31;var SYNC=32;var ENOUGH_LENS=852;var ENOUGH_DISTS=592;var MAX_WBITS=15;var DEF_WBITS=MAX_WBITS;function ZSWAP32(q){return(q>>>24&255)+(q>>>8&65280)+((q&65280)<<8)+((q&255)<<24)}function InflateState(){this.mode=0;this.last=false;this.wrap=0;this.havedict=false;this.flags=0;this.dmax=0;this.check=0;this.total=0;this.head=null;this.wbits=0;this.wsize=0;this.whave=0;this.wnext=0;this.window=null;this.hold=0;this.bits=0;this.length=0;this.offset=0;this.extra=0;this.lencode=null;this.distcode=null;this.lenbits=0;this.distbits=0;this.ncode=0;this.nlen=0;this.ndist=0;this.have=0;this.next=null;this.lens=new utils.Buf16(320);this.work=new utils.Buf16(288);this.lendyn=null;this.distdyn=null;this.sane=0;this.back=0;this.was=0}function inflateResetKeep(strm){var state;if(!strm||!strm.state){return Z_STREAM_ERROR}state=strm.state;strm.total_in=strm.total_out=state.total=0;strm.msg="";if(state.wrap){strm.adler=state.wrap&1}state.mode=HEAD;state.last=0;state.havedict=0;state.dmax=32768;state.head=null;state.hold=0;state.bits=0;state.lencode=state.lendyn=new utils.Buf32(ENOUGH_LENS);state.distcode=state.distdyn=new utils.Buf32(ENOUGH_DISTS);state.sane=1;state.back=-1;return Z_OK}function inflateReset(strm){var state;if(!strm||!strm.state){return Z_STREAM_ERROR}state=strm.state;state.wsize=0;state.whave=0;state.wnext=0;return inflateResetKeep(strm)}function inflateReset2(strm,windowBits){var wrap;var state;if(!strm||!strm.state){return Z_STREAM_ERROR}state=strm.state;if(windowBits<0){wrap=0;windowBits=-windowBits}else{wrap=(windowBits>>4)+1;if(windowBits<48){windowBits&=15}}if(windowBits&&(windowBits<8||windowBits>15)){return Z_STREAM_ERROR}if(state.window!==null&&state.wbits!==windowBits){state.window=null}state.wrap=wrap;state.wbits=windowBits;return inflateReset(strm)}function inflateInit2(strm,windowBits){var ret;var state;if(!strm){return Z_STREAM_ERROR}state=new InflateState;strm.state=state;state.window=null;ret=inflateReset2(strm,windowBits);if(ret!==Z_OK){strm.state=null}return ret}function inflateInit(strm){return inflateInit2(strm,DEF_WBITS)}var virgin=true;var lenfix,distfix;function fixedtables(state){if(virgin){var sym;lenfix=new utils.Buf32(512);distfix=new utils.Buf32(32);sym=0;while(sym<144){state.lens[sym++]=8}while(sym<256){state.lens[sym++]=9}while(sym<280){state.lens[sym++]=7}while(sym<288){state.lens[sym++]=8}inflate_table(LENS,state.lens,0,288,lenfix,0,state.work,{bits:9});sym=0;while(sym<32){state.lens[sym++]=5}inflate_table(DISTS,state.lens,0,32,distfix,0,state.work,{bits:5});virgin=false}state.lencode=lenfix;state.lenbits=9;state.distcode=distfix;state.distbits=5}function updatewindow(strm,src,end,copy){var dist;var state=strm.state;if(state.window===null){state.wsize=1<<state.wbits;state.wnext=0;state.whave=0;state.window=new utils.Buf8(state.wsize)}if(copy>=state.wsize){utils.arraySet(state.window,src,end-state.wsize,state.wsize,0);state.wnext=0;state.whave=state.wsize}else{dist=state.wsize-state.wnext;if(dist>copy){dist=copy}utils.arraySet(state.window,src,end-copy,dist,state.wnext);copy-=dist;if(copy){utils.arraySet(state.window,src,end-copy,copy,0);state.wnext=copy;state.whave=state.wsize}else{state.wnext+=dist;if(state.wnext===state.wsize){state.wnext=0}if(state.whave<state.wsize){state.whave+=dist}}}return 0}function inflate(strm,flush){var state;var input,output;var next;var put;
var have,left;var hold;var bits;var _in,_out;var copy;var from;var from_source;var here=0;var here_bits,here_op,here_val;var last_bits,last_op,last_val;var len;var ret;var hbuf=new utils.Buf8(4);var opts;var n;var order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!strm||!strm.state||!strm.output||!strm.input&&strm.avail_in!==0){return Z_STREAM_ERROR}state=strm.state;if(state.mode===TYPE){state.mode=TYPEDO}put=strm.next_out;output=strm.output;left=strm.avail_out;next=strm.next_in;input=strm.input;have=strm.avail_in;hold=state.hold;bits=state.bits;_in=have;_out=left;ret=Z_OK;inf_leave:for(;;){switch(state.mode){case HEAD:if(state.wrap===0){state.mode=TYPEDO;break}while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(state.wrap&2&&hold===35615){state.check=0;hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;state.check=crc32(state.check,hbuf,2,0);hold=0;bits=0;state.mode=FLAGS;break}state.flags=0;if(state.head){state.head.done=false}if(!(state.wrap&1)||(((hold&255)<<8)+(hold>>8))%31){strm.msg="incorrect header check";state.mode=BAD;break}if((hold&15)!==Z_DEFLATED){strm.msg="unknown compression method";state.mode=BAD;break}hold>>>=4;bits-=4;len=(hold&15)+8;if(state.wbits===0){state.wbits=len}else if(len>state.wbits){strm.msg="invalid window size";state.mode=BAD;break}state.dmax=1<<len;strm.adler=state.check=1;state.mode=hold&512?DICTID:TYPE;hold=0;bits=0;break;case FLAGS:while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.flags=hold;if((state.flags&255)!==Z_DEFLATED){strm.msg="unknown compression method";state.mode=BAD;break}if(state.flags&57344){strm.msg="unknown header flags set";state.mode=BAD;break}if(state.head){state.head.text=hold>>8&1}if(state.flags&512){hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;state.check=crc32(state.check,hbuf,2,0)}hold=0;bits=0;state.mode=TIME;case TIME:while(bits<32){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(state.head){state.head.time=hold}if(state.flags&512){hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;hbuf[2]=hold>>>16&255;hbuf[3]=hold>>>24&255;state.check=crc32(state.check,hbuf,4,0)}hold=0;bits=0;state.mode=OS;case OS:while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(state.head){state.head.xflags=hold&255;state.head.os=hold>>8}if(state.flags&512){hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;state.check=crc32(state.check,hbuf,2,0)}hold=0;bits=0;state.mode=EXLEN;case EXLEN:if(state.flags&1024){while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.length=hold;if(state.head){state.head.extra_len=hold}if(state.flags&512){hbuf[0]=hold&255;hbuf[1]=hold>>>8&255;state.check=crc32(state.check,hbuf,2,0)}hold=0;bits=0}else if(state.head){state.head.extra=null}state.mode=EXTRA;case EXTRA:if(state.flags&1024){copy=state.length;if(copy>have){copy=have}if(copy){if(state.head){len=state.head.extra_len-state.length;if(!state.head.extra){state.head.extra=new Array(state.head.extra_len)}utils.arraySet(state.head.extra,input,next,copy,len)}if(state.flags&512){state.check=crc32(state.check,input,copy,next)}have-=copy;next+=copy;state.length-=copy}if(state.length){break inf_leave}}state.length=0;state.mode=NAME;case NAME:if(state.flags&2048){if(have===0){break inf_leave}copy=0;do{len=input[next+copy++];if(state.head&&len&&state.length<65536){state.head.name+=String.fromCharCode(len)}}while(len&&copy<have);if(state.flags&512){state.check=crc32(state.check,input,copy,next)}have-=copy;next+=copy;if(len){break inf_leave}}else if(state.head){state.head.name=null}state.length=0;state.mode=COMMENT;case COMMENT:if(state.flags&4096){if(have===0){break inf_leave}copy=0;do{len=input[next+copy++];if(state.head&&len&&state.length<65536){state.head.comment+=String.fromCharCode(len)}}while(len&&copy<have);if(state.flags&512){state.check=crc32(state.check,input,copy,next)}have-=copy;next+=copy;if(len){break inf_leave}}else if(state.head){state.head.comment=null}state.mode=HCRC;case HCRC:if(state.flags&512){while(bits<16){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(hold!==(state.check&65535)){strm.msg="header crc mismatch";state.mode=BAD;break}hold=0;bits=0}if(state.head){state.head.hcrc=state.flags>>9&1;state.head.done=true}strm.adler=state.check=0;state.mode=TYPE;break;case DICTID:while(bits<32){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}strm.adler=state.check=ZSWAP32(hold);hold=0;bits=0;state.mode=DICT;case DICT:if(state.havedict===0){strm.next_out=put;strm.avail_out=left;strm.next_in=next;strm.avail_in=have;state.hold=hold;state.bits=bits;return Z_NEED_DICT}strm.adler=state.check=1;state.mode=TYPE;case TYPE:if(flush===Z_BLOCK||flush===Z_TREES){break inf_leave}case TYPEDO:if(state.last){hold>>>=bits&7;bits-=bits&7;state.mode=CHECK;break}while(bits<3){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.last=hold&1;hold>>>=1;bits-=1;switch(hold&3){case 0:state.mode=STORED;break;case 1:fixedtables(state);state.mode=LEN_;if(flush===Z_TREES){hold>>>=2;bits-=2;break inf_leave}break;case 2:state.mode=TABLE;break;case 3:strm.msg="invalid block type";state.mode=BAD}hold>>>=2;bits-=2;break;case STORED:hold>>>=bits&7;bits-=bits&7;while(bits<32){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if((hold&65535)!==(hold>>>16^65535)){strm.msg="invalid stored block lengths";state.mode=BAD;break}state.length=hold&65535;hold=0;bits=0;state.mode=COPY_;if(flush===Z_TREES){break inf_leave}case COPY_:state.mode=COPY;case COPY:copy=state.length;if(copy){if(copy>have){copy=have}if(copy>left){copy=left}if(copy===0){break inf_leave}utils.arraySet(output,input,next,copy,put);have-=copy;next+=copy;left-=copy;put+=copy;state.length-=copy;break}state.mode=TYPE;break;case TABLE:while(bits<14){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.nlen=(hold&31)+257;hold>>>=5;bits-=5;state.ndist=(hold&31)+1;hold>>>=5;bits-=5;state.ncode=(hold&15)+4;hold>>>=4;bits-=4;if(state.nlen>286||state.ndist>30){strm.msg="too many length or distance symbols";state.mode=BAD;break}state.have=0;state.mode=LENLENS;case LENLENS:while(state.have<state.ncode){while(bits<3){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.lens[order[state.have++]]=hold&7;hold>>>=3;bits-=3}while(state.have<19){state.lens[order[state.have++]]=0}state.lencode=state.lendyn;state.lenbits=7;opts={bits:state.lenbits};ret=inflate_table(CODES,state.lens,0,19,state.lencode,0,state.work,opts);state.lenbits=opts.bits;if(ret){strm.msg="invalid code lengths set";state.mode=BAD;break}state.have=0;state.mode=CODELENS;case CODELENS:while(state.have<state.nlen+state.ndist){for(;;){here=state.lencode[hold&(1<<state.lenbits)-1];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(here_val<16){hold>>>=here_bits;bits-=here_bits;state.lens[state.have++]=here_val}else{if(here_val===16){n=here_bits+2;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=here_bits;bits-=here_bits;if(state.have===0){strm.msg="invalid bit length repeat";state.mode=BAD;break}len=state.lens[state.have-1];copy=3+(hold&3);hold>>>=2;bits-=2}else if(here_val===17){n=here_bits+3;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=here_bits;bits-=here_bits;len=0;copy=3+(hold&7);hold>>>=3;bits-=3}else{n=here_bits+7;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=here_bits;bits-=here_bits;len=0;copy=11+(hold&127);hold>>>=7;bits-=7}if(state.have+copy>state.nlen+state.ndist){strm.msg="invalid bit length repeat";state.mode=BAD;break}while(copy--){state.lens[state.have++]=len}}}if(state.mode===BAD){break}if(state.lens[256]===0){strm.msg="invalid code -- missing end-of-block";state.mode=BAD;break}state.lenbits=9;opts={bits:state.lenbits};ret=inflate_table(LENS,state.lens,0,state.nlen,state.lencode,0,state.work,opts);state.lenbits=opts.bits;if(ret){strm.msg="invalid literal/lengths set";state.mode=BAD;break}state.distbits=6;state.distcode=state.distdyn;opts={bits:state.distbits};ret=inflate_table(DISTS,state.lens,state.nlen,state.ndist,state.distcode,0,state.work,opts);state.distbits=opts.bits;if(ret){strm.msg="invalid distances set";state.mode=BAD;break}state.mode=LEN_;if(flush===Z_TREES){break inf_leave}case LEN_:state.mode=LEN;case LEN:if(have>=6&&left>=258){strm.next_out=put;strm.avail_out=left;strm.next_in=next;strm.avail_in=have;state.hold=hold;state.bits=bits;inflate_fast(strm,_out);put=strm.next_out;output=strm.output;left=strm.avail_out;next=strm.next_in;input=strm.input;have=strm.avail_in;hold=state.hold;bits=state.bits;if(state.mode===TYPE){state.back=-1}break}state.back=0;for(;;){here=state.lencode[hold&(1<<state.lenbits)-1];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(here_op&&(here_op&240)===0){last_bits=here_bits;last_op=here_op;last_val=here_val;for(;;){here=state.lencode[last_val+((hold&(1<<last_bits+last_op)-1)>>last_bits)];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(last_bits+here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=last_bits;bits-=last_bits;state.back+=last_bits}hold>>>=here_bits;bits-=here_bits;state.back+=here_bits;state.length=here_val;if(here_op===0){state.mode=LIT;break}if(here_op&32){state.back=-1;state.mode=TYPE;break}if(here_op&64){strm.msg="invalid literal/length code";state.mode=BAD;break}state.extra=here_op&15;state.mode=LENEXT;case LENEXT:if(state.extra){n=state.extra;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.length+=hold&(1<<state.extra)-1;hold>>>=state.extra;bits-=state.extra;state.back+=state.extra}state.was=state.length;state.mode=DIST;case DIST:for(;;){here=state.distcode[hold&(1<<state.distbits)-1];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if((here_op&240)===0){last_bits=here_bits;last_op=here_op;last_val=here_val;for(;;){here=state.distcode[last_val+((hold&(1<<last_bits+last_op)-1)>>last_bits)];here_bits=here>>>24;here_op=here>>>16&255;here_val=here&65535;if(last_bits+here_bits<=bits){break}if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}hold>>>=last_bits;bits-=last_bits;state.back+=last_bits}hold>>>=here_bits;bits-=here_bits;state.back+=here_bits;if(here_op&64){strm.msg="invalid distance code";state.mode=BAD;break}state.offset=here_val;state.extra=here_op&15;state.mode=DISTEXT;case DISTEXT:if(state.extra){n=state.extra;while(bits<n){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}state.offset+=hold&(1<<state.extra)-1;hold>>>=state.extra;bits-=state.extra;state.back+=state.extra}if(state.offset>state.dmax){strm.msg="invalid distance too far back";state.mode=BAD;break}state.mode=MATCH;case MATCH:if(left===0){break inf_leave}copy=_out-left;if(state.offset>copy){copy=state.offset-copy;if(copy>state.whave){if(state.sane){strm.msg="invalid distance too far back";state.mode=BAD;break}}if(copy>state.wnext){copy-=state.wnext;from=state.wsize-copy}else{from=state.wnext-copy}if(copy>state.length){copy=state.length}from_source=state.window}else{from_source=output;from=put-state.offset;copy=state.length}if(copy>left){copy=left}left-=copy;state.length-=copy;do{output[put++]=from_source[from++]}while(--copy);if(state.length===0){state.mode=LEN}break;case LIT:if(left===0){break inf_leave}output[put++]=state.length;left--;state.mode=LEN;break;case CHECK:if(state.wrap){while(bits<32){if(have===0){break inf_leave}have--;hold|=input[next++]<<bits;bits+=8}_out-=left;strm.total_out+=_out;state.total+=_out;if(_out){strm.adler=state.check=state.flags?crc32(state.check,output,_out,put-_out):adler32(state.check,output,_out,put-_out)}_out=left;if((state.flags?hold:ZSWAP32(hold))!==state.check){strm.msg="incorrect data check";state.mode=BAD;break}hold=0;bits=0}state.mode=LENGTH;case LENGTH:if(state.wrap&&state.flags){while(bits<32){if(have===0){break inf_leave}have--;hold+=input[next++]<<bits;bits+=8}if(hold!==(state.total&4294967295)){strm.msg="incorrect length check";state.mode=BAD;break}hold=0;bits=0}state.mode=DONE;case DONE:ret=Z_STREAM_END;break inf_leave;case BAD:ret=Z_DATA_ERROR;break inf_leave;case MEM:return Z_MEM_ERROR;case SYNC:default:return Z_STREAM_ERROR}}strm.next_out=put;strm.avail_out=left;strm.next_in=next;strm.avail_in=have;state.hold=hold;state.bits=bits;if(state.wsize||_out!==strm.avail_out&&state.mode<BAD&&(state.mode<CHECK||flush!==Z_FINISH)){if(updatewindow(strm,strm.output,strm.next_out,_out-strm.avail_out)){state.mode=MEM;return Z_MEM_ERROR}}_in-=strm.avail_in;_out-=strm.avail_out;strm.total_in+=_in;strm.total_out+=_out;state.total+=_out;if(state.wrap&&_out){strm.adler=state.check=state.flags?crc32(state.check,output,_out,strm.next_out-_out):adler32(state.check,output,_out,strm.next_out-_out)}strm.data_type=state.bits+(state.last?64:0)+(state.mode===TYPE?128:0)+(state.mode===LEN_||state.mode===COPY_?256:0);if((_in===0&&_out===0||flush===Z_FINISH)&&ret===Z_OK){ret=Z_BUF_ERROR}return ret}function inflateEnd(strm){if(!strm||!strm.state){return Z_STREAM_ERROR}var state=strm.state;if(state.window){state.window=null}strm.state=null;return Z_OK}function inflateGetHeader(strm,head){var state;if(!strm||!strm.state){return Z_STREAM_ERROR}state=strm.state;if((state.wrap&2)===0){return Z_STREAM_ERROR}state.head=head;head.done=false;return Z_OK}exports.inflateReset=inflateReset;exports.inflateReset2=inflateReset2;exports.inflateResetKeep=inflateResetKeep;exports.inflateInit=inflateInit;exports.inflateInit2=inflateInit2;exports.inflate=inflate;exports.inflateEnd=inflateEnd;exports.inflateGetHeader=inflateGetHeader;exports.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":27,"./adler32":29,"./crc32":31,"./inffast":34,"./inftrees":36}],36:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("../utils/common");var MAXBITS=15;var ENOUGH_LENS=852;var ENOUGH_DISTS=592;var CODES=0;var LENS=1;var DISTS=2;var lbase=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0];var lext=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78];var dbase=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0];var dext=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];module.exports=function inflate_table(type,lens,lens_index,codes,table,table_index,work,opts){var bits=opts.bits;var len=0;var sym=0;var min=0,max=0;var root=0;var curr=0;var drop=0;var left=0;var used=0;var huff=0;var incr;var fill;var low;var mask;var next;var base=null;var base_index=0;var end;var count=new utils.Buf16(MAXBITS+1);var offs=new utils.Buf16(MAXBITS+1);var extra=null;var extra_index=0;var here_bits,here_op,here_val;for(len=0;len<=MAXBITS;len++){count[len]=0}for(sym=0;sym<codes;sym++){count[lens[lens_index+sym]]++}root=bits;for(max=MAXBITS;max>=1;max--){if(count[max]!==0){break}}if(root>max){root=max}if(max===0){table[table_index++]=1<<24|64<<16|0;table[table_index++]=1<<24|64<<16|0;opts.bits=1;return 0}for(min=1;min<max;min++){if(count[min]!==0){break}}if(root<min){root=min}left=1;for(len=1;len<=MAXBITS;len++){left<<=1;left-=count[len];if(left<0){return-1}}if(left>0&&(type===CODES||max!==1)){return-1}offs[1]=0;for(len=1;len<MAXBITS;len++){offs[len+1]=offs[len]+count[len]}for(sym=0;sym<codes;sym++){if(lens[lens_index+sym]!==0){work[offs[lens[lens_index+sym]]++]=sym}}if(type===CODES){base=extra=work;end=19}else if(type===LENS){base=lbase;base_index-=257;extra=lext;extra_index-=257;end=256}else{base=dbase;extra=dext;end=-1}huff=0;sym=0;len=min;next=table_index;curr=root;drop=0;low=-1;used=1<<root;mask=used-1;if(type===LENS&&used>ENOUGH_LENS||type===DISTS&&used>ENOUGH_DISTS){return 1}var i=0;for(;;){i++;here_bits=len-drop;if(work[sym]<end){here_op=0;here_val=work[sym]}else if(work[sym]>end){here_op=extra[extra_index+work[sym]];here_val=base[base_index+work[sym]]}else{here_op=32+64;here_val=0}incr=1<<len-drop;fill=1<<curr;min=fill;do{fill-=incr;table[next+(huff>>drop)+fill]=here_bits<<24|here_op<<16|here_val|0}while(fill!==0);incr=1<<len-1;while(huff&incr){incr>>=1}if(incr!==0){huff&=incr-1;huff+=incr}else{huff=0}sym++;if(--count[len]===0){if(len===max){break}len=lens[lens_index+work[sym]]}if(len>root&&(huff&mask)!==low){if(drop===0){drop=root}next+=min;curr=len-drop;left=1<<curr;while(curr+drop<max){left-=count[curr+drop];if(left<=0){break}curr++;left<<=1}used+=1<<curr;if(type===LENS&&used>ENOUGH_LENS||type===DISTS&&used>ENOUGH_DISTS){return 1}low=huff&mask;table[low]=root<<24|curr<<16|next-table_index|0}}if(huff!==0){table[next+huff]=len-drop<<24|64<<16|0}opts.bits=root;return 0}},{"../utils/common":27}],37:[function(_dereq_,module,exports){"use strict";module.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],38:[function(_dereq_,module,exports){"use strict";var utils=_dereq_("../utils/common");var Z_FIXED=4;var Z_BINARY=0;var Z_TEXT=1;var Z_UNKNOWN=2;function zero(buf){var len=buf.length;while(--len>=0){buf[len]=0}}var STORED_BLOCK=0;var STATIC_TREES=1;var DYN_TREES=2;var MIN_MATCH=3;var MAX_MATCH=258;var LENGTH_CODES=29;var LITERALS=256;var L_CODES=LITERALS+1+LENGTH_CODES;var D_CODES=30;var BL_CODES=19;var HEAP_SIZE=2*L_CODES+1;var MAX_BITS=15;var Buf_size=16;var MAX_BL_BITS=7;var END_BLOCK=256;var REP_3_6=16;var REPZ_3_10=17;var REPZ_11_138=18;var extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0];var extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];var extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7];var bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];var DIST_CODE_LEN=512;var static_ltree=new Array((L_CODES+2)*2);zero(static_ltree);var static_dtree=new Array(D_CODES*2);zero(static_dtree);var _dist_code=new Array(DIST_CODE_LEN);zero(_dist_code);var _length_code=new Array(MAX_MATCH-MIN_MATCH+1);zero(_length_code);var base_length=new Array(LENGTH_CODES);zero(base_length);var base_dist=new Array(D_CODES);zero(base_dist);var StaticTreeDesc=function(static_tree,extra_bits,extra_base,elems,max_length){this.static_tree=static_tree;this.extra_bits=extra_bits;this.extra_base=extra_base;this.elems=elems;this.max_length=max_length;this.has_stree=static_tree&&static_tree.length};var static_l_desc;var static_d_desc;var static_bl_desc;var TreeDesc=function(dyn_tree,stat_desc){this.dyn_tree=dyn_tree;this.max_code=0;this.stat_desc=stat_desc};function d_code(dist){return dist<256?_dist_code[dist]:_dist_code[256+(dist>>>7)]}function put_short(s,w){s.pending_buf[s.pending++]=w&255;s.pending_buf[s.pending++]=w>>>8&255}function send_bits(s,value,length){if(s.bi_valid>Buf_size-length){s.bi_buf|=value<<s.bi_valid&65535;put_short(s,s.bi_buf);s.bi_buf=value>>Buf_size-s.bi_valid;s.bi_valid+=length-Buf_size}else{s.bi_buf|=value<<s.bi_valid&65535;s.bi_valid+=length}}function send_code(s,c,tree){send_bits(s,tree[c*2],tree[c*2+1])}function bi_reverse(code,len){var res=0;do{res|=code&1;code>>>=1;res<<=1}while(--len>0);return res>>>1}function bi_flush(s){if(s.bi_valid===16){put_short(s,s.bi_buf);s.bi_buf=0;s.bi_valid=0}else if(s.bi_valid>=8){s.pending_buf[s.pending++]=s.bi_buf&255;s.bi_buf>>=8;s.bi_valid-=8}}function gen_bitlen(s,desc){var tree=desc.dyn_tree;var max_code=desc.max_code;var stree=desc.stat_desc.static_tree;var has_stree=desc.stat_desc.has_stree;var extra=desc.stat_desc.extra_bits;var base=desc.stat_desc.extra_base;var max_length=desc.stat_desc.max_length;var h;var n,m;var bits;var xbits;var f;var overflow=0;for(bits=0;bits<=MAX_BITS;bits++){s.bl_count[bits]=0}tree[s.heap[s.heap_max]*2+1]=0;for(h=s.heap_max+1;h<HEAP_SIZE;h++){n=s.heap[h];bits=tree[tree[n*2+1]*2+1]+1;if(bits>max_length){bits=max_length;overflow++}tree[n*2+1]=bits;if(n>max_code){continue}s.bl_count[bits]++;xbits=0;if(n>=base){xbits=extra[n-base]}f=tree[n*2];s.opt_len+=f*(bits+xbits);if(has_stree){s.static_len+=f*(stree[n*2+1]+xbits)}}if(overflow===0){return}do{bits=max_length-1;while(s.bl_count[bits]===0){bits--}s.bl_count[bits]--;s.bl_count[bits+1]+=2;s.bl_count[max_length]--;overflow-=2}while(overflow>0);for(bits=max_length;bits!==0;bits--){n=s.bl_count[bits];while(n!==0){m=s.heap[--h];if(m>max_code){continue}if(tree[m*2+1]!==bits){s.opt_len+=(bits-tree[m*2+1])*tree[m*2];tree[m*2+1]=bits}n--}}}function gen_codes(tree,max_code,bl_count){var next_code=new Array(MAX_BITS+1);var code=0;var bits;var n;for(bits=1;bits<=MAX_BITS;bits++){next_code[bits]=code=code+bl_count[bits-1]<<1}for(n=0;n<=max_code;n++){var len=tree[n*2+1];if(len===0){continue}tree[n*2]=bi_reverse(next_code[len]++,len)}}function tr_static_init(){var n;var bits;var length;var code;var dist;var bl_count=new Array(MAX_BITS+1);length=0;for(code=0;code<LENGTH_CODES-1;code++){base_length[code]=length;for(n=0;n<1<<extra_lbits[code];n++){_length_code[length++]=code}}_length_code[length-1]=code;dist=0;for(code=0;code<16;code++){base_dist[code]=dist;for(n=0;n<1<<extra_dbits[code];n++){_dist_code[dist++]=code}}dist>>=7;for(;code<D_CODES;code++){base_dist[code]=dist<<7;for(n=0;n<1<<extra_dbits[code]-7;n++){_dist_code[256+dist++]=code}}for(bits=0;bits<=MAX_BITS;bits++){bl_count[bits]=0}n=0;while(n<=143){static_ltree[n*2+1]=8;n++;bl_count[8]++}while(n<=255){static_ltree[n*2+1]=9;n++;bl_count[9]++}while(n<=279){static_ltree[n*2+1]=7;n++;bl_count[7]++}while(n<=287){static_ltree[n*2+1]=8;n++;bl_count[8]++}gen_codes(static_ltree,L_CODES+1,bl_count);for(n=0;n<D_CODES;n++){static_dtree[n*2+1]=5;static_dtree[n*2]=bi_reverse(n,5)}static_l_desc=new StaticTreeDesc(static_ltree,extra_lbits,LITERALS+1,L_CODES,MAX_BITS);static_d_desc=new StaticTreeDesc(static_dtree,extra_dbits,0,D_CODES,MAX_BITS);static_bl_desc=new StaticTreeDesc(new Array(0),extra_blbits,0,BL_CODES,MAX_BL_BITS)}function init_block(s){var n;for(n=0;n<L_CODES;n++){s.dyn_ltree[n*2]=0}for(n=0;n<D_CODES;n++){s.dyn_dtree[n*2]=0}for(n=0;n<BL_CODES;n++){s.bl_tree[n*2]=0}s.dyn_ltree[END_BLOCK*2]=1;s.opt_len=s.static_len=0;s.last_lit=s.matches=0}function bi_windup(s){if(s.bi_valid>8){put_short(s,s.bi_buf)}else if(s.bi_valid>0){s.pending_buf[s.pending++]=s.bi_buf}s.bi_buf=0;s.bi_valid=0}function copy_block(s,buf,len,header){bi_windup(s);if(header){put_short(s,len);put_short(s,~len)}utils.arraySet(s.pending_buf,s.window,buf,len,s.pending);s.pending+=len}function smaller(tree,n,m,depth){var _n2=n*2;var _m2=m*2;return tree[_n2]<tree[_m2]||tree[_n2]===tree[_m2]&&depth[n]<=depth[m]}function pqdownheap(s,tree,k){var v=s.heap[k];var j=k<<1;while(j<=s.heap_len){if(j<s.heap_len&&smaller(tree,s.heap[j+1],s.heap[j],s.depth)){j++}if(smaller(tree,v,s.heap[j],s.depth)){break}s.heap[k]=s.heap[j];k=j;j<<=1}s.heap[k]=v}function compress_block(s,ltree,dtree){var dist;var lc;var lx=0;var code;var extra;if(s.last_lit!==0){do{dist=s.pending_buf[s.d_buf+lx*2]<<8|s.pending_buf[s.d_buf+lx*2+1];lc=s.pending_buf[s.l_buf+lx];lx++;if(dist===0){send_code(s,lc,ltree)}else{code=_length_code[lc];send_code(s,code+LITERALS+1,ltree);extra=extra_lbits[code];if(extra!==0){lc-=base_length[code];send_bits(s,lc,extra)}dist--;code=d_code(dist);send_code(s,code,dtree);extra=extra_dbits[code];if(extra!==0){dist-=base_dist[code];send_bits(s,dist,extra)}}}while(lx<s.last_lit)}send_code(s,END_BLOCK,ltree)}function build_tree(s,desc){var tree=desc.dyn_tree;var stree=desc.stat_desc.static_tree;var has_stree=desc.stat_desc.has_stree;var elems=desc.stat_desc.elems;var n,m;var max_code=-1;var node;s.heap_len=0;s.heap_max=HEAP_SIZE;for(n=0;n<elems;n++){if(tree[n*2]!==0){s.heap[++s.heap_len]=max_code=n;s.depth[n]=0}else{tree[n*2+1]=0}}while(s.heap_len<2){node=s.heap[++s.heap_len]=max_code<2?++max_code:0;tree[node*2]=1;s.depth[node]=0;s.opt_len--;if(has_stree){s.static_len-=stree[node*2+1]}}desc.max_code=max_code;for(n=s.heap_len>>1;n>=1;n--){pqdownheap(s,tree,n)}node=elems;do{n=s.heap[1];s.heap[1]=s.heap[s.heap_len--];pqdownheap(s,tree,1);m=s.heap[1];s.heap[--s.heap_max]=n;s.heap[--s.heap_max]=m;tree[node*2]=tree[n*2]+tree[m*2];s.depth[node]=(s.depth[n]>=s.depth[m]?s.depth[n]:s.depth[m])+1;tree[n*2+1]=tree[m*2+1]=node;s.heap[1]=node++;pqdownheap(s,tree,1)}while(s.heap_len>=2);s.heap[--s.heap_max]=s.heap[1];gen_bitlen(s,desc);gen_codes(tree,max_code,s.bl_count)}function scan_tree(s,tree,max_code){var n;var prevlen=-1;var curlen;var nextlen=tree[0*2+1];var count=0;var max_count=7;var min_count=4;if(nextlen===0){max_count=138;min_count=3}tree[(max_code+1)*2+1]=65535;for(n=0;n<=max_code;n++){curlen=nextlen;nextlen=tree[(n+1)*2+1];if(++count<max_count&&curlen===nextlen){continue}else if(count<min_count){s.bl_tree[curlen*2]+=count}else if(curlen!==0){if(curlen!==prevlen){s.bl_tree[curlen*2]++}s.bl_tree[REP_3_6*2]++}else if(count<=10){s.bl_tree[REPZ_3_10*2]++}else{s.bl_tree[REPZ_11_138*2]++}count=0;prevlen=curlen;if(nextlen===0){max_count=138;min_count=3}else if(curlen===nextlen){max_count=6;min_count=3}else{max_count=7;min_count=4}}}function send_tree(s,tree,max_code){var n;var prevlen=-1;var curlen;var nextlen=tree[0*2+1];var count=0;var max_count=7;var min_count=4;if(nextlen===0){max_count=138;min_count=3}for(n=0;n<=max_code;n++){curlen=nextlen;nextlen=tree[(n+1)*2+1];if(++count<max_count&&curlen===nextlen){continue}else if(count<min_count){do{send_code(s,curlen,s.bl_tree)}while(--count!==0)}else if(curlen!==0){if(curlen!==prevlen){send_code(s,curlen,s.bl_tree);count--}send_code(s,REP_3_6,s.bl_tree);send_bits(s,count-3,2)}else if(count<=10){send_code(s,REPZ_3_10,s.bl_tree);send_bits(s,count-3,3)}else{send_code(s,REPZ_11_138,s.bl_tree);send_bits(s,count-11,7)}count=0;prevlen=curlen;if(nextlen===0){max_count=138;min_count=3}else if(curlen===nextlen){max_count=6;min_count=3}else{max_count=7;min_count=4}}}function build_bl_tree(s){var max_blindex;scan_tree(s,s.dyn_ltree,s.l_desc.max_code);scan_tree(s,s.dyn_dtree,s.d_desc.max_code);build_tree(s,s.bl_desc);for(max_blindex=BL_CODES-1;max_blindex>=3;max_blindex--){if(s.bl_tree[bl_order[max_blindex]*2+1]!==0){break}}s.opt_len+=3*(max_blindex+1)+5+5+4;return max_blindex}function send_all_trees(s,lcodes,dcodes,blcodes){var rank;send_bits(s,lcodes-257,5);send_bits(s,dcodes-1,5);send_bits(s,blcodes-4,4);for(rank=0;rank<blcodes;rank++){send_bits(s,s.bl_tree[bl_order[rank]*2+1],3)}send_tree(s,s.dyn_ltree,lcodes-1);send_tree(s,s.dyn_dtree,dcodes-1)}function detect_data_type(s){var black_mask=4093624447;var n;for(n=0;n<=31;n++,black_mask>>>=1){if(black_mask&1&&s.dyn_ltree[n*2]!==0){return Z_BINARY}}if(s.dyn_ltree[9*2]!==0||s.dyn_ltree[10*2]!==0||s.dyn_ltree[13*2]!==0){return Z_TEXT}for(n=32;n<LITERALS;n++){if(s.dyn_ltree[n*2]!==0){return Z_TEXT}}return Z_BINARY}var static_init_done=false;function _tr_init(s){if(!static_init_done){tr_static_init();static_init_done=true}s.l_desc=new TreeDesc(s.dyn_ltree,static_l_desc);s.d_desc=new TreeDesc(s.dyn_dtree,static_d_desc);s.bl_desc=new TreeDesc(s.bl_tree,static_bl_desc);s.bi_buf=0;s.bi_valid=0;init_block(s)}function _tr_stored_block(s,buf,stored_len,last){send_bits(s,(STORED_BLOCK<<1)+(last?1:0),3);copy_block(s,buf,stored_len,true)}function _tr_align(s){send_bits(s,STATIC_TREES<<1,3);send_code(s,END_BLOCK,static_ltree);bi_flush(s)}function _tr_flush_block(s,buf,stored_len,last){var opt_lenb,static_lenb;var max_blindex=0;if(s.level>0){if(s.strm.data_type===Z_UNKNOWN){s.strm.data_type=detect_data_type(s)}build_tree(s,s.l_desc);build_tree(s,s.d_desc);max_blindex=build_bl_tree(s);opt_lenb=s.opt_len+3+7>>>3;static_lenb=s.static_len+3+7>>>3;if(static_lenb<=opt_lenb){opt_lenb=static_lenb}}else{opt_lenb=static_lenb=stored_len+5}if(stored_len+4<=opt_lenb&&buf!==-1){_tr_stored_block(s,buf,stored_len,last)}else if(s.strategy===Z_FIXED||static_lenb===opt_lenb){send_bits(s,(STATIC_TREES<<1)+(last?1:0),3);compress_block(s,static_ltree,static_dtree)}else{send_bits(s,(DYN_TREES<<1)+(last?1:0),3);send_all_trees(s,s.l_desc.max_code+1,s.d_desc.max_code+1,max_blindex+1);compress_block(s,s.dyn_ltree,s.dyn_dtree)}init_block(s);if(last){bi_windup(s)}}function _tr_tally(s,dist,lc){s.pending_buf[s.d_buf+s.last_lit*2]=dist>>>8&255;s.pending_buf[s.d_buf+s.last_lit*2+1]=dist&255;s.pending_buf[s.l_buf+s.last_lit]=lc&255;s.last_lit++;if(dist===0){s.dyn_ltree[lc*2]++}else{s.matches++;dist--;s.dyn_ltree[(_length_code[lc]+LITERALS+1)*2]++;s.dyn_dtree[d_code(dist)*2]++}return s.last_lit===s.lit_bufsize-1}exports._tr_init=_tr_init;exports._tr_stored_block=_tr_stored_block;exports._tr_flush_block=_tr_flush_block;exports._tr_tally=_tr_tally;exports._tr_align=_tr_align},{"../utils/common":27}],39:[function(_dereq_,module,exports){"use strict";function ZStream(){this.input=null;this.next_in=0;this.avail_in=0;this.total_in=0;this.output=null;this.next_out=0;this.avail_out=0;this.total_out=0;this.msg="";this.state=null;this.data_type=2;this.adler=0}module.exports=ZStream},{}]},{},[9])(9)});(function(){function x(b,a){for(var c=[];b;)c.push(a),--b;return c}function y(b,a){for(var c=0,d={};c<b.length;++c)d[b[c]]=a[c];return d}function s(b,a){var c=b.split(/%[ds]/);c.length>a.length&&a.push("");return a.map(function(a,b){return c[b]+a}).join("")}function q(b,a){p.info(s(b,a))}function B(b,a){return-1!==b.indexOf(a,b.length-a.length)}function C(b){return Object.keys(b).map(function(a){return parseInt(a)})}function G(b,a){var c=[],d;if(Array.isArray(b))for(d=0;d<b.length;++d)d in b&&c.push([d,b[d]]);else for(d in b)c.push([d,b[d]]);c.sort(a?function(a,b){return a[0]-b[0]}:function(a,b){return a[1]-b[1]||b[0]-a[0]});return c}function H(b){this.reset();this.ixp=b;this.divs=this.mdur=this.ixm=0}function w(b,a){this.tijd=0;this.dur=b;this.fact=null;this.tup=[""];this.tupabc="";this.grace=this.beam=0;this.after=this.before="";this.ns=a?[a]:[];this.lyrs={};this.pos=0}function z(b){this.tijd=0;this.str=b;this.pos=0}function A(){}function r(b){this.maxtime=this.tijd=0;this.gMaten=[];this.gLyrics=[];this.vnums={};this.cnt=new A;this.vceCnt=1;this.lastnote=null;this.bpl=b.b;this.cpl=b.n;this.repbra=0;this.nvlt=b.v}function D(b,a,c,d){this.fnmext=b;this.outlist=[];this.infolist=[];this.title="T:Title";this.key="none";this.clefs={};this.mtr="none";this.tempo=0;this.pad=a;this.X=c+1;this.denL=d.d;this.volpan=d.m;this.cmpL=[];this.rightmargin=this.leftmargin=this.pagewidth=this.scale="";4==d.p.length&&(this.scale=""!=d.p[0]?parseFloat(d.p[0]):"",this.pagewidth=""!=d.p[1]?parseFloat(d.p[1]):"",this.leftmargin=""!=d.p[2]?parseFloat(d.p[2]):"",this.rightmargin=""!=d.p[3]?parseFloat(d.p[3]):"")}function P(b,a){if(!b.join(""))return["",0];for(var c=[],d=0;d<b.length;++d){var f=b[d];""==f?f=a?"_":"*":B(f,"_")&&!B(f,"\\_")?(f=f.replace("_",""),a=1):a=0;c.push(f)}return[c.join(" "),a]}function F(b,a){for(var c=b,d=a,f;a;)f=b%a,b=a,a=f;return[c/b,d/b]}function I(b,a,c){if(0==b.dur)return"";var d;d=F(c*b.dur,4*a);a=d[0];c=d[1];b.fact&&(d=b.fact[0],b=b.fact[1],d=F(a*d,c*b),a=d[0],c=d[1]);64<c&&(d=F(Math.round(64*a/c)||1,64),q("denominator too small: %d/%d rounded to %d/%d",[a,c,d[0],d[1]]),a=d[0],c=d[1]);return 1==a?1==c?"":2==c?"/":"/"+c:1==c?""+a:a+"/"+c}function J(b){var a=b.match(/([_^]*)([A-Ga-g])([',]*)/);if(!a)return-1;b=a[1];var c=a[2],a=a[3],d;d=c.toUpperCase();c=60+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(d)]+(d!=c?12:0);b&&(c+=("^"==b[0]?1:-1)*b.length);a&&(c+=("'"==a[0]?12:-12)*a.length);return c}function Q(b,a,c,d){var f;f=0;0<=c.indexOf("stafflines=1")&&(f+=4);!d&&0<=c.indexOf("bass")&&(f+=12);f&&(c="CDEFGAB".split(""),f=c.indexOf(b)+f,b=c[f%7],a+=Math.floor(f/7));4<a&&(b=b.toLowerCase());5<a&&(b+=Array(a-5+1).join("'"));4>a&&(b+=Array(4-a+1).join(","));return b}function K(b,a,c){var d=0,f,e,g=a[b];
e=g.tup.indexOf("start");-1<e&&g.tup.splice(e,1);var l=b;for(c=[g.fact[0]/c[0],g.fact[1]/c[1]];b<a.length;){g=a[b];if(!(g instanceof z||g.grace)){-1<g.tup.indexOf("start")?(e=K(b,a,c),b=e[0],e=e[1],d+=e):g.fact&&(d+=1);e=g.tup.indexOf("stop");if(-1<e){g.tup.splice(e,1);break}if(!g.fact){b=f;break}f=b}b+=1}f=[c[0],c[1],d];f="3,2,3"==f.toString()?"(3":s("(%d:%d:%d",f);a[l].tupabc=f+a[l].tupabc;return[b,d]}function R(b){b=b.filter(function(a){return a instanceof w});for(var a=0;a<b.length-1;){var c=b[a],d=b[a+1];!c.fact&&!d.fact&&0<c.dur&&d.beam&&(3*c.dur==d.dur?(d.dur=2*d.dur/3,c.dur*=2,c.after="<"+c.after,a+=1):3*d.dur==c.dur&&(c.dur=2*c.dur/3,d.dur*=2,c.after=">"+c.after,a+=1));a+=1}}function S(b,a,c,d,f){for(d=0;d<b.length;)c=b[d],c instanceof w&&c.fact&&(c=K(d,b,[1,1]),d=c[0]),d+=1;d=[];for(var e,g=0;g<b.length;++g){c=b[g];if(c instanceof w){var l=I(c,a,f),k=1<c.ns.length;e=c.ns.filter(function(a){return B(a,"-")});e=e.map(function(a){return a.slice(0,-1)});var h="";k&&e.length==c.ns.length&&(c.ns=e,h="-");e=c.tupabc+c.before;k&&(e+="[");e+=c.ns.join("");k&&(e+="]"+h);B(e,"-")&&(e=e.slice(0,-1),h="-");e+=l+h;e+=c.after;c=c.beam}else e=c.str,c=1;c?d.push(e):d.push(" "+e)}return d.join("")}function T(b,a){b.map(function(a,b){a.pos=b});b.sort(function(a,b){return a.tijd-b.tijd||a.pos-b.pos});for(var c=0,d=[],f=0;f<b.length;++f){var e=b[f];e.tijd>c&&d.push(new w(e.tijd-c,"x"));if(e instanceof z)e.tijd<c&&(e.tijd=c),d.push(e),c=e.tijd;else{if(e.tijd<c){if("z"==e.ns[0])continue;var g=d[d.length-1];if(g.tijd<=e.tijd)if("z"==g.ns[0])g.dur=e.tijd-g.tijd,0==g.dur&&pop(d),q("overlap in part %d, measure %d: rest shortened",[a.ixp+1,a.ixm+1]);else{g.ns=g.ns.concat(e.ns);q("overlap in part %d, measure %d: added chord",[a.ixp+1,a.ixm+1]);e.dur=e.tijd+e.dur-c;if(0>=e.dur)continue;e.tijd=c}else{q("overlapping notes in one voice! part %d, measure %d, note %s discarded",[a.ixp+1,a.ixm+1,e instanceof w?e.ns:e.str]);continue}}d.push(e);c=e.tijd+e.dur}}0==c&&q("empty measure in part %d, measure %d, it should contain at least a rest to advance the time!",[a.ixp+1,a.ixm+1]);return d}function U(b){function a(a){a=s('<part-group number="%d" type="%s"></part-group>',[a,"stop"]);a=$.parseXML(a).firstChild;return $(a)}var c,d,f,e,g,l,k;c=[];d=[];l=b.children();for(g=0;g<l.length;g++)b=$(l[g]),"part-group"==b[0].nodeName?(f=b.attr("number"),e=b.attr("type"),k=d.indexOf(f),"start"==e?-1<k?(c.push(a(f)),c.push(b)):(c.push(b),d.push(f)):-1<k&&(d.splice(k,1),c.push(b))):c.push(b);for(g=d.length-1;0<=g;--g)f=d[g],c.push(a(f));return c}function E(b,a,c){var d,f,e,g;if(0==b.length)return[[],[]];d=b.shift();if("part-group"==d[0].nodeName){f=d.attr("number");e=d.attr("type");if("start"==e){e=[];for(g in{"group-symbol":0,"group-barline":0,"group-name":0,"group-abbreviation":0})e.push(d.find(g).text()||"");a[f]=e;c.push(f);g=E(b,a,c);b=g[0];d=g[1];g=E(d,a,c);a=g[0];c=g[1];return[[b].concat(a),c]}c=c.pop();b.length&&"stop"==b[0].attr("type")&&f!=c&&(g=a[c],a[c]=a[f],a[f]=g);a=a[f];return[[a],b]}g=E(b,a,c);a=g[0];b=g[1];return[[["name_tuple",d.find("part-name").text()||"",d.find("part-abbreviation").text()||""]].concat(a),b]}function L(b){var a,c,d,f;if(0==b.length)return[];a=[];for(d=0;d<b.length;++d){c=b[d];if(1==c.length)a.push(""+c[0]);else{a.push("(");for(f=0;f<c.length;++f)a.push(""+c[f]);a.push(")")}a.push("|")}a.splice(-1,1);1<b.length&&(a=["{"].concat(a).concat(["}"]));return a}function M(b,a,c,d,f,e){if("name_tuple"==b[0])d=d.shift(),a[0]&&(b[1]=a[0]+":"+b[1],b[2]=a[1]+":"+b[2]),f.push(b),e.push.apply(e,L(d));else if(2==b.length)d=d.shift(),c=["name_tuple","",""],c[1]=b[0][1]+":"+b[1][2],c[2]=b[0][2]+":"+b[1][3],f.push(c),e.push.apply(e,L(d));else{var g,l,k;k=b[b.length-1];a=k[0];g=k[1];l=k[2];k=k[3];g="yes"==g||c;e.push("brace"==a?"{":"[");for(c=0;c<b.length-1;++c)M(b[c],[l,k],g,d,f,e),g&&e.push("|");g&&e.splice(-1,1);e.push("brace"==a?"}":"]")}}function V(b){for(var a="",c=b.children(),d=0;d<c.length;++d){var f=c[d];switch(f.nodeName){case"elision":a+="~";break;case"text":a+=$(f).text().replace(/_/g,"\\_").replace(/-/g,"\\-").replace(/ /g,"~")}}if(!a)return a;c=b.find("syllabic").text();if("begin"==c||"middle"==c)a+="-";b.find("extend").length&&(a+="_");return a}function n(b){this.slurBuf={};this.wedge_type="";this.ingrace=0;this.msc=new r(b);this.unfold=b.u;this.ctf=b.c;this.gStfMap=[];this.midiMap=[];this.drumInst={};this.drumNotes={};this.instMid=[];this.midDflt=[-1,-1,-1,-91];this.msralts={};this.curalts={};this.stfMap={};this.clefMap={};this.curClef={};this.clefOct={};this.curStf={};this.nolbrk=b.x;this.doPageFmt=1==b.p.length;this.tstep=b.t}var W=Math.pow(2,53),N={"ornaments>trill-mark":"T","ornaments>mordent":"M","ornaments>inverted-mordent":"P","ornaments>turn":"!turn!","ornaments>inverted-turn":"!invertedturn!","ornaments>tremolo":"!///!","technical>up-bow":"u","technical>down-bow":"v","technical>harmonic":"!open!","technical>open-string":"!open!","technical>stopped":"!plus!","articulations>accent":"!>!","articulations>strong-accent":"!>!","articulations>staccato":".","articulations>staccatissimo":"!wedge!",fermata:"!fermata!",arpeggiate:"!arpeggio!","articulations>tenuto":"!tenuto!","articulations>staccatissimo":"!wedge!","articulations>spiccato":"!wedge!","articulations>breath-mark":"!breath!","articulations>detached-legato":"!tenuto!."},O={p:"!p!",pp:"!pp!",ppp:"!ppp!",f:"!f!",ff:"!ff!",fff:"!fff!",mp:"!mp!",mf:"!mf!",sfz:"!sfz!"},p;xml2abc_VERSION=62;H.prototype.reset=function(){this.lline=this.attr="";this.rline="|";this.lnum=""};A.prototype.inc=function(b,a){this.counters[b][a]=(this.counters[b][a]||0)+1};A.prototype.clear=function(b){b=Object.keys(b);var a=x(b.length,0);this.counters={note:y(b,a),nopr:y(b,a),nopt:y(b,a)}};A.prototype.getv=function(b,a){return this.counters[b][a]};A.prototype.prcnt=function(b){for(var a in this.counters.note)0!=this.getv("nopr",a)&&q("part %d, voice %d has %d skipped non printable notes",[b,a,this.getv("nopr",a)]),0!=this.getv("nopt",a)&&q("part %d, voice %d has %d notes without pitch",[b,a,this.getv("nopt",a)]),0==this.getv("note",a)&&q("part %d, skipped empty voice %d",[b,a])};r.prototype.initVoices=function(b){this.vtimes={};this.voices={};this.lyrics={};for(var a in this.vnums)this.vtimes[a]=0,this.voices[a]=[],this.lyrics[a]=[];b&&this.cnt.clear(this.vnums)};r.prototype.incTime=function(b){this.tijd+=b;this.tijd>this.maxtime&&(this.maxtime=this.tijd)};r.prototype.appendElemCv=function(b,a){for(var c in b)this.appendElem(c,a)};r.prototype.insertElem=function(b,a){var c=new z(a);c.tijd=0;this.voices[b].unshift(c)};r.prototype.appendObj=function(b,a,c){a.tijd=this.tijd;this.voices[b].push(a);this.incTime(c);this.tijd>this.vtimes[b]&&(this.vtimes[b]=this.tijd)};r.prototype.appendElem=function(b,a){this.appendObj(b,new z(a),0)};r.prototype.appendNote=function(b,a,c){a.ns.push(c);this.appendObj(b,a,parseInt(a.dur));"z"!=c&&(this.lastnote=a,this.cnt.inc("note",b),a.grace||this.lyrics[b].push(a.lyrs))};r.prototype.getLastRec=function(b){return this.gMaten.length?(b=this.gMaten[this.gMaten.length-1][b],b[b.length-1]):null};r.prototype.getLastMelis=function(b,a){if(this.gLyrics.length){var c=this.gLyrics[this.gLyrics.length-1][b];if(a in c)return c[a][1]}return 0};r.prototype.addChord=function(b){this.lastnote.ns.push(b)};r.prototype.addBar=function(b,a){a.mdur&&this.maxtime>a.mdur&&q("measure %d in part %d longer than metre",[a.ixm+1,a.ixp+1]);this.tijd=this.maxtime;for(var c in this.vnums){if(a.lline||a.lnum){var d=this.getLastRec(c);if(d){var f=d.str;a.lline&&(f=(f+a.lline).replace(/:\|:/g,"::").replace(/\|\|/g,"|"));3==this.nvlt?a.ixp+parseInt(c)==Math.min.apply(null,C(this.vnums))&&(f+=a.lnum):4==this.nvlt?parseInt(c)==Math.min.apply(null,C(this.vnums))&&(f+=a.lnum):a.lnum&&(f+=a.lnum,this.repbra=1);d.str=f}else a.lline&&this.insertElem(c,"|:")}b&&(d=this.getLastRec(c))&&(d.str+=b);a.attr&&this.insertElem(c,""+a.attr);this.appendElem(c," "+a.rline);this.voices[c]=T(this.voices[c],a);for(var d=this.lyrics[c],f={},e=d.reduce(function(a,b){return a.concat(C(b))},[]),g=Math.max.apply(null,e.concat([0]));0<g;--g){var e=d.map(function(a){return a[g]||""}),l=this.getLastMelis(c,g);f[g]=P(e,l)}this.lyrics[c]=f;R(this.voices[c])}this.gMaten.push(this.voices);this.gLyrics.push(this.lyrics);this.tijd=this.maxtime=0;this.initVoices()};r.prototype.outVoices=function(b,a){var c,d,f,e,g,l,k,h,m;g={};k=Math.min.apply(null,C(this.vnums));for(h in this.vnums)if(0!=this.cnt.getv("note",h)){if(p.denL)l=p.denL;else{var t=h,u=this.gMaten;l=b;m=0;e=W;d=c=void 0;for(var n=[4,8,16];n.length;){var v=n.shift(),q=0;for(c=0;c<u.length;++c){var r=u[c][t];for(d=0;d<r.length;++d){var s=r[d];s instanceof z||0==s.dur||(q+=I(s,l,v).length)}}q<e&&(m=v,e=q)}l=m}p.cmpL.push(l);t=[];u={};for(m=0;m<this.gMaten.length;++m){e=this.gMaten[m][h];t.push(S(e,b,m,a,l));d=this.gLyrics;if(0!=m)for(n in e=this.gMaten[m][h],c=d[m][h],d=d[m-1][h],v=v=n=void 0,d)if(v=d[n][1],!(n in c)&&v){v=e;q=[];for(r=0;r<v.length;++r)if(s=v[r],s instanceof w&&!s.grace){if("z"==s.ns[0])break;q.push("_")}(v=q.join(" "))&&(c[n]=[v,0])}c=this.gLyrics[m][h];for(f in c)if(e=c[f],e=e[0],f in u){for(;u[f].length<m;)u[f].push("");u[f].push(e)}else u[f]=x(m,"").concat([e])}for(f in u)e=u[f],l=t.length-e.length,u[f]=e.concat(x(l,""));p.add("V:"+this.vceCnt);this.repbra&&(1==this.nvlt&&1<this.vceCnt&&p.add("I:repbra 0"),2==this.nvlt&&parseInt(h)>k&&p.add("I:repbra 0"));0<this.cpl?this.bpl=0:0==this.bpl&&(this.cpl=100);for(l=0;t.length;){m=1;for(e=t[0];m<t.length&&!(0<this.cpl&&e.length+t[m].length>=this.cpl)&&!(0<this.bpl&&m>=this.bpl);)e+=t[m],m+=1;l+=m;p.add(e+" %"+l);t.splice(0,m);c=G(u,1);for(d=0;d<c.length;++d)e=c[d],f=e[0],e=e[1],p.add("w: "+e.slice(0,m).join("|")+"|"),e.splice(0,m)}g[h]=this.vceCnt;this.vceCnt+=1}this.gMaten=[];this.gLyrics=[];this.cnt.prcnt(a+1);return g};D.prototype.add=function(b){this.outlist.push(b+"\n")};D.prototype.info=function(b,a){this.infolist.push(("undefined"==typeof a||a?"-- ":"")+b)};D.prototype.mkHeader=function(b,a,c){var d=[],f=[],e,g,l,k,h,m;k=b.slice();for(m=0;m<a.length;++m){e=a[m];try{M(e,["",""],"",b,d,f)}catch(t){q("lousy musicxml: error in part-list",[])}}a=f.join(" ");b={};for(m=0;m<k.length;++m)g=k[m],e=d[m],l=e[1],e=e[2],0!=g.length&&(g=g[0][0],l=l.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),e=e.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),b[g]=(l?'nm="'+l+'"':"")+(e?' snm="'+e+'"':""));d=[s("X:%d\n%s\n",[this.X,this.title])];""!==this.scale&&d.push("%%scale "+this.scale+"\n");""!==this.pagewidth&&d.push("%%pagewidth "+this.pagewidth+"cm\n");""!==this.leftmargin&&d.push("%%leftmargin "+this.leftmargin+"cm\n");""!==this.rightmargin&&d.push("%%rightmargin "+this.rightmargin+"cm\n");a&&1<f.length&&d.push("%%score "+a+"\n");k=this.tempo?"Q:1/4="+this.tempo+"\n":"";f=[];for(m=0;m<this.cmpL.length;++m)e=this.cmpL[m],f[e]=(f[e]||0)+1;f=G(f);f=f[f.length-1][0];f=this.denL?this.denL:f;d.push(s("L:1/%d\n%sM:%s\n",[f,k,this.mtr]));d.push(s("I:linebreak $\nK:%s\n",[this.key]));for(h in this.clefs){e=c[h-1];m=e[0];a=e[1];l=e[1];g=e[3];k=e.slice(4);e=this.clefs[h];k.length&&0>e.indexOf("perc")&&(e=(e+" map=perc").trim());d.push(s("V:%d %s %s\n",[h,e,b[h]||""]));1<this.volpan?(0<m&&m!=h&&d.push("%%MIDI channel "+m+"\n"),0<a&&d.push("%%MIDI program "+(a-1)+"\n"),0<=l&&d.push("%%MIDI control 7 "+l+"\n"),0<=g&&d.push("%%MIDI control 10 "+g+"\n")):0<this.volpan&&(k.length&&0<m&&d.push("%%MIDI channel "+m+"\n"),0<a&&d.push("%%MIDI program "+(a-1)+"\n"));for(m=0;m<k.length;++m)if(e=k[m].nt,l=k[m].step,a=k[m].midi,(g=k[m].nhd)||(g="normal"),J(e)!=a||e!=l)0<this.volpan&&d.push("%%MIDI drummap "+e+" "+a+"\n"),d.push("I:percmap "+e+" "+l+" "+a+" "+g+"\n");f!=this.cmpL[h-1]&&d.push("L:1/"+this.cmpL[h-1]+"\n")}this.outlist=d.concat(this.outlist)};n.prototype.matchSlur=function(b,a,c,d,f,e){if(-1!=["start","stop"].indexOf(b))if(a||(a="1"),a in this.slurBuf){var g=this.slurBuf[a],l=g[0],k=g[1],h=g[2],g=g[3];b!=l?(c!=k||"start"!=l||g&&e||(h.before="("+h.before,d.after+=")"),delete this.slurBuf[a]):(q("double slur numbers %s-%s in part %d, measure %d, voice %d note %s, first discarded",[b,a,this.msr.ixp+1,this.msr.ixm+1,c,d.ns]),this.slurBuf[a]=[b,c,d,f])}else this.slurBuf[a]=[b,c,d,f]};n.prototype.doNotations=function(b,a){for(var c=Object.keys(N).sort(),d=0;d<c.length;++d){var f=c[d],e=N[f];a.find(f).length&&(b.before+=e)}c=a.find("technical>fingering");c.length&&(b.before+="!"+c.text()+"!");c=a.find("ornaments>wavy-line");if(c.length)switch(c.attr("type")){case"start":b.before="!trill(!"+b.before;break;case"stop":b.after+="!trill)!"}};n.prototype.ntAbc=function(b,a,c,d){var f={"double-flat":-2,"flat-flat":-2,flat:-1,natural:0,sharp:1,"sharp-sharp":2,"double-sharp":2};a+=this.clefOct[this.curStf[d]]||0;var e=b;4<a&&(e=b.toLowerCase());5<a&&(e+=Array(a-5+1).join("'"));4>a&&(e+=Array(4-a+1).join(","));a=c.find("accidental").text();var g=c.find("pitch>alter").text();!g&&this.msralts[b]&&(g=0);var l=e+"#"+d;if(""===a&&""===g)return e;if(""!=a)g=f[a];else{g=parseInt(g);if(l in this.curalts){if(g==this.curalts[l])return e}else if(g==(this.msralts[b]||0))return e;if(c.find("tie").map(function(){return $(this).attr("type")}).get().some(function(a){return"stop"==a}))return e;q("accidental %d added in part %d, measure %d, voice %d note %s",[g,this.msr.ixp+1,this.msr.ixm+1,d+1,e])}this.curalts[l]=g;return e=["__","_","=","^","^^"][g+2]+e};n.prototype.doNote=function(b){var a=new w(0,null),c=parseInt(b.find("voice").text()||"1");this.isSib&&(c+=100*(b.find("staff").text()||1));var d=0<b.find("chord").length,f=b.find("pitch>step").text()||b.find("unpitched>display-step").text(),e=b.find("pitch>octave").text()||b.find("unpitched>display-octave").text(),g=0<b.find("rest").length,l=b.find("time-modification>actual-notes").text();if(l){var k=b.find("time-modification>normal-notes").text();a.fact=[parseInt(l),parseInt(k)]}a.tup=b.find("notations>tuplet").map(function(){return $(this).attr("type")}).get();k=b.find("duration").text();l=b.find("grace");a.grace=0<l.length;a.before="";a.after="";a.grace&&!this.ingrace&&(this.ingrace=1,a.before="{","yes"==l.attr("slash")&&(a.before+="/"));if(l=!a.grace&&this.ingrace)this.ingrace=0,this.msc.lastnote.after+="}";if(g||"no"!=b.attr("print-object")){if(!k||a.grace)k=0;a.dur=parseInt(k);g||f&&e||(this.msc.cnt.inc("nopt",c),e=5,f="E");k=b.find("notations");k.length&&this.doNotations(a,k);g=g?"z":this.ntAbc(f,parseInt(e),b,c);if(b.find("unpitched").length){var k=this.curClef[this.curStf[c]],f=Q(f,parseInt(e),k,this.tstep),e=b.find("instrument"),e=e.length?e.attr("id"):"dummyId",e=this.drumInst[e]||J(g),k=b.find("notehead"),h=k.text().replace(" ","-");"yes"==k.attr("filled")&&(h+="+");"x"==h&&(g="^"+g.replace(/\^/g,"").replace(/_/g,""));if("circle-x"==h||"diamond"==h)g="_"+g.replace(/\^/g,"").replace(/_/g,"");this.drumNotes[c+";"+g]=[f,e,h]}f=b.find("tie").map(function(){return $(this).attr("type")}).get();-1<f.indexOf("start")&&(g+="-");f=b.find("beam").map(function(){return $(this).text()}).get();a.beam=-1<f.indexOf("continue")||-1<f.indexOf("end")||a.grace;f=b.find("lyric");for(e=k=0;e<f.length;++e){var h=$(f[e]),m=parseInt((h.attr("number")||"1").replace(/^.*verse/,""));0==m?m=k+1:k=m;a.lyrs[m]=V(h)}d?this.msc.addChord(g):(d=parseInt(b.find("staff").text()||"1"),this.curStf[c]!=d&&(f=d-this.curStf[c],this.curStf[c]=d,this.msc.appendElem(c,"[I:staff "+(0<f?"+":"")+f+"]")),this.msc.appendNote(c,a,g));f=b.find("notations>slur");for(e=0;e<f.length;++e)b=$(f[e]),this.matchSlur(b.attr("type"),b.attr("number"),c,this.msc.lastnote,a.grace,l)}else this.msc.cnt.inc("nopr",c)};n.prototype.doAttr=function(b){var a,c,d,f,e,g,l,k,h,m,t,n;a={C1:"alto1",C2:"alto2",C3:"alto",C4:"tenor",F4:"bass",F3:"bass3",G2:"treble",TAB:"",percussion:"perc"};if(c=b.find("divisions").text())this.msr.divs=parseInt(c);c=parseInt(b.find("transpose>chromatic").text()||"0");d=b.find("key>fifths").first().text();f=0==this.msc.tijd&&0==this.msr.ixm;d&&(e=parseInt(d),g=b.find("key>mode").first().text()||"major",h="FCGDAEB".split(""),k="Cb Gb Db Ab Eb Bb F C G D A E B F# C#".split(" "),l="Ab Eb Bb F C G D A E B F# C# G# D# A#".split(" "),d="","major"==g&&(d=k[7+e]),"minor"==g&&(d=l[7+e]+"min"),e=0<=e?y(h.slice(0,e),x(e,1)):y(h.slice(e),x(-e,-1)),e=[d,e],d=e[0],this.msralts=e[1],f&&!c&&"none"==p.key?p.key=d:d==p.key&&f||(this.msr.attr+="[K:"+d+"]"));if(d=b.find("time>beats").text())e=b.find("time>beat-type").text(),g=d+"/"+e,f?p.mtr=g:this.msr.attr+="[M:"+g+"]",this.msr.mdur=this.msr.divs*parseInt(d)*4/parseInt(e);(d=b.find("transpose>octave-change").text()||"")&&(c+=12*parseInt(d));g=b.find("clef");for(e=0;e<g.length;e++)if(l=$(g[e]),d=parseInt(l.attr("number")||"1"),k=l.find("sign").text(),h="percussion"!=k?l.find("line").text()||"":"",h=a[k+h]||"",k=l.find("clef-octave-change").text()||"0",h+={"-2":"-15","-1":"-8",1:"+8",2:"+15"}[k]||"",this.clefOct[d]=-parseInt(k),c&&(h+=" transpose="+c),(k=b.find("staff-details>staff-lines").text())&&(h+=" stafflines="+k),this.curClef[d]=h,f)this.clefMap[d]=h;else for(l=this.stfMap[d],n=0;n<l.length;++n)m=l[n],d!=this.curStf[m]&&(t=d-this.curStf[m],this.curStf[m]=d,k=0<t?"+":"",this.msc.appendElem(m,"[I:staff "+k+t+"]")),this.msc.appendElem(m,"[K:"+h+"]")};n.prototype.doDirection=function(b){var a,c,d,f,e,g,l,k,h;d=parseInt(b.find("staff").first().text()||"1");d=this.stfMap[d][0];a=b.attr("placement");c=b.find("sound");if(c.length){if(g=c.find("midi-instrument")){l=c.find("midi-instrument>midi-program").text();k=c.find("midi-instrument>midi-channel").text();for(h in this.vceInst)this.vceInst[h]==g.attr("id")&&(d=h);(h=(l?l-1:k)+"")&&0<p.volpan&&this.msc.appendElem(d,"[I:MIDI= "+(l?"program":"channel")+" "+h+"]")}if(c=c.attr("tempo"))c=-1<c.indexOf(".")?parseFloat(c).toFixed(2):parseInt(c),0==this.msc.tijd&&0==this.msr.ixm?p.tempo=c:this.msc.appendElem(d,"[Q:1/4="+c+"]")}b=b.children("direction-type");if(b.length){c=b.find("wedge");if(c.length){switch(c.attr("type")){case"crescendo":f="!<(!";this.wedge_type="<";break;case"diminuendo":f="!>(!";this.wedge_type=">";break;case"stop":f="<"==this.wedge_type?"!<)!":"!>)!";break;default:raise("wrong wedge type")}this.msc.appendElem(d,f)}f=b.find("words").eq(0);f.length&&(a="below"==a?"_":"^",0>parseFloat(f.attr("default-y")||"0")&&(a="_"),(f=f.text().replace(/"/g,'\\"').replace(/\n/g," ").trim())&&this.msc.appendElem(d,'"'+a+f+'"'));for(e in O)a=O[e],b.find("dynamics>"+e).length&&this.msc.appendElem(d,a);b.find("coda").length&&this.msc.appendElem(d,"O");b.find("segno").length&&this.msc.appendElem(d,"S")}};n.prototype.doHarmony=function(b){var a,c,d,f,e,g,l,k,h;a=parseInt(b.children("staff").text()||"1");a=this.stfMap[a][0];c={major:"",minor:"m",augmented:"+",diminished:"dim",dominant:"7","half-diminished":"m7b5"};d={major:"maj",dominant:"",minor:"m",diminished:"dim",augmented:"+",suspended:"sus"};f={second:"2",fourth:"4",seventh:"7",sixth:"6",ninth:"9","11th":"11","13th":"13"};e={1:"#",0:"","-1":"b"};g=b.find("root>root-step","").text();l=e[b.find("root>root-alter").text()]||"";k="";h=b.find("kind").text();h in c?h=c[h]:-1<h.indexOf("-")?(c=h.split("-"),h=c[0],c=c[1],h=(d[h]||"")+(f[c]||""),0==h.indexOf("sus")&&(k=h,h="")):"none"==h&&(h=b.find("kind").attr("text"));d=b.find("degree");for(f=0;f<d.length;++f)c=$(d[f]),h+=(e[c.find("degree-alter").text()]||"")+c.find("degree-value").text();h=h.replace("79","9").replace("713","13").replace("maj6","6");b=b.find("bass>bass-step").text()+(e[b.find("bass>bass-alter").text()]||"");this.msc.appendElem(a,'"'+g+l+h+k+(b&&"/"+b)+'"')};n.prototype.doBarline=function(b){var a=b.find("repeat"),c=0;a.length&&(c=a.attr("direction"));if(this.unfold)return c?"forward"==c?1:2:0;"right"==b.attr("location")&&(a=b.find("bar-style").text(),"light-light"==a?this.msr.rline="||":"light-heavy"==a&&(this.msr.rline="|]"));c&&("forward"==c?this.msr.lline=":":this.msr.rline=":|");b=b.find("ending");b.length&&("start"==b.attr("type")?(b=(b.attr("number")||"1").replace(/\./g,"").replace(/ /g,""),/^[\d,]+$/.test(b)||(b='"'+b.trim()+'"'),this.msr.lnum=b):"|"==this.msr.rline&&(this.msr.rline="||"));return 0};n.prototype.doPrint=function(b){if("yes"==b.attr("new-system")||"yes"==b.attr("new-page"))return this.nolbrk?"":"$"};n.prototype.doPartList=function(b){var a,c,d,f,e,g,l,k,h,m;f=b.find("part-list>score-part");for(a=0;a<f.length;++a){c=f[a];e={};g=$(c).find("midi-instrument");for(c=0;c<g.length;++c){l=$(g[c]);h=["midi-channel","midi-program","volume","pan"];k=[];for(d=0;d<h.length;++d)m=h[d],k.push(l.find(m).text()||this.midDflt[d]);d=k[3];-90<=d&&90>=d&&(d=(d+90)/180*127);e[l.attr("id")]=[parseInt(k[0]),parseInt(k[1]),parseFloat(k[2]),d];(k=l.find("midi-unpitched").text())&&(this.drumInst[l.attr("id")]=k-1)}this.instMid.push(e)}b=b.find("part-list");k=U(b);return E(k,{},[])[0]};n.prototype.mkTitle=function(b){var a,c,d=[],f=[],e=[],g,l,k,h,m;a=b.find("work>work-title").text().trim();c=b.find("movement-title").text().trim();g=b.find("identification>creator");for(l=0;l<g.length;++l)k=$(g[l]),h=k.text(),k=k.attr("type"),h&&(h=h.split("\n").map(function(a){return a.trim()}),"composer"==k?d.push.apply(d,h):"lyricist"!=k&&"transcriber"!=k||f.push.apply(f,h));g=b.find("identification>rights");for(l=0;l<g.length;++l)h=$(g[l]).text(),h=h.split("\n").map(function(a){return a.trim()}),f.push.apply(f,h);g=b.find("credit");for(l=0;l<g.length;++l){h="";k=$(g[l]).find("credit-words");for(m=0;m<k.length;++m)h+=$(k[m]).text();e.push(h.replace(/\s*[\r\n]\s*/g," "))}e=function(b){function g(a){return a&&-1<h.indexOf(a)}var k=[],h,l;for(l=0;l<e.length;++l)h=e[l],6>b&&(h&&-1<a.indexOf(h)||h&&-1<c.indexOf(h))||5>b&&(h&&-1<d.indexOf(h)||h&&-1<f.indexOf(h))||4>b&&(a&&-1<h.indexOf(a)||c&&-1<h.indexOf(c))||3>b&&(d.some(g)||f.some(g))||2>b&&/^[\d\W]*$/.test(h)||k.push(h);0==b&&a+c&&(k="");return k}(this.ctf);a&&(a="T:"+a.replace(/\n/g,"\nT:")+"\n");c&&(a+="T:"+c.replace(/\n/g,"\nT:")+"\n");e.length&&(a+=e.map(function(a){return"T:"+a}).join("\n")+"\n");d.length&&(a+=d.map(function(a){return"C:"+a}).join("\n")+"\n");f.length&&(a+=f.map(function(a){return"Z:"+a}).join("\n")+"\n");a&&(p.title=a.substr(0,a.length-1));(this.isSib=0<=b.find("identification>encoding>software").text().indexOf("Sibelius"))&&q("Sibelius MusicXMl is unreliable",[])};n.prototype.doDefaults=function(b){var a,c,d,f;this.doPageFmt&&(a=b.find("defaults"),a.length&&(b=a.find("scaling>millimeters").text(),c=a.find("scaling>tenths").text(),c=b/c/10,b=a.find("page-layout>page-width").text()*c,d=a.find("page-layout>page-margins").first(),a=d.find("left-margin").text(),d=d.find("right-margin").text(),f=10*c/.2117,!p.scale&&f&&(p.scale=f.toFixed(2)),!p.pagewidth&&b&&(p.pagewidth=b.toFixed(2)),p.leftmargin||""==a||(p.leftmargin=(a*c).toFixed(2)),p.rightmargin||""==d||(p.rightmargin=(d*c).toFixed(2))))};n.prototype.locStaffMap=function(b){var a={};this.vceInst={};this.msc.vnums={};b=b.find("measure>note");for(var c=0;c<b.length;c++){var d=$(b[c]),f=parseInt(d.find("voice").text()||"1");this.isSib&&(f+=100*(d.find("staff").text()||1));this.msc.vnums[f]=1;var e=parseInt(d.find("staff").text()||"1");if(f in a){var g=a[f];g[e]=(g[e]||0)+1}else g={},g[e]=1,a[f]=g;g=d.find("instrument");g.length&&(this.vceInst[f]=$(g).attr("id"))}this.stfMap={};this.clefMap={};for(f in a){b=[];c=a[f];for(e in c)b.push([c[e],e]);b.sort(function(a,b){return b[0]-a[0]});b=b[0][1];this.stfMap[b]=(this.stfMap[b]||[]).concat([f]);this.curStf[f]=b}};n.prototype.addStaffMap=function(b){var a,c,d,f,e,g,l=[],k=Object.keys(this.stfMap).sort();for(c=0;c<k.length;++c){e=k[c];f=this.stfMap[e];g=[];for(a=0;a<f.length;++a)d=f[a],d in b&&g.push(b[d]);if(g.length)for((l.push(g.sort()),f=e in this.clefMap?this.clefMap[e]:"treble",a=0);a<g.length;++a)d=g[a],p.clefs[d]=f}this.gStfMap.push(l)};n.prototype.addMidiMap=function(b,a){var c=this.instMid[b],d,f=Object.keys(c);d=f.length?c[f[0]]:this.midDflt;var e=[],g,l,k,h=this;for(g in a)f=Object.keys(this.drumNotes).sort().filter(function(a){return a.split(";")[0]==g}),k=f.map(function(a){return{nt:a.split(";")[1],step:h.drumNotes[a][0],midi:h.drumNotes[a][1],nhd:h.drumNotes[a][2]}}),f=a[g],l=this.vceInst[g]||"",l in c?e.push([f,c[l].concat(k)]):e.push([f,d.concat(k)]);e.sort(function(a,b){return a[0]-b[0]});for(c=0;c<e.length;++c)f=e[c][0],d=e[c][1],this.midiMap.push(d)};n.prototype.parse=function(b){var a=$(b);this.mkTitle(a);this.doDefaults(a);partlist=this.doPartList(a);b=a.find("part");for(var c=0;c<b.length;++c){var a=$(b[c]),d=a.find("measure");this.locStaffMap(a);this.drumNotes={};this.clefOct={};this.msc.initVoices(1);var f=0,e=0;for(this.msr=new H(c);this.msr.ixm<d.length;){var g=$(d[this.msr.ixm]),l=0,k="";this.msr.reset();this.curalts={};for(var h=g.children(),m=0;m<h.length;m++){var n=h[m],a=$(n);switch(n.nodeName){case"note":this.doNote(a);break;case"attributes":this.doAttr(a);break;case"direction":this.doDirection(a);break;case"sound":this.doDirection(g);break;case"harmony":this.doHarmony(a);break;case"barline":l=this.doBarline(a);break;case"backup":a=parseInt(a.find("duration").text());this.msc.incTime(-a);break;case"forward":a=parseInt(a.find("duration").text());this.msc.incTime(a);break;case"print":k=this.doPrint(a)}}this.msc.addBar(k,this.msr);1==l?(e=this.msr.ixm,this.msr.ixm+=1):2==l?1>f?(this.msr.ixm=e,f+=1):(f=0,this.msr.ixm+=1):this.msr.ixm+=1}d=this.msc.outVoices(this.msr.divs,c);this.addStaffMap(d);this.addMidiMap(c,d)}Object.keys(d).length?p.mkHeader(this.gStfMap,partlist,this.midiMap):q("nothing written, %s has no notes ...",[p.fnmext])};vertaal=function(b,a){var c={u:0,b:0,n:0,c:0,v:0,d:0,m:0,x:0,t:0,p:"f"},d;for(d in a)c[d]=a[d];c.p=c.p?c.p.split(","):[];p=new D(".abc","",0,c);c=new n(c);try{c.parse(b)}catch(f){q("** exception occurred: %s",[f])}return[p.outlist.join(""),p.infolist.join("\n")]}})();!function(n){"use strict";function t(n,t){var r=(65535&n)+(65535&t),e=(n>>16)+(t>>16)+(r>>16);return e<<16|65535&r}function r(n,t){return n<<t|n>>>32-t}function e(n,e,o,u,c,f){return t(r(t(t(e,n),t(u,f)),c),o)}function o(n,t,r,o,u,c,f){return e(t&r|~t&o,n,t,u,c,f)}function u(n,t,r,o,u,c,f){return e(t&o|r&~o,n,t,u,c,f)}function c(n,t,r,o,u,c,f){return e(t^r^o,n,t,u,c,f)}function f(n,t,r,o,u,c,f){return e(r^(t|~o),n,t,u,c,f)}function i(n,r){n[r>>5]|=128<<r%32,n[(r+64>>>9<<4)+14]=r;var e,i,a,h,d,l=1732584193,g=-271733879,v=-1732584194,m=271733878;for(e=0;e<n.length;e+=16)i=l,a=g,h=v,d=m,l=o(l,g,v,m,n[e],7,-680876936),m=o(m,l,g,v,n[e+1],12,-389564586),v=o(v,m,l,g,n[e+2],17,606105819),g=o(g,v,m,l,n[e+3],22,-1044525330),l=o(l,g,v,m,n[e+4],7,-176418897),m=o(m,l,g,v,n[e+5],12,1200080426),v=o(v,m,l,g,n[e+6],17,-1473231341),g=o(g,v,m,l,n[e+7],22,-45705983),l=o(l,g,v,m,n[e+8],7,1770035416),m=o(m,l,g,v,n[e+9],12,-1958414417),v=o(v,m,l,g,n[e+10],17,-42063),g=o(g,v,m,l,n[e+11],22,-1990404162),l=o(l,g,v,m,n[e+12],7,1804603682),m=o(m,l,g,v,n[e+13],12,-40341101),v=o(v,m,l,g,n[e+14],17,-1502002290),g=o(g,v,m,l,n[e+15],22,1236535329),l=u(l,g,v,m,n[e+1],5,-165796510),m=u(m,l,g,v,n[e+6],9,-1069501632),v=u(v,m,l,g,n[e+11],14,643717713),g=u(g,v,m,l,n[e],20,-373897302),l=u(l,g,v,m,n[e+5],5,-701558691),m=u(m,l,g,v,n[e+10],9,38016083),v=u(v,m,l,g,n[e+15],14,-660478335),g=u(g,v,m,l,n[e+4],20,-405537848),l=u(l,g,v,m,n[e+9],5,568446438),m=u(m,l,g,v,n[e+14],9,-1019803690),v=u(v,m,l,g,n[e+3],14,-187363961),g=u(g,v,m,l,n[e+8],20,1163531501),l=u(l,g,v,m,n[e+13],5,-1444681467),m=u(m,l,g,v,n[e+2],9,-51403784),v=u(v,m,l,g,n[e+7],14,1735328473),g=u(g,v,m,l,n[e+12],20,-1926607734),l=c(l,g,v,m,n[e+5],4,-378558),m=c(m,l,g,v,n[e+8],11,-2022574463),v=c(v,m,l,g,n[e+11],16,1839030562),g=c(g,v,m,l,n[e+14],23,-35309556),l=c(l,g,v,m,n[e+1],4,-1530992060),m=c(m,l,g,v,n[e+4],11,1272893353),v=c(v,m,l,g,n[e+7],16,-155497632),g=c(g,v,m,l,n[e+10],23,-1094730640),l=c(l,g,v,m,n[e+13],4,681279174),m=c(m,l,g,v,n[e],11,-358537222),v=c(v,m,l,g,n[e+3],16,-722521979),g=c(g,v,m,l,n[e+6],23,76029189),l=c(l,g,v,m,n[e+9],4,-640364487),m=c(m,l,g,v,n[e+12],11,-421815835),v=c(v,m,l,g,n[e+15],16,530742520),g=c(g,v,m,l,n[e+2],23,-995338651),l=f(l,g,v,m,n[e],6,-198630844),m=f(m,l,g,v,n[e+7],10,1126891415),v=f(v,m,l,g,n[e+14],15,-1416354905),g=f(g,v,m,l,n[e+5],21,-57434055),l=f(l,g,v,m,n[e+12],6,1700485571),m=f(m,l,g,v,n[e+3],10,-1894986606),v=f(v,m,l,g,n[e+10],15,-1051523),g=f(g,v,m,l,n[e+1],21,-2054922799),l=f(l,g,v,m,n[e+8],6,1873313359),m=f(m,l,g,v,n[e+15],10,-30611744),v=f(v,m,l,g,n[e+6],15,-1560198380),g=f(g,v,m,l,n[e+13],21,1309151649),l=f(l,g,v,m,n[e+4],6,-145523070),m=f(m,l,g,v,n[e+11],10,-1120210379),v=f(v,m,l,g,n[e+2],15,718787259),g=f(g,v,m,l,n[e+9],21,-343485551),l=t(l,i),g=t(g,a),v=t(v,h),m=t(m,d);return[l,g,v,m]}function a(n){var t,r="";for(t=0;t<32*n.length;t+=8)r+=String.fromCharCode(n[t>>5]>>>t%32&255);return r}function h(n){var t,r=[];for(r[(n.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;for(t=0;t<8*n.length;t+=8)r[t>>5]|=(255&n.charCodeAt(t/8))<<t%32;return r}function d(n){return a(i(h(n),8*n.length))}function l(n,t){var r,e,o=h(n),u=[],c=[];for(u[15]=c[15]=void 0,o.length>16&&(o=i(o,8*n.length)),r=0;16>r;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(h(t)),512+8*t.length),a(i(c.concat(e),640))}function g(n){var t,r,e="0123456789abcdef",o="";for(r=0;r<n.length;r+=1)t=n.charCodeAt(r),o+=e.charAt(t>>>4&15)+e.charAt(15&t);return o}function v(n){return unescape(encodeURIComponent(n))}function m(n){return d(v(n))}function p(n){return g(m(n))}function s(n,t){return l(v(n),v(t))}function C(n,t){return g(s(n,t))}function A(n,t,r){return t?r?s(t,n):C(t,n):r?m(n):p(n)}"function"==typeof define&&define.amd?define(function(){return A}):"object"==typeof module&&module.exports?module.exports=A:n.md5=A}(this);!function(a){function b(){var a=arguments[0],c=b.cache;return c[a]&&c.hasOwnProperty(a)||(c[a]=b.parse(a)),b.format.call(null,c[a],arguments)}function c(a){return"number"==typeof a?"number":"string"==typeof a?"string":Object.prototype.toString.call(a).slice(8,-1).toLowerCase()}function d(a,b){return b>=0&&7>=b&&g[a]?g[a][b]:Array(b+1).join(a)}var e={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/bcdiefguxX/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};b.format=function(a,f){var g,h,i,j,k,l,m,n=1,o=a.length,p="",q=[],r=!0,s="";for(h=0;o>h;h++)if(p=c(a[h]),"string"===p)q[q.length]=a[h];else if("array"===p){if(j=a[h],j[2])for(g=f[n],i=0;i<j[2].length;i++){if(!g.hasOwnProperty(j[2][i]))throw new Error(b('[sprintf] property "%s" does not exist',j[2][i]));g=g[j[2][i]]}else g=j[1]?f[j[1]]:f[n++];if(e.not_type.test(j[8])&&e.not_primitive.test(j[8])&&"function"==c(g)&&(g=g()),e.numeric_arg.test(j[8])&&"number"!=c(g)&&isNaN(g))throw new TypeError(b("[sprintf] expecting number but found %s",c(g)));switch(e.number.test(j[8])&&(r=g>=0),j[8]){case"b":g=parseInt(g,10).toString(2);break;case"c":g=String.fromCharCode(parseInt(g,10));break;case"d":case"i":g=parseInt(g,10);break;case"j":g=JSON.stringify(g,null,j[6]?parseInt(j[6]):0);break;case"e":g=j[7]?parseFloat(g).toExponential(j[7]):parseFloat(g).toExponential();break;case"f":g=j[7]?parseFloat(g).toFixed(j[7]):parseFloat(g);break;case"g":g=j[7]?parseFloat(g).toPrecision(j[7]):parseFloat(g);break;case"o":g=g.toString(8);break;case"s":g=String(g),g=j[7]?g.substring(0,j[7]):g;break;case"t":g=String(!!g),g=j[7]?g.substring(0,j[7]):g;break;case"T":g=c(g),g=j[7]?g.substring(0,j[7]):g;break;case"u":g=parseInt(g,10)>>>0;break;case"v":g=g.valueOf(),g=j[7]?g.substring(0,j[7]):g;break;case"x":g=parseInt(g,10).toString(16);break;case"X":g=parseInt(g,10).toString(16).toUpperCase()}e.json.test(j[8])?q[q.length]=g:(!e.number.test(j[8])||r&&!j[3]?s="":(s=r?"+":"-",g=g.toString().replace(e.sign,"")),l=j[4]?"0"===j[4]?"0":j[4].charAt(1):" ",m=j[6]-(s+g).length,k=j[6]&&m>0?d(l,m):"",q[q.length]=j[5]?s+g+k:"0"===l?s+k+g:k+s+g)}return q.join("")},b.cache={},b.parse=function(a){for(var b=a,c=[],d=[],f=0;b;){
if(null!==(c=e.text.exec(b)))d[d.length]=c[0];else if(null!==(c=e.modulo.exec(b)))d[d.length]="%";else{if(null===(c=e.placeholder.exec(b)))throw new SyntaxError("[sprintf] unexpected placeholder");if(c[2]){f|=1;var g=[],h=c[2],i=[];if(null===(i=e.key.exec(h)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(g[g.length]=i[1];""!==(h=h.substring(i[0].length));)if(null!==(i=e.key_access.exec(h)))g[g.length]=i[1];else{if(null===(i=e.index_access.exec(h)))throw new SyntaxError("[sprintf] failed to parse named argument key");g[g.length]=i[1]}c[2]=g}else f|=2;if(3===f)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");d[d.length]=c}b=b.substring(c[0].length)}return d};var f=function(a,c,d){return d=(c||[]).slice(0),d.splice(0,0,a),b.apply(null,d)},g={0:["","0","00","000","0000","00000","000000","0000000"]," ":[""," ","  ","   ","    ","     ","      ","       "],_:["","_","__","___","____","_____","______","_______"]};"undefined"!=typeof exports?(exports.sprintf=b,exports.vsprintf=f):(a.sprintf=b,a.vsprintf=f,"function"==typeof define&&define.amd&&define(function(){return{sprintf:b,vsprintf:f}}))}("undefined"==typeof window?this:window);var swfobject=function(){var D="undefined",r="object",S="Shockwave Flash",W="ShockwaveFlash.ShockwaveFlash",q="application/x-shockwave-flash",R="SWFObjectExprInst",x="onreadystatechange",O=window,j=document,t=navigator,T=false,U=[h],o=[],N=[],I=[],l,Q,E,B,J=false,a=false,n,G,m=true,M=function(){var aa=typeof j.getElementById!=D&&typeof j.getElementsByTagName!=D&&typeof j.createElement!=D,ah=t.userAgent.toLowerCase(),Y=t.platform.toLowerCase(),ae=Y?/win/.test(Y):/win/.test(ah),ac=Y?/mac/.test(Y):/mac/.test(ah),af=/webkit/.test(ah)?parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):false,X=!+"\x0B1",ag=[0,0,0],ab=null;if(typeof t.plugins!=D&&typeof t.plugins[S]==r){ab=t.plugins[S].description;if(ab&&!(typeof t.mimeTypes!=D&&t.mimeTypes[q]&&!t.mimeTypes[q].enabledPlugin)){T=true;X=false;ab=ab.replace(/^.*\s+(\S+\s+\S+$)/,"$1");ag[0]=parseInt(ab.replace(/^(.*)\..*$/,"$1"),10);ag[1]=parseInt(ab.replace(/^.*\.(.*)\s.*$/,"$1"),10);ag[2]=/[a-zA-Z]/.test(ab)?parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0}}else{if(typeof O.ActiveXObject!=D){try{var ad=new ActiveXObject(W);if(ad){ab=ad.GetVariable("$version");if(ab){X=true;ab=ab.split(" ")[1].split(",");ag=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}}catch(Z){}}}return{w3:aa,pv:ag,wk:af,ie:X,win:ae,mac:ac}}(),k=function(){if(!M.w3){return}if(typeof j.readyState!=D&&j.readyState=="complete"||typeof j.readyState==D&&(j.getElementsByTagName("body")[0]||j.body)){f()}if(!J){if(typeof j.addEventListener!=D){j.addEventListener("DOMContentLoaded",f,false)}if(M.ie&&M.win){j.attachEvent(x,function(){if(j.readyState=="complete"){j.detachEvent(x,arguments.callee);f()}});if(O==top){(function(){if(J){return}try{j.documentElement.doScroll("left")}catch(X){setTimeout(arguments.callee,0);return}f()})()}}if(M.wk){(function(){if(J){return}if(!/loaded|complete/.test(j.readyState)){setTimeout(arguments.callee,0);return}f()})()}s(f)}}();function f(){if(J){return}try{var Z=j.getElementsByTagName("body")[0].appendChild(C("span"));Z.parentNode.removeChild(Z)}catch(aa){return}J=true;var X=U.length;for(var Y=0;Y<X;Y++){U[Y]()}}function K(X){if(J){X()}else{U[U.length]=X}}function s(Y){if(typeof O.addEventListener!=D){O.addEventListener("load",Y,false)}else{if(typeof j.addEventListener!=D){j.addEventListener("load",Y,false)}else{if(typeof O.attachEvent!=D){i(O,"onload",Y)}else{if(typeof O.onload=="function"){var X=O.onload;O.onload=function(){X();Y()}}else{O.onload=Y}}}}}function h(){if(T){V()}else{H()}}function V(){var X=j.getElementsByTagName("body")[0];var aa=C(r);aa.setAttribute("type",q);var Z=X.appendChild(aa);if(Z){var Y=0;(function(){if(typeof Z.GetVariable!=D){var ab=Z.GetVariable("$version");if(ab){ab=ab.split(" ")[1].split(",");M.pv=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}else{if(Y<10){Y++;setTimeout(arguments.callee,10);return}}X.removeChild(aa);Z=null;H()})()}else{H()}}function H(){var ag=o.length;if(ag>0){for(var af=0;af<ag;af++){var Y=o[af].id;var ab=o[af].callbackFn;var aa={success:false,id:Y};if(M.pv[0]>0){var ae=c(Y);if(ae){if(F(o[af].swfVersion)&&!(M.wk&&M.wk<312)){w(Y,true);if(ab){aa.success=true;aa.ref=z(Y);ab(aa)}}else{if(o[af].expressInstall&&A()){var ai={};ai.data=o[af].expressInstall;ai.width=ae.getAttribute("width")||"0";ai.height=ae.getAttribute("height")||"0";if(ae.getAttribute("class")){ai.styleclass=ae.getAttribute("class")}if(ae.getAttribute("align")){ai.align=ae.getAttribute("align")}var ah={};var X=ae.getElementsByTagName("param");var ac=X.length;for(var ad=0;ad<ac;ad++){if(X[ad].getAttribute("name").toLowerCase()!="movie"){ah[X[ad].getAttribute("name")]=X[ad].getAttribute("value")}}P(ai,ah,Y,ab)}else{p(ae);if(ab){ab(aa)}}}}}else{w(Y,true);if(ab){var Z=z(Y);if(Z&&typeof Z.SetVariable!=D){aa.success=true;aa.ref=Z}ab(aa)}}}}}function z(aa){var X=null;var Y=c(aa);if(Y&&Y.nodeName=="OBJECT"){if(typeof Y.SetVariable!=D){X=Y}else{var Z=Y.getElementsByTagName(r)[0];if(Z){X=Z}}}return X}function A(){return!a&&F("6.0.65")&&(M.win||M.mac)&&!(M.wk&&M.wk<312)}function P(aa,ab,X,Z){a=true;E=Z||null;B={success:false,id:X};var ae=c(X);if(ae){if(ae.nodeName=="OBJECT"){l=g(ae);Q=null}else{l=ae;Q=X}aa.id=R;if(typeof aa.width==D||!/%$/.test(aa.width)&&parseInt(aa.width,10)<310){aa.width="310"}if(typeof aa.height==D||!/%$/.test(aa.height)&&parseInt(aa.height,10)<137){aa.height="137"}j.title=j.title.slice(0,47)+" - Flash Player Installation";var ad=M.ie&&M.win?"ActiveX":"PlugIn",ac="MMredirectURL="+O.location.toString().replace(/&/g,"%26")+"&MMplayerType="+ad+"&MMdoctitle="+j.title;if(typeof ab.flashvars!=D){ab.flashvars+="&"+ac}else{ab.flashvars=ac}if(M.ie&&M.win&&ae.readyState!=4){var Y=C("div");X+="SWFObjectNew";Y.setAttribute("id",X);ae.parentNode.insertBefore(Y,ae);ae.style.display="none";(function(){if(ae.readyState==4){ae.parentNode.removeChild(ae)}else{setTimeout(arguments.callee,10)}})()}u(aa,ab,X)}}function p(Y){if(M.ie&&M.win&&Y.readyState!=4){var X=C("div");Y.parentNode.insertBefore(X,Y);X.parentNode.replaceChild(g(Y),X);Y.style.display="none";(function(){if(Y.readyState==4){Y.parentNode.removeChild(Y)}else{setTimeout(arguments.callee,10)}})()}else{Y.parentNode.replaceChild(g(Y),Y)}}function g(ab){var aa=C("div");if(M.win&&M.ie){aa.innerHTML=ab.innerHTML}else{var Y=ab.getElementsByTagName(r)[0];if(Y){var ad=Y.childNodes;if(ad){var X=ad.length;for(var Z=0;Z<X;Z++){if(!(ad[Z].nodeType==1&&ad[Z].nodeName=="PARAM")&&!(ad[Z].nodeType==8)){aa.appendChild(ad[Z].cloneNode(true))}}}}}return aa}function u(ai,ag,Y){var X,aa=c(Y);if(M.wk&&M.wk<312){return X}if(aa){if(typeof ai.id==D){ai.id=Y}if(M.ie&&M.win){var ah="";for(var ae in ai){if(ai[ae]!=Object.prototype[ae]){if(ae.toLowerCase()=="data"){ag.movie=ai[ae]}else{if(ae.toLowerCase()=="styleclass"){ah+=' class="'+ai[ae]+'"'}else{if(ae.toLowerCase()!="classid"){ah+=" "+ae+'="'+ai[ae]+'"'}}}}}var af="";for(var ad in ag){if(ag[ad]!=Object.prototype[ad]){af+='<param name="'+ad+'" value="'+ag[ad]+'" />'}}aa.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+ah+">"+af+"</object>";N[N.length]=ai.id;X=c(ai.id)}else{var Z=C(r);Z.setAttribute("type",q);for(var ac in ai){if(ai[ac]!=Object.prototype[ac]){if(ac.toLowerCase()=="styleclass"){Z.setAttribute("class",ai[ac])}else{if(ac.toLowerCase()!="classid"){Z.setAttribute(ac,ai[ac])}}}}for(var ab in ag){if(ag[ab]!=Object.prototype[ab]&&ab.toLowerCase()!="movie"){e(Z,ab,ag[ab])}}aa.parentNode.replaceChild(Z,aa);X=Z}}return X}function e(Z,X,Y){var aa=C("param");aa.setAttribute("name",X);aa.setAttribute("value",Y);Z.appendChild(aa)}function y(Y){var X=c(Y);if(X&&X.nodeName=="OBJECT"){if(M.ie&&M.win){X.style.display="none";(function(){if(X.readyState==4){b(Y)}else{setTimeout(arguments.callee,10)}})()}else{X.parentNode.removeChild(X)}}}function b(Z){var Y=c(Z);if(Y){for(var X in Y){if(typeof Y[X]=="function"){Y[X]=null}}Y.parentNode.removeChild(Y)}}function c(Z){var X=null;try{X=j.getElementById(Z)}catch(Y){}return X}function C(X){return j.createElement(X)}function i(Z,X,Y){Z.attachEvent(X,Y);I[I.length]=[Z,X,Y]}function F(Z){var Y=M.pv,X=Z.split(".");X[0]=parseInt(X[0],10);X[1]=parseInt(X[1],10)||0;X[2]=parseInt(X[2],10)||0;return Y[0]>X[0]||Y[0]==X[0]&&Y[1]>X[1]||Y[0]==X[0]&&Y[1]==X[1]&&Y[2]>=X[2]?true:false}function v(ac,Y,ad,ab){if(M.ie&&M.mac){return}var aa=j.getElementsByTagName("head")[0];if(!aa){return}var X=ad&&typeof ad=="string"?ad:"screen";if(ab){n=null;G=null}if(!n||G!=X){var Z=C("style");Z.setAttribute("type","text/css");Z.setAttribute("media",X);n=aa.appendChild(Z);if(M.ie&&M.win&&typeof j.styleSheets!=D&&j.styleSheets.length>0){n=j.styleSheets[j.styleSheets.length-1]}G=X}if(M.ie&&M.win){if(n&&typeof n.addRule==r){n.addRule(ac,Y)}}else{if(n&&typeof j.createTextNode!=D){n.appendChild(j.createTextNode(ac+" {"+Y+"}"))}}}function w(Z,X){if(!m){return}var Y=X?"visible":"hidden";if(J&&c(Z)){c(Z).style.visibility=Y}else{v("#"+Z,"visibility:"+Y)}}function L(Y){var Z=/[\\\"<>\.;]/;var X=Z.exec(Y)!=null;return X&&typeof encodeURIComponent!=D?encodeURIComponent(Y):Y}var d=function(){if(M.ie&&M.win){window.attachEvent("onunload",function(){var ac=I.length;for(var ab=0;ab<ac;ab++){I[ab][0].detachEvent(I[ab][1],I[ab][2])}var Z=N.length;for(var aa=0;aa<Z;aa++){y(N[aa])}for(var Y in M){M[Y]=null}M=null;for(var X in swfobject){swfobject[X]=null}swfobject=null})}}();return{registerObject:function(ab,X,aa,Z){if(M.w3&&ab&&X){var Y={};Y.id=ab;Y.swfVersion=X;Y.expressInstall=aa;Y.callbackFn=Z;o[o.length]=Y;w(ab,false)}else{if(Z){Z({success:false,id:ab})}}},getObjectById:function(X){if(M.w3){return z(X)}},embedSWF:function(ab,ah,ae,ag,Y,aa,Z,ad,af,ac){var X={success:false,id:ah};if(M.w3&&!(M.wk&&M.wk<312)&&ab&&ah&&ae&&ag&&Y){w(ah,false);K(function(){ae+="";ag+="";var aj={};if(af&&typeof af===r){for(var al in af){aj[al]=af[al]}}aj.data=ab;aj.width=ae;aj.height=ag;var am={};if(ad&&typeof ad===r){for(var ak in ad){am[ak]=ad[ak]}}if(Z&&typeof Z===r){for(var ai in Z){if(typeof am.flashvars!=D){am.flashvars+="&"+ai+"="+Z[ai]}else{am.flashvars=ai+"="+Z[ai]}}}if(F(Y)){var an=u(aj,am,ah);if(aj.id==ah){w(ah,true)}X.success=true;X.ref=an}else{if(aa&&A()){aj.data=aa;P(aj,am,ah,ac);return}else{w(ah,true)}}if(ac){ac(X)}})}else{if(ac){ac(X)}}},switchOffAutoHideShow:function(){m=false},ua:M,getFlashPlayerVersion:function(){return{major:M.pv[0],minor:M.pv[1],release:M.pv[2]}},hasFlashPlayerVersion:F,createSWF:function(Z,Y,X){if(M.w3){return u(Z,Y,X)}else{return undefined}},showExpressInstall:function(Z,aa,X,Y){if(M.w3&&A()){P(Z,aa,X,Y)}},removeSWF:function(X){if(M.w3){y(X)}},createCSS:function(aa,Z,Y,X){if(M.w3){v(aa,Z,Y,X)}},addDomLoadEvent:K,addLoadEvent:s,getQueryParamValue:function(aa){var Z=j.location.search||j.location.hash;if(Z){if(/\?/.test(Z)){Z=Z.split("?")[1]}if(aa==null){return L(Z)}var Y=Z.split("&");for(var X=0;X<Y.length;X++){if(Y[X].substring(0,Y[X].indexOf("="))==aa){return L(Y[X].substring(Y[X].indexOf("=")+1))}}}return""},expressInstallCallback:function(){if(a){var X=c(R);if(X&&l){X.parentNode.replaceChild(l,X);if(Q){w(Q,true);if(M.ie&&M.win){l.style.display="block"}}if(E){E(B)}}a=false}}}}();AbcDE=function(){"use strict";var Options,Magnification=1,Preferences={},Sequences=[],Grace_Notes_In_Source,Autosaver=undefined,Md5_Key="",Abc_Images,Abc_Fname="noname.abc",Org_Abc_Str,My_Abc,Timer=0,Input_Buffer=[],Open_Ornament=false,Trailing_Characters=[],Current_Note,Current_Line_Number=0,Notes=[],Notes_On_Line=[],Note_At={},Fingered_Note_At={},Sorted_Note_Locations=[],Preprocessing_Completed=false,Staff_Notes_At_Time={},Voice_Staff={},Ref=[],Rerender_Count=0,Fonts_Set_In_Source,Toggled=false,Colcl=[],Persist_Annotated=true,Show_Metadata=false,Ui_In_Place=false;var DIDACTYL_URL="https://dvdrndlph.github.io/didactyl";var HOME_URL=DIDACTYL_URL+"/abcde";var HELP_URL=HOME_URL+"/view/abcde_help.html";var IMAGE_DIR=HOME_URL+"/image";var MEDIA_DIR=HOME_URL+"/lib/media";var FINGER_RE=/\(([<>]\d)+\)|[<>]\d,[<>]\d\/[<>]\d,[<>]\d|[<>]\d\/[<>]\d,[<>]\d|[<>]\d,[<>]\d\/[<>]\d|[<>]\d,[<>]\d|[<>]\d\/[<>]\d|[<>]\d|x/g;var PRESET_RE=/\(([<>]?\d)+\)|[<>]?\d,[<>]?\d\/[<>]?\d,[<>]?\d|[<>]?\d\/[<>]?\d,[<>]?\d|[<>]?\d,[<>]?\d\/[<>]?\d|[<>]?\d,[<>]?\d|[<>]?\d\/[<>]?\d|[<>]?\d|x/g;var SPACE_RE=/\s/g;var LH_REG=/</g;var RH_REG=/>/g;var RL_REG=/[><]/g;var LAST_HAND_RE=/.*([<>])[^<>]+$/;var ABCD_HDR_RE=/^% abcDidactyl v([\d\.]+)$/;var ABCD_FINGERING_RE=/^% abcD fingering (\d+): ([<>1-5,\/\(\)@&x]+)$/;var ABCD_TERMINAL_RE=/^% abcDidactyl END$/;var ABCD_AUTHORITY_RE=/^% Authority: (.*)\s+\((\d\d\d\d)\)$/;var ABCD_TRANSCRIBER_RE=/^% Transcriber: (.*)$/;var ABCD_TRANSCRIPTION_DATE_RE=/^% Transcription date: ((\d\d\d\d\-[01]\d\-[0-3]\d)\s?([0-2]\d:[0-5]\d:[0-5]\d)?)$/;var ABCD_COMMENT_RE=/^% (.*)$/;var TIMEOUT_MS=300;var AUTOSAVE_MS=4e3;var ABCDE_DIV_ID="abcde";var SOURCE_ID="abc_source";var SOURCE_CLASS_ID="source";var PREFS_DIV_ID="abcde_prefs";var CONTROLS_DIV_ID="abcde_controls";var METADATA_DIV_ID="abcde_metadata";var KEYPAD_DIV_ID="abcde_keypad";var RENDERING_DIV_ID="abcde_rendering";var TARGET_DIV_ID="abcde_target";var ERROR_DIV_ID="abcde_error";var MAGNIFICATION_INCREMENT=.1;var MAX_MAGNIFICATION=3;var MIN_MAGNIFICATION=.3;var ENTER_CODE=13;var BACKSPACE_CODE=8;var TAB_CODE=9;var LEFT_ARROW_CODE=37;var RIGHT_ARROW_CODE=39;var SETFONT_COMMANDS="%%setfont-1 Bookman 11\n"+"%%setfont-2 Helvetica-Bold 11";var GRACE_NOTE_DECORATIONS="%%deco 1 3 fng 8 1 1 1\n"+"%%deco 2 3 fng 8 1 1 2\n"+"%%deco 3 3 fng 8 1 1 3\n"+"%%deco 4 3 fng 8 1 1 4\n"+"%%deco 5 3 fng 8 1 1 5";function initialize_globals(){if(Autosaver){clearInterval(Autosaver)}Md5_Key="";Abc_Fname="noname.abc";Grace_Notes_In_Source=undefined;Org_Abc_Str="";My_Abc=undefined;Input_Buffer=[];Open_Ornament=false;Trailing_Characters=[];Current_Note=undefined;Current_Line_Number=0;Notes=[];Notes_On_Line=[];Note_At={};Fingered_Note_At={};Sorted_Note_Locations=[];Preprocessing_Completed=false;Staff_Notes_At_Time={};Voice_Staff={};Ref=[];Rerender_Count=0;Fonts_Set_In_Source=undefined;Colcl=[]}function get_sorted_staff_note_times(staff){var notes_at_time=Staff_Notes_At_Time[staff];var sorted_note_times=[];var key;for(key in notes_at_time){if(notes_at_time.hasOwnProperty(key)){sorted_note_times.push(key)}}sorted_note_times.sort(function(a,b){return parseInt(a)-parseInt(b)});return sorted_note_times}function get_handed_fingering(fingering,starting_hand){if(!fingering){console.log("MISSING fingers have no hands.");return""}if(fingering==="x"){return fingering}var hand=starting_hand;var handed_tokens=[];var chars=fingering.split("");for(var i=0;i<chars.length;i++){var char=chars[i];if(char==="<"||char===">"){hand=char}else if(char.match(/\d/)){handed_tokens.push(hand+char)}else{handed_tokens.push(char)}}return handed_tokens.join("")}function local_storage_is_supported(){if(typeof Storage==="undefined"){return false}return true}function get_storage_key(field_name,sequence_number){if(!Md5_Key){Md5_Key=md5(Org_Abc_Str)}var storage_key=field_name+"_"+sequence_number+"_"+Md5_Key;return storage_key}function get_autosaved_sequence(sequence_number){if(!local_storage_is_supported()){return{}}var saved_seq={sequence:""};var storage_key=get_storage_key("sequence",sequence_number);var stored_fingerings=localStorage.getItem(storage_key)||"";if(stored_fingerings.match(/[^x&@]/)){saved_seq.sequence=stored_fingerings}storage_key=get_storage_key("authority",sequence_number);var stored_authority=localStorage.getItem(storage_key)||"";saved_seq.authority=stored_authority;storage_key=get_storage_key("authority_year",sequence_number);var stored_year=localStorage.getItem(storage_key)||"";saved_seq.authority_year=stored_year;storage_key=get_storage_key("transcriber",sequence_number);var stored_transcriber=localStorage.getItem(storage_key)||"";saved_seq.transcriber=stored_transcriber;storage_key=get_storage_key("comments",sequence_number);var stored_comments=localStorage.getItem(storage_key)||"";saved_seq.comments=stored_comments;return saved_seq}function get_field_value(field_id){var field=document.getElementById(field_id);if(field.value){return field.value}return""}function get_current_sequence(){var current_date=new Date;var date_str=current_date.getFullYear()+"-"+sprintf("%02d",current_date.getMonth()+1)+"-"+sprintf("%02d",current_date.getDate())+" "+sprintf("%02d",current_date.getHours())+":"+sprintf("%02d",current_date.getMinutes())+":"+sprintf("%02d",current_date.getSeconds());var sequence={sequence:abcde$get_entered_collection(),authority:get_field_value("authority"),authority_year:get_field_value("authority_year"),transcriber:get_field_value("transcriber"),transcription_date:date_str,comments:get_field_value("comments")};return sequence}function store_sequence_field(field_id,sequence_id){var field=document.getElementById(field_id);var setting=field.value;var storage_key=get_storage_key(field_id,sequence_id);localStorage.setItem(storage_key,setting)}function get_radio_setting(group_name){var group=document.getElementsByName(group_name);for(var i=0;i<group.length;i++){var button=group[i];if(button.checked){return button.id}}return undefined}function store_preference(field_id){var setting="";if(field_id==="preset"||field_id==="output"||field_id==="keypad"||field_id=="restore"){setting=get_radio_setting(field_id)}else{var field=document.getElementById(field_id);setting=field.value}Preferences[field_id]=setting;localStorage.setItem(field_id,setting)}function get_current_sequence_number(){var sequence_spinner=document.getElementById("sequence_spinner");if(!sequence_spinner){alert("Sequence DOM element has gone missing.");return"1"}return sequence_spinner.value}function autosave(){if(!local_storage_is_supported()){return""}var sequence_number=get_current_sequence_number();var storage_key=get_storage_key("sequence",sequence_number);var fingerings=abcde$get_entered_collection();localStorage.setItem(storage_key,fingerings);store_sequence_field("authority",sequence_number);store_sequence_field("authority_year",sequence_number);store_sequence_field("transcriber",sequence_number);store_sequence_field("comments",sequence_number)}function get_setting(arg){if(Options&&Options[arg]){return Options[arg]}var preference=get_radio_setting(arg);if(preference){return preference}return""}function get_default_sequence_number(){var setting=get_setting("preset");var number=1;if(setting==="last"){number=Sequences.length||1}return number}function get_sequences(abcd_str){var lines=abcd_str.split("\n");var match;var within_abcd_block=false;var seq={};var sequences=[];var input_abcde_version="";for(var i=0;i<lines.length;i++){var line=lines[i];if(!input_abcde_version){match=ABCD_HDR_RE.exec(line);if(match&&match[1]){input_abcde_version=match[1];within_abcd_block=true;continue}}if(within_abcd_block){match=ABCD_FINGERING_RE.exec(line);if(match&&match[1]&&match[2]){seq={sequence:match[2],comments:""};sequences.push(seq)}else{match=ABCD_TERMINAL_RE.exec(line);if(match){break}match=ABCD_AUTHORITY_RE.exec(line);if(match&&match[1]){seq.authority=match[1];if(match[2]){seq.authority_year=match[2]}continue}match=ABCD_TRANSCRIBER_RE.exec(line);if(match&&match[1]){seq.transcriber=match[1];continue}match=ABCD_TRANSCRIPTION_DATE_RE.exec(line);if(match&&match[1]){seq.transcription_date=match[1];continue}match=ABCD_COMMENT_RE.exec(line);if(match&&match[1]){seq.comments+=match[1]+"\n"}}}}return sequences}function set_default_sequence(){var sequence_spinner=document.getElementById("sequence_spinner");sequence_spinner.min=1;sequence_spinner.max=Sequences.length||1;var default_sequence_number=get_default_sequence_number();sequence_spinner.value=default_sequence_number}function get_default_sequence(){var setting=get_setting("preset");if(!setting||setting==="none"){return""}else if(setting==="first"){return Sequences[0]}else if(setting==="last"){return Sequences[Sequences.length-1]}return""}function get_preset_sequence(sequence_number){if(sequence_number){var sequence_index=sequence_number-1;if(parseInt(sequence_number)<=Sequences.length){return Sequences[sequence_index]}else{return""}}return get_default_sequence()}function set_radio(group_name,value){var group=document.getElementsByName(group_name);for(var i=0;i<group.length;i++){var button=group[i];if(button.id===value){button.checked=true}}}function set_field(field_id,value){var field=document.getElementById(field_id);if(value){field.value=value}else{field.value=""}}function preset_preferences(){set_radio("preset",localStorage.getItem("preset"));set_radio("output",localStorage.getItem("output"));set_radio("restore",localStorage.getItem("restore"));set_radio("keypad",localStorage.getItem("keypad"));set_field("default_authority",localStorage.getItem("default_authority"));set_field("default_authority_year",localStorage.getItem("default_authority_year"));set_field("default_transcriber",localStorage.getItem("default_transcriber"))}function restore_metadata(metadata){set_field("authority",metadata.authority);set_field("authority_year",metadata.authority_year);set_field("transcriber",metadata.transcriber);set_field("comments",metadata["comments"])}function preset_sequence(){var sequence_number=get_current_sequence_number();var autosaved=get_autosaved_sequence(sequence_number);var preset=get_preset_sequence(sequence_number);set_sequence(sequence_number,autosaved,preset)}function set_sequence(autosaved,preset){var finger_str=preset.sequence;var presetting=true;var setting=get_setting("preset");if(!setting||setting==="none"){presetting=false;finger_str=""}var should_restore=false;if(autosaved.sequence&&autosaved.sequence!==finger_str){var restore_setting=get_setting("restore");if(restore_setting==="always"){should_restore=true}else if(restore_setting==="never"){should_restore=false}else{should_restore=confirm("You have previously entered data for this piece. "+"Do you want to restore them?")}if(should_restore){finger_str=autosaved.sequence}}if(should_restore){restore_metadata(autosaved)}else if(presetting){restore_metadata(preset)}if(finger_str){console.log("Presetting fingers: ",finger_str);var staff_fingerings={};var staff_lines=finger_str.split("@");var staff_num;var line_num;var fingering;for(staff_num=0;staff_num<staff_lines.length;staff_num++){var hand=get_staff_hand(staff_num);staff_fingerings=[];var finger_lines=staff_lines[staff_num].split("&");for(line_num=0;line_num<finger_lines.length;line_num++){var finger_line=finger_lines[line_num];staff_fingerings=staff_fingerings.concat(get_tokens(PRESET_RE,finger_line))}var sorted_staff_note_times=get_sorted_staff_note_times(staff_num);for(var time_index=0;time_index<sorted_staff_note_times.length;time_index++){var time=sorted_staff_note_times[time_index];var notes=Staff_Notes_At_Time[staff_num][time];notes.sort(order_notes);if(notes[0].grace){notes[0].fingering="";for(var i=0;i<notes[0].size;i++){fingering=staff_fingerings.shift();if(!fingering){console.log("Preset fingering MISSING for note:");print_note("preset grace note",notes[0])}fingering=get_handed_fingering(fingering,hand);hand=get_new_last_hand(fingering,hand);notes[0].fingering+=fingering}}var notes_with_pit=get_sorted_synchronous_notes_with_pit(notes);var pits=get_sorted_synchronous_pits(notes_with_pit);for(i=0;i<pits.length;i++){var pit=pits[i];for(var j=0;j<notes_with_pit[pit].length;j++){var pit_note=notes_with_pit[pit][j];pit_note.fingering=""}}for(i=0;i<pits.length;i++){var pit=pits[i];for(var j=0;j<notes_with_pit[pit].length;j++){var pit_note=notes_with_pit[pit][j];if(pit_note.grace){continue}if(!pit_note.fingering){pit_note.fingering=""}fingering=staff_fingerings.shift();if(!fingering){console.log("Preset fingering MISSING for note:");print_note("preset pit note",pit_note)}fingering=get_handed_fingering(fingering,hand);hand=get_new_last_hand(fingering,hand);pit_note.fingering+=fingering}}}}}Autosaver=setInterval(function(){autosave()},AUTOSAVE_MS)}function get_tokens(re,line){if(!line){return[]}var matches=[];var match;var start_index=0;var end_index=0;while((match=re.exec(line))!=null){end_index=re.lastIndex;var token_str;if(start_index===end_index){token_str=line.substr(start_index)}else{token_str=line.substr(start_index,end_index-start_index)}matches.push(token_str);start_index=re.lastIndex}var remainder=line.substr(start_index);if(remainder){var last_match="";if(matches.length>0){last_match=matches.pop()}last_match+=remainder;matches.push(last_match)}return matches}function show_help(){var help_window=window.open(HELP_URL,"_blank");help_window.focus()}function open_preferences(e){unhandle_keys();var modal_wrapper=document.getElementById("modal_wrapper");var modal_window=document.getElementById("modal_window");modal_wrapper.className="overlay";var overflow=modal_window.offsetHeight-document.documentElement.clientHeight;if(overflow>0){modal_window.style.maxHeight=parseInt(window.getComputedStyle(modal_window).height)-overflow+"px"}modal_window.style.marginTop=-modal_window.offsetHeight/2+"px";modal_window.style.marginLeft=-modal_window.offsetWidth/2+"px";e.preventDefault?e.preventDefault():e.returnValue=false}function zoom_out(){if(Magnification>MIN_MAGNIFICATION){Magnification-=MAGNIFICATION_INCREMENT;rerender()}}function zoom_in(){if(Magnification<MAX_MAGNIFICATION){Magnification+=MAGNIFICATION_INCREMENT;rerender()}}function close_preferences(e){store_preference("preset");store_preference("output");store_preference("restore");store_preference("keypad");store_preference("default_authority");store_preference("default_authority_year");store_preference("default_transcriber");var modal_wrapper=document.getElementById("modal_wrapper");modal_wrapper.className="";show_keypad();handle_keys();e.preventDefault?e.preventDefault():e.returnValue=false}function get_xml_encoding(data){var head=data.slice(0,100);if(head.indexOf("<?xml")==-1){return false}var encoding_match=head.match(/encoding="([^"]+)"/);var encoding="utf-8";if(encoding_match&&encoding_match.length==2){encoding=encoding_match[1]}return encoding}function xml2abc(data){var xml_options={};var xml_data=$.parseXML(data);var result=vertaal(xml_data,xml_options);var abc=result[0];var error_txt=result[1];if(error_txt){console.log("xml2abc ERROR: "+error_txt)}if(!abc){alert("Unable to open MusicXML file: "+error_txt)}return abc}function create_cors_request(method,url){var xhr=new XMLHttpRequest;if("withCredentials"in xhr){xhr.open(method,url,true)}else if(typeof XDomainRequest!="undefined"){xhr=new XDomainRequest;xhr.open(method,url)}else{xhr=null}return xhr}function get_extension(file_path){var name_tokens=file_path.split(".");return name_tokens[name_tokens.length-1]}function mxl2abc(data){var content="";try{var zip=new JSZip(data);$.each(zip.files,function(index,zip_entry){content=zip_entry.asText()})}catch(e){alert("Could not open compressed MusicXML file: "+e.message);return""}var encoding=get_xml_encoding(content);if(encoding!=="UTF-8"){alert("Input mxl is not UTF-8 encoded. Cannot open.");return""}else{content=xml2abc(content)}return content}function make_cors_request(url){var extension=get_extension(url);var error_msg="The server hosting file does not allow access from this domain. "+'Please download the file outside abcDE and then "Choose file" to work with it.';var xhr=create_cors_request("GET",url);if(!xhr){alert(error_msg);return}if(extension==="mxl"){xhr.responseType="arraybuffer"}xhr.onload=function(){console.log("File has been retrieved.");var content="";if(extension==="mxl"){content=mxl2abc(xhr.response);if(!content){return}}else{content=xhr.responseText;var xml_encoding=get_xml_encoding(content);if(xml_encoding){if(!/^utf/i.test(xml_encoding)){alert("Input xml is not UTF-8 encoded. Cannot open.");return}else{content=xml2abc(content)}}}if(content){document.getElementById(SOURCE_ID).value=content;abcde$render(Options)}};xhr.onerror=function(){alert(error_msg)};xhr.send()}function import_url(){var prompt="Please enter URL for abc file to open.";var default_url=DIDACTYL_URL+"/abc/OpenWTC/pf02.abc";var url=window.prompt(prompt,default_url);if(url!==null){make_cors_request(url)}}function import_mxl_file(file){var reader=new FileReader;var content="";reader.onload=function(e){try{var zip=new JSZip(e.target.result);$.each(zip.files,function(index,zip_entry){content=zip_entry.asText()})}catch(e){alert("Could not open compressed MusicXML file: "+e.message);return}var encoding=get_xml_encoding(content);if(encoding!=="UTF-8"){alert("Input xml is not UTF-8 encoded. Cannot open.");return}else{content=xml2abc(content);document.getElementById(SOURCE_ID).value=content;abcde$render(Options)}};reader.readAsArrayBuffer(file)}function import_file(){var file_control=document.getElementById("file_input");var files=file_control.files;if(!files.length){alert("Please select a valid abc file.");return}var file=files[0];var extension=get_extension(file.name);if(extension==="mxl"){import_mxl_file(file);return}var is_xml=false;var encoding_reader=new FileReader;encoding_reader.onload=function(e){var encoding=get_xml_encoding(encoding_reader.result);var reader=new FileReader;if(encoding){is_xml=true}else{encoding="UTF-8"}reader.onload=function(e){var content="";if(is_xml){content=xml2abc(reader.result)}else{content=e.target.result}document.getElementById(SOURCE_ID).value=content;abcde$render(Options)};reader.readAsText(file,encoding)};encoding_reader.readAsText(file,"UTF-8")}function toggle_persistence(){if(Persist_Annotated){Persist_Annotated=false}else{Persist_Annotated=true}}function toggle_show_metadata(){if(Show_Metadata){Show_Metadata=false;handle_keys()}else{Show_Metadata=true;unhandle_keys()}show_metadata()}function show_keypad(){var keypad_div=document.getElementById(KEYPAD_DIV_ID);var setting=get_setting("keypad");if(setting==="show"){keypad_div.style.display="block"}else{keypad_div.style.display="none"}}function show_metadata(){var metadata_div=document.getElementById(METADATA_DIV_ID);if(Show_Metadata){metadata_div.style.display="block"}else{metadata_div.style.display="none"}}function digits_only(event){var key=event.keyCode||event.which;key=String.fromCharCode(key);var regex=/[0-9]/;if(!regex.test(key)){event.returnValue=false;if(event.preventDefault){event.preventDefault()}}}function insert_text_field(container,id,prompt,html_class,validator,add_break){var field=document.createElement("input");field.type="text";field.class=html_class;field.id=id;if(validator){field.onkeypress=validator}if(html_class==="year"){field.size="4"}var label=document.createElement("label");label.htmlFor=id;label.appendChild(document.createTextNode(prompt));container.appendChild(label);container.appendChild(field);if(add_break){container.appendChild(document.createElement("br"))}}function insert_text_area(container,id,prompt,html_class,row_count){var field=document.createElement("textarea");field.class=html_class;field.id=id;field.rows=row_count;var label=document.createElement("label");label.htmlFor=id;label.appendChild(document.createTextNode(prompt));container.appendChild(label);container.appendChild(field)}function insert_label(container,text,html_class){var label=document.createElement("label");label.class=html_class;var text_node=document.createTextNode(text);label.appendChild(text_node);container.appendChild(label)}function insert_radio_buttons(container,prompt,name,ids,labels,selected,add_break){var radio_div=document.createElement("div");radio_div.class="radio_div";insert_label(container,prompt,"prompt");for(var i=0;i<ids.length;i++){var radio=document.createElement("input");radio.type="radio";radio.id=ids[i];if(radio.id===selected){radio.checked=true}radio.name=name;radio_div.appendChild(radio);insert_label(radio_div,labels[i],"radio_label");var space=document.createElement("span");space.innerHTML="&nbsp;&nbsp";radio_div.appendChild(space)}container.appendChild(radio_div);if(add_break){container.appendChild(document.createElement("br"))}}function insert_preference_fields(){var prefs_holder=document.getElementById(PREFS_DIV_ID);
var modal_wrapper=document.createElement("div");modal_wrapper.id="modal_wrapper";prefs_holder.appendChild(modal_wrapper);var modal_window=document.createElement("div");modal_window.id="modal_window";modal_wrapper.appendChild(modal_window);var close_div=document.createElement("div");close_div.style.textAlign="right";var closer=document.createElement("a");closer.id="modal_close";closer.href="#";closer.innerHTML="Close <b>X</b>";close_div.appendChild(closer);closer.addEventListener("click",close_preferences,false);modal_window.appendChild(close_div);var h=document.createElement("h3");h.innerText="Preferences";modal_window.appendChild(h);var radio_name="restore";var button_ids=["always","never","ask"];var button_labels=["Always","Never","Ask"];insert_radio_buttons(modal_window,"Restore Data",radio_name,button_ids,button_labels,"ask",true);var radio_name="output";var button_ids=["append","replace"];var button_labels=["Append","Replace"];insert_radio_buttons(modal_window,"Output",radio_name,button_ids,button_labels,"append",true);radio_name="preset";var button_ids=["first","last","none"];var button_labels=["First","Last","None"];insert_radio_buttons(modal_window,"Preset",radio_name,button_ids,button_labels,"first",true);radio_name="keypad";var button_ids=["show","hide"];var button_labels=["Show","Hide"];var default_keypad_setting="hide";var has_touch="ontouchstart"in window;if(has_touch){default_keypad_setting="show"}insert_radio_buttons(modal_window,"Keypad",radio_name,button_ids,button_labels,default_keypad_setting,true);insert_text_field(modal_window,"default_authority","Default Authority","name",undefined,true);insert_text_field(modal_window,"default_authority_year","Year","year",digits_only,true);insert_text_field(modal_window,"default_transcriber","Transcriber Name","name",undefined,true)}function insert_keypad_button(container,button_id,value){var button=document.createElement("input");button.type="button";button.class="keypad-button";button.id=button_id;button.value=value;button.onclick=function(){buffer_character_input(value)};container.appendChild(button)}function handle_qualtrics_click(button_id){var qualtrics=get_setting("qualtrics");var x_val=abcde$get_x_value(Org_Abc_Str);var result_store="result_"+x_val;var fingerings=abcde$get_entered_collection();console.log("SETTING "+result_store+" to "+fingerings);Qualtrics.SurveyEngine.setEmbeddedData(result_store,fingerings);if(button_id==="q_next"){qualtrics.clickNextButton()}else{qualtrics.clickPreviousButton()}}function insert_qualtrics_button(container,button_id,value){var button=document.createElement("input");button.type="button";button.class="keypad-button";button.id=button_id;button.value=value;button.onclick=function(){handle_qualtrics_click(button_id)};container.appendChild(button)}function insert_keypad_image_button(container,button_id,file_name,alt){var button=document.createElement("input");button.id=button_id;button.class="keypad_button";button.type="image";button.src=IMAGE_DIR+"/"+file_name;button.alt=alt;button.onclick=function(){handle_navigation_input(button_id)};container.appendChild(button)}function insert_keypad(){var keypad_div=document.getElementById(KEYPAD_DIV_ID);var number_div=document.createElement("number_div");var symbol_div=document.createElement("symbol_div");keypad_div.appendChild(symbol_div);keypad_div.appendChild(document.createElement("br"));keypad_div.appendChild(number_div);insert_keypad_button(number_div,"one","1");insert_keypad_button(number_div,"two","2");insert_keypad_button(number_div,"three","3");insert_keypad_button(number_div,"four","4");insert_keypad_button(number_div,"five","5");insert_keypad_image_button(number_div,"pencil","target.svg","...");var using_qualtrics=get_setting("qualtrics");if(using_qualtrics){insert_qualtrics_button(number_div,"q_back","BACK");insert_qualtrics_button(number_div,"q_next","NEXT")}insert_keypad_image_button(symbol_div,"previous","arrow-circle-left.svg","<-");insert_keypad_image_button(symbol_div,"next","arrow-circle-right.svg","->");insert_keypad_button(symbol_div,"comma",",");insert_keypad_button(symbol_div,"slash","/");insert_keypad_button(symbol_div,"open_paren","(");insert_keypad_button(symbol_div,"close_paren",")");insert_keypad_button(symbol_div,"toggle","T");insert_keypad_image_button(symbol_div,"backspace","delete.svg","<]")}function insert_metadata_fields(){var metadata_div=document.getElementById(METADATA_DIV_ID);metadata_div.class="right_aligned";metadata_div.align="center";insert_text_field(metadata_div,"authority","Authority","name",undefined,false);insert_text_field(metadata_div,"authority_year","Year","year",digits_only,true);insert_text_field(metadata_div,"transcriber","Transcriber","name",undefined,true);insert_text_area(metadata_div,"comments","Comments","comments",5,true)}function insert_controls(){if(Ui_In_Place){return}insert_preference_fields();insert_metadata_fields();show_metadata();var save_button=IMAGE_DIR+"/download_36_x4.png";var button_width="36";var control_div=document.getElementById(CONTROLS_DIV_ID);var table=document.createElement("table");var tbody=document.createElement("tbody");var row=document.createElement("tr");control_div.appendChild(table);table.appendChild(tbody);table.style.backgroundColor="LightGray";table.align="center";tbody.appendChild(row);var downloadify=document.createElement("p");downloadify.setAttribute("id","downloadify");var cell=document.createElement("td");cell.appendChild(downloadify);row.appendChild(cell);var sequence_spinner=document.createElement("input");sequence_spinner.id="sequence_spinner";sequence_spinner.min="1";sequence_spinner.max="999";sequence_spinner.size=3;sequence_spinner.type="number";sequence_spinner.alt="fingering_number";sequence_spinner.value=1;sequence_spinner.onchange=load_fingering;cell=document.createElement("td");insert_label(cell,"Sequence","sequence_prompt");cell.appendChild(sequence_spinner);row.appendChild(cell);if(!Options.preset_select){cell.style.display="none"}var view_button=document.createElement("input");view_button.type="image";view_button.src=IMAGE_DIR+"/eye.svg";view_button.width=button_width;view_button.alt="View";view_button.onclick=view_source;cell=document.createElement("td");cell.appendChild(view_button);row.appendChild(cell);var print_button=document.createElement("input");print_button.type="image";print_button.src=IMAGE_DIR+"/print.svg";print_button.width=button_width;print_button.alt="Print...";print_button.onclick=print_score;var cell=document.createElement("td");cell.appendChild(print_button);row.appendChild(cell);cell=document.createElement("td");var checkbox=document.createElement("input");checkbox.type="checkbox";checkbox.value="annotated";checkbox.checked=Persist_Annotated;checkbox.id="view_annotated";checkbox.onclick=toggle_persistence;var label=document.createElement("label");label.htmlFor="view_annotated";label.appendChild(document.createTextNode("Annotated"));cell.appendChild(checkbox);cell.appendChild(label);row.appendChild(cell);var url_button=document.createElement("input");url_button.type="image";url_button.src=IMAGE_DIR+"/globe.svg";url_button.width=button_width;url_button.alt="URL";url_button.onclick=import_url;cell=document.createElement("td");cell.appendChild(url_button);row.appendChild(cell);if(!Options.url_input){url_button.style.visibility="hidden"}var file_input=document.createElement("input");file_input.setAttribute("type","file");file_input.setAttribute("accept","text/vnd.abc");file_input.onchange=import_file;file_input.setAttribute("id","file_input");cell=document.createElement("td");cell.appendChild(file_input);row.appendChild(cell);if(!Options.file_input){file_input.style.visibility="hidden"}cell=document.createElement("td");checkbox=document.createElement("input");checkbox.type="checkbox";checkbox.value="comment";checkbox.checked=Show_Metadata;checkbox.id="show_metadata";checkbox.onclick=toggle_show_metadata;label=document.createElement("label");label.htmlFor="show_metadata";label.appendChild(document.createTextNode("Comment"));cell.appendChild(checkbox);cell.appendChild(label);row.appendChild(cell);var zoom_out_button=document.createElement("input");zoom_out_button.type="image";zoom_out_button.src=IMAGE_DIR+"/zoom-out.svg";zoom_out_button.alt="Zoom In";zoom_out_button.width=button_width;zoom_out_button.onclick=zoom_out;cell=document.createElement("td");cell.appendChild(zoom_out_button);row.appendChild(cell);var zoom_in_button=document.createElement("input");zoom_in_button.type="image";zoom_in_button.src=IMAGE_DIR+"/zoom-in.svg";zoom_in_button.alt="Zoom In";zoom_in_button.width=button_width;zoom_in_button.onclick=zoom_in;cell=document.createElement("td");cell.appendChild(zoom_in_button);row.appendChild(cell);var prefs_button=document.createElement("input");prefs_button.type="image";prefs_button.src=IMAGE_DIR+"/cog.svg";prefs_button.alt="Preferences...";prefs_button.width=button_width;prefs_button.onclick=open_preferences;cell=document.createElement("td");cell.appendChild(prefs_button);row.appendChild(cell);var help_button=document.createElement("input");help_button.type="image";help_button.src=IMAGE_DIR+"/info.svg";help_button.alt="Help";help_button.width=button_width;help_button.onclick=show_help;cell=document.createElement("td");cell.appendChild(help_button);row.appendChild(cell);Downloadify.create("downloadify",{filename:function(){return Abc_Fname},data:function(){var abc_str=get_fingered_abc_str();var abcd_str=get_abcd(abc_str);return abcd_str},onComplete:function(){alert("Your file has been saved.")},onCancel:function(){alert("File save has been cancelled.")},onError:function(){alert("File save failed!")},transparent:false,swf:MEDIA_DIR+"/downloadify.swf",downloadImage:save_button,width:button_width,height:button_width,append:false});insert_keypad();Ui_In_Place=true}function print_note(tag,note){console.log(tag+" Line: "+note.line+" Start: "+note.start+" Time: "+note.time+" String: "+note.string+" Size: "+note.size+" Pitch: "+note.pitches.join(",")+" Voice: "+note.voice+" Staff: "+note.staff+" Grace: "+note.grace)}function store_note_from_symbol(music_types,elem){if(music_types[elem.type]!="note"&&music_types[elem.type]!="grace"){return{}}var note={};note.line=-1;note.grace=false;note.anno_start=elem.istart;var size=0;var pits=[];if(music_types[elem.type]==="note"){size=elem.notes.length;for(var i=0;i<size;i++){pits.push(elem.notes[i].pit)}pits.sort(function(a,b){return parseInt(a)-parseInt(b)});note.start=elem.istart;note.end=elem.iend}else{var starts=[];var stops=[];note.grace=true;i;note.start=elem.extra.istart;size=1;var last_note=elem.extra;if(!last_note.notes){alert("Who turned off the notes?!");return{}}while(true){if(last_note.notes.length>1){alert('Chords not supported in a grace "note."')}starts.push(last_note.istart);stops.push(last_note.iend);pits.push(last_note.notes[0].pit);if(!last_note.next){note.end=last_note.iend;break}last_note=last_note.next;size++}note.starts=starts;note.stops=stops}note.time=elem.time;note.size=size;note.pitches=pits;note.string=Org_Abc_Str.substring(note.start,note.end);note.voice=elem.v;note.staff=elem.st;Notes.push(note);Note_At[elem.istart]=note;if(!(note.staff in Staff_Notes_At_Time)){Staff_Notes_At_Time[note.staff]={}}if(!(note.time in Staff_Notes_At_Time[note.staff])){Staff_Notes_At_Time[note.staff][note.time]=[]}Staff_Notes_At_Time[note.staff][note.time].push(note);return note}function get_score_width(){var width_in_inches=8.5;if(Magnification!==1){width_in_inches*=Magnification}var width_str='width="'+width_in_inches+'in"';return width_str}function User(){this.read_file=function(fn){return""};this.errmsg=function(msg,l,c){var diverr=document.getElementById(ERROR_DIV_ID);if(l)diverr.innerHTML+='<b onclick="gotoabc('+l+","+c+')" style="cursor: pointer; display: inline-block">'+msg+"</b><br/>\n";else diverr.innerHTML+=msg+"<br/>\n"};this.img_out=function(str){var re=/<svg /;if(str.match(re)){Current_Line_Number++}Abc_Images+=str};this.anno_start=function(type,start,stop,x,y,w,h){if(!Preprocessing_Completed&&start in Note_At){Note_At[start].line=Current_Line_Number}else if(type==="grace"){console.log(type+" ANNO_START start: "+start+" stop: "+stop)}Ref.push([start,stop]);My_Abc.out_svg('<g class="e_'+start+'">\n')};this.anno_stop=function(type,start,stop,x,y,w,h){if(type==="grace"){console.log(type+" ANNO_STOP start: "+start+" stop: "+stop)}My_Abc.out_svg("</g>\n");My_Abc.out_svg('<rect class="abcr _'+start+'" x="');My_Abc.out_sxsy(x,'" y="',y);My_Abc.out_svg('" width="'+w.toFixed(2)+'" height="'+h.toFixed(2)+'"/>\n')};this.get_abcmodel=function(tsfirst,voice_tb,music_types){if(Preprocessing_Completed){return}console.log(music_types);for(var v=0;v<voice_tb.length;v++){console.log("Voice: "+v);var staff_id=voice_tb[v].st;Voice_Staff[v]=staff_id}var elem=tsfirst;while(elem){store_note_from_symbol(music_types,elem);elem=elem.ts_next}};this.page_format=false;this.imagesize=get_score_width()}function order_notes(a,b){var time_order=parseInt(a.time)-parseInt(b.time);if(time_order!==0){return time_order}if(a.grace&&b.grace){alert("Conflicting grace notes.")}if(a.grace){return-1}if(b.grace){return 1}if(a.pitches[a.pitches.length-1]<b.pitches[0]){return-1}if(a.pitches[0]>b.pitches[b.pitches.length-1]){return 1}if(a.voice<b.voice){console.log("NOTES SORTED BY VOICE!");return-1}return 1}function sort_notes_in_finger_order(){var note,line,staff;for(var i=0;i<Notes.length;i++){note=Notes[i];line=note.line;staff=note.staff;if(!(line in Notes_On_Line)){Notes_On_Line[line]=[];Notes_On_Line[line][0]=[];Notes_On_Line[line][1]=[]}Notes_On_Line[line][staff].push(note)}for(line=0;line<Notes_On_Line.length;line++){for(staff=0;staff<2;staff++){var staff_line_notes=Notes_On_Line[line][staff];staff_line_notes.sort(order_notes)}}var this_note,prior_note;for(staff=0;staff<2;staff++){for(line=0;line<Notes_On_Line.length;line++){var staff_line_notes=Notes_On_Line[line][staff];for(i=0;i<staff_line_notes.length;i++){this_note=staff_line_notes[i];if(!prior_note){prior_note=this_note;this_note.prior_note=undefined;continue}prior_note.next_note=this_note;this_note.prior_note=prior_note;prior_note=this_note}}}this_note.next_note=undefined}function sort_note_locations(){var key;for(key in Note_At){if(Note_At.hasOwnProperty(key)){Sorted_Note_Locations.push(key)}}Sorted_Note_Locations.sort(function(a,b){return parseInt(a)-parseInt(b)})}function get_font_for_hand(hand){var font="$1";if(hand.match(RH_REG)){font="$1"}if(hand.match(LH_REG)){font="$2"}return font}function get_ornament_annotation_sequence(fingering,staff){var lh_font=get_font_for_hand("<");var rh_font=get_font_for_hand(">");var cooked_fingering=fingering.replace(/[\)\(]/g,"");var fingers=get_tokens(FINGER_RE,cooked_fingering);var position=get_annotation_position(staff);var annotation_str='"'+position;for(var i=0;i<fingers.length;i++){fingers[i]=fingers[i].replace(LH_REG,lh_font);fingers[i]=fingers[i].replace(RH_REG,rh_font);annotation_str+=fingers[i]}annotation_str+='"';return annotation_str}function get_annotation_position(staff){var position="^";if(staff==1){position="_"}return position}function get_annotation_sequence(fingers,staff,pad_missing_fingers){var actual_finger_seen=false;var lh_font=get_font_for_hand("<");var rh_font=get_font_for_hand(">");var annotations=[];for(var i=0;i<fingers.length;i++){var annotation="";var finger="x";if(fingers[i]&&fingers[i]!=="x"){actual_finger_seen=true;finger=fingers[i]}else if(!pad_missing_fingers){break}if(finger.match(/^\(/)){annotation=get_ornament_annotation_sequence(finger,staff)}else{finger=finger.replace(LH_REG,lh_font);finger=finger.replace(RH_REG,rh_font);var position=get_annotation_position(staff);annotation='"'+position+finger+'"'}annotations.unshift(annotation)}var annotation_str="";if(actual_finger_seen){annotation_str=annotations.join("")}return annotation_str}function get_single_note_annotation(note){var finger_str=note.fingering;if(finger_str==="x"){return""}finger_str=finger_str.replace(SPACE_RE,"");var fingers=get_tokens(FINGER_RE,finger_str);var note_annotation=get_annotation_sequence(fingers,note.staff,false);return note_annotation}function get_sorted_synchronous_pits(notes_with_pits){var pits=[];for(var pit in notes_with_pits){if(notes_with_pits.hasOwnProperty(pit)){pits.push(pit)}}pits.sort(function(a,b){return parseInt(a)-parseInt(b)});return pits}function get_sorted_synchronous_notes_with_pit(synchronous_notes){var pits=[];var notes_with_pit={};for(var i=0;i<synchronous_notes.length;i++){var test_note=synchronous_notes[i];if(test_note.grace){continue}for(var j=0;j<test_note.pitches.length;j++){var pit=test_note.pitches[j];pits.push(pit);if(!(pit in notes_with_pit)){notes_with_pit[pit]=[]}notes_with_pit[pit].push(test_note)}}for(i=0;i<notes_with_pit.length;i++){notes_with_pit[i].sort(order_notes)}return notes_with_pit}function get_synchronous_fingering_array(synchronous_notes){var notes_with_pit=get_sorted_synchronous_notes_with_pit(synchronous_notes);var pits=get_sorted_synchronous_pits(notes_with_pit);var ordered_fingers=[];for(var i=0;i<pits.length;i++){var pit=pits[i];for(var j=0;j<notes_with_pit[pit].length;j++){var pit_note=notes_with_pit[pit][j];var note_finger_str=pit_note.fingering;var fingers=get_tokens(FINGER_RE,note_finger_str);for(var k=0;k<pit_note.pitches.length;k++){var pn_pit=pit_note.pitches[k];if(pn_pit===parseInt(pit)){if(fingers[k]!=="x"){ordered_fingers.push(fingers[k])}else{ordered_fingers.push("")}}}}}return ordered_fingers}function get_grace_note_count(synchronous_notes){var count=0;for(var i=0;i<synchronous_notes.length;i++){if(synchronous_notes[i].grace){count++}}return count}function get_note_annotation(note){if(note.size>1){console.log("BIGGIE")}if(note.grace){return get_single_note_annotation(note)}var synchronous_notes=Staff_Notes_At_Time[note.staff][note.time];var grace_note_count=get_grace_note_count(synchronous_notes);var big_note_count=synchronous_notes.length-grace_note_count;if(big_note_count<2){return get_single_note_annotation(note)}synchronous_notes.sort(order_notes);var lowest_note=synchronous_notes[0];if(synchronous_notes[0].grace){lowest_note=synchronous_notes[1]}if(note!==lowest_note){return""}var ordered_fingers=get_synchronous_fingering_array(synchronous_notes);return get_annotation_sequence(ordered_fingers,note.staff,true)}function get_grace_note_tokens(note){var tokens=[];var str=note.string;var starts=note.starts;var stops=note.stops;var normalized_starts=[];var normalized_stops=[];for(var i=0;i<starts.length;i++){normalized_starts.push(starts[i]-starts[0]);normalized_stops.push(stops[i]-starts[0])}for(var j=0;j<normalized_starts.length;j++){var token=str.substring(normalized_starts[j],normalized_stops[j]);tokens.push(token)}return tokens}function get_fingered_grace_note(note){var abc_str="{";var grace_tokens=get_grace_note_tokens(note);var finger_tokens=[];if(note.fingering){finger_tokens=get_tokens(FINGER_RE,note.fingering)}for(var token_num=0;token_num<grace_tokens.length;token_num++){if(finger_tokens[token_num]){var naked_finger=finger_tokens[token_num];naked_finger=naked_finger.replace(RL_REG,"");abc_str+="!"+naked_finger+"!"}abc_str+=grace_tokens[token_num]}abc_str+="}";return abc_str}function is_epoch_fingered(note){if(note.fingering){return true}var synchronous_notes=Staff_Notes_At_Time[note.staff][note.time];for(var i=0;i<synchronous_notes.length;i++){if(synchronous_notes[i].grace){continue}if(synchronous_notes[i].fingering){return true}}return false}function fonts_set_in_source(){if(Fonts_Set_In_Source!==undefined){return Fonts_Set_In_Source}Fonts_Set_In_Source=false;var found_one=false;var found_two=false;var lines=Org_Abc_Str.split("\n");for(var i=0;i<lines.length;i++){var line=lines[i];if(line.match(/^%%setfont-1/)){found_one=true}if(line.match(/^%%setfont-2/)){found_two=true}if(found_one&&found_two){Fonts_Set_In_Source=true;break}}return Fonts_Set_In_Source}function grace_notes_in_source(){if(Grace_Notes_In_Source!==undefined){return Grace_Notes_In_Source}Grace_Notes_In_Source=false;for(var i=0;i<Sorted_Note_Locations.length;i++){var sorted_loc=Sorted_Note_Locations[i];var note=Note_At[sorted_loc];if(note.grace){Grace_Notes_In_Source=true;break}}return Grace_Notes_In_Source}function get_fingered_abc_str(){var fingered_str="";if(!fonts_set_in_source()){fingered_str+=SETFONT_COMMANDS+"\n";if(grace_notes_in_source()){fingered_str+=GRACE_NOTE_DECORATIONS+"\n"}}var prior_loc=0;for(var i=0;i<Sorted_Note_Locations.length;i++){var sorted_loc=Sorted_Note_Locations[i];var note=Note_At[sorted_loc];var prologue="";if(note.grace){prologue=Org_Abc_Str.substring(parseInt(prior_loc),parseInt(note.start-1));prior_loc=note.end+1;fingered_str+=prologue;note.fingered_start=fingered_str.length+note.anno_start-note.start+1;if(note.fingering&&note.fingering!=="x"){var finger_tokens=get_tokens(FINGER_RE,note.fingering);note.fingered_start+=3*finger_tokens.length}fingered_str+=get_fingered_grace_note(note)}else{var start_loc=parseInt(note.start);var end_loc=parseInt(note.end);prologue=Org_Abc_Str.substring(parseInt(prior_loc),start_loc);fingered_str+=prologue;prior_loc=end_loc;if(is_epoch_fingered(note)){fingered_str+=get_note_annotation(note)}note.fingered_start=fingered_str.length;fingered_str+=note.string}Fingered_Note_At[note.fingered_start]=note}fingered_str+=Org_Abc_Str.substring(prior_loc);return fingered_str}function rerender(){Rerender_Count++;console.log("RERENDERING NUMBER "+Rerender_Count);var start_time=(new Date).getTime();var target=document.getElementById(TARGET_DIV_ID),diverr=document.getElementById(ERROR_DIV_ID);var user=new User;My_Abc=new Abc(user);var abc_str=get_fingered_abc_str();var end_time=(new Date).getTime();var elapsed=end_time-start_time;console.log("MY LAG: "+elapsed);document.getElementById(SOURCE_ID).value=abc_str;start_time=(new Date).getTime();Abc_Images="";My_Abc.tosvg("edit",'%%bgcolor white\n%%beginsvg\n<style type="text/css">\n	rect.abcr {fill:#a08000; fill-opacity:0}\n	rect.abcr:hover {fill-opacity:0.3}\n</style>\n%%endsvg\n');Current_Line_Number=0;diverr.innerHTML="";Ref=[];try{My_Abc.tosvg(Abc_Fname,document.getElementById(SOURCE_ID).value)}catch(e){alert(e.message+"\nabc2svg tosvg bug - stack:\n"+e.stack);return}try{target.innerHTML=Abc_Images}catch(e){alert(e.message+"\nabc2svg image bug - abort:\n"+e.stack);return}setTimeout(function(){var elts=document.getElementsByClassName("abcr"),i=elts.length,elt;while(--i>=0){elt=elts[i];elt.onclick=function(){process_note_click(this)};elt.ondblclick=function(){process_note_dblclick(this)}}},300);end_time=(new Date).getTime();elapsed=end_time-start_time;console.log("LIB LAG: "+elapsed);show_keypad()}function get_char(event){if(event.which==null){return String.fromCharCode(event.keyCode)}else if(event.which!=0&&event.charCode!=0){return String.fromCharCode(event.which)}else{return null}}function handle_key_code(key_code){console.log(String.fromCharCode(key_code)+" --> "+key_code);if(key_code===BACKSPACE_CODE){punt_on_input();Trailing_Characters=[];var current_characters=get_unblanked_current_characters();if(current_characters.length>0){Current_Note.fingering="";rerender()}else if(Current_Note.prior_note){Current_Note=Current_Note.prior_note}highlight_note(Current_Note)}else if(key_code==TAB_CODE||key_code==RIGHT_ARROW_CODE){flush_buffer();Trailing_Characters=[];if(Current_Note.next_note){Current_Note=Current_Note.next_note}}else if(key_code==LEFT_ARROW_CODE){flush_buffer();Trailing_Characters=[];if(Current_Note.prior_note){Current_Note=Current_Note.prior_note}}else if(key_code==ENTER_CODE){collect_manual_input()}else{return false}highlight_note(Current_Note);return true}function handle_keydown(e){var key_code=e.keyCode;var event_handled=handle_key_code(key_code);if(event_handled){e.preventDefault()}return event_handled}function handle_navigation_input(button_id){var key_code=TAB_CODE;switch(button_id){case"previous":key_code=LEFT_ARROW_CODE;break;case"next":key_code=RIGHT_ARROW_CODE;break;case"backspace":key_code=BACKSPACE_CODE;break;case"pencil":key_code=ENTER_CODE}return handle_key_code(key_code)}function toggle_hand(){if(Toggled){Toggled=false;document.body.style.backgroundColor="white"}else{Toggled=true;document.body.style.backgroundColor="black"}highlight_note(Current_Note)}function get_current_hand(note){if(Toggled){if(note.staff==0){return"<"}else{return">"}}return get_staff_hand(note.staff)}function get_staff_hand(staff){if(staff==0){return">"}return"<"}function get_pitch_fingering(leaf_node,note){var current_hand=get_current_hand(note);var hand=leaf_node.fingering.strike.hand||current_hand;var str=hand+leaf_node.fingering.strike.digit;if(leaf_node.fingering.release){hand=leaf_node.fingering.release.hand||current_hand;str+=","+hand+leaf_node.fingering.release.digit}return str}function get_abcd_for_score_fingering(score_fingering,note){var str="";var elements=[];var element_fingering;var i;if(score_fingering.first.ornaments){elements=score_fingering.first.ornaments[0];str+="(";for(i=0;i<elements.length;i++){element_fingering=elements[i];str+=get_pitch_fingering(element_fingering,note)}str+=")"}else{str+=get_pitch_fingering(score_fingering.first,note)}if(score_fingering.last&&score_fingering.last.ornaments){elements=score_fingering.last.ornaments[0];str+="(";for(i=0;i<elements.length;i++){element_fingering=score_fingering.last.ornaments[i];str+="/"+get_pitch_fingering(element_fingering,note)}str+=")"}else if(score_fingering.last){str+="/"+get_pitch_fingering(score_fingering.last,note)}return str}function finger_current_from_nodes(new_score_fingerings){Current_Note.fingering="";var current_finger_count=0;while(current_finger_count<Current_Note.size){var score_fingering=new_score_fingerings.shift();var abcd=get_abcd_for_score_fingering(score_fingering,Current_Note);Current_Note.fingering+=abcd;current_finger_count++;if(new_score_fingerings.length===0){break}}if(current_finger_count===Current_Note.size){return true}for(;current_finger_count<Current_Note.size;current_finger_count++){Current_Note.fingering+="x"}return false}function finger_notes_from_parse(parse){var new_score_fingerings=parse.upper.score_fingerings;while(new_score_fingerings.length>0){if(finger_current_from_nodes(new_score_fingerings)&&Current_Note.next_note){Current_Note=Current_Note.next_note}}if(Open_Ornament){Current_Note=Current_Note.prior_note}}function punt_on_input(){Open_Ornament=false;Input_Buffer=[];Trailing_Characters=[];rerender();highlight_note(Current_Note)}function get_unblanked_current_characters(){var current_fingerings=Current_Note.fingering.split("");var unblanked_chars=[];for(var i=0;i<current_fingerings.length;i++){var char=current_fingerings[i];if(char==="x"){unblanked_chars.push("")}else{unblanked_chars.push(char)}}return unblanked_chars}function buffer_current_fingering(){var current_characters=get_unblanked_current_characters();while(current_characters.length){var char=current_characters.pop();if(char){Input_Buffer.unshift(char)}}}function flush_buffer(){var modifying_prior_note=false;if(Trailing_Characters.length>0){Array.prototype.unshift.apply(Input_Buffer,Trailing_Characters);modifying_prior_note=true}Trailing_Characters=[];for(var i=Input_Buffer.length-1;i>=0;i--){if(/[,\/\(]/.test(Input_Buffer[i])){Trailing_Characters.unshift(Input_Buffer.pop())}else{break}}if(Input_Buffer.length===0){return}if(/[,\/]/.test(Input_Buffer[0])){modifying_prior_note=true}if(Open_Ornament){var current_characters=get_unblanked_current_characters();if(current_characters[current_characters.length-1]===")"){current_characters.pop()}else{alert("Something wonky with parentheses.");punt_on_input()}Array.prototype.unshift.apply(Input_Buffer,current_characters);Open_Ornament=false}if(modifying_prior_note){if(Current_Note.prior_note){Current_Note=Current_Note.prior_note;buffer_current_fingering()}else{Input_Buffer.pop()}}else{if(Current_Note.fingering.match(/x/)){buffer_current_fingering()}}var input=Input_Buffer.join("");var truncation_count=0;var try_count=1;while(true){try{var parsimony=Abcdf_Parser.parse(input);Open_Ornament=false;if(try_count===2){Open_Ornament=true}finger_notes_from_parse(parsimony);break}catch(e){if(try_count===1){Input_Buffer.push(")")}else if(try_count===2){Input_Buffer.pop();Input_Buffer.pop();truncation_count++}else if(try_count===3){try_count=0}if(Input_Buffer.length==0){break}input=Input_Buffer.join("");try_count++}}Input_Buffer=[];rerender();highlight_note(Current_Note)}function buffer_character_input(char){clearTimeout(Timer);var character_processed=false;if(/[\(\)\/,1-5]/.test(char)){Input_Buffer.push(char);character_processed=true}if(char==="t"||char==="T"){flush_buffer();toggle_hand();character_processed=true}Timer=setTimeout(flush_buffer,TIMEOUT_MS);console.log("Done "+Timer);return character_processed}function handle_keypress(e){var char=get_char(e).toLowerCase();return buffer_character_input(char)}function process_options(options){if(!Options){Options=options}}function get_abcd_version(){return 5}function get_abcd_hdr(){var abcd_hdr="% abcDidactyl v"+get_abcd_version();return abcd_hdr}function get_abcd_fingering_preamble(fingering_number){var preamble="% abcD fingering "+fingering_number+": ";return preamble}function get_abcd(abc_str){var body_lines=[];var header_lines=[];header_lines.push(get_abcd_hdr());var sequences=get_sequences(abc_str);var lines=abc_str.split("\n");var input_abcd_version="";var out_of_abcd_block=false;var match;for(var i=0;i<lines.length;i++){var line=lines[i];if(input_abcd_version){if(out_of_abcd_block){body_lines.push(line)}else{match=ABCD_TERMINAL_RE.exec(line);if(match){out_of_abcd_block=true}}}else{match=ABCD_HDR_RE.exec(line);if(match&&match[1]){input_abcd_version=match[1]}else{body_lines.push(line)}}}var current_sequence_number=get_current_sequence_number();var current_sequence=get_current_sequence();if(get_setting("output")==="replace"){var sequence_index=current_sequence_number-1;sequences[sequence_index]=current_sequence}else{sequences.push(current_sequence)}var fingering_line,authority_line,transcriber_line,date_line,comments;for(var i=0;i<sequences.length;i++){var sequence_number=i+1;try{Abcdf_Parser.parse(sequences[i].sequence)}catch(e){alert("Bad abcDF parse of fingering string: "+e.message+e.stack)}fingering_line=get_abcd_fingering_preamble(sequence_number)+sequences[i].sequence;header_lines.push(fingering_line);if(sequences[i].authority){authority_line="% Authority: "+sequences[i].authority;if(sequences[i].authority_year){authority_line+=" ("+sequences[i].authority_year+")"}header_lines.push(authority_line)}if(sequences[i].transcriber){transcriber_line="% Transcriber: "+sequences[i].transcriber;header_lines.push(transcriber_line)}if(sequences[i].transcription_date){date_line="% Transcription date: "+sequences[i].transcription_date;header_lines.push(date_line)}var comments=sequences[i].comments.split("\n");for(var j=0;j<comments.length;j++){if(j!==comments.length-1||comments[j]){header_lines.push("% "+comments[j])}}}header_lines.push("% abcDidactyl END");var header_str=header_lines.join("\n");var body_str=body_lines.join("\n");return header_str+"\n"+body_str}function handle_keys(){document.body.addEventListener("keydown",handle_keydown);document.body.addEventListener("keypress",handle_keypress)}function unhandle_keys(){document.body.removeEventListener("keydown",handle_keydown);document.body.removeEventListener("keypress",handle_keypress)}function insert_main_divs(){if(Ui_In_Place){return}var abcde_div=document.getElementById(ABCDE_DIV_ID);abcde_div.align="center";var source_div=document.getElementById(SOURCE_ID);if(!source_div){source_div=document.createElement("div");source_div.id=SOURCE_ID;source_div.style.display="none";abcde_div.appendChild(source_div)}source_div.class=SOURCE_CLASS_ID;var prefs_div=document.createElement(PREFS_DIV_ID);prefs_div.id=PREFS_DIV_ID;abcde_div.appendChild(prefs_div);var controls_div=document.createElement(CONTROLS_DIV_ID);controls_div.id=CONTROLS_DIV_ID;abcde_div.appendChild(controls_div);var metadata_div=document.createElement(METADATA_DIV_ID);
metadata_div.id=METADATA_DIV_ID;abcde_div.appendChild(metadata_div);var rendering_div=document.createElement(RENDERING_DIV_ID);rendering_div.id=RENDERING_DIV_ID;abcde_div.appendChild(rendering_div);var target_div=document.createElement(TARGET_DIV_ID);target_div.id=TARGET_DIV_ID;rendering_div.appendChild(target_div);var err_div=document.createElement(ERROR_DIV_ID);err_div.id=ERROR_DIV_ID;rendering_div.appendChild(err_div);for(var i=0;i<7;i++){rendering_div.appendChild(document.createElement("br"))}var keypad_div=document.createElement(KEYPAD_DIV_ID);keypad_div.id=KEYPAD_DIV_ID;abcde_div.appendChild(keypad_div)}function abcde$render(options){insert_main_divs();initialize_globals();process_options(options);insert_controls();preset_preferences();Org_Abc_Str=document.getElementById(SOURCE_ID).value;if(Org_Abc_Str){Sequences=get_sequences(Org_Abc_Str);set_default_sequence();render();Current_Note=Notes_On_Line[0][0][0];highlight_note(Current_Note);handle_keys()}show_keypad()}function render_new_sequence(){initialize_globals();Org_Abc_Str=document.getElementById(SOURCE_ID).value;render();Current_Note=Notes_On_Line[0][0][0];highlight_note(Current_Note);handle_keys()}function process_note_click(happening){console.log("Processing note click....");var classiness=happening.getAttribute("class");console.log("Click "+classiness);var tokens=classiness.split("_");var note_loc=tokens[1];if(note_loc in Fingered_Note_At){var clicked_note=Fingered_Note_At[note_loc];print_note("process_note_click",clicked_note);highlight_note(clicked_note);Current_Note=clicked_note}}function abcde$set_entered_collection(abcdf){Current_Note=Notes_On_Line[0][0][0];var seq_number=get_current_sequence_number();var seq=get_current_sequence();seq.sequence=abcdf;var autosaved=get_autosaved_sequence(seq_number);set_sequence(autosaved,seq);rerender();highlight_note(Current_Note)}function collect_manual_input(){punt_on_input();var prompt="Please enter abcD fingering string for the selected note.";var initial_fingering=Current_Note.fingering;var new_fingering=window.prompt(prompt,initial_fingering);try{if(new_fingering===null){return}var parsimony=Abcdf_Parser.parse(new_fingering);finger_notes_from_parse(parsimony);rerender();highlight_note(Current_Note)}catch(e){alert("Bad abcDF parse of fingering string: "+e.message+e.stack)}}function process_note_dblclick(happening){console.log("Processing note double-click....");process_note_click(happening);collect_manual_input()}function render(){var user=new User;var target=document.getElementById(TARGET_DIV_ID),diverr=document.getElementById(ERROR_DIV_ID);target.align="center";My_Abc=new Abc(user);Abc_Images="";My_Abc.tosvg("edit",'%%bgcolor white\n%%beginsvg\n<style type="text/css">\n	rect.abcr {fill:#a08000; fill-opacity:0}\n	rect.abcr:hover {fill-opacity:0.3}\n</style>\n%%endsvg\n');diverr.innerHTML="";Ref=[];try{if(Org_Abc_Str){My_Abc.tosvg(Abc_Fname,Org_Abc_Str)}}catch(e){alert(e.message+"\nabc2svg tosvg bug - stack:\n"+e.stack);return}try{if(Org_Abc_Str){target.innerHTML=Abc_Images;sort_notes_in_finger_order();sort_note_locations();Preprocessing_Completed=true;Current_Line_Number=0;preset_sequence();rerender()}}catch(e){alert(e.message+"\nabc2svg image bug - abort:\n"+e.stack);return}}function gotoabc(l,c){var s=document.getElementById(SOURCE_ID),idx=0;while(--l>=0){idx=s.value.indexOf("\n",idx)+1;if(idx<=0){alert("bad line number");idx=s.value.length-1;c=0;break}}c=Number(c)+idx;s.focus();s.setSelectionRange(c,c+1)}function setcolor(cl,color){var elts=document.getElementsByClassName(cl),i=elts.length,elt;while(--i>=0){elt=elts[i];elt.setAttribute("color",color)}}function colorsel(color){var i,n=Colcl.length;for(i=0;i<n;i++)setcolor(Colcl[i],color)}function highlight_note(note){var note_start=note.fingered_start;console.log("HIGHLIGHT note at "+note_start);if(Colcl.length!=0){colorsel("black");Colcl=[]}Colcl.push("e_"+note_start);if(Toggled){colorsel("blue")}else{colorsel("red")}}function abcde$get_x_value(abc_str){var lines=abc_str.split("\n");for(var i=0;i<lines.length;i++){var line=lines[i];if(/^\s*X:/.test(line)){var tokens=line.split(":");if(tokens.length!=2){return""}var val=tokens[1].trim();return val}}return""}function get_verbose_note_fingering(note,all_or_nothing){var finger_tokens=[];if(note.fingering){finger_tokens=get_tokens(FINGER_RE,note.fingering)}else if(all_or_nothing){return""}if(all_or_nothing&&finger_tokens.length!=note.size){return""}var finger_str=note.fingering||"";for(var i=finger_tokens.length;i<note.size;i++){finger_str+="x"}return finger_str}function get_note_fingering_for_output(note,all_or_nothing){if(note.grace){return get_verbose_note_fingering(note,all_or_nothing)}var synchronous_notes=Staff_Notes_At_Time[note.staff][note.time];var grace_note_count=get_grace_note_count(synchronous_notes);var big_note_count=synchronous_notes.length-grace_note_count;if(big_note_count<2){return get_verbose_note_fingering(note,all_or_nothing)}synchronous_notes.sort(order_notes);var lowest_note=synchronous_notes[0];if(synchronous_notes[0].grace){lowest_note=synchronous_notes[1]}if(note!==lowest_note){return""}var ordered_fingers=get_synchronous_fingering_array(synchronous_notes);var finger_str="";for(var i=0;i<ordered_fingers.length;i++){if(!ordered_fingers[i]){finger_str+="x"}else{finger_str+=ordered_fingers[i]}}return finger_str}function clean_fingering_line(fingering,last_hand){var clean_tokens=[];var current_hand=last_hand;var tokens=fingering.split("");for(var i=0;i<tokens.length;i++){var token=tokens[i];if(!token.match(RL_REG)){clean_tokens.push(token)}else if(token!==current_hand){clean_tokens.push(token);current_hand=token}}return clean_tokens.join("")}function get_fingerings_for_output(staff_number,line_number,last_hand){var sl_notes=Notes_On_Line[line_number][staff_number];var fingerings="";for(var i=0;i<sl_notes.length;i++){var note=sl_notes[i];var fingering=get_note_fingering_for_output(note,false);fingerings+=fingering}return fingerings}function get_new_last_hand(finger_str,old_last_hand){var match=LAST_HAND_RE.exec(finger_str);if(match&&match[1]){return match[1]}return old_last_hand}function current_collection(){var all_treble_fingers="";var all_bass_fingers="";var last_treble_hand=get_staff_hand(0);var last_bass_hand=get_staff_hand(1);for(var i=0;i<Notes_On_Line.length;i++){var treble_fingerings=get_fingerings_for_output(0,i);if(treble_fingerings){treble_fingerings=clean_fingering_line(treble_fingerings,last_treble_hand);last_treble_hand=get_new_last_hand(treble_fingerings,last_treble_hand);all_treble_fingers+=treble_fingerings;if(i<Notes_On_Line.length-1){all_treble_fingers+="&"}}if(Notes_On_Line[i][1]){var bass_fingerings=get_fingerings_for_output(1,i);if(bass_fingerings){bass_fingerings=clean_fingering_line(bass_fingerings,last_bass_hand);last_bass_hand=get_new_last_hand(bass_fingerings,last_bass_hand);all_bass_fingers+=bass_fingerings;if(i<Notes_On_Line.length-1){all_bass_fingers+="&"}}}}var all_fingers=all_treble_fingers+"@"+all_bass_fingers;return all_fingers}function print_score(){console.log("Print that score.");var print_window=window.open("","print_window");print_window.document.write(Abc_Images);print_window.document.close();print_window.focus();print_window.print();print_window.close()}function load_fingering(){var source_elem=document.getElementById(SOURCE_ID);source_elem.value=Org_Abc_Str;render_new_sequence()}function view_source(){var abc_str,abcd_str;if(Persist_Annotated){abc_str=get_fingered_abc_str();abcd_str=get_abcd(abc_str)}else{abcd_str=get_abcd(Org_Abc_Str)}window.open("data:text/vnd.abc;charset=utf-8,"+encodeURI(abcd_str),"view_window")}function abcde$get_authority(){if(get_setting("include_pii")){return get_field_value("authority")}return""}function abcde$get_comments(){return get_field_value("comments")}function abcde$get_entered_collection(){return current_collection()}function is_invalid_abcdf(abcdf_str){try{Abcdf_Parser.parse(abcdf_str)}catch(e){return"Bad abcDF parse of fingering string: "+e.message+e.stack}var missing_count=0;var required_validation=get_setting("validate");if(required_validation==="complete"){missing_count=abcdf_str.split("x").length-1}else if(required_validation==="none"){missing_count=0}else if(required_validation==="auto"){return"Validation of autofill is not yet implemented.";return 9999}if(missing_count===1){return"One note is missing a fingering annotation."}else{return missing_count+" notes are missing fingering annotations."}return""}function is_valid_abcdf(abcdf_str){var invalidity=is_invalid_abcdf(abcdf_str);if(invalidity){alert(invalidity);return false}return true}function abcde$get_validated_collection(){var dat=current_collection();if(is_valid_abcdf(dat)){return dat}return""}function abcde$get_entered_abcd(){return get_abcd()}function abcde$get_validated_abcd(){var abcdf=current_collection();if(is_valid_abcdf(abcdf)){var abcd=get_abcd();if(!/^\s*X:/g.test(abcd)){alert("File is not valid abc.");return""}else if(!/^% abcDidactyl/.test(abcd)){alert("File is not valid abcD.");return""}return abcd}return""}return{render:abcde$render,getXValue:abcde$get_x_value,getAuthority:abcde$get_authority,getComments:abcde$get_comments,getEnteredCollection:abcde$get_entered_collection,getEnteredAbcD:abcde$get_entered_abcd,getValidatedCollection:abcde$get_validated_collection,getValidatedAbcD:abcde$get_validated_abcd,setEnteredCollection:abcde$set_entered_collection}}();