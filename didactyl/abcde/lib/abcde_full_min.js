/* abcDE_full_min.js v5.0.136 */
function Abc(user){function clone(e){if(!e)return e;var t=new e.constructor;for(var n in e)t[n]=e[n];return t}function errbld(e,t,n,r){var s,i,a,o,c;if(user.errbld){switch(e){case 0:e="warn";break;case 1:e="error";break;default:e="fatal"}return void user.errbld(e,t,n,r)}if(void 0!=r&&r>=0){for(a=0,s=-1,o=0;;){if(i=parse.file.indexOf("\n",s+1),0>i){s=parse.file.length-1;break}if(i>r)break;a++,s=i}o=r-s}switch(c="",n&&(c=n,a&&(c+=":"+(a+1)+":"+(o+1)),c+=" "),e){case 0:c+="Warning: ";break;case 1:c+="Error: ";break;default:c+="Internal bug: "}t=t.replace(/&/g,"&amp;"),t=t.replace(/</g,"&lt;"),t=t.replace(/>/g,"&gt;"),user.errmsg(c+t,a,o)}function error(e,t,n){t&&t.ctx?errbld(e,n,t.ctx.fname,t.istart):errbld(e,n)}function scanBuf(){this.index=0,this["char"]=function(){return this.index>=this.buffer.length?void 0:this.buffer[this.index]},this.next_char=function(){return this.index>=this.buffer.length?void 0:this.buffer[++this.index]},this.advance=function(){this.index<this.buffer.length&&this.index++},this.get_int=function(){for(var e=0,t=this.buffer[this.index];t>="0"&&"9">=t;)e=10*e+Number(t),t=this.next_char();return e},this.get_float=function(){for(var e,t="";;){if(e=this.buffer[this.index],"0123456789.-".indexOf(e)<0)break;t+=e,this.index++}return parseFloat(t)},this.error=function(e){errbld(1,e,parse.ctx.fname,this.index+parse.bol-1)}}function syntax(e,t){errbld(e,t,parse.ctx.fname,parse.istart)}function abc2svg_init(){font_init(),init_tune()}function y_get(e,t,n,r){var s,i=staff_tb[e],a=Math.floor(n/realwidth*YSTEP),o=Math.floor((n+r)/realwidth*YSTEP);if(0>a&&(a=0),o>=YSTEP&&(o=YSTEP-1,a>o&&(a=o)),t)for(s=i.top[a++];o>=a;)s<i.top[a]&&(s=i.top[a]),a++;else for(s=i.bot[a++];o>=a;)s>i.bot[a]&&(s=i.bot[a]),a++;return s}function y_set(e,t,n,r,s){var i=staff_tb[e],a=Math.floor(n/realwidth*YSTEP),o=Math.floor((n+r)/realwidth*YSTEP);if(0>a&&(a=0),o>=YSTEP&&(o=YSTEP-1,a>o&&(a=o)),t)for(;o>=a;)i.top[a]<s&&(i.top[a]=s),a++;else for(;o>=a;)i.bot[a]>s&&(i.bot[a]=s),a++}function set_str(e,t){var n=t.match(/^@([0-9.-]+),([0-9.-]+)/);n?(e.x+=Number(n[1]),e.dy=Number(n[2]),e.str=t.replace(n[0],"")):(e.str=t,e.dy=0)}function up_p(e,t){switch(t){case SL_ABOVE:return!0;case SL_BELOW:return!1}return e.multi&&0!=e.multi?e.multi>0:voice_tb[e.v].have_ly?e.pos.voc!=SL_ABOVE:!1}function d_arp(e){var t,n,r,s=e.s,i=e.dd,a=0;for(t=0;t<=s.nhd;t++){if(s.notes[t].acc)r=5+s.notes[t].shac;else switch(r=6-s.notes[t].shhd,s.head){case"square":case"oval":r+=2.5}r>a&&(a=r)}n=3*(s.notes[s.nhd].pit-s.notes[0].pit)+4,t=i.h,t>n&&(n=t),e.flags.val=!0,e.val=n,e.x=s.x-a,e.y=3*(s.notes[0].pit-18)-3}function d_cresc(e){if(!e.flags.ldst){var t,n,r,s,i,a,o,c,l,u=e.s,f=e.start;f?(t=f.s,i=t.x+3,c=f.ix,c>0&&(l=a_de[c-1])):(t=first_note,i=t.x-t.wl-4),e.st=u.st,e.flags.lden=!1,e.flags.val=!0,s=up_p(u,u.pos.dyn),s&&(e.flags.up=!0),l&&l.s==t&&(e.flags.up&&!l.flags.up||!e.flags.up&&l.flags.up)&&(r=l.dd,r.func>=6&&(o=l.x+l.val+4,o>i&&(i=o))),e.defl.noen?(a=e.x-i,20>a&&(i=e.x-20-3,a=20)):(o=u.x,e.next&&e.next.s==t&&(e.flags.up&&!e.next.flags.up||!e.flags.up&&e.next.flags.up)&&(r=e.next.dd,r.func>=6&&(o-=5)),a=o-i-4,20>a&&(i-=.5*(20-a),e.start||(i-=.5*(20-a)),a=20)),e.val=a,e.x=i,n=e.dd,e.y=y_get(e.st,s,i,a),s||(e.y-=n.h)}}function d_near(e){var t,n,r=e.s,s=e.dd;return s.str?(e.x=r.x,e.y=r.y,void set_str(e,s.str)):(n=r.multi?r.multi>0:r.stem<0,t=n?Math.floor(r.ymx):Math.floor(r.ymn-s.h),t>-6&&24>t&&(n&&(t+=3),t=6*Math.floor((t+6)/6)-6),n?r.ymx=t+s.h:r.ymn=t,e.y=t,e.x=r.x+r.notes[r.stem>=0?0:r.nhd].shhd,void("d"==s.name[0]&&r.nflags>=-1&&(n?r.stem>0&&(e.x+=3.5):r.stem<0&&(e.x-=3.5))))}function d_pf(e){var t,n,r,s,i,a=e.s,o=e.dd;e.val=o.wl+o.wr,s=up_p(a,a.pos.vol),s&&(e.flags.up=!0),r=a.x-o.wl,e.ix>0&&(i=a_de[e.ix-1],i.s==a&&(e.flags.up&&!i.flags.up||!e.flags.up&&i.flags.up)&&(t=i.dd,t.func>=6&&(n=i.x+i.val+4,n>r&&(r=n)))),e.x=r,e.y=y_get(a.st,s,r,e.val),s||(e.y-=o.h),o.str?set_str(e,o.str):"sfz"!=o.name&&(e.str=o.name)}function d_slide(e){var t,n,r=e.s,s=r.notes[0].pit,i=5;for(t=0;t<=r.nhd;t++){if(r.notes[t].acc)n=4+r.notes[t].shac;else switch(n=5-r.notes[t].shhd,r.head){case"square":case"oval":n+=2.5}r.notes[t].pit<=s+3&&n>i&&(i=n)}e.x=r.x-i,e.y=3*(s-18)}function d_trill(e){if(!e.flags.ldst){var t,n,r,s,i,a,o,c=e.s;if(e.start?(t=e.start.s,i=t.x,t.type==NOTE&&t.a_dd&&t.a_dd.length>1&&(i+=10)):(t=first_note,i=t.x-t.wl-4),e.st=r=c.st,s=c.multi>=0,e.defl.noen?(o=e.x-i,20>o&&(i=e.x-20-3,o=20)):(o=c.x-i-6,c.type==NOTE&&(o-=6),20>o&&(i-=.5*(20-o),e.start||(i-=.5*(20-o)),o=20)),n=e.dd,a=y_get(r,s,i,o),s){var l=staff_tb[t.st].topbar+2;l>a&&(a=l)}else{a-=n.h;var u=staff_tb[t.st].botbar-2;a>u&&(a=u)}e.flags.lden=void 0,e.flags.val=!0,e.val=o,e.x=i,e.y=a,s&&(a+=n.h),y_set(r,s,i,o,a),s?t.ymx=c.ymx=a:t.ymn=c.ymn=a}}function d_upstaff(e){var t,n,r,s=e.s,i=e.dd,a=s.x,o=i.wl+i.wr,c=staff_tb[s.st].topbar+2,l=staff_tb[s.st].botbar-2;if(s.nhd&&(a+=s.notes[s.stem>=0?0:s.nhd].shhd),n=-1,4!=i.func)switch(s.pos.orn){case SL_ABOVE:n=1;break;case SL_BELOW:n=0}switch(i.glyph){case"accent":case"cpu":!n||0>n&&(s.multi<0||!s.multi&&s.stem>0)?(t=y_get(s.st,!1,s.x-i.wl,o),t>l&&(t=l),t-=i.h,y_set(s.st,!1,s.x,0,t),r=!0,s.ymn=t):(t=y_get(s.st,!0,s.x,0),c>t&&(t=c),y_set(s.st,!0,s.x-i.wl,o,t+i.h),s.ymx=t+i.h);break;case"brth":case"lphr":case"mphr":case"sphr":for(t=c+1,s=s.ts_next;s&&!s.shrink;s=s.ts_next);a+=s?.4*(s.x-a):.4*(realwidth-a);break;default:0==i.name.indexOf("invert")&&(r=!0),"invertedfermata"!=i.name&&(n>0||0>n&&s.multi>=0)?(t=y_get(s.st,!0,s.x-i.wl,o),c>t&&(t=c),y_set(s.st,!0,s.x-i.wl,o,t+i.h),s.ymx=t+i.h):(t=y_get(s.st,!1,s.x-i.wl,o),t>l&&(t=l),t-=i.h,y_set(s.st,!1,s.x-i.wl,o,t),"fermata"==i.name&&(r=!0),s.ymn=t)}r&&(t+=i.h,e.flags.inv=!0),e.x=a,e.y=t,i.str&&set_str(e,i.str)}function deco_add(e){user_deco_tb||(user_deco_tb=[]),user_deco_tb.push(e)}function deco_build(e){var t,n,r,s;if(a=e.match(/(.+)\s+(\d+)\s+(.+?)\s+([0-9.]+)\s+([0-9.]+)\s+([0-9.]+)/),!a)return void error(1,null,"Invalid decoration '"+e+"'");var i=Number(a[2]),o=parseFloat(a[4]),c=parseFloat(a[5]),l=parseFloat(a[6]);return isNaN(i)?void error(1,null,"%%deco: bad C function value '"+a[2]+"'"):(0>i||i>=func_tb.length)&&(32>i||i>41)?void error(1,null,"%%deco: bad C function index '"+i+"'"):0>o||0>c||0>l?void error(1,null,"%%deco: cannot have a negative value '"+e+"'"):o>50||c>80||l>80?void error(1,null,"%%deco: abnormal h/wl/wr value "+e+"'"):(t=dd_tb[a[1]],t||(t={name:a[1]},dd_tb[a[1]]=t),t.func=i,t.glyph=a[3],t.h=o,t.wl=c,t.wr=l,s=e.replace(a[0],"").trim(),s&&('"'==s[0]&&(s=s.slice(1,-1)),t.str=s),r=t.name[t.name.length-1],("("==r||")"==r&&t.name.indexOf("(")<0)&&("("==r?t.ldst=!0:t.lden=!0,name2=t.name.slice(0,-1)+("("==r?")":"("),n=dd_tb[name2],n&&("("==r?t.ld_en_dd=n:n.ld_en_dd=t)),t)}function deco_cnv(e,t,n){var r,s,i,a,o,c=e.length;for(r=0;c>r;r++)if(a=e[r],i=dd_tb[a],i||(i=deco_def(a)))switch(i.func){default:if("head-"==i.name.slice(0,5)){if(!t.notes){error(1,t,"!"+i.name+"! must be on a note or rest");break}for(s=0;s<=t.nhd;s++)o=t.notes[s],o.a_dcn||(o.a_dcn=[]),o.a_dcn.push(i.name)}else t.a_dd||(t.a_dd=[]),t.a_dd.push(i);break;case 32:t.invisible=!0;break;case 33:if(t.type!=BAR){error(1,t,"!beamon! must be on a bar");break}t.beam_on=!0;break;case 34:if(t.type!=NOTE||!n||n.type!=NOTE){error(1,t,"!"+i.name+"! must be on the last of a couple of notes");break}for(t.trem2=!0,t.beam_end=!0,n.trem2=!0,n.beam_st=!0,t.ntrem=n.ntrem=Number(i.name[4]),t.nflags--,n.nflags--,t.nflags>0?(t.nflags+=t.ntrem,n.nflags+=t.ntrem):(t.nflags<=-2&&(t.stemless=!0,n.stemless=!0),t.nflags=t.ntrem,n.nflags=t.ntrem),s=0;s<=t.nhd;s++)t.notes[s].dur*=2;for(s=0;s<=n.nhd;s++)n.notes[s].dur*=2;break;case 35:if(t.type!=NOTE){error(1,t,"!xstem! must be on a note");break}t.xstem=!0,t.nflags=0;break;case 36:if(t.type!=NOTE){error(1,t,"!"+i.name+"! must be on a note");break}"1"==i.name[6]?t.beam_br1=!0:t.beam_br2=!0;break;case 37:t.rbstop=1;break;case 38:if(t.type!=NOTE){error(1,t,"!"+i.name+"! must be on a note");break}t.trem1=!0,t.ntrem=i.name.length,t.nflags>0?t.nflags+=t.ntrem:t.nflags=t.ntrem;break;case 39:if(t.type!=NOTE){error(1,t,"!"+i.name+"! must be on a note");break}t.feathered_beam="a"==i.name[5]?1:-1;break;case 40:t.stemless=!0;break;case 41:t.rbstop=2}else cfmt.decoerr&&error(1,t,"Unknown decoration '"+a+"'")}function deco_def(e){var t,n,r=e+" ";if(user_deco_tb)for(n=user_deco_tb.length,t=0;n>t;t++)if(0==user_deco_tb[t].indexOf(r))return deco_build(user_deco_tb[t]);for(n=std_deco_tb.length,t=0;n>t;t++)if(0==std_deco_tb[t].indexOf(r))return deco_build(std_deco_tb[t])}function deco_update(e,t){var n,r,s=a_de.length;for(n=0;s>n;n++)r=a_de[n],r.s==e&&(r.x+=t)}function deco_width(e){var t,n,r=0,s=e.a_dd,i=s.length;for(n=n=0;i>n;n++)switch(t=s[n],t.func){case 1:7>r&&(r=7);break;case 2:14>r&&(r=14)}return 0!=r&&e.prev&&e.prev.type==BAR&&(r-=3),r}function draw_all_deco(){if(0!=a_de.length){var e,t,n,r,s,i,a,o,c,l,u=[];if(!cfmt.dynalign)for(r=nstaff,i=staff_tb[r].y;--r>=0;)a=staff_tb[r].y,u[r]=.5*(i+24+a),i=a;for(;;){if(e=a_de.shift(),!e)break;t=e.dd,t.ldst&&t.ld_en_dd||(n=t.glyph,l=n.indexOf("/"),l>0&&(n=e.s.stem>=0?n.slice(0,l):n.slice(l+1)),r=e.st,i=e.y+staff_tb[r].y,t.func>=6&&!cfmt.dynalign&&(e.flags.up&&r>0||!e.flags.up&&r<nstaff)&&(o=e.flags.up?u[--r]:u[r++],o-=.5*t.h,(e.flags.up&&o>i||!e.flags.up&&i>o)&&(a=y_get(r,!e.flags.up,e.x,e.val)+staff_tb[r].y,e.flags.up&&(a-=t.h),(e.flags.up&&a>o||!e.flags.up&&o>a)&&(i=o,y_set(r,e.flags.up,e.x,e.val,(e.flags.up?i+t.h:i)-staff_tb[r].y)))),set_scale(e.s),s=e.x,c=user[n],c&&"function"==typeof c?c(s,i,e):psdeco(n,s,i,e)||(e.flags.grace?(output.push('<g transform="translate('),out_sxsy(s,",",i),e.flags.inv?output.push(') scale(0.7, -0.7)">\n'):output.push(') scale(0.7)">\n'),stv_g.trans=!0,s=i=0):e.flags.inv&&(output.push('<g transform="translate('),out_sxsy(s,",",i),output.push(') scale(1, -1)">\n'),stv_g.trans=!0,s=i=0),e.flags.val?2!=t.func||stv_g.st<0?out_deco_val(s,i,n,e.val/stv_g.scale,e.defl):out_deco_val(s,i,n,e.val,e.defl):e.str?out_deco_str(s,i+e.dy+.2*t.h,n,e.str):xygl(s,i,n),stv_g.trans&&(stv_g.trans=!1,output.push("</g>\n"))))}}}function draw_deco_head(e,t,n,r){var s,i,a=dd_tb[e];if(!a&&(a=deco_def(e),!a))return error(1,null,"Unknown decoration '"+e+"'"),!1;if(s=a.glyph,pshdeco(s,t,n,a))return 0==a.name.indexOf("head-");if(a.str)i={x:t},set_str(i,a.str),out_deco_str(i.x,n+i.dy,s,i.str);else switch(a.func){default:xygl(t,n,s);break;case 2:case 5:case 7:error(1,null,"Cannot have !"+a.name+"! on a head");break;case 3:case 4:xygl(t,n,s)}return 0==a.name.indexOf("head-")}function create_deco(e){var t,n,r,s,i=e.a_dd.length;for(n=0;i>n;n++){switch(t=e.a_dd[n],t.func){default:r=0;break;case 3:case 4:case 5:r=e.pos.orn;break;case 6:r=e.pos.vol;break;case 7:r=e.pos.dyn}if(r!=SL_HIDDEN)if(0!=t.name.indexOf("head-"))s={s:e,dd:t,st:e.st,ix:a_de.length,flags:{},defl:{},dy:0},a_de.push(s),e.grace&&(s.flags.grace=!0),t.ldst?s.flags.ldst=!0:t.lden&&(s.flags.lden=!0,s.defl.nost=!0),t.func>=3||(e.type==NOTE?func_tb[t.func](s):error(1,e,"Cannot have !"+t.name+"! on a rest or a bar"));else switch(e.type){case NOTE:case REST:break;default:error(1,e,"Cannot have !"+t.name+"! on a bar")}}}function draw_deco_near(){var e,t,n;for(e=tsfirst;e;e=e.ts_next){switch(e.type){case BAR:case MREST:break;case NOTE:case REST:case SPACE:n||(n=e);break;case GRACE:for(t=e.extra;t;t=t.next)t.a_dd&&create_deco(t);continue;default:continue}e.a_dd&&create_deco(e)}first_note=n}function draw_deco_note(){var e,t,n,r,s,i,a,o;for(n_de=a_de.length,e=0;e<n_de;e++)if(de=a_de[e],de.flags.ldst){for(r=de.dd,s=r.ld_en_dd,s||(s={name:r.name.slice(0,-1)+")",func:r.func,glyph:r.glyph,h:r.h},r.ld_en_dd=s),o=de.s.v,t=e+1;t<n_de&&(n=a_de[t],n.dd!=s||n.s.v!=o);t++);if(t==n_de)for(a=de.s.st,t=e+1;t<n_de&&(n=a_de[t],n.dd!=s||n.s.st!=a);t++);t==n_de&&(n={s:de.s,st:de.st,dd:s,ix:a_de.length-1,x:realwidth-6,y:de.s.y,flags:{lden:!0},defl:{noen:!0}},a_de.push(n)),n.start=de,delete n.defl.nost}for(e=0;e<n_de;e++)de=a_de[e],r=de.dd,i=r.func,3>i||i>=6||func_tb[i](de)}function draw_deco_staff(){function e(e){var t,n,r,i,a,o;for(r=staff_tb[e.st].topbar+6+20,t=e.sym;t;t=t.next)if(t.type==BAR&&t.rbstart&&!t.norepbra){if(!t.next)break;for(o||(o=t),n=t;t.next&&(t=t.next,!t.rbstop););i=y_get(e.st,!0,n.x,t.x-n.x),i>r&&(r=i),n.text&&(a=strw(n.text),i=y_get(e.st,!0,n.x+4,a),i+=gene.curfont.size+2,i>r&&(r=i)),t.rbstart&&(t=t.prev)}if(t=o)for(set_dscale(e.st),set_font("repeat"),i=r*staff_tb[e.st].staffscale;t;t=t.next)if(t.rbstart&&!t.norepbra){for(n=t;t.next&&(t=t.next,!t.rbstop););if(n==t)break;s=n.x,a=t.type!=BAR?t.rbstop?0:t.x-realwidth+4:t.bar_type.length>1&&"[]"!=t.bar_type||"]"==t.bar_type?n.st>0&&!(cur_sy.staves[n.st-1].flags&STOP_BAR)?t.wl:":"==t.bar_type[t.bar_type.length-1]?12:":"!=t.bar_type[0]||"]"==t.bar_type?0:8:8,a=(t.x-s-a)/staff_tb[e.st].staffscale,t.next||t.rbstop||e.bar_start||(e.bar_start=clone(t),e.bar_start.bar_type="[",e.bar_start.text=void 0,e.bar_start.rbstart=1,delete e.bar_start.a_gch),n.text&&xy_str(s+4,i-.9*gene.curfont.size,n.text),xypath(s,i),2==n.rbstart&&output.push("m0 20v-20"),output.push("h"),output.push(a.toFixed(2)),2==t.rbstop&&output.push("v20"),output.push('"/>\n'),y_set(n.st,!0,s,a,r+2),t.rbstart&&(t=t.prev)}}var t,n,r,s,i,a,o,c,l,u,f,d,p,h,m=new Array(nstaff);for(o=0;o<=nstaff;o++)m[o]={ymin:0,ymax:24};for(t=tsfirst;t;t=t.ts_next)if(t.a_gch){for(n||(n=t),c=t.a_gch.length,h=0;c>h&&(d=t.a_gch[h],!("g"==d.type&&(p=d,d.y<0)));h++);p&&(a=p.w,p.y>=0?(i=y_get(t.st,!0,t.x,a),i>m[t.st].ymax&&(m[t.st].ymax=i)):(i=y_get(t.st,!1,t.x,a),i<m[t.st].ymin&&(m[t.st].ymin=i)))}if(n){for(o=0;o<=nstaff;o++){var v=staff_tb[o].botbar;m[o].ymin-=3,m[o].ymin>v-10&&(m[o].ymin=v-10);var _=staff_tb[o].topbar;m[o].ymax+=3,m[o].ymax<_+10&&(m[o].ymax=_+10)}for(set_sscale(-1),t=n;t;t=t.ts_next)if(t.a_gch){switch(t.type){case NOTE:case REST:case SPACE:case MREST:break;case BAR:if(void 0==t.text)break;default:continue}draw_gchord(t,m[t.st].ymin,m[t.st].ymax)}}for(c=voice_tb.length,l=0;c>l;l++)r=voice_tb[l],!r.second&&r.sym&&e(r);for(o=0;o<=nstaff;o++)m[o]={ymin:0,ymax:0};for(c=a_de.length,o=0;c>o;o++)u=a_de[o],f=u.dd,f.func<6||(func_tb[f.func](u),f.ldst||cfmt.dynalign&&(u.flags.up?u.y>m[u.st].ymax&&(m[u.st].ymax=u.y):u.y<m[u.st].ymin&&(m[u.st].ymin=u.y)));for(o=0;c>o;o++)u=a_de[o],f=u.dd,f.ldst||f.func<6||(cfmt.dynalign?(i=u.flags.up?m[u.st].ymax:m[u.st].ymin,u.y=i):i=u.y,u.flags.up&&(i+=f.h),y_set(u.st,u.flags.up,u.x,u.val,i))}function draw_measnb(){var e,t,n,r,s,i,a,o,c,l=cur_sy;for(t=0;t<=nstaff&&l.staves[t].empty;t++);if(!(t>nstaff)){if(set_dscale(t),1!=staff_tb[t].staffscale&&(c=get_font("measure").size,param_set_font("measurefont","* "+(c/staff_tb[t].staffscale).toString())),set_font("measure"),e=tsfirst,n=gene.nbar,n>1)if(0==cfmt.measurenb)o=!0,s=y_get(t,!0,0,20),s<staff_tb[t].topbar+14&&(s=staff_tb[t].topbar+14),xy_str(0,s,n.toString()),y_set(t,!0,0,20,s+gene.curfont.size+2);else if(n%cfmt.measurenb==0){for(;;e=e.ts_next){switch(e.type){case METER:case CLEF:case KEY:case FORMAT:case STBRK:continue}break}for(;e.st!=t;)e=e.ts_next;e.prev.type!=CLEF&&(e=e.prev),r=e.x-e.wl,o=!0,i=cwid("0")*gene.curfont.swfac,n>=10&&(i*=n>=100?3:2),cfmt.measurebox&&(i+=4),s=y_get(t,!0,r,i),s<staff_tb[t].topbar+6&&(s=staff_tb[t].topbar+6),s+=2,xy_str(r,s,n.toString()),cfmt.measurebox&&(a=gene.curfont.size+3,i+=3,xybox(r-1,s-3+a,i,a)),s+=gene.curfont.size,y_set(t,!0,r,i,s),e.ymx=s}for(;e;e=e.ts_next){if(e.new_sy){for(l=l.next,t=0;t<nstaff&&l.staves[t].empty;t++);set_sscale(t)}e.type==BAR&&e.bar_num&&(n=e.bar_num,0!=cfmt.measurenb&&n%cfmt.measurenb==0&&e.next&&(o||(o=!0),i=cwid("0")*gene.curfont.swfac,n>=10&&(i*=n>=100?3:2),cfmt.measurebox&&(i+=4),r=e.x-.4*i,s=y_get(t,!0,r,i),s<staff_tb[t].topbar+6&&(s=staff_tb[t].topbar+6),e.next.type==NOTE&&(e.next.stem>0?s<e.next.ys-gene.curfont.size&&(s=e.next.ys-gene.curfont.size):s<e.next.y&&(s=e.next.y)),s+=2,xy_str(r,s,n.toString()),cfmt.measurebox&&(a=gene.curfont.size+3,i+=3,xybox(r-1,s-3+a,i,a)),s+=gene.curfont.size,y_set(t,!0,r,i,s),e.ymx=s))}gene.nbar=n,c&&param_set_font("measurefont","* "+c.toString())}}function draw_notempo(e,t,n,r,s){var i,a,o,c=identify_note(e,r),l=c[0],u=c[1],f=c[2];switch(stv_g.started&&(output.push("</g>\n"),stv_g.started=!1),output.push('<g transform="translate('),out_sxsy(t+8,",",n+3),output.push(") scale("+s+')">\n'),l){case"oval":a="HD";break;case"empty":a="Hd";break;default:a="hd"}if(xygl(-posx,posy,a),i=4,u){switch(o=8,f>0&&(o+=4),l){case"square":case"oval":o+=2;break;case"empty":o+=1}for(i=o*u,o-=posx;--u>=0;)out_dot(o,posy),o+=3.5}return r<BASE_LEN&&(0>=f?out_stem(-posx,posy,21):(out_stem(-posx,posy,21,!1,f),6>i&&(i=6))),output.push("\n</g>\n"),(i+15)*s}function tempo_width(e){var t,n,r=0;if(set_font("tempo"),e.tempo_str1&&(r=strw(e.tempo_str1)),e.tempo_value){for(t=1,n=e.tempo_notes.length;n>t;)r+=10,t++;r+=6+cwid(" ")*gene.curfont.swfac*6+10+10}return e.tempo_str2&&(r+=strw(e.tempo_str2)),r}function write_tempo(e,t,n,r){var s,i,a,o;if(set_font("tempo"),e.tempo_str1&&(xy_str(t,n,e.tempo_str1),t+=strw(e.tempo_str1)+6),e.tempo_value){for(r*=.7*gene.curfont.size/15,i=e.tempo_notes.length,s=0;i>s;s++)t+=draw_notempo(e,t,n,e.tempo_notes[s],r);t+=5,xy_str(t,n,"="),t+=strw("= ")+5,e.tempo_value.indexOf("/")<0?(xy_str(t,n,e.tempo_value.toString()),a=cwid("0")*gene.curfont.swfac,t+=a+5,e.tempo_value>=10&&(t+=a,e.tempo_value>=100&&(t+=a))):(o=e.tempo_value.split("/"),2==o.length&&Number(o[1])>0&&draw_notempo(e,t,n,o[0]*BASE_LEN/o[1],r))}e.tempo_str2&&xy_str(t,n,e.tempo_str2)}function draw_partempo(e,t){var n,r,s,i,a,o,c,l=0,u=0,f=staff_tb[e].topbar+12,d=0,p=1,h=0;for(n=tsfirst;n;n=n.ts_next)if(r=n.extra){for(;r&&r.type!=TEMPO;r=r.next);r&&(i||(i=!0),o=tempo_width(r),c=y_get(e,!0,n.x-5,o)+2,c>f&&(f=c),h>=n.x-5&&!(d&p>>1)&&(d|=p),p<<=1,h=n.x-5+o)}if(i)for(set_font("tempo"),u=gene.curfont.size+2+2,c=2-u,a=c-u,0!=d&&(u*=2),f+u>t&&(l=f+u-t),n=tsfirst;n;n=n.ts_next)if(n.seqst){for(r=n.extra;r&&(r.type!=TEMPO||r.deleted);r=r.next);r&&((user.anno_start||user.anno_stop)&&(r.x=n.x,r.wl=5,r.wr=40,r.ymn=1&d?a:c,r.ymx=r.ymn+14,user.anno_start&&anno_start(r)),write_tempo(r,n.x-5,1&d?a:c,1),user.anno_stop&&anno_stop(r),d>>=1)}for(f=staff_tb[e].topbar+14,n=tsfirst;n;n=n.ts_next)if(r=n.extra){for(;r&&r.type!=PART;r=r.next);r&&(s||(s=!0,set_font("parts"),a=gene.curfont.size+2+2),o=strw(r.text),c=y_get(e,!0,n.x-10,o+15)+5,c>f&&(f=c))}if(s)for(f+a+u>t&&(l=f+a+u-t),n=tsfirst;n;n=n.ts_next)if(r=n.extra){for(;r&&r.type!=PART;r=r.next);r&&((user.anno_start||user.anno_stop)&&(r.x=n.x-10,o=strw(r.text),r.wl=0,r.wr=o,r.ymn=2-u-a,r.ymx=r.ymn+a,user.anno_start&&anno_start(r)),xy_str(n.x-10,2-u-a,r.text),cfmt.partsbox&&(o=strw(r.text)+4,xybox(n.x-10-2,2-u-4,o,a)),user.anno_stop&&anno_stop(r))}return l}function b_pos(e,t,n,r){function s(e){var t=6*Math.round((e+12)/6)-12;return t-e}var i,a,o,c,l=e?3:BEAM_SHIFT,u=e?1.7:BEAM_DEPTH;if(t>0){if(a=r-(n-1)*l-u,a>26)return 0;i=r}else{if(i=r+(n-1)*l+u,-2>i)return 0;a=r}return o=s(i-BEAM_OFFSET),c=s(a+BEAM_OFFSET),o*o>c*c?c:o}function sym_dup(e){var t,n,r=clone(e);for(r.invisible=!0,delete r.text,delete r.a_gch,delete r.a_ly,delete r.a_dd,r.notes=clone(e.notes),t=0;t<=r.nhd;t++)n=r.notes[t]=clone(e.notes[t]),delete n.a_dcn;return r}function calculate_beam(e,t){var n,r,s,i,a,o,c,l,u,f,d,p,h,m,v,_,g,y,b,x,w,k,E,T;for(t.beam_st||(n=sym_dup(t),n.prev=t.prev,n.prev?n.prev.next=n:voice_tb[n.v].sym=n,t.prev=n,n.next=t,t.ts_prev.ts_next=n,n.ts_prev=t.ts_prev,t.ts_prev=n,n.ts_next=t,n.x-=12,n.x>t.prev.x+12&&(n.x=t.prev.x+12),n.beam_st=!0,delete n.beam_end,n.tmp=!0,n.slur_start=0,delete n.slur_end,t=n),s=i=0,c=l=!1,a=t.st,o=t.v,E=t.grace?GSTEM_XOFF:3.5,r=t;r.type!=NOTE||(r.nflags>i&&(i=r.nflags),s++,r.st!=a&&(c=!0),r.stem!=t.stem&&(l=!0),!r.beam_end);r=r.next)if(!r.next){for(;r.type!=NOTE;r=r.prev);n=sym_dup(r),n.next=r.next,n.next&&(n.next.prev=n),r.next=n,n.prev=r,n.ts_next=r.ts_next,n.ts_next&&(n.ts_next.ts_prev=n),r.ts_next=n,n.ts_prev=r,delete n.beam_st,n.beam_end=!0,n.tmp=!0,delete n.slur_start,delete n.slur_end,n.x+=12,n.x<realwidth-12&&(n.x=realwidth-12),r=n,s++;break}if(e.s2=r,0==staff_tb[a].y){if(c)return!1}else if(!c)return e.s1=t,e.a=(t.ys-r.ys)/(t.xs-r.xs),e.b=t.ys-t.xs*e.a+staff_tb[a].y,e.nflags=i,!0;for(g=y=b=x=w=0,n=t;n.type!=NOTE||(1==(T=voice_tb[n.v].scale)&&(T=staff_tb[n.st].staffscale),f=n.stem>=0?E+n.notes[0].shhd:-E+n.notes[n.nhd].shhd,f*=T,f+=n.x,n.xs=f,d=n.ys+staff_tb[n.st].y,g+=f,y+=d,b+=f*f,x+=f*d,w+=d*d,n!=r);n=n.next);if(h=(x*s-g*y)/(b*s-g*g),m=(y-h*g)/s,t.grace?h>BEAM_SLOPE?h=BEAM_SLOPE:-0.5>h&&(h=-0.5):(s>=3&&(u=w-h*x-m*y,u>0&&u/(s-2)>.5&&(h*=BEAM_FLATFAC)),h=h>=0?BEAM_SLOPE*h/(BEAM_SLOPE+h):BEAM_SLOPE*h/(BEAM_SLOPE-h)),k=h*(r.xs-t.xs)/(20*(s-1)),.0036>k*k&&(h=0),m=(y-h*g)/s,cfmt.flatbeams&&(m=t.grace?35+staff_tb[a].y:-11+staff_tb[a].y,h=0),_=0,n=t,l)p=t.grace?3:BEAM_SHIFT,p*=i-1,p+=BEAM_DEPTH,p*=.5,p*=t.stem!=r.stem&&t.nflags<r.nflags?r.stem:t.stem,m+=p;else if(t.grace)for(;p=h*n.xs+m-staff_tb[n.st].y,v=12,n.stem>0?v-=p-3*(n.notes[n.nhd].pit-18):v+=p-3*(n.notes[0].pit-18),v+=3*(n.nflags-1),v>_&&(_=v),n!=r;n=n.next);else{for(var C=BEAM_DEPTH+BEAM_SHIFT*(i-1);n.ts_prev&&n.ts_prev.type==NOTE&&n.ts_prev.time==n.time&&n.ts_prev.x>t.xs;)n=n.ts_prev;for(;n&&n.time<=r.time;n=n.ts_next)if(!(n.type!=NOTE||n.invisible||n.st!=a&&n.v!=o)){if(f=n.v==o?n.xs:n.x,p=h*f+m-staff_tb[n.st].y,n.v==o)v=0==n.nhd?min_tb[0][n.nflags]:min_tb[1][n.nflags],n.stem>0?(n.notes[n.nhd].pit>26&&(v-=2,n.notes[n.nhd].pit>28&&(v-=2)),v-=p-3*(n.notes[n.nhd].pit-18)):(n.notes[0].pit<18&&(v-=2,n.notes[0].pit<16&&(v-=2)),v-=3*(n.notes[0].pit-18)-p),v+=BEAM_DEPTH+BEAM_SHIFT*(n.nflags-1);else{if(t.stem>0)if(n.stem>0){if(n.ymn>p+4||n.ymx<p-C-2)continue;v=n.v>o?n.ymx-p:n.ymn+8-p}else v=n.ymx-p;else if(n.stem<0){if(n.ymx<p-4||n.ymn>p-C-2)continue;v=n.v<o?p-n.ymn:p-n.ymx+8}else v=p-n.ymn;v+=2+C}v>_&&(_=v)}}if(_>0&&(m+=t.stem*_),!c&&!l)for(n=t.next;;n=n.next){var S;switch(n.type){case REST:if(S=n.ts_next,!S||S.st!=a||S.type!=NOTE&&S.type!=REST)break;case BAR:if(n.invisible)break;case CLEF:d=h*n.x+m,t.stem>0?(d=n.ymx-d+BEAM_DEPTH+BEAM_SHIFT*(i-1)+2,d>0&&(m+=d)):(d=n.ymn-d-BEAM_DEPTH-BEAM_SHIFT*(i-1)-2,0>d&&(m+=d));break;case GRACE:for(S=n.extra;S;S=S.next)S.type==NOTE&&(d=h*S.x+m,t.stem>0?(d=S.ymx-d+BEAM_DEPTH+BEAM_SHIFT*(i-1)+2,d>0&&(m+=d)):(d=S.ymn-d-BEAM_DEPTH-BEAM_SHIFT*(i-1)-2,0>d&&(m+=d)))}if(n==r)break}for(0==h&&(m+=b_pos(t.grace,t.stem,i,m-staff_tb[a].y)),n=t;;n=n.next){var O;switch(n.type){case NOTE:n.ys=h*n.xs+m-staff_tb[n.st].y,n.stem>0?(n.ymx=n.ys+2.5,n.ts_prev&&n.ts_prev.stem>0&&n.ts_prev.st==n.st&&n.ts_prev.ymn<n.ymx&&n.ts_prev.x==n.x&&0==n.notes[0].shhd&&(n.ts_prev.x-=5,n.ts_prev.xs-=5)):n.ymn=n.ys-2.5;break;case REST:if(d=h*n.x+m-staff_tb[n.st].y,O=BEAM_DEPTH+BEAM_SHIFT*(i-1)+("full"!=n.head?4:9),t.stem>0){if(d-=O,0==t.multi&&d>12&&(d=12),n.y<=d)break}else if(d+=O,0==t.multi&&12>d&&(d=12),n.y>=d)break;"full"!=n.head&&(d=6*Math.floor((d+3+12)/6)-12),n.y=d}if(n==r)break}return 0==staff_tb[a].y?!1:(e.s1=t,e.a=h,e.b=m,e.nflags=i,!0)}function draw_beams(e){function t(e,t,n,r,s,i){var a,o,c=s.s1,l=c.nflags;c.ntrem&&(l-=c.ntrem),c.trem2&&i>l&&(c.dur>=BASE_LEN/2?(e=c.x+6,t=s.s2.x-6):c.dur<BASE_LEN/4&&(e+=5,t-=6)),a=s.a*e+s.b-n,t-=e,t/=stv_g.scale,o=s.a*t*stv_g.scale,xypath(e,a,!0),output.push("l"+t.toFixed(2)+" "+(-o).toFixed(2)+"v"+r.toFixed(2)+"l"+(-t).toFixed(2)+" "+o.toFixed(2)+'"/>\n')}var n,r,s,i,a,o,c,l,u,f,d,p,h=e.s1,m=e.s2;for(h.grace?(a=3,o=3.2,i=.29,c=1.6):(a=BEAM_SHIFT,o=BEAM_STUB,i=.34,c=BEAM_DEPTH),s=h.stem,h.stem!=m.stem&&h.nflags<m.nflags&&(s=m.stem),0>s&&(c=-c),t(h.xs-i,m.xs+i,0,c,e,1),l=0,n=h;n.type==NOTE&&n.stem!=s&&(n.ys=e.a*n.xs+e.b-staff_tb[n.st].y+a*(n.nflags-1)*n.stem-c),n!=m;n=n.next);for(h.feathered_beam&&(l=a/(m.xs-h.xs),h.feathered_beam>0?(l=-l,a=l*h.xs):a=l*m.xs,l*=s),i=0,r=2;r<=e.nflags;r++)for(i+=a,0!=l&&(e.a+=l),n=h;;n=n.next)if(n.type!=NOTE||n.nflags<r){if(n==m)break}else if(n.trem1&&r>n.nflags-n.ntrem){if(p=n.dur>=BASE_LEN/2?n.x:n.xs,t(p-5,p+5,(i+2.5)*s,c,e,r),n==m)break}else{for(f=n;;){if(n==m)break;if(u=n.next,u.type==NOTE||u.type==REST)if(u.trem1){if(u.nflags-u.ntrem<r)break}else if(u.nflags<r)break;if(u.beam_br1||u.beam_br2&&r>2)break;n=u}for(d=n;d.type!=NOTE;)d=d.prev;if(p=f.xs,f==d)if(f==h)p+=o;else if(f==m)p-=o;else if(f.beam_br1||f.beam_br2&&r>2)p+=o;else{for(u=f.next;u.type!=NOTE;)u=u.next;if(u.beam_br1||u.beam_br2&&r>2)p-=o;else{for(f=f.prev;f.type!=NOTE;)f=f.prev;f.nflags<u.nflags||f.nflags==u.nflags&&f.dots<u.dots?p+=o:p-=o}}if(t(p,d.xs,i*s,c,e,r),n==m)break}h.tmp?unlksym(h):m.tmp&&unlksym(m)}function draw_lstaff(e){function t(e,t,n){for(var r,s,i,a;cur_sy.staves[t].empty;){if(cur_sy.staves[t].flags&n)return;t++}for(r=s=t;;){if(cur_sy.staves[r].empty||(s=r),cur_sy.staves[r].flags&n)break;r++}i=staff_tb[t].y+staff_tb[t].topbar*staff_tb[t].staffscale,a=staff_tb[s].y+staff_tb[s].botbar*staff_tb[s].staffscale,n&(CLOSE_BRACE|CLOSE_BRACE2)?out_brace(e,a,i-a):out_bracket(e,i,i-a)}if(!cfmt.alignbars){var n,r,s,i,a=cur_sy.nstaff,o=0;for(n=0;(cur_sy.staves[n].flags&(OPEN_BRACE|OPEN_BRACKET)&&o++,cur_sy.staves[n].empty)&&(cur_sy.staves[n].flags&(CLOSE_BRACE|CLOSE_BRACKET)&&o--,n!=a);n++);for(r=a;r>n&&cur_sy.staves[r].empty;r--);if(n!=r||0!=o)for(s=staff_tb[r].y+staff_tb[r].botbar*staff_tb[r].staffscale,i=staff_tb[n].y+staff_tb[n].topbar*staff_tb[n].staffscale-s,xypath(e,s),output.push("v"+(-i).toFixed(2)+'"/>\n'),n=0;a>=n;n++)cur_sy.staves[n].flags&OPEN_BRACE&&t(e,n,CLOSE_BRACE),cur_sy.staves[n].flags&OPEN_BRACKET&&t(e,n,CLOSE_BRACKET),cur_sy.staves[n].flags&OPEN_BRACE2&&t(e-6,n,CLOSE_BRACE2),cur_sy.staves[n].flags&OPEN_BRACKET2&&t(e-6,n,CLOSE_BRACKET2)}}function draw_meter(e,t){if(t.a_meter){var n,r,s=t.st,i=staff_tb[s].y;for(e-=t.wl,r=0;r<t.a_meter.length;r++){var a,o=t.a_meter[r];if(n="C|"==o.top?13:13*o.top.length,o.bot)o.bot.length>o.top.length&&(n=13*o.bot.length),output.push('<g style="font:bold 16px serif"\n	transform="translate('),out_sxsy(e+.5*n,",",i),output.push(') scale(1.2,1)">\n	<text y="-12" text-anchor="middle">'+o.top+'</text>\n	<text text-anchor="middle">'+o.bot+"</text>\n</g>\n");else switch(o.top[0]){case"C":a="|"!=o.top[1]?"csig":"ctsig",e-=5,i+=12;break;case"c":a="."!=o.top[1]?"imsig":"iMsig";break;case"o":a="."!=o.top[1]?"pmsig":"pMsig";break;default:output.push('<g style="font:bold 18px serif"\n	transform="translate('),out_sxsy(e+.5*n,",",i),output.push(') scale(1.2,1)">\n	<text y="-6" text-anchor="middle">'+o.top+"</text>\n</g>\n")}a&&xygl(e+.5*n,i,a),e+=n}}}function draw_acc(e,t,n,r,s){if(r)if(r==s)n=-1==n?-2:2;else if(2*r!=s)return void xygl(e,t,"acc"+n+"_"+r+"_"+s);xygl(e,t,"acc"+n)}function draw_hl(e,t,n,r,s){var i=staff_tb[r],a=i.y,o=i.stafflines,c=2*(o.length-1)*3;if(!(c-i.botline<4)){for(t=6*Math.ceil(t/6);t<i.botline;t+=6)xygl(e,a+t,s);for(n-=n%6;n>c;n-=6)xygl(e,a+n,s)}}function draw_keysig(e,t,n){if(!n.k_none){var r,s,i,a=n.k_old_sf,o=e.st,c=staff_tb[o].y,l=n.k_y_clef;for(1&l&&(l+=7),l/=2;0>l;)l+=7;if(l%=7,n.k_a_acc){var u,f=n.k_a_acc[0].acc,d=100;for(r=0;r<n.k_a_acc.length;r++)u=n.k_a_acc[r],s=3*(n.k_y_clef+u.pit-18),0!=r&&(s>d+18||d-18>s)?t-=5.5:u.acc!=f&&(t+=3),f=u.acc,draw_hl(t,s,s,o,"hl"),d=s,draw_acc(t,c+s,u.acc,u.micro_n,u.micro_d),t+=5.5}else{if((cfmt.cancelkey||0==n.k_sf)&&(0==n.k_sf||a*n.k_sf<0)){for(s=sharp_cl[l],i=s>9?sharp1:sharp2,r=0;a>r;r++)xygl(t,c+s,"acc3"),s+=i[r],t+=5.5;for(s=flat_cl[l],i=18>s?flat1:flat2,r=0;r>a;r--)xygl(t,c+s,"acc3"),s+=i[-r],t+=5.5;0!=n.k_sf&&(t+=3)}if(n.k_sf>0){for(s=sharp_cl[l],i=s>9?sharp1:sharp2,r=0;r<n.k_sf;r++)xygl(t,c+s,"acc1"),s+=i[r],t+=5.5;if(cfmt.cancelkey&&a>r)for(t+=2;a>r;r++)xygl(t,c+s,"acc3"),s+=i[r],t+=5.5}if(n.k_sf<0){for(s=flat_cl[l],i=18>s?flat1:flat2,r=0;r>n.k_sf;r--)xygl(t,c+s,"acc-1"),s+=i[-r],t+=5.5;if(cfmt.cancelkey&&n.k_sf>a)for(t+=2;r>a;r--)xygl(t,c+s,"acc3"),s+=i[-r],t+=5.5}}}}function bar_cnv(e){switch(e){case"[":case"[]":return"";case":":return"|";case"|:":case"|::":case"|:::":return"["+e;case":|":case"::|":case":::|":return e+"]";case"::":return cfmt.dblrepbar}return e}function draw_bar(e,t,n){var r,s,i=e.st,a=e.x;if(e.bar_mrep)if(s=staff_tb[i].y,set_scale(e),1==e.bar_mrep){for(var o=e.prev;o.type!=REST;o=o.prev);xygl(o.x,s,"mrep")}else xygl(a,s,"mrep2"),e.v==cur_sy.top_voice&&(set_font("annotation"),xy_str(a,s+staff_tb[i].topbar+4,e.bar_mrep.toString(),"c"));0==i||!e.ts_prev||e.ts_prev.type==BAR&&e.ts_prev.st==i-1||(n=staff_tb[i].topbar*staff_tb[i].staffscale);var c=e.bar_dotted||":"==e.bar_type,l=bar_cnv(e.bar_type);if(l)for(r=l.length;--r>=0;){switch(l[r]){case"|":set_sscale(-1),c?out_dotbar(a,t,n):out_bar(a,t,n);break;default:a-=3,set_sscale(-1),out_thbar(a,t,n);break;case":":a-=2,set_sscale(i),xygl(a+1,staff_tb[i].y,"rdots")}a-=3}}function draw_rest(e){var t,n,r,s,i,a,o,c=staff_tb[e.st];if(!c.empty){if(e.dur==voice_tb[e.v].meter.wmeasure){for(t=e.ts_next;t&&t.time!=e.time+e.dur;)t=t.ts_next;for(i=t?t.x:realwidth,t=e;!t.seqst;)t=t.ts_prev;t=t.ts_prev,i=(i+t.x)/2,e.a_dd&&deco_update(e,i-e.x),e.x=i}else i=e.x,e.notes[0].shhd&&(i+=e.notes[0].shhd*stv_g.scale);if(!e.invisible){if(o=c.y,e.repeat_n)return void(e.repeat_n<0?xygl(i,o,"srep"):(xygl(i,o,"mrep"),e.repeat_n>2&&e.v==cur_sy.top_voice&&(set_font("annotation"),xy_str(i,o+24+4,e.repeat_n.toString(),"c"))));if(a=e.y,e.notes[0].a_dcn)for(s=0;s<note.a_dcn.length;s++)draw_deco_head(e.notes[0].a_dcn[s],i,a+o,e.stem);else{if(n=5-e.nflags,7==n&&12==a&&c.stafflines.length<=2&&(a-=6),xygl(i,a+o,rest_tb[n]),n>=6)switch(r=a/6,n){case 6:"|"!=c.stafflines[r]&&xygl(i,a+o,"hl");break;case 7:"|"!=c.stafflines[r+1]&&xygl(i,a+6+o,"hl");break;default:"|"!=c.stafflines[r+1]&&xygl(i,a+6+o,"hl"),9==n&&(a-=6,r--),"|"!=c.stafflines[r]&&xygl(i,a+o,"hl")}for(i+=8,a+=o-3,n=0;n<e.dots;n++)out_dot(i,a),i+=3.5}}}}function draw_gracenotes(e){var t,n,r,s,i,a,o,c,l,u,f,d,p,h,m,v,_={};for(h=e.extra;h&&(h.type!=NOTE||(user.anno_start&&anno_start(e),h.beam_st&&!h.beam_end&&calculate_beam(_,h)&&draw_beams(_),draw_note(h,!_.s2),h==_.s2&&(_.s2=void 0),h.sappo&&(h.next?(s=.5*(h.next.x-h.x)+4,i=.5*(h.ys+h.next.ys)-h.y,h.stem>0?i-=1:i+=1):(s=9,i=h.stem>0?5:-5),v=h.notes[h.stem<0?0:h.nhd],out_acciac(x_head(h,v),y_head(h,v),s,i,h.stem>0)),user.anno_stop&&anno_stop(e),h.next));h=h.next);if(!voice_tb[e.v].key.k_bagpipe&&cfmt.graceslurs&&!e.slur_start&&e.next&&e.next.type==NOTE){if(m=h,m.stem>=0){for(t=127,h=e.extra;h;h=h.next)h.type==NOTE&&h.y<t&&(t=h.y,m=h);n=m.x,r=m.y-5,e.extra!=m&&(n-=4,r+=1),e=e.next,c=e.x-1,e.stem<0&&(c-=4),l=3*(e.notes[0].pit-18)-5,d=.4*(c-n),d>3&&(d=3),p=d,u=.2,f=.8,r>l+7?(n=m.x-1,r+=.5,l+=6.5,c=e.x-5.5,d=.8*(r-l),p=.2*(r-l),u=0):l>r+4&&(l=r+4,n=m.x+2,r=m.y-4)}else{for(t=-127,h=e.extra;h;h=h.next)h.type==NOTE&&h.y>t&&(t=h.y,m=h);n=m.x,r=m.y+5,e.extra!=m&&(n-=4,r-=1),e=e.next,c=e.x-1,e.stem>=0&&(c-=2),l=3*(e.notes[e.nhd].pit-18)+5,d=.4*(n-c),-3>d&&(d=-3),p=d,u=.2,f=.8,l-7>r?(n=m.x-1,r-=.5,l-=6.5,c=e.x-5.5,d=.8*(r-l),p=.2*(r-l),u=0):r-4>l&&(l=r-4,n=m.x+2,r=m.y+4)}s=u*c+(1-u)*n-n,i=u*l+(1-u)*r-d-r,a=f*c+(1-f)*n-n,o=f*l+(1-f)*r-p-r,xypath(n,r+staff_tb[e.st].y),output.push("c"+s.toFixed(2)+" "+(-i).toFixed(2)+" "+a.toFixed(2)+" "+(-o).toFixed(2)+" "+(c-n).toFixed(2)+" "+(-l+r).toFixed(2)+'"/>\n')}}function setdoty(e,t){var n,r,s;for(n=0;n<=e.nhd;n++)s=3*(e.notes[n].pit-18),s%6==0&&(e.dot_low?s-=3:s+=3),t[n]=s;for(n=0;n<e.nhd;n++)if(!(t[n+1]>t[n])){for(r=n;r>0&&!(t[r]>t[r-1]+6);)r--;if(3*(e.notes[r].pit-18)-t[r]<t[n+1]-3*(e.notes[n+1].pit-18))for(;n>=r;)t[r++]-=6;else t[n+1]=t[n]+6}}function x_head(e,t){return e.x+t.shhd}function y_head(e,t){return staff_tb[e.st].y+3*(t.pit-18)}function draw_basic_note(e,t,n,r){var s,i,a,o,c,l,u,f,d=!1,p=t.notes[n];if(staffb=staff_tb[t.st].y,a=3*(p.pit-18),shhd=p.shhd*stv_g.scale,x_note=e+shhd,y_note=a+staffb,l=0,p.a_dcn)for(i=0;i<p.a_dcn.length;i++)l|=draw_deco_head(p.a_dcn[i],e+shhd,a+staffb,t.stem);if(!(t.invisible||void 0!=t.nohdi1&&n>=t.nohdi1&&n<t.nohdi2)){var h=identify_note(t,p.dur),m=h[0],v=h[1];h[2];if(a%6==0&&shhd!=(t.stem>0?t.notes[0].shhd:t.notes[t.nhd].shhd)&&(c=0,a>=30?(c=a,c%6&&(c-=3)):-6>=a&&(c=a,c%6&&(c+=3)),c&&xygl(x_note,c+staffb,"hl")),l);else if(p.map&&p.map[0])s=-t.nflags,0>s&&(s=0),o=p.map[0][s],o||(o=p.map[0][p.map[0].length-1]),s=o.indexOf("/"),s>=0&&(o=t.stem>=0?o.slice(0,s):o.slice(s+1));else if(t.grace)o="ghd",
x_note-=4.5*stv_g.scale;else if(t.type==CUSTOS)o="custos";else switch(m){case"oval":if(p.dur<2*BASE_LEN){o="HD";break}if("square"!=t.head){o="HDD";break}case"square":o=p.dur<4*BASE_LEN?"breve":"longa",tsnext||!t.next||t.next.type!=BAR||t.next.next||(v=0);break;case"empty":o="Hd";break;default:o="hd"}if(p.map&&p.map[2]&&(d=set_color(p.map[2])),o&&xygl(x_note,y_note,o),v)for(u=e+(7.7+t.xmx)*stv_g.scale,void 0==r[n]&&(r[n]=3*(t.notes[n].pit-18),0==(1&t.notes[n].pit)&&(r[n]+=3)),f=r[n]+staffb;--v>=0;)out_dot(u,f),u+=3.5;p.acc&&(e-=p.shac*stv_g.scale,t.grace?(output.push('<g transform="translate('),out_sxsy(e,",",a+staffb),output.push(') scale(.7)">\n'),stv_g.trans=!0,draw_acc(0,0,p.acc,p.micro_n,p.micro_d),stv_g.trans=!1,output.push("</g>\n")):draw_acc(e,a+staffb,p.acc,p.micro_n,p.micro_d)),0!=d&&set_color(d)}}function draw_note(e,t){var n,r,s,i,a,o,c,l,s,u,f=new Array(e.nhd+1);if(e.dots&&setdoty(e,f),u=e.notes[e.stem<0?e.nhd:0],l=x_head(e,u),i=staff_tb[e.st].y,!e.invisible){if(e.grace)o="ghl";else switch(e.head){default:o="hl";break;case"oval":o="hl1";break;case"square":o="hl2"}draw_hl(l,3*(e.notes[0].pit-18),3*(e.notes[e.nhd].pit-18),e.st,o)}if(s=y_head(e,u),e.invisible||e.stemless?e.xstem&&(n=e.ts_prev,a=(n.stem>0?n.y:n.ys)-e.y,a+=staff_tb[n.st].y-i,a/=voice_tb[e.v].scale,out_stem(l,s,a)):(a=e.ys-e.y,c=e.nflags,e.ntrem&&(c-=e.ntrem),!t||0>=c?(e.nflags>0&&(e.stem>=0?a-=1:a+=1),out_stem(l,s,a,e.grace)):out_stem(l,s,a,e.grace,c,cfmt.straightflags)),!e.invisible&&t&&e.trem1){var d=e.ntrem?e.ntrem:0,p=l;a=3*(e.notes[e.stem>0?e.nhd:0].pit-18),"full"==e.head||"empty"==e.head?(p+=(e.grace?GSTEM_XOFF:3.5)*e.stem,e.stem>0?a+=6+5.4*d:a-=11.4):e.stem>0?a+=5+5.4*d:a-=10.4,a/=voice_tb[e.v].scale,out_trem(p,i+a,d)}for(l=e.x,r=0;r<=e.nhd;r++)draw_basic_note(l,e,r,f)}function next_scut(e){var t=e;for(e=e.next;e;e=e.next){if(e.type==BAR&&(":"==e.bar_type[0]||"|]"==e.bar_type||"[|"==e.bar_type||e.text&&"1"!=e.text[0]))return e;t=e}return t}function prev_scut(e){for(;e.prev;)if(e=e.prev,e.type==BAR&&(":"==e.bar_type[0]||"|]"==e.bar_type||"[|"==e.bar_type||e.text&&"1"!=e.text[0]))return e;for(e=voice_tb[e.v].sym;e.type!=CLEF;)e=e.ts_prev;return e.next.type==KEY&&(e=e.next),e.next.type==METER?e.next:e}function slur_direction(e,t){var n,r,s;for(n=e;;n=n.next){if(n.type==NOTE){if(!n.stemless){if(n.stem<0)return 1;r=!0}n.notes[0].pit<22&&(s=!0)}if(n==t)break}return r||s?-1:1}function slur_out(e,t,n,r,s,i,a){var o,c,l,u=.3,f=.45;c=r-t,0>c&&(c=-c),o=n-e,o>40&&.7>c/o&&(u=.3+.002*(o-40),u>.7&&(u=.7));var d=.5*(e+n),p=.5*(t+r),h=d+u*(e-d),m=p+u*(t-p)+i;h=e+f*(h-e),m=t+f*(m-t);var v=d+u*(n-d),_=p+u*(r-p)+i;v=n+f*(v-n),_=r+f*(_-r),o=.03*(n-e),c=2*s,l=.2+.001*(n-e),l>.6&&(l=.6),l*=s;var g=stv_g.v?stv_g.scale:1;a?output.push('<path class="stroke" stroke-dasharray="5,5" d="M'):output.push('<path class="fill" d="M'),out_sxsy(e," ",t),output.push("c"+((h-e)/stv_g.scale).toFixed(2)+" "+((t-m)/g).toFixed(2)+" "+((v-e)/stv_g.scale).toFixed(2)+" "+((t-_)/g).toFixed(2)+" "+((n-e)/stv_g.scale).toFixed(2)+" "+((t-r)/g).toFixed(2)),a||output.push("\n	v"+(-l).toFixed(2)+"c"+((v-o-n)/stv_g.scale).toFixed(2)+" "+((r+l-_-c)/g).toFixed(2)+" "+((h+o-n)/stv_g.scale).toFixed(2)+" "+((r+l-m-c)/g).toFixed(2)+" "+((e-n)/stv_g.scale).toFixed(2)+" "+((r+l-t)/g).toFixed(2)),output.push('"/>\n')}function slur_multi(e,t){for(;;){if(e.multi)return e.multi;if(e==t)break;e=e.next}return 0}function draw_slur(e,t,n,r,s){for(var i,a,o,c,l,u,f,d,p,h,m,v,_,g,y,b=e;b.v!=t.v;)b=b.ts_next;switch(7&s){case SL_ABOVE:y=1;break;case SL_BELOW:y=-1;break;default:y=slur_multi(b,t),y||(y=slur_direction(b,t))}var x=1,w=b.st,k=!1;if(b!=t)for(i=b.next;;){if((i.type==NOTE||i.type==REST)&&(x++,i.st!=w&&(k=!0,i.st<w&&(w=i.st))),i==t)break;i=i.next}if(k&&error(2,b,"*** multi-staves slurs not treated yet"),o=e.x,e.notes&&e.notes[0].shhd&&(o+=e.notes[0].shhd),e!=t)l=t.x,t.notes&&(l+=t.notes[0].shhd);else{for(i=t.ts_next;i&&!i.new_sy;i=i.ts_next);l=i?i.x:realwidth}if(n>=0?c=3*(b.notes[n].pit-18)+5*y:(c=y>0?b.ymx+2:b.ymn-2,b.type==NOTE&&(y>0?b.stem>0?(o+=5,b.beam_end&&b.nflags>=-1&&!b.in_tuplet?b.nflags>0?(o+=2,c=b.ys-3):c=b.ys-6:c=b.ys+3):c=b.y+8:b.stem<0?(o-=1,b.beam_end&&b.nflags>=-1&&(!b.in_tuplet||b.ys<c+3)?b.nflags>0?(o+=2,c=b.ys+3):c=b.ys+6:c=b.ys-3):c=b.y-8)),r>=0?u=3*(t.notes[r].pit-18)+5*y:(u=y>0?t.ymx+2:t.ymn-2,t.type==NOTE&&(y>0?t.stem>0?(l+=1,u=t.beam_st&&t.nflags>=-1&&!t.in_tuplet?t.ys-6:t.ys+3):u=t.y+8:t.stem<0?(l-=5,u=t.beam_st&&t.nflags>=-1&&!t.in_tuplet?t.ys+6:t.ys-3):u=t.y-8)),b.type!=NOTE&&(c=u+1.2*y,o=b.x+.5*b.wr,o>l-12&&(o=l-12)),t.type!=NOTE&&(u=b.type==NOTE?c+1.2*y:c,b!=t&&(l=t.x-.3*t.wl)),x>=3&&(b.next.type!=BAR&&b.next.x<o+48&&(y>0?(h=b.next.ymx-2,h>c&&(c=h)):(h=b.next.ymn+2,c>h&&(c=h))),t.prev&&t.prev.type!=BAR&&t.prev.x>l-48&&(y>0?(h=t.prev.ymx-2,h>u&&(u=h)):(h=t.prev.ymn+2,u>h&&(u=h)))),p=(u-c)/(l-o),(p>SLUR_SLOPE||-1>p)&&(p=p>SLUR_SLOPE?SLUR_SLOPE:-1,p*y>0?c=u-p*(l-o):u=c+p*(l-o)),h=u-c,h>8?h=8:-8>h&&(h=-8),m=h,0>m&&(m=-m),_=.5*m,g=.3*h,h*y>0?(l-=_,u-=g):(o+=_,c+=g),b.grace&&(o=b.x-.8),t.grace&&(l=t.x+1.5*GSTEM_XOFF),v=0,p=(u-c)/(l-o),b!=t&&b.v==t.v){for(d=c-p*o,i=b.next;i!=t;i=i.next)if(i.st==w)switch(i.type){case NOTE:case REST:y>0?(h=3*(i.notes[i.nhd].pit-18)+6,h<i.ymx&&(h=i.ymx),h-=p*i.x+d,h>v&&(v=h)):(h=3*(i.notes[0].pit-18)-6,h>i.ymn&&(h=i.ymn),h-=p*i.x+d,v>h&&(v=h));break;case GRACE:for(a=i.extra;a;a=a.next)a.type==NOTE&&(y>0?(h=3*(a.notes[a.nhd].pit-18)+6,h<a.ymx&&(h=a.ymx),h-=p*a.x+d,h>v&&(v=h)):(h=3*(a.notes[0].pit-18)-6,h>a.ymn&&(h=a.ymn),h-=p*a.x+d,v>h&&(v=h)))}c+=.45*v,u+=.45*v,v*=.65}if(f=x>3?(.08*(l-o)+12)*y:(.03*(l-o)+8)*y,y>0?(3*v>f&&(f=3*v),f>40&&(f=40)):(f>3*v&&(f=3*v),-40>f&&(f=-40)),h=u-c,0>h&&(h=-h),y>0?.8*h>f&&(f=.8*h):f>-.8*h&&(f=-.8*h),f*=cfmt.slurheight,slur_out(o,c,l,u,y,f,s&SL_DOTTED),_=l-o,p=(u-c)/_,d=c-p*o+.4*f,b.v==t.v)for(i=b;i!=t;i=i.next)i.st==w&&(h=p*i.x+d,i.ymx<h?i.ymx=h:i.ymn>h&&(i.ymn=h),i.next==t?(_=l,t.sl1&&(_-=5)):_=i.next.x,i!=b&&(o=i.x),_-=o,y_set(w,y>0,o,_,h));return(y>0?SL_ABOVE:SL_BELOW)|s&SL_DOTTED}function draw_slurs(e,t){for(var n,r,s,i,a,o,c,l,u=e;;){if(!u||u==t){if(!s||!(u=s.next)||u==t)break;s=null}if(u.type!=GRACE)if(u.type!=NOTE&&u.type!=REST&&u.type!=SPACE||!u.slur_start&&!u.sl1)u=u.next;else{r=null,n=u.next;for(var f=!1;;)if(n)if(n.type!=GRACE){if(n.type==BAR&&(":"==n.bar_type[0]||"|]"==n.bar_type||"[|"==n.bar_type||n.text&&"1"!=n.text[0])){r=n;break}if(n.type==NOTE||n.type==REST||n.type==SPACE){if(n.slur_end||n.sl2){r=n;break}if(n.slur_start||n.sl1){if(i){for(r=n;r.next;r=r.next);r.next=i.next,i.next&&(i.next.prev=r),r=null}draw_slurs(n,t),i&&i.next&&(delete i.next.prev.next,i.next.prev=i)}if(n==t)break;n=n.next}else n=n.next}else i=n,n=n.extra;else{if(i){n=i.next,i=null;continue}if(!s||f)break;n=s.next,f=!0}if(n){if(!r){if(u=n,u==t)break;continue}}else r=next_scut(u);if(s){for(n=u;n.next;n=n.next);n.next=s.next,s.next&&(s.next.prev=n),s.slur_start=SL_AUTO}if(i&&(i.prev.next=i.extra,i.extra.prev=i.prev,i.slur_start=SL_AUTO),u.slur_start)c=15&u.slur_start,u.slur_start>>=4,a=-1;else{for(a=0;a<=u.nhd&&!u.notes[a].sl1;a++);c=15&u.notes[a].sl1,u.notes[a].sl1>>=4,u.sl1--}if(o=-1,l=0,r.type!=NOTE&&r.type!=REST&&r.type!=SPACE||!r.slur_end&&!r.sl2)r.type==BAR&&(":"==r.bar_type[0]||"|]"==r.bar_type||"[|"==r.bar_type||r.text&&"1"!=r.text[0])||(l=1);else if(r.slur_end)r.slur_end--;else{for(o=0;o<=r.nhd&&!r.notes[o].sl2;o++);r.notes[o].sl2--,r.sl2--}if(c=draw_slur(u,r,a,o,c),l&&(voice_tb[r.v].slur_start<<=4,voice_tb[r.v].slur_start+=c),s&&s.next&&(delete s.next.prev.next,s.next.prev=s),i&&(i.prev.next=i,delete i.extra.prev),!u.slur_start&&!u.sl1){if(u==t)break;u=u.next}}else s=u,u=u.extra}}function draw_tuplet(e,t){var n,r,s,i,a,o,c,l,u,f,d,p,h,m,v,_,g,y,b,v,x,w=t;if(1==e.tuplet_f[0])return w;for(i=e.next;i;i=i.next)i.type==TUPLET&&(s=draw_tuplet(i,t),s.time>w.time&&(w=s));for(a=e.tuplet_r,o=t.st,r=t;r;r=r.next){if(r!=t&&r.in_tuplet)for(i=r.extra;i;i=i.next)i.type==TUPLET&&(s=draw_tuplet(i,r),s.time>w.time&&(w=s));if(r.type==NOTE||r.type==REST){if((r.slur_start||r.slur_end||r.sl1||r.sl2)&&(l=!0),r.st<o&&(o=r.st),n||(n=r),--a<=0)break}else if(r.type==GRACE)for(i=r.extra;i;i=i.next)i.type==NOTE&&(i.slur_start||i.sl1)&&(l=!0)}if(!r)return w;if(r.time>w.time&&(w=r),n==r)c=!0;else if(1==e.tuplet_f[1])c=!0,draw_slur(n,r,-1,-1,n.stem>0?SL_ABOVE:SL_BELOW);else if(2==e.tuplet_f[0]||n.type!=NOTE||r.type!=NOTE)c=!1;else{for(c=!0,s=n;;s=s.next){if(s.type!=NOTE&&s.type!=REST){if(s.type==GRACE||s.type==SPACE)continue;c=!1;break}if(s==r)break;if(s.beam_end){c=!1;break}}if(c&&!n.beam_st&&!n.beam_br1&&!n.beam_br2)for(s=n.prev;s;s=s.prev)if(s.type==NOTE||s.type==REST){s.nflags>=n.nflags&&(c=!1);break}if(c&&!r.beam_end)for(s=r.next;s;s=s.next)if(s.type==NOTE||s.type==REST){!s.beam_br1&&!s.beam_br2&&s.nflags>=r.nflags&&(c=!1);break}}if(c){if(1==e.tuplet_f[2])return w;for(h=.5*(r.x+n.x),v=n==r?0:(r.ys-n.ys)/(r.x-n.x),x=n.ys-v*n.x,g=v*h+x,n.stem>0?(m=y_get(o,1,h-3,6),m>g&&(x+=m-g),x+=2):(m=y_get(o,0,h-3,6),g>m&&(x+=m-g),x-=10),s=n;!(s.x>=h);s=s.next);return n.stem*r.stem>0&&(n.stem>0?h+=1.5:h-=1.5),m=v*h+x,0==e.tuplet_f[2]?out_bnum(h,m,e.tuplet_p):out_bnum(h,m,e.tuplet_p+":"+e.tuplet_q),n.stem>0?(m+=10,s.ymx<m&&(s.ymx=m),y_set(o,!0,h-3,6,m)):(s.ymn>m&&(s.ymn=m),y_set(o,!1,h-3,6,m)),t.in_tuplet=!1,w}if(l){if(draw_slurs(n,r),n.slur_start||n.sl1)return w;for(s=n.next;s!=r;s=s.next)if(s.slur_start||s.slur_end||s.sl1||s.sl2)return w;if(r.slur_end||r.sl2)return w}if(0!=e.tuplet_f[1]&&error(2,e,"'what' value of %%tuplets not yet coded"),n.multi>=0){if(u=n.x-4,d=24,n.st==o){if(s=n,s.type!=NOTE)for(s=s.next;s!=r&&s.type!=NOTE;s=s.next);m=y_get(o,1,s.x,0),m>d&&(d=m),n.stem>0&&(u+=3)}if(p=24,r.st==o){if(s=r,s.type!=NOTE)for(s=s.prev;s!=n&&s.type!=NOTE;s=s.prev);m=y_get(o,1,s.x,0),m>p&&(p=m)}for(r.dur>r.prev.dur?f=r.next?r.next.x-r.next.wl-5:realwidth-6:(f=r.x+4,a=r.stem>=0?0:r.nhd,r.notes[a].shhd>0&&(f+=r.notes[a].shhd),r.st==o&&r.stem>0&&(f+=3.5)),h=.5*(u+f),m=.5*(d+p),v=(p-d)/(f-u),_=3*(r.notes[r.nhd].pit-n.notes[n.nhd].pit)/(f-u),_>0?0>v?v=0:v>_&&(v=_):v>0?v=0:_>v&&(v=_),.1*.1>v*v&&(v=0),b=0,s=n;;s=s.next)if(s.dur&&s.st==o){if(g=m+(s.x-h)*v,y=y_get(o,1,s.x,0),y-g>b&&(b=y-g),s==r)break}else if(s==r)break;for(m+=b+2,d=m+v*(u-h),p=m+v*(f-h),out_tubr(u,d+4,f-u,p-d,!0),m+=8,s=n;;s=s.next)if(s.st==o){if(g=m+(s.x-h)*v,s.ymx<g&&(s.ymx=g),s==r)break;y_set(o,!0,s.x,s.next.x-s.x,g)}else if(s==r)break}else{if(u=n.x-7,r.dur>r.prev.dur?f=r.next?r.next.x-r.next.wl-8:realwidth-6:(f=r.x+2,r.notes[r.nhd].shhd>0&&(f+=r.notes[r.nhd].shhd)),n.st==o){if(s=n,s.type!=NOTE)for(s=s.next;s!=r&&s.type!=NOTE;s=s.next);d=y_get(o,0,s.x,0)}else d=0;if(r.st==o){if(s=r,s.type!=NOTE)for(s=s.prev;s!=n&&s.type!=NOTE;s=s.prev);p=y_get(o,0,s.x,0)}else p=0;for(h=.5*(u+f),m=.5*(d+p),v=(p-d)/(f-u),_=3*(r.notes[0].pit-n.notes[0].pit)/(f-u),_>0?0>v?v=0:v>_&&(v=_):v>0?v=0:_>v&&(v=_),.1*.1>v*v&&(v=0),b=0,s=n;;s=s.next)if(s.dur&&s.st==o){if(g=m+(s.x-h)*v,y=y_get(o,0,s.x,0),b>y-g&&(b=y-g),s==r)break}else if(s==r)break;for(m+=b-10,d=m+v*(u-h),p=m+v*(f-h),out_tubr(u,d+4,f-u,p-d),m-=2,s=n;;s=s.next){if(s.st==o){if(s==r)break;g=m+(s.x-h)*v,s.ymn>g&&(s.ymn=g),y_set(o,!1,s.x,s.next.x-s.x,g)}if(s==r)break}}return 1==e.tuplet_f[2]?(t.in_tuplet=!1,w):(g=.5*(d+p),0==e.tuplet_f[2]?out_bnum(h,g,e.tuplet_p,!0):out_bnum(h,g,e.tuplet_p+":"+e.tuplet_q,!0),n.multi>=0?(g+=9,y_set(o,!0,h-3,6,g)):y_set(o,!1,h-3,6,g),t.in_tuplet=!1,w)}function draw_note_ties(e,t,n,r,s){var i,a,o,c,l,u,f,d,p,h,m,v,_,g;for(i=0;i<n.length;i++){switch(o=n[i],u=e.notes[o].pit,c=r[i],f=t.notes[c].pit,a=(7&e.notes[o].ti1)==SL_ABOVE?1:-1,m=e.x,g=e.notes[o].shhd,a>0?o<e.nhd&&u+1==e.notes[o+1].pit&&e.notes[o+1].shhd>g&&(g=e.notes[o+1].shhd):o>0&&u==e.notes[o-1].pit+1&&e.notes[o-1].shhd>g&&(g=e.notes[o-1].shhd),m+=.6*g,v=t.x,g=t.notes[c].shhd,a>0?c<t.nhd&&f+1==t.notes[c+1].pit&&t.notes[c+1].shhd<g&&(g=t.notes[c+1].shhd):c>0&&f==t.notes[c-1].pit+1&&t.notes[c-1].shhd<g&&(g=t.notes[c-1].shhd),v+=.6*g,p=e.st,s){case 0:l=u==f||1&u?u:f;break;case 1:case 3:m=e.x,m>v-20&&(m=v-20),l=f,p=t.st,3==s&&(a=-a);break;default:if(e!=t)v-=t.wl;else{for(h=t.ts_next;h&&!h.new_sy;h=h.ts_next);v=h?h.x:realwidth}m+16>v&&(v=m+16),l=u}v-m>20&&(m+=3.5,v-=3.5),d=3*(l-18),1!=s&&3!=s?(1&l&&(d+=2*a),a>0&&!(1&l)&&e.dots>0&&(d=3*(l-18)+6)):1&l&&(d+=2*a),_=(.04*(v-m)+10)*a,slur_out(m,staff_tb[p].y+d,v,staff_tb[p].y+d,a,_,e.notes[o].ti1&SL_DOTTED)}}function draw_ties(e,t,n){var r,s,i,a,o,c,l=[],u=[],f=[],d=e.nhd,p=e.time+e.dur;if(e.type==GRACE)for(r=e.extra;r;)r.type==NOTE&&(e=r),r=r.next;if(t&&t.type==GRACE)for(r=t.extra;r;){if(r.type==NOTE){t=r,2==n&&(n=0);break}r=r.next}if(2==n){for(s=0;d>=s;s++)e.notes[s].ti1&&f.push(s);return void draw_note_ties(e,t||e,f,f,n)}for(s=0;d>=s;s++)if(e.notes[s].ti1){for(c=-1,o=e.notes[s].apit,a=t.nhd;a>=0;a--){switch(t.notes[a].apit-o){case 1:case-1:e.notes[s].acc!=t.notes[a].acc&&(c=a);default:continue;case 0:c=a}break}c>=0?(l.push(s),u.push(c)):f.push(s)}if(draw_note_ties(e,t,l,u,n),0!=f.length){for(r=e.ts_next;r&&r.time<p;)r=r.ts_next;for(;r&&r.time==p;)if(r.type==NOTE&&r.st==e.st){for(l.length=0,u.length=0,s=f.length;--s>=0;)for(i=f[s],o=e.notes[i].apit,a=r.nhd;a>=0;a--)if(r.notes[a].apit==o){l.push(i),u.push(a),f[s]=f.pop();break}if(l.length>0&&(draw_note_ties(e,r,l,u,1==n?1:0),0==f.length))return;r=r.ts_next}else r=r.ts_next;0!=f.length&&error(1,e,"Bad tie")}}function tie_comb(e){var t,n,r;for(n=e.time+e.dur,r=e.st,t=e.ts_next;t;t=t.ts_next)if(t.st==r)if(t.time!=n){if(t.time>n)return e}else if(t.type==NOTE)return t;return null}function draw_all_ties(e){var t,n,r,s,i,a,o,c,l;for(t=e.sym;t;t=t.next){switch(t.type){case CLEF:case KEY:case METER:continue}break}for(a=e.s_rtie,n=t;n&&(!n.dur&&n.type!=GRACE);n=n.next)n.type==BAR&&n.text&&("1"==n.text[0]?a=e.s_tie:e.s_tie=a);if(n){for(e.s_tie&&(e.s_tie.x=t.x+t.wr,t=e.s_tie,delete e.s_tie,t.st=n.st,t.ts_next=n.ts_next,t.time=n.time-t.dur,draw_ties(t,n,1));;){for(t=n;t&&!t.ti1;t=t.next)if(a&&t.type==BAR&&t.text)if("1"!=t.text[0]){if("|"!=t.bar_type){for(n=t.next;n&&n.type!=NOTE;n=n.next);if(!n){t=null;break}o=clone(a),o.x=t.x+t.wr,o.next=n,o.st=n.st,o.time=n.time-o.dur,draw_ties(o,n,1)}}else a=null;if(!t)break;for(i=t.time+t.dur,n=t.next;n&&!n.dur;n=n.next);if(n){if(n.type!=NOTE){error(1,t,"Bad tie");continue}n.time!=i&&(n=tie_comb(t))}else{for(n=t.ts_next;n;n=n.ts_next)if(n.st==t.st&&!(n.time<i)){if(n.time>i){n=null;break}if(n.dur)break}if(!n){draw_ties(t,null,2),e.s_tie=t;break}}for(r=t.ts_next;r;r=r.ts_next)if(r.st==t.st){if(r.time>i)break;if(r.type!=CLEF){if(r.type==BAR){if(":"==r.bar_type[0]||"|]"==r.bar_type||"[|"==r.bar_type){n=r;break}if(!r.text)continue;if("1"!=r.text[0]){n=r;break}a=t}}else s=!0}s||t.st!=n.st?(s=!1,l=.4*(n.x-t.x),c=n.x,n.x-=l,n.x>t.x+32&&(n.x=t.x+32),draw_ties(t,n,2),n.x=c,c=t.x,t.x+=l,t.x<n.x-24&&(t.x=n.x-24),draw_ties(t,n,3),t.x=c):draw_ties(t,n,n.type==NOTE?0:2)}e.s_rtie=a}}function draw_all_slurs(e){var t,n,r,s=e.sym;if(s){var i=0;if(r=e.slur_start)for(;0!=r;)i<<=4,i|=15&r,r>>=4;for(delete e.slur_start,draw_slurs(s,void 0);s;s=s.next)if(s.type==NOTE||s.type==REST||s.type==SPACE)for(;s.slur_end||s.sl2;){if(s.slur_end)s.slur_end--,n=-1;else{for(n=0;n<=s.nhd&&!s.notes[n].sl2;n++);s.notes[n].sl2--,s.sl2--}r=15&i,t=prev_scut(s),draw_slur(t,s,-1,n,r),t.type==BAR&&(":"==t.bar_type[0]||"|]"==t.bar_type||"[|"==t.bar_type||t.text&&"1"!=t.text[0])||(i>>=4)}for(s=e.sym;0!=i;)r=15&i,i>>=4,t=next_scut(s),draw_slur(s,t,-1,-1,r),t.type==BAR&&(":"==t.bar_type[0]||"|]"==t.bar_type||"[|"==t.bar_type||t.text&&"1"!=t.text[0])||(e.slur_start<<=4,e.slur_start+=r)}}function draw_sym_near(){var e,t,n,r,s,i,a,o,c,l,s;for(r=0;r<voice_tb.length;r++){var u={},f=!0;for(e=voice_tb[r],n=e.sym;n;n=n.next){for(a=n.extra;a;a=a.next)a.type==NOTE&&a.beam_st&&!a.beam_end&&calculate_beam(u,a);n.type==NOTE&&(n.beam_st&&!n.beam_end||f&&!n.beam_st)&&(f=!1,calculate_beam(u,n))}}for(s=0;s<=nstaff;s++)for(t=staff_tb[s],t.top||(t.top=[],t.bot=[]),l=0;l<YSTEP;l++)t.top[l]=0,t.bot[l]=24;for(set_tie_room(),draw_deco_near(),n=tsfirst;n;n=n.ts_next)if(!n.invisible)if(n.type!=GRACE)n.type!=MREST?(y_set(n.st,!0,n.x-n.wl,n.wl+n.wr,n.ymx+2),y_set(n.st,!1,n.x-n.wl,n.wl+n.wr,n.ymn-2)):y_set(n.st,!0,n.x-16,32,n.ymx+2),n.type==NOTE&&(n.notes[n.nhd].acc&&(i=n.y+8,n.ymx<i&&(n.ymx=i),y_set(n.st,!0,n.x,0,i)),n.notes[0].acc&&(i=n.y,i-=1==n.notes[0].acc||3==n.notes[0].acc?7:5,n.ymn>i&&(n.ymn=i),y_set(n.st,!1,n.x,0,i)));else for(a=n.extra;a;a=a.next)y_set(n.st,!0,a.x-2,4,a.ymx+1),y_set(n.st,!1,a.x-2,4,a.ymn-1);for(cfmt.measurenb>=0&&draw_measnb(),draw_deco_note(),r=0;r<voice_tb.length;r++)if(e=voice_tb[r],n=e.sym){for(s=e.st,set_dscale(s);n;n=n.next)if(n.in_tuplet)for(a=n.extra;a;a=a.next)if(a.type==TUPLET){n=draw_tuplet(a,n);break}for(draw_all_slurs(e),n=e.sym;n;n=n.next)if(n.in_tuplet)for(a=n.extra;a;a=a.next)if(a.type==TUPLET){n=draw_tuplet(a,n);break}}for(s=0;s<=nstaff;s++)for(t=staff_tb[s],o=t.topbar+2,c=t.botbar-2,l=0;l<YSTEP;l++)o>t.top[l]&&(t.top[l]=o),c<t.bot[l]&&(t.bot[l]=c);for(r=0;r<voice_tb.length;r++)if(e=voice_tb[r],e.have_ly){draw_all_lyrics();break}draw_deco_staff(),set_sscale(-1)}function draw_vname(e){var t,n,r,s,i,a,o,c=[];for(r=cur_sy.nstaff;r>=0&&cur_sy.staves[r].empty;r--);if(!(0>r)){for(s=0;s<voice_tb.length;s++)if(t=voice_tb[s],t.sym&&(r=cur_sy.voices[s].st,cur_sy.staves[r]&&!cur_sy.staves[r].empty&&(t.new_name?(delete t.new_name,a=t.nm):a=t.snm,a))){if(cur_sy.staves[r].flags&CLOSE_BRACE2)for(;!(cur_sy.staves[r].flags&OPEN_BRACE2);)r--;else if(cur_sy.staves[r].flags&CLOSE_BRACE)for(;!(cur_sy.staves[r].flags&OPEN_BRACE);)r--;c[r]?c[r]+="\\n"+a:c[r]=a}if(0!=c.length)for(set_font("voice"),e=.5*-e,r=0;r<c.length;r++)if(c[r]){if(i=c[r].split("\\n"),o=staff_tb[r].y+.5*staff_tb[r].topbar*staff_tb[r].staffscale+9*(i.length-1)-.3*gene.curfont.size,n=r,cur_sy.staves[r].flags&OPEN_BRACE2)for(;!(cur_sy.staves[n].flags&CLOSE_BRACE2);)n++;else if(cur_sy.staves[r].flags&OPEN_BRACE)for(;!(cur_sy.staves[n].flags&CLOSE_BRACE);)n++;for(n!=r&&(o-=.5*(staff_tb[r].y-staff_tb[n].y)),n=0;n<i.length;n++)a=i[n],xy_str(e,o,a,"c"),o-=18}}}function set_staff(){var e,t,n,r,s,i,a,o,c,l,u,f,d,p,h=[];for(r=0;r<=nstaff;r++)staff_tb[r].empty=!1,h[r]=!0;for(t=cur_sy,r=0;r<t.staves.length;r++)t.staves[r].empty||(h[r]=!1);for(e=tsfirst;e;e=e.ts_next)if(e.new_sy)for(t=t.next,r=0;r<t.staves.length;r++)t.staves[r].empty||(h[r]=!1);for(i=0;i<voice_tb.length;i++)d=voice_tb[i],1!=d.scale&&(d.scale_str='transform="scale('+d.scale.toFixed(2)+')"');for(r=0;r<=nstaff&&h[r];r++)staff_tb[r].empty=!0;if(a=0,r>nstaff)r--;else for(p=staff_tb[r],n=0;n<YSTEP;n++)f=p.top[n],f>a&&(a=f);if(a+=draw_partempo(r,a),h[r])return a;o=.5*cfmt.staffsep+staff_tb[r].topbar*staff_tb[r].staffscale,o>a&&(a=o),p.y=-a,s=r;var m=t.staves[s];for(r++;r<=nstaff;r++)if(p=staff_tb[r],h[r])p.empty=!0;else{if(o=m.sep?m.sep:cfmt.sysstaffsep,l=m.maxsep?m.maxsep:cfmt.maxsysstaffsep,c=0,p.staffscale==staff_tb[s].staffscale){for(n=0;n<YSTEP;n++)f=p.top[n]-staff_tb[s].bot[n],f>c&&(c=f);c*=p.staffscale}else for(n=0;n<YSTEP;n++)f=p.top[n]*p.staffscale-staff_tb[s].bot[n]*staff_tb[s].staffscale,f>c&&(c=f);o+=p.topbar*p.staffscale,o>c&&(c=o),l+=p.topbar*p.staffscale,c>l&&(c=l),a+=c,p.y=-a,s=r,m=t.staves[s]}for(u=0,n=0;n<YSTEP;n++)f=staff_tb[s].bot[n],u>f&&(u=f);for(u*=staff_tb[s].staffscale,r=0;r<=nstaff;r++)p=staff_tb[r],c=p.y,1!=p.staffscale?(p.scale_str='transform="translate(0,'+(posy-c).toFixed(2)+") scale("+p.staffscale.toFixed(2)+')"',p.y_delayed=0):p.y_delayed=posy-c;if(0==u){for(r=nstaff;r>=0&&h[r];r--);if(0>r)return a}return c=-u,o=.5*cfmt.staffsep,o>c&&(c=o),l=.5*cfmt.maxstaffsep,c>l&&(c=l),a+=c,a>cfmt.maxstaffsep&&(a=cfmt.maxstaffsep),a}function bar_set(e,t){var n,r,s,i,a=0;for(n=0;n<=cur_sy.nstaff;n++)cur_sy.staves[n].empty?e[n]=t[n]=0:(r=staff_tb[n].staffscale,s=staff_tb[n].topbar*r,i=staff_tb[n].botbar*r,0==a&&(a=staff_tb[n].y+s),t[n]=a-staff_tb[n].y-i,e[n]=staff_tb[n].y+i,a=cur_sy.staves[n].flags&STOP_BAR?0:e[n])}function draw_systems(e){function t(e,t,n){var r,s,i=staff_tb[e].y,a=staff_tb[e].stafflines;if("."!=a[a.length-1]){for(set_sscale(e),r=(n-t)/stv_g.scale,s=0;s<a.length&&"."==a[s];s++)i+=6;for(xypath(t,i),output.push("h"+r.toFixed(2)),i=0,s++;s<a.length;s++)i-=6,"."!=a[s]&&(output.push("m-"+r.toFixed(2)+" "+i),output.push("h"+r.toFixed(2)),i=0);output.push('"/>\n')}}var n,r,s,i,a,o,c,l=[],u=[],f=[];for(draw_vname(e),i=0;i<=nstaff;i++)l[i]=!cur_sy.staves[i]||cur_sy.staves[i].empty?-1:0;for(bar_set(u,f),draw_lstaff(0),r=tsfirst;r;r=r.ts_next){if(r.new_sy){for(n=cur_sy.next,i=0;i<=nstaff;i++)if(a=l[i],0>a)n.staves[i]&&!n.staves[i].empty&&(r.type==BAR?l[i]=r.x:l[i]=r.x-r.wl-2);else{if(o=r.ts_prev.type==BAR?r.ts_prev.x:r.x-r.wl-2,!n.staves[i]||n.staves[i].empty)l[i]=-1;else{if(n.staves[i].stafflines==cur_sy.staves[i].stafflines)continue;l[i]=o}t(i,a,o)}cur_sy=n,c=bar_set(),u=c[0],f=c[1]}switch(i=r.st,r.type){case BAR:if((r.second||cur_sy.staves[i].empty)&&(r.invisible=!0),r.invisible)break;user.anno_start&&anno_start(r),draw_bar(r,u[i],f[i]),user.anno_stop&&anno_stop(r);break;case STBRK:if(0==cur_sy.voices[r.v].range&&r.xmx>14){for(var d=0,p=0;p<voice_tb.length;p++)cur_sy.voices[p].range>0&&d++;for(s=r.ts_next;s&&s.type==STBRK;s=s.ts_next)d--;0==d&&draw_lstaff(r.x)}if(s=r.prev,!s)break;if(o=s.x,s.type!=BAR&&(o+=s.wr),i=r.st,a=l[i],a>=0){if(a>=o)continue;t(i,a,o)}l[i]=r.x}}for(i=0;i<=nstaff;i++)(a=l[i])<0||t(i,a,realwidth)}function draw_symbols(e){var t,n,r,s,i,a,o={};for(a=!0,t=e.sym;t;t=t.next){if(t.extra)for(n=t.extra;n;n=n.next)n.type==FORMAT&&"voicecolor"==n.fmt_type&&(e.color=n.color,set_color(e.color));if(!t.invisible||t.type==NOTE||t.type==REST||t.type==GRACE)switch(r=t.x,t.type){case NOTE:set_color(e.color),set_scale(t),(t.beam_st&&!t.beam_end||a&&!t.beam_st)&&(a=!1,calculate_beam(o,t)&&draw_beams(o)),user.anno_start&&anno_start(t),draw_note(t,!o.s2),user.anno_stop&&anno_stop(t),t==o.s2&&(o.s2=null);break;case REST:set_color(e.color),set_scale(t),user.anno_start&&anno_start(t),draw_rest(t),user.anno_stop&&anno_stop(t);break;case BAR:break;case CLEF:if(i=t.st,t.second)break;if(t.invisible||staff_tb[i].empty)break;set_color(void 0),set_sscale(i),user.anno_start&&anno_start(t),s=staff_tb[i].y,t.clef_name?xygl(r,s+t.y,t.clef_name):t.clef_small?xygl(r,s+t.y,"s"+t.clef_type+"clef"):xygl(r,s+t.y,t.clef_type+"clef"),t.clef_octave&&(t.clef_octave>0?(s+=t.ymx-10,t.clef_small&&(s-=1)):(s+=t.ymn+2,t.clef_small&&(s+=1)),xygl(r-2,s,"oct")),user.anno_stop&&anno_stop(t);break;case METER:if(e.meter=t,t.second||staff_tb[t.st].empty)break;if(cfmt.alignbars&&0!=t.st)break;set_color(void 0),set_sscale(t.st),user.anno_start&&anno_start(t),draw_meter(r,t),user.anno_stop&&anno_stop(t);break;case KEY:if(e.key=t,t.second||staff_tb[t.st].empty)break;set_color(void 0),set_sscale(t.st),user.anno_start&&anno_start(t),draw_keysig(e,r,t),user.anno_stop&&anno_stop(t);break;case MREST:set_color(e.color),set_scale(t),xygl(r,staff_tb[t.st].y+12,"mrest"),output.push('<text style="font:bold 15px serif"\n	x ="'),out_sxsy(r,'" y="',staff_tb[t.st].y+28),output.push('" text-anchor="middle">'+t.nmes+"</text>\n");break;case GRACE:set_color(e.color),set_scale(t),draw_gracenotes(t);break;case SPACE:case STBRK:case FORMAT:break;case CUSTOS:set_color(e.color),set_scale(t),t.stemless=!0,draw_note(t,0);break;default:error(2,t,"draw_symbols - Cannot draw symbol "+t.type)}}set_color(e.color),set_scale(e.sym),draw_all_ties(e),set_color(void 0)}function draw_all_sym(){var e,t,n,r=voice_tb.length;for(n=0;r>n;n++)e=voice_tb[n],e.sym&&draw_symbols(e);for(t=tsfirst;t;t=t.ts_next)t.type==CLEF&&(staff_tb[t.st].clef=t)}function set_tie_dir(e){var t,n,r,s,i,a,o;for(t=e;t;t=t.next)if(t.ti1)if(0==t.multi){for(i=r=0,a=128,n=0;n<=t.nhd;n++)t.notes[n].ti1&&(r++,128>a&&t.notes[n].pit<=a+1&&i++,a=t.notes[n].pit);if(1>=r){for(s=t.stem<0?SL_ABOVE:SL_BELOW,n=0;n<=t.nhd;n++)if(o=t.notes[n].ti1){(7&o)==SL_AUTO&&(t.notes[n].ti1=o&SL_DOTTED|s);break}}else if(0!=i){for(a=128,n=0;n<=t.nhd;n++)if(t.notes[n].ti1){if(128>a&&t.notes[n].pit<=a+1){r=n;break}a=t.notes[n].pit}for(s=SL_BELOW,n=0;n<=t.nhd;n++)o=t.notes[n].ti1,0!=o&&(r==n&&(s=SL_ABOVE),(7&o)==SL_AUTO&&(t.notes[n].ti1=o&SL_DOTTED|s))}else{if(1&r){for(r=(r-1)/2,s=SL_BELOW,n=0;n<=t.nhd;n++)o=t.notes[n].ti1,0!=o&&(0==r&&t.notes[n].pit>=22&&(s=SL_ABOVE),(7&o)==SL_AUTO&&(t.notes[n].ti1=o&SL_DOTTED|s),0==r--&&(s=SL_ABOVE));continue}for(r/=2,s=SL_BELOW,n=0;n<=t.nhd;n++)o=t.notes[n].ti1,0!=o&&((7&o)==SL_AUTO&&(t.notes[n].ti1=o&SL_DOTTED|s),0==--r&&(s=SL_ABOVE))}}else for(s=t.multi>0?SL_ABOVE:SL_BELOW,n=0;n<=t.nhd;n++)o=t.notes[n].ti1,(7&o)==SL_AUTO&&(t.notes[n].ti1=o&SL_DOTTED|s)}function set_tie_room(){var e,t,n,r,s,i,a;for(r=0;r<voice_tb.length;r++)if(e=voice_tb[r],t=e.sym,t&&(t=t.next))for(set_tie_dir(t);t;t=t.next)if(t.ti1){if(t.notes[0].pit<20&&(7&t.notes[0].ti1)==SL_BELOW);else if(!(t.notes[t.nhd].pit>24&&(7&t.notes[t.nhd].ti1)==SL_ABOVE))continue;for(n=t.next;n&&n.type!=NOTE;)n=n.next;if(n){if(n.st!=t.st)continue;s=n.x-t.x-10}else s=realwidth-t.x-10;a=100>s?9:300>s?12:16,t.notes[t.nhd].pit>24&&(i=3*(t.notes[t.nhd].pit-18)+a,t.ymx<i&&(t.ymx=i),n&&n.ymx<i&&(n.ymx=i),y_set(t.st,!0,t.x+5,s,i)),t.notes[0].pit<20&&(i=3*(t.notes[0].pit-18)-a,t.ymn>i&&(t.ymn=i),n&&n.ymn>i&&(n.ymn=i),y_set(t.st,!1,t.x+5,s,i))}}function get_bool(e){return!e.match(/^(0|n|f)/i)}function get_int(e){var t=parseInt(e);return isNaN(t)&&(parse.line.error("Bad integer value\n"),t=1),t}function get_font_scale(e){var t=e.split(/\s+/);if(!(t.length<=1)){var n=parseFloat(t[t.length-1]);if(isNaN(n)||0>=t)return void parse.line.error("Bad scale value in %%font");font_scale_tb[t[0]]=n;for(var r in font_tb){var s=font_tb[r];s.name==t[0]&&(s.swfac=s.size*n)}}}function param_set_font(e,t){var n,r,s,i,a,o,c,l,u;if("-"==e[e.length-2]){if(i=e[e.length-1],"1">i||i>"9")return;e="u"+i+"font"}r=cfmt[e],r&&(n=font_tb[r],n&&(s=n.name+"."+n.size)),a=t.split(/\s+/),o=a[0],"*"==o&&n?o=n.name:(o=o.replace("Times-Roman","serif"),o=o.replace("Times","serif"),o=o.replace("Helvetica","sans-serif"),o=o.replace("Courier","monospace")),a.length>1?(l=a[a.length-1],"*"==l&&(l=n.size)):l=n.size,c=o+"."+l,c!=s&&(n=font_tb[c],n||(u=font_scale_tb[o],u||(u=1.1),n={name:o,size:Number(l),swfac:l*u},font_tb[c]=n),cfmt[e]=c)}function get_unit(e){var t=parseFloat(e);switch(e.slice(-2)){case"CM":case"cm":t*=28.35;break;case"IN":case"in":t*=72}return t}function get_unitp(e){var t=parseFloat(e);switch(e.slice(-2)){case"CM":case"cm":t*=CM;break;case"IN":case"in":t*=IN}return t}function set_infoname(e){for(var t=cfmt.infoname.split("\n"),n=e[0],r=0;r<t.length;r++){var s=t[r];if(s[0]==n)return 1==e.length?t.splice(r,1):t[r]=e,void(cfmt.infoname=t.join("\n"))}cfmt.infoname+="\n"+e}function get_textopt(e){return textopt[e]}function set_pos(e,t){var n,r,s;switch(r=t[0]>="0"&&t[0]<="3"?parseInt(t):posval[t]||0,e[0]){case"d":e="dyn";break;case"g":e="c"==e[1]?"gch":"gst";break;case"o":e="orn";break;case"s":e="ste";break;case"v":e="c"==e[2]?"voc":"vol";break;default:return}if(s=curvoice?curvoice.pos:cfmt.pos,s[e]=r,!curvoice)for(n=0;n<voice_tb.length;n++)voice_tb[n].pos[e]=r}function set_writefields(e){var t,n,r=e.split(/\s+/);if(get_bool(r[1]))for(n=0;n<r[0].length;n++)t=r[0][n],cfmt.writefields.indexOf(t)<0&&(cfmt.writefields+=t);else for(n=0;n<r[0].length;n++)t=r[0][n],cfmt.writefields.indexOf(t)>=0&&(cfmt.writefields=cfmt.writefields.replace(t,""))}function set_format(e,t,n){function r(e,t){return curvoice?void(curvoice[e]=t):0==parse.state?void(cfmt["voice"+e]=t):(parse.voice_param||(parse.voice_param={}),void(parse.voice_param[e]=t))}var s,a,o,c;if(n)n[e]=!0;else if(n[e])return;if(e.match(/.+font$/)||e.match(/.+font-[\d]$/)){if(" box"==t.slice(-4)&&(c=!0,t=t.slice(0,-4)),param_set_font(e,t),c)switch(e){case"gchordfont":cfmt.gchordbox=c;break;case"measurefont":cfmt.measurebox=c;break;case"partsfont":cfmt.partsbox=c}}else switch(e){case"aligncomposer":case"barsperstaff":case"infoline":case"measurefirst":case"measurenb":case"rbmax":case"rbmin":case"shiftunison":case"staffnonote":cfmt[e]=get_int(t);break;case"microscale":if(s=get_int(t),4>s||s>256||s%1){parse.line.error("Bad value for "+e);break}if(cfmt.microscale=s,0==parse.state)break;if(1==parse.state)for(o=0;o<voice_tb.length;o++)voice_tb[o].microscale=cfmt.microscale;else 2==parse.state&&goto_tune(),curvoice.microscale=cfmt.microscale;break;case"bgcolor":case"dblrepbar":case"titleformat":cfmt[e]=t;break;case"breaklimit":case"lineskipfac":case"maxshrink":case"pagescale":case"parskipfac":case"scale":case"slurheight":case"stemheight":case"stretchlast":if(s=parseFloat(t),!s){parse.line.error("Bad value for "+e);break}"scale"==e?s/=.75:"pagescale"==e&&(e="scale"),cfmt[e]=s;break;case"bstemdown":case"breakoneoln":case"cancelkey":case"custos":case"decoerr":case"dynalign":case"flatbeams":case"gchordbox":case"graceslurs":case"hyphencont":case"keywarn":case"linewarn":case"measurebox":case"partsbox":case"singleline":case"squarebreve":case"straightflags":case"stretchstaff":case"timewarn":case"titlecaps":case"titleleft":case"titletrim":cfmt[e]=get_bool(t);break;case"composerspace":case"indent":case"infospace":case"maxstaffsep":case"maxsysstaffsep":case"musicspace":case"partsspace":case"staffsep":case"subtitlespace":case"sysstaffsep":case"textspace":case"titlespace":case"topspace":case"vocalspace":case"wordsspace":cfmt[e]=get_unit(t);break;case"leftmargin":case"pagewidth":case"rightmargin":cfmt[e]=get_unitp(t);break;case"contbarnb":cfmt.contbarnb=get_int(t);break;case"writefields":set_writefields(t);break;case"dynamic":case"gchord":case"gstemdir":case"ornament":case"stemdir":case"vocal":case"volume":set_pos(e,t);break;case"font":get_font_scale(t);break;case"fullsvg":if(0!=parse.state){parse.line.error("Cannot have 'fullsvg' inside a tune");break}cfmt[e]=t;break;case"gracespace":case"tuplets":cfmt[e]=t.split(/\s+/);break;case"infoname":set_infoname(t);break;case"notespacingfactor":if(s=parseFloat(t),!s||1>s||s>2){parse.line.error("Bad value for notespacingfactor");break}for(i=5,a=space_tb[i];--i>=0;)a/=s,space_tb[i]=a;for(i=5,a=space_tb[i];++i<space_tb.length;)a*=s,space_tb[i]=a;break;case"pos":e=t.match(/(\w|-)+/),e=e[0],t=t.replace(e,"").trim(),set_pos(e,t);break;case"staffwidth":o=cfmt.pagewidth-get_unitp(t)-cfmt.leftmargin,0>o?parse.line.error("'staffwidth' too big"):cfmt.rightmargin=o;break;case"textoption":cfmt[e]=get_textopt(t);break;case"combinevoices":case"voicecombine":if(o=parseInt(t),isNaN(o)||-1>o||o>2)return void parse.line.error("Bad value in %%voicecombine");if(curvoice&&"combinevoices"==e)for(s=0;s<voice_tb.length;s++)voice_tb[s].combine=o;r("combine",o);break;case"voicemap":r("map",t);break;case"voicescale":if(o=parseFloat(t),isNaN(o)||.6>o||o>1.5)return void parse.line.error("Bad %%voicescale value");r("scale",o)}}function font_init(){param_set_font("annotationfont","sans-serif 12"),param_set_font("composerfont","serifItalic 14"),param_set_font("gchordfont","sans-serif 12"),param_set_font("historyfont","serif 16"),param_set_font("infofont","serifItalic 14"),param_set_font("measurefont","serifItalic 14"),param_set_font("partsfont","serif 15"),param_set_font("repeatfont","serif 13"),param_set_font("subtitlefont","serif 16"),param_set_font("tempofont","serifBold 15"),param_set_font("textfont","serif 16"),param_set_font("titlefont","serif 20"),param_set_font("vocalfont","serifBold 13"),param_set_font("voicefont","serifBold 13"),param_set_font("wordsfont","serif 16")}function style_add_font(e){var t=e.name,n=t.indexOf("Italic"),r=100,s=t.indexOf("Oblique"),i=t.indexOf("Bold");font_style+="\n.f"+e.fid+cfmt.fullsvg+" {font:",i>0&&(font_style+="bold ",r=i),(n>0||s>0)&&(n>0&&(font_style+="italic ",r>n&&(r=n)),s>0&&(font_style+="oblique ",r>s&&(r=s))),100!=r&&("-"==t[r-1]&&r--,t=t.slice(0,r)),font_style+=e.size+"px "+t+"}"}function use_font(e){defined_font[e.fid]||(defined_font[e.fid]=!0,style_add_font(e))}function get_font(e){e+="font";var t=cfmt[e],n=font_tb[t];return n?(n.fid||(n.fid=fid++),use_font(n),n):(parse.line.error("Unknown font "+e),null)}function cnv_escape(e){for(var t,n,r,s,i="",a=0;;){if(r=e.indexOf("\\",a),0>r)break;if(i+=e.slice(a,r),t=e[++r],void 0==t)return i+"\\";switch(t){case"0":case"2":if("0"==e[r+1])switch(e[r+2]){
case"1":i+="â™¯",a=r+3;continue;case"2":i+="â™­",a=r+3;continue;case"3":i+="â™®",a=r+3;continue;case"4":s=[55348,56618],i+=String.fromCharCode.apply(null,s),a=r+3;continue;case"5":s=[55348,56619],i+=String.fromCharCode.apply(null,s),a=r+3;continue}case"1":case"3":if(e[r+1]>="0"&&e[r+1]<="7"&&e[r+2]>="0"&&e[r+2]<="7"){a=parseInt(e.slice(r,r+3),8),i+=String.fromCharCode(a),a=r+3;continue}break;case"u":s=[],a=parseInt(e.slice(r+1,r+5),16),s.push(a),a>=55296&&57343>=a?(a=parseInt(e.slice(r+7,r+11),16),s.push(a),a=r+11):a=r+5,i+=String.fromCharCode.apply(null,s);continue;default:if(n=abc_utf[e.slice(r,r+2)]){i+=n,a=r+2;continue}}i+="\\"+t,a=r+1}return i+e.slice(a)}function do_include(e){var t,n;return user.read_file?0>=include?void syntax(1,"Too many include levels"):(include--,(t=user.read_file(e))?(n=clone(parse),tosvg(e,t),parse=n,void include++):void error(1,void 0,"Cannot read file '"+e+"'")):void syntax(1,"No read_file support")}function tosvg(e,t){function n(){for(f=l;u>f&&(c=t[f]," "==c||"	"==c);)f++}function r(){for(d=u-1;d>l&&(c=t[d]," "==c||"	"==c);)d--;d++}function s(){var e=t.indexOf("K:",l);return 0>e?!1:(e=t.indexOf("\n",e),parse.select.test(t.slice(l,e))?!0:(u=t.indexOf("\n\n",e),0>u?u=B-1:u++,!1))}function i(e,t){var n,r,s,i;for(t&&e.indexOf("\\")>=0&&(e=cnv_escape(e)),i=e.length,n=0;i>n;n++){switch(s=e[n]){case"\\":n++;continue;case"%":return e.slice(0,n).replace(/\s+$/,"");case'"':break;default:continue}for(r=n+1;(r=e.indexOf('"',r),!(0>r))&&"\\"==e[r-1];);if(0>r)break;n=r}return e=e.replace(/\s+$/,""),e.replace(/\\%/g,"%")}function a(){gen_ly(!1),put_history(),blk_out(),blk_flush(),parse.state=0,cfmt=E,posx=cfmt.leftmargin/cfmt.scale,info=T,char_tb=C,glovar=S,maps=O,init_tune()}var o,c,l,u,f,d,p,h,m,v,_,g,y,b,x,w,k,E,T,C,S,O,A,N="\n",B=t.length;for(parse.file=t,parse.ctx={fname:e},line=new scanBuf,parse.line=line,line.buffer=t,line.index=0,l=0,l=0;!(l>=B);l=u+1)if(u=t.indexOf("\n",l),0>u&&(u=B),u!=l){if(parse.istart=parse.bol=l,parse.iend=parse.eol=u,v=t[l],_=t[l+1],"%"==v){if(parse.prefix.indexOf(_)<0)continue;"a"==t[l+2]&&"b"==t[l+3]&&"c"==t[l+4]&&" "==t[l+5]?(l+=6,v=t[l],_=t[l+1]):A=!0}else"I"==v&&":"==_&&(A=!0);if(A){if(A=!1,l+=2,n(),r(),b=t.slice(f,d),!b||"%"==b[0])continue;switch(x=b.split(/\s+/,2),x[0]||x.shift(),x[0]){case"abcm2ps":parse.prefix=x[1];continue;case"abc-include":if(h=x[1].match(/.*\.(.*)/),!h)continue;switch(h[1]){case"abc":do_include(x[1])}continue}if(w=x[0].match(/begin(.*)/)){if(p="\n"+v+_+"end"+w[1],o=t.indexOf(p,u),0>o){syntax(1,"No "+p.slice(1)+" after %%"+w[0]),u=B;continue}do_begin_end(w[1],x[1],parse.file.slice(u+1,o).replace(new RegExp("^"+v+_,"gm"),"")),u=t.indexOf("\n",o+6),0>u&&(u=B);continue}switch(x[0]){case"select":if(0!=parse.state){syntax(1,"%%select ignored");continue}m=i(b.slice(7).trim(),!1),'"'==m[0]&&(m=m.slice(1,-1)),m=m.replace(/\(/g,"\\("),m=m.replace(/\)/g,"\\)"),parse.select=new RegExp(m,"m");continue;case"tune":syntax(1,"%%tune not treated yet");continue;case"voice":if(0!=parse.state){syntax(1,"%%voice ignored");continue}if(m=i(b.slice(6).trim(),!1),!m){parse.cur_tune_opts?parse.cur_tune_opts.voice_opts=null:parse.voice_opts=null;continue}if("end"==m)continue;for(parse.cur_tune_opts?(parse.cur_tune_opts.voice_opts||(parse.cur_tune_opts.voice_opts={}),y=parse.cur_tune_opts.voice_opts):(parse.voice_opts||(parse.voice_opts={}),y=parse.voice_opts),y[m]=[];;){if(l=++u,"%"!=t[l])break;if(u=t.indexOf("\n",u),t[l+1]==_){switch(l+=2,b=0>u?t.slice(l):t.slice(l,u),x=b.split(/\s+/,1),x[0]){default:y[m].push(i(b.trim(),!0));continue;case"score":case"staves":case"tune":case"voice":l-=2}break}}u=l-1;continue}do_pscom(i(b.trim(),!0))}else if(":"==_){if(b=t.slice(l+2,u),b=i(b.trim(),!0),"+"==v&&":"==_){if(!g){syntax(1,"No previous info field");continue}N=" ",v=g}switch(v){case"X":if(0!=parse.state){syntax(1,"X: found in tune - ignored");continue}if(parse.select&&!s())continue;E=clone(cfmt),cfmt.pos=clone(cfmt.pos),T=clone(info),C=clone(char_tb),S=clone(glovar),O=maps,info.X=b,parse.state=1;continue;case"T":if(0==parse.state)continue;if(curvoice=voice_tb[0],!curvoice){void 0==info.T?info.T=b:info.T+="\n"+b;continue}k={type:BLOCK,subtype:"title",text:b},sym_link(k);continue;case"K":if(0==parse.state)continue;if(1==parse.state?info.K=b:2==parse.state&&goto_tune(),parse.line.buffer=b,parse.line.index=0,do_info(v,b),1!=parse.state)continue;parse.state=2,glovar.ulen||(glovar.ulen=BASE_LEN/8);continue;case"W":if(0==parse.state||cfmt.writefields.indexOf("W")<0)break;info.W?info.W+=N+b:info.W=b;break;case"s":if(3!=parse.state)break;break;case"w":if(3!=parse.state||cfmt.writefields.indexOf("w")<0)break;if(get_lyrics(b," "==N),"\\"==b[b.length-1]){N=" ",g=v;continue}break;case"|":if(3!=parse.state){if(2!=parse.state)continue;goto_tune()}parse_music_line();continue;default:if("ABCDFGHOSZ".indexOf(v)>=0){if(parse.state>=2){syntax(1,v+": in tune - ignored");continue}info[v]?info[v]+=N+b:info[v]=b;break}parse.line.buffer=b,parse.line.index=0,do_info(v,b);continue}N="\n",g=v}else{if(g=void 0,3!=parse.state){if(2!=parse.state)continue;goto_tune()}parse_music_line()}}else 1==parse.state?(parse.istart=l,syntax(1,"Empty line in tune header - ignored")):parse.state>=2&&a();parse.state>=2&&a(),blk_flush(),parse.state=0}function set_head_shift(e){var t,n,r,s,i,a,o=dx_tb[e.head],c=e.stem,l=e.nhd;if(e.dur>=2*BASE_LEN&&"oval"==e.head&&(o=15.8),0==l)return void(e.notes[0].acc&&(e.grace&&(o*=.7),e.notes[0].shac=o));a=.78*o,e.grace&&(a*=.5),c>=0?(n=1,r=l+1,i=e.notes[0].pit):(a=-a,n=l-1,r=-1,i=e.notes[l].pit);var u=!1,f=0;for(t=n;t!=r;t+=c){if(s=e.notes[t].pit-i,i=e.notes[t].pit,0==s){if(u){var d=e.notes[t].shhd=e.notes[t-c].shhd+a;d>f&&(f=d);continue}if(t+c!=r&&i+c==e.notes[t+c].pit){e.notes[t].shhd=-a,-a>f&&(f=-a);continue}}0>s&&(s=-s),s>3||s>=2&&"square"!=e.head?u=!1:(u=!u,u&&(e.notes[t].shhd=a,a>f&&(f=a)))}e.xmx=f}function set_acc_shft(){function e(e,t){var n,r,s,i,a,o,c,l=e.length;for(n=l-1;--n>=0;)if(s=e[n].shhd,s&&!(s>0))for(s=t-s,a=e[n].pit,r=l;--r>=0;)if(e[r].acc){if(o=e[r].pit,a-3>o)break;o>a+3||e[r].shac<s&&(e[r].shac=s)}for(n=l;--n>=0;)if(c=e[n].acc){for(s=e[n].shac,s||(s=e[n].shhd,s=0>s?t-s:t),a=e[n].pit,r=l;--r>n;)e[r].acc&&(o=e[r].pit,o>=a+4&&(o>a+4||0>c||e[r].acc<0)||s>e[r].shac-6&&(i=e[r].shac+7,i>s&&(s=i)));e[n].shac=s}}var t,n,r,s,i,r,a,o;for(t=tsfirst;t;)if(t.type!=NOTE||t.invisible)t=t.ts_next;else{for(r=t.st,a=t.time,i=!1,n=t;n&&(n.time==a&&n.type==NOTE&&n.st==r);n=n.ts_next)if(!i)for(s=0;s<=n.nhd;s++)if(n.notes[s].acc){i=!0;break}if(i){for(o=dx_tb[t.head],t.dur>=2*BASE_LEN&&"oval"==t.head&&(o=15.8),r={notes:[]};t!=n;t=t.ts_next)r.notes=r.notes.concat(t.notes);sort_pitch(r),e(r.notes,o)}else t=n}}function unlksym(e){if(e.next){if(e.next.prev=e.prev,e.extra){var t=e.next.extra;if(t){for(;t.next;t=t.next);t.next=e.extra}else e.next.extra=e.extra}}else if(e.extra)return e.type=FORMAT,void(e.fmt_type=void 0);e.prev?e.prev.next=e.next:voice_tb[e.v].sym=e.next,e.ts_next&&(e.seqst&&!e.ts_next.seqst&&(e.ts_next.seqst=!0,e.ts_next.shrink=e.shrink,e.ts_next.space=e.space),e.new_sy&&(e.ts_next.new_sy=!0),e.ts_next.ts_prev=e.ts_prev),e.ts_prev&&(e.ts_prev.ts_next=e.ts_next),tsfirst==e&&(tsfirst=e.ts_next),tsnext==e&&(tsnext=e.ts_next)}function may_combine(e){var t,n=e.ts_next;return!n||n.type!=NOTE&&n.type!=REST?!1:n.v==e.v||n.st!=e.st||n.time!=e.time||n.dur!=e.dur?!1:e.combine<=0&&n.type!=e.type?!1:e.a_gch&&n.a_gch?!1:e.type==REST?e.type==n.type&&e.invisible&&!n.invisible?!1:!0:n.a_ly||n.sl1||n.sl2||n.slur_start||n.slur_end?!1:n.beam_st!=e.beam_st||n.beam_end!=e.beam_end?!1:(t=n.nhd,e.combine<=1&&e.notes[0].pit<=n.notes[t].pit+1?!1:!0)}function combine_notes(e,t){var n,r,s;if(e.notes=e.notes.concat(t.notes),e.nhd=n=e.notes.length-1,sort_pitch(e),e.combine>=3){for(s=n;s>0;s--)e.notes[s].pit==e.notes[s-1].pit&&e.notes[s].acc==e.notes[s-1].acc&&e.notes.splice(s,1);e.nhd=n=e.notes.length-1}e.ymx=3*(e.notes[n].pit-18)+4,e.ymn=3*(e.notes[0].pit-18)-4,e.yav=(e.ymx+e.ymn)/2,e.a_dd?t.a_dd&&(e.a_dd=e.a_dd.concat(t.a_dd)):e.a_dd=t.a_dd,r=e.notes[0].ti1,(15&r)==SL_AUTO&&(e.notes[0].ti1=SL_BELOW|r&~SL_DOTTED),r=e.notes[n].ti1,(15&r)==SL_AUTO&&(e.notes[n].ti1=SL_ABOVE|r&~SL_DOTTED)}function do_combine(e){for(var t,n,r;;)if(n=e.nhd,t=e.ts_next,r=t.nhd,delete t.extra,e.type!=t.type?t.type!=REST&&(t=e,e=t.ts_next):e.type==REST?e.invisible&&!t.invisible&&delete e.invisible:combine_notes(e,t),t.text&&!e.text&&(e.text=t.text,e.a_gch=t.a_gch),unlksym(t),e.in_tuplet||!may_combine(e))break}function combine_voices(){var e,t,n,r,s;for(e=tsfirst;e.ts_next;e=e.ts_next)if(!(e.combine<0||0==e.combine&&e.type!=REST))if(e.in_tuplet){if(n=e.extra,!n)continue;for(s=0;n;n=n.next)n.type==TUPLET&&n.tuplet_r>s&&(s=n.tuplet_r);if(0==s)continue;for(r=s,t=e;t&&t.ts_next;t=t.next)if(t.type==NOTE||t.type==REST){if(!may_combine(t))break;if(--r<=0)break}if(r>0)continue;for(t=e;t.type!=NOTE&&t.type!=REST||(do_combine(t),!(--s<=0));t=t.next);}else if(e.type==NOTE){if(e.beam_st)if(e.beam_end)may_combine(e)&&do_combine(e);else{for(t=e;;){if(!may_combine(t)){t=null;break}if(t.beam_end)break;do t=t.next;while(t.type!=NOTE&&t.type!=REST)}if(t)for(t=e;;){if(do_combine(t),t.beam_end)break;do t=t.next;while(t.type!=NOTE&&t.type!=REST)}}}else e.type==REST&&may_combine(e)&&do_combine(e)}function insert_clef(e,t,n){var r,s=voice_tb[e.v],i=e.st;for(e.type==BAR&&e.prev&&e.prev.type==BAR&&(e=e.prev),s.last_sym=e.prev,s.last_sym||(s.sym=null),s.time=e.time,r=sym_add(s),r.type=CLEF,r.next=e,e.prev=r,r.clef_type=t,r.clef_line=n,r.st=i,r.clef_small=!0,r.second=void 0,r.notes=[],r.notes[0]={pit:e.notes[0].pit},r.nhd=0;!e.seqst;)e=e.ts_prev;return e.ts_prev.type!=CLEF&&(r.seqst=!0),r.ts_prev=e.ts_prev,r.ts_prev.ts_next=r,r.ts_next=e,e.ts_prev=r,r}function set_float(){var e,t,n,r,s,i,a,o;for(r=0;r<voice_tb.length;r++)if(e=voice_tb[r],e.floating)for(n=!1,t=e.st,s=e.sym;s;s=s.next)if(s.type==NOTE)if(s.floating)if(s.notes[0].pit>=19)n=!1;else if(s.notes[s.nhd].pit<=12)n=!0,s.st++;else{for(a=127,i=s.ts_prev;i&&(i.st==t&&i.v!=s.v);i=i.ts_prev)i.type==NOTE&&i.notes[0].pit<a&&(a=i.notes[0].pit);if(127!=a)if(s.notes[s.nhd].pit>a-3)n=!1;else{for(o=-127,i=s.ts_next;i&&(i.st==t+1&&i.v!=s.v);i=i.ts_next)i.type==NOTE&&i.notes[i.nhd].pit>o&&(o=i.notes[i.nhd].pit);if(-127!=o)if(s.notes[0].pit<o+3)n=!0,s.st++;else{if(a-=s.notes[s.nhd].pit,o=s.notes[0].pit-o,n){if(o-3>a){n=!1;continue}}else{if(o+3>a)continue;n=!0}s.st++}else n&&s.st++}else n&&s.st++}else n=!1;else n&&s.st++}function set_graceoffs(e){var t,n,r,s,i,a,o;for(i=Number(cfmt.gracespace[0]),a=Number(cfmt.gracespace[1]),o=Number(cfmt.gracespace[2]),s=0,t=e.extra;t.type!=NOTE;t=t.next);for(t.beam_st=!0;;t=t.next)if(t.type==NOTE){for(set_head_shift(t),r=t.nhd;r>=0;r--)if(t.notes[r].acc){s+=5,t.notes[r].micro&&(s+=2);break}if(t.x=s,t.nflags<=0&&(t.beam_st=!0,t.beam_end=!0),n=t.next,!n){t.beam_end=!0;break}n.nflags<=0&&(t.beam_end=!0),t.beam_end&&(n.beam_st=!0,s+=a/4),t.nflags<=0&&(s+=a/4),t.y>n.y+8&&(s-=1.5),s+=a}else if(!t.next)break;return s+=i+o,n=e.next,n&&n.type==NOTE&&(t.y>=3*(n.notes[n.nhd].pit-18)?s-=1:t.beam_st&&t.y<3*(n.notes[0].pit-18)-7&&(s+=2)),s}function gchord_width(e,t,n){for(var r,s,i,a,o=0,c=0,l=0;l<e.a_gch.length;l++)switch(s=e.a_gch[l],s.type){default:a=-s.x,a>o&&(o=a),i=s.w+2-a,i>c&&(c=i);break;case"<":i=s.w+t,i>o&&(o=i);break;case">":i=s.w+e.wr,i>c&&(c=i)}if(r=e.prev,r&&r.a_gch)for(r=e.ts_prev;;r=r.ts_prev){if(r==e.prev){o>n&&(n=o);break}r.seqst&&(o-=r.shrink)}if(r=e.next,r&&r.a_gch)for(r=e.ts_next;;r=r.ts_next){if(r==e.next){e.wr<c&&(e.wr=c);break}r.seqst&&(c-=8)}return n}function set_width(e){var t,n,r,s,i,a,o,c;switch(e.type){case NOTE:case REST:switch(e.head){default:a=8;break;case"oval":a=6;break;case"empty":a=5;break;case"full":a=4.5}if(e.wr=a,e.xmx>0&&(e.wr+=e.xmx+4),t=e.prev)switch(t.type){case BAR:case CLEF:case KEY:case METER:a+=3}for(r=0;r<=e.nhd;r++)if(s=e.notes[r].shhd,0>s&&-s+5>a&&(a=-s+5),e.notes[r].acc){var l=e.notes[r].shac+(e.notes[r].micro?6.5:4.5);l>a&&(a=l)}if(t)switch(t.type){case BAR:case CLEF:case KEY:case METER:a-=3}if(e.a_dd&&(a+=deco_width(e)),e.beam_st&&e.beam_end&&e.stem>0&&e.nflags>0&&e.wr<e.xmx+9&&(e.wr=e.xmx+9),e.dots>0){switch(e.head){case"square":case"oval":e.xmx+=2;break;case"empty":e.xmx+=1}e.wr<e.xmx+12&&(e.wr=e.xmx+12),e.dots>=2&&(e.wr+=3.5*(e.dots-1))}if(e.trem2&&e.beam_end&&20>a&&(a=20),o=a,t)switch(t.type){case NOTE:t.stem>0&&e.stem<0&&7>o&&(o=7),(e.y>27&&t.y>27||e.y<-3&&t.y<-3)&&6>o&&(o=6),t.ti1&&14>o&&(o=14);break;case CLEF:if(t.second||t.clef_small)break;o+=8;break;case KEY:o+=4}return e.a_gch&&(o=gchord_width(e,a,o)),e.a_ly&&(o=ly_width(e,o)),void(t&&t.type==GRACE?e.wl=a-4.5:e.wl=o);case SPACE:return s=e.width/2,e.wr=s,e.a_gch&&(s=gchord_width(e,s,s)),e.a_dd&&(s+=deco_width(e)),void(e.wl=s);case BAR:if(e.norepbra)break;if(e.invisible)e.wl=e.wr=0;else{var u=e.bar_type;switch(u){case"|":i=8;break;case"|:":case":|":i=16;break;case"::":i=24;break;default:if(!u)break;for(i=5+3*u.length,n=0;n<u.length;n++)switch(u[n]){case"[":case"]":i+=3;break;case":":i+=2}}e.wl=i,e.next&&e.next.type!=METER?e.wr=8:e.wr=5}return e.a_dd&&(e.wl+=deco_width(e)),void(e.a_gch&&e.a_gch[0].text.length<4&&(e.wl=gchord_width(e,e.wl,e.wl)));case CLEF:if(e.invisible)break;return e.wl=12,void(e.wr=e.clef_small?10:12);case KEY:var f,d,p;if(e.wl=3,p=4,e.k_a_acc){f=d=e.k_a_acc.length;var h=e.k_a_acc[0].acc;for(n=1;d>n;n++)c=e.k_a_acc[n],c.pit>e.k_a_acc[n-1].pit+6||c.pit<e.k_a_acc[n-1].pit-6?f--:c.acc!=h&&(p+=3),h=c.acc}else f=e.k_sf,d=e.k_old_sf&&(cfmt.cancelkey||0==f)?e.k_old_sf:0,f*d>=0?(0>f&&(f=-f),0>d&&(d=-d),d>f&&(f=d)):(f-=d,0>f&&(f=-f),p+=3);return void(e.wr=5.5*f+p);case METER:for(i=0,n=0;n<e.a_meter.length;n++){var m=e.a_meter[n];i+="C|"==m.top?6.5:!m.bot||m.top.length>m.bot.length?6.5*m.top.length:6.5*m.bot.length}return e.wl=i,void(e.wr=i+7);case MREST:return e.wl=36,void(e.wr=36);case GRACE:return e.wl=set_graceoffs(e),void(e.wr=0);case STBRK:return e.wl=e.xmx,void(e.next&&e.next.type==CLEF?(e.wr=2,delete e.next.clef_small):e.wr=8);case FORMAT:return e.wl=6,void(e.wr=0);default:error(2,e,"set_width - Cannot set width for symbol "+e.type)}e.wl=e.wr=0}function set_space(e){var t,n,r,s,i=e.ts_prev.time,a=e.time-i;if(0==a){switch(e.type){case MREST:return e.wl+16;case NOTE:case REST:if(e.ts_prev.type==BAR)return e.nflags<-2?space_tb[0]:space_tb[2]}return 0}if(e.ts_prev.type==MREST)return e.ts_prev.wr+16+3;if(smallest_duration>=BASE_LEN/2&&(a/=smallest_duration>=BASE_LEN?4:2),n=a>=BASE_LEN/4?a<BASE_LEN/2?5:a<BASE_LEN?6:a<2*BASE_LEN?7:a<4*BASE_LEN?8:9:a>=BASE_LEN/8?4:a>=BASE_LEN/16?3:a>=BASE_LEN/32?2:a>=BASE_LEN/64?1:0,r=a-(BASE_LEN/16/8<<n),s=space_tb[n],0!=r&&(0>r?s=space_tb[0]*a/(BASE_LEN/16/8):(n>=9&&(n=8),s+=(space_tb[n+1]-space_tb[n])*r/a)),!e.dur){switch(e.type){case BAR:s*=e.bar_type.length>1?.8:.7;break;case CLEF:s-=e.wl}return s}if(e.beam_st||(s*=.9),e.type==NOTE&&e.nflags>=-1&&e.stem>0){var o=!0;for(t=e.ts_prev;t&&t.time==i;t=t.ts_prev)if(t.type==NOTE&&(t.nflags<-1||t.stem>0)){o=!1;break}if(o){for(t=e.ts_next;t&&t.time==e.time;t=t.ts_next)if(t.type==NOTE&&(t.nflags<-1||t.stem<0)){o=!1;break}o&&(s*=.9)}}return s}function set_allsymwidth(e){for(var t,n,r,s,i=0,a=tsfirst;;)if(set_width(a),i<a.wl&&(i=a.wl),a=a.ts_next,a==e||a.seqst)break;if(tsfirst.shrink=i,tsfirst.space=0,a!=e)for(;;){t=a,r=s=0;do{var o,c,l,u,f;for(set_width(t),t.type==BAR?(o=50,c=-50):(o=t.ymx,c=t.ymn),f=t.wl,i=0,n=a.ts_prev;n;n=n.ts_prev){if(!(i<n.wr)||n.type!=NOTE&&n.type!=REST||t.type!=NOTE&&t.type!=REST||(i=n.wr),n.st==t.st&&(!n.invisible||n.v==t.v)&&i<n.wr+f)switch(n.type){case NOTE:case REST:if(t.type==NOTE||t.type==REST){i=n.wr+f;break}default:if(l=n.ymx,u=n.ymn,c>l||u>o)break;case SPACE:case BAR:case CLEF:case METER:case KEY:i=n.wr+f}if(n.seqst){if(0!=i)break;if(f-=n.shrink,0>f)break}}if(i>r&&(r=i),i=set_space(t),i>s&&(s=i),(t=t.ts_next)==e)break}while(!t.seqst);if(0==r&&0==s&&a.type==CLEF&&(delete a.seqst,a.time=a.ts_prev.time),a.shrink=r,a.space=s,(a=t)==e)break}}function to_rest(e){e.type=REST,delete e.in_tuplet,delete e.sl1,delete e.sl2,delete e.a_dd,delete e.a_gch,delete e.extra,e.slur_start=e.slur_end=0}function set_repeat(e,t){var n,r,s,i,a,o,c=t.st,l=t.v;if((a=e.repeat_n)<0){for(a=-a,s=a,r=t.prev;r;r=r.prev)if(r.dur){if(--s<=0)break}else if(r.type==BAR)return error(1,r,"Bar in sequence to repeat"),void(e.fmt_type=void 0);if(!r)return error(1,t,"Not enough symbols to repeat"),void(e.fmt_type=void 0);for(s=e.repeat_k*a,n=t;n;n=n.next)if(n.dur){if(--s<=0)break}else if(n.type==BAR)return error(1,n,"Bar in repeat sequence"),void(e.fmt_type=void 0);if(!n||!n.next)return error(1,t,"Not enough symbols after repeat sequence"),void(e.fmt_type=void 0);for(n=t.prev;n!=r;n=n.prev)if(n.type==NOTE){n.beam_end=!0;break}for(r=t,i=e.repeat_k;--i>=0;){for(s=a,r.dur&&s--,n=r.ts_next;s>0;)n.st==c&&(n.v==l&&n.dur&&s--,delete n.extra,unlksym(n),n=n.ts_next);to_rest(r),r.dur=r.notes[0].dur=n.time-r.time,r.repeat_n=-1,r.beam_st=!0,set_width(r),r.seqst&&(r.space=set_space(r)),r.head="square",r=n}return void(e.fmt_type=void 0)}for(s=a,n=t.prev.prev;n&&(n.type!=BAR&&n.time!=tsfirst.time||!(--s<=0));n=n.prev);if(!n)return error(1,t,"Not enough measures to repeat"),void(e.fmt_type=void 0);for(o=t.time-n.time,s=1==a?e.repeat_k:a,n=t;n&&!(n.type==BAR&&--s<=0);n=n.next);if(!n)return error(1,t,"Not enough bars after repeat measure"),void(e.fmt_type=void 0);if(s=e.repeat_k,2==a&&s>1){if(n=n.next,!n)return error(1,t,"Not enough bars after repeat measure"),void(e.fmt_type=void 0);e.repeat_k=1,t=clone(e),t.next=n.extra,t.next&&(t.next.prev=t),delete t.prev,n.extra=t,t.repeat_k=--s}if(o/=a,2==a){for(r=t,n=t.ts_next;;n=n.ts_next)if(n.st==c){if(n.v==l&&n.type==BAR)break;delete n.extra,unlksym(n)}for(to_rest(r),r.dur=r.notes[0].dur=o,r.invisible=!0,r.seqst&&(r.space=set_space(r)),n.bar_mrep=2,n.seqst&&(n.space=set_space(n)),r=n.next,n=r.next;;){if(n.type==BAR||n.type==CLEF)break;delete n.extra,unlksym(n),n=n.next}return to_rest(r),r.dur=r.notes[0].dur=o,r.invisible=!0,set_width(r),r.seqst&&(r.space=set_space(r)),void(n.seqst&&(n.space=set_space(n)))}for(r=t,i=e.repeat_k;--i>=0;){for(n=r.ts_next;;n=n.ts_next)if(n.st==c){if(n.v==l&&n.type==BAR)break;delete n.extra,unlksym(n)}if(to_rest(r),r.dur=r.notes[0].dur=o,r.beam_st=!0,r.seqst&&(r.space=set_space(r)),n.seqst&&(n.space=set_space(n)),1==e.repeat_k){r.repeat_n=1;break}r.repeat_n=e.repeat_k-i+1,r=n.next}}function custos_add(e){for(var t,n,r,s=e;;){if(s.type==NOTE)break;if(s=s.next,!s)return}for(t=voice_tb[e.v],t.last_sym=e.prev,t.time=e.time,n=sym_add(t),n.type=CUSTOS,n.next=e,e.prev=n,n.ts_prev=e.ts_prev,n.ts_prev.ts_next=n,n.ts_next=e,e.ts_prev=n,n.seqst=!0,n.wl=8,n.wr=4,n.shrink=e.shrink,n.shrink<12&&(n.shrink=12),n.space=s.space,n.nhd=s.nhd,n.notes=[],r=0;r<e.notes.length;r++)n.notes[r]={pit:s.notes[r].pit,shhd:0,dur:BASE_LEN/4};n.stemless=!0}function set_nl(e){function t(e){if(cfmt.custos&&1==voice_tb.length)custos_add(e);else switch(r=e.ts_prev,r.type){case BAR:case FORMAT:case CLEF:case KEY:case METER:break;default:s=voice_tb[r.v],s.last_sym=r,s.time=e.time,r=r.next,o=sym_add(s),o.type=FORMAT,o.next=r,r&&(r.prev=o),o.ts_prev=o.prev,o.ts_prev.ts_next=o,o.ts_next=e,e.ts_prev=o,o.seqst=!0,o.wl=6,o.shrink=e.shrink,o.space=e.space,e.x&&(o.x=e.x)}e.nl=!0}function n(e){if(e=e.next,!e)return e;for(;!e.seqst;)e=e.ts_prev;return t(e),e}var r,s,i,a,o,c;if(e.eoln&&!cfmt.keywarn&&!cfmt.timewarn)return n(e);switch(e.type){case CLEF:case BAR:break;case KEY:if(cfmt.keywarn&&!e.k_none)break;return n(e);case METER:if(cfmt.timewarn)break;return n(e);case GRACE:if(e=e.next,!e)return e;default:return n(e)}for(;e;e=e.ts_prev)if(e.seqst){switch(e.type){case KEY:case CLEF:case METER:continue}break}for(c=0;;e=e.ts_next){if(!e)return e;if(e.new_sy&&(a=!0,e.new_sy=!1),e.seqst){if(0>c)break;switch(e.type){case BAR:c||!e.bar_num&&e.next&&":"==e.bar_type[e.bar_type.length-1]&&":"!=e.bar_type[0]?i=!0:c=1;break;case STBRK:if(!e.stbrk_forced){unlksym(e);break}c=-1;break;case METER:cfmt.timewarn||(i=!0);break;case CLEF:c&&(i=!0);break;case KEY:(!cfmt.keywarn||e.k_none)&&(i=!0);break;default:if(!c||e.prev&&e.prev.type==GRACE)break;i=!0}if(i)break;e.extra&&(o?error(2,e,"Extra symbol may be misplaced"):o=e)}}if(o&&o!=e){for(r=o.extra;r.next;)r=r.next;r.next=e.extra,e.extra=o.extra,delete o.extra}return a&&(e.new_sy=!0),t(e),e}function get_ck_width(){var e,t,n=voice_tb.length;for(e=0;n>e&&(t=voice_tb[e],!t.clef);e++);return set_width(t.clef),set_width(t.key),cfmt.singleline?(set_width(t.meter),t.clef.wl+t.clef.wr+t.key.wl+t.key.wr+t.meter.wl+t.meter.wr):t.clef.wl+t.clef.wr+t.key.wl+t.key.wr}function get_width(e,t,n){var r,s,i,a=1-cfmt.maxshrink;for(r=e;r!=t;r=r.ts_next)r.seqst&&(r.x=n,s=r.shrink,n+=(i=r.space)<s?s:s*cfmt.maxshrink+i*a);return n}function set_lines(e,t,n,r){var s,i,a,o,c,l,u,f,d;for(u=get_width(e,t,r),s=e;;){if(f=Math.ceil(u/n),1>=f)return t&&(t=set_nl(t)),t;for(i=e=s,c=s.x+u/f*cfmt.breaklimit,l=s.x+n,d=!1;s!=t;s=s.ts_next)if(o=s.x){if(o>l)break;if(s.type==BAR){if(o>c){d=!0;break}i=s}}if(s==t)return t;if(!d){var p=!i.dur||i.beam_st||i.beam_end?0:1,h=i.time;for(s=i,i=a=null,l-=6;s!=t;s=s.ts_next){if(s.beam_st){if(!s.beam_end){p++;continue}}else s.beam_end&&p--;if(o=s.x,o&&!(c>o)){if(o+o.shrink>=l)break;0==p&&(i=s,(s.time-h)%(BASE_LEN/8)==0&&(a=s))}}for(a&&(i=a),i&&(s=i);!s.x||s.x+2*s.shrink>=l;)s=s.ts_prev}if(s.nl)for(error(0,s,"Line split problem - adjust maxshrink and/or breaklimit"),f=2,s=s.ts_next;s!=t&&!(s.x&&--f<=0);s=s.ts_next);if(s=set_nl(s),!s||t&&s.time>=t.time)break;u-=s.x-e.x}return s}function cut_tune(e,t){var n,r,s,i,n=tsfirst;if(e-=get_ck_width(),cfmt.custos&&1==voice_tb.length&&(e-=12),cfmt.barsperstaff){for(s=cfmt.barsperstaff,r=n;n;n=n.ts_next)n.type==BAR&&n.bar_num&&(--s>0||(n.eoln=!0,s=cfmt.barsperstaff));n=r}for(i=t,r=n;n;n=n.ts_next)if(n.seqst||n.eoln)if(i+=n.shrink,i>e){for(;n&&!n.eoln;n=n.ts_next);if(n=r=set_lines(r,n,e,t),!n)break;i=n.shrink,t=0}else if(n.eoln){if(r=set_nl(n),delete n.eoln,n=r,!n)break;i=n.shrink,t=0}}function set_yval(e){switch(e.type){case CLEF:if(e.second||e.invisible){e.ymx=e.ymn=12;break}switch(e.y=6*(e.clef_line-1),e.clef_type){default:e.ymx=e.y+28,e.ymn=e.y-14;break;case"c":e.ymx=e.y+13,e.ymn=e.y-11;break;case"b":e.ymx=e.y+7,e.ymn=e.y-12}e.clef_small&&(e.ymx-=2,e.ymn+=2),e.ymx<26&&(e.ymx=26),e.ymn>-1&&(e.ymn=-1),e.clef_octave&&(e.clef_octave>0?e.ymx+=12:e.ymn-=12);break;case KEY:e.k_sf>2?e.ymx=34:e.k_sf>0?e.ymx=30:e.ymx=26,e.ymn=-2;break;default:e.ymx=26,e.ymn=-2}}function set_auto_clef(e,t,n){var r,s,i,a,o,c;for(i=12,s=20,r=t;r&&(!r.new_sy||r==t);r=r.ts_next)if(r.st==e)if(r.type==NOTE)r.notes[0].pit<s?s=r.notes[0].pit:r.notes[r.nhd].pit>i&&(i=r.notes[r.nhd].pit);else if(r.type==CLEF){if("a"!=r.clef_type)break;unlksym(r)}if(s>=19||s>=13&&"b"!=n)return"t";if(13>=i||19>=i&&"t"!=n)return"b";"a"==n&&(n=(i+s)/2>=16?"t":"b");var l=n,u=r,f=null;for(r=t;r!=u&&(!r.new_sy||r==t);r=r.ts_next)if(r.st==e&&r.type==NOTE){if(a=r.time,"t"==l){if(r.notes[0].pit>12||r.notes[r.nhd].pit>20){r.notes[0].pit>20&&(f=r);continue}if(o=r.ts_prev,o&&o.time==a&&o.st==e&&o.type==NOTE&&o.notes[0].pit>=19)continue;if(o=r.ts_next,o&&o.st==e&&o.time==a&&o.type==NOTE&&o.notes[0].pit>=19)continue}else{if(r.notes[0].pit<12||r.notes[r.nhd].pit<20){r.notes[r.nhd].pit<12&&(f=r);continue}if(o=r.ts_prev,o&&o.time==a&&o.st==e&&o.type==NOTE&&o.notes[0].pit<=13)continue;if(o=r.ts_next,o&&o.st==e&&o.time==a&&o.type==NOTE&&o.notes[0].pit<=13)continue}if(f){for(c=r,o=r.ts_prev;o!=f;o=o.ts_prev)if(o.st==e){if(o.type==BAR&&o.v==r.v){c=o;break}o.type==NOTE&&o.beam_st&&!voice_tb[o.v].second&&(c=o)}c.time!=f.time?(f=r,l="t"==l?"b":"t",o=insert_clef(c,l,"t"==l?2:4),o.clef_auto=!0):f=r}else l=n="t"==l?"b":"t",f=r}return n}function set_clefs(){var e,t,n,r,s,i,a,o,c=new Array(nstaff),l=cur_sy;for(staff_tb=new Array(nstaff),n=0;n<=nstaff;n++)c[n]={autoclef:!0},staff_tb[n]={output:[]};for(r=0;r<voice_tb.length;r++)s=voice_tb[r],l.voices[r].range<0||(n=l.voices[r].st,l.voices[r].second||(void 0!=s.stafflines&&(l.staves[n].stafflines=s.stafflines),s.staffscale&&(l.staves[n].staffscale=s.staffscale),l.voices[r].sep&&(l.staves[n].sep=l.voices[r].sep),l.voices[r].maxsep&&(l.staves[n].maxsep=l.voices[r].maxsep)),l.voices[r].second||s.clef.clef_auto||(c[n].autoclef=!1));for(r=0;r<voice_tb.length;r++)s=voice_tb[r],l.voices[r].range<0||l.voices[r].second||(n=l.voices[r].st,e=s.clef,c[n].autoclef&&(e.clef_type=set_auto_clef(n,tsfirst,e.clef_type),e.clef_line="t"==e.clef_type?2:4),c[n].clef=staff_tb[n].clef=e);for(e=tsfirst;e;e=e.ts_next){for(i=e.extra;i;i=i.next)if(i.type==FORMAT&&"repeat"==i.fmt_type){set_repeat(i,e);break}if(e.new_sy){for(l=l.next,n=0;n<=nstaff;n++)c[n].autoclef=!0;for(r=0;r<voice_tb.length;r++)l.voices[r].range<0||(s=voice_tb[r],n=l.voices[r].st,l.voices[r].second||(void 0!=s.stafflines&&(l.staves[n].stafflines=s.stafflines),s.staffscale&&(l.staves[n].staffscale=s.staffscale),l.voices[r].sep&&(l.staves[n].sep=l.voices[r].sep),l.voices[r].maxsep&&(l.staves[n].maxsep=l.voices[r].maxsep)),t=s.clef,t.clef_auto||(c[n].autoclef=!1));for(r=0;r<voice_tb.length;r++)if(!(l.voices[r].range<0||l.voices[r].second))if(s=voice_tb[r],n=l.voices[r].st,t=s.clef,t.clef_auto?(a=set_auto_clef(n,e,c[n].clef?c[n].clef.clef_type:"a"),o="t"==a?2:4):(a=t.clef_type,o=t.clef_line),c[n].clef){if(a!=c[n].clef.clef_type||o!=c[n].clef.clef_line){for(i=e;i.v!=r;)i=i.ts_next;i.type!=CLEF&&(i=insert_clef(i,a,o),t.clef_auto&&(i.clef_auto=!0)),c[n].clef=s.clef=i}}else t.clef_auto&&("a"!=t.type&&(s.clef=clone(s.clef)),s.clef.clef_type=a,s.clef.clef_line=o),staff_tb[n].clef=c[n].clef=s.clef}if(e.type==CLEF)if(s=voice_tb[e.v],s.clef=e,e.second)unlksym(e);else{if(n=e.st,c[n].clef){if(e.clef_type==c[n].clef.clef_type&&e.clef_line==c[n].clef.clef_line&&!e.new_sy)continue}else staff_tb[n].clef=e;c[n].clef=e}}for(l=cur_sy,r=0;r<voice_tb.length;r++)if(!(l.voices[r].range<0)&&(t=voice_tb[r].sym,t&&127==t.notes[0].pit)){switch(n=l.voices[r].st,staff_tb[n].clef.clef_type){default:pitch=22;break;case"c":pitch=16;break;case"b":pitch=10}for(e=t;e;e=e.next)e.notes[0].pit=pitch}}function set_pitch(e){var t,n,r,s,i,a,o,c=new Array(nstaff);for(r=0;r<=nstaff;r++)t=staff_tb[r].clef,c[r]=delta_tb[t.clef_type]+2*t.clef_line,t.clef_oct_transp&&(c[r]-=t.clef_octave);for(a=BASE_LEN,t=tsfirst;t!=e;t=t.ts_next)switch(r=t.st,t.type){case CLEF:c[r]=delta_tb[t.clef_type]+2*t.clef_line,t.clef_oct_transp&&(c[r]-=t.clef_octave),set_yval(t);break;case GRACE:for(n=t.extra;n;n=n.next)if(n.type==NOTE){if(s=c[n.st],0!=s&&!voice_tb[t.v].key.k_drum)for(i=0;i<=n.nhd;i++)o=n.notes[i],o.pit+=s;n.ymn=3*(n.notes[0].pit-18)-2,n.ymx=3*(n.notes[n.nhd].pit-18)+2}set_yval(t);break;case KEY:t.k_y_clef=c[r];default:set_yval(t);break;case MREST:if(t.invisible)break;t.y=12,t.ymx=39,t.ymn=-2;break;case REST:if(1==voice_tb.length){t.y=12,t.ymx=24,t.ymn=0;break}case NOTE:if(s=c[r],0!=s&&!voice_tb[t.v].key.k_drum)for(i=t.nhd;i>=0;i--)t.notes[i].pit+=s;t.type==NOTE?(t.ymx=3*(t.notes[t.nhd].pit-18)+4,t.ymn=3*(t.notes[0].pit-18)-4,t.yav=(t.ymx+t.ymn)/2):(t.y=6*Math.floor((t.notes[0].pit-18)/2),t.ymx=t.y+rest_sp[5-t.nflags][0],t.ymn=t.y-rest_sp[5-t.nflags][1]),t.dur<a&&(a=t.dur)}smallest_duration=a}function set_stem_dir(){for(var e,t,n,r,s,i,a,o,c,l=[],u=tsfirst,f=cur_sy,d=f.nstaff;u;){for(r=0;d>=r;r++)l[r]=[];for(c=[],t=u;t&&t.type!=BAR;t=t.ts_next){if(t.new_sy){if(t!=u)break;for(f=f.next,r=d;r<=f.nstaff;r++)l[r]=[];d=f.nstaff}if(!(t.type!=NOTE&&t.type!=REST||t.invisible)){if(r=t.st,r>d){var p="*** fatal set_stem_dir(): bad staff number "+r+" max "+d;throw error(2,null,p),new Error(p)}for(i=t.v,v_st=c[i],v_st||(v_st={st1:-1,st2:-1},c[i]=v_st),v_st.st1<0?v_st.st1=r:v_st.st1!=r&&(r>v_st.st1?r>v_st.st2&&(v_st.st2=r):(v_st.st1>v_st.st2&&(v_st.st2=v_st.st1),v_st.st1=r)),a=l[r],s=f.voices[i].range,n=a.length;--n>=0&&(o=a[n],o.v!=s););if(0>n){for(o={v:s,ymx:0,ymn:24},n=0;n<a.length;n++)if(s<a[n].v){a.splice(n,0,o);break}n==a.length&&a.push(o)}t.type==NOTE&&(t.ymx>o.ymx&&(o.ymx=t.ymx),t.ymn<o.ymn&&(o.ymn=t.ymn),t.xstem&&(t.ts_prev.st!=r-1||t.ts_prev.type!=NOTE?(error(1,u,"Bad +xstem+"),delete t.xstem):(t.ts_prev.multi=1,t.multi=1,t.stemless=!0)))}}for(;u!=t;u=u.ts_next)if(!u.multi&&(u.type==NOTE||u.type==REST||u.type==GRACE))if(r=u.st,i=u.v,v_st=c[i],a=l[r],v_st&&v_st.st2>=0)r==v_st.st1?u.multi=-1:r==v_st.st2&&(u.multi=1);else if(a.length<=1)u.floating&&(r==voice_tb[i].st?u.multi=-1:u.multi=1);else{for(s=f.voices[i].range,n=a.length;--n>=0&&a[n].v!=s;);0>n||(n==a.length-1?u.multi=-1:(u.multi=1,0!=n&&n+2==a.length&&(a[n].ymn-cfmt.stemheight>a[n+1].ymx&&(u.multi=-1),e=u.ts_next,u.ts_prev&&u.ts_prev.time==u.time&&u.ts_prev.st==u.st&&u.notes[u.nhd].pit==u.ts_prev.notes[0].pit&&u.beam_st&&u.beam_end&&(!e||e.st!=u.st||e.time!=u.time)&&(u.multi=-1))))}for(;u&&u.type==BAR;)u.new_sy&&(f=f.next,d=f.nstaff),u=u.ts_next}}function set_rest_offset(){var e,t,n,r,s,i,a,o,c,l,u,f=[],d=cur_sy;for(e=tsfirst;e;e=e.ts_next)if(!e.invisible){switch(e.new_sy&&(d=d.next),e.type){default:continue;case NOTE:case REST:}if(i=f[e.v],i||(i={},f[e.v]=i),i.s=e,i.st=e.st,i.end_time=e.time+e.dur,e.type==REST){for(o=-127,a=127,s=l=!1,n=0;n<=f.length;n++)i=f[n],i&&i.s&&i.st==e.st&&n!=e.v&&(i.end_time<=e.time||(s=!0,t=i.s,d.voices[n].range<d.voices[e.v].range?t.ymn<a&&(t.time==e.time?(a=t.ymn,t.dots&&(l=!0)):a=(t.ymx+t.ymn)/2):t.ymx>o&&(t.time==e.time?(o=t.ymx,t.dots&&(l=!0)):o=(t.ymx+t.ymn)/2)));for(r=e.time+e.dur,t=e.ts_next;t&&!(t.time>=r);t=t.ts_next)t.st!=e.st||t.type!=NOTE&&t.type!=REST||t.invisible||(s=!0,d.voices[t.v].range<d.voices[e.v].range?t.ymn<a&&(t.time==e.time?(a=t.ymn,t.dots&&(l=!0)):a=(t.ymx+t.ymn)/2):t.ymx>o&&(t.time==e.time?(o=t.ymx,t.dots&&(l=!0)):o=(t.ymx+t.ymn)/2));if(c=a-e.ymx,0>c){if(c=6*Math.ceil(-c/6),e.ymn-c>=o){e.y-=c,e.ymx-=c,e.ymn-=c;continue}u=l?15:10,e.notes[0].shhd=u,e.xmx=u}else if(c=o-e.ymn,c>0){if(c=6*Math.ceil(c/6),e.ymx+c<=a){e.y+=c,e.ymx+=c,e.ymn+=c;continue}u=l?15:10,e.notes[0].shhd=u,e.xmx=u}else s||(e.y=12,e.ymx=24,e.ymn=0)}}}function new_sym(e,t,n){return s={type:e,ctx:n.ctx,v:t.v,st:t.st,time:n.time,next:t.last_sym.next},s.next&&(s.next.prev=s),t.last_sym.next=s,s.prev=t.last_sym,t.last_sym=s,s.ts_next=n,s.ts_prev=n.ts_prev,s.ts_prev.ts_next=s,s.ts_prev.type!=e&&(s.seqst=!0),n.ts_prev=s,n.type==e&&s.v!=n.v&&(delete n.seqst,n.shrink=0),s}function init_music_line(){var e,t,n,r,s,i=voice_tb.length;for(r=0;i>r;r++)if(e=voice_tb[r],!(cur_sy.voices[r].range<0)){for(e.second=cur_sy.voices[r].second,s=cur_sy.voices[r].st;s<nstaff&&cur_sy.staves[s].empty;)s++;e.st=s}for(n=tsfirst,t=n.extra;t;t=t.next)if(t.type==BLOCK)switch(t.subtype){case"center":write_text(t.text,"c");break;case"sep":vskip(t.sk1),output.push('<path class="stroke"\n	d="M'),out_sxsy(t.x," ",0),output.push("h"+t.l.toFixed(2)+'"/>\n'),vskip(t.sk2),blk_out();break;case"ml":svg_flush(),user.img_out(t.text);break;case"text":write_text(t.text,t.opt);break;case"title":write_title(t.text,!0);break;case"vskip":vskip(t.sk),blk_out()}for(;n.type==CLEF;)r=n.v,e=voice_tb[r],cur_sy.voices[r].range>=0&&!cur_sy.voices[r].second&&(delete n.clef_small,e.last_sym=e.sym=n),n=n.ts_next;for(r=0;i>r;r++)e=voice_tb[r],e.sym&&e.sym.type==CLEF||cur_sy.voices[r].range<0||cur_sy.voices[r].second&&!e.bar_start||(s=cur_sy.voices[r].st,staff_tb[s]&&staff_tb[s].clef&&(t=clone(staff_tb[s].clef),t.v=r,t.st=s,t.time=n.time,t.prev=null,t.next=e.sym,t.next&&(t.next.prev=t),e.sym=t,e.last_sym=t,t.ts_next=n,t.ts_prev=n.ts_prev,t.ts_prev?(t.ts_prev.ts_next=t,delete t.seqst):(tsfirst=t,t.seqst=!0),n.ts_prev=t,n.type==CLEF&&delete n.seqst,delete t.clef_small,t.second=cur_sy.voices[r].second,cur_sy.staves[s].empty&&(t.invisible=!0)));for(r=0;i>r;r++)cur_sy.voices[r].range<0||cur_sy.voices[r].second||cur_sy.staves[cur_sy.voices[r].st].empty||(e=voice_tb[r],n.v!=r||n.type!=KEY?(e.key.k_sf||e.key.k_a_acc)&&(t=new_sym(KEY,e,n),t.k_sf=e.key.k_sf,t.k_old_sf=e.key.k_sf,t.k_a_acc=e.key.k_a_acc,t.istart=e.key.istart,t.iend=e.key.iend,e.key.k_bagpipe&&(t.k_bagpipe=e.key.k_bagpipe,"p"==t.k_bagpipe&&(t.k_old_sf=3))):(e.last_sym=n,n=n.ts_next));if(1&insert_meter)for(r=0;i>r;r++)e=voice_tb[r],cur_sy.voices[r].range<0||cur_sy.voices[r].second||cur_sy.staves[cur_sy.voices[r].st].empty||0==e.meter.a_meter.length||(n.v!=r||n.type!=METER?(t=new_sym(METER,e,n),
t.istart=e.meter.istart,t.iend=e.meter.iend,t.wmeasure=e.meter.wmeasure,t.a_meter=e.meter.a_meter):(e.last_sym=n,n=n.ts_next));for(r=0;i>r;r++)e=voice_tb[r],!e.bar_start||cur_sy.voices[r].range<0||cur_sy.staves[cur_sy.voices[r].st].empty||(t=new_sym(BAR,e,n),t.istart=e.bar_start.istart,t.iend=e.bar_start.iend,t.bar_type=e.bar_start.bar_type,e.bar_start.invisible&&(t.invisible=!0),e.bar_start.norepbra&&(t.norepbra=!0),t.text=e.bar_start.text,t.a_gch=e.bar_start.a_gch,e.bar_start.rbstart&&(t.rbstart=e.bar_start.rbstart),delete e.bar_start);if(set_pitch(n),t=n)for(;t&&!t.seqst;t=t.ts_next);if(t)for(t=t.ts_next;t&&!t.seqst;t=t.ts_next);set_allsymwidth(t)}function set_words(e){var t,n,r,s,i;for(t=e.sym;t;t=t.next)if(t.type==NOTE){n=t.notes[0].pit;break}for(t||(n=127),r=!0,t=e.sym;t;t=t.next){switch(t.type){case MREST:r=!0;break;case BAR:t.beam_on||(r=!0),!t.next&&t.prev&&t.prev.type==NOTE&&t.prev.dur>=2*BASE_LEN&&(t.prev.head="square");break;case NOTE:case REST:if(t.trem2)break;s=t.nflags,t.ntrem&&(s+=t.ntrem),t.type==REST&&t.beam_end&&(t.beam_end=!1,r=!0),(r||0>=s)&&(i&&(i.beam_end=!0,i=null),0>=s?(t.beam_st=!0,t.beam_end=!0):t.type==NOTE&&(t.beam_st=!0,r=!1)),t.beam_end&&(r=!0),t.type==NOTE&&(i=t)}t.type==NOTE?(0!=t.nhd&&sort_pitch(t),n=t.notes[0].pit,t.prev&&t.prev.type!=NOTE&&(t.prev.notes[0].pit=(t.prev.notes[0].pit+n)/2)):(t.notes||(t.notes=[],t.notes[0]={},t.nhd=0),t.notes[0].pit=n)}i&&(i.beam_end=!0)}function set_rb(e){for(var t,n,r,s=e.sym;s;)if(s.type==BAR&&s.rbstart){if(n=cfmt.rbmax,s.text&&"1"==s.text[0]){for(r=0,t=null,s=s.next;s;s=s.next)if(s.type==BAR){if(r++,s.rbstop){r<=cfmt.rbmax&&(n=r,t=null);break}r==cfmt.rbmin&&(t=s)}t&&(t.rbstop=1,n=cfmt.rbmin)}for(;s;){if(2!=s.rbstart){if(s=s.next,!s)break;if(2!=s.rbstart){if(s=s.next,!s)break;if(2!=s.rbstart)break}}for(r=0,t=null,s=s.next;s;s=s.next)if(s.type==BAR){if(r++,s.rbstop)break;r==n&&(s.rbstop=1)}}}else s=s.next}function set_global(){var e,t,n,r,s=cur_sy;for(t=s.nstaff;;){if(s=s.next,!s)break;s.nstaff>t&&(t=s.nstaff)}for(nstaff=t,r=voice_tb.length,n=0;r>n;n++)e=voice_tb[n],set_words(e),e.second||e.norepbra||set_rb(e);set_float(),set_clefs(),set_pitch(null)}function set_indent(){var e,t,n,r,s,i,a,o,c=voice_tb.length,l=0;for(t=0;c>t;t++)if(r=voice_tb[t],!(cur_sy.voices[t].range<0)&&(e=cur_sy.voices[t].st,!cur_sy.staves[e].empty&&(s=r.new_name?r.nm:r.snm)))for(o||(o=get_font("voice"),gene.curfont=gene.deffont=o),i=0;;){if(a=s.indexOf("\\n",i),n=strw(0>a?s.slice(i):s.slice(i,a)),n>l&&(l=n),0>a)break;i=a+1}if(0!=l){for(n=0,e=0;e<=cur_sy.nstaff;e++){if(cur_sy.staves[e].flags&(OPEN_BRACE2|OPEN_BRACKET2)){n=20;break}cur_sy.staves[e].flags&(OPEN_BRACE|OPEN_BRACKET)&&0==n&&(n=10)}l+=4*cwid(" ")*o.swfac+n}return 2&insert_meter&&(l+=cfmt.indent),l}function set_beams(e){var t,n,r,s,i,a,o=-1,c=0;for(t=e;t;t=t.next)if(t.type==NOTE){if(t.stem||0!=(t.stem=t.multi))t.beam_st&&!t.beam_end&&(s=!0);else if(s)t.stem=o;else if(t.beam_st&&!t.beam_end){var l=t.yav,u=12;for(n=t.next;n;n=n.next){if(n.type==NOTE){if(n.multi){l=u-n.multi;break}l+=n.yav,u+=12}if(n.beam_end)break}u>l?o=1:(l>u||cfmt.bstemdown)&&(o=-1),s=!0,t.stem=o}else if(t.stem=t.yav>=12?-1:1,12==t.yav&&!cfmt.bstemdown)if(t.prev&&t.prev.type!=BAR)a=t.yav-c,a>-7&&7>a&&(t.stem=o);else{for(n=t.next;n&&(n.type!=NOTE&&n.type!=BAR);n=n.next);n&&n.type==NOTE&&n.yav<12&&(t.stem=1)}if(t.beam_end&&(s=!1),o=t.stem,c=t.yav,i){for(r=i.extra;r;r=r.next)r.stem=-o;i.stem=-o,i=null}}else{if(t.type!=GRACE)continue;for(r=t.extra;r.type!=NOTE;)r=r.next;if(2==r.stem){i=t;continue}for(t.stem||0!=(t.stem=t.multi)||(t.stem=1);r;r=r.next)r.stem=t.stem,r.multi=t.multi}}function same_head(e,t){var n,r,s,i,a,o,c,l,u,f,d;if(e.shiftunison&&e.shiftunison>=3)return!1;if((s=e.dur)>=BASE_LEN)return!1;if((i=t.dur)>=BASE_LEN)return!1;if(e.stemless&&t.stemless)return!1;if(e.dots!=t.dots&&(e.shiftunison&&1&e.shiftunison||e.dots*t.dots!=0))return!1;if(e.stem*t.stem>0)return!1;if(n=r=0,e.notes[0].pit>t.notes[0].pit){if(e.stem<0)return!1;for(;t.notes[r].pit!=e.notes[0].pit;)if(++r>t.nhd)return!1}else if(e.notes[0].pit<t.notes[0].pit){if(t.stem<0)return!1;for(;t.notes[0].pit!=e.notes[n].pit;)if(++n>e.nhd)return!1}if(t.notes[r].acc!=e.notes[n].acc)return!1;o=n,l=r,f=e.notes[n].shhd,d=t.notes[r].shhd;do{if(n++,r++,n>e.nhd)break;if(r>t.nhd)break;if(t.notes[r].acc!=e.notes[n].acc)return!1;f<e.notes[n].shhd&&(f=e.notes[n].shhd),d<t.notes[r].shhd&&(d=t.notes[r].shhd)}while(t.notes[r].pit==e.notes[n].pit);if(n<=e.nhd){if(r<=t.nhd)return!1;if(t.stem>0)return!1}else if(r<=t.nhd&&e.stem>0)return!1;if(c=n,u=r,a=0,s!=i)if(i>s&&(s=i,i=e.dur),s<BASE_LEN/2)t.dots>0?a=2:e.dots>0&&(a=1);else{if(!(i<BASE_LEN/4))return!1;if(e.shiftunison&&2&e.shiftunison)return!1;a=t.dur>=BASE_LEN/2?2:1}if(0==a&&(a=voice_tb[e.v].scale<voice_tb[t.v].scale?2:1),1==a){for(t.nohdi1=l,t.nohdi2=u,r=l;u>r;r++)delete t.notes[r].acc;for(r=0;r<=t.nhd;r++)t.notes[r].shhd+=f}else{for(e.nohdi1=o,e.nohdi2=c,n=o;c>n;n++)delete e.notes[n].acc;for(n=0;n<=e.nhd;n++)e.notes[n].shhd+=d}return!0}function unison_acc(e,t,n,r){var s,i;if(t.notes[r].acc){for(i=2*w_note[e.head]+e.xmx+t.notes[r].shac+2,t.notes[r].micro&&(i+=2),e.dots&&(i+=6),s=0;s<=t.nhd;s++)t.notes[s].shhd+=i,t.notes[s].shac-=i;t.xmx+=i}else{for(i=2*w_note[t.head]+t.xmx+e.notes[n].shac+2,e.notes[n].micro&&(i+=2),t.dots&&(i+=6),s=0;s<=e.nhd;s++)e.notes[s].shhd+=i,e.notes[s].shac-=i;e.xmx+=i}}function set_left(e,t){var n,r,s,i,a,o=w_note[e.head];for(r=0;MAXPIT>r;r++)t[r]=-100;for(i=o,e.stem>0?(i=-i,r=2*e.notes[0].pit,s=2*(Math.ceil((e.ymx-2)/3)+18)):(r=2*(Math.ceil((e.ymn+2)/3)+18),s=2*e.notes[e.nhd].pit),0>r&&(r=0);MAXPIT>r&&s>=r;r++)t[r]=i;for(a=e.notes[e.stem>0?0:e.nhd].shhd,n=0;n<=e.nhd;n++)i=-e.notes[n].shhd+o+a,r=2*e.notes[n].pit,0>r?r=0:r>=95&&(r=94),i>t[r]&&(t[r]=i),"square"!=e.head&&(i-=1),i>t[r-1]&&(t[r-1]=i),i>t[r+1]&&(t[r+1]=i)}function set_right(e,t){var n,r,s,i,a,o,c,l=w_note[e.head];for(r=0;MAXPIT>r;r++)t[r]=-100;for(a=e.nflags>0&&e.beam_st&&e.beam_end,o=l,e.stem<0?(o=-o,r=2*(Math.ceil((e.ymn+2)/3)+18),s=2*e.notes[e.nhd].pit,i=r+4):(r=2*e.notes[0].pit,s=2*(Math.ceil((e.ymx-2)/3)+18)),0>r&&(r=0);MAXPIT>r&&s>r;r++)t[r]=o;if(a)if(e.stem>0)for(r=0==e.xmx?2*e.notes[e.nhd].pit:2*e.notes[0].pit,r+=4,0>r&&(r=0);MAXPIT>r&&s-4>=r;r++)t[r]=11;else for(r=i,0>r&&(r=0);MAXPIT>r&&r<=2*e.notes[0].pit-4;r++)t[r]=3.5;for(c=e.notes[e.stem>0?0:e.nhd].shhd,n=0;n<=e.nhd;n++)o=e.notes[n].shhd+l-c,r=2*e.notes[n].pit,0>r?r=0:r>=95&&(r=94),o>t[r]&&(t[r]=o),"square"!=e.head&&(o-=1),o>t[r-1]&&(t[r-1]=o),o>t[r+1]&&(t[r+1]=o)}function set_overlap(){function e(){n=r,r=t,f=d,v=g,_=y,h=p}var t,n,r,s,i,a,o,c,l,u,f,d,p,h,m,v,_,g=[],y=[],b=[],x=[];for(t=tsfirst;t;t=t.ts_next)if(t.type==NOTE&&!t.invisible){if(t.xstem&&t.ts_prev.stem<0){for(r=t.ts_prev,o=0;o<=r.nhd;o++)r.notes[o].shhd+=7,r.notes[o].shac-=7;r.xmx+=7}for(r=t;r=r.ts_next,r;){if(r.time!=t.time){r=null;break}if(r.type==NOTE&&!r.invisible&&r.st==t.st)break}if(r&&(n=t,cur_sy.voices[n.v].range<cur_sy.voices[r.v].range?r.dot_low=!0:n.dot_low=!0,!(n.ymn>r.ymx||n.ymx<r.ymn||same_head(n,r)))){for(set_right(n,y),set_left(r,b),f=-10,s=0;MAXPIT>s;s++)b[s]+y[s]>f&&(f=b[s]+y[s]);if(!(-3>f&&(!n.dots||!r.dots||!r.dot_low||n.stem>0||r.stem<0||n.notes[n.nhd].pit+2!=r.notes[0].pit||1&r.notes[0].pit))){for(set_right(r,x),set_left(n,g),d=p=h=-100,s=0;MAXPIT>s;s++)g[s]+x[s]>d&&(d=g[s]+x[s]),x[s]>h&&(h=x[s]),y[s]>p&&(p=y[s]);for(l=0,i=n.nhd,a=r.nhd;;){switch(u=n.notes[i].pit-r.notes[a].pit){case 0:if(n.notes[i].acc!=r.notes[a].acc){l=-1;break}r.notes[a].acc&&(r.notes[a].acc=0),n.dots&&r.dots&&1&n.notes[i].pit&&(l=1);break;case-1:n.dots&&r.dots&&(1&n.notes[i].pit?(n.dot_low=!1,r.dot_low=!1):(n.dot_low=!0,r.dot_low=!0));break;case-2:if(n.dots&&r.dots&&!(1&n.notes[i].pit)){n.dot_low=!1,r.dot_low=!1;break}}if(0>l)break;if(u>=0&&--i<0)break;if(0>=u&&--a<0)break}if(0>l)unison_acc(n,r,i,a);else{if(c=0,n.dots?r.dots&&(l||(c=1)):r.dots&&f+h>d+p&&(c=1),v=b,_=x,f+h>d+p&&e(),f+=3,0>f&&(f=0),o=n.stem>=0?0:n.nhd,f+=n.notes[o].shhd,o=r.stem>=0?0:r.nhd,f-=r.notes[o].shhd,n.dots)if(m=7.7+n.xmx+3.5*n.dots-3.5+3,c){if(m<f+h+r.xmx){for(d=0,i=0;i<=n.nhd;i++)s=n.notes[i].pit,1&s||(n.dot_low?s--:s++),s*=2,1>s?s=1:s>=95&&(s=94),_[s]>d&&(d=_[s]),_[s-1]+1>d&&(d=_[s-1]=1),_[s+1]+1>d&&(d=_[s+1]+1);d>4.5&&7.7+n.xmx+2<f+d+r.xmx&&(r.xmx=d+3-7.7)}}else{for(d=-100,i=0;i<=n.nhd;i++)s=n.notes[i].pit,1&s||(n.dot_low?s--:s++),s*=2,1>s?s=1:s>=95&&(s=94),v[s]>d&&(d=v[s]),v[s-1]+1>d&&(d=v[s-1]+1),v[s+1]+1>d&&(d=v[s+1]+1);m+d+2>f&&(f=m+d+2)}for(o=r.nhd;o>=0;o--)r.notes[o].shhd+=f;r.xmx+=f,c&&(n.xmx=r.xmx)}}}}}function set_stems(){var e,t,n,r,s,i,a,o,c,l;for(e=tsfirst;e;e=e.ts_next)if(e.type==NOTE){if(set_head_shift(e),o=e.nflags,e.beam_st&&!e.beam_end){for(e.feathered_beam&&(o=++e.nflags),t=e.next;t.type!=NOTE||(e.feathered_beam&&t.nflags++,!t.beam_end);t=t.next);t.nflags>o&&(o=t.nflags)}else if(!e.beam_st&&e.beam_end){for(t=e.prev;!t.beam_st;t=t.prev);t.nflags>o&&(o=t.nflags)}switch(r=cfmt.stemheight,o){case 2:r+=2;break;case 3:r+=5;break;case 4:r+=10;break;case 5:r+=16}1!=(s=voice_tb[e.v].scale)&&(r*=.5*(s+1)),i=3*(e.notes[0].pit-18),e.nhd>0?(r-=2,a=3*(e.notes[e.nhd].pit-18)):a=i,e.ntrem&&(r+=2*e.ntrem),e.stemless?(e.stem>=0?(e.y=i,e.ys=a):(e.ys=i,e.y=a),-4==o&&(i-=6),e.ymx=a+4,e.ymn=i-4):e.stem>=0?(o>=2&&(r-=1),e.notes[e.nhd].pit>26&&(0>=o||!e.beam_st||!e.beam_end)&&(r-=2,e.notes[e.nhd].pit>28&&(r-=2)),e.y=i,e.notes[0].ti1&&(i-=3),e.ymn=i-4,e.ys=a+r,e.ys<12&&(e.ys=12),e.ymx=e.ys+2.5):(e.notes[0].pit<18&&(0>=o||!e.beam_st||!e.beam_end)&&(r-=2,e.notes[0].pit<16&&(r-=2)),e.ys=i-r,e.ys>12&&(e.ys=12),e.ymn=e.ys-2.5,e.y=a,e.notes[e.nhd].ti1&&(a+=3),e.ymx=a+4)}else{if(e.type!=GRACE)continue;for(c=l=12,n=e.extra;n;n=n.next)n.type==NOTE&&(r=GSTEM,n.nflags>1&&(r+=1.2*(n.nflags-1)),i=3*(n.notes[0].pit-18),a=3*(n.notes[n.nhd].pit-18),e.stem>=0?(n.y=i,n.ys=a+r,a=Math.round(n.ys)):(n.y=a,n.ys=i-r,i=Math.round(n.ys)),a+=2,i-=2,c>i?c=i:a>l&&(l=a),n.ymx=a,n.ymn=i);e.ymx=l,e.ymn=c}}function check_bar(e){for(var t,n,r=voice_tb[e.v];e.type==CLEF||e.type==KEY||e.type==METER;)if(e.type==METER&&e.time>r.sym.time&&(insert_meter|=1),e=e.prev,!e)return;if(e.type==BAR&&(void 0!=e.text&&(r.bar_start=clone(e),r.bar_start.bar_type="[",delete e.text,delete e.a_gch),t=e.bar_type,":"!=t&&":"==t[t.length-1])){if(r.bar_start||(r.bar_start=clone(e)),":"!=t[0])return r.bar_start.bar_type=t,void(e.prev&&e.prev.type==BAR?unlksym(e):e.bar_type="|");if("::"==t)return r.bar_start.bar_type="|:",void(e.bar_type=":|");for(n=0;":"==t[n];)n++;if(n<t.length){for(e.bar_type=t.slice(0,n)+"|",n=t.length-1;":"==t[n];)n--;r.bar_start.bar_type="|"+t.slice(n+1)}else n=Math.floor(t.length/2),e.bar_type=t.slice(0,n)+"|",r.bar_start.bar_type="|"+t.slice(n)}}function sym_staff_move(e,t,n){for(;;)if(t.st==e&&t.type!=CLEF&&(t.st++,t.invisible=!0),t=t.ts_next,t==tsnext||t.new_sy)break}function set_piece(){function e(e){var t=staff_tb[e],n=l.staves[e];t||(t=staff_tb[e]={}),t.y=0,t.stafflines=n.stafflines,t.staffscale=n.staffscale,c[e]=!0}function t(e){var t,n,r,s=e.staves.length;for(t=0;s>t;t++)if(e.staves[t].flags&(OPEN_BRACE|OPEN_BRACE2)){for(r=0,n=t;s>t&&(r|=e.staves[t].empty?1:2,!(e.staves[t].flags&(CLOSE_BRACE|CLOSE_BRACE2)));)t++;if(3==r)for(;t>=n;)e.staves[n++].empty=!1}}function n(){var e,t,n,r;for(e=0;e<=nstaff;e++)if(t=staff_tb[e],c[e])t.botbar=t.topbar=0;else{for(r=t.stafflines.length,t.topbar=6*(r-1),n=0;r-1>n&&"."==t.stafflines[n];n++);t.botline=t.botbar=6*n,n>=r-2&&(t.botbar-=6,t.topbar+=6)}}var r,s,i,a,o,c=[],l=cur_sy;for(nstaff=a=l.nstaff,s=0;a>=s;s++)e(s);for(r=tsfirst;r&&!r.nl;r=r.ts_next){if(r.new_sy){for(s=0;s<=nstaff;s++)l.staves[s].empty=c[s],c[s]=!0;for(t(l);a>=s;s++)l.staves[s].empty=!0;for(l=l.next,a=l.nstaff,a>nstaff&&(nstaff=a);a>=s;s++)e(s)}if(r.st>nstaff)unlksym(r);else if(c[r.st])switch(r.type){case GRACE:c[r.st]=!1;break;case NOTE:case REST:case SPACE:case MREST:cfmt.staffnonote>1?c[r.st]=!1:r.invisible||(0!=cfmt.staffnonote||r.type==NOTE)&&(c[r.st]=!1)}}for(tsnext=r,s=0;s<=nstaff;s++)l.staves[s].empty=c[s];for(t(l),n(),l=cur_sy,s=0;s<nstaff;s++)l.staves[s].empty&&sym_staff_move(s,tsfirst,l);if(l.next)for(r=tsfirst;r&&!r.nl;r=r.ts_next)if(r.new_sy){for(l=l.next,s=0;s<l.nstaff;s++)l.staves[s].empty&&sym_staff_move(s,r,l);if(!l.next)break}if(c[nstaff]&&(staff_tb[nstaff].topbar=0),init_music_line(),c[nstaff]||(insert_meter&=-2),tsnext)for(r=tsnext,r.nl=!1,r=r.ts_prev,r.ts_next=null,o=voice_tb.length,i=0;o>i;i++){if(voice_tb[i].sym&&voice_tb[i].sym.time<=tsnext.time){for(r=tsnext.ts_prev;r;r=r.ts_prev)if(r.v==i){voice_tb[i].s_next=r.next,r.next=null,check_bar(r);break}if(r)continue}voice_tb[i].s_next=voice_tb[i].sym,voice_tb[i].sym=null}}function set_sym_glue(e){for(var t,n,r,s,i,a,o,c,l=tsfirst,u=0,f=0,d=0;;){if(l.type==GRACE&&(c=!0),l.seqst&&(t=l.space,u+=l.shrink,t<l.shrink&&(t=l.shrink),f+=t),!l.ts_next)break;l=l.ts_next}for(d=f,cfmt.stretchstaff&&(d*=1.8),n=1,tsnext?f>=e?beta_last=0:(beta_last=(e-f)/(d-f),beta_last>n&&(cfmt.stretchstaff?cfmt.linewarn&&error(0,l,"Line underfull ("+(n*d+(1-n)*f).toFixed(2)+"pt of "+e.toFixed(2)+"pt)"):(e=f,beta_last=0))):e>f&&(s=(e-f)/(d-f),s>=beta_last&&(s=beta_last*d+(1-beta_last)*f,s<e*(1-cfmt.stretchlast)&&(e=s))),o=e/f,f=d=0,l=tsfirst;;){if(l.seqst&&(t=l.shrink,0!=l.space&&(t<l.space*o&&(t=l.space*o),d+=l.space*o*1.8),f+=t,d+=t,l.x=f,l.xmax=d),!l.ts_next)break;l=l.ts_next}switch(l.type){case BAR:break;case FORMAT:break;case CUSTOS:f+=l.wr,u+=l.wr,d+=l.wr;break;default:for(i=l.wr;!l.seqst;)l=l.ts_prev,l.wr>i&&(i=l.wr);u+=i+3,tsnext&&.8*tsnext.space>l.wr+4?(f+=.8*tsnext.space*o,d+=.8*tsnext.space*o*1.8):(f+=i+4,d+=i+4)}if(f>=e?(s=0,f==u?r=1:(r=(f-e)/(f-u),r>1&&error(0,l,"Line too much shrunk "+u.toFixed(2)+" "+f.toFixed(2)+" "+e.toFixed(2))),realwidth=u*r+f*(1-r)):(r=0,s=d>f?(e-f)/(d-f):1,s>n&&(cfmt.stretchstaff||(s=0)),realwidth=d*s+f*(1-s)),l=tsfirst,0!=r)if(1>r)for(f=u=0;l;l=l.ts_next)l.seqst&&(u+=l.shrink*r,f=u+l.x*(1-r)),l.x=f;else for(r=realwidth/f,f=0;l;l=l.ts_next)l.seqst&&(f=l.x*r),l.x=f;else for(f=0;l;l=l.ts_next)l.seqst&&(f=l.xmax*s+l.x*(1-s)),l.x=f;if(c)for(l=tsfirst;l;l=l.ts_next)if(l.type==GRACE)for(f=l.x-l.wl+Number(cfmt.gracespace[0]),a=l.extra;a;a=a.next)a.type==NOTE&&(a.x+=f)}function new_music_line(){var e,t,n,r=voice_tb.length;for(n=0;r>n;n++)e=voice_tb[n],t=e.s_next,e.sym=t,t&&(t.prev=null)}function gen_init(){for(var e=tsfirst;e;e=e.ts_next){switch(e.new_sy&&(e.new_sy=!1,cur_sy=cur_sy.next),e.type){case CLEF:case KEY:case METER:continue;case FORMAT:if(!e.extra&&(unlksym(e),!tsfirst))return}return}tsfirst=null}function output_music(){var e,t,n,r,s;if(user.get_abcmodel&&user.get_abcmodel(tsfirst,voice_tb,anno_type,info),user.img_out&&(gen_init(),tsfirst)){for(set_global(),voice_tb.length>1&&(combine_voices(),set_stem_dir()),t=0;t<voice_tb.length;t++)set_beams(voice_tb[t].sym);for(set_stems(),voice_tb.length>1&&(set_rest_offset(),set_overlap()),set_acc_shft(),set_allsymwidth(null),r=set_indent(),cfmt.singleline?(n=get_ck_width()+get_width(tsfirst,null,r),cfmt.pagewidth=(n+cfmt.leftmargin+cfmt.rightmargin)*cfmt.scale):(n=(cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/cfmt.scale,50>n&&(error(1,null,"Bad page width "+n),n=10*CM),cut_tune(n,r)),beta_last=0;;){if(set_piece(),r=set_indent(),set_sym_glue(n-r),0!=r&&(posx+=r),e=output,output=void 0,draw_sym_near(),output=e,s=set_staff(),delayed_update(),draw_systems(r),draw_all_sym(),draw_all_deco(),set_sscale(-1),vskip(s),0!=r&&(posx-=r,insert_meter&=-3),tsfirst=tsnext,!tsnext)break;if(gen_init(),!tsfirst)break;blk_out(),tsfirst.ts_prev=null,new_music_line()}}}function reset_gen(){insert_meter=cfmt.writefields.indexOf("M")>=0?3:2}function new_clef(e){var t={type:CLEF,ctx:parse.ctx,istart:parse.istart,iend:parse.iend,clef_line:2,clef_type:"t"},n=1;switch(e[0]){case'"':n=e.indexOf('"'),t.clef_name=e.slice(1,n),n++;break;case"a":if("u"==e[1]){t.clef_type="a",t.clef_auto=!0,n=4;break}n=4;case"C":t.clef_type="c",t.clef_line=3;break;case"b":n=4;case"F":t.clef_type="b",t.clef_line=4;break;case"n":n=4,t.invisible=!0;break;case"t":if("e"==e[1]){t.clef_type="c",t.clef_line=4;break}n=6;case"G":break;case"p":n=4;case"P":t.clef_type="p",t.clef_line=3;break;default:return parse.line.error("unknown clef '"+e+"'"),void delete t}if(e[n]>="1"&&e[n]<="9"&&(t.clef_line=Number(e[n]),n++),"8"!=e[n+1])return t;switch(e[n]){case"^":t.clef_oct_transp=!0;case"+":t.clef_octave=7;break;case"_":t.clef_oct_transp=!0;case"-":t.clef_octave=-7;break;default:return t}return t}function get_transp(e){var t,n,r,s=[];if("0"==e[0])return 0;if("123456789-+".indexOf(e[0])>=0){if(t=3*parseInt(e),isNaN(t)||-108>t||t>108)return void parse.line.error("Bad %%transpose value");switch(e[e.length-1]){default:return t;case"#":t++;break;case"b":t+=2}return t>0?t:t-3}for(n=new scanBuf,n.buffer=e,n.index=0,n.ctx=parse.ctx,i=0;i<2;i++){if(r=parse_acc_pit(n),!r)return void parse.line.error("Bad %%transpose value");r.pit+=124,t=12*Math.floor(r.pit/7)+pit_st[r.pit%7],r.acc&&3!=r.acc&&(t+=r.acc),s[i]=t}switch(t=3*(s[1]-s[0]),r.acc){default:return t;case 2:case 1:t++;break;case-1:case-2:t+=2}return t>0?t:t-3}function set_linebreak(e){var t,n;for(t=0;128>t;t++)if("\n"==char_tb[t]){char_tb[t]=nil;break}for(e=e.split(/\s+/),t=0;t<e.length;t++){switch(n=e[t]){case"!":case"$":case"*":case";":case"?":case"@":break;case"<none>":continue;case"<EOL>":n="\n";break;default:parse.line.error("Bad value '"+n+"' in %%linebreak - ignored");continue}char_tb[n.charCodeAt(0)]="\n"}}function set_user(e){var t,n,r,s=e[0],i="!",a=e.indexOf("!");if(0>a){if(a=e.indexOf('"'),0>a)return void parse.line.error('Lack of starting ! or " in U:/%%user');i='"'}if(t=e.indexOf(i,a+1),0>t)return void parse.line.error("Lack of ending "+i+" in U:/%%user");if("\\"==s&&(s=e[1],"t"==s&&(s="	")),n=s.charCodeAt(0),n>=128)return void parse.line.error(not_ascii);switch(char_tb[n][0]){case"0":case"d":case"i":case" ":break;case'"':case"!":if(char_tb[n].length>1)break;default:return void parse.line.error("Bad user character '"+s+"'")}switch(r=e.slice(a,t+1)){case"!beambreak!":r=" ";break;case"!ignore!":r="i";break;case"!nil!":case"!none!":r="d"}char_tb[n]=r}function get_st_lines(e){var t,n;if("|"==e[0]||"."==e[0])return e;switch(t=parseInt(e)){case 0:return"...";case 1:return"..|";case 2:return".||";case 3:return"|||."}if(!(isNaN(t)||0>t||t>16)){for(n="|";--t>0;)n+="|";return n}}function new_block(e){2==parse.state&&goto_tune();var t={type:BLOCK,subtype:e};return curvoice=voice_tb[0],curvoice.last_sym&&(curvoice.last_sym.eoln=!0),sym_link(t),t}function do_pscom(e){var t,n,r,s,i,a,o,c=!1;if(e.match(/ lock$/)&&(c=!0,e=e.slice(0,-5).trim()),s=e.match(/(\w|-)+/)){switch(s=s[0],i=e.replace(s,"").trim(),s){case"break":return;case"center":return parse.state>=2?(r=new_block("center"),void(r.text=cnv_escape(i))):void write_text(cnv_escape(i),"c");case"clef":return void(parse.state>=2&&(2==parse.state&&goto_tune(),r=new_clef(i),r&&get_clef(r)));case"clip":return;case"deco":return void deco_add(i);case"linebreak":return void set_linebreak(i);case"map":return void get_map(i);case"maxsysstaffsep":if(3==parse.state)return void(par_sy.voices[curvoice.v].maxsep=get_unit(i));break;case"multicol":switch(generate(),i){case"start":blk_out(),multicol={posy:posy,maxy:posy,lmarg:cfmt.leftmargin,rmarg:cfmt.rightmargin,state:parse.state};break;case"new":if(!multicol){parse.line.error("%%multicol new without start");break}posy>multicol.maxy&&(multicol.maxy=posy),cfmt.leftmargin=multicol.lmarg,posx=cfmt.leftmargin/cfmt.scale,cfmt.rightmargin=multicol.rmarg,posy=multicol.posy;break;case"end":if(!multicol){parse.line.error("%%multicol end without start");break}cfmt.leftmargin=multicol.lmarg,posx=cfmt.leftmargin/cfmt.scale,cfmt.rightmargin=multicol.rmarg,posy<multicol.maxy&&(posy=multicol.maxy),multicol=void 0,blk_out();break;default:parse.line.error("Unknown keyword '"+i+"' in %%multicol")}return;case"repbra":return void(parse.state>=2&&(2==parse.state&&goto_tune(),curvoice.norepbra=!get_bool(i)));case"repeat":if(3!=parse.state){if(2!=parse.state)return;goto_tune()}if(!curvoice.last_sym)return void parse.line.error("%%repeat cannot start a tune");if(i.length){var l=i.split(/\s+/);if(a=parseInt(l[0]),o=parseInt(l[1]),isNaN(a)||1>a||curvoice.last_sym.type==BAR&&a>2)return void parse.line.error("Incorrect 1st value in %%repeat");if(isNaN(o))o=1;else if(1>o)return void parse.line.error("Incorrect 2nd value in repeat")}else a=1,o=1;return r={type:FORMAT,fmt_type:"repeat",repeat_k:o},curvoice.last_sym.type==BAR?r.repeat_n=a:r.repeat_n=-a,void sym_link(r);case"sep":lwidth=cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin;var u,f;if(t=u=f=0,i){var d=i.split(/\s+/);t=get_unit(d[0]),d[1]&&(u=get_unit(d[1]),d[2]&&(f=get_unit(d[2])))}return 1>t&&(t=14),1>u&&(u=t),1>f&&(f=90),parse.state>=2?(r=new_block("sep"),r.x=(lwidth-f)/2/cfmt.scale,r.l=f/cfmt.scale,r.sk1=t,void(r.sk2=u)):(vskip(t),output.push('<path class="stroke"\n	d="M'),out_sxsy((lwidth-f)/2/cfmt.scale," ",0),output.push("h"+(f/cfmt.scale).toFixed(2)+'"/>\n'),vskip(u),void blk_out());case"setbarnb":return n=parseInt(i),isNaN(n)?void parse.line.error("Bad %%setbarnb value"):void(parse.state>=2?glovar.new_nbar=n:cfmt.measurefirst=n);case"staff":if(3!=parse.state){if(2!=parse.state)return;goto_tune()}if(n=parseInt(i),isNaN(n))return void parse.line.error("Bad %%staff value '"+i+"'");var p;return p="+"==i[0]||"-"==i[0]?curvoice.cst+n:n-1,0>p||p>nstaff?void parse.line.error("Bad %%staff number "+p+" cur "+curvoice.cst+" max "+nstaff):(delete curvoice.floating,void(curvoice.cst=p));case"staffbreak":if(3!=parse.state){if(2!=parse.state)return;goto_tune()}return r={type:STBRK},i[0]>="0"&&i[0]<="9"?(r.xmx=get_unit(i),"f"==i[i.length-1]&&(r.stbrk_forced=!0)):(r.xmx=14,"f"==i[0]&&(r.stbrk_forced=!0)),void sym_link(r);case"stafflines":return(n=get_st_lines(i))?curvoice?void(curvoice.stafflines=n):void(glovar.stafflines=n):void parse.line.error("Bad %%stafflines value");case"staffscale":return n=parseFloat(i),isNaN(n)||.3>n||n>2?void parse.line.error("Bad %%staffscale value"):curvoice?void(curvoice.staffscale=n):void(glovar.staffscale=n);case"staves":case"score":if(0==parse.state)return;return void get_staves(s,i);case"sysstaffsep":if(3==parse.state)return void(par_sy.voices[curvoice.v].sep=get_unit(i));break;case"text":return parse.state>=2?(r=new_block("text"),r.text=cnv_escape(i),void(r.opt=cfmt.textoption)):void write_text(cnv_escape(i),cfmt.textoption);case"transpose":if(2==parse.state&&goto_tune(),n=get_transp(i),!curvoice)return void(0==parse.state?cfmt.transpose=n:cfmt.transpose+=n);if(curvoice.ckey.k_bagpipe||curvoice.ckey.k_drum)return;if(curvoice.transpose=n+cfmt.transpose,r=curvoice.sym,!r)return curvoice.key=clone(curvoice.okey),key_transp(curvoice.key,curvoice.transpose),curvoice.ckey=clone(curvoice.key),void(curvoice.key.k_none&&(curvoice.key.k_sf=0));for(;r.type!=KEY;)if(r.time!=curvoice.time||!(r=r.prev)){r=sym_add(curvoice),r.type=KEY,r.k_old_sf=curvoice.key.k_sf;break}return r.k_sf=curvoice.okey.k_sf,curvoice.okey.k_none&&(r.k_none=curvoice.okey.k_none),curvoice.okey.k_a_acc&&(r.k_a_acc=curvoice.okey.k_a_acc),key_transp(r,curvoice.transpose),curvoice.ckey=clone(r),void(curvoice.key.k_none&&(r.k_sf=0));case"tune":return;case"user":return void set_user(i);case"voicecolor":if(parse.state<2)return;return 2==parse.state&&goto_tune(),r={type:FORMAT,fmt_type:"voicecolor"},"#000000"!=i&&"black"!=i&&(r.color=i),void sym_link(r);case"vskip":return n=get_unit(i),0>n?void parse.line.error("%%vskip cannot be negative"):parse.state>=2?(r=new_block("vskip"),void(r.sk=n)):(vskip(n),void blk_out());case"newpage":case"leftmargin":case"rightmargin":case"scale":return 2==parse.state&&goto_tune(),3==parse.state&&(generate(),blk_out()),"newpage"==s?void(block.newpage=!0):(set_format(s,i,c),void(posx=cfmt.leftmargin/cfmt.scale))}set_format(s,i,c)}}function do_begin_end(type,opt,text){var i,j,action,s;switch(type){default:case"ps":wpsobj&&(wpsobj.parse(text),output.push(svgbuf));break;case"js":eval(text);break;case"ml":parse.state>=2?(s=new_block("ml"),s.text=text):(svg_flush(),user.img_out(text));break;case"svg":for(j=0;;)if(i=text.indexOf('<style type="text/css">\n',j),i>=0){if(j=text.indexOf("</style>",i),0>j){parse.line.error("No </style> in %%beginsvg sequence");break}style+=text.slice(i+23,j)}else{if(i=text.indexOf("<defs>",j),!(i>=0))break;if(j=text.indexOf("</defs>",i),0>j){parse.line.error("No </defs> in %%beginsvg sequence");break}defs_add(text.slice(i+6,j))}break;case"text":if(action=get_textopt(opt),parse.state>=2){s=new_block("text"),s.text=text,s.opt=get_textopt(opt);break}write_text(text,action)}}function next_word(e,t){for(;e[t]&&" "!=e[t];)t++;for(;" "==e[t];)t++;return t}function parse_kv_args(e){var t,n,r=curvoice;for(r||(r=parse.voice_param={});;){if(n=e.shift(),!n)break;switch(n){case"clef=":t=new_clef(e.shift());break;case"octave=":r.octave=Number(e.shift());break;case"map=":r.map=e.shift();break;case"cue=":r.scale="on"==e.shift()?.7:1;break;case"stafflines=":if(n=get_st_lines(e.shift()),!n){parse.line.error("Bad stafflines= value");break}r.stafflines=n;break;default:switch(n.slice(0,4)){case"treb":case"bass":case"alto":case"teno":case"perc":t=new_clef(n);break;default:"GFC".indexOf(n[0])>=0?t=new_clef(n):"="==n[n.length-1]&&e.shift()}}}return t}function new_key(e){var t,n,r,s,i={type:KEY,ctx:parse.ctx,istart:parse.istart,iend:parse.iend,k_delta:0};if(!e.length)return[i,null];switch(t=1,e[0]){case"A":i.k_sf=3;break;case"B":i.k_sf=5;break;case"C":i.k_sf=0;break;case"D":i.k_sf=2;break;case"E":i.k_sf=4;break;case"F":i.k_sf=-1;break;case"G":i.k_sf=1;break;case"H":switch(e[1]){case"P":i.k_bagpipe="P",t++;break;case"p":i.k_bagpipe="p",i.k_sf=2,t++;break;default:parse.line.error("Unknown bagpipe-like key")}n=!0;break;case"P":i.k_drum=!0,n=!0;break;case"n":"none"==e.slice(0,4)&&(i.k_sf=0,i.k_none=!0,t=4);default:n=!0}if(!n){switch(e[t]){case"#":i.k_sf+=7,t++;break;case"b":i.k_sf-=7,t++}switch(e=e.slice(t).trim(),e.slice(0,3).toLowerCase()){case"aeo":case"m":case"min":i.k_sf-=3;break;case"dor":i.k_sf-=2;break;case"ion":case"maj":break;case"loc":i.k_sf-=5;break;case"lyd":i.k_sf+=1;break;case"mix":i.k_sf-=1;break;case"phr":i.k_sf-=4;break;default:if("m"==e[0]&&(" "==e[1]||"	"==e[1]||"\n"==e[1])){i.k_sf-=3;break}n=!0}if(n||(e=e.replace(/\w+\s*/,"")),"exp "==e.slice(0,4)&&(e=e.replace(/\w+\s*/,""),e||parse.line.error("no accidental after 'exp'"),i.k_exp=!0),r=e[0],"^"==r||"_"==r||"="==r){i.k_a_acc=[],s=new scanBuf,s.buffer=e,s.index=0,s.ctx=parse.ctx;do{var a=parse_acc_pit(s);if(!a)return[i,null];var o={pit:a.pit,acc:a.acc};for(i.k_a_acc.push(o),r=s["char"]();" "==r;)r=s.next_char()}while("^"==r||"_"==r||"="==r);e=e.slice(s.index)}else i.k_exp&&"none"==e.slice(0,4)&&(i.k_sf=0,e=e.replace(/\w+\s*/,""))}return i.k_delta=(cgd2cde[(i.k_sf+7)%7]+14)%7,e?[i,parse_kv_args(info_split(e,0))]:[i,null]}function get_map(e){if(e){var t,n,r,s,i,a,o=info_split(e,2);if(o.length<3)return void parse.line.error("Not enough parameters");if(a=o[1],"octave,"==a.slice(0,7)||"key,"==a.slice(0,4))a=a.replace(/[,']+$/m,"").toLowerCase(),"k"==a[0]&&(a=a.replace(/[_=^]+/,""));else if("*"==a[0]||"all"==a.slice(0,3))a="all";else{if(i=new scanBuf,i.buffer=o[1],i.index=0,i.ctx=parse.ctx,n=parse_acc_pit(i),!n)return void parse.line.error("Bad note in %%map");for(a="abcdefg"[(n.pit+77)%7],n.acc&&(a=["__","_","","^","^^","="][n.acc+2]+a),t=n.pit;t>=28;t-=7)a+="'";for(t=n.pit;21>t;t+=7)a+=","}if(maps||(maps={}),r=maps[o[0]],r||(maps[o[0]]=r={}),s=r[a],s||(r[a]=s=[]),o[2]){if(t=2,o[2].indexOf("=")<0){if("*"!=o[2][0]&&(i=new scanBuf,i.buffer=o[2],i.index=0,i.ctx=parse.ctx,s[1]=parse_acc_pit(i)),!o[3])return;t++,o[3].indexOf("=")<0&&(s[0]=o[3].split(","),t++)}for(;t<o.length;t++)switch(o[t]){case"heads=":s[0]=o[++t].split(",");break;case"print=":i=new scanBuf,i.buffer=o[++t],i.index=0,i.ctx=parse.ctx,s[1]=parse_acc_pit(i);break;case"color=":s[2]=o[++t]}}}}function new_meter(text){var s={type:METER,ctx:parse.ctx,istart:parse.istart,iend:parse.iend,a_meter:[]},meter={},val,v,m1=0,m2,i=0,j,wmeasure,p=text,in_parenth;if(0==p.indexOf("none"))i=4,wmeasure=1;else for(wmeasure=0;i<text.length&&"="!=p[i];){switch(p[i]){case"C":meter.top=p[i++],"|"==p[i]&&(meter.top+=p[i++]),m1=4,m2=4;break;case"c":case"o":m1="c"==p[i]?4:3,m2=4,meter.top=p[i++],"."==p[i]&&(meter.top+=p[i++]);break;case"(":for("("==p[i+1]&&(in_parenth=!0,meter.top=p[i++],s.a_meter.push(meter),meter={}),j=i+1;j<text.length&&")"!=p[j]&&"/"!=p[j];)j++;if(")"==p[j]&&"/"==p[j+1]){i++;continue}case")":in_parenth="("==p[i],meter.top=p[i++],s.a_meter.push(meter),meter={};continue;default:if(p[i]<="0"||p[i]>"9")return void parse.line.error("Bad char '"+p[i]+"' in M:");for(m2=2,meter.top=p[i++];;){for(;p[i]>="0"&&p[i]<="9";)meter.top+=p[i++];if(")"==p[i]){if("/"!=p[i+1])break;i++}if("/"==p[i]){if(i++,p[i]<="0"||p[i]>"9")return void parse.line.error("Bad char '"+p[i]+"' in M:");for(meter.bot=p[i++];p[i]>="0"&&p[i]<="9";)meter.bot+=p[i++];break}if(" "!=p[i]&&"+"!=p[i])break;if(i>=text.length||"("==p[i+1])break;meter.top+=p[i++]}m1=parseInt(meter.top)}for(in_parenth||(meter.bot&&(m2=parseInt(meter.bot)),wmeasure+=m1*BASE_LEN/m2),s.a_meter.push(meter),meter={};" "==p[i];)i++;"+"==p[i]&&(meter.top=p[i++],s.a_meter.push(meter),meter={})}if("="==p[i]){if(val=p.substring(++i),!val.match(/^(\d|\/)+$/))return void parse.line.error("Bad duration '"+val+"' in M:");wmeasure=BASE_LEN*eval(val)}if(s.wmeasure=wmeasure,3!=parse.state){if(info.M=text,glovar.meter=s,parse.state>=1)for(glovar.ulen||(1>=wmeasure||wmeasure>=3*BASE_LEN/4?glovar.ulen=BASE_LEN/8:glovar.ulen=BASE_LEN/16),v=0;v<voice_tb.length;v++)voice_tb[v].meter=s,voice_tb[v].wmeasure=wmeasure}else curvoice.wmeasure=wmeasure,is_voice_sig()?(curvoice.meter=s,reset_gen()):sym_link(s)}function new_tempo(e){if(!(cfmt.writefields.indexOf("Q")<0)){var t,n,r,s=0,i={type:TEMPO,ctx:parse.ctx,istart:parse.istrt,iend:parse.iend};if('"'==e[0]){if(s=e.indexOf('"',1),0>s)return void parse.line.error("Unterminated string in Q:");for(i.tempo_str1=e.slice(1,s),s++;" "==e[s];)s++}for(r=new scanBuf,r.buffer=e,r.index=s;;){if(t=r["char"](),void 0==t||"0">=t||t>"9")break;for(n=parse_dur(r),i.tempo_notes||(i.tempo_notes=[]),i.tempo_notes.push(BASE_LEN*n[0]/n[1]);;){if(t=r["char"]()," "!=t)break;r.advance()}}if("="==t){for(t=r.next_char();" "==t;)t=r.next_char();for(i.tempo_value="";t&&'"'!=t;)i.tempo_value+=t,t=r.next_char();i.tempo_value=i.tempo_value.replace(/\s+$/,"")}if('"'==t){if(r.advance(),s=e.indexOf('"',r.index+1),0>s)return void parse.line.error("Unterminated string in Q:");i.tempo_str2=e.slice(r.index,s)}if(3!=parse.state){if(1==parse.state)return info.Q=e,void(glovar.tempo=i);goto_tune()}curvoice.v==par_sy.top_voice&&sym_link(i)}}function do_info(info_type,text){switch(info_type){case"I":do_pscom(text);break;case"L":if(text.match(/^\d*\/\d*$/))text=BASE_LEN*eval(text);else{if("auto"!=text){parse.line.error("Bad L: value");break}text=-1}2==parse.state&&goto_tune(),3!=parse.state?glovar.ulen=Number(text):curvoice.ulen=Number(text);break;case"M":new_meter(text);break;case"U":set_user(text);break;case"P":if(0==parse.state)break;if(1==parse.state){info.P=text;break}if(2==parse.state&&goto_tune(),cfmt.writefields.indexOf("P")<0)break;var s={type:PART,ctx:parse.ctx,istart:parse.istart,iend:parse.iend,text:text},p_voice=voice_tb[par_sy.top_voice];if(curvoice.v!=p_voice.v){if(curvoice.time!=p_voice.time)break;if(p_voice.last_sym&&p_voice.last_sym.type==PART)break;var curvoice_sav=curvoice;curvoice=p_voice,sym_link(s),curvoice=curvoice_sav}else sym_link(s);break;case"Q":if(0==parse.state)break;new_tempo(text);break;case"V":if(0==parse.state)break;2==parse.state&&goto_tune(),get_voice(text),!curvoice.last_sym&&parse.voice_opts&&voice_filter();break;case"K":get_key_clef(new_key(text));break;case"k":parse.line.error("k: is obsolete - use %%map instead"),get_map(text);break;case"N":case"R":info[info_type]?info[info_type]+="\n"+text:info[info_type]=text;break;default:parse.line.error("'"+info_type+":' line ignored")}}function adjust_dur(e){var t,n,r,s,i;if(t=curvoice.last_sym,t&&t.type!=MREST&&t.type!=BAR){for(;t.type!=BAR&&t.prev;)t=t.prev;
if(n=t.time,r=curvoice.time-n,0==n){for(;t&&!t.dur;)t=t.next;t&&t.type==REST&&t.invisible&&(n+=t.dur*curvoice.wmeasure/r,t.prev?t.prev.next=t.next:curvoice.sym=t.next,t.next&&(t.next.prev=t.prev),t=t.next)}if(curvoice.wmeasure!=r){for(;t;t=t.next)if(t.time=n,t.dur&&!t.grace&&(t.dur=t.dur*curvoice.wmeasure/r,t.dur_orig=t.dur_orig*curvoice.wmeasure/r,n+=t.dur,t.type==NOTE||t.type==REST)){for(s=0;s<=t.nhd;s++)t.notes[s].dur=t.notes[s].dur*curvoice.wmeasure/r;i=identify_note(t,t.dur_orig),t.head=i[0],t.dots=i[1],t.nflags=i[2],t.nflags<=-2?t.stemless=!0:delete t.stemless}curvoice.time=e.time=n}}}function new_bar(){var e,t,n,r=parse.line,s={type:BAR,ctx:parse.ctx,multi:0};for(s.istart=parse.bol+r.index,vover&&vover.bar&&get_vover("|"),glovar.new_nbar&&(s.bar_num=glovar.new_nbar,delete glovar.new_nbar),n=r["char"](),":"==n&&(s.rbstop=2);;){switch(t=r.next_char()){case"|":case"[":case"]":case":":n+=t;continue}break}if(gchord&&(gch_build(s),gchord=null),a_dcn&&(deco_cnv(a_dcn,s),a_dcn=null),t>"0"&&"9">=t){for(s.text=t;;){if(t=r.next_char(),"0123456789,.-".indexOf(t)<0)break;s.text+=t}s.rbstop=2,s.rbstart=2}else if('"'==t&&"["==n){for(s.text="";;){if(t=r.next_char(),!t)return void r.error("No end of repeat string");if('"'==t){r.advance();break}"\\"==t&&(t=r.next_char()),s.text+=t}s.text=cnv_escape(s.text),s.rbstop=2,s.rbstart=2}switch(n[n.length-1]){case"[":s.rbstart||(n=n.slice(0,-1),r.index--);break;case":":s.rbstop=2}if("]"==n[0]&&(s.rbstop=2,1!=n.length?n=n.slice(1):s.invisible=!0),s.iend=parse.bol+r.index,s.rbstart&&curvoice.norepbra&&!curvoice.second&&(s.norepbra=!0),curvoice.ulen<0&&adjust_dur(s),e=curvoice.last_sym,e&&e.type==BAR){if("["==n&&!e.text&&!e.a_gch&&(0==curvoice.st||par_sy.staves[curvoice.st-1].flags&STOP_BAR||s.norepbra))return s.text&&(e.text=s.text),s.a_gch&&(e.a_gch=s.a_gch),s.norepbra&&(e.norepbra=s.norepbra),s.rbstart&&(e.rbstart=s.rbstart),void(s.rbstop&&(e.rbstop=s.rbstop));if("|:"==n&&!s.text&&":|"==e.bar_type)return e.bar_type="::",void(e.rbstop=2)}switch(n){case"[":s.rbstop=2;case"[]":case"[|]":s.invisible=!0,n="[]";break;case":|:":case":||:":n="::"}s.bar_type=n,curvoice.lyric_restart||(curvoice.lyric_restart=s),e&&e.type==KEY?(curvoice.last_sym=e.prev,curvoice.last_sym||(curvoice.sym=null),sym_link(s),s.next=e,e.prev=s,curvoice.last_sym=e):sym_link(s),s.st=curvoice.st,s.rbstart&&!curvoice.norepbra&&curvoice.st>0&&!(par_sy.staves[curvoice.st-1].flags&STOP_BAR)&&(e={type:BAR,ctx:s.ctx,istart:s.istart,iend:s.iend,bar_type:"[",multi:0,invisible:!0,text:s.text,rbstart:2},sym_link(e),e.st=curvoice.st,s.text=void 0,s.rbstart=0)}function parse_staves(e){for(var t,n=[],r=!1,s=0,i=0,a=0,o=0,c=0,l=e,u=0;u<l.length;){switch(l[u]){case" ":case"	":break;case"[":if(o||i+a>=2){parse.line.error("Misplaced '[' in %%staves"),r=!0;break}s|=i+a==0?OPEN_BRACKET:OPEN_BRACKET2,a++,c<<=8,c|=OPEN_BRACKET;break;case"{":if(o||i||a>=2){parse.line.error("Misplaced '{' in %%staves"),r=!0;break}s|=0==a?OPEN_BRACE:OPEN_BRACE2,i++,c<<=8,c|=OPEN_BRACE;break;case"(":if(o){parse.line.error("Misplaced '(' in %%staves"),r=!0;break}s|=OPEN_PARENTH,o++,c<<=8,c|=OPEN_PARENTH;break;case"*":!i||o||s&(OPEN_BRACE|OPEN_BRACE2)||(s|=FL_VOICE);break;case"+":s|=MASTER_VOICE;break;default:if(!l[u].match(/\w/)){parse.line.error("Bad voice ID in %%staves"),r=!0;break}for(var f="";u<l.length&&!(" 	()[]{}|*".indexOf(l[u])>=0);)f+=l[u++];for(t={v:new_voice(f).v};u<l.length;u++){switch(l[u]){case" ":case"	":continue;case"]":if(!(c&OPEN_BRACKET)){parse.line.error("Misplaced ']' in %%staves"),r=!0;break}a--,s|=i+a==0?CLOSE_BRACKET:CLOSE_BRACKET2,c>>=8;continue;case"}":if(!(c&OPEN_BRACE)){parse.line.error("Misplaced '}' in %%staves"),r=!0;break}i--,s|=0==a?CLOSE_BRACE:CLOSE_BRACE2,s&=~FL_VOICE,c>>=8;continue;case")":if(!(c&OPEN_PARENTH)){parse.line.error("Misplaced ')' in %%staves"),r=!0;break}o--,s|=CLOSE_PARENTH,c>>=8;continue;case"|":s|=STOP_BAR;continue}break}t.flags=s,n.push(t),s=0;continue}u++}return 0!=c&&(parse.line.error("'}', ')' or ']' missing in %%staves"),r=!0),r&&(n=null),n}function info_split(e,t){var n,r,s=[],i="",a=e.length;for(n=0;a>n;n++)switch(e[n]){case"=":if(!i){i="=";break}if(i+="=",s.length<t)break;s.push(i),i="";break;case" ":case"	":if(!i)break;s.push(i),i="";break;case'"':for(i&&(s.push(i),i=""),r=++n;a>n&&'"'!=e[n];)"\\"==e[n]&&n++,n++;if('"'!=e[n]){parse.line.error("Unterminated string");break}s.push(e.slice(r,n));break;case"\\":i+=e[n++];default:i+=e[n]}return i&&s.push(i),s}function parse_voice(e){var t,n=info_split(e,1),r=n.shift();curvoice=new_voice(r),void 0==curvoice.time&&(curvoice.time=0,3==parse.state&&0>staves_found&&(t=curvoice.v,curvoice.st=curvoice.cst=++nstaff,par_sy.nstaff=nstaff,par_sy.voices[t].st=nstaff,par_sy.voices[t].range=t,par_sy.staves[nstaff]={stafflines:"|||||",staffscale:1}));for(var s=0;s<n.length;s++)switch(n[s]){case"name=":case"nm=":curvoice.nm=n[++s],curvoice.new_name=!0;break;case"subname=":case"sname=":case"snm=":curvoice.snm=n[++s];break;case"stem=":set_pos("stem",n[++s]);break;default:"="==n[s][n[s].length-1]&&s++}return parse_kv_args(n)}function identify_note(e,t){var n,r,s;for(t%12!=0&&parse.line.error("Invalid note duration "+t),t/=12,0==t&&parse.line.error("Note too short"),s=5;0!=t&&!(1&t);t>>=1,s--);switch(t>>=1){case 0:r=0;break;case 1:r=1;break;case 3:r=2;break;case 7:r=3;break;default:r=3}if(s-=r,s>=0)n="full";else switch(s){default:parse.line.error("Note too long"),s=-4;case-4:n="square";break;case-3:n=cfmt.squarebreve?"square":"oval";break;case-2:n="oval";break;case-1:n="empty"}return[n,r,s]}function parse_dur(e){var t,n;if(c=e["char"](),c>"0"&&c<="9"?(t=e.get_int(),c=e["char"]()):t=1,"/"==c)if(n=2,c=e.next_char(),"/"==c){do n*=2,c=e.next_char();while("/"==c)}else c>"0"&&c<="9"&&(n=e.get_int());else n=1;return[t,n]}function parse_acc_pit(e){var t,n,r,s,i=e["char"]();switch(i){case"^":i=e.next_char(),"^"==i?(t=2,i=e.next_char()):t=1;break;case"=":t=3,i=e.next_char();break;case"_":i=e.next_char(),"_"==i?(t=-2,i=e.next_char()):t=-1}if((t&&i>="1"&&"9">=i||"/"==i)&&(nd=parse_dur(e),n=nd[0],r=nd[1],1==r?r=curvoice.microscale:r*=2,i=e["char"]()),s="CDEFGABcdefgab".indexOf(i)+16,i=e.next_char(),16>s)return void e.error("'"+e.buffer[e.index-1]+"' is not a note");for(;"'"==i;)s+=7,i=e.next_char();for(;","==i;)s-=7,i=e.next_char();return note={pit:s,apit:s,shhd:0,shac:0,ti1:0},t&&(note.acc=t,n&&(note.micro_n=n,note.micro_d=r)),note}function set_map(e){var t,n,r,s,i=maps[curvoice.map];for(t="abcdefg"[(e.pit+77)%7],n=e.acc?["__","_","","^","^^","="][e.acc+2]:"",r=n+t,s=e.pit;s>=28;s-=7)r+="'";for(s=e.pit;21>s;s+=7)r+=",";if(i[r])e.map=i[r],e.map[1]&&(e.apit=e.pit=e.map[1].pit,e.acc=e.map[1].acc);else{if(r="octave,"+n+t,!i[r]&&(r="key,"+n+"abcdefg"[(e.pit+77-curvoice.ckey.k_delta)%7],!i[r]&&(r="all",!i[r])))return;e.map=i[r]}}function parse_basic_note(e,t){var n,r=parse_acc_pit(e);return r?("0"==e["char"]()&&(parse.stemless=!0,e.advance()),n=parse_dur(e),r.dur=t*n[0]/n[1],r):null}function parse_vpos(){var e,t=parse.line,n=0;return"."!=t.buffer[t.index-1]||a_dcn||(n=SL_DOTTED),e=t.next_char(),"'"==e?(n+=SL_ABOVE,t.index++):","==e?(n+=SL_BELOW,t.index++):n+=SL_AUTO,n}function sort_pitch(e){function t(e,t){return e.pit-t.pit}e.notes=e.notes.sort(t)}function new_note(e,t){var n,r,s,i,a,o,c,l,u,f,d,p,h=0,m=parse.line,v=a_dcn;switch(a_dcn=void 0,parse.stemless=!1,r={type:NOTE,ctx:parse.ctx,stem:0,multi:0,nhd:0,xmx:0},r.istart=parse.bol+m.index,e?r.grace=!0:gchord&&(gch_build(r),gchord=void 0),i=m["char"]()){case"X":r.invisible=!0;case"Z":if(r.type=MREST,i=m.next_char(),i>"0"&&"9">=i?r.nmes=m.get_int():r.nmes=1,r.dur=curvoice.wmeasure*r.nmes,curvoice.second)return curvoice.time+=r.dur,null;break;case"y":r.type=SPACE,r.invisible=!0,i=m.next_char(),i>="0"&&"9">=i?r.width=m.get_int():r.width=10;break;case"x":r.invisible=!0;case"z":r.type=REST,m.advance(),u=parse_dur(m),r.dur=r.dur_orig=(curvoice.ulen<0?BASE_LEN/4:curvoice.ulen)*u[0]/u[1],r.notes=[{pit:18,dur:r.dur}];break;case"[":s=!0,i=m.next_char();default:for(curvoice.microscale&&(r.microscale=curvoice.microscale),r.notes=[];;){if(s)for(;;){if(!i)break;if(o=i.charCodeAt(0),o>=128)return m.error(not_ascii),null;switch(type=char_tb[o],type[0]){case"(":h<<=4,h+=parse_vpos(),i=m["char"]();continue;case"!":if(a_dcn||(a_dcn=[]),type.length>1)a_dcn.push(type.slice(1,-1));else{for(a="";;){if(i=m.next_char(),"!"==i)break;a+=i}a_dcn.push(a)}i=m.next_char();continue}break}if(n=parse_basic_note(m,r.grace||curvoice.ulen<0?BASE_LEN/4:curvoice.ulen),!n)return null;if(curvoice.octave&&(n.apit=n.pit+=7*curvoice.octave),h&&(n.sl1=h,r.sl1?r.sl1++:r.sl1=1,h=0),a_dcn&&(n.a_dcn=a_dcn,a_dcn=null),r.notes.push(n),!s)break;for(i=m["char"]();;){switch(i){case")":n.sl2?n.sl2++:n.sl2=1,r.sl2?r.sl2++:r.sl2=1,i=m.next_char();continue;case"-":n.ti1=parse_vpos(),r.ti1=!0,i=m["char"]();continue;case".":if(i=m.next_char(),"-"!=i){m.error("Misplaced dot");break}continue}break}if("]"==i){for(m.advance(),u=parse_dur(m),r.nhd=r.notes.length-1,o=0;o<=r.nhd;o++)n=r.notes[o],n.dur=n.dur*u[0]/u[1];break}}r.dur=r.dur_orig=r.notes[0].dur}if(r.grace&&r.type!=NOTE)return m.error("Not a note in grace note sequence"),null;if(r.notes){if(r.type==NOTE&&curvoice.transpose&&note_transp(r),r.grace){var _=curvoice.key.k_bagpipe?8:4;for(o=0;o<=r.nhd;o++)r.notes[o].dur/=_;switch(r.dur/=_,r.dur_orig/=_,curvoice.pos.gst){case SL_ABOVE:r.stem=1;break;case SL_BELOW:r.stem=-1;break;case SL_HIDDEN:r.stem=2}}else{switch(curvoice.pos.ste){case SL_ABOVE:r.stem=1;break;case SL_BELOW:r.stem=-1}if(r.combine=curvoice.combine,t&&(r.dur*=t),d=curvoice.brk_rhythm){if(l=curvoice.last_note,d>0){for(c=2*d-1,r.dur=r.dur*c/d,r.dur_orig=r.dur_orig*c/d,o=0;o<=r.nhd;o++)r.notes[o].dur=r.notes[o].dur*c/d;for(l.dur/=d,l.dur_orig/=d,o=0;o<=l.nhd;o++)l.notes[o].dur/=d}else{for(d=-d,c=2*d-1,r.dur/=d,r.dur_orig/=d,o=0;o<=r.nhd;o++)r.notes[o].dur/=d;for(l.dur=l.dur*c/d,l.dur_orig=l.dur_orig*c/d,o=0;o<=l.nhd;o++)l.notes[o].dur=l.notes[o].dur*c/d}curvoice.time=l.time+l.dur,f=identify_note(l,l.dur_orig),l.head=f[0],l.dots=f[1],l.nflags=f[2],curvoice.brk_rhythm=0,l.nflags<=-2?l.stemless=!0:delete l.stemless}}if(r.type==NOTE){if(f=identify_note(r,r.dur_orig),r.head=f[0],r.dots=f[1],r.nflags=f[2],r.xstem&&(r.nflags=0),r.nflags<=-2&&(r.stemless=!0),curvoice.map&&maps[curvoice.map])for(o=0;o<=r.nhd;o++)set_map(r.notes[o])}else p=r.dur_orig,p==curvoice.wmeasure&&(p=p<2*BASE_LEN?BASE_LEN:p<4*BASE_LEN?2*BASE_LEN:4*BASE_LEN),f=identify_note(r,p),r.head=f[0],r.dots=f[1],r.nflags=f[2];curvoice.last_note=r}return sym_link(r),cfmt.shiftunison&&(r.shiftunison=cfmt.shiftunison),curvoice.lyric_restart||(curvoice.lyric_restart=r),v&&deco_cnv(v,r,r.prev),parse.stemless&&(r.stemless=!0),r.iend=parse.bol+m.index,r}function parse_music_line(){var e,t,n,r,s,i,a,o,c,l,u,f,d,p=0,h=1,m=parse.line;for(m.buffer=parse.file.slice(parse.bol,parse.eol),m.index=0;;){if(i=m["char"](),!i||"%"==i)break;if("."==i)switch(m.buffer[m.index+1]){case"(":case"-":case"|":i=m.next_char()}if(a=i.charCodeAt(0),a>=128)m.error(not_ascii),m.advance();else{switch(o=char_tb[a],o[0]){case" ":curvoice.last_note&&(curvoice.last_note.beam_end=!0);break;case"\n":if(cfmt.barsperstaff)break;0==par_sy.voices[curvoice.v].range&&curvoice.last_sym&&(curvoice.last_sym.eoln=!0);break;case"&":if(i=m.next_char(),")"==i){get_vover(")");break}get_vover("&");continue;case"(":if(i=m.next_char(),i>"0"&&"9">=i){var v=m.get_int(),_=[0,1,3,2,3,0,2,0,3,0][v],g=v,i=m["char"]();if(":"==i){if(i=m.next_char(),i>"0"&&"9">=i&&(_=m.get_int(),i=m["char"]()),":"==i){if(i=m.next_char(),!(i>"0"&&"9">=i)){m.error("Invalid 'r' in tuplet");continue}g=m.get_int(),i=m["char"]()}}else 0==_&&(_=curvoice.wmeasure%9==0?3:2);e={type:TUPLET,tuplet_p:v,tuplet_q:_,tuplet_r:g,tuplet_n:g,tuplet_f:clone(cfmt.tuplets)},sym_link(e),f=u,d=h,u=e,h*=_/v;continue}if("&"==i){get_vover("(");break}p<<=4,m.index--,p+=parse_vpos();continue;case")":if(curvoice.ignore)break;if(e=curvoice.last_sym)switch(e.type){case NOTE:case REST:case SPACE:break;default:e=null}if(!e){m.error("Bad character ')'");break}e.slur_end?e.slur_end++:e.slur_end=1;break;case"!":if(a_dcn||(a_dcn=[]),o.length>1){a_dcn.push(o.slice(1,-1));break}for(r="",s=m.index;;){if(i=m.next_char(),!i)break;if("!"==i)break;r+=i}if(!i){m.index=s,m.error("No end of decoration");break}a_dcn.push(r);break;case'"':parse_gchord(o);break;case"-":var y=0;if(!curvoice.last_note||curvoice.last_note.type!=NOTE){m.error("No note before '-'");break}for(y=parse_vpos(),e=curvoice.last_note,s=0;s<=e.nhd;s++)e.notes[s].ti1?0==e.nhd&&m.error("Too many ties"):e.notes[s].ti1=y;e.ti1=!0;continue;case"[":var b=m.buffer[m.index+1];if('|[]: "'.indexOf(b)>=0||b>="1"&&"9">=b){if(t){m.error("Cannot have a bar in grace notes");break}new_bar();continue}if(":"==m.buffer[m.index+2]){if(parse.istart=parse.bol+m.index,m.index++,s=m.buffer.indexOf("]",m.index),0>s){m.error("Lack of ']'");break}var x=m.buffer.slice(m.index+2,s).trim();m.index=s+1,parse.iend=parse.bol+m.index;var w=do_info(b,x);w&&m.error(w);continue}case"n":if(e=new_note(t,h),!e)continue;e.type==NOTE&&(e.slur_start=p,p=0,n&&(e.sappo=!0,n=!1)),t?u&&(e.in_tuplet=!0):u&&e.notes&&(e.in_tuplet=!0,u.tuplet_n--,f&&f.tuplet_n--,0==u.tuplet_n&&(u=f,h=d,u?(f=null,d=1,0==u.tuplet_n&&(u=null,h=1,curvoice.time=Math.round(curvoice.time),e.dur=curvoice.time-e.time)):(curvoice.time=Math.round(curvoice.time),e.dur=curvoice.time-e.time)));continue;case"<":if(!curvoice.last_note){m.error("No note before '"+i+"'");break}for(var k="<"==i?1:-1;"<"==i||">"==i;)k*=2,i=m.next_char();curvoice.brk_rhythm=k;continue;case"d":m.error("Bad character '"+i+"'");break;case"i":break;case"{":if(t){m.error("'{' in grace note");break}if(c=curvoice.last_note,curvoice.last_note=null,l=a_dcn,a_dcn=void 0,t=!0,i=m.next_char(),"/"==i){n=!0;break}continue;case"|":i=m.buffer[m.index-1],new_bar(),"."==i&&(curvoice.last_sym.bar_dotted=!0);continue;case"}":if(e=curvoice.last_note,!t||!e){m.error("Bad character '}'");break}if(e.gr_end=!0,t=!1,!(e.prev&&e.prev.grace||curvoice.key.k_bagpipe)){for(s=0;s<=e.nhd;s++)e.notes[s].dur*=2;e.dur*=2,e.dur_orig*=2;var E=identify_note(e,e.dur_orig);e.head=E[0],e.dots=E[1],e.nflags=E[2]}curvoice.last_note=c,a_dcn=l;break;case"\\":if(m.index==m.buffer.length-1)return;for(s=m.index+1;;s++){if(i=m.buffer[s],!i||"%"==i)return;if(" "!=i&&"	"!=i)break}default:m.error("Bad character '"+i+"'")}m.advance()}}cfmt.breakoneoln&&curvoice.last_note&&(curvoice.last_note.beam_end=!0),cfmt.barsperstaff||"\n"==char_tb["\n".charCodeAt(0)]&&0==par_sy.voices[curvoice.v].range&&curvoice.last_sym&&(curvoice.last_sym.eoln=!0)}function cwid(e){var t=e.charCodeAt(0);return t>=128&&(t=97),cw_tb[t]}function strw(e){var t,n,r,s=gene.curfont.swfac,i=0,a=e.length;for(t=0;a>t;t++){switch(r=e[t]){case"$":if(r=e[t+1],"0"==r)gene.curfont=gene.deffont;else{if(!(r>="1"&&"9">=r)){i+=cwid("$")*s;break}gene.curfont=get_font("u"+r)}t++,s=gene.curfont.swfac;continue;case"&":n=e.indexOf(";",t),n>0&&10>n-t&&(t=n,r="a")}i+=cwid(r)*s}return i}function set_font(e){gene.curfont=gene.deffont=get_font(e)}function out_str(e){var t,n,r,s=gene.curfont,i=s;for(t=0;t<e.length;t++){switch(n=e[t]){case"<":n="&lt;";break;case">":n="&gt;";break;case"'":n="&apos;";break;case'"':n="&quot;";break;case"&":if("#"==e[t+1])break;if("t"==e[t+2]&&";"==e[t+3]&&("l"==e[t+1]||"g"==e[t+1]))break;if("a"==e[t+1]&&"p"==e[t+2]&&"o"==e[t+3]&&"s"==e[t+4]&&";"==e[t+5])break;if("q"==e[t+1]&&"u"==e[t+2]&&"o"==e[t+3]&&"t"==e[t+4]&&";"==e[t+5])break;if("a"==e[t+1]&&"m"==e[t+2]&&"p"==e[t+3]&&";"==e[t+4])break;n="&amp;";break;case"$":if(n=e[++t],"0"==n)r=gene.deffont;else{if(!(n>="1"&&"9">=n)){output.push("$"+n);continue}if(r=get_font("u"+n),!r){output.push("$"+n);continue}}if(r==i)continue;if(i!=s&&output.push("</tspan>"),i=r,i==s)continue;n='<tspan\n	class="f'+r.fid+cfmt.fullsvg+'">'}output.push(n)}i!=s&&output.push("</tspan>")}function xy_str(e,t,n,r,s){output.push('<text class="f'+gene.curfont.fid+cfmt.fullsvg+'" x="'),out_sxsy(e,'" y="',t),"c"==r?output.push('" text-anchor="middle">'):"j"==r?output.push('" textLength="'+s.toFixed(2)+'">'):"r"==r?output.push('" text-anchor="end">'):output.push('">'),out_str(n),output.push("</text>\n")}function trim_title(e,t){var n;return cfmt.titletrim&&(n=e.lastIndexOf(", "),(0>n||e[n+2]<"A"||e[n+2]>"Z"||n<e.length-7||e.indexOf(" ",n+3)>=0)&&(n=0)),!t&&cfmt.writefields.indexOf("X")>=0&&(e=info.X+".  "+e),n&&(e=e.slice(n+2).trim()+" "+e.slice(0,n)),cfmt.titlecaps?e.toUpperCase():e}function write_title(e,t){var n;e&&(e=trim_title(e,t),t?(set_font("subtitle"),n=gene.curfont.size,vskip(cfmt.subtitlespace+n)):(set_font("title"),n=gene.curfont.size,vskip(cfmt.titlespace+n)),cfmt.titleleft?xy_str(0,.2*n,e):xy_str((cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/2/cfmt.scale,.2*n,e,"c"))}function put_inf2r(e,t,n,r,s){n||(n=r,r=null),r?xy_str(e,t,n+" ("+r+")",s):xy_str(e,t,n,s)}function write_text(e,t){if("s"!=t){set_font("text");var n,r,s,i=(cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/cfmt.scale,a=gene.curfont.size*cfmt.lineskipfac,o=gene.curfont.size*cfmt.parskipfac;switch(t){default:switch(t){case"c":s=i/2;break;case"r":s=i;break;default:s=0}for(r=0;;){if(n=e.indexOf("\n",r),0>n){vskip(a),xy_str(s,0,e.slice(r),t);break}if(n==r){for(vskip(o),blk_out();"\n"==e[n+1];)vskip(a),n++;if(n==e.length)break}else vskip(a),xy_str(s,0,e.slice(r,n),t);r=n+1}vskip(o),blk_out();break;case"f":case"j":var c;for(r=0;;){n=e.indexOf("\n\n",r),c=0>n?e.slice(r):e.slice(r,n),c=c.split(/\s+/);var l=0,u=0;for(r=0;r<c.length;r++)l+=strw(c[r]+" "),l>=i&&(vskip(a),xy_str(0,0,c.slice(u,r).join(" "),t,i),u=r,l=0);if(0!=l&&(vskip(a),xy_str(0,0,c.slice(u).join(" "))),vskip(o),blk_out(),0>n)break;for(;"\n"==e[n+2];)vskip(a),n++;if(n==e.length)break;r=n+2}}}}function put_wline(e,t,n){for(var r,s,i=0;" "==e[i];)i++;if("$"==e[i]&&e[i+1]>="0"&&e[i+1]<="9"&&(i+=2),s=0,r=i,e[i]>="0"&&e[i]<="9"||"."==e[i+1]){for(;i<e.length&&(i++," "!=e[i]&&":"!=e[i-1]&&"."!=e[i-1]););for(s=i;" "==e[i];)i++}return 0!=s&&xy_str(t,0,e.slice(r,s),"r"),i<e.length&&xy_str(t+5,0,e.slice(i),"l"),i>e.length&&0==s}function put_words(e){var t,n,r,s,i,a,o,c;blk_out(),set_font("words");var l=.5*(cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/cfmt.scale,u=(l-45)/(cwid("a")*gene.curfont.swfac);for(s=0,e=e.split("\n"),i=e.length,n=0;i>n;n++){if(t=e[n],t.length>u){s=0;break}t?c=!0:c&&(s++,c=!1)}if(s>0){for(s++,s/=2,n=s,c=!1,o=0;i>o;o++){for(t=e[o],r=0;" "==t[r];)r++;if(r==t.length){if(c&&--n<=0)break;c=!1}else c=!0}a=o+1}else a=o=i;for(vskip(cfmt.wordsspace),n=0;o>n||i>a;n++){var f=.2*gene.curfont.size;o>n&&0==e[n].length&&blk_out(),vskip(cfmt.lineskipfac*gene.curfont.size-f),o>n&&put_wline(e[n],45,0),i>a&&(put_wline(e[a],20+l,1)&&0==--s&&(o>n?s++:a<e.length-1&&(l*=.6)),a++),vskip(f)}}function put_history(){var e,t,n,r,s,i,a,o=cfmt.infoname.split("\n"),c=o.length;for(e=0;c>e;e++)if(n=o[e][0],!(cfmt.writefields.indexOf(n)<0)&&(r=info[n])){for(s||(s=!0,set_font("history"),vskip(cfmt.textspace),i=gene.curfont.size*cfmt.lineskipfac),head=o[e].slice(2),(head[0]='"')&&(head=head.slice(1,-1)),vskip(i),xy_str(0,0,head),a=strw(head),r=r.split("\n"),xy_str(a,0,r[0]),t=1;t<r.length;t++)vskip(i),xy_str(a,0,r[t]);vskip(.3*i),blk_out()}}function write_headform(e){for(var t,n,r,s,i,a,o,c={},l=clone(info_font_init),u={A:cfmt.infospace,C:cfmt.composerspace,O:cfmt.composerspace,R:cfmt.infospace},f={},d="",p=cfmt.titleformat,h=0,m=0;;){for(;" "==p[m];)m++;if(m>=p.length)break;if(t=p[m++],"A">t||t>"Z")if("+"==t){if(0==d.lenth||"+"==d[d.length-1])continue;d=d.slice(0,-1)+"+"}else","==t&&("+"==d[d.length-1]&&(d=d.slice(0,-1)+"l"),d+="\n");else{if(c[t])f[t]++;else{if(!info[t])continue;c[t]=info[t].split("\n"),f[t]=1}switch(d+=t,p[m]){case"-":d+="l",m++;break;case"0":d+="c",m++;break;case"1":d+="r",m++;break;default:d+="c"}}}"+"==d[d.length-1]&&(d=d.slice(0,-1)+"l"),d+="\n";var v,_={l:cfmt.titlespace,c:cfmt.titlespace,r:cfmt.titlespace},g={l:0,c:.5*e,r:e},y={};for(p=d,m=0;;){for(y.l=y.c=y.r=a=0,h=m;;){if(t=p[h++],"\n"==t)break;if(s=p[h++],"+"==s)s=p[h+1];else if(0!=y[s])continue;v=c[t],v&&(r=l[t],r||(r="history"),n=get_font(r),o=1.1*n.size,u[t]&&(o+=u[t]),o>a&&(a=o),y[s]=o)}for(_.l+=a-y.l,_.c+=a-y.c,_.r+=a-y.r;;){if(t=p[m++],"\n"==t)break;if(s=p[m++],0!=c[t].length){if(v=c[t].shift(),"+"==s&&(f[t]--,t=p[m++],s=p[m++],c[t].length>0&&(v?v+=" "+c[t].shift():v=" "+c[t].shift())),r=l[t],r||(r="history"),n=get_font(r),o=1.1*n.size,u[t]&&(o+=u[t]),set_font(r),i=g[s],a=_[s]+o,"Q"==t){if("l"!=s){var b=tempo_width(glovar.tempo);"c"==s&&(b*=.5),i-=b}write_tempo(glovar.tempo,i,-a,.75),glovar.tempo.deleted=!0}else v&&xy_str(i,-a,v,s);if("T"==t&&(r=l.T="subtitle",u.T=cfmt.subtitlespace),f[t]<=1)for("T"==t&&(n=get_font(r),o=1.1*n.size,u[t]&&(o+=u[t]),set_font(r));c[t].length>0;)a+=o,v=c[t].shift(),xy_str(i,-a,v,s);f[t]--,_[s]=a}}if(_.c>_.l&&(_.l=_.c),_.r>_.l&&(_.l=_.r),m>=d.length)break;_.c=_.r=_.l}vskip(_.l)}function write_heading(){var e,t,n,r,s,i,a,o,c=(cfmt.pagewidth-cfmt.leftmargin-cfmt.rightmargin)/cfmt.scale;if(cfmt.titleformat&&cfmt.titleformat.length>0)return write_headform(c),void vskip(cfmt.musicspace);if(info.T&&cfmt.writefields.indexOf("T")>=0)for(e=0;;){if(t=info.T.indexOf("\n",e),0>t){write_title(info.T.substring(e),0!=e);break}write_title(info.T.slice(e,t),0!=e),e=t+1}if(set_font("composer"),a=cfmt.composerspace+gene.curfont.size,parse.ckey.k_bagpipe&&!cfmt.infoline&&cfmt.writefields.indexOf("R")>=0&&(i=info.R),i&&(xy_str(0,-cfmt.composerspace,i),a=cfmt.composerspace),n=info.A,cfmt.writefields.indexOf("C")>=0&&(r=info.C),cfmt.writefields.indexOf("O")>=0&&(s=info.O),r||s||cfmt.infoline){var l,u;if(vskip(cfmt.composerspace),cfmt.aligncomposer<0?(l=0,u=" "):0==cfmt.aligncomposer?(l=.5*c,u="c"):(l=c,u="r"),o=a,r||s){for(cfmt.aligncomposer>=0&&a!=o&&vskip(a-o),e=0;;){if(vskip(gene.curfont.size),t=r?r.indexOf("\n",e):-1,0>t){put_inf2r(l,0,r?r.substring(e):null,s,u);break}xy_str(l,0,r.slice(e,t),u),a+=gene.curfont.size,e=t+1}o>a&&vskip(o-a)}i=i?null:info.R,(i||n)&&cfmt.infoline&&(set_font("info"),vskip(gene.curfont.size+cfmt.infospace),put_inf2r(c,0,i,n,"r"),a+=gene.curfont.size+cfmt.infospace),o=0}else o=cfmt.composerspace;info.P&&cfmt.writefields.indexOf("P")>=0&&(set_font("parts"),a=cfmt.partsspace+gene.curfont.size-a,a>0&&(o+=a),o>.01&&vskip(o),xy_str(0,0,info.P),o=0),vskip(o+cfmt.musicspace)}function def_use(e){var t,n,r;if(!defined_glyph[e]){if(defined_glyph[e]=!0,r=glyphs[e],!r)return void error(1,null,"unknown glyph: "+e);for(n=0;;){if(t=r.indexOf('xlink:href="#',n),0>t)break;t+=13,n=r.indexOf('"',t),def_use(r.slice(t,n))}defs+="\n"+r}}function defs_add(e){for(var t,n,r,s,i,a=0;;){if(i=e.indexOf("<",a),0>i)break;if("<!--"!=e.slice(i,i+4)){if(t=e.indexOf('id="',i),0>t)break;if(t+=4,n=e.indexOf('"',t),0>n)break;if(r=e.slice(t,n),a=e.indexOf(">",n),0>a)break;if("/"==e[a-1])a++;else{if(t=e.indexOf(" ",i),0>t)break;if(s=e.slice(i+1,t),a=e.indexOf("</"+s+">",a),0>a)break;a+=3+s.length}glyphs[r]=e.slice(i,a)}else if(a=e.indexOf("-->",i+4),0>a)break}}function set_g(){stv_g.started&&(stv_g.started=!1,output.push("</g>\n")),(1!=stv_g.scale||stv_g.color)&&(output.push("<g "),1!=stv_g.scale&&(stv_g.st>=0?0==staff_tb[stv_g.st].y?output.push("!S"+stv_g.st+"!"):output.push(staff_tb[stv_g.st].scale_str):0==staff_tb[0].y?output.push("!V"+stv_g.v+"!"):output.push(voice_tb[stv_g.v].scale_str)),stv_g.color&&(1!=stv_g.scale&&output.push(" "),output.push('style="color:'+stv_g.color+'"')),output.push(">\n"),stv_g.started=!0)}function set_color(e){var t=stv_g.color;return e!=stv_g.color&&(stv_g.color=e,set_g()),t}function set_sscale(e){var t,n;e!=stv_g.st&&1!=stv_g.scale&&(stv_g.scale=0),t=e>=0?staff_tb[e].staffscale:1,n=e>=0&&1!=t?staff_tb[e].y:posy,(t!=stv_g.scale||n!=stv_g.dy)&&(stv_g.scale=t,stv_g.dy=n,stv_g.st=e,set_g())}function set_scale(e){var t=voice_tb[e.v].scale;return 1==t?void set_sscale(e.st):void((t!=stv_g.scale||stv_g.dy!=posy)&&(stv_g.scale=t,stv_g.dy=posy,stv_g.st=-1,stv_g.v=e.v,set_g()))}function set_dscale(e){output=staff_tb[e].output,stv_g.scale=staff_tb[e].staffscale,stv_g.st=-1}function delayed_update(){function e(e){for(var t,n,r,s=0;;){if(t=e.indexOf("!",s),0>t)break;output.push(e.slice(s,t)),"S"==e[t+1]?(n=e.indexOf("!",t+2),r=Number(e.slice(t+2,n)),output.push(staff_tb[r].scale_str),s=n+1):"V"==e[t+1]?(n=e.indexOf("!",t+2),r=Number(e.slice(t+2,n)),output.push(voice_tb[r].scale_str),s=n+1):(output.push("!"),s=t+1)}output.push(e.slice(s))}var t;for(t=0;t<=nstaff;t++)0!=staff_tb[t].output.length&&(output.push('<g transform="translate(0,'+(-staff_tb[t].y).toFixed(2)),1!=staff_tb[t].staffscale&&output.push(") scale("+staff_tb[t].staffscale.toFixed(2)),output.push(')">\n'),e(staff_tb[t].output.join("")),output.push("</g>\n"),staff_tb[t].output=[])}function anno_start(e){if(void 0!=e.istart){var t=e.type,n=e.ymx-e.ymn+4;e.grace&&(t=GRACE),stv_g.started&&(stv_g.started=!1,output.push("</g>\n")),user.anno_start(anno_type[e.type],e.istart,e.iend,e.x-e.wl-2,staff_tb[e.st].y+e.ymn+n-2,e.wl+e.wr+4,e.ymx-e.ymn+4),set_g()}}function anno_stop(e){if(void 0!=e.istart){var t=e.type,n=e.ymx-e.ymn+4;e.grace&&(t=GRACE),stv_g.started&&(stv_g.started=!1,output.push("</g>\n")),user.anno_stop(anno_type[e.type],e.istart,e.iend,e.x-e.wl-2,staff_tb[e.st].y+e.ymn+n-2,e.wl+e.wr+4,e.ymx-e.ymn+4),set_g()}}function out_svg(e){output.push(e)}function sx(e){return(e+posx)/stv_g.scale}function sy(e){return 1==stv_g.scale?posy-e:stv_g.st<0?(posy-e)/stv_g.scale:stv_g.dy-e}function out_sxsy(e,t,n){stv_g.trans||(e=(posx+e)/stv_g.scale,n=1!=stv_g.scale?stv_g.st<0?(posy-n)/stv_g.scale:stv_g.dy-n:posy-n),output.push(e.toFixed(2)+t+n.toFixed(2))}function xypath(e,t,n){n?output.push('<path class="fill" d="m'):output.push('<path class="stroke" d="m'),out_sxsy(e," ",t),output.push("\n")}function xybox(e,t,n,r){output.push('<rect class="stroke" stroke-width="0.6"\n	x="'),out_sxsy(e,'" y="',t),output.push('" width="'+n.toFixed(2)+'" height="'+r.toFixed(2)+'"/>\n')}function xygl(e,t,n){psxygl(e,t,n)||(def_use(n),output.push('<use x="'),out_sxsy(e,'" y="',t),output.push('" xlink:href="#'+n+'"/>\n'))}function out_acciac(e,t,n,r,s){s?(e-=1,t+=4):(e-=5,t-=4),output.push('<path class="stroke" d="m'),out_sxsy(e," ",t),output.push("l"+n.toFixed(2)+" "+(-r).toFixed(2)+'"/>\n')}function out_bar(e,t,n){e+=posx,t=posy-t,output.push('<path class="stroke" stroke-width="1" d="m'+e.toFixed(2)+" "+t.toFixed(2)+"v"+(-n).toFixed(2)+'"/>\n')}function out_bnum(e,t,n,r){if(n=n.toString(),r){var s,i=.6;for(s=0;s<n.length;s++)i+=cwid(n[s]);i*=12,output.push('<rect fill="white" x="'),out_sxsy(e-i/2,'" y="',t+10),output.push('" width="'+i.toFixed(2)+'" height="12"/>\n')}output.push('<text style="font:italic 12px serif"\n	x="'),out_sxsy(e,'" y="',t),output.push('" text-anchor="middle">'+n+'</text>\n"')}function out_brace(e,t,n){def_use("brace"),e+=posx-6,t=posy-t,n/=24,output.push('<use transform="translate('+e.toFixed(2)+","+t.toFixed(2)+") scale(2.5,"+n.toFixed(2)+')" xlink:href="#brace"/>')}function out_bracket(e,t,n){e+=posx-5,t=posy-t-3,n+=2,output.push('<path class="fill"\n	d="m'+e.toFixed(2)+" "+t.toFixed(2)+"\n	c10.5 1 12 -4.5 12 -3.5c0 1 -3.5 5.5 -8.5 5.5\n	v"+n.toFixed(2)+'\n	c5 0 8.5 4.5 8.5 5.5c0 1 -1.5 -4.5 -12 -3.5"/>\n')}function out_dot(e,t){output.push('<circle class="fill" cx="'),out_sxsy(e,'" cy="',t),output.push('" r="1.2"/>\n')}function out_dotbar(e,t,n){e+=posx,t=posy-t,output.push('<path class="stroke" stroke-dasharray="5,5"\n	d="m'+e.toFixed(2)+" "+t.toFixed(2)+"v"+(-n).toFixed(2)+'"/>\n')}function out_hyph(e,t,n){var r,s=25+3*Math.floor(n/20);r=n>15?Math.floor((n-15)/s):0,e+=(n-s*r-5)/2,output.push('<path class="stroke" stroke-width="1.2"\n	stroke-dasharray="5,'),output.push(Math.round((s-5)/stv_g.scale)),output.push('"\n	d="m'),out_sxsy(e," ",t+3),output.push("h"+(s*r+5).toFixed(2)+'"/>\n')}function out_stem(e,t,n,r,s,i){var a=r?GSTEM_XOFF:3.5,o=-n;if(0>n&&(a=-a),e+=a*stv_g.scale,output.push('<path class="stroke" d="m'),out_sxsy(e," ",t),stv_g.st<0&&(o/=stv_g.scale),output.push("v"+o.toFixed(2)+'"/>\n'),s){if(output.push('<path class="fill"\n	d="'),t+=n,n>0)if(i)if(r)for(;--s>=0;)output.push("M"),out_sxsy(e," ",t),output.push("l3 1.5 0 2 -3 -1.5z\n"),t-=3;else for(t+=1;--s>=0;)output.push("M"),out_sxsy(e," ",t),output.push("l7 3.2 0 3.2 -7 -3.2z\n"),t-=5.4;else if(r)if(1==s)output.push("M"),out_sxsy(e," ",t),output.push("c0.6 3.4 5.6 3.8 3 10\n	c1.2 -4.4 -1.4 -7 -3 -7\n");else for(;--s>=0;)output.push("M"),out_sxsy(e," ",t),output.push("c1 3.2 5.6 2.8 3.2 8\n	c1.4 -4.8 -2.4 -5.4 -3.2 -5.2\n"),t-=3.5;else if(1==s)output.push("M"),out_sxsy(e," ",t),output.push("c0.6 5.6 9.6 9 5.6 18.4\n	c1.6 -6 -1.3 -11.6 -5.6 -12.8\n");else for(;--s>=0;)output.push("M"),out_sxsy(e," ",t),output.push("c0.9 3.7 9.1 6.4 6 12.4\n	c1 -5.4 -4.2 -8.4 -6 -8.4\n"),t-=5.4;else if(i){if(!r)for(t+=1;--s>=0;)output.push("M"),out_sxsy(e," ",t),output.push("l7 -3.2 0 -3.2 -7 3.2z\n"),t+=5.4}else if(r)if(1==s)output.push("M"),out_sxsy(e," ",t),output.push("c0.6 -3.4 5.6 -3.8 3 -10\n	c1.2 4.4 -1.4 7 -3 7\n");else for(;--s>=0;)output.push("M"),out_sxsy(e," ",t),output.push("c1 -3.2 5.6 -2.8 3.2 -8\n	c1.4 4.8 -2.4 5.4 -3.2 5.2\n"),t+=3.5;else if(1==s)output.push("M"),out_sxsy(e," ",t),output.push("c0.6 -5.6 9.6 -9 5.6 -18.4\n	c1.6 6 -1.3 11.6 -5.6 12.8\n");else for(;--s>=0;)output.push("M"),out_sxsy(e," ",t),output.push("c0.9 -3.7 9.1 -6.4 6 -12.4\n	c1 5.4 -4.2 8.4 -6 8.4\n"),t+=5.4;output.push('"/>\n')}}function out_thbar(e,t,n){e+=posx+1.5,t=posy-t,output.push('<path class="stroke" stroke-width="3"\n	d="m'+e.toFixed(2)+" "+t.toFixed(2)+"v"+(-n).toFixed(2)+'"/>\n')}function out_trem(e,t,n){for(output.push('<path class="fill" d="m'),out_sxsy(e-4.5," ",t),output.push("\n	");;){if(output.push("l9 -3v3l-9 3z"),--n<=0)break;output.push("m0 5.4")}output.push('"/>\n')}function out_tubr(e,t,n,r,s){var i;s?(i=-3,t-=3):(i=3,t+=3),n/=stv_g.scale,output.push('<path class="stroke" d="m'),out_sxsy(e," ",t),output.push("v"+i.toFixed(2)+"l"+n.toFixed(2)+" "+(-r).toFixed(2)+"v"+(-i).toFixed(2)+'"/>\n')}function out_wln(e,t,n){output.push('<path class="stroke" stroke-width="0.8"\n	d="m'),out_sxsy(e," ",t),output.push("h"+n.toFixed(2)+'"/>\n')}function out_deco_str(e,t,n,r){var s=deco_str_style[n];s||(s={dx:0,dy:0,style:'style="font:14px serif"'}),e+=s.dx,t+=s.dy,output.push("<text "+s.style+'\n	x="'),out_sxsy(e,'" y="',t),output.push('">'),set_font("annotation"),out_str(r),output.push("</text>\n")}function out_arp(e,t,n){for(output.push('<g transform="translate('),out_sxsy(e,",",t),output.push(') rotate(270)">\n'),stv_g.trans=!0,e=0,t=-4,n=Math.ceil(n/6);--n>=0;)xygl(e,t,"ltr"),e+=6;stv_g.trans=!1,output.push("</g>\n")}function out_cresc(e,t,n,r){output.push('<path class="stroke" d="m'),r.nost?(out_sxsy(e," ",t+3.2),output.push("l"+n.toFixed(2)+" -2.2m0 8l"+(-n).toFixed(2)+' -2.2"/>\n')):(out_sxsy(e," ",t+5),output.push("l"+n.toFixed(2)+" -4m0 8l"+(-n).toFixed(2)+' -4"/>\n'))}function out_dim(e,t,n,r){output.push('<path class="stroke"\n	d="m'),out_sxsy(e," ",t+5),output.push("l"+n.toFixed(2)),r.noen?output.push(" -2.2m0 -3.6l"+(-n).toFixed(2)+' -2.2"/>\n'):output.push(" -4l"+(-n).toFixed(2)+' -4"/>\n')}function out_ltr(e,t,n){for(t+=4,n=Math.ceil(n/6);--n>=0;)xygl(e,t,"ltr"),e+=6}function out_deco_val(e,t,n,r,s){deco_val_tb[n]?deco_val_tb[n](e,t,r,s):error(1,null,"No function for decoration '"+n+"'")}function vskip(e){posy+=e}function svg_flush(){var e;!multicol&&output&&user.img_out&&(info.X?(e=info.X+".",info.T&&(e+=" "+info.T.split("\n")[0]),e=e.replace(/&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;")):e="noname",posy*=cfmt.scale,user.imagesize?user.img_out('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n	xmlns:xlink="http://www.w3.org/1999/xlink"\n	xml:space="preserve" color="black"\n'+user.imagesize+' viewBox="0 0 '+cfmt.pagewidth.toFixed(0)+" "+posy.toFixed(0)+'">\n<title>abc2svg - '+e+"</title>"):user.img_out('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n	xmlns:xlink="http://www.w3.org/1999/xlink"\n	xml:space="preserve" color="black"\n	width="'+cfmt.pagewidth.toFixed(0)+'px" height="'+posy.toFixed(0)+'px">\n<title>abc2svg - '+e+"</title>"),
(style||font_style)&&user.img_out('<style type="text/css">'+style+font_style+"\n</style>"),defs&&user.img_out("<defs>"+defs+"\n</defs>"),cfmt.bgcolor&&user.img_out('<rect width="100%" height="100%" fill="'+cfmt.bgcolor+'"/>'),1==cfmt.scale?user.img_out('<g stroke-width=".7">'):user.img_out('<g stroke-width=".7"> transform="scale('+cfmt.scale.toFixed(2)+')">'),svgobj&&(svgobj.setg(0),output.push(svgbuf),svgbuf=""),user.img_out(output.join("")+"</g>\n</svg>"),output=[],font_style="",cfmt.fullsvg?(defined_glyph={},defined_font={}):(style="",defs=""),posy=0)}function blk_out(){!multicol&&output&&user.img_out&&(user.page_format&&!block.started&&(block.started=!0,block.newpage?(block.newpage=!1,user.img_out('<div class="nobrk newpage">')):user.img_out('<div class="nobrk">')),svg_flush())}function blk_flush(){block.started&&user.img_out&&(block.started=!1,user.img_out("</div>"))}function voice_filter(){var e,t,n;for(e in parse.voice_opts)if(t=new RegExp(e),t.test(curvoice.id)||t.test(curvoice.nm))for(n=0;n<parse.voice_opts[e].length;n++)do_pscom(parse.voice_opts[e][n])}function sym_link(e){curvoice.ignore||(parse.last_sym=e,e.prev=curvoice.last_sym,curvoice.last_sym?curvoice.last_sym.next=e:curvoice.sym=e,curvoice.last_sym=e),e.v=curvoice.v,e.st=curvoice.cst,e.time=curvoice.time,e.dur&&!e.grace&&(curvoice.time+=e.dur),e.pos=clone(curvoice.pos),curvoice.second&&(e.second=!0),curvoice.floating&&(e.floating=!0)}function sym_add(e){var t,n={},r=curvoice;return curvoice=e,sym_link(n),curvoice=r,t=n.prev,t||(t=n.next),t&&(n.ctx=t.ctx,n.istart=t.istart,n.iend=t.iend),n}function mrest_expand(e){var t,n,r,s=e.nmes,i=e.dur/s,a=e.a_dd;for(e.type=REST,e.dur=i,e.head="full",e.nflags=-2,r=e.next,t=voice_tb[e.v],t.last_sym=e,t.time=e.time+i,t.cst=e.st,n=e;--s>0;)n=sym_add(t),n.type=BAR,n.bar_type="|",n=sym_add(t),n.type=REST,e.invisible&&(n.invisible=!0),n.dur=i,n.head="full",n.nflags=-2,t.time+=i;n.next=r,r&&(r.prev=n),n.a_dd=a}function sort_all(){var e,t,n,r,s,i,a,o,c,l,u,f,d,p=voice_tb.length,h=[],m=[],v=-1;for(r=0;p>r;r++)h.push(voice_tb[r].sym);for(var _=cur_sy,g=!0;;){if(g)for(g=!1,f=1,c=-1,r=0;p>r;r++)_.voices[r]?(o=_.voices[r].range,0>o||(m[o]=r,c++)):_.voices[r]={range:-1};for(a=s=1e6,o=0;o<m.length&&(r=m[o],void 0!=r);o++)e=h[r],!e||e.time>s||(i=weight_tb[e.type],e.time<s?(s=e.time,a=i):a>i&&(a=i),e.type==MREST&&(1==e.nmes?mrest_expand(e):c>0&&(v=s)));if(a>127)break;if(s==v){for(d=0,o=0;o<m.length&&(r=m[o],void 0!=r);o++)if(e=h[r],e&&e.time==s&&weight_tb[e.type]==a){if(e.type!=MREST){v=-1;break}if(0==d)d=e.nmes;else if(d!=e.nmes){v=-1;break}}if(0>v)for(o=0;o<m.length&&(r=m[o],void 0!=r);o++)e=h[r],e&&e.type==MREST&&mrest_expand(e)}for(o=0;o<m.length&&(r=m[o],void 0!=r);o++)e=h[r],e&&e.time==s&&weight_tb[e.type]==a&&(e.type==STAVES?(_=_.next,g=u=!0,e.prev?e.prev.next=e.next:voice_tb[r].sym=e.next,e.next&&(e.next.prev=e.prev)):(f&&(f=0,e.seqst=!0),u&&(u=!1,e.new_sy=!0),e.ts_prev=l,l?l.ts_next=e:tsfirst=e,l=e),h[r]=e.next);f=a}if(l){if(l.type!=BAR&&l.type!=FORMAT||u)for(n=voice_tb[l.v],n.last_sym=l,e=sym_add(n),e.type=FORMAT,e.time=l.time+l.dur,e.seqst=!0,u&&(e.new_sy=!0),l.ts_next=e,e.ts_prev=l;;){if(delete l.eoln,l.seqst)break;l=l.ts_prev}if(t=glovar.tempo){for(e=tsfirst.extra;e;){if(e.type==TEMPO)return;e=e.next}e=tsfirst,t.v=e.v,t.st=e.st,t.time=e.time,e.extra&&(t.next=e.extra,t.next.prev=t),e.extra=t}}}function compr_voice(){function e(e){var t,n,r,s,i,a,o,s=e.dur,c=1;for(t=e;t&&(!t.beam_end&&t.next);t=t.next)c++;if(1>=c)return void delete e.feathered_beam;if(n=t,i=s/2,o=s/(c-1),r=e.time,e.feathered_beam>0)for(t=e,a=c-1;t!=n;t=t.next,a--)s=Math.floor(o*a)+i,t.dur=s,t.time=r,r+=s;else for(t=e,a=0;t!=n;t=t.next,a++)s=Math.floor(o*a)+i,t.dur=s,t.time=r,r+=s;t.dur=t.time+t.dur-r,t.time=r}var t,n,r,s,i;for(i=0;i<voice_tb.length;i++){for(t=voice_tb[i],t.ignore&&(t.ignore=!1),n=t.sym;n&&!(n.time>=staves_found);n=n.next);for(s=null;n;n=n.next){switch(n.type){case FORMAT:if(r=n.extra){if(s||(s=r),n.prev&&(n.prev.next=r,r.prev=n.prev),!n.next){s=null;break}for(;r.next;)r=r.next;n.next.prev=r,r.next=n.next}case TEMPO:case PART:case TUPLET:case BLOCK:s||(s=n);continue;case MREST:if(!s)continue;r={type:SPACE,width:-1,invisible:!0,v:n.v,st:n.st,time:n.time},r.next=n,r.prev=n.prev,r.prev.next=r,n.prev=r,n=r}if(n.feathered_beam&&e(n),n.grace){for(s||(s=n);!n.gr_end;)n=n.next;r=clone(n),r.type=GRACE,r.dur=0,delete r.notes,r.next=n.next,r.next?r.next.prev=r:t.last_sym=r,r.prev=n,n.next=r,n=r}s&&(n.extra=s,delete n.prev.next,n.prev=s.prev,n.prev?n.prev.next=n:t.sym=n,delete s.prev,s=null)}s&&(n=sym_add(t),n.type=FORMAT,n.extra=s,delete n.prev.next,n.prev=s.prev,n.prev?n.prev.next=n:t.sym=n,delete s.prev)}}function dupl_voice(){var e,t,n,r,s,i,a,o;for(a=0;a<voice_tb.length;a++)if(e=voice_tb[a],t=e.clone){for(e.clone=null,n=e.sym;n&&!(n.time>=staves_found);n=n.next);for(t.clef=clone(e.clef),curvoice=t;n;n=n.next){if(r=clone(n),n.notes)for(r.notes=[],o=0;o<=n.nhd;o++)r.notes.push(clone(n.notes[o]));if(sym_link(r),t.second?r.second=!0:delete r.second,t.floating?r.floating=!0:delete r.floating,delete r.a_ly,s=r.extra)for(i=clone(s),r.extra=i,r=i,r.v=a,r.st=t.st,s=s.next;s;s=s.next){if(i=clone(s),s.notes)for(i.notes=[],o=0;o<=s.nhd;o++)i.notes.push(clone(s.notes[o]));r.next=i,i.prev=r,r=i,r.v=a,r.st=t.st}}}}function new_system(){var e,t,n={voices:[],staves:[],top_voice:0};if(par_sy){for(t=0;t<voice_tb.length;t++){e=par_sy.voices[t].st;var r=par_sy.staves[e],s=voice_tb[t];void 0!=s.stafflines&&(r.stafflines=s.stafflines),s.staffscale&&(r.staffscale=s.staffscale),n.voices[t]=clone(par_sy.voices[t]),n.voices[t].range=-1,delete n.voices[t].second}for(e=0;e<par_sy.staves.length;e++)n.staves[e]=clone(par_sy.staves[e]),n.staves[e].flags=0;par_sy.next=n,par_sy=n}else cur_sy=par_sy=n}function go_global_time(e,t){var n,r,s;if(t.bar<=1){if(1==t.bar){for(n=e;n&&(n.type!=BAR||0==n.time);n=n.ts_next);n.time<voice_tb[cur_sy.top_voice].meter.wmeasure&&(e=n)}}else{for(;e&&!(e.type==BAR&&e.bar_num>=t.bar);e=e.ts_next);if(!e)return null;if(0!=t.seq){for(s=t.seq,e=e.ts_next;e&&(e.type!=BAR||e.bar_num!=t.bar||0!=--s);e=e.ts_next);if(!e)return null}}if(0==t.time)return e;for(r=e.time+t.time;e.time<r;)if(e=e.ts_next,!e)return e;do e=e.ts_prev;while(!e.seqst);return e}function do_clip(){var e,t,n,r,s;if(e=tsfirst,clip_start.bar>0||clip_start.time>0){if(e=go_global_time(e,clip_start),!e)return void(tsfirst=null);for(n=cur_sy,t=tsfirst;t!=e;t=t.ts_next)switch(t.new_sy&&(n=n.next),t.type){case CLEF:voice_tb[t.v].clef=t;break;case KEY:voice_tb[t.v].key=clone(t.as.u.key);break;case METER:voice_tb[t.v].meter=clone(t.as.u.meter)}for(cur_sy=n,s=0;s<voice_tb.length;s++){for(r=voice_tb[s],t=e;t;t=t.ts_next)if(t.v==s){delete t.prev;break}r.sym=t}tsfirst=e,delete e.ts_prev}if(e=go_global_time(e,clip_end)){do if(e=e.ts_next,!e)return;while(!e.seqst);for(s=0;s<voice_tb.length;s++){for(r=voice_tb[s],t=e.ts_prev;t;t=t.ts_prev)if(t.v==s){delete t.next;break}t||(r.sym=null)}delete e.ts_prev.ts_next}}function set_bar_num(){var e,t,n,r,s=cur_sy.top_voice,i=voice_tb[s].meter.wmeasure,a=gene.nbar;for(e=tsfirst;;e=e.ts_next){if(!e)return;switch(e.type){case METER:case CLEF:case KEY:case FORMAT:case STBRK:continue;case BAR:if(e.bar_num){gene.nbar=e.bar_num;break}e.text&&!cfmt.contbarnb&&("1"==e.text[0]?a=gene.nbar:(gene.nbar=a,e.bar_num=gene.nbar))}break}for(var o=e.time+i,c=gene.nbar;e;e=e.ts_next)switch(e.type){case CLEF:if(e.new_sy)break;for(t=e.ts_prev;t;t=t.ts_prev){if(t.new_sy){t=void 0;break}switch(t.type){case BAR:if(t.seqst)break;continue;case MREST:case NOTE:case REST:case SPACE:case STBRK:case TUPLET:t=void 0;break;default:continue}break}if(!t)break;if(e.next.prev=e.prev,e.prev.next=e.next,e.ts_next.ts_prev=e.ts_prev,e.ts_prev.ts_next=e.ts_next,e.next=t,e.prev=t.prev,e.prev.next=e,t.prev=e,e.ts_next=t,e.ts_prev=t.ts_prev,e.ts_prev.ts_next=e,t.ts_prev=e,n=e.extra){if(e.ts_next.extra){for(;n.next;)n=n.next;n.next=e.ts_next.extra,e.ts_next.extra=e.extra}else e.ts_next.extra=n;e.extra=void 0}e=t;break;case METER:i=e.wmeasure,e.time<o&&(o=e.time+i);break;case MREST:for(c+=e.nmes-1;e.ts_next&&e.ts_next.type!=BAR;)e=e.ts_next;break;case BAR:if(e.bar_num){if(c=e.bar_num,e.time<o){delete e.bar_num;break}}else{if(e.time<o)break;c++}r=e.time,t=e;do{if(t.type==BAR&&t.text&&!cfmt.contbarnb){"1"==t.text[0]?a=c:c=a;break}t=t.next}while(t&&t.time==r);e.bar_num=c,o=e.time+i}cfmt.measurenb<0&&(gene.nbar=c)}function generate(){var e,t;if(compr_voice(),dupl_voice(),sort_all(),tsfirst&&(set_bar_num(),tsfirst)){for(output_music(),e=0;e<voice_tb.length;e++)t=voice_tb[e],t.time=0,t.sym=t.last_sym=null,t.st=cur_sy.voices[e].st,t.second=cur_sy.voices[e].second,t.clef.time=0,delete t.have_ly,t.hy_st=0,delete t.bar_start,delete t.slur_st,delete t.s_tie,delete t.s_rtie;staves_found=0}}function gen_ly(e){generate(),info.W&&(put_words(info.W),delete info.W),e&&blk_out()}function key_transp(e,t){var n,r;switch(r=t>0?Math.floor(t/3):-Math.floor(-t/3),n=(-2&r)+7*(1&r)+e.k_sf,(t+210)%3){case 1:n=(n+4+48)%12-4;break;case 2:n=(n+7+48)%12-7;break;default:n=(n+5+48)%12-5}e.k_sf=n}function set_k_acc(e){var t,n,r,s,i,a=[],o=[];if(e.k_sf>0)for(s=0;s<e.k_sf;s++)a[s]=1,o[s]=[26,23,27,24,21,25,22][s];else for(s=0;s<-e.k_sf;s++)a[s]=-1,o[s]=[22,25,21,24,20,23,26][s];for(r=e.k_a_acc.length,t=0;r>t;t++){for(i=e.k_a_acc[t],n=0;s>n;n++)if(o[n]==i.pit){a[n]=i.acc;break}n==s&&(a[n]=i.acc,o[n]=i.pit,s++)}for(t=0;s>t;t++)i=e.k_a_acc[t],i||(i=e.k_a_acc[t]={}),i.acc=a[t],i.pit=o[t]}function acc_same_pitch(e){var t,n;if(s=curvoice.last_sym,s)for(n=s.time;s;s=s.prev)switch(s.type){case BAR:if(s.time<n)return;for(;;){if(s=s.prev,!s)return;if(s.type==NOTE){if(s.time+s.dur==n)break;return}if(s.time<n)return}for(t=0;t<=s.nhd;t++)if(s.notes[t].pit==e&&s.notes[t].ti1)return s.notes[t].acc;return;case NOTE:for(t=0;t<=s.nhd;t++)if(s.notes[t].pit==e)return s.notes[t].acc}}function note_transp(e){var t,n,r,s,i,a,o,c,l,u,f=e.nhd,d=curvoice.okey.k_sf,p=curvoice.ckey.k_sf-d,h=cgd2cde[(p+28)%7],m=curvoice.transpose;for(m>0?h+=7*Math.floor(m/3/12):(0!=h&&(h-=7),h-=7*Math.floor(-m/3/12)),t=0;f>=t;t++){if(u=e.notes[t],r=u.pit,u.pit+=h,u.apit=u.pit,o=cde2fcg[(r+5+112)%7],i=u.acc,!i)if(curvoice.okey.a_acc){for(n=0;n<curvoice.okey.a_acc.length;n++)if(a=curvoice.okey.a_acc[n],(r+112-a.pit)%7==0){i=a.acc;break}}else d>0?d-1>o&&(i=1):0>d&&o>=d+6&&(i=-1);if(c=o+p,i&&3!=i&&(c+=7*i),o=(Math.floor((c+1+21)/7)+2-3+160)%5,i=acc2[o],u.acc);else if(curvoice.ckey.k_none){if(3==i||acc_same_pitch(u.pit))continue}else{if(!curvoice.ckey.a_acc)continue;for(l=cgd2cde[(c+112)%7],n=0;n<curvoice.ckey.a_acc.length&&(l+112-curvoice.ckey.a_acc[n].pits)%7!=0;n++);if(n<curvoice.ckey.a_acc.length)continue}if(o=u.acc,s=u.micro_d,s&&o!=i)switch(r=u.micro_n,i){case 3:r>s/2?(r-=s/2,u.micro_n=r,i=o):i=-o;break;case 2:r>s/2?(u.pit+=1,u.apit=u.pit,r-=s/2):r+=s/2,i=o,u.micro_n=r;break;case-2:r>=s/2?(u.pit-=1,u.apit=u.pit,r-=s/2):r+=s/2,i=o,u.micro_n=r}u.acc=i}}function get_staves(e,t){var n,r,s,i,a,o,c,l,u,f;compr_voice(),dupl_voice();var d=0,p=!0;for(o=0;o<voice_tb.length;o++)r=voice_tb[o],r.time>d&&(d=r.time),r.sym&&(p=!1);if(p||0==d&&0>staves_found)for(o=0;o<par_sy.voices.length;o++)par_sy.voices[o].range=-1;else if(staves_found!=d){for(o=0;o<par_sy.voices.length;o++)if(par_sy.voices[o].range>=0){curvoice=voice_tb[o];break}curvoice.time=d,n={type:STAVES},sym_link(n),par_sy.nstaff=nstaff,new_system()}if(staves_found=d,u=parse_staves(t)){for(o=0;o<voice_tb.length;o++)r=voice_tb[o],delete r.second,delete r.ignore,r.time=d;for(f=0,par_sy.top_voice=u[0].v,i=0;i<u.length;i++){if(l=u[i],o=l.v,r=voice_tb[o],par_sy.voices[o].range>=0){for(s=clone(r),par_sy.voices[voice_tb.length]=clone(par_sy.voices[o]),o=voice_tb.length,s.v=o,s.sym=s.last_sym=null,s.time=d,voice_tb.push(s),delete s.clone;r.clone;)r=r.clone;r.clone=s,r=s,l.v=o}par_sy.voices[o].range=f++}if("t"==e[1])for(i=0;i<u.length;i++)l=u[i],a=l.flags,a&(OPEN_BRACE|OPEN_BRACE2)&&(a&(OPEN_BRACE|CLOSE_BRACE))!=(OPEN_BRACE|CLOSE_BRACE)&&(a&(OPEN_BRACE2|CLOSE_BRACE2))!=(OPEN_BRACE2|CLOSE_BRACE2)&&0==u[i+1].flags&&(a&OPEN_PARENTH||u[i+2].flags&OPEN_PARENTH||(u[i+2].flags&(CLOSE_BRACE|CLOSE_BRACE2)?u[i+1].flags|=FL_VOICE:0==u[i+2].flags&&u[i+3].flags&(CLOSE_BRACE|CLOSE_BRACE2)&&(l.flags|=OPEN_PARENTH,u[i+1].flags|=CLOSE_PARENTH,u[i+2].flags|=OPEN_PARENTH,u[i+3].flags|=CLOSE_PARENTH)));for(c=-1,i=0;i<u.length;i++)if(l=u[i],a=l.flags,(a&(OPEN_PARENTH|CLOSE_PARENTH))==(OPEN_PARENTH|CLOSE_PARENTH)&&(a&=~(OPEN_PARENTH|CLOSE_PARENTH),l.flags=a),o=l.v,r=voice_tb[o],a&FL_VOICE?(r.floating=!0,r.second=!0):(c++,par_sy.staves[c]||(par_sy.staves[c]={stafflines:"|||||",staffscale:1}),par_sy.staves[c].flags=0),r.st=r.cst=par_sy.voices[o].st=c,par_sy.staves[c].flags|=a,a&OPEN_PARENTH){for(s=r;i<u.length-1&&(l=u[++i],o=l.v,r=voice_tb[o],l.flags&MASTER_VOICE?(s.second=!0,s=r):r.second=!0,r.st=r.cst=par_sy.voices[o].st=c,!(l.flags&CLOSE_PARENTH)););par_sy.staves[c].flags|=l.flags}if(0>c&&(c=0),par_sy.nstaff=nstaff=c,"c"==e[1])for(c=0;c<=nstaff;c++)par_sy.staves[c].flags^=STOP_BAR;for(o=0;o<voice_tb.length;o++)par_sy.voices[o].range<0||(r=voice_tb[o],par_sy.voices[o].second=r.second,c=r.st,!(c>0)||r.norepbra||par_sy.staves[c-1].flags&STOP_BAR||(r.norepbra=!0));curvoice=voice_tb[par_sy.top_voice]}}function get_vover(e){function t(e){var t,n;for(t=0;t<voice_tb.length;t++)if(n=voice_tb[t],n.id==e)return n;return n=clone(curvoice),n.v=voice_tb.length,n.id=e,n.pos=clone(curvoice.pos),n.sym=n.last_sym=null,n.nm=null,n.snm=null,n.lyric_restart=n.lyric_restart=n.lyric_cont=null,voice_tb.push(n),n}var n,r,i,a,o,c,l=parse.line;if(!curvoice.ignore){if("|"==e||")"==e)return curvoice.last_sym.beam_end=!0,vover?(curvoice.time!=vover.mxtime&&l.error("Wrong duration in voice overlay"),curvoice=vover.p_voice,void(vover=null)):void l.error("Erroneous end of voice overlap");if("("==e)return vover?void l.error("Voice overlay already started"):void(vover={time:curvoice.time});if(!curvoice.last_note)return void l.error("No note before start of voice overlay");if(curvoice.last_note.beam_end=!0,n=curvoice.voice_down,!n){n=t(curvoice.id+"o"),curvoice.voice_down=n,n.time=0,n.second=!0,o=n.v,par_sy.voices[o]={st:curvoice.st,second:!0,scale:curvoice.scale,transpose:curvoice.transpose,key:curvoice.key,ckey:curvoice.ckey,okey:curvoice.okey,pos:n.pos};var u=void 0!=curvoice.clone?1:0;for(i=par_sy.voices[curvoice.v].range,a=0;a<par_sy.voices.length;a++)par_sy.voices[a].range>i&&(par_sy.voices[a].range+=u+1);par_sy.voices[o].range=i+1,u&&(r=t(n.id+"c"),r.second=!0,c=r.v,par_sy.voices[c]={second:!0,scale:curvoice.clone.scale,range:i+2},n.clone=r)}if(n.ulen=curvoice.ulen,curvoice.microscale&&(n.microscale=curvoice.microscale),vover)vover.p_voice?curvoice.time!=vover.mxtime&&l.error("Wrong duration in voice overlay"):(vover.mxtime=curvoice.time,vover.p_voice=curvoice);else{vover={bar:!0,mxtime:curvoice.time,p_voice:curvoice};var f=n.time;for(s=curvoice.last_sym;!(s.type==BAR||s.time<=f);s=s.prev);vover.time=s.time}n.time=vover.time,curvoice=n}}function is_voice_sig(){if(!curvoice.sym)return!0;if(0!=curvoice.time)return!1;for(s=curvoice.sym;s;s=s.next)switch(s.type){case TEMPO:case PART:case FORMAT:break;default:return!1}return!0}function get_clef(e){if(is_voice_sig())curvoice.clef=e;else{if(s2=curvoice.last_sym,s2&&s2.prev&&(s2.type==KEY&&!s2.k_none||s2.type==BAR)){for(s3=s2;s3.prev;s3=s3.prev){switch(s3.prev.type){case KEY:case BAR:continue}break}curvoice.last_sym=s3.prev,sym_link(e),e.next=s3,s3.prev=e,curvoice.last_sym=s2}else sym_link(e);e.clef_small=!0}}function set_voice_param(e){var t;cfmt.microscale&&(e.microscale=cfmt.microscale),void 0!=glovar.stafflines&&void 0==e.stafflines&&(e.stafflines=glovar.stafflines),glovar.staffscale&&(e.staffscale=glovar.staffscale),cfmt.transpose&&!e.transpose&&(e.transpose=cfmt.transpose);for(t in parse.voice_param)e[t]=parse.voice_param[t];e.wmeasure||(e.wmeasure=e.meter.wmeasure)}function get_key_clef(e){var t,n,r,s=e[0],i=clone(s),a=e[1];if(s.k_sf&&!s.k_exp&&s.k_a_acc&&set_k_acc(s),1==parse.state){for(void 0!=s.k_sf||s.k_a_acc||(s.k_sf=0),cfmt.transpose&&key_transp(s,cfmt.transpose),t=0;t<voice_tb.length;t++)n=voice_tb[t],n.ckey=s,n.key=clone(s),n.okey=i,n.clef=a||clone(glovar.clef),s.k_none&&(n.key.k_sf=0);return parse.okey=i,parse.ckey=s,a?glovar.clef=a:(glovar.clef.ctx=s.ctx,glovar.clef.istart=s.istart,glovar.clef.iend=s.iend),vskip(cfmt.topspace),write_heading(),reset_gen(),void(gene.nbar=cfmt.measurefirst)}return curvoice.transpose&&key_transp(s,curvoice.transpose),a&&get_clef(a),is_voice_sig()?((void 0!=s.k_sf||s.k_a_acc)&&(curvoice.ckey=s,curvoice.key=clone(s),s.k_none&&(curvoice.key.k_sf=0)),void(curvoice.okey=i)):void((void 0!=s.k_sf||s.k_a_acc)&&(s.k_old_sf=curvoice.ckey.k_sf,curvoice.okey=i,curvoice.ckey=s,r=curvoice.last_sym,r&&r.type==METER?(curvoice.last_sym=r.prev,curvoice.last_sym||(curvoice.sym=null),sym_link(s),s.next=r,r.prev=s,curvoice.last_sym=r):sym_link(s)))}function new_voice(e){var t,n,r=voice_tb.length;if(1==r&&voice_tb[0]["default"]&&(delete voice_tb[0]["default"],!voice_tb[0].last_sym))return t=voice_tb[0],t.id=e,t;for(n=0;r>n;n++)if(t=voice_tb[n],t.id==e)return t;return t={v:n,id:e,pos:clone(cfmt.pos),scale:cfmt.voicescale,combine:cfmt.voicecombine,ulen:glovar.ulen,key:clone(parse.ckey),ckey:clone(parse.ckey),okey:clone(parse.okey),meter:clone(glovar.meter),clef:clone(glovar.clef),hy_st:0},cfmt.voicemap&&(t.map=cfmt.voicemap),3==parse.state&&set_voice_param(t),voice_tb.push(t),par_sy.voices[n]={range:-1},t}function init_tune(){nstaff=-1,voice_tb=[],curvoice=null,par_sy=null,new_system(),staves_found=-1,parse.voice_param=null,gene={}}function get_voice(e){var t=parse_voice(e),n=curvoice.v;par_sy.voices[n].range<0&&(cfmt.alignbars&&parse.line.error("V: does not work with %%alignbars"),staves_found>=0&&(curvoice.ignore=!0)),t&&get_clef(t)}function goto_tune(){var e,t;for(0==voice_tb.length?(curvoice=new_voice("1"),curvoice.clef.istart=curvoice.key.istart,curvoice.clef.iend=curvoice.key.iend,nstaff=0,curvoice.time=0,curvoice["default"]=!0):curvoice=0>staves_found?voice_tb[0]:voice_tb[par_sy.top_voice],e=0;e<voice_tb.length;e++)t=voice_tb[e],t.ulen=glovar.ulen,t.key.k_bagpipe&&0==t.pos.ste&&(t.pos.ste=SL_BELOW),t.key.k_none&&(t.key.k_sf=0),set_voice_param(t);if(0>staves_found){for(nstaff=voice_tb.length-1,e=0;e<=nstaff;e++)t=voice_tb[e],t.st=t.cst=e,par_sy.voices[e].st=e,par_sy.voices[e].range=e,par_sy.staves[e]={stafflines:"|||||",staffscale:1};par_sy.nstaff=nstaff}parse.state=3,!curvoice.last_sym&&parse.voice_opts&&voice_filter()}function get_lyrics(e,t){var n,r,s,i,a;if(!curvoice.ignore){if(curvoice.pos.voc!=SL_HIDDEN&&(curvoice.have_ly=!0),t){if(n=curvoice.lyric_cont,!n)return void parse.line.error("+: lyric without music")}else if(set_font("vocal"),curvoice.lyric_restart?(curvoice.lyric_start=n=curvoice.lyric_restart,curvoice.lyric_restart=null,curvoice.lyric_line=0):(curvoice.lyric_line++,n=curvoice.lyric_start),n||(n=curvoice.sym),!n)return void parse.line.error("w: without music");for(s=e,i=0;;){for(;" "==s[i]||"	"==s[i];)i++;if(!s[i])break;switch(s[i]){case"|":for(;n&&n.type!=BAR;)n=n.next;if(!n)return void parse.line.error("Not enough bar lines for lyric line");n=n.next,i++;continue;case"-":r="-\n";break;case"_":r="_\n";break;case"*":r=null;break;default:if("\\"==s[i]&&i==s.length-1)return void(curvoice.lyric_cont=n);for(r="";;){if(!s[i])break;switch(s[i]){case"_":case"*":case"|":i--;case" ":case"	":break;case"~":r+=" ",i++;continue;case"-":r+="\n";break;case"\\":r+=s[++i],i++;continue;default:r+=s[i],i++;continue}break}}for(;n&&(n.type!=NOTE||n.grace);)n=n.next;if(!n)return void parse.line.error("Too many words in lyric line");r&&n.pos.voc!=SL_HIDDEN&&(r.match(/^\$\d/)&&(set_font("0"==r[1]?"vocal":"u"+r[1]),r=r.slice(2)),a={t:r,font:gene.curfont,w:strw(r)},n.a_ly||(n.a_ly=[]),n.a_ly[curvoice.lyric_line]=a),n=n.next,i++}curvoice.lyric_cont=n}}function ly_width(e,t){var n,r,s,i,a,o,c,l,u,f,d,p=e.a_ly;for(i=0,c=0;c<p.length;c++)if(n=p[c]){for(d=n.t,o=n.w,s=n.font.swfac,a=o+2*cwid(" ")*s,d[0]>="0"&&d[0]<="9"&&d.length>2||":"==d[1]||"("==d[0]||")"==d[0]?("("==d[0]?r=cwid("(")*s:(l=d.indexOf(" "),gene.curfont=gene.deffont=n.font,r=l>0?strw(d.slice(0,l)):o),f=.4*(o-r+2*cwid(" ")*s),f>20&&(f=20),f+=r,n.t[0]>="0"&&n.t[0]<="9"&&f>i&&(i=f)):"-\n"==d||"_\n"==d?f=0:(f=.4*a,f>20&&(f=20)),n.shift=f,f>t&&(t=f),a-=f,f=2*cwid(" ")*s,u=e.next;u;u=u.next){switch(u.type){case NOTE:case REST:if(u.a_ly&&u.a_ly[c]&&0!=u.a_ly[c].w){if("-\n"!=u.a_ly[c].t&&"_\n"!=u.a_ly[c].t)break;a-=f}else a-=9;if(0>=a)break;continue;case CLEF:case METER:case KEY:a-=10;continue;default:a-=5}break}a>e.wr&&(e.wr=a)}if(i>0)for(c=0;c<p.length;c++)n=p[c],n.t[0]>="0"&&n.t[0]<="9"&&(n.shift=i);return t}function draw_lyrics(e,t,n,r){var s,i,a,o,c,l,u,f,d,p,h,m,v,_,g,y;for(set_font("vocal"),_=gene.curfont,r>0?(s=0,n-=_.size,n>-cfmt.vocalspace&&(n=-cfmt.vocalspace)):(v=staff_tb[e.st].topbar,s=t-1,t=-1,n<v+cfmt.vocalspace-_.size&&(n=v+cfmt.vocalspace-_.size)),y=.25*_.size;s!=t;s+=r){for(m=n+y,e.hy_st&1<<s&&(d=!0,e.hy_st&=~(1<<s)),u=e.sym;u.type==CLEF||u.type==KEY||u.type==METER;u=u.next);for(u.prev?o=u.prev.x:tsfirst.x,h=0,l=1.1*_.size;u;u=u.next)if(f=u.a_ly?u.a_ly[s]:null)f.font!=_&&(gene.curfont=_=f.font,l<1.1*_.size&&(l=1.1*_.size)),a=f.t,c=f.w,g=f.shift,d&&("_\n"==a?a="-\n":"-\n"!=a&&(out_hyph(o,m,u.x-g-o),d=!1,o=u.x+u.wr)),p&&"_\n"!=a&&(out_wln(o+3,m,h-o+3),p=!1,o=u.x+u.wr),"-\n"!=a&&"_\n"!=a?(h=u.x-g,i=a.length-1,"\n"==a[i]&&(a=a.slice(0,i),d=!0),xy_str(h,m,a),o=h+c):(0==h&&o>u.x-18&&(o=u.x-18),"-"==a[0]?d=!0:p=!0,h=u.x-g);else switch(u.type){case REST:case MREST:p&&(out_wln(o+3,m,h-o),p=!1,o=u.x+u.wr)}for(d&&(d=!1,h=realwidth-10,o+10>h&&(h=o+10),out_hyph(o,m,h-o),cfmt.hyphencont&&(e.hy_st|=1<<s)),e.s_next;u;u=u.next)if(u.type==NOTE){if(!u.a_ly)break;f=u.a_ly[s],f&&"_\n"==f.t&&(p=!0,h=realwidth-15,o+12>h&&(h=o+12));break}p&&(out_wln(o+3,m,h-o+3),p=!1),r>0?n-=l:n+=l}return r>0&&(n+=l),n}function draw_all_lyrics(){var e,t,n,r,s,i,a,o,c=new Array(nstaff),l=new Array(voice_tb.length),u=new Array(voice_tb.length),f=new Array(voice_tb.length),d=0,p=0,h=-1;for(n=0;n<voice_tb.length;n++)if(e=voice_tb[n],e.sym){if(e.st!=h&&(d=0,p=0,h=e.st),r=0,e.have_ly)for(t=e.sym;t;t=t.next){var m=t.a_ly;m&&m[0]&&(i=t.x,0!=m[0].w?(i-=m[0].shift,o=m[0].w):o=10,a=y_get(e.st,1,i,o),a>d&&(d=a),a=y_get(e.st,0,i,o),p>a&&(p=a),r<m.length&&(r=m.length))}else a=y_get(e.st,1,0,realwidth),a>d&&(d=a),a=y_get(e.st,0,0,realwidth),p>a&&(p=a);c[h]||(c[h]={}),c[h].top=d,c[h].bot=p,l[n]=r,0!=r&&(0!=e.pos.voc?u[n]=e.pos.voc==SL_ABOVE:voice_tb[e.v+1]&&voice_tb[e.v+1].st==h&&voice_tb[e.v+1].have_ly?u[n]=!0:u[n]=!1,u[n]?c[h].a=!0:c[h].b=!0)}for(s=0,n=0;n<voice_tb.length;n++)e=voice_tb[n],e.sym&&e.have_ly&&(u[n]?f[s++]=n:(h=e.st,set_dscale(h),l[n]>0&&(c[h].bot=draw_lyrics(e,l[n],c[h].bot,1))));for(;--s>=0;)n=f[s],e=voice_tb[n],h=e.st,set_dscale(h),c[h].top=draw_lyrics(e,l[n],c[h].top,-1);for(n=0;n<voice_tb.length;n++)if(e=voice_tb[n],e.sym){if(h=e.st,c[h].a)for(d=c[h].top+2,t=e.sym.next;t;t=t.next)t.a_ly&&y_set(h,1,t.x-2,10,d);if(c[h].b)if(p=c[h].bot-2,l[e.v]>0)for(t=e.sym.next;t;t=t.next)t.a_ly&&y_set(h,0,t.x-2,10,p);else y_set(h,0,0,realwidth,p)}}function parse_gchord(e){var t,n,r=parse.line;if(e.length>1)n=e.slice(1,-1);else for(n="";;){if(t=r.next_char(),void 0==t)return void r.error("No end of guitar chord");if('"'==t)break;n+=t}gchord?gchord+="\n"+cnv_escape(n):gchord=cnv_escape(n)}function gch_acc(e,t,n){for(var r=1;;){if(r=e.indexOf(t,r),0>r)break;"\\"==e[r-1]?e=2==r||"/"==e[r-3]?e.slice(0,r-1)+e.slice(r):e.slice(0,r-1)+n+e.slice(r+1):(1==r||"/"==e[r-2])&&(e=e.slice(0,r)+n+e.slice(r+1)),r++}return e}function gch_tr1(e){var t,n,r,s,i,a,o,c,l,u;switch(n=0,e[0]){case"A":case"B":r=e.charCodeAt(0)-"A".charCodeAt(0)+5;break;case"C":case"E":case"G":r=e.charCodeAt(0)-"C".charCodeAt(0);break;case"D":if("o"==e[1]){n=1,r=0;break}r=1;break;case"F":"a"==e[1]&&(n=1),r=3;break;case"L":n=1,r=5;break;case"M":n=1,r=2;break;case"R":n=1,"e"!=e[1]&&n++,r=1;break;case"S":n=1,"o"==e[1]?(n++,r=4):r=6;break;default:return e}return c=0,l=n+1,"#"==e[l]?(c++,l++,"#"==e[l]&&(c++,l++)):"b"==e[l]?(c--,l++,"b"==e[l]&&(c--,l++)):"="==e[l]&&l++,i=curvoice.ckey.k_sf-curvoice.okey.k_sf,a=cde2fcg[r]+i+7*c,o=cgd2cde[(a+112)%7],s=(Math.floor((a+1+21)/7)+2-3+160)%5,t=n?latin_names[o]+acc_name[s]:note_names[o]+acc_name[s],u=e.indexOf("/",l),0>u?t+e.slice(l):(r=note_names.indexOf(e[++u]),0>r?t+e.slice(l):(t+=e.slice(l,u),"#"==e[++u]?(c=1,u++):"b"==e[u]?(c=-1,u++):c=0,a=cde2fcg[r]+i+7*c,o=cgd2cde[(a+112)%7],s=(Math.floor((a+1+21)/7)+2-3+160)%5,note_names[o]+acc_name[s]+e.slice(u)))}function gch_transp(e){for(var t,n,r=0;;){if(t=e.a_gch[r++],!t)return;if("g"==t.type)break}n=t.text,r=n.indexOf("	"),r>=0&&(r++,n=n.slice(0,r)+gch_tr1(n.slice(r))),t.text=gch_tr1(n,0)}function gch_build(e){if(curvoice.pos.gch!=SL_HIDDEN){var t,n,r,s,i,a,o,l,u=curvoice.pos.gch==SL_BELOW?-1:1,f=get_font("gchord"),d=get_font("annotation"),p=f.size,h=d.size,m=0,v=0,_=0,g=0,y=cfmt.gchordbox,b="\n";for(e.a_gch=[],t=new scanBuf,t.buffer=gchord,t.index=0;;){if(c=t["char"](),!c)break;switch(n={text:""},"n"!=b&&"^_<>@".indexOf(c)>=0?(antype=c,c=t.next_char(),"@"==antype&&(i=t.get_float(),c=t["char"](),","!=c?(error(1,e,'Error in annotation "@"'),a=0):(t.advance(),a=t.get_float(),c=t["char"]()," "==c&&(c=t.next_char())))):"\n"==b&&(antype="g"),"g"==antype?(n.font=f,n.box=y):n.font=d,n.type=antype,antype){default:if(0>u)break;m+=p,y&&(m+=2);break;case"^":m+=h;break;case"_":break;case"<":_+=.5*h;break;case">":g+=.5*h;break;case"@":n.x=i,n.y=a,a-=h}for(;;){switch(c){case"\\":if(c=t.next_char(),"n"==c)break;n.text+="\\";default:n.text+=c,c=t.next_char();continue;case"&":for(;;){switch(n.text+=c,c=t.next_char(),c){default:continue;case";":case void 0:case"\n":case"\\":}break}if(";"==c){n.text+=c,c=t.next_char();continue}break;case void 0:case";":case"\n":}break}if(e.a_gch.push(n),!c)break;b=c,t.advance()}curvoice.transpose&&gch_transp(e);const x=.4;for(l=e.a_gch.length,o=0;l>o;o++)if(n=e.a_gch[o],"g"==n.type&&(n.text.indexOf("#")&&(n.text=gch_acc(n.text,"#","â™¯")),n.text.indexOf("b")&&(n.text=gch_acc(n.text,"b","â™­")),n.text.indexOf("=")&&(n.text=gch_acc(n.text,"=","â™®"))),"@"!=n.type||user.anno_start)switch(gene.curfont=n.font,r=strw(n.text),n.w=r,n.type){case"@":break;case"_":s=r*x,s>8&&(s=8),n.x=-s,v-=h,n.y=v;break;case"^":s=r*x,s>8&&(s=8),n.x=-s,m-=h,n.y=m;break;default:s=r*x,s>8&&(s=8),n.x=-s,0>u?(v-=p,n.y=v,y&&(v-=2,n.y-=1)):(m-=p,n.y=m,y&&(m-=2,n.y-=1));break;case"<":n.x=-(r+6),_-=h,n.y=_;break;case">":n.x=6,g-=h,n.y=g}}}function draw_gchord(e,t,n){var r,s,i,a,o,c,l,u,f,d,p,m,v,_,g=e.a_gch[0].w,y=y_get(e.st,1,e.x-2,g),b=y_get(e.st,0,e.x-2,g),x=e.a_gch.length,w=e.yav||0;for(a=0;x>a&&(r=e.a_gch[a],!("g"==r.type&&(s=r,r.y<0)));a++);for(s&&(s.y>=0?n>y&&(y=n):b>t&&(b=t)),set_dscale(e.st),m=p=e.x,v=-100,_=100,f=0,a=0;x>a;a++){switch(r=e.a_gch[a],use_font(r.font),gene.curfont=gene.deffont=r.font,h=r.font.size,g=r.w,o=e.x+r.x,i=r.text,r.type){case"_":c=r.y+b,y_set(e.st,0,o,g,c-.2*h-2);break;case"^":c=r.y+y,y_set(e.st,1,o,g,c+.8*h+2);break;default:if(d=r.box?3:2,r.y>=0?(c=r.y+y,y_set(e.st,!0,o,g,c+h+d)):(c=r.y+b,y_set(e.st,!1,o,g,c-d)),r.box&&(p>o&&(p=o),g+=o,g>m&&(m=g),_>c&&(_=c),v<c+h&&(v=c+h),f++),l=i.indexOf("	"),l>=0){o=realwidth;for(var k=e.next;k;k=k.next){switch(k.type){default:continue;case NOTE:case REST:case BAR:o=k.x}break}for(u=2;l=i.indexOf("	",l+1),!(0>l);)u++;var E=(o-e.x)/u;for(o=e.x,user.anno_start&&user.anno_start("gchord",e.istart,e.iend,o-2,c+h+2,g+4,h+4),l=0,u=l;l=i.indexOf("	",u),!(0>l);)xy_str(o,c+.2*h,i.slice(u,l),"c"),o+=E,u=l+1;xy_str(o,c+.2*h,i.slice(u),"c"),user.anno_stop&&user.anno_stop("annot",e.istart,e.iend,e.x-2,c+h+2,g+4,h+4);continue}break;case"<":e.notes[0].acc&&(o-=e.notes[0].shac),c=r.y+w;break;case">":o+=e.xmx,e.dots>0&&(o+=1.5+3.5*e.dots),c=r.y+w;break;case"@":c=r.y+w,c>0?y_set(e.st,1,o,1,c+.8*h+3):y_set(e.st,0,o,1,c-.2*h)}user.anno_start&&user.anno_start("annot",e.istart,e.iend,o-2,c+h+2,g+4,h+4),xy_str(o,c+.2*h,i),user.anno_stop&&user.anno_stop("annot",e.istart,e.iend,o-2,c+h+2,g+4,h+4)}m!=p&&(p-=2,g=m-p,h=v-_+3,xybox(p,_-1+h,g,h))}function psdeco(e,t,n,r){return!1}function pshdeco(e,t,n,r){return!1}function psxygl(e,t,n){return!1}var wpsobj,svgobj;this.user=user;const BAR=0,CLEF=1,CUSTOS=2,FORMAT=3,GRACE=4,KEY=5,METER=6,MREST=7,NOTE=8,PART=9,REST=10,SPACE=11,STAVES=12,STBRK=13,TEMPO=14,TUPLET=15,BLOCK=16;SL_ABOVE=1,SL_BELOW=2,SL_AUTO=3,SL_HIDDEN=4,SL_DOTTED=8,OPEN_BRACE=1,CLOSE_BRACE=2,OPEN_BRACKET=4,CLOSE_BRACKET=8,OPEN_PARENTH=16,CLOSE_PARENTH=32,STOP_BAR=64,FL_VOICE=128,OPEN_BRACE2=256,CLOSE_BRACE2=512,OPEN_BRACKET2=1024,CLOSE_BRACKET2=2048,MASTER_VOICE=4096,BASE_LEN=1536,CM=37.8,IN=96,YSTEP=128;var glovar={clef:{type:CLEF,clef_auto:!0,clef_type:"a"},meter:{type:METER,wmeasure:1,a_meter:[]}},info={},parse={ctx:{},prefix:"%",state:0},dd_tb={},a_de=[];const std_deco_tb=["dot 0 stc 5 1 1","tenuto 0 emb 5 2 2","slide 1 sld 3 7 0","arpeggio 2 arp 12 10 0","roll 3 cpu 7 6 6","fermata 3 hld 12 7 7","emphasis 3 accent 7 4 4","lowermordent 3 lmrd 10 2 2","coda 3 coda 24 10 10","uppermordent 3 umrd 10 2 2","segno 3 sgno 20 4 4","trill 3 trl 14 4 4","upbow 3 upb 10 5 5","downbow 3 dnb 9 5 5","gmark 3 grm 6 5 5","wedge 3 wedge 8 1 1","turnx 3 turnx 10 0 5","breath 3 brth 0 1 20","longphrase 3 lphr 0 1 1","mediumphrase 3 mphr 0 1 1","shortphrase 3 sphr 0 1 1","invertedfermata 3 hld 12 7 7","invertedturn 3 turn 10 0 5","invertedturnx 3 turnx 10 0 5","0 3 fng 8 3 3 0","1 3 fng 8 3 3 1","2 3 fng 8 3 3 2","3 3 fng 8 3 3 3","4 3 fng 8 3 3 4","5 3 fng 8 3 3 5","plus 3 dplus 7 3 3","+ 3 dplus 7 3 3","accent 3 accent 6 4 4","> 3 accent 6 4 4","marcato 3 marcato 9 3 3","^ 3 marcato 9 3 3","mordent 3 lmrd 10 2 2","open 3 opend 10 2 2","snap 3 snap 14 3 3","thumb 3 thumb 14 2 2","D.C. 3 dacs 16 10 10 D.C.","D.S. 3 dacs 16 10 10 D.S.","fine 3 dacs 16 10 10 FINE","f 6 pf 18 1 7","ff 6 pf 18 2 10","fff 6 pf 18 4 13","ffff 6 pf 18 6 16","mf 6 pf 18 6 13","mp 6 pf 18 6 16","p 6 pf 18 2 8","pp 6 pf 18 5 14","ppp 6 pf 18 8 20","pppp 6 pf 18 10 25","pralltriller 3 umrd 10 2 2",'sfz 6 sfz 18 4 10 ""',"turn 3 turn 10 0 5","trill( 5 ltr 8 0 0","trill) 5 ltr 8 0 0","crescendo( 7 cresc 18 0 0","crescendo) 7 cresc 18 0 0","<( 7 cresc 18 0 0","<) 7 cresc 18 0 0","diminuendo( 7 dim 18 0 0","diminuendo) 7 dim 18 0 0",">( 7 dim 18 0 0",">) 7 dim 18 0 0","invisible 32 0 0 0 0","beamon 33 0 0 0 0","trem1 34 0 0 0 0","trem2 34 0 0 0 0","trem3 34 0 0 0 0","trem4 34 0 0 0 0","xstem 35 0 0 0 0","beambr1 36 0 0 0 0","beambr2 36 0 0 0 0","rbstop 37 0 0 0 0","/ 38 0 0 6 6","// 38 0 0 6 6","/// 38 0 0 6 6","beam-accel 39 0 0 0 0","beam-rall 39 0 0 0 0","stemless 40 0 0 0 0","rbend 41 0 0 0 0"];var user_deco_tb,first_note;const func_tb=[d_near,d_slide,d_arp,d_upstaff,d_upstaff,d_trill,d_pf,d_cresc],STEM_MIN=16,STEM_MIN2=14,STEM_MIN3=12,STEM_MIN4=10,STEM_CH_MIN=14,STEM_CH_MIN2=10,STEM_CH_MIN3=9,STEM_CH_MIN4=9,BEAM_DEPTH=3.2,BEAM_OFFSET=.25,BEAM_SHIFT=5,BEAM_FLATFAC=.6,BEAM_THRESH=.06,BEAM_SLOPE=.5,BEAM_STUB=6,SLUR_SLOPE=1,GSTEM=14,GSTEM_XOFF=1.6,min_tb=[[STEM_MIN,STEM_MIN,STEM_MIN2,STEM_MIN3,STEM_MIN4,STEM_MIN4],[STEM_CH_MIN,STEM_CH_MIN,STEM_CH_MIN2,STEM_CH_MIN3,STEM_CH_MIN4,STEM_CH_MIN4]],sharp_cl=[24,9,15,21,6,12,18],flat_cl=[12,18,24,9,15,21,6],sharp1=[-9,12,-9,-9,12,-9],sharp2=[12,-9,12,-9,12,-9],flat1=[9,-12,9,-12,9,-12],flat2=[-12,9,-12,9,-12,9],rest_tb=["r128","r64","r32","r16","r8","r4","r2","r1","r0","r00"];var defined_font={},font_tb={},fid=1,font_scale_tb={serif:1.05,serifBold:1.05,"sans-serif":1.1,"sans-serifBold":1.15,Palatino:1.1,Mono:1.35},lock={},cfmt={aligncomposer:1,breaklimit:.7,breakoneoln:!0,composerspace:6,dblrepbar:":][:",decoerr:!0,dynalign:!0,fullsvg:"",gracespace:[6.5,8,12],graceslurs:!0,hyphencont:!0,indent:0,infoname:'R "Rhythm: "\nB "Book: "\nS "Source: "\nD "Discography: "\nN "Notes: "\nZ "Transcription: "\nH "History: "',infospace:0,keywarn:!0,leftmargin:.7*IN,lineskipfac:1.1,linewarn:!0,maxshrink:.65,maxstaffsep:2e3,maxsysstaffsep:2e3,measurefirst:1,measurenb:-1,musicspace:6,parskipfac:.4,partsspace:8,pagewidth:21*CM,pos:{dyn:0,gch:0,gst:0,
orn:0,ste:0,voc:0,vol:0},rightmargin:.7*IN,rbmax:4,rbmin:2,scale:1,slurheight:1,staffnonote:1,staffsep:46,stemheight:21,stretchlast:.25,stretchstaff:!0,subtitlespace:3,sysstaffsep:34,textspace:14,titlespace:6,titletrim:!0,transpose:0,topspace:22,tuplets:[0,0,0],vocalspace:23,voicecombine:0,voicescale:1,writefields:"CMOPQTWw",wordsspace:5};const textopt={align:"j",center:"c",fill:"f",justify:"j",ragged:"f",right:"r",skip:"s"},posval={above:SL_ABOVE,below:SL_BELOW,down:SL_BELOW,hidden:SL_HIDDEN,opposite:SL_HIDDEN,up:SL_ABOVE};var abc_utf={"`A":"Ã€","`E":"Ãˆ","`I":"ÃŒ","`O":"Ã’","`U":"Ã™","`a":"Ã ","`e":"Ã¨","`i":"Ã¬","`o":"Ã²","`u":"Ã¹","'A":"Ã","'E":"Ã‰","'I":"Ã","'O":"Ã“","'U":"Ãš","'Y":"Ã","'a":"Ã¡","'e":"Ã©","'i":"Ã­","'o":"Ã³","'u":"Ãº","'y":"Ã½","'S":"Åš","'Z":"Å¹","'s":"Å›","'z":"Åº","'R":"Å”","'L":"Ä¹","'C":"Ä†","'N":"Åƒ","'r":"Å•","'l":"Äº","'c":"Ä‡","'n":"Å„","^A":"Ã‚","^E":"ÃŠ","^I":"ÃŽ","^O":"Ã”","^U":"Ã›","^a":"Ã¢","^e":"Ãª","^i":"Ã®","^o":"Ã´","^u":"Ã»","^H":"Ä¤","^J":"Ä´","^h":"Ä¥","^j":"Äµ","^C":"Äˆ","^G":"Äœ","^S":"Åœ","^c":"Ä‰","^g":"Ä","^s":"Å",",C":"Ã‡",",c":"Ã§",",S":"Åž",",s":"ÅŸ",",T":"Å¢",",t":"Å£",",R":"Å–",",L":"Ä»",",G":"Ä¢",",r":"Å—",",l":"Ä¼",",g":"Ä£",",N":"Å…",",K":"Ä¶",",n":"Å†",",k":"Ä·",'"A':"Ã„",'"E':"Ã‹",'"I':"Ã",'"O':"Ã–",'"U':"Ãœ",'"Y':"Å¸",'"a':"Ã¤",'"e':"Ã«",'"i':"Ã¯",'"o':"Ã¶",'"u':"Ã¼",'"y':"Ã¿","~A":"Ãƒ","~N":"Ã‘","~O":"Ã•","~a":"Ã£","~n":"Ã±","~o":"Ãµ","~I":"Ä¨","~i":"Ä©","~U":"Å¨","~u":"Å©",oA:"Ã…",oa:"Ã¥",oU:"Å®",ou:"Å¯","=A":"Ä€","=D":"Ä","=E":"Ä’","=H":"Ä¦","=I":"Äª","=O":"ÅŒ","=T":"Å¦","=U":"Åª","=a":"Ä","=d":"Ä‘","=e":"Ä“","=h":"Ä§","=i":"Ä«","=o":"Å","=t":"Å§","=u":"Å«","/O":"Ã˜","/o":"Ã¸","/D":"Ä","/d":"Ä‘","/L":"Å","/l":"Å‚",";A":"Ä„",";E":"Ä˜",";I":"Ä®",";U":"Å²",";a":"Ä…",";e":"Ä™",";i":"Ä¯",";u":"Å³",vL:"Ä½",vS:"Å ",vT:"Å¤",vZ:"Å½",vl:"Ä¾",vs:"Å¡",vt:"Å¥",vz:"Å¾",vC:"ÄŒ",vE:"Äš",vD:"ÄŽ",vN:"Å‡",vR:"Å˜",vc:"Ä",ve:"Ä›",vd:"Ä",vn:"Åˆ",vr:"Å™",uA:"Ä‚",ua:"Äƒ",uE:"Ä”",ue:"Ä•",uG:"Äž",ug:"ÄŸ",uI:"Ä¬",ui:"Ä­",uO:"ÅŽ",uo:"Å",uU:"Å¬",uu:"Å­",":O":"Å",":U":"Å°",":o":"Å‘",":u":"Å±",".Z":"Å»",".z":"Å¼",".I":"Ä°",".i":"Ä±",".C":"ÄŠ",".c":"Ä‹",".G":"Ä ",".g":"Ä¡",".E":"Ä–",".e":"Ä—",AA:"Ã…",aa:"Ã¥",AE:"Ã†",ae:"Ã¦",cc:"Ã§",cC:"Ã‡",DH:"Ã",dh:"Ã°",ng:"Å‹",OE:"Å’",oe:"Å“",ss:"ÃŸ",TH:"Ãž",th:"Ã¾"},include=2;Abc.prototype.tosvg=tosvg;var gene,staff_tb,tsnext,realwidth,insert_meter,beta_last,space_tb=[7,10,14.15,20,28.3,40,56.6,80,113,150],smallest_duration;const dx_tb={full:9,empty:10,oval:12,square:15.3},delta_tb={t:-4,c:0,b:4,p:-6},rest_sp=[[18,18],[12,18],[12,12],[8,12],[6,8],[10,10],[6,4],[10,0],[10,4],[10,10]],delpit=[0,-7,-14,0],w_note={full:3.5,empty:3.7,oval:5,square:7},MAXPIT=96;var gchord,a_dcn,multicol,maps;const not_ascii="Not an ASCII character";var pit_st=[0,2,4,5,7,9,11],nil="0",char_tb=[nil,nil,nil,nil,nil,nil,nil,nil,nil," ","\n",nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil," ","!",'"',nil,"\n",nil,"&",nil,"(",")",nil,nil,nil,"-","!dot!",nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,"|",nil,"<","n","<",nil,nil,"n","n","n","n","n","n","n","!fermata!","d","d","d","!emphasis!","!lowermordent!","d","!coda!","!uppermordent!","d","d","!segno!","!trill!","d","d","d","n","d","n","[","\\","|","n","n","i","n","n","n","n","n","n","n","d","d","d","d","d","d","d","d","d","d","d","d","d","!upbow!","!downbow!","d","n","n","n","{","|","}","!roll!",nil],cw_tb=[.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.25,.333,.408,.5,.5,.833,.778,.333,.333,.333,.5,.564,.25,.564,.25,.278,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.278,.278,.564,.564,.564,.444,.921,.722,.667,.667,.722,.611,.556,.722,.722,.333,.389,.722,.611,.889,.722,.722,.556,.722,.667,.556,.611,.722,.722,.944,.722,.722,.611,.333,.278,.333,.469,.5,.333,.444,.5,.444,.5,.444,.333,.5,.5,.278,.278,.5,.278,.778,.5,.5,.5,.5,.333,.389,.278,.5,.5,.722,.5,.5,.444,.48,.2,.48,.541,.5],info_font_init={A:"info",C:"composer",O:"composer",P:"parts",Q:"tempo",R:"info",T:"title",X:"title"},output=[],style="\n.fill {fill: currentColor}\n.stroke {stroke: currentColor; fill: none}",font_style="",posy=0,posx=cfmt.leftmargin/cfmt.scale,defined_glyph={},defs="",stv_g={scale:1,dy:0,st:-1,v:0},block={},glyphs={brace:'<path id="brace" class="fill" transform="scale(0.0235)"\n	d="M-20 -515v-2\n	c35 -16 53 -48 53 -91\n	c0 -34 -11 -84 -35 -150\n	c-13 -41 -18 -76 -18 -109\n	c0 -69 29 -121 87 -160\n	c-44 35 -63 77 -63 125\n	c0 26 8 56 21 91\n	c27 71 37 130 37 174\n	c0 62 -26 105 -77 121\n	c52 16 77 63 77 126\n	c0 46 -10 102 -37 172\n	c-13 35 -21 68 -21 94\n	c0 48 19 89 63 124\n	c-58 -39 -87 -91 -87 -160\n	c0 -33 5 -68 18 -109\n	c24 -66 35 -116 35 -150\n	c0 -44 -18 -80 -53 -96z"/>',utclef:'<path id="utclef" class="fill" transform="scale(0.045)"\n	d="m-50 44\n	c-72 -41 -72 -158 52 -188\n	150 -10 220 188 90 256\n	-114 52 -275 0 -293 -136\n	-15 -181 93 -229 220 -334\n	88 -87 79 -133 62 -210\n	-51 33 -94 105 -89 186\n	17 267 36 374 49 574\n	6 96 -19 134 -77 135\n	-80 1 -126 -93 -61 -133\n	85 -41 133 101 31 105\n	23 17 92 37 90 -92\n	-10 -223 -39 -342 -50 -617\n	0 -90 0 -162 96 -232\n	56 72 63 230 22 289\n	-74 106 -257 168 -255 316\n	9 153 148 185 252 133\n	86 -65 29 -192 -80 -176\n	-71 12 -105 67 -59 124"/>',tclef:'<use id="tclef" xlink:href="#utclef"/>',stclef:'<use id="stclef" transform="scale(0.8)"\n	xlink:href="#utclef"/>',ubclef:'<path id="ubclef" class="fill" transform="scale(0.045)"\n	d="m-200 312\n	c124 -35 222 -78 254 -236\n	43 -228 -167 -246 -192 -103\n	59 -80 157 22 92 78\n	-62 47 -115 -22 -106 -88\n	21 -141 270 -136 274 52\n	-1 175 -106 264 -322 297\n	m357 -250\n	c0 -36 51 -34 51 0\n	0 37 -51 36 -51 0\n	m-2 -129\n	c0 -36 51 -34 51 0\n	0 38 -51 37 -51 0"/>',bclef:'<use id="bclef" xlink:href="#ubclef"/>',sbclef:'<use id="sbclef" transform="scale(0.8)"\n	xlink:href="#ubclef"/>',ucclef:'<path id="ucclef" class="fill" transform="scale(0.045)"\n	d="m-51 3\n	v262\n	h-13\n	v-529\n	h13\n	v256\n	c25 -20 41 -36 63 -109\n	14 31 13 51 56 70\n	90 34 96 -266 -41 -185\n	52 19 27 80 -11 77\n	-90 -38 33 -176 139 -69\n	72 79 1 241 -134 186\n	l-16 39 16 38\n	c135 -55 206 107 134 186\n	-106 108 -229 -31 -139 -69\n	38 -3 63 58 11 77\n	137 81 131 -219 41 -185\n	-43 19 -45 30 -56 64\n	-22 -73 -38 -89 -63 -109\n	m-99 -267\n	h57\n	v529\n	h-57\n	v-529"/>',cclef:'<use id="cclef" xlink:href="#ucclef"/>',scclef:'<use id="scclef" transform="scale(0.8)"\n	xlink:href="#ucclef"/>',pclef:'<path id="pclef" class="stroke" stroke-width="1.4"\n	d="m-4 10h5.4v-20h-5.4v20"/>',hd:'<ellipse id="hd" rx="4.1" ry="2.9"\n	transform="rotate(-20)" class="fill"/>',Hd:'<path id="Hd" class="fill" d="m3 -1.6\n	c-1 -1.8 -7 1.4 -6 3.2\n	1 1.8 7 -1.4 6 -3.2\n	m0.5 -0.3\n	c2 3.8 -5 7.6 -7 3.8\n	-2 -3.8 5 -7.6 7 -3.8"/>',HD:'<path id="HD" class="fill" d="m-2.7 -1.4\n	c1.5 -2.8 6.9 0 5.3 2.7\n	-1.5 2.8 -6.9 0 -5.3 -2.7\n	m8.3 1.4\n	c0 -1.5 -2.2 -3 -5.6 -3\n	-3.4 0 -5.6 1.5 -5.6 3\n	0 1.5 2.2 3 5.6 3\n	3.4 0 5.6 -1.5 5.6 -3"/>',HDD:'<g id="HDD">\n	<use xlink:href="#HD"/>\n	<path d="m-6 -4v8m12 0v-8" class="stroke"/>\n</g>',breve:'<g id="breve" class="stroke">\n	<path d="m-6 -2.7h12m0 5.4h-12" stroke-width="2.5"/>\n	<path d="m-6 -5v10m12 0v-10"/>\n</g>',longa:'<g id="longa" class="stroke">\n	<path d="m-6 2.7h12m0 -5.4h-12" stroke-width="2.5"/>\n	<path d="m-6 5v-10m12 0v16"/>\n</g>',ghd:'<use id="ghd" transform="translate(4.5,0) scale(0.5)" xlink:href="#hd"/>',r00:'<rect id="r00" class="fill"\n	x="-1.6" y="-6" width="3" height="12"/>',r0:'<rect id="r0" class="fill"\n	x="-1.6" y="-6" width="3" height="6"/>',r1:'<rect id="r1" class="fill"\n	x="-3.5" y="-6" width="7" height="3"/>',r2:'<rect id="r2" class="fill"\n	x="-3.5" y="-3" width="7" height="3"/>',r4:'<path id="r4" class="fill" d="m-1 -8.5\n	l3.6 5.1 -2.1 5.2 2.2 4.3\n	c-2.6 -2.3 -5.1 0 -2.4 2.6\n	-4.8 -3 -1.5 -6.9 1.4 -4.1\n	l-3.1 -4.5 1.9 -5.1 -1.5 -3.5"/>',r8e:'<path id="r8e" class="fill" d="m 0 0\n	c-1.5 1.5 -2.4 2 -3.6 2\n	2.4 -2.8 -2.8 -4 -2.8 -1.2\n	0 2.7 4.3 2.4 5.9 0.6"/>',r8:'<g id="r8">\n	<path d="m3.3 -4l-3.4 9.6" class="stroke"/>\n	<use x="3.4" y="-4" xlink:href="#r8e"/>\n</g>',r16:'<g id="r16">\n	<path d="m3.3 -4l-4 15.6" class="stroke"/>\n	<use x="3.4" y="-4" xlink:href="#r8e"/>\n	<use x="1.9" y="2" xlink:href="#r8e"/>\n</g>',r32:'<g id="r32">\n	<path d="m4.8 -10l-5.5 21.6" class="stroke"/>\n	<use x="4.9" y="-10" xlink:href="#r8e"/>\n	<use x="3.4" y="-4" xlink:href="#r8e"/>\n	<use x="1.9" y="2" xlink:href="#r8e"/>\n</g>',r64:'<g id="r64">\n	<path d="m4.8 -10 l-7 27.6" class="stroke"/>\n	<use x="4.9" y="-10" xlink:href="#r8e"/>\n	<use x="3.4" y="-4" xlink:href="#r8e"/>\n	<use x="1.9" y="2" xlink:href="#r8e"/>\n	<use x="0.4" y="8" xlink:href="#r8e"/>\n</g>',r128:'<g id="r128">\n	<path d="m5.8 -16 l-8.5 33.6" class="stroke"/>\n	<use x="5.9" y="-16" xlink:href="#r8e"/>\n	<use x="4.4" y="-10" xlink:href="#r8e"/>\n	<use x="2.9" y="-4" xlink:href="#r8e"/>\n	<use x="1.4" y="2" xlink:href="#r8e"/>\n	<use x="0.1" y="8" xlink:href="#r8e"/>\n</g>',mrest:'<g id="mrest" class="stroke">\n	<path d="m-10 6v-12m20 0v12"/>\n	<path d="m-10 0h20" stroke-width="5"/>\n</g>',usharp:'<path id="usharp" class="fill" d="m136 -702\n	v890\n	h32\n	v-890\n	m128 840\n	h32\n	v-888\n	h-32\n	m-232 286\n	v116\n	l338 -96\n	v-116\n	m-338 442\n	v116\n	l338 -98\n	v-114"/>',uflat:'<path id="uflat" class="fill" d="m100 -746\n	h32\n	v734\n	l-32 4\n	m32 -332\n	c46 -72 152 -90 208 -20\n	100 110 -120 326 -208 348\n	m0 -28\n	c54 0 200 -206 130 -290\n	-50 -60 -130 -4 -130 34"/>',unat:'<path id="unat" class="fill" d="m96 -750\n	h-32\n	v716\n	l32 -8\n	l182 -54\n	v282\n	h32\n	v-706\n	l-34 10\n	l-180 50\n	v-290\n	m0 592\n	v-190\n	l182 -52\n	v188"/>',udblesharp:'<path id="udblesharp" class="fill" d="m240 -282\n	c40 -38 74 -68 158 -68\n	v-96\n	h-96\n	c0 84 -30 118 -68 156\n	-40 -38 -70 -72 -70 -156\n	h-96\n	v96\n	c86 0 120 30 158 68\n	-38 38 -72 68 -158 68\n	v96\n	h96\n	c0 -84 30 -118 70 -156\n	38 38 68 72 68 156\n	h96\n	v-96\n	c-84 0 -118 -30 -158 -68"/>',udbleflat:'<path id="udbleflat" class="fill" d="m20 -746\n	h24\n	v734\n	l-24 4\n	m24 -332\n	c34 -72 114 -90 156 -20\n	75 110 -98 326 -156 348\n	m0 -28\n	c40 0 150 -206 97 -290\n	-37 -60 -97 -4 -97 34\n	m226 -450\n	h24\n	v734\n	l-24 4\n	m24 -332\n	c34 -72 114 -90 156 -20\n	75 110 -98 326 -156 348\n	m0 -28\n	c40 0 150 -206 97 -290\n	-37 -60 -97 -4 -97 34"/>',acc1:'<use id="acc1" transform="translate(-4,5) scale(0.018)" xlink:href="#usharp"/>',"acc-1":'<use id="acc-1" transform="translate(-3.5,3.5) scale(0.018)" xlink:href="#uflat"/>',acc3:'<use id="acc3" transform="translate(-3,5) scale(0.018)" xlink:href="#unat"/>',acc2:'<use id="acc2" transform="translate(-4,5) scale(0.018)"\n	xlink:href="#udblesharp"/>',"acc-2":'<use id="acc-2" transform="translate(-4,3.5) scale(0.018)"\n	xlink:href="#udbleflat"/>',acc1_1_4:'<g id="acc1_1_4">\n	<path d="m0 7.8v-15.4" class="stroke"/>\n	<path class="fill" d="M-1.8 2.7l3.6 -1.1v2.2l-3.6 1.1v-2.2z\n		M-1.8 -3.7l3.6 -1.1v2.2l-3.6 1.1v-2.2"/>\n</g>',acc1_3_4:'<g id="acc1_3_4">\n	<path d="m-2.5 8.7v-15.4M0 7.8v-15.4M2.5 6.9v-15.4" class="stroke"/>\n	<path class="fill" d="m-3.7 3.1l7.4 -2.2v2.2l-7.4 2.2v-2.2z\n		M-3.7 -3.2l7.4 -2.2v2.2l-7.4 2.2v-2.2"/>\n</g>',"acc-1_1_4":'<g id="acc-1_1_4" transform="scale(-1,1)">\n	<use xlink:href="#acc-1"/>\n</g>',"acc-1_3_4":'<g id="acc-1_3_4">\n    <path class="fill" d="m0.6 -2.7\n	c-5.7 -3.1 -5.7 3.6 0 6.7c-3.9 -4 -4 -7.6 0 -5.8\n	M1 -2.7c5.7 -3.1 5.7 3.6 0 6.7c3.9 -4 4 -7.6 0 -5.8"/>\n    <path d="m1.6 3.5v-13M0 3.5v-13" class="stroke" stroke-width=".6"/>\n</g>',pshhd:'<use id="pshhd" xlink:href="#acc2"/>',pfthd:'<g id="pfthd">\n	<use xlink:href="#acc2"/>\n	<circle r="4" class="stroke"/>\n</g>',csig:'<path id="csig" class="fill" transform="scale(0.0235, 0.0235)"\n	d="M303 -161\n	c8 1 12 2 18 3\n	c3 -4 4 -9 4 -13\n	c0 -28 -52 -54 -91 -54\n	c-61 2 -115 58 -115 210\n	c0 76 7 151 39 193\n	c23 29 49 42 81 42\n	c26 0 55 -10 83 -34\n	s47 -64 70 -112\n	c0 3 18 6 17 9\n	c-33 103 -76 164 -198 166\n	c-50 0 -100 -20 -138 -57\n	c-39 -38 -60 -91 -63 -159\n	c0 -4 -1 -43 -1 -47\n	c0 -168 88 -231 219 -232\n	c52 0 97 27 117 50\n	s34 49 34 75\n	c0 47 -25 94 -64 94\n	c-45 0 -73 -39 -73 -74\n	c2 -26 23 -60 60 -60h1z"/>',ctsig:'<g id="ctsig">\n	<use xlink:href="#csig"/>\n	<path d="m5 8v-16" class="stroke"/>\n</g>',pmsig:'<path id="pmsig" class="stroke" stroke-width="0.8"\n	d="m0 -7a5 5 0 0 1 0 -10a5 5 0 0 1 0 10"/>',pMsig:'<g id="pMsig">\n	<use xlink:href="#pmsig"/>\n	<path class="fill" d="m0 -10a2 2 0 0 1 0 -4a2 2 0 0 1 0 4"/>\n</g>',imsig:'<path id="imsig" class="stroke" stroke-width="0.8"\n	d="m0 -7a5 5 0 1 1 0 -10"/>',iMsig:'<g id="iMsig">\n	<use xlink:href="#imsig"/>\n	<path class="fill" d="m0 -10a2 2 0 0 1 0 -4a2 2 0 0 1 0 4"/>\n</g>',hl:'<path id="hl" class="stroke" d="m-6 0h12"/>',hl1:'<path id="hl1" class="stroke" d="m-7 0h14"/>',hl2:'<path id="hl2" class="stroke" d="m-9 0h18"/>',ghl:'<path id="ghl" class="stroke" d="m-3 0h6"/>',rdots:'<g id="rdots" class="fill">\n	<circle cx="0" cy="-9" r="1.2"/>\n	<circle cx="0" cy="-15" r="1.2"/>\n</g>',srep:'<path id="srep" class="fill" d="m-1 -6l11 -12h3l-11 12h-3"/>',mrep:'<path id="mrep" class="fill"\n    d="m-5 -16.5a1.5 1.5 0 0 1 0 3a1.5 1.5 0 0 1 0 -3\n	M4.5 -10a1.5 1.5 0 0 1 0 3a1.5 1.5 0 0 1 0 -3\n	M-7 -6l11 -12h3l-11 12h-3"/>',mrep2:'<g id="mrep2">\n    <path d="m-5.5 -19.5a1.5 1.5 0 0 1 0 3a1.5 1.5 0 0 1 0 -3\n	M5 -7.5a1.5 1.5 0 0 1 0 3a1.5 1.5 0 0 1 0 -3" class="fill"/>\n    <path d="m-7 -4l14 -10m-14 4l14 -10" class="stroke" stroke-width="1.8"/>\n</g>',accent:'<g id="accent" class="stroke">\n	<path d="m-4 0l8 -2l-8 -2" stroke-width="1.2"/>\n</g>',marcato:'<path id="marcato" d="m-3 0l3 -7l3 7l-1.5 0l-1.8 -4.2l-1.7 4.2"/>',umrd:'<path id="umrd" class="fill" d="m0 -4\n	l2.2 -2.2 2.1 2.9 0.7 -0.7 0.2 0.2\n	-2.2 2.2 -2.1 -2.9 -0.7 0.7\n	-2.2 2.2 -2.1 -2.9 -0.7 0.7 -0.2 -0.2\n	2.2 -2.2 2.1 2.9 0.7 -0.7"/>',lmrd:'<g id="lmrd">\n	<use xlink:href="#umrd"/>\n	<line x1="0" y1="0" x2="0" y2="-8" class="stroke" stroke-width=".6"/>\n</g>',grm:'<path id="grm" class="fill" d="m-5 -2.5\n	c5 -8.5 5.5 4.5 10 -2\n	-5 8.5 -5.5 -4.5 -10 2"/>',stc:'<circle id="stc" class="fill" cx="0" cy="-3" r="1.2"/>',sld:'<path id="sld" class="fill" d="m-7.2 4.8\n	c1.8 0.7 4.5 -0.2 7.2 -4.8\n	-2.1 5 -5.4 6.8 -7.6 6"/>',emb:'<path id="emb" class="stroke" stroke-width="1.2" stroke-linecap="round"\n	d="m-2.5 -3h5"/>',hld:'<g id="hld" class="fill">\n    <circle cx="0" cy="-3" r="1.3"/>\n    <path d="m-7.5 -1.5\n	c0 -11.5 15 -11.5 15 0\n	h-0.25\n	c-1.25 -9 -13.25 -9 -14.5 0"/>\n</g>',brth:'<text id="brth" y="-6" style="font:bold italic 30px serif">,</text>',cpu:'<path id="cpu" class="fill" d="m-6 0\n	c0.4 -7.3 11.3 -7.3 11.7 0\n	-1.3 -6 -10.4 -6 -11.7 0"/>',upb:'<path id="upb" class="stroke" d="m-2.6 -9.4\n	l2.6 8.8\n	l2.6 -8.8"/>',dnb:'<g id="dnb">\n	<path d="M-3.2 -2v-7.2m6.4 0v7.2" class="stroke"/>\n	<path d="M-3.2 -6.8v-2.4l6.4 0v2.4" class="fill"/>\n</g>',sgno:'<g id="sgno">\n    <path class="fill" d="m0 -3\n	c1.5 1.7 6.4 -0.3 3 -3.7\n	-10.4 -7.8 -8 -10.6 -6.5 -11.9\n	4 -1.9 5.9 1.7 4.2 2.6\n	-1.3 0.7 -2.9 -1.3 -0.7 -2\n	-1.5 -1.7 -6.4 0.3 -3 3.7\n	10.4 7.8 8 10.6 6.5 11.9\n	-4 1.9 -5.9 -1.7 -4.2 -2.6\n	1.3 -0.7 2.9 1.3 0.7 2"/>\n    <line x1="-6" y1="-4.2" x2="6.6" y2="-16.8" class="stroke"/>\n    <circle cx="-6" cy="-10" r="1.2"/>\n    <circle cx="6" cy="-11" r="1.2"/>\n</g>',coda:'<g id="coda" class="stroke">\n	<path d="m0 -2v-20m-10 10h20"/>\n	<circle cx="0" cy="-12" r="6" stroke-width="1.7"/>\n</g>',dplus:'<path id="dplus" class="stroke" stroke-width="1.7"\n	d="m0 -0.5v-6m-3 3h6"/>',lphr:'<path id="lphr" class="stroke" stroke-width="1.2"\n	d="m0 0v18"/>',mphr:'<path id="mphr" class="stroke" stroke-width="1.2"\n	d="m0 0v12"/>',sphr:'<path id="sphr" class="stroke" stroke-width="1.2"\n	d="m0 0v6"/>',sfz:'<text id="sfz" x="-5" y="-7" style="font:italic 14px serif">\n	s<tspan font-size="16" font-weight="bold">f</tspan>z</text>',trl:'<text id="trl" x="-2" y="-4"\n	style="font:bold italic 16px serif">tr</text>',opend:'<circle id="opend" class="stroke"\n	cx="0" cy="-3" r="2.5"/>',snap:'<path id="snap" class="stroke" d="m-3 -6\n	c0 -5 6 -5 6 0\n	0 5 -6 5 -6 0\n	M0 -5v6"/>',thumb:'<path id="thumb" class="stroke" d="m-2.5 -7\n	c0 -6 5 -6 5 0\n	0 6 -5 6 -5 0\n	M-2.5 -9v4"/>',turn:'<path id="turn" class="fill" d="m5.2 -8\n	c1.4 0.5 0.9 4.8 -2.2 2.8\n	l-4.8 -3.5\n	c-3 -2 -5.8 1.8 -3.6 4.4\n	1 1.1 2 0.8 2.1 -0.1\n	0.1 -0.9 -0.7 -1.2 -1.9 -0.6\n	-1.4 -0.5 -0.9 -4.8 2.2 -2.8\n	l4.8 3.5\n	c3 2 5.8 -1.8 3.6 -4.4\n	-1 -1.1 -2 -0.8 -2.1 0.1\n	-0.1 0.9 0.7 1.2 1.9 0.6"/>',turnx:'<g id="turnx">\n	<use xlink:href="#turn"/>\n	<path d="m0 -1.5v-9" class="stroke"/>\n</g>',wedge:'<path id="wedge" class="fill" d="m0 -1l-1.5 -5h3l-1.5 5"/>',ltr:'<path id="ltr" class="fill"\n	d="m0 -0.4c2 -1.5 3.4 -1.9 3.9 0.4\n	c0.2 0.8 0.7 0.7 2.1 -0.4\n	v0.8c-2 1.5 -3.4 1.9 -3.9 -0.4\n	c-0.2 -0.8 -0.7 -0.7 -2.1 0.4z"/>',custos:'<g id="custos">\n	<path d="m-4 0l2 2.5 2 -2.5 2 2.5 2 -2.5\n		-2 -2.5 -2 2.5 -2 -2.5 -2 2.5" class="fill"/>\n	<path d="m3.5 0l5 -7" class="stroke"/>\n</g>',oct:'<text id="oct" style="font:12px serif">8</text>i'},anno_type=["bar","clef","custos","format","grace","key","meter","Zrest","note","part","rest","yspace","staves","Break","tempo","tuplet","block"];Abc.prototype.out_svg=out_svg,Abc.prototype.sx=sx,Abc.prototype.sy=sy,Abc.prototype.out_sxsy=out_sxsy,Abc.prototype.xypath=xypath;const deco_str_style={crdc:{dx:0,dy:5,style:'style="font:italic 14px serif"'},dacs:{dx:0,dy:3,style:'style="font:16px serif" text-anchor="middle"'},fng:{dx:-3,dy:1,style:'style="font:8px Bookman"'},pf:{dx:0,dy:5,style:'style="font:bold italic 16px serif"'}};var deco_val_tb={arp:out_arp,cresc:out_cresc,dim:out_dim,ltr:out_ltr},block_started;Abc.prototype.blk_out=blk_out,Abc.prototype.blk_flush=blk_flush;var par_sy,cur_sy,voice_tb,curvoice,staves_found,vover,tsfirst;const weight_tb=[3,1,6,0,2,4,5,9,9,0,9,2,0,6,0,7,0],cde2fcg=[0,2,4,-1,1,3,5],cgd2cde=[0,4,1,5,2,6,3],acc2=[-2,-1,3,1,2],note_names="CDEFGAB",latin_names=["Do","RÃ©","Mi","Fa","Sol","La","Si"],acc_name=["bb","b","","#","##"];return abc2svg_init(),this}/** @license
 *
 * Copyright (c) 2015, 2016 David A. Randolph.
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS," WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 *
 * ****************************************************************************
 * Created by David A. Randolph on 8/18/15, on top of the abc2svg
 * example script by Jef Moine.
 */
function AbcDE(){"use strict";function t(){fn&&clearInterval(fn),rn=[],sn=[],dn="",on=!1,pn="noname.abc",Jt=void 0,Yt="",Zt=void 0,mn=[],vn=!1,_n=[],en=void 0,gn=0,yn=[],bn=[],xn={},wn={},kn=[],En=!1,Tn={},Cn={},Sn=[],On=0,tn=void 0,nn=void 0,Nn=[]}function n(e){var t,n=Tn[e],r=[];for(t in n)n.hasOwnProperty(t)&&r.push(t);return r.sort(function(e,t){return parseInt(e)-parseInt(t)}),r}function r(e,t){if(!e)return console.log("MISSING fingers have no hands."),"";if("x"===e)return e;for(var n=t,r=[],s=e.split(""),i=0;i<s.length;i++){var a=s[i];"<"===a||">"===a?n=a:a.match(/\d/)?r.push(n+a):r.push(a)}return r.join("")}function s(){return"undefined"==typeof Storage?!1:!0}function i(e,t){dn||(dn=md5(Yt));var n=e+"_"+t+"_"+dn;return n}function a(e){if(!s())return{};var t={sequence:""},n=i("sequence",e),r=localStorage.getItem(n)||"";r.match(/[^x&@]/)&&(t.sequence=r),n=i("authority",e);var a=localStorage.getItem(n)||"";t.authority=a,n=i("authority_year",e);var o=localStorage.getItem(n)||"";t.authority_year=o,n=i("transcriber",e);var c=localStorage.getItem(n)||"";t.transcriber=c,n=i("comments",e);var l=localStorage.getItem(n)||"";return t.comments=l,t}function o(e){var t=document.getElementById(e);return t.value?t.value:""}function c(e){var t=new Date,n=t.getFullYear()+"-"+sprintf("%02d",t.getMonth()+1)+"-"+sprintf("%02d",t.getDate())+" "+sprintf("%02d",t.getHours())+":"+sprintf("%02d",t.getMinutes())+":"+sprintf("%02d",t.getSeconds()),r="",s="";(e||h("include_pii"))&&(r=o("authority"),s=o("transcriber"));var i={sequence:Ht(),authority:r,authority_year:o("authority_year"),transcriber:s,transcription_date:n,comments:o("comments")};return i}function l(e,t){var n=document.getElementById(e),r=n.value,s=i(e,t);localStorage.setItem(s,r)}function u(e){for(var t=document.getElementsByName(e),n=0;n<t.length;n++){var r=t[n];if(r.checked)return r.id}}function f(e){var t="";if("preset"===e||"output"===e||"keypad"===e||"restore"==e)t=u(e);else{var n=document.getElementById(e);t=n.value}ln[e]=t,localStorage.setItem(e,t)}function d(){var e=document.getElementById("sequence_spinner");return e?e.value:(alert("Sequence DOM element has gone missing."),"1")}function p(){if(!s())return void clearInterval(fn);var e=document.getElementById("sequence_spinner");if(!e)return void clearInterval(fn);var t=d(),n=i("sequence",t),r=Ht();localStorage.setItem(n,r),l("authority",t),l("authority_year",t),l("transcriber",t),l("comments",t)}function h(e){if(Qt&&Qt[e])return Qt[e];if("measure_number_interval"===e){var t=document.getElementById(e);return t.value}var n=u(e);return n?n:""}function m(){var e=h("preset"),t=1;return"last"===e&&(t=un.length||1),t}function v(){var e={};return e.authority=o("default_authority"),e.authority_year=o("default_authority_year"),e.transcriber=o("default_transcriber"),e.sequence="x",e.comments="",e}function _(e){for(var t,n=e.split("\n"),r=!1,s={},i=[],a="",o=0;o<n.length;o++){var c=n[o];if(!a&&(t=Wn.exec(c),t&&t[1]))a=t[1],r=!0;else if(r)if(t=Kn.exec(c),t&&t[1]&&t[2])s={sequence:t[2],comments:""},i.push(s);else{if(t=Xn.exec(c))break;if(t=Qn.exec(c),t&&t[1]){s.authority=t[1],t[2]&&(s.authority_year=t[2]);continue}if(t=Jn.exec(c),t&&t[1]){s.transcriber=t[1];continue}if(t=Gn.exec(c),t&&t[1]){s.transcription_date=t[1];continue}t=Yn.exec(c),t&&t[1]&&(s.comments+=t[1]+"\n")}}return i}function g(){var e=document.getElementById("sequence_spinner");e.min=1,e.max=un.length||1;var t=m();e.value=t}function y(){var e=h("preset");return e&&"none"!==e?"first"===e?un[0]:"last"===e?un[un.length-1]:"":v()}function b(e){if(e){var t=e-1;return parseInt(e)<=un.length?un[t]:v()}return y()}function x(e,t){for(var n=document.getElementsByName(e),r=0;r<n.length;r++){var s=n[r];s.id===t&&(s.checked=!0)}}function w(e,t){var n=document.getElementById(e);void 0!==t?n.value=t:n.value=""}function k(){x("preset",localStorage.getItem("preset")),x("output",localStorage.getItem("output")),x("restore",localStorage.getItem("restore")),x("keypad",localStorage.getItem("keypad"));var e=localStorage.getItem("measure_number_interval");(void 0===e||""===e)&&(e=jn),w("measure_number_interval",e),w("default_authority",localStorage.getItem("default_authority")),w("default_authority_year",localStorage.getItem("default_authority_year")),w("default_transcriber",localStorage.getItem("default_transcriber"))}function E(e){w("authority",e.authority),w("authority_year",e.authority_year),w("transcriber",e.transcriber),w("comments",e.comments)}function T(){var e=o("authority"),t=o("default_authority");!e&&t&&w("authority",t);var n=o("authority_year"),r=o("default_authority_year");!n&&r&&w("authority_year",r);var s=o("transcriber"),i=o("default_transcriber");!s&&i&&w("transcriber",i)}function C(e,t){if(e){console.log("Setting fingers: ",e);var s,i,a,o={},c=e.split("@");for(s=0;s<c.length;s++){var l=Ke(s);o=[];var u=c[s].split("&");for(i=0;i<u.length;i++){var f=u[i];o=o.concat(R(qn,f))}for(var d=n(s),p=0;p<d.length;p++){var h=d[p],m=Tn[s][h];m.sort(be);for(var v=0;m[v].grace;){m[v][t]="";for(var _=0;_<m[v].size;_++)a=o.shift(),a||(console.log("Preset fingering MISSING for note:"),me("preset grace note",m[v])),a=r(a,l),l=Lt(a,l),m[v][t]+=a;v++}var g=Ae(m),y=Oe(g);for(_=0;_<y.length;_++)for(var b=y[_],x=0;x<g[b].length;x++){var w=g[b][x];w[t]=""}for(_=0;_<y.length;_++)for(var b=y[_],x=0;x<g[b].length;x++){var w=g[b][x];w.grace||(w[t]||(w[t]=""),a=o.shift(),a||(console.log("Preset fingering MISSING for note:"),me("preset pit note",w)),a=r(a,l),l=Lt(a,l),w[t]+=a)}}}}}function S(e,t){var n=t.sequence,r=t.sequence,s=!0,i=h("preset");i&&"none"!==i||(s=!1,n="");var a=!1;if(e&&e.sequence&&e.sequence!==n){var o=h("restore");a="always"===o?!0:"never"===o?!1:confirm("You have previously entered data for this piece. Do you want to restore them?"),a&&(n=e.sequence)}a?E(e):s&&E(t),C(n,"fingering"),C(r,"preset_fingering"),fn=setInterval(function(){p()},er)}function O(){var e=d(),t=a(e),n=b(e);S(t,n),T()}function A(e){var t=Pt();return t}function N(){var e="Please enter a fingering string for the current piece.",t=window.prompt(e,"");null!==t&&(C(t,"fingering"),qe())}function B(){if(Yt){var e=confirm("All changes you have made to this fingering sequence will be discarded, and the initial sequence will be restored. Are you sure you want to proceed?");if(e){var t=d(),n=b(t);S(void 0,n),qe(),en=bn[0][0][0],St(en)}}}function R(e,t){if(!t)return[];for(var n,r=[],s=0,i=0;null!=(n=e.exec(t));){i=e.lastIndex;var a;a=s===i?t.substr(s):t.substr(s,i-s),r.push(a),s=e.lastIndex}var o=t.substr(s);if(o){var c="";r.length>0&&(c=r.pop()),c+=o,r.push(c)}return r}function L(){var e=window.open(In,"_blank");e.focus()}function P(e){dt();var t=document.getElementById("prefs_modal_wrapper"),n=document.getElementById("prefs_modal_window");t.className="overlay";var r=n.offsetHeight-document.documentElement.clientHeight;r>0&&(n.style.maxHeight=parseInt(window.getComputedStyle(n).height)-r+"px"),n.style.marginTop=-n.offsetHeight/2+"px",n.style.marginLeft=-n.offsetWidth/2+"px",e.preventDefault?e.preventDefault():e.returnValue=!1}function I(e){dt();var t=document.getElementById("metadata_modal_wrapper"),n=document.getElementById("metadata_modal_window");t.className="overlay";var r=n.offsetHeight-document.documentElement.clientHeight;r>0&&(n.style.maxHeight=parseInt(window.getComputedStyle(n).height)-r+"px"),n.style.marginTop=-n.offsetHeight/2+"px",n.style.marginLeft=-n.offsetWidth/2+"px",e.preventDefault?e.preventDefault():e.returnValue=!1}function M(e){var t=document.getElementById("metadata_modal_wrapper");t.className="",p(),Y(),ft(),e.preventDefault?e.preventDefault():e.returnValue=!1}function D(){cn>pr&&(cn-=fr,qe())}function j(){dr>cn&&(cn+=fr,qe())}function F(e){f("preset"),f("output"),f("restore"),f("keypad"),f("measure_number_interval"),f("default_authority"),f("default_authority_year"),f("default_transcriber");var t=document.getElementById("prefs_modal_wrapper");t.className="",Yt&&(qe(),St(en)),Y(),ft(),e.preventDefault?e.preventDefault():e.returnValue=!1}function q(e){var t=e.slice(0,100);if(-1==t.indexOf("<?xml"))return!1;var n=t.match(/encoding="([^"]+)"/),r="utf-8";return n&&2==n.length&&(r=n[1]),r}function V(e){var t={},n=$.parseXML(e),r=vertaal(n,t),s=r[0],i=r[1];return i&&console.log("xml2abc ERROR: "+i),s||alert("Unable to open MusicXML file: "+i),s}function z(e,t){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,t,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(e,t)):n=null,n}function H(e){var t=e.split(".");return t[t.length-1]}function U(e){var t="";try{var n=new JSZip(e);$.each(n.files,function(e,n){t=n.asText()})}catch(r){return alert("Could not open compressed MusicXML file: "+r.message),""}var s=q(t);return"UTF-8"!==s?(alert("Input mxl is not UTF-8 encoded. Cannot open."),""):t=V(t)}function W(e){var t=H(e),n='The server hosting file does not allow access from this domain. Please download the file outside abcDE and then "Choose file" to work with it.',r=z("GET",e);return r?("mxl"===t&&(r.responseType="arraybuffer"),r.onload=function(){console.log("File has been retrieved.");var n="";if("mxl"===t){if(n=U(r.response),!n)return}else{n=r.responseText;var s=q(n);if(s){if(!/^utf/i.test(s))return void alert("Input xml is not UTF-8 encoded. Cannot open.");n=V(n)}}n&&(an=e,document.getElementById(nr).value=n,ht())},r.onerror=function(){alert(n)},void r.send()):void alert(n)}function K(){var e="Please enter URL to open.",t=Ln+"/wtc/prelude02.abc";if(an)t=an;else{var n=h("default_url");n&&(t=n)}var r=window.prompt(e,t);r&&W(r)}function X(e){var t=new FileReader,n="";t.onload=function(e){try{var t=new JSZip(e.target.result);$.each(t.files,function(e,t){n=t.asText()})}catch(e){return void alert("Could not open compressed MusicXML file: "+e.message)}var r=q(n);return"UTF-8"!==r?void alert("Input xml is not UTF-8 encoded. Cannot open."):(n=V(n),document.getElementById(nr).value=n,ht(),void 0)},t.readAsArrayBuffer(e)}function Q(){var e=document.getElementById("file_input"),t=e.files;if(!t.length)return void alert("Please select a valid abc file.");var n=t[0],r=H(n.name);if("mxl"===r)return void X(n);var s=!1,i=new FileReader;i.onload=function(e){var t=q(i.result),r=new FileReader;t?s=!0:t="UTF-8",r.onload=function(e){var t="";t=s?V(r.result):e.target.result,document.getElementById(nr).value=t,ht()},r.readAsText(n,t)},i.readAsText(n,"UTF-8")}function J(){Bn=Bn?!1:!0}function G(e,t){for(var n=e.children,r=0;r<n.length;r++)n[r].style.display=t}function Y(){var e=document.getElementById(or),t=document.getElementById("number_div"),n=document.getElementById("symbol_div"),r=h("keypad");if("show"===r)e.style.display="block",t.style.display="block",n.style.display="block",G(t,"inline"),G(n,"inline");else{G(n,"none"),G(t,"none");var s=h("qualtrics"),i=h("submit_button_id");if(s){var a=document.getElementById("q_next");a.style.display="inline";var o=document.getElementById("q_back");o&&(o.style.display="inline")}else if(i){var c=document.getElementById(i);c.style.display="inline"}else t.style.display="block",n.style.display="block",e.style.display="none"}}function Z(e){var t=e.keyCode||e.which;t=String.fromCharCode(t);var n=/[0-9]/;n.test(t)||(e.returnValue=!1,e.preventDefault&&e.preventDefault())}function ee(e,t,n,r,s,i){var a=document.createElement("input");a.type="text",a["class"]=r,a.id=t,s&&(a.onkeypress=s),"year"===r&&(a.size="4");var o=document.createElement("label");o.htmlFor=t,o.appendChild(document.createTextNode(n)),e.appendChild(o),e.appendChild(a),i&&e.appendChild(document.createElement("br"))}function te(e,t,n,r,s,i){var a=document.createElement("textarea");a["class"]=r,a.id=t,a.rows=s,a.cols=i;var o=document.createElement("label");o.htmlFor=t,o.appendChild(document.createTextNode(n)),e.appendChild(o),e.appendChild(a)}function ne(e,t,n){var r=document.createElement("label");r["class"]=n;var s=document.createTextNode(t);r.appendChild(s),e.appendChild(r)}function re(e,t,n,r,s,i,a){var o=document.createElement("div");o["class"]="radio_div",ne(e,t,"prompt");for(var c=0;c<r.length;c++){var l=document.createElement("input");l.type="radio",l.id=r[c],l.id===i&&(l.checked=!0),l.name=n,o.appendChild(l),ne(o,s[c],"radio_label");var u=document.createElement("span");u.innerHTML="&nbsp;&nbsp",o.appendChild(u)}return e.appendChild(o),a&&e.appendChild(document.createElement("br")),o}function se(e,t,n,r,s,i,a,o){var c=document.createElement("div");c["class"]="spinner_div",ne(c,t,"prompt");var l=document.createElement("input");return l.id=n,l.min=r,l.max=s,l.size=i,l.type="number",l.value=a,c.appendChild(l),e.appendChild(c),o&&e.appendChild(document.createElement("br")),c}function ie(){var e=document.getElementById(ar),t=document.createElement("div");t.id="metadata_modal_wrapper",e.appendChild(t);var n=document.createElement("div");n.id="metadata_modal_window",t.appendChild(n);var r=document.createElement("div");r.style.textAlign="right";var s=document.createElement("a");s.id="metadata_modal_close",s.href="#",s.innerHTML="Close <b>X</b>",r.appendChild(s),s.addEventListener("click",M,!1),n.appendChild(r),ee(n,"authority","Authority","name",void 0,!1),ee(n,"authority_year","Year","year",Z,!0),ee(n,"transcriber","Transcriber","name",void 0,!0),te(n,"comments","Comments","comments",10,50)}function ae(){var e=document.getElementById(sr),t=document.createElement("div");t.id="prefs_modal_wrapper",e.appendChild(t);var n=document.createElement("div");n.id="prefs_modal_window",t.appendChild(n);var r=document.createElement("div");r.style.textAlign="right";var s=document.createElement("a");s.id="prefs_modal_close",s.href="#",s.innerHTML="Close <b>X</b>",r.appendChild(s),s.addEventListener("click",F,!1),n.appendChild(r);var i=document.createElement("h3");i.innerText="Preferences",n.appendChild(i);var a="restore",o=["always","never","ask"],c=["Always","Never","Ask"];Qt&&Qt[a]||re(n,"Restore Data",a,o,c,"ask",!0),a="output",Qt&&Qt[a]||(o=["append","replace"],c=["Append","Replace"],re(n,"Output",a,o,c,"append",!0)),a="preset",Qt&&Qt[a]||(o=["first","last","none"],c=["First","Last","None"],re(n,"Preset",a,o,c,"first",!0)),a="keypad",o=["show","hide"],c=["Show","Hide"];var l="hide",u="ontouchstart"in window;u&&(l="show"),re(n,"Keypad",a,o,c,l,!0),se(n,"Measure Number Interval","measure_number_interval",0,20,2,5,!0),ee(n,"default_authority","Default Authority","name",void 0,!0),ee(n,"default_authority_year","Year","year",Z,!0),ee(n,"default_transcriber","Transcriber Name","name",void 0,!0)}function oe(e,t,n){var r=document.createElement("input");r.type="button",r["class"]="keypad-button",r.id=t,r.value=n,r.onclick=function(){st(n)},e.appendChild(r)}function ce(){for(var e=document.getElementById(tr);e.firstChild;)e.removeChild(e.firstChild);e.remove(),Rn=!1,fn&&clearInterval(fn)}function le(e){var n=h("qualtrics"),r=Ot(Yt),s="abcDF_"+r,i="abcD_"+r,a=Ht();Qualtrics.SurveyEngine.setEmbeddedData(s,a);var o=Kt();Qualtrics.SurveyEngine.setEmbeddedData(i,o),p(),"q_next"===e?(t(),qe(),ce(),on=!1,n.enableNextButton(),n.enablePreviousButton(),n.clickNextButton()):(n.enableNextButton(),n.enablePreviousButton(),n.clickPreviousButton())}function ue(e,t,n){var r=document.createElement("input");r.type="button",r["class"]="keypad-button",r.id=t,r.value=n,r.onclick=function(){le(t)},e.appendChild(r)}function fe(e,t,n){var r=document.createElement("input");r.type="button",r["class"]="keypad-button",r.id=t,r.value=n,e.appendChild(r)}function de(e,t,n,r){var s=document.createElement("input");s.id=t,s["class"]="keypad_button",s.type="image",s.src=Mn+"/"+n,s.alt=r,s.onclick=function(){Ue(t)},e.appendChild(s)}function pe(){var e=document.getElementById(or),t=document.createElement("number_div");t.id="number_div";var n=document.createElement("symbol_div");n.id="symbol_div",e.appendChild(n),e.appendChild(document.createElement("br")),e.appendChild(t),de(t,"undo","action-undo.svg","undo"),de(t,"redo","action-redo.svg","redo"),oe(t,"one","1"),oe(t,"two","2"),oe(t,"three","3"),oe(t,"four","4"),oe(t,"five","5"),oe(t,"toggle","T"),de(t,"pencil","target.svg","...");var r=h("qualtrics");r&&(h("qualtrics_back")&&ue(t,"q_back","BACK"),ue(t,"q_next","NEXT"));var s=h("submit_button_id");if(s){var i=h("submit_button_label");i||(i="NEXT"),fe(t,s,i)}de(n,"previous","arrow-circle-left.svg","<-"),de(n,"next","arrow-circle-right.svg","->"),oe(n,"hyphen","-"),oe(n,"slash","/"),oe(n,"open_paren","("),oe(n,"close_paren",")");var a=h("phrasing");a&&(oe(n,"short_phrase","S"),oe(n,"medium_phrase","M"),oe(n,"long_phrase","L")),de(n,"backspace","delete.svg","<]")}function he(){if(!Rn){ae(),ie();var e=Mn+"/download_36_x4.png",t="36",n=document.getElementById(ir),r=document.createElement("table"),s=document.createElement("tbody"),i=document.createElement("tr");n.appendChild(r),r.appendChild(s),r.style.backgroundColor="LightGray",r.align="center",s.appendChild(i);var a=document.createElement("p");a.setAttribute("id","downloadify");var o=document.createElement("td");o.appendChild(a),i.appendChild(o);var c=document.createElement("input");c.id="sequence_spinner",c.min="1",c.max="999",c.size=3,c.type="number",c.alt="fingering_number",c.value=1,c.onchange=Mt,o=document.createElement("td"),ne(o,"Sequence","sequence_prompt"),o.appendChild(c),i.appendChild(o),Qt.preset_select||(o.style.display="none");var l=document.createElement("input");l.type="image",l.src=Mn+"/eye.svg",l.width=t,l.alt="View",l.onclick=jt,o=document.createElement("td"),o.appendChild(l),i.appendChild(o);var u=document.createElement("input");u.type="image",u.src=Mn+"/print.svg",u.width=t,u.alt="Print...",u.onclick=It;var o=document.createElement("td");o.appendChild(u),i.appendChild(o),o=document.createElement("td");var f=document.createElement("input");f.type="checkbox",f.value="annotated",f.checked=Bn,f.id="view_annotated",f.onclick=J;var d=document.createElement("label");d.htmlFor="view_annotated",d.appendChild(document.createTextNode("Annotated")),o.appendChild(f),o.appendChild(d),i.appendChild(o);var p=document.createElement("input");p.type="image",p.src=Mn+"/reload.svg",p.width=t,p.alt="reset",p.onclick=B,o=document.createElement("td"),o.appendChild(p),i.appendChild(o);var h=document.createElement("input");h.id="copy_fingerings_button",h.type="image",h.src=Mn+"/clipboard.svg",h.width=t,h.alt="copy",o=document.createElement("td"),o.appendChild(h),i.appendChild(o),Qt.hide_copy?h.style.display="none":new Clipboard("#copy_fingerings_button",{text:A});var m=document.createElement("input");m.type="image",m.src=Mn+"/paperclip.svg",m.width=t,m.alt="paste",m.onclick=N,o=document.createElement("td"),o.appendChild(m),i.appendChild(o),Qt.hide_paste&&(m.style.display="none");var v=document.createElement("input");v.type="image",v.src=Mn+"/globe.svg",v.width=t,v.alt="URL",v.onclick=K,o=document.createElement("td"),o.appendChild(v),i.appendChild(o),Qt.url_input||(v.style.display="none");var _=document.createElement("input");_.setAttribute("type","file"),_.setAttribute("accept","text/vnd.abc"),_.onchange=Q,_.setAttribute("id","file_input"),o=document.createElement("td"),o.appendChild(_),i.appendChild(o),Qt.file_input||(_.style.display="none");var g=document.createElement("input");g.type="image",g.src=Mn+"/tags.svg",g.alt="Metadata...",g.width=t,g.onclick=I,o=document.createElement("td"),o.appendChild(g),i.appendChild(o);var y=document.createElement("input");y.type="image",y.src=Mn+"/zoom-out.svg",y.alt="Zoom In",y.width=t,y.onclick=D,o=document.createElement("td"),o.appendChild(y),i.appendChild(o);var b=document.createElement("input");b.type="image",b.src=Mn+"/zoom-in.svg",b.alt="Zoom In",b.width=t,b.onclick=j,o=document.createElement("td"),o.appendChild(b),i.appendChild(o);var x=document.createElement("input");x.type="image",x.src=Mn+"/cog.svg",x.alt="Preferences...",x.width=t,x.onclick=P,o=document.createElement("td"),o.appendChild(x),i.appendChild(o);var w=document.createElement("input");w.type="image",w.src=Mn+"/info.svg",w.alt="Help",w.width=t,w.onclick=L,o=document.createElement("td"),o.appendChild(w),i.appendChild(o),Downloadify.create("downloadify",{filename:function(){return pn},data:Dt,onComplete:function(){alert("Your file has been saved.")},onCancel:function(){alert("File save has been cancelled.")},onError:function(){alert("File save failed!")},transparent:!1,swf:Dn+"/downloadify.swf",downloadImage:e,width:t,height:t,append:!1}),pe(),Rn=!0}}function me(e,t){console.log(e+" Line: "+t.line+" Start: "+t.start+" Time: "+t.time+" String: "+t.string+" Size: "+t.size+" Pitch: "+t.pitches.join(",")+" Voice: "+t.voice+" Staff: "+t.staff+" Grace: "+t.grace)}function ve(){for(var e=0;e<yn.length;e++){var t=yn[e];t.undone_fingerings=[]}rn=[]}function _e(e,t){if("note"!=e[t.type]&&"grace"!=e[t.type])return{};if(this.line=-1,this.grace=!1,this.anno_start=t.istart,this.size=0,this.pitches=[],this.start=-1,this.end=-1,this.starts=[],this.stops=[],this.phrase_break="X","note"===e[t.type]){this.size=t.notes.length;for(var n=0;n<this.size;n++)this.pitches.push(t.notes[n].pit);this.pitches.sort(function(e,t){return parseInt(e)-parseInt(t)}),this.start=t.istart,this.end=t.iend}else{this.grace=!0,this.start=t.extra.istart,this.size=1;var r=t.extra;if(!r.notes)return alert("Who turned off the notes?!"),{};for(;;){if(r.notes.length>1&&alert('Chords not supported in a grace "note."'),this.starts.push(r.istart),this.stops.push(r.iend),this.pitches.push(r.notes[0].pit),!r.next){this.end=r.iend;break}r=r.next,this.size++}}return this.istart=t.istart,this.time=t.time,this.string=Yt.substring(this.start,this.end),this.voice=t.v,this.staff=t.st,this.prior_fingerings=[],this.undone_fingerings=[],this.init_fingering=function(){this.fingering="";for(var e=0;e<this.size;e++)this.fingering+="x"},this.init_fingering(),this.set_fingering=function(e){ve(),this.fingering&&this.prior_fingerings.push(this.fingering),e?this.fingering=e:this.init_fingering(),sn.push(this)},this.undo_fingering_change=function(){this.prior_fingerings.length>0&&(this.undone_fingerings.push(this.fingering),this.fingering=this.prior_fingerings.pop()),rn.push(this)},this.redo_fingering_change=function(){this.undone_fingerings.length>0&&(this.fingering&&this.prior_fingerings.push(this.fingering),this.fingering=this.undone_fingerings.pop()),sn.push(this)},this.get_fingering=function(){return this.fingering?this.fingering:void 0},this}function ge(){var e=8.5;1!==cn&&(e*=cn);var t='width="'+e+'in"';return t}function ye(){this.read_file=function(e){return""},this.errmsg=function(e,t,n){var r=document.getElementById(ur);t?r.innerHTML+='<b onclick="gotoabc('+t+","+n+')" style="cursor: pointer; display: inline-block">'+e+"</b><br/>\n":r.innerHTML+=e+"<br/>\n"},this.img_out=function(e){var t=/<svg /;e.match(t)&&(e=e.replace(t,'<svg id="line_'+gn+'" '),gn++),Gt+=e},this.anno_start=function(e,t,n,r,s,i,a){!En&&t in xn?xn[t].line=gn:"grace"===e&&console.log(e+" ANNO_START start: "+t+" stop: "+n),Sn.push([t,n]),Zt.out_svg('<g class="e_'+t+'">\n')},this.anno_stop=function(e,t,n,r,s,i,a){"grace"===e&&console.log(e+" ANNO_STOP start: "+t+" stop: "+n),Zt.out_svg("</g>\n"),Zt.out_svg('<rect class="abcr _'+t+'" x="'),Zt.out_sxsy(r,'" y="',s),Zt.out_svg('" width="'+i.toFixed(2)+'" height="'+a.toFixed(2)+'"/>\n')},this.get_abcmodel=function(e,t,n){if(!En){console.log(n);for(var r=0;r<t.length;r++){console.log("Voice: "+r);var s=t[r].st;Cn[r]=s}for(var i=e;i;){var a=new _e(n,i);a.istart&&(yn.push(a),xn[a.istart]=a,a.staff in Tn||(Tn[a.staff]={}),a.time in Tn[a.staff]||(Tn[a.staff][a.time]=[]),Tn[a.staff][a.time].push(a)),i=i.ts_next}}},this.page_format=!1,this.imagesize=ge()}function be(e,t){var n=parseInt(e.time)-parseInt(t.time);return 0!==n?n:e.grace&&!t.grace?-1:t.grace&&!e.grace?1:e.pitches[e.pitches.length-1]<t.pitches[0]?-1:e.pitches[0]>t.pitches[t.pitches.length-1]?1:e.voice<t.voice?(console.log("NOTES SORTED BY VOICE!"),-1):1}function xe(){for(var e,t,n,r=0;r<yn.length;r++)e=yn[r],t=e.line,n=e.staff,t in bn||(bn[t]=[],bn[t][0]=[],bn[t][1]=[]),bn[t][n].push(e);for(t=0;t<bn.length;t++)for(n=0;2>n;n++){var s=bn[t][n];s.sort(be)}var i,a;for(n=0;2>n;n++)for(t=0;t<bn.length;t++){var s=bn[t][n];for(r=0;r<s.length;r++)i=s[r],a?(a.next_note=i,i.prior_note=a,a=i):(a=i,i.prior_note=void 0)}i.next_note=void 0}function we(){var e;for(e in xn)xn.hasOwnProperty(e)&&kn.push(e);kn.sort(function(e,t){return parseInt(e)-parseInt(t)})}function ke(e){var t="$1";return e.match(Hn)&&(t="$1"),e.match(zn)&&(t="$2"),t}function Ee(e){var t="^";return/^</.test(e)&&(t="_"),t}function Te(e,t){for(var n=ke("<"),r=ke(">"),s=e.replace(/[\)\(]/g,""),i=R(Fn,s),a="",o=0;o<i.length;o++)i[o]=i[o].replace(zn,n),i[o]=i[o].replace(Hn,r),a+=i[o];a+='"';var c=Ee(s);return a='"'+c+a}function Ce(e,t,n){for(var r=!1,s=ke("<"),i=ke(">"),a=[],o=0;o<e.length;o++){var c="",l="x";if(e[o]&&"x"!==e[o])r=!0,l=e[o];else{if(!n)break;if(!e[o]||e[o]&&"x"===e[o])continue}if(l.match(/^\(/))c=Te(l,t);else{var u=Ee(l);l=l.replace(zn,s),l=l.replace(Hn,i),c='"'+u+l+'"'}a.unshift(c)}var f="";return r&&(f=a.join("")),f}function Se(e){var t=e.fingering;if("x"===t)return"";t=t.replace(Vn,"");var n=R(Fn,t),r=Ce(n,e.staff,!1);return r}function Oe(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t.sort(function(e,t){return parseInt(e)-parseInt(t)}),t}function Ae(e){for(var t=[],n={},r=0;r<e.length;r++){var s=e[r];if(!s.grace)for(var i=0;i<s.pitches.length;i++){var a=s.pitches[i];t.push(a),a in n||(n[a]=[]),n[a].push(s)}}for(r=0;r<n.length;r++)n[r].sort(be);return n}function Ne(e){for(var t=Ae(e),n=Oe(t),r=[],s=0;s<n.length;s++)for(var i=n[s],a=0;a<t[i].length;a++)for(var o=t[i][a],c=o.fingering,l=R(Fn,c),u=0;u<o.pitches.length;u++){var f=o.pitches[u];f===parseInt(i)&&("x"!==l[u]?r.push(l[u]):r.push(""))}return r}function Be(e){for(var t=0,n=0;n<e.length;n++)e[n].grace&&t++;return t}function Re(e){if(e.size>1&&console.log("BIGGIE"),e.grace)return Se(e);var t=Tn[e.staff][e.time],n=Be(t),r=t.length-n;if(2>r)return Se(e);t.sort(be);for(var s=0,i=t[0];i.grace;)s++,i=t[s];if(e!==i)return"";var a=Ne(t);return Ce(a,e.staff,!0)}function Le(e){for(var t=[],n=e.string,r=e.starts,s=e.stops,i=[],a=[],o=0;o<r.length;o++)i.push(r[o]-r[0]),a.push(s[o]-r[0]);for(var c=0;c<i.length;c++){var l=n.substring(i[c],a[c]);t.push(l)}return t}function Pe(e){var t="{",n=Le(e),r=[];e.fingering&&(r=R(Fn,e.fingering));for(var s=0;s<n.length;s++){if(r[s]){var i=r[s];i=i.replace(Un,""),"x"!==i&&(t+="!"+i+"!")}t+=n[s]}return t+="}"}function Ie(e){if(e.fingering)return!0;for(var t=Tn[e.staff][e.time],n=0;n<t.length;n++)if(!t[n].grace&&t[n].fingering)return!0;return!1}function Me(){if(void 0!==tn)return tn;tn=!1;for(var e=!1,t=!1,n=Yt.split("\n"),r=0;r<n.length;r++){var s=n[r];if(s.match(/^%%setfont-1/)&&(e=!0),s.match(/^%%setfont-2/)&&(t=!0),e&&t){tn=!0;break}}return tn}function De(){if(void 0!==nn)return nn;nn=!1;for(var e=Yt.split("\n"),t=0;t<e.length;t++){var n=e[t];if(n.match(/^%%measurenb\s+\d+/)){nn=!0;break}}return nn}function je(){if(void 0!==Jt)return Jt;Jt=!1;for(var e=0;e<kn.length;e++){var t=kn[e],n=xn[t];if(n.grace){Jt=!0;break}}return Jt}function Fe(){var e="";if(Me()||(e+=xr+"\n",je()&&(e+=wr+"\n")),!De()){var t=h("measure_number_interval");t&&(e+="%%measurenb "+t+"\n")}for(var n=0,r=0;r<kn.length;r++){var s=kn[r],i=xn[s],a="";if(i.grace){if(a=Yt.substring(parseInt(n),parseInt(i.start-1)),n=i.end+1,e+=a,i.fingered_start=e.length+i.anno_start-i.start+1,i.fingering&&"x"!==i.fingering){var o=R(Fn,i.fingering);i.fingered_start+=3*o.length}e+=Pe(i)}else{var c=parseInt(i.start),l=parseInt(i.end);a=Yt.substring(parseInt(n),c),e+=a,n=l,Ie(i)&&(e+=Re(i)),i.fingered_start=e.length,e+=i.string}wn[i.fingered_start]=i}return e+=Yt.substring(n)}function qe(){on=!0,On++,console.log("RERENDERING NUMBER "+On);var e=(new Date).getTime(),t=document.getElementById(lr),n=document.getElementById(ur),r=new ye;Zt=new Abc(r);var s=Fe(),i=(new Date).getTime(),a=i-e;console.log("MY LAG: "+a),document.getElementById(nr).value=s,e=(new Date).getTime(),Gt="",Zt.tosvg("edit",'%%bgcolor white\n%%beginsvg\n<style type="text/css">\n	rect.abcr {fill:#a08000; fill-opacity:0}\n	rect.abcr:hover {fill-opacity:0.3}\n</style>\n%%endsvg\n'),gn=0,n.innerHTML="",Sn=[];try{Zt.tosvg(pn,document.getElementById(nr).value)}catch(o){return void alert(o.message+"\nabc2svg tosvg bug - stack:\n"+o.stack)}try{t.innerHTML=Gt}catch(o){return void alert(o.message+"\nabc2svg image bug - abort:\n"+o.stack)}setTimeout(function(){for(var e,t=document.getElementsByClassName("abcr"),n=t.length;--n>=0;)e=t[n],e.onclick=function(){_t(this)},e.ondblclick=function(){wt(this)}},300),i=(new Date).getTime(),a=i-e,console.log("LIB LAG: "+a),Y()}function Ve(e){return null==e.which?String.fromCharCode(e.keyCode):0!=e.which&&0!=e.charCode?String.fromCharCode(e.which):null}function ze(e){if(console.log(String.fromCharCode(e)+" --> "+e),e===_r){Ye();var t=Ze();t.length>0&&t[0]?(en.set_fingering(""),qe()):en.prior_note&&(en=en.prior_note,en.set_fingering(""),qe()),St(en)}else if(e==gr||e==br)nt(),_n=[],en.next_note&&(en=en.next_note);else if(e==yr)nt(),_n=[],en.prior_note&&(en=en.prior_note);else if(e==vr)xt();else if(e==hr)yt();else{if(e!=mr)return!1;bt()}return St(en),!0}function He(e){var t=e.keyCode,n=ze(t);return n&&e.preventDefault(),n}function Ue(t){var n=gr;switch(t){case"previous":n=yr;break;case"next":n=br;break;case"backspace":n=_r;break;case"pencil":n=vr;break;case"undo":n=hr;break;case"redo":n=mr}var r=ze(n);return r&&e.preventDefault(),r}function $e(){An?(An=!1,on&&(document.body.style.backgroundColor="white")):(An=!0,on&&(document.body.style.backgroundColor="black")),St(en)}function We(e){return An?0==e.staff?"<":">":Ke(e.staff)}function Ke(e){return 0==e?">":"<"}function Xe(e,t){var n=We(t);if(!e.fingering.strike)return"x";var r=e.fingering.strike.hand||n,s=r+e.fingering.strike.digit;return e.fingering.release&&(r=e.fingering.release.hand||n,s+="-"+r+e.fingering.release.digit),s}function Qe(e,t){var n,r,s="",i=[];if(e.first.ornaments){for(i=e.first.ornaments[0],s+="(",r=0;r<i.length;r++)n=i[r],s+=Xe(n,t);s+=")"}else s+=Xe(e.first,t);if(e.last&&e.last.ornaments){for(i=e.last.ornaments[0],s+="(",r=0;r<i.length;r++)n=e.last.ornaments[r],s+="/"+Xe(n,t);s+=")"}else e.last&&(s+="/"+Xe(e.last,t));return s}function Je(e){for(var t="",n=0;n<en.size;){var r=e.shift(),s=Qe(r,en);if(t+=s,n++,0===e.length)break}if(n===en.size)return en.set_fingering(t),!0;for(;n<en.size;n++)t+="x";return en.set_fingering(t),!1}function Ge(e){for(var t=e.upper.score_fingerings;t.length>0;)Je(t)&&en.next_note&&(en=en.next_note);vn&&(en=en.prior_note)}function Ye(){vn=!1,mn=[],_n=[],qe(),St(en)}function Ze(){for(var e=[],t=en.get_fingering(),n=t.split(""),r=0;r<n.length;r++){var s=n[r];"x"===s?e.push(""):e.push(s)}return e}function et(){for(var e=Ze();e.length;){var t=e.pop();t&&mn.unshift(t)}}function tt(){for(var e=0;e<_n.length;e++)if("("===_n[e])return!0;return!1}function nt(){var e=!1;_n.length>0&&(Array.prototype.unshift.apply(mn,_n),tt()||(e=!0)),_n=[];for(var t=mn.length-1;t>=0&&/[\-\/\(]/.test(mn[t]);t--)_n.unshift(mn.pop());if(0!==mn.length){if(/[\-\/]/.test(mn[0])&&(e=!0),vn){var n=Ze();")"===n[n.length-1]?n.pop():(alert("Something wonky with parentheses."),Ye()),Array.prototype.unshift.apply(mn,n),vn=!1}e?en.prior_note?(en=en.prior_note,et()):mn.pop():en.fingering&&en.fingering.match(/x/)&&et();for(var r=mn.join(""),s=0,i=1;;)try{var a=Abcdf_Parser.parse(r);vn=!1,2===i&&(vn=!0),Ge(a);break}catch(o){if(1===i?mn.push(")"):2===i?(mn.pop(),mn.pop(),s++):3===i&&(i=0),0==mn.length)break;r=mn.join(""),i++}mn=[],qe(),St(en)}}function rt(e){en.phrase_break=e.toUpperCase()}function st(e){clearTimeout(hn);var t=!1;return/[\(\)\/\-1-5]/.test(e)&&(mn.push(e),t=!0),("t"===e||"T"===e)&&(nt(),$e(),t=!0),("s"===e||"S"===e||"m"===e||"M"===e||"l"===e||"L"===e)&&(nt(),rt(e),t=!0),hn=setTimeout(nt,Zn),console.log("Done "+hn),t}function it(e){var t=Ve(e).toLowerCase();return st(t)}function at(e){Qt||(Qt=e)}function ot(){return 5}function ct(){var e="% abcDidactyl v"+ot();return e}function lt(e){var t="% abcD fingering "+e+": ";return t;
}function ut(e,t){var n=[],r=[];r.push(ct());for(var s,i=_(e),a=e.split("\n"),o="",l=!1,u=0;u<a.length;u++){var f=a[u];o?l?n.push(f):(s=Xn.exec(f),s&&(l=!0)):(s=Wn.exec(f),s&&s[1]?o=s[1]:n.push(f))}var p=d(),m=c(t);if("replace"===h("output")){var v=p-1;i[v]=m}else i.push(m);for(var g,y,b,x,w,u=0;u<i.length;u++){var k=u+1;try{Abcdf_Parser.parse(i[u].sequence)}catch(E){alert("Bad abcDF parse of fingering string: "+E.message)}g=lt(k)+i[u].sequence,r.push(g),i[u].authority&&(y="% Authority: "+i[u].authority,i[u].authority_year&&(y+=" ("+i[u].authority_year+")"),r.push(y)),i[u].transcriber&&(b="% Transcriber: "+i[u].transcriber,r.push(b)),i[u].transcription_date&&(x="% Transcription date: "+i[u].transcription_date,r.push(x)),w=i[u].comments.split("\n");for(var T=0;T<w.length;T++)(T!==w.length-1||w[T])&&r.push("% "+w[T])}r.push("% abcDidactyl END");var C=r.join("\n"),S=n.join("\n");return C+"\n"+S}function ft(){document.body.addEventListener("keydown",He),document.body.addEventListener("keypress",it)}function dt(){document.body.removeEventListener("keydown",He),document.body.removeEventListener("keypress",it)}function pt(){if(!Rn){var e=document.getElementById(tr);e.align="center";var t=document.getElementById(nr);t||(t=document.createElement("div"),t.id=nr,t.style.display="none",e.appendChild(t)),t["class"]=rr;var n=document.createElement(sr);n.id=sr,e.appendChild(n);var r=document.createElement(ir);r.id=ir,e.appendChild(r);var s=document.createElement(ar);s.id=ar,e.appendChild(s);var i=document.createElement(cr);i.id=cr,e.appendChild(i);var a=document.createElement(lr);a.id=lr,i.appendChild(a);var o=document.createElement(ur);o.id=ur,i.appendChild(o);for(var c=0;7>c;c++)i.appendChild(document.createElement("br"));var l=document.createElement(or);l.id=or,e.appendChild(l)}}function ht(){if(pt(),t(),he(),k(),Yt=document.getElementById(nr).value,!Yt){var e=h("default_url");e&&(W(e),Yt=document.getElementById(nr).value)}on=!0,Yt&&(un=_(Yt),g(),kt(),en=bn[0][0][0],St(en),ft()),Y(),$(function(){FastClick.attach(document.body)})}function mt(e){at(e),ht();var t=h("qualtrics");t&&(t.disableNextButton(),t.disablePreviousButton())}function vt(){t(),Yt=document.getElementById(nr).value,kt(),en=bn[0][0][0],St(en),ft()}function _t(e){console.log("Processing note click....");var t=e.getAttribute("class");console.log("Click "+t);var n=t.split("_"),r=n[1];if(r in wn){var s=wn[r];me("process_note_click",s),St(s),en=s}}function gt(e){en=bn[0][0][0];var t=d(),n=c(!0);n.sequence=e;var r=a(t);S(r,n),qe(),St(en)}function yt(){Ye();var e=sn.pop();e&&(e.undo_fingering_change(),en=e,qe(),St(en))}function bt(){Ye();var e=rn.pop();e&&(e.redo_fingering_change(),en=e.next_note?e.next_note:e,qe(),St(en))}function xt(){Ye();var e="";en.preset_fingering&&(e+="Preset (recommended) fingering: "+en.preset_fingering+"\n\n"),e+="Please enter a fingering string for the selected note.";var t=en.fingering,n=window.prompt(e,t);try{if(null===n)return;var r=Abcdf_Parser.parse(n);Ge(r),qe(),St(en)}catch(s){alert("Bad abcDF parse of fingering string: "+s.message+s.stack)}}function wt(e){console.log("Processing note double-click...."),_t(e),xt()}function kt(){var e=new ye,t=document.getElementById(lr),n=document.getElementById(ur);t.align="center",Zt=new Abc(e),Gt="",Zt.tosvg("edit",'%%bgcolor white\n%%beginsvg\n<style type="text/css">\n	rect.abcr {fill:#a08000; fill-opacity:0}\n	rect.abcr:hover {fill-opacity:0.3}\n</style>\n%%endsvg\n'),n.innerHTML="",Sn=[];try{Yt&&Zt.tosvg(pn,Yt)}catch(r){return void alert(r.message+"\nabc2svg tosvg bug - stack:\n"+r.stack)}try{Yt&&(t.innerHTML=Gt,xe(),we(),En=!0,gn=0,O(),qe())}catch(r){return void alert(r.message+"\nabc2svg image bug - abort:\n"+r.stack)}}function Et(e,t){for(var n,r=document.getElementsByClassName(e),s=r.length;--s>=0;)n=r[s],n.setAttribute("color",t)}function Tt(e){var t,n=Nn.length;for(t=0;n>t;t++)Et(Nn[t],e)}function Ct(e){var t=$(e),n=$(window),r=document.getElementById(or),s=n.scrollTop(),i=s+n.height()-r.offsetHeight,a=t.offset().top,o=a+t.height();return i>=o&&a>=s}function St(e){var t=e.fingered_start;0!=Nn.length&&(Tt("black"),Nn=[]),Nn.push("e_"+t),Tt(An?0===e.staff?"blue":"red":1===e.staff?"blue":"red");var n="line_"+e.line,r=document.getElementById(n);if(!Ct(r)){r.scrollIntoView(!1);var s=document.getElementById(or),i=document.body.scrollTop;window.scrollTo(0,i+s.offsetHeight)}}function Ot(e){e||(e=Yt);for(var t=e.split("\n"),n=0;n<t.length;n++){var r=t[n];if(/^\s*X:/.test(r)){var s=r.split(":");if(2!=s.length)return"";var i=s[1].trim();return i}}return""}function At(e,t){var n=[];if(e.fingering)n=R(Fn,e.fingering);else if(t)return"";if(t&&n.length!=e.size)return"";for(var r=e.fingering||"",s=n.length;s<e.size;s++)r+="x";return r}function Nt(e,t){if(e.grace)return At(e,t);var n=Tn[e.staff][e.time],r=Be(n),s=n.length-r;if(2>s)return At(e,t);n.sort(be);for(var i=0,a=n[0];a.grace;)i++,a=n[i];if(e!==a)return"";for(var o=Ne(n),c="",i=0;i<o.length;i++)c+=o[i]?o[i]:"x";return c}function Bt(e,t){for(var n=[],r=t,s=e.split(""),i=0;i<s.length;i++){var a=s[i];a.match(Un)?a!==r&&(n.push(a),r=a):n.push(a)}return n.join("")}function Rt(e,t,n){for(var r=bn[t][e],s="",i=0;i<r.length;i++){var a=r[i],o=Nt(a,!1);s+=o}return s}function Lt(e,t){var n=$n.exec(e);return n&&n[1]?n[1]:t}function Pt(){for(var e="",t="",n=Ke(0),r=Ke(1),s=0;s<bn.length;s++){var i=Rt(0,s);if(i&&(i=Bt(i,n),n=Lt(i,n),e+=i,s<bn.length-1&&(e+="&")),bn[s][1]){var a=Rt(1,s);a&&(a=Bt(a,r),r=Lt(a,r),t+=a,s<bn.length-1&&(t+="&"))}}var o=e+"@"+t;return o}function It(){console.log("Print that score.");var e=window.open("","print_window");e.document.write(Gt),e.document.close(),e.focus(),e.print(),e.close()}function Mt(){var e=document.getElementById(nr);e.value=Yt,vt()}function Dt(){var e,t;return Bn?(e=Fe(),t=ut(e,!0)):t=ut(Yt,!0),t}function jt(){var e=Dt();window.open("data:text/vnd.abc;charset=utf-8,"+encodeURI(e),"view_window")}function Ft(){return h("include_pii")?o("authority"):""}function qt(){return o("authority_year")}function Vt(){return h("include_pii")?o("transcriber"):""}function zt(){return o("comments")}function Ht(){return Pt()}function Ut(e){try{Abcdf_Parser.parse(e)}catch(t){return"Bad abcDF parse of fingering string: "+t.message+t.stack}var n=0,r=h("validate");if("complete"===r)n=e.split("x").length-1;else if("none"===r)n=0;else if("auto"===r)return"Validation of autofill is not yet implemented.";return 1===n?"One note is missing a fingering annotation.":n>1?n+" notes are missing fingering annotations.":""}function $t(e){var t=Ut(e);return t?(alert(t),!1):!0}function Wt(){var e=Pt();return $t(e)?e:""}function Kt(){var e=Fe();return ut(e,!1)}function Xt(){var e=Pt();if($t(e)){var t=Fe(),n=ut(t,!1);return/^\s*X:/m.test(n)?/^% abcDidactyl/m.test(n)?n:(alert("File is not valid abcD."),""):(alert("File is not valid abc."),"")}return""}var Qt,Jt,Gt,Yt,Zt,en,tn,nn,rn=[],sn=[],an="",on=!1,cn=1,ln={},un=[],fn=void 0,dn="",pn="noname.abc",hn=0,mn=[],vn=!1,_n=[],gn=0,yn=[],bn=[],xn={},wn={},kn=[],En=!1,Tn={},Cn={},Sn=[],On=0,An=!1,Nn=[],Bn=!0,Rn=!1,Ln="https://dvdrndlph.github.io/didactyl",Pn=Ln+"/abcde",In=Pn+"/view/abcde_help.html",Mn=Pn+"/image",Dn=Pn+"/lib/media",jn=5,Fn=/\(([<>]\d)+\)|[<>]\d-[<>]\d\/[<>]\d-[<>]\d|[<>]\d\/[<>]\d-[<>]\d|[<>]\d-[<>]\d\/[<>]\d|[<>]\d-[<>]\d|[<>]\d\/[<>]\d|[<>]\d|x/g,qn=/\(([<>]?\d)+\)|[<>]?\d-[<>]?\d\/[<>]?\d-[<>]?\d|[<>]?\d\/[<>]?\d-[<>]?\d|[<>]?\d-[<>]?\d\/[<>]?\d|[<>]?\d-[<>]?\d|[<>]?\d\/[<>]?\d|[<>]?\d|x/g,Vn=/\s/g,zn=/</g,Hn=/>/g,Un=/[><]/g,$n=/.*([<>])[^<>]+$/,Wn=/^% abcDidactyl v([\d\.]+)$/,Kn=/^% abcD fingering (\d+): ([<>1-5\-\/\(\)@&x]+)$/,Xn=/^% abcDidactyl END$/,Qn=/^% Authority: (.*)\s+\((\d\d\d\d)\)$/,Jn=/^% Transcriber: (.*)$/,Gn=/^% Transcription date: ((\d\d\d\d\-[01]\d\-[0-3]\d)\s?([0-2]\d:[0-5]\d:[0-5]\d)?)$/,Yn=/^% (.*)$/,Zn=300,er=4e3,tr="abcde",nr="abc_source",rr="source",sr="abcde_prefs",ir="abcde_controls",ar="abcde_metadata",or="abcde_keypad",cr="abcde_rendering",lr="abcde_target",ur="abcde_error",fr=.1,dr=3,pr=.3,hr=90,mr=89,vr=13,_r=8,gr=9,yr=37,br=39,xr="%%setfont-1 Bookman 11\n%%setfont-2 Helvetica-Bold 11",wr="%%deco 1 3 fng 8 1 1 1\n%%deco 2 3 fng 8 1 1 2\n%%deco 3 3 fng 8 1 1 3\n%%deco 4 3 fng 8 1 1 4\n%%deco 5 3 fng 8 1 1 5";return this.renderUI=mt,this.getXValue=Ot,this.getAuthority=Ft,this.getAuthorityYear=qt,this.getTranscriber=Vt,this.getComments=zt,this.getEnteredCollection=Ht,this.getEnteredAbcDF=Ht,this.getEnteredAbcD=Kt,this.getValidatedCollection=Wt,this.getValidatedAbcD=Xt,this.setEnteredCollection=gt,this.handleKeys=ft,this.unhandleKeys=dt,this}!function(e,t){"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(e,t){function n(e){var t=!!e&&"length"in e&&e.length,n=pe.type(e);return"function"===n||pe.isWindow(e)?!1:"array"===n||0===t||"number"==typeof t&&t>0&&t-1 in e}function r(e,t,n){if(pe.isFunction(t))return pe.grep(e,function(e,r){return!!t.call(e,r,e)!==n});if(t.nodeType)return pe.grep(e,function(e){return e===t!==n});if("string"==typeof t){if(ke.test(t))return pe.filter(t,e,n);t=pe.filter(t,e)}return pe.grep(e,function(e){return pe.inArray(e,t)>-1!==n})}function s(e,t){do e=e[t];while(e&&1!==e.nodeType);return e}function i(e){var t={};return pe.each(e.match(Ae)||[],function(e,n){t[n]=!0}),t}function a(){re.addEventListener?(re.removeEventListener("DOMContentLoaded",o),e.removeEventListener("load",o)):(re.detachEvent("onreadystatechange",o),e.detachEvent("onload",o))}function o(){(re.addEventListener||"load"===e.event.type||"complete"===re.readyState)&&(a(),pe.ready())}function c(e,t,n){if(void 0===n&&1===e.nodeType){var r="data-"+t.replace(Pe,"-$1").toLowerCase();if(n=e.getAttribute(r),"string"==typeof n){try{n="true"===n?!0:"false"===n?!1:"null"===n?null:+n+""===n?+n:Le.test(n)?pe.parseJSON(n):n}catch(s){}pe.data(e,t,n)}else n=void 0}return n}function l(e){var t;for(t in e)if(("data"!==t||!pe.isEmptyObject(e[t]))&&"toJSON"!==t)return!1;return!0}function u(e,t,n,r){if(Re(e)){var s,i,a=pe.expando,o=e.nodeType,c=o?pe.cache:e,l=o?e[a]:e[a]&&a;if(l&&c[l]&&(r||c[l].data)||void 0!==n||"string"!=typeof t)return l||(l=o?e[a]=ne.pop()||pe.guid++:a),c[l]||(c[l]=o?{}:{toJSON:pe.noop}),("object"==typeof t||"function"==typeof t)&&(r?c[l]=pe.extend(c[l],t):c[l].data=pe.extend(c[l].data,t)),i=c[l],r||(i.data||(i.data={}),i=i.data),void 0!==n&&(i[pe.camelCase(t)]=n),"string"==typeof t?(s=i[t],null==s&&(s=i[pe.camelCase(t)])):s=i,s}}function f(e,t,n){if(Re(e)){var r,s,i=e.nodeType,a=i?pe.cache:e,o=i?e[pe.expando]:pe.expando;if(a[o]){if(t&&(r=n?a[o]:a[o].data)){pe.isArray(t)?t=t.concat(pe.map(t,pe.camelCase)):t in r?t=[t]:(t=pe.camelCase(t),t=t in r?[t]:t.split(" ")),s=t.length;for(;s--;)delete r[t[s]];if(n?!l(r):!pe.isEmptyObject(r))return}(n||(delete a[o].data,l(a[o])))&&(i?pe.cleanData([e],!0):fe.deleteExpando||a!=a.window?delete a[o]:a[o]=void 0)}}}function d(e,t,n,r){var s,i=1,a=20,o=r?function(){return r.cur()}:function(){return pe.css(e,t,"")},c=o(),l=n&&n[3]||(pe.cssNumber[t]?"":"px"),u=(pe.cssNumber[t]||"px"!==l&&+c)&&Me.exec(pe.css(e,t));if(u&&u[3]!==l){l=l||u[3],n=n||[],u=+c||1;do i=i||".5",u/=i,pe.style(e,t,u+l);while(i!==(i=o()/c)&&1!==i&&--a)}return n&&(u=+u||+c||0,s=n[1]?u+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=u,r.end=s)),s}function p(e){var t=Ue.split("|"),n=e.createDocumentFragment();if(n.createElement)for(;t.length;)n.createElement(t.pop());return n}function h(e,t){var n,r,s=0,i="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):void 0;if(!i)for(i=[],n=e.childNodes||e;null!=(r=n[s]);s++)!t||pe.nodeName(r,t)?i.push(r):pe.merge(i,h(r,t));return void 0===t||t&&pe.nodeName(e,t)?pe.merge([e],i):i}function m(e,t){for(var n,r=0;null!=(n=e[r]);r++)pe._data(n,"globalEval",!t||pe._data(t[r],"globalEval"))}function v(e){qe.test(e.type)&&(e.defaultChecked=e.checked)}function _(e,t,n,r,s){for(var i,a,o,c,l,u,f,d=e.length,_=p(t),g=[],y=0;d>y;y++)if(a=e[y],a||0===a)if("object"===pe.type(a))pe.merge(g,a.nodeType?[a]:a);else if(We.test(a)){for(c=c||_.appendChild(t.createElement("div")),l=(Ve.exec(a)||["",""])[1].toLowerCase(),f=$e[l]||$e._default,c.innerHTML=f[1]+pe.htmlPrefilter(a)+f[2],i=f[0];i--;)c=c.lastChild;if(!fe.leadingWhitespace&&He.test(a)&&g.push(t.createTextNode(He.exec(a)[0])),!fe.tbody)for(a="table"!==l||Ke.test(a)?"<table>"!==f[1]||Ke.test(a)?0:c:c.firstChild,i=a&&a.childNodes.length;i--;)pe.nodeName(u=a.childNodes[i],"tbody")&&!u.childNodes.length&&a.removeChild(u);for(pe.merge(g,c.childNodes),c.textContent="";c.firstChild;)c.removeChild(c.firstChild);c=_.lastChild}else g.push(t.createTextNode(a));for(c&&_.removeChild(c),fe.appendChecked||pe.grep(h(g,"input"),v),y=0;a=g[y++];)if(r&&pe.inArray(a,r)>-1)s&&s.push(a);else if(o=pe.contains(a.ownerDocument,a),c=h(_.appendChild(a),"script"),o&&m(c),n)for(i=0;a=c[i++];)ze.test(a.type||"")&&n.push(a);return c=null,_}function g(){return!0}function y(){return!1}function b(){try{return re.activeElement}catch(e){}}function x(e,t,n,r,s,i){var a,o;if("object"==typeof t){"string"!=typeof n&&(r=r||n,n=void 0);for(o in t)x(e,o,n,r,t[o],i);return e}if(null==r&&null==s?(s=n,r=n=void 0):null==s&&("string"==typeof n?(s=r,r=void 0):(s=r,r=n,n=void 0)),s===!1)s=y;else if(!s)return e;return 1===i&&(a=s,s=function(e){return pe().off(e),a.apply(this,arguments)},s.guid=a.guid||(a.guid=pe.guid++)),e.each(function(){pe.event.add(this,t,s,r,n)})}function w(e,t){return pe.nodeName(e,"table")&&pe.nodeName(11!==t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function k(e){return e.type=(null!==pe.find.attr(e,"type"))+"/"+e.type,e}function E(e){var t=st.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function T(e,t){if(1===t.nodeType&&pe.hasData(e)){var n,r,s,i=pe._data(e),a=pe._data(t,i),o=i.events;if(o){delete a.handle,a.events={};for(n in o)for(r=0,s=o[n].length;s>r;r++)pe.event.add(t,n,o[n][r])}a.data&&(a.data=pe.extend({},a.data))}}function C(e,t){var n,r,s;if(1===t.nodeType){if(n=t.nodeName.toLowerCase(),!fe.noCloneEvent&&t[pe.expando]){s=pe._data(t);for(r in s.events)pe.removeEvent(t,r,s.handle);t.removeAttribute(pe.expando)}"script"===n&&t.text!==e.text?(k(t).text=e.text,E(t)):"object"===n?(t.parentNode&&(t.outerHTML=e.outerHTML),fe.html5Clone&&e.innerHTML&&!pe.trim(t.innerHTML)&&(t.innerHTML=e.innerHTML)):"input"===n&&qe.test(e.type)?(t.defaultChecked=t.checked=e.checked,t.value!==e.value&&(t.value=e.value)):"option"===n?t.defaultSelected=t.selected=e.defaultSelected:("input"===n||"textarea"===n)&&(t.defaultValue=e.defaultValue)}}function S(e,t,n,r){t=ie.apply([],t);var s,i,a,o,c,l,u=0,f=e.length,d=f-1,p=t[0],m=pe.isFunction(p);if(m||f>1&&"string"==typeof p&&!fe.checkClone&&rt.test(p))return e.each(function(s){var i=e.eq(s);m&&(t[0]=p.call(this,s,i.html())),S(i,t,n,r)});if(f&&(l=_(t,e[0].ownerDocument,!1,e,r),s=l.firstChild,1===l.childNodes.length&&(l=s),s||r)){for(o=pe.map(h(l,"script"),k),a=o.length;f>u;u++)i=l,u!==d&&(i=pe.clone(i,!0,!0),a&&pe.merge(o,h(i,"script"))),n.call(e[u],i,u);if(a)for(c=o[o.length-1].ownerDocument,pe.map(o,E),u=0;a>u;u++)i=o[u],ze.test(i.type||"")&&!pe._data(i,"globalEval")&&pe.contains(c,i)&&(i.src?pe._evalUrl&&pe._evalUrl(i.src):pe.globalEval((i.text||i.textContent||i.innerHTML||"").replace(it,"")));l=s=null}return e}function O(e,t,n){for(var r,s=t?pe.filter(t,e):e,i=0;null!=(r=s[i]);i++)n||1!==r.nodeType||pe.cleanData(h(r)),r.parentNode&&(n&&pe.contains(r.ownerDocument,r)&&m(h(r,"script")),r.parentNode.removeChild(r));return e}function A(e,t){var n=pe(t.createElement(e)).appendTo(t.body),r=pe.css(n[0],"display");return n.detach(),r}function N(e){var t=re,n=lt[e];return n||(n=A(e,t),"none"!==n&&n||(ct=(ct||pe("<iframe frameborder='0' width='0' height='0'/>")).appendTo(t.documentElement),t=(ct[0].contentWindow||ct[0].contentDocument).document,t.write(),t.close(),n=A(e,t),ct.detach()),lt[e]=n),n}function B(e,t){return{get:function(){return e()?void delete this.get:(this.get=t).apply(this,arguments)}}}function R(e){if(e in Et)return e;for(var t=e.charAt(0).toUpperCase()+e.slice(1),n=kt.length;n--;)if(e=kt[n]+t,e in Et)return e}function L(e,t){for(var n,r,s,i=[],a=0,o=e.length;o>a;a++)r=e[a],r.style&&(i[a]=pe._data(r,"olddisplay"),n=r.style.display,t?(i[a]||"none"!==n||(r.style.display=""),""===r.style.display&&je(r)&&(i[a]=pe._data(r,"olddisplay",N(r.nodeName)))):(s=je(r),(n&&"none"!==n||!s)&&pe._data(r,"olddisplay",s?n:pe.css(r,"display"))));for(a=0;o>a;a++)r=e[a],r.style&&(t&&"none"!==r.style.display&&""!==r.style.display||(r.style.display=t?i[a]||"":"none"));return e}function P(e,t,n){var r=bt.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function I(e,t,n,r,s){for(var i=n===(r?"border":"content")?4:"width"===t?1:0,a=0;4>i;i+=2)"margin"===n&&(a+=pe.css(e,n+De[i],!0,s)),r?("content"===n&&(a-=pe.css(e,"padding"+De[i],!0,s)),"margin"!==n&&(a-=pe.css(e,"border"+De[i]+"Width",!0,s))):(a+=pe.css(e,"padding"+De[i],!0,s),"padding"!==n&&(a+=pe.css(e,"border"+De[i]+"Width",!0,s)));return a}function M(t,n,r){var s=!0,i="width"===n?t.offsetWidth:t.offsetHeight,a=ht(t),o=fe.boxSizing&&"border-box"===pe.css(t,"boxSizing",!1,a);if(re.msFullscreenElement&&e.top!==e&&t.getClientRects().length&&(i=Math.round(100*t.getBoundingClientRect()[n])),0>=i||null==i){if(i=mt(t,n,a),(0>i||null==i)&&(i=t.style[n]),ft.test(i))return i;s=o&&(fe.boxSizingReliable()||i===t.style[n]),i=parseFloat(i)||0}return i+I(t,n,r||(o?"border":"content"),s,a)+"px"}function D(e,t,n,r,s){return new D.prototype.init(e,t,n,r,s)}function j(){return e.setTimeout(function(){Tt=void 0}),Tt=pe.now()}function F(e,t){var n,r={height:e},s=0;for(t=t?1:0;4>s;s+=2-t)n=De[s],r["margin"+n]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}function q(e,t,n){for(var r,s=(H.tweeners[t]||[]).concat(H.tweeners["*"]),i=0,a=s.length;a>i;i++)if(r=s[i].call(n,t,e))return r}function V(e,t,n){var r,s,i,a,o,c,l,u,f=this,d={},p=e.style,h=e.nodeType&&je(e),m=pe._data(e,"fxshow");n.queue||(o=pe._queueHooks(e,"fx"),null==o.unqueued&&(o.unqueued=0,c=o.empty.fire,o.empty.fire=function(){o.unqueued||c()}),o.unqueued++,f.always(function(){f.always(function(){o.unqueued--,pe.queue(e,"fx").length||o.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(n.overflow=[p.overflow,p.overflowX,p.overflowY],l=pe.css(e,"display"),u="none"===l?pe._data(e,"olddisplay")||N(e.nodeName):l,"inline"===u&&"none"===pe.css(e,"float")&&(fe.inlineBlockNeedsLayout&&"inline"!==N(e.nodeName)?p.zoom=1:p.display="inline-block")),n.overflow&&(p.overflow="hidden",fe.shrinkWrapBlocks()||f.always(function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]}));for(r in t)if(s=t[r],St.exec(s)){if(delete t[r],i=i||"toggle"===s,s===(h?"hide":"show")){if("show"!==s||!m||void 0===m[r])continue;h=!0}d[r]=m&&m[r]||pe.style(e,r)}else l=void 0;if(pe.isEmptyObject(d))"inline"===("none"===l?N(e.nodeName):l)&&(p.display=l);else{m?"hidden"in m&&(h=m.hidden):m=pe._data(e,"fxshow",{}),i&&(m.hidden=!h),h?pe(e).show():f.done(function(){pe(e).hide()}),f.done(function(){var t;pe._removeData(e,"fxshow");for(t in d)pe.style(e,t,d[t])});for(r in d)a=q(h?m[r]:0,r,f),r in m||(m[r]=a.start,h&&(a.end=a.start,a.start="width"===r||"height"===r?1:0))}}function z(e,t){var n,r,s,i,a;for(n in e)if(r=pe.camelCase(n),s=t[r],i=e[n],pe.isArray(i)&&(s=i[1],i=e[n]=i[0]),n!==r&&(e[r]=i,delete e[n]),a=pe.cssHooks[r],a&&"expand"in a){i=a.expand(i),delete e[r];for(n in i)n in e||(e[n]=i[n],t[n]=s)}else t[r]=s}function H(e,t,n){var r,s,i=0,a=H.prefilters.length,o=pe.Deferred().always(function(){delete c.elem}),c=function(){if(s)return!1;for(var t=Tt||j(),n=Math.max(0,l.startTime+l.duration-t),r=n/l.duration||0,i=1-r,a=0,c=l.tweens.length;c>a;a++)l.tweens[a].run(i);return o.notifyWith(e,[l,i,n]),1>i&&c?n:(o.resolveWith(e,[l]),!1)},l=o.promise({elem:e,props:pe.extend({},t),opts:pe.extend(!0,{specialEasing:{},easing:pe.easing._default},n),originalProperties:t,originalOptions:n,startTime:Tt||j(),duration:n.duration,tweens:[],createTween:function(t,n){var r=pe.Tween(e,l.opts,t,n,l.opts.specialEasing[t]||l.opts.easing);return l.tweens.push(r),r},stop:function(t){var n=0,r=t?l.tweens.length:0;if(s)return this;for(s=!0;r>n;n++)l.tweens[n].run(1);return t?(o.notifyWith(e,[l,1,0]),o.resolveWith(e,[l,t])):o.rejectWith(e,[l,t]),this}}),u=l.props;for(z(u,l.opts.specialEasing);a>i;i++)if(r=H.prefilters[i].call(l,e,u,l.opts))return pe.isFunction(r.stop)&&(pe._queueHooks(l.elem,l.opts.queue).stop=pe.proxy(r.stop,r)),r;return pe.map(u,q,l),pe.isFunction(l.opts.start)&&l.opts.start.call(e,l),pe.fx.timer(pe.extend(c,{elem:e,anim:l,queue:l.opts.queue})),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always)}function U(e){return pe.attr(e,"class")||""}function $(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,s=0,i=t.toLowerCase().match(Ae)||[];if(pe.isFunction(n))for(;r=i[s++];)"+"===r.charAt(0)?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function W(e,t,n,r){function s(o){var c;return i[o]=!0,pe.each(e[o]||[],function(e,o){var l=o(t,n,r);return"string"!=typeof l||a||i[l]?a?!(c=l):void 0:(t.dataTypes.unshift(l),s(l),!1)}),c}var i={},a=e===Gt;return s(t.dataTypes[0])||!i["*"]&&s("*")}function K(e,t){var n,r,s=pe.ajaxSettings.flatOptions||{};for(r in t)void 0!==t[r]&&((s[r]?e:n||(n={}))[r]=t[r]);return n&&pe.extend(!0,e,n),e}function X(e,t,n){for(var r,s,i,a,o=e.contents,c=e.dataTypes;"*"===c[0];)c.shift(),void 0===s&&(s=e.mimeType||t.getResponseHeader("Content-Type"));if(s)for(a in o)if(o[a]&&o[a].test(s)){c.unshift(a);break}if(c[0]in n)i=c[0];else{for(a in n){if(!c[0]||e.converters[a+" "+c[0]]){i=a;break}r||(r=a)}i=i||r}return i?(i!==c[0]&&c.unshift(i),n[i]):void 0}function Q(e,t,n,r){var s,i,a,o,c,l={},u=e.dataTypes.slice();if(u[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];for(i=u.shift();i;)if(e.responseFields[i]&&(n[e.responseFields[i]]=t),!c&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),c=i,i=u.shift())if("*"===i)i=c;else if("*"!==c&&c!==i){if(a=l[c+" "+i]||l["* "+i],!a)for(s in l)if(o=s.split(" "),o[1]===i&&(a=l[c+" "+o[0]]||l["* "+o[0]])){a===!0?a=l[s]:l[s]!==!0&&(i=o[0],u.unshift(o[1]));break}if(a!==!0)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(f){return{state:"parsererror",error:a?f:"No conversion from "+c+" to "+i}}}return{state:"success",data:t}}function J(e){return e.style&&e.style.display||pe.css(e,"display")}function G(e){for(;e&&1===e.nodeType;){if("none"===J(e)||"hidden"===e.type)return!0;e=e.parentNode}return!1}function Y(e,t,n,r){var s;if(pe.isArray(t))pe.each(t,function(t,s){n||nn.test(e)?r(e,s):Y(e+"["+("object"==typeof s&&null!=s?t:"")+"]",s,n,r)});else if(n||"object"!==pe.type(t))r(e,t);else for(s in t)Y(e+"["+s+"]",t[s],n,r)}function Z(){try{return new e.XMLHttpRequest}catch(t){}}function ee(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}function te(e){return pe.isWindow(e)?e:9===e.nodeType?e.defaultView||e.parentWindow:!1}var ne=[],re=e.document,se=ne.slice,ie=ne.concat,ae=ne.push,oe=ne.indexOf,ce={},le=ce.toString,ue=ce.hasOwnProperty,fe={},de="1.12.0",pe=function(e,t){return new pe.fn.init(e,t)},he=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,me=/^-ms-/,ve=/-([\da-z])/gi,_e=function(e,t){return t.toUpperCase()};pe.fn=pe.prototype={jquery:de,constructor:pe,selector:"",length:0,toArray:function(){return se.call(this)},get:function(e){return null!=e?0>e?this[e+this.length]:this[e]:se.call(this)},pushStack:function(e){var t=pe.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e){return pe.each(this,e)},map:function(e){return this.pushStack(pe.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(se.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(0>e?t:0);return this.pushStack(n>=0&&t>n?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:ae,sort:ne.sort,splice:ne.splice},pe.extend=pe.fn.extend=function(){var e,t,n,r,s,i,a=arguments[0]||{},o=1,c=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[o]||{},o++),"object"==typeof a||pe.isFunction(a)||(a={}),o===c&&(a=this,o--);c>o;o++)if(null!=(s=arguments[o]))for(r in s)e=a[r],n=s[r],a!==n&&(l&&n&&(pe.isPlainObject(n)||(t=pe.isArray(n)))?(t?(t=!1,i=e&&pe.isArray(e)?e:[]):i=e&&pe.isPlainObject(e)?e:{},a[r]=pe.extend(l,i,n)):void 0!==n&&(a[r]=n));return a},pe.extend({expando:"jQuery"+(de+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isFunction:function(e){return"function"===pe.type(e)},isArray:Array.isArray||function(e){return"array"===pe.type(e)},isWindow:function(e){return null!=e&&e==e.window},isNumeric:function(e){var t=e&&e.toString();return!pe.isArray(e)&&t-parseFloat(t)+1>=0},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},isPlainObject:function(e){var t;if(!e||"object"!==pe.type(e)||e.nodeType||pe.isWindow(e))return!1;try{if(e.constructor&&!ue.call(e,"constructor")&&!ue.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}if(!fe.ownFirst)for(t in e)return ue.call(e,t);for(t in e);return void 0===t||ue.call(e,t)},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?ce[le.call(e)]||"object":typeof e},globalEval:function(t){t&&pe.trim(t)&&(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(me,"ms-").replace(ve,_e)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t){var r,s=0;if(n(e))for(r=e.length;r>s&&t.call(e[s],s,e[s])!==!1;s++);else for(s in e)if(t.call(e[s],s,e[s])===!1)break;return e},trim:function(e){return null==e?"":(e+"").replace(he,"")},makeArray:function(e,t){var r=t||[];return null!=e&&(n(Object(e))?pe.merge(r,"string"==typeof e?[e]:e):ae.call(r,e)),r},inArray:function(e,t,n){var r;if(t){if(oe)return oe.call(t,e,n);for(r=t.length,n=n?0>n?Math.max(0,r+n):n:0;r>n;n++)if(n in t&&t[n]===e)return n}return-1},merge:function(e,t){for(var n=+t.length,r=0,s=e.length;n>r;)e[s++]=t[r++];if(n!==n)for(;void 0!==t[r];)e[s++]=t[r++];return e.length=s,e},grep:function(e,t,n){for(var r,s=[],i=0,a=e.length,o=!n;a>i;i++)r=!t(e[i],i),r!==o&&s.push(e[i]);return s},map:function(e,t,r){var s,i,a=0,o=[];if(n(e))for(s=e.length;s>a;a++)i=t(e[a],a,r),null!=i&&o.push(i);else for(a in e)i=t(e[a],a,r),null!=i&&o.push(i);return ie.apply([],o)},guid:1,proxy:function(e,t){var n,r,s;return"string"==typeof t&&(s=e[t],t=e,e=s),pe.isFunction(e)?(n=se.call(arguments,2),r=function(){return e.apply(t||this,n.concat(se.call(arguments)))},r.guid=e.guid=e.guid||pe.guid++,r):void 0},now:function(){return+new Date},support:fe}),"function"==typeof Symbol&&(pe.fn[Symbol.iterator]=ne[Symbol.iterator]),pe.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){ce["[object "+t+"]"]=t.toLowerCase()});var ge=function(e){function t(e,t,n,r){var s,i,a,o,c,l,f,p,h=t&&t.ownerDocument,m=t?t.nodeType:9;if(n=n||[],"string"!=typeof e||!e||1!==m&&9!==m&&11!==m)return n;if(!r&&((t?t.ownerDocument||t:q)!==R&&B(t),t=t||R,P)){if(11!==m&&(l=_e.exec(e)))if(s=l[1]){if(9===m){if(!(a=t.getElementById(s)))return n;if(a.id===s)return n.push(a),n}else if(h&&(a=h.getElementById(s))&&j(t,a)&&a.id===s)return n.push(a),n}else{if(l[2])return Y.apply(n,t.getElementsByTagName(e)),n;if((s=l[3])&&x.getElementsByClassName&&t.getElementsByClassName)return Y.apply(n,t.getElementsByClassName(s)),n}if(x.qsa&&!$[e+" "]&&(!I||!I.test(e))){if(1!==m)h=t,p=e;else if("object"!==t.nodeName.toLowerCase()){for((o=t.getAttribute("id"))?o=o.replace(ye,"\\$&"):t.setAttribute("id",o=F),f=T(e),i=f.length,c=de.test(o)?"#"+o:"[id='"+o+"']";i--;)f[i]=c+" "+d(f[i]);p=f.join(","),h=ge.test(e)&&u(t.parentNode)||t}if(p)try{return Y.apply(n,h.querySelectorAll(p)),n}catch(v){}finally{o===F&&t.removeAttribute("id")}}}return S(e.replace(oe,"$1"),t,n,r)}function n(){function e(n,r){return t.push(n+" ")>w.cacheLength&&delete e[t.shift()],e[n+" "]=r}var t=[];return e}function r(e){return e[F]=!0,e}function s(e){var t=R.createElement("div");try{return!!e(t)}catch(n){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function i(e,t){for(var n=e.split("|"),r=n.length;r--;)w.attrHandle[n[r]]=t}function a(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||K)-(~e.sourceIndex||K);if(r)return r;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function o(e){return function(t){var n=t.nodeName.toLowerCase();return"input"===n&&t.type===e}}function c(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function l(e){return r(function(t){return t=+t,r(function(n,r){for(var s,i=e([],n.length,t),a=i.length;a--;)n[s=i[a]]&&(n[s]=!(r[s]=n[s]))})})}function u(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}function f(){}function d(e){for(var t=0,n=e.length,r="";n>t;t++)r+=e[t].value;return r}function p(e,t,n){var r=t.dir,s=n&&"parentNode"===r,i=z++;return t.first?function(t,n,i){for(;t=t[r];)if(1===t.nodeType||s)return e(t,n,i)}:function(t,n,a){var o,c,l,u=[V,i];if(a){for(;t=t[r];)if((1===t.nodeType||s)&&e(t,n,a))return!0}else for(;t=t[r];)if(1===t.nodeType||s){if(l=t[F]||(t[F]={}),c=l[t.uniqueID]||(l[t.uniqueID]={}),(o=c[r])&&o[0]===V&&o[1]===i)return u[2]=o[2];if(c[r]=u,u[2]=e(t,n,a))return!0}}}function h(e){return e.length>1?function(t,n,r){for(var s=e.length;s--;)if(!e[s](t,n,r))return!1;return!0}:e[0]}function m(e,n,r){for(var s=0,i=n.length;i>s;s++)t(e,n[s],r);return r}function v(e,t,n,r,s){for(var i,a=[],o=0,c=e.length,l=null!=t;c>o;o++)(i=e[o])&&(!n||n(i,r,s))&&(a.push(i),l&&t.push(o));return a}function _(e,t,n,s,i,a){return s&&!s[F]&&(s=_(s)),i&&!i[F]&&(i=_(i,a)),r(function(r,a,o,c){var l,u,f,d=[],p=[],h=a.length,_=r||m(t||"*",o.nodeType?[o]:o,[]),g=!e||!r&&t?_:v(_,d,e,o,c),y=n?i||(r?e:h||s)?[]:a:g;if(n&&n(g,y,o,c),s)for(l=v(y,p),s(l,[],o,c),u=l.length;u--;)(f=l[u])&&(y[p[u]]=!(g[p[u]]=f));if(r){if(i||e){if(i){for(l=[],u=y.length;u--;)(f=y[u])&&l.push(g[u]=f);i(null,y=[],l,c)}for(u=y.length;u--;)(f=y[u])&&(l=i?ee(r,f):d[u])>-1&&(r[l]=!(a[l]=f))}}else y=v(y===a?y.splice(h,y.length):y),i?i(null,a,y,c):Y.apply(a,y)})}function g(e){for(var t,n,r,s=e.length,i=w.relative[e[0].type],a=i||w.relative[" "],o=i?1:0,c=p(function(e){return e===t},a,!0),l=p(function(e){return ee(t,e)>-1},a,!0),u=[function(e,n,r){var s=!i&&(r||n!==O)||((t=n).nodeType?c(e,n,r):l(e,n,r));return t=null,s}];s>o;o++)if(n=w.relative[e[o].type])u=[p(h(u),n)];else{if(n=w.filter[e[o].type].apply(null,e[o].matches),n[F]){for(r=++o;s>r&&!w.relative[e[r].type];r++);return _(o>1&&h(u),o>1&&d(e.slice(0,o-1).concat({value:" "===e[o-2].type?"*":""})).replace(oe,"$1"),n,r>o&&g(e.slice(o,r)),s>r&&g(e=e.slice(r)),s>r&&d(e))}u.push(n)}return h(u)}function y(e,n){var s=n.length>0,i=e.length>0,a=function(r,a,o,c,l){var u,f,d,p=0,h="0",m=r&&[],_=[],g=O,y=r||i&&w.find.TAG("*",l),b=V+=null==g?1:Math.random()||.1,x=y.length;for(l&&(O=a===R||a||l);h!==x&&null!=(u=y[h]);h++){if(i&&u){for(f=0,a||u.ownerDocument===R||(B(u),o=!P);d=e[f++];)if(d(u,a||R,o)){c.push(u);break}l&&(V=b)}s&&((u=!d&&u)&&p--,r&&m.push(u))}if(p+=h,s&&h!==p){for(f=0;d=n[f++];)d(m,_,a,o);if(r){if(p>0)for(;h--;)m[h]||_[h]||(_[h]=J.call(c));_=v(_)}Y.apply(c,_),l&&!r&&_.length>0&&p+n.length>1&&t.uniqueSort(c)}return l&&(V=b,O=g),m};return s?r(a):a}var b,x,w,k,E,T,C,S,O,A,N,B,R,L,P,I,M,D,j,F="sizzle"+1*new Date,q=e.document,V=0,z=0,H=n(),U=n(),$=n(),W=function(e,t){return e===t&&(N=!0),0},K=1<<31,X={}.hasOwnProperty,Q=[],J=Q.pop,G=Q.push,Y=Q.push,Z=Q.slice,ee=function(e,t){for(var n=0,r=e.length;r>n;n++)if(e[n]===t)return n;return-1},te="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",ne="[\\x20\\t\\r\\n\\f]",re="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",se="\\["+ne+"*("+re+")(?:"+ne+"*([*^$|!~]?=)"+ne+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+re+"))|)"+ne+"*\\]",ie=":("+re+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+se+")*)|.*)\\)|)",ae=new RegExp(ne+"+","g"),oe=new RegExp("^"+ne+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ne+"+$","g"),ce=new RegExp("^"+ne+"*,"+ne+"*"),le=new RegExp("^"+ne+"*([>+~]|"+ne+")"+ne+"*"),ue=new RegExp("="+ne+"*([^\\]'\"]*?)"+ne+"*\\]","g"),fe=new RegExp(ie),de=new RegExp("^"+re+"$"),pe={
ID:new RegExp("^#("+re+")"),CLASS:new RegExp("^\\.("+re+")"),TAG:new RegExp("^("+re+"|[*])"),ATTR:new RegExp("^"+se),PSEUDO:new RegExp("^"+ie),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ne+"*(even|odd|(([+-]|)(\\d*)n|)"+ne+"*(?:([+-]|)"+ne+"*(\\d+)|))"+ne+"*\\)|)","i"),bool:new RegExp("^(?:"+te+")$","i"),needsContext:new RegExp("^"+ne+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ne+"*((?:-\\d)?\\d*)"+ne+"*\\)|)(?=[^-]|$)","i")},he=/^(?:input|select|textarea|button)$/i,me=/^h\d$/i,ve=/^[^{]+\{\s*\[native \w/,_e=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ge=/[+~]/,ye=/'|\\/g,be=new RegExp("\\\\([\\da-f]{1,6}"+ne+"?|("+ne+")|.)","ig"),xe=function(e,t,n){var r="0x"+t-65536;return r!==r||n?t:0>r?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)},we=function(){B()};try{Y.apply(Q=Z.call(q.childNodes),q.childNodes),Q[q.childNodes.length].nodeType}catch(ke){Y={apply:Q.length?function(e,t){G.apply(e,Z.call(t))}:function(e,t){for(var n=e.length,r=0;e[n++]=t[r++];);e.length=n-1}}}x=t.support={},E=t.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?"HTML"!==t.nodeName:!1},B=t.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:q;return r!==R&&9===r.nodeType&&r.documentElement?(R=r,L=R.documentElement,P=!E(R),(n=R.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",we,!1):n.attachEvent&&n.attachEvent("onunload",we)),x.attributes=s(function(e){return e.className="i",!e.getAttribute("className")}),x.getElementsByTagName=s(function(e){return e.appendChild(R.createComment("")),!e.getElementsByTagName("*").length}),x.getElementsByClassName=ve.test(R.getElementsByClassName),x.getById=s(function(e){return L.appendChild(e).id=F,!R.getElementsByName||!R.getElementsByName(F).length}),x.getById?(w.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&P){var n=t.getElementById(e);return n?[n]:[]}},w.filter.ID=function(e){var t=e.replace(be,xe);return function(e){return e.getAttribute("id")===t}}):(delete w.find.ID,w.filter.ID=function(e){var t=e.replace(be,xe);return function(e){var n="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return n&&n.value===t}}),w.find.TAG=x.getElementsByTagName?function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):x.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],s=0,i=t.getElementsByTagName(e);if("*"===e){for(;n=i[s++];)1===n.nodeType&&r.push(n);return r}return i},w.find.CLASS=x.getElementsByClassName&&function(e,t){return"undefined"!=typeof t.getElementsByClassName&&P?t.getElementsByClassName(e):void 0},M=[],I=[],(x.qsa=ve.test(R.querySelectorAll))&&(s(function(e){L.appendChild(e).innerHTML="<a id='"+F+"'></a><select id='"+F+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&I.push("[*^$]="+ne+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||I.push("\\["+ne+"*(?:value|"+te+")"),e.querySelectorAll("[id~="+F+"-]").length||I.push("~="),e.querySelectorAll(":checked").length||I.push(":checked"),e.querySelectorAll("a#"+F+"+*").length||I.push(".#.+[+~]")}),s(function(e){var t=R.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&I.push("name"+ne+"*[*^$|!~]?="),e.querySelectorAll(":enabled").length||I.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),I.push(",.*:")})),(x.matchesSelector=ve.test(D=L.matches||L.webkitMatchesSelector||L.mozMatchesSelector||L.oMatchesSelector||L.msMatchesSelector))&&s(function(e){x.disconnectedMatch=D.call(e,"div"),D.call(e,"[s!='']:x"),M.push("!=",ie)}),I=I.length&&new RegExp(I.join("|")),M=M.length&&new RegExp(M.join("|")),t=ve.test(L.compareDocumentPosition),j=t||ve.test(L.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},W=t?function(e,t){if(e===t)return N=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n?n:(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1,1&n||!x.sortDetached&&t.compareDocumentPosition(e)===n?e===R||e.ownerDocument===q&&j(q,e)?-1:t===R||t.ownerDocument===q&&j(q,t)?1:A?ee(A,e)-ee(A,t):0:4&n?-1:1)}:function(e,t){if(e===t)return N=!0,0;var n,r=0,s=e.parentNode,i=t.parentNode,o=[e],c=[t];if(!s||!i)return e===R?-1:t===R?1:s?-1:i?1:A?ee(A,e)-ee(A,t):0;if(s===i)return a(e,t);for(n=e;n=n.parentNode;)o.unshift(n);for(n=t;n=n.parentNode;)c.unshift(n);for(;o[r]===c[r];)r++;return r?a(o[r],c[r]):o[r]===q?-1:c[r]===q?1:0},R):R},t.matches=function(e,n){return t(e,null,null,n)},t.matchesSelector=function(e,n){if((e.ownerDocument||e)!==R&&B(e),n=n.replace(ue,"='$1']"),x.matchesSelector&&P&&!$[n+" "]&&(!M||!M.test(n))&&(!I||!I.test(n)))try{var r=D.call(e,n);if(r||x.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(s){}return t(n,R,null,[e]).length>0},t.contains=function(e,t){return(e.ownerDocument||e)!==R&&B(e),j(e,t)},t.attr=function(e,t){(e.ownerDocument||e)!==R&&B(e);var n=w.attrHandle[t.toLowerCase()],r=n&&X.call(w.attrHandle,t.toLowerCase())?n(e,t,!P):void 0;return void 0!==r?r:x.attributes||!P?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},t.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},t.uniqueSort=function(e){var t,n=[],r=0,s=0;if(N=!x.detectDuplicates,A=!x.sortStable&&e.slice(0),e.sort(W),N){for(;t=e[s++];)t===e[s]&&(r=n.push(s));for(;r--;)e.splice(n[r],1)}return A=null,e},k=t.getText=function(e){var t,n="",r=0,s=e.nodeType;if(s){if(1===s||9===s||11===s){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=k(e)}else if(3===s||4===s)return e.nodeValue}else for(;t=e[r++];)n+=k(t);return n},w=t.selectors={cacheLength:50,createPseudo:r,match:pe,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(be,xe),e[3]=(e[3]||e[4]||e[5]||"").replace(be,xe),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||t.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&t.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return pe.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&fe.test(n)&&(t=T(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(be,xe).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=H[e+" "];return t||(t=new RegExp("(^|"+ne+")"+e+"("+ne+"|$)"))&&H(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,n,r){return function(s){var i=t.attr(s,e);return null==i?"!="===n:n?(i+="","="===n?i===r:"!="===n?i!==r:"^="===n?r&&0===i.indexOf(r):"*="===n?r&&i.indexOf(r)>-1:"$="===n?r&&i.slice(-r.length)===r:"~="===n?(" "+i.replace(ae," ")+" ").indexOf(r)>-1:"|="===n?i===r||i.slice(0,r.length+1)===r+"-":!1):!0}},CHILD:function(e,t,n,r,s){var i="nth"!==e.slice(0,3),a="last"!==e.slice(-4),o="of-type"===t;return 1===r&&0===s?function(e){return!!e.parentNode}:function(t,n,c){var l,u,f,d,p,h,m=i!==a?"nextSibling":"previousSibling",v=t.parentNode,_=o&&t.nodeName.toLowerCase(),g=!c&&!o,y=!1;if(v){if(i){for(;m;){for(d=t;d=d[m];)if(o?d.nodeName.toLowerCase()===_:1===d.nodeType)return!1;h=m="only"===e&&!h&&"nextSibling"}return!0}if(h=[a?v.firstChild:v.lastChild],a&&g){for(d=v,f=d[F]||(d[F]={}),u=f[d.uniqueID]||(f[d.uniqueID]={}),l=u[e]||[],p=l[0]===V&&l[1],y=p&&l[2],d=p&&v.childNodes[p];d=++p&&d&&d[m]||(y=p=0)||h.pop();)if(1===d.nodeType&&++y&&d===t){u[e]=[V,p,y];break}}else if(g&&(d=t,f=d[F]||(d[F]={}),u=f[d.uniqueID]||(f[d.uniqueID]={}),l=u[e]||[],p=l[0]===V&&l[1],y=p),y===!1)for(;(d=++p&&d&&d[m]||(y=p=0)||h.pop())&&((o?d.nodeName.toLowerCase()!==_:1!==d.nodeType)||!++y||(g&&(f=d[F]||(d[F]={}),u=f[d.uniqueID]||(f[d.uniqueID]={}),u[e]=[V,y]),d!==t)););return y-=s,y===r||y%r===0&&y/r>=0}}},PSEUDO:function(e,n){var s,i=w.pseudos[e]||w.setFilters[e.toLowerCase()]||t.error("unsupported pseudo: "+e);return i[F]?i(n):i.length>1?(s=[e,e,"",n],w.setFilters.hasOwnProperty(e.toLowerCase())?r(function(e,t){for(var r,s=i(e,n),a=s.length;a--;)r=ee(e,s[a]),e[r]=!(t[r]=s[a])}):function(e){return i(e,0,s)}):i}},pseudos:{not:r(function(e){var t=[],n=[],s=C(e.replace(oe,"$1"));return s[F]?r(function(e,t,n,r){for(var i,a=s(e,null,r,[]),o=e.length;o--;)(i=a[o])&&(e[o]=!(t[o]=i))}):function(e,r,i){return t[0]=e,s(t,null,i,n),t[0]=null,!n.pop()}}),has:r(function(e){return function(n){return t(e,n).length>0}}),contains:r(function(e){return e=e.replace(be,xe),function(t){return(t.textContent||t.innerText||k(t)).indexOf(e)>-1}}),lang:r(function(e){return de.test(e||"")||t.error("unsupported lang: "+e),e=e.replace(be,xe).toLowerCase(),function(t){var n;do if(n=P?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return n=n.toLowerCase(),n===e||0===n.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===L},focus:function(e){return e===R.activeElement&&(!R.hasFocus||R.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!w.pseudos.empty(e)},header:function(e){return me.test(e.nodeName)},input:function(e){return he.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:l(function(){return[0]}),last:l(function(e,t){return[t-1]}),eq:l(function(e,t,n){return[0>n?n+t:n]}),even:l(function(e,t){for(var n=0;t>n;n+=2)e.push(n);return e}),odd:l(function(e,t){for(var n=1;t>n;n+=2)e.push(n);return e}),lt:l(function(e,t,n){for(var r=0>n?n+t:n;--r>=0;)e.push(r);return e}),gt:l(function(e,t,n){for(var r=0>n?n+t:n;++r<t;)e.push(r);return e})}},w.pseudos.nth=w.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})w.pseudos[b]=o(b);for(b in{submit:!0,reset:!0})w.pseudos[b]=c(b);return f.prototype=w.filters=w.pseudos,w.setFilters=new f,T=t.tokenize=function(e,n){var r,s,i,a,o,c,l,u=U[e+" "];if(u)return n?0:u.slice(0);for(o=e,c=[],l=w.preFilter;o;){(!r||(s=ce.exec(o)))&&(s&&(o=o.slice(s[0].length)||o),c.push(i=[])),r=!1,(s=le.exec(o))&&(r=s.shift(),i.push({value:r,type:s[0].replace(oe," ")}),o=o.slice(r.length));for(a in w.filter)!(s=pe[a].exec(o))||l[a]&&!(s=l[a](s))||(r=s.shift(),i.push({value:r,type:a,matches:s}),o=o.slice(r.length));if(!r)break}return n?o.length:o?t.error(e):U(e,c).slice(0)},C=t.compile=function(e,t){var n,r=[],s=[],i=$[e+" "];if(!i){for(t||(t=T(e)),n=t.length;n--;)i=g(t[n]),i[F]?r.push(i):s.push(i);i=$(e,y(s,r)),i.selector=e}return i},S=t.select=function(e,t,n,r){var s,i,a,o,c,l="function"==typeof e&&e,f=!r&&T(e=l.selector||e);if(n=n||[],1===f.length){if(i=f[0]=f[0].slice(0),i.length>2&&"ID"===(a=i[0]).type&&x.getById&&9===t.nodeType&&P&&w.relative[i[1].type]){if(t=(w.find.ID(a.matches[0].replace(be,xe),t)||[])[0],!t)return n;l&&(t=t.parentNode),e=e.slice(i.shift().value.length)}for(s=pe.needsContext.test(e)?0:i.length;s--&&(a=i[s],!w.relative[o=a.type]);)if((c=w.find[o])&&(r=c(a.matches[0].replace(be,xe),ge.test(i[0].type)&&u(t.parentNode)||t))){if(i.splice(s,1),e=r.length&&d(i),!e)return Y.apply(n,r),n;break}}return(l||C(e,f))(r,t,!P,n,!t||ge.test(e)&&u(t.parentNode)||t),n},x.sortStable=F.split("").sort(W).join("")===F,x.detectDuplicates=!!N,B(),x.sortDetached=s(function(e){return 1&e.compareDocumentPosition(R.createElement("div"))}),s(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||i("type|href|height|width",function(e,t,n){return n?void 0:e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),x.attributes&&s(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||i("value",function(e,t,n){return n||"input"!==e.nodeName.toLowerCase()?void 0:e.defaultValue}),s(function(e){return null==e.getAttribute("disabled")})||i(te,function(e,t,n){var r;return n?void 0:e[t]===!0?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),t}(e);pe.find=ge,pe.expr=ge.selectors,pe.expr[":"]=pe.expr.pseudos,pe.uniqueSort=pe.unique=ge.uniqueSort,pe.text=ge.getText,pe.isXMLDoc=ge.isXML,pe.contains=ge.contains;var ye=function(e,t,n){for(var r=[],s=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(s&&pe(e).is(n))break;r.push(e)}return r},be=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},xe=pe.expr.match.needsContext,we=/^<([\w-]+)\s*\/?>(?:<\/\1>|)$/,ke=/^.[^:#\[\.,]*$/;pe.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?pe.find.matchesSelector(r,e)?[r]:[]:pe.find.matches(e,pe.grep(t,function(e){return 1===e.nodeType}))},pe.fn.extend({find:function(e){var t,n=[],r=this,s=r.length;if("string"!=typeof e)return this.pushStack(pe(e).filter(function(){for(t=0;s>t;t++)if(pe.contains(r[t],this))return!0}));for(t=0;s>t;t++)pe.find(e,r[t],n);return n=this.pushStack(s>1?pe.unique(n):n),n.selector=this.selector?this.selector+" "+e:e,n},filter:function(e){return this.pushStack(r(this,e||[],!1))},not:function(e){return this.pushStack(r(this,e||[],!0))},is:function(e){return!!r(this,"string"==typeof e&&xe.test(e)?pe(e):e||[],!1).length}});var Ee,Te=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,Ce=pe.fn.init=function(e,t,n){var r,s;if(!e)return this;if(n=n||Ee,"string"==typeof e){if(r="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:Te.exec(e),!r||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof pe?t[0]:t,pe.merge(this,pe.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:re,!0)),we.test(r[1])&&pe.isPlainObject(t))for(r in t)pe.isFunction(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}if(s=re.getElementById(r[2]),s&&s.parentNode){if(s.id!==r[2])return Ee.find(e);this.length=1,this[0]=s}return this.context=re,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):pe.isFunction(e)?"undefined"!=typeof n.ready?n.ready(e):e(pe):(void 0!==e.selector&&(this.selector=e.selector,this.context=e.context),pe.makeArray(e,this))};Ce.prototype=pe.fn,Ee=pe(re);var Se=/^(?:parents|prev(?:Until|All))/,Oe={children:!0,contents:!0,next:!0,prev:!0};pe.fn.extend({has:function(e){var t,n=pe(e,this),r=n.length;return this.filter(function(){for(t=0;r>t;t++)if(pe.contains(this,n[t]))return!0})},closest:function(e,t){for(var n,r=0,s=this.length,i=[],a=xe.test(e)||"string"!=typeof e?pe(e,t||this.context):0;s>r;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?a.index(n)>-1:1===n.nodeType&&pe.find.matchesSelector(n,e))){i.push(n);break}return this.pushStack(i.length>1?pe.uniqueSort(i):i)},index:function(e){return e?"string"==typeof e?pe.inArray(this[0],pe(e)):pe.inArray(e.jquery?e[0]:e,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(pe.uniqueSort(pe.merge(this.get(),pe(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),pe.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return ye(e,"parentNode")},parentsUntil:function(e,t,n){return ye(e,"parentNode",n)},next:function(e){return s(e,"nextSibling")},prev:function(e){return s(e,"previousSibling")},nextAll:function(e){return ye(e,"nextSibling")},prevAll:function(e){return ye(e,"previousSibling")},nextUntil:function(e,t,n){return ye(e,"nextSibling",n)},prevUntil:function(e,t,n){return ye(e,"previousSibling",n)},siblings:function(e){return be((e.parentNode||{}).firstChild,e)},children:function(e){return be(e.firstChild)},contents:function(e){return pe.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:pe.merge([],e.childNodes)}},function(e,t){pe.fn[e]=function(n,r){var s=pe.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(s=pe.filter(r,s)),this.length>1&&(Oe[e]||(s=pe.uniqueSort(s)),Se.test(e)&&(s=s.reverse())),this.pushStack(s)}});var Ae=/\S+/g;pe.Callbacks=function(e){e="string"==typeof e?i(e):pe.extend({},e);var t,n,r,s,a=[],o=[],c=-1,l=function(){for(s=e.once,r=t=!0;o.length;c=-1)for(n=o.shift();++c<a.length;)a[c].apply(n[0],n[1])===!1&&e.stopOnFalse&&(c=a.length,n=!1);e.memory||(n=!1),t=!1,s&&(a=n?[]:"")},u={add:function(){return a&&(n&&!t&&(c=a.length-1,o.push(n)),function r(t){pe.each(t,function(t,n){pe.isFunction(n)?e.unique&&u.has(n)||a.push(n):n&&n.length&&"string"!==pe.type(n)&&r(n)})}(arguments),n&&!t&&l()),this},remove:function(){return pe.each(arguments,function(e,t){for(var n;(n=pe.inArray(t,a,n))>-1;)a.splice(n,1),c>=n&&c--}),this},has:function(e){return e?pe.inArray(e,a)>-1:a.length>0},empty:function(){return a&&(a=[]),this},disable:function(){return s=o=[],a=n="",this},disabled:function(){return!a},lock:function(){return s=!0,n||u.disable(),this},locked:function(){return!!s},fireWith:function(e,n){return s||(n=n||[],n=[e,n.slice?n.slice():n],o.push(n),t||l()),this},fire:function(){return u.fireWith(this,arguments),this},fired:function(){return!!r}};return u},pe.extend({Deferred:function(e){var t=[["resolve","done",pe.Callbacks("once memory"),"resolved"],["reject","fail",pe.Callbacks("once memory"),"rejected"],["notify","progress",pe.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return s.done(arguments).fail(arguments),this},then:function(){var e=arguments;return pe.Deferred(function(n){pe.each(t,function(t,i){var a=pe.isFunction(e[t])&&e[t];s[i[1]](function(){var e=a&&a.apply(this,arguments);e&&pe.isFunction(e.promise)?e.promise().progress(n.notify).done(n.resolve).fail(n.reject):n[i[0]+"With"](this===r?n.promise():this,a?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?pe.extend(e,r):r}},s={};return r.pipe=r.then,pe.each(t,function(e,i){var a=i[2],o=i[3];r[i[1]]=a.add,o&&a.add(function(){n=o},t[1^e][2].disable,t[2][2].lock),s[i[0]]=function(){return s[i[0]+"With"](this===s?r:this,arguments),this},s[i[0]+"With"]=a.fireWith}),r.promise(s),e&&e.call(s,s),s},when:function(e){var t,n,r,s=0,i=se.call(arguments),a=i.length,o=1!==a||e&&pe.isFunction(e.promise)?a:0,c=1===o?e:pe.Deferred(),l=function(e,n,r){return function(s){n[e]=this,r[e]=arguments.length>1?se.call(arguments):s,r===t?c.notifyWith(n,r):--o||c.resolveWith(n,r)}};if(a>1)for(t=new Array(a),n=new Array(a),r=new Array(a);a>s;s++)i[s]&&pe.isFunction(i[s].promise)?i[s].promise().progress(l(s,n,t)).done(l(s,r,i)).fail(c.reject):--o;return o||c.resolveWith(r,i),c.promise()}});var Ne;pe.fn.ready=function(e){return pe.ready.promise().done(e),this},pe.extend({isReady:!1,readyWait:1,holdReady:function(e){e?pe.readyWait++:pe.ready(!0)},ready:function(e){(e===!0?--pe.readyWait:pe.isReady)||(pe.isReady=!0,e!==!0&&--pe.readyWait>0||(Ne.resolveWith(re,[pe]),pe.fn.triggerHandler&&(pe(re).triggerHandler("ready"),pe(re).off("ready"))))}}),pe.ready.promise=function(t){if(!Ne)if(Ne=pe.Deferred(),"complete"===re.readyState)e.setTimeout(pe.ready);else if(re.addEventListener)re.addEventListener("DOMContentLoaded",o),e.addEventListener("load",o);else{re.attachEvent("onreadystatechange",o),e.attachEvent("onload",o);var n=!1;try{n=null==e.frameElement&&re.documentElement}catch(r){}n&&n.doScroll&&!function s(){if(!pe.isReady){try{n.doScroll("left")}catch(t){return e.setTimeout(s,50)}a(),pe.ready()}}()}return Ne.promise(t)},pe.ready.promise();var Be;for(Be in pe(fe))break;fe.ownFirst="0"===Be,fe.inlineBlockNeedsLayout=!1,pe(function(){var e,t,n,r;n=re.getElementsByTagName("body")[0],n&&n.style&&(t=re.createElement("div"),r=re.createElement("div"),r.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",n.appendChild(r).appendChild(t),"undefined"!=typeof t.style.zoom&&(t.style.cssText="display:inline;margin:0;border:0;padding:1px;width:1px;zoom:1",fe.inlineBlockNeedsLayout=e=3===t.offsetWidth,e&&(n.style.zoom=1)),n.removeChild(r))}),function(){var e=re.createElement("div");fe.deleteExpando=!0;try{delete e.test}catch(t){fe.deleteExpando=!1}e=null}();var Re=function(e){var t=pe.noData[(e.nodeName+" ").toLowerCase()],n=+e.nodeType||1;return 1!==n&&9!==n?!1:!t||t!==!0&&e.getAttribute("classid")===t},Le=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Pe=/([A-Z])/g;pe.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(e){return e=e.nodeType?pe.cache[e[pe.expando]]:e[pe.expando],!!e&&!l(e)},data:function(e,t,n){return u(e,t,n)},removeData:function(e,t){return f(e,t)},_data:function(e,t,n){return u(e,t,n,!0)},_removeData:function(e,t){return f(e,t,!0)}}),pe.fn.extend({data:function(e,t){var n,r,s,i=this[0],a=i&&i.attributes;if(void 0===e){if(this.length&&(s=pe.data(i),1===i.nodeType&&!pe._data(i,"parsedAttrs"))){for(n=a.length;n--;)a[n]&&(r=a[n].name,0===r.indexOf("data-")&&(r=pe.camelCase(r.slice(5)),c(i,r,s[r])));pe._data(i,"parsedAttrs",!0)}return s}return"object"==typeof e?this.each(function(){pe.data(this,e)}):arguments.length>1?this.each(function(){pe.data(this,e,t)}):i?c(i,e,pe.data(i,e)):void 0},removeData:function(e){return this.each(function(){pe.removeData(this,e)})}}),pe.extend({queue:function(e,t,n){var r;return e?(t=(t||"fx")+"queue",r=pe._data(e,t),n&&(!r||pe.isArray(n)?r=pe._data(e,t,pe.makeArray(n)):r.push(n)),r||[]):void 0},dequeue:function(e,t){t=t||"fx";var n=pe.queue(e,t),r=n.length,s=n.shift(),i=pe._queueHooks(e,t),a=function(){pe.dequeue(e,t)};"inprogress"===s&&(s=n.shift(),r--),s&&("fx"===t&&n.unshift("inprogress"),delete i.stop,s.call(e,a,i)),!r&&i&&i.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return pe._data(e,n)||pe._data(e,n,{empty:pe.Callbacks("once memory").add(function(){pe._removeData(e,t+"queue"),pe._removeData(e,n)})})}}),pe.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),arguments.length<n?pe.queue(this[0],e):void 0===t?this:this.each(function(){var n=pe.queue(this,e,t);pe._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&pe.dequeue(this,e)})},dequeue:function(e){return this.each(function(){pe.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,s=pe.Deferred(),i=this,a=this.length,o=function(){--r||s.resolveWith(i,[i])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";a--;)n=pe._data(i[a],e+"queueHooks"),n&&n.empty&&(r++,n.empty.add(o));return o(),s.promise(t)}}),function(){var e;fe.shrinkWrapBlocks=function(){if(null!=e)return e;e=!1;var t,n,r;return n=re.getElementsByTagName("body")[0],n&&n.style?(t=re.createElement("div"),r=re.createElement("div"),r.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",n.appendChild(r).appendChild(t),"undefined"!=typeof t.style.zoom&&(t.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:1px;width:1px;zoom:1",t.appendChild(re.createElement("div")).style.width="5px",e=3!==t.offsetWidth),n.removeChild(r),e):void 0}}();var Ie=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Me=new RegExp("^(?:([+-])=|)("+Ie+")([a-z%]*)$","i"),De=["Top","Right","Bottom","Left"],je=function(e,t){return e=t||e,"none"===pe.css(e,"display")||!pe.contains(e.ownerDocument,e)},Fe=function(e,t,n,r,s,i,a){var o=0,c=e.length,l=null==n;if("object"===pe.type(n)){s=!0;for(o in n)Fe(e,t,o,n[o],!0,i,a)}else if(void 0!==r&&(s=!0,pe.isFunction(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(pe(e),n)})),t))for(;c>o;o++)t(e[o],n,a?r:r.call(e[o],o,t(e[o],n)));return s?e:l?t.call(e):c?t(e[0],n):i},qe=/^(?:checkbox|radio)$/i,Ve=/<([\w:-]+)/,ze=/^$|\/(?:java|ecma)script/i,He=/^\s+/,Ue="abbr|article|aside|audio|bdi|canvas|data|datalist|details|dialog|figcaption|figure|footer|header|hgroup|main|mark|meter|nav|output|picture|progress|section|summary|template|time|video";!function(){var e=re.createElement("div"),t=re.createDocumentFragment(),n=re.createElement("input");e.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",fe.leadingWhitespace=3===e.firstChild.nodeType,fe.tbody=!e.getElementsByTagName("tbody").length,fe.htmlSerialize=!!e.getElementsByTagName("link").length,fe.html5Clone="<:nav></:nav>"!==re.createElement("nav").cloneNode(!0).outerHTML,n.type="checkbox",n.checked=!0,t.appendChild(n),fe.appendChecked=n.checked,e.innerHTML="<textarea>x</textarea>",fe.noCloneChecked=!!e.cloneNode(!0).lastChild.defaultValue,t.appendChild(e),n=re.createElement("input"),n.setAttribute("type","radio"),n.setAttribute("checked","checked"),n.setAttribute("name","t"),e.appendChild(n),fe.checkClone=e.cloneNode(!0).cloneNode(!0).lastChild.checked,fe.noCloneEvent=!!e.addEventListener,e[pe.expando]=1,fe.attributes=!e.getAttribute(pe.expando)}();var $e={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:fe.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]};$e.optgroup=$e.option,$e.tbody=$e.tfoot=$e.colgroup=$e.caption=$e.thead,$e.th=$e.td;var We=/<|&#?\w+;/,Ke=/<tbody/i;!function(){var t,n,r=re.createElement("div");for(t in{submit:!0,change:!0,focusin:!0})n="on"+t,(fe[t]=n in e)||(r.setAttribute(n,"t"),fe[t]=r.attributes[n].expando===!1);r=null}();var Xe=/^(?:input|select|textarea)$/i,Qe=/^key/,Je=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,Ge=/^(?:focusinfocus|focusoutblur)$/,Ye=/^([^.]*)(?:\.(.+)|)/;pe.event={global:{},add:function(e,t,n,r,s){var i,a,o,c,l,u,f,d,p,h,m,v=pe._data(e);if(v){for(n.handler&&(c=n,n=c.handler,s=c.selector),n.guid||(n.guid=pe.guid++),(a=v.events)||(a=v.events={}),(u=v.handle)||(u=v.handle=function(e){return"undefined"==typeof pe||e&&pe.event.triggered===e.type?void 0:pe.event.dispatch.apply(u.elem,arguments)},u.elem=e),t=(t||"").match(Ae)||[""],o=t.length;o--;)i=Ye.exec(t[o])||[],p=m=i[1],h=(i[2]||"").split(".").sort(),p&&(l=pe.event.special[p]||{},p=(s?l.delegateType:l.bindType)||p,l=pe.event.special[p]||{},f=pe.extend({type:p,origType:m,data:r,handler:n,guid:n.guid,selector:s,needsContext:s&&pe.expr.match.needsContext.test(s),namespace:h.join(".")},c),(d=a[p])||(d=a[p]=[],d.delegateCount=0,l.setup&&l.setup.call(e,r,h,u)!==!1||(e.addEventListener?e.addEventListener(p,u,!1):e.attachEvent&&e.attachEvent("on"+p,u))),l.add&&(l.add.call(e,f),f.handler.guid||(f.handler.guid=n.guid)),s?d.splice(d.delegateCount++,0,f):d.push(f),pe.event.global[p]=!0);e=null}},remove:function(e,t,n,r,s){var i,a,o,c,l,u,f,d,p,h,m,v=pe.hasData(e)&&pe._data(e);if(v&&(u=v.events)){for(t=(t||"").match(Ae)||[""],l=t.length;l--;)if(o=Ye.exec(t[l])||[],p=m=o[1],h=(o[2]||"").split(".").sort(),p){for(f=pe.event.special[p]||{},p=(r?f.delegateType:f.bindType)||p,d=u[p]||[],o=o[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),c=i=d.length;i--;)a=d[i],!s&&m!==a.origType||n&&n.guid!==a.guid||o&&!o.test(a.namespace)||r&&r!==a.selector&&("**"!==r||!a.selector)||(d.splice(i,1),a.selector&&d.delegateCount--,f.remove&&f.remove.call(e,a));c&&!d.length&&(f.teardown&&f.teardown.call(e,h,v.handle)!==!1||pe.removeEvent(e,p,v.handle),delete u[p])}else for(p in u)pe.event.remove(e,p+t[l],n,r,!0);pe.isEmptyObject(u)&&(delete v.handle,pe._removeData(e,"events"))}},trigger:function(t,n,r,s){var i,a,o,c,l,u,f,d=[r||re],p=ue.call(t,"type")?t.type:t,h=ue.call(t,"namespace")?t.namespace.split("."):[];if(o=u=r=r||re,3!==r.nodeType&&8!==r.nodeType&&!Ge.test(p+pe.event.triggered)&&(p.indexOf(".")>-1&&(h=p.split("."),p=h.shift(),h.sort()),a=p.indexOf(":")<0&&"on"+p,t=t[pe.expando]?t:new pe.Event(p,"object"==typeof t&&t),t.isTrigger=s?2:3,t.namespace=h.join("."),t.rnamespace=t.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=r),n=null==n?[t]:pe.makeArray(n,[t]),l=pe.event.special[p]||{},s||!l.trigger||l.trigger.apply(r,n)!==!1)){if(!s&&!l.noBubble&&!pe.isWindow(r)){for(c=l.delegateType||p,Ge.test(c+p)||(o=o.parentNode);o;o=o.parentNode)d.push(o),u=o;u===(r.ownerDocument||re)&&d.push(u.defaultView||u.parentWindow||e)}for(f=0;(o=d[f++])&&!t.isPropagationStopped();)t.type=f>1?c:l.bindType||p,i=(pe._data(o,"events")||{})[t.type]&&pe._data(o,"handle"),i&&i.apply(o,n),i=a&&o[a],i&&i.apply&&Re(o)&&(t.result=i.apply(o,n),t.result===!1&&t.preventDefault());if(t.type=p,!s&&!t.isDefaultPrevented()&&(!l._default||l._default.apply(d.pop(),n)===!1)&&Re(r)&&a&&r[p]&&!pe.isWindow(r)){u=r[a],u&&(r[a]=null),pe.event.triggered=p;try{r[p]()}catch(m){}pe.event.triggered=void 0,u&&(r[a]=u)}return t.result}},dispatch:function(e){e=pe.event.fix(e);var t,n,r,s,i,a=[],o=se.call(arguments),c=(pe._data(this,"events")||{})[e.type]||[],l=pe.event.special[e.type]||{};if(o[0]=e,e.delegateTarget=this,!l.preDispatch||l.preDispatch.call(this,e)!==!1){for(a=pe.event.handlers.call(this,e,c),t=0;(s=a[t++])&&!e.isPropagationStopped();)for(e.currentTarget=s.elem,n=0;(i=s.handlers[n++])&&!e.isImmediatePropagationStopped();)(!e.rnamespace||e.rnamespace.test(i.namespace))&&(e.handleObj=i,e.data=i.data,r=((pe.event.special[i.origType]||{}).handle||i.handler).apply(s.elem,o),void 0!==r&&(e.result=r)===!1&&(e.preventDefault(),e.stopPropagation()));return l.postDispatch&&l.postDispatch.call(this,e),e.result}},handlers:function(e,t){var n,r,s,i,a=[],o=t.delegateCount,c=e.target;if(o&&c.nodeType&&("click"!==e.type||isNaN(e.button)||e.button<1))for(;c!=this;c=c.parentNode||this)if(1===c.nodeType&&(c.disabled!==!0||"click"!==e.type)){for(r=[],n=0;o>n;n++)i=t[n],s=i.selector+" ",void 0===r[s]&&(r[s]=i.needsContext?pe(s,this).index(c)>-1:pe.find(s,this,null,[c]).length),r[s]&&r.push(i);r.length&&a.push({elem:c,handlers:r})}return o<t.length&&a.push({elem:this,handlers:t.slice(o)}),a},fix:function(e){if(e[pe.expando])return e;var t,n,r,s=e.type,i=e,a=this.fixHooks[s];for(a||(this.fixHooks[s]=a=Je.test(s)?this.mouseHooks:Qe.test(s)?this.keyHooks:{}),r=a.props?this.props.concat(a.props):this.props,e=new pe.Event(i),t=r.length;t--;)n=r[t],e[n]=i[n];return e.target||(e.target=i.srcElement||re),3===e.target.nodeType&&(e.target=e.target.parentNode),e.metaKey=!!e.metaKey,a.filter?a.filter(e,i):e},props:"altKey bubbles cancelable ctrlKey currentTarget detail eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,t){var n,r,s,i=t.button,a=t.fromElement;return null==e.pageX&&null!=t.clientX&&(r=e.target.ownerDocument||re,s=r.documentElement,n=r.body,e.pageX=t.clientX+(s&&s.scrollLeft||n&&n.scrollLeft||0)-(s&&s.clientLeft||n&&n.clientLeft||0),e.pageY=t.clientY+(s&&s.scrollTop||n&&n.scrollTop||0)-(s&&s.clientTop||n&&n.clientTop||0)),
!e.relatedTarget&&a&&(e.relatedTarget=a===e.target?t.toElement:a),e.which||void 0===i||(e.which=1&i?1:2&i?3:4&i?2:0),e}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==b()&&this.focus)try{return this.focus(),!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){return this===b()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return pe.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},_default:function(e){return pe.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n){var r=pe.extend(new pe.Event,n,{type:e,isSimulated:!0});pe.event.trigger(r,null,t),r.isDefaultPrevented()&&n.preventDefault()}},pe.removeEvent=re.removeEventListener?function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)}:function(e,t,n){var r="on"+t;e.detachEvent&&("undefined"==typeof e[r]&&(e[r]=null),e.detachEvent(r,n))},pe.Event=function(e,t){return this instanceof pe.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&e.returnValue===!1?g:y):this.type=e,t&&pe.extend(this,t),this.timeStamp=e&&e.timeStamp||pe.now(),void(this[pe.expando]=!0)):new pe.Event(e,t)},pe.Event.prototype={constructor:pe.Event,isDefaultPrevented:y,isPropagationStopped:y,isImmediatePropagationStopped:y,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=g,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=g,e&&!this.isSimulated&&(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0)},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=g,e&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),this.stopPropagation()}},pe.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){pe.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,s=e.relatedTarget,i=e.handleObj;return(!s||s!==r&&!pe.contains(r,s))&&(e.type=i.origType,n=i.handler.apply(this,arguments),e.type=t),n}}}),fe.submit||(pe.event.special.submit={setup:function(){return pe.nodeName(this,"form")?!1:void pe.event.add(this,"click._submit keypress._submit",function(e){var t=e.target,n=pe.nodeName(t,"input")||pe.nodeName(t,"button")?pe.prop(t,"form"):void 0;n&&!pe._data(n,"submit")&&(pe.event.add(n,"submit._submit",function(e){e._submitBubble=!0}),pe._data(n,"submit",!0))})},postDispatch:function(e){e._submitBubble&&(delete e._submitBubble,this.parentNode&&!e.isTrigger&&pe.event.simulate("submit",this.parentNode,e))},teardown:function(){return pe.nodeName(this,"form")?!1:void pe.event.remove(this,"._submit")}}),fe.change||(pe.event.special.change={setup:function(){return Xe.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(pe.event.add(this,"propertychange._change",function(e){"checked"===e.originalEvent.propertyName&&(this._justChanged=!0)}),pe.event.add(this,"click._change",function(e){this._justChanged&&!e.isTrigger&&(this._justChanged=!1),pe.event.simulate("change",this,e)})),!1):void pe.event.add(this,"beforeactivate._change",function(e){var t=e.target;Xe.test(t.nodeName)&&!pe._data(t,"change")&&(pe.event.add(t,"change._change",function(e){!this.parentNode||e.isSimulated||e.isTrigger||pe.event.simulate("change",this.parentNode,e)}),pe._data(t,"change",!0))})},handle:function(e){var t=e.target;return this!==t||e.isSimulated||e.isTrigger||"radio"!==t.type&&"checkbox"!==t.type?e.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return pe.event.remove(this,"._change"),!Xe.test(this.nodeName)}}),fe.focusin||pe.each({focus:"focusin",blur:"focusout"},function(e,t){var n=function(e){pe.event.simulate(t,e.target,pe.event.fix(e))};pe.event.special[t]={setup:function(){var r=this.ownerDocument||this,s=pe._data(r,t);s||r.addEventListener(e,n,!0),pe._data(r,t,(s||0)+1)},teardown:function(){var r=this.ownerDocument||this,s=pe._data(r,t)-1;s?pe._data(r,t,s):(r.removeEventListener(e,n,!0),pe._removeData(r,t))}}}),pe.fn.extend({on:function(e,t,n,r){return x(this,e,t,n,r)},one:function(e,t,n,r){return x(this,e,t,n,r,1)},off:function(e,t,n){var r,s;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,pe(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(s in e)this.off(s,t,e[s]);return this}return(t===!1||"function"==typeof t)&&(n=t,t=void 0),n===!1&&(n=y),this.each(function(){pe.event.remove(this,e,n,t)})},trigger:function(e,t){return this.each(function(){pe.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];return n?pe.event.trigger(e,t,n,!0):void 0}});var Ze=/ jQuery\d+="(?:null|\d+)"/g,et=new RegExp("<(?:"+Ue+")[\\s/>]","i"),tt=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi,nt=/<script|<style|<link/i,rt=/checked\s*(?:[^=]|=\s*.checked.)/i,st=/^true\/(.*)/,it=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,at=p(re),ot=at.appendChild(re.createElement("div"));pe.extend({htmlPrefilter:function(e){return e.replace(tt,"<$1></$2>")},clone:function(e,t,n){var r,s,i,a,o,c=pe.contains(e.ownerDocument,e);if(fe.html5Clone||pe.isXMLDoc(e)||!et.test("<"+e.nodeName+">")?i=e.cloneNode(!0):(ot.innerHTML=e.outerHTML,ot.removeChild(i=ot.firstChild)),!(fe.noCloneEvent&&fe.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||pe.isXMLDoc(e)))for(r=h(i),o=h(e),a=0;null!=(s=o[a]);++a)r[a]&&C(s,r[a]);if(t)if(n)for(o=o||h(e),r=r||h(i),a=0;null!=(s=o[a]);a++)T(s,r[a]);else T(e,i);return r=h(i,"script"),r.length>0&&m(r,!c&&h(e,"script")),r=o=s=null,i},cleanData:function(e,t){for(var n,r,s,i,a=0,o=pe.expando,c=pe.cache,l=fe.attributes,u=pe.event.special;null!=(n=e[a]);a++)if((t||Re(n))&&(s=n[o],i=s&&c[s])){if(i.events)for(r in i.events)u[r]?pe.event.remove(n,r):pe.removeEvent(n,r,i.handle);c[s]&&(delete c[s],l||"undefined"==typeof n.removeAttribute?n[o]=void 0:n.removeAttribute(o),ne.push(s))}}}),pe.fn.extend({domManip:S,detach:function(e){return O(this,e,!0)},remove:function(e){return O(this,e)},text:function(e){return Fe(this,function(e){return void 0===e?pe.text(this):this.empty().append((this[0]&&this[0].ownerDocument||re).createTextNode(e))},null,e,arguments.length)},append:function(){return S(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=w(this,e);t.appendChild(e)}})},prepend:function(){return S(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=w(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return S(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return S(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++){for(1===e.nodeType&&pe.cleanData(h(e,!1));e.firstChild;)e.removeChild(e.firstChild);e.options&&pe.nodeName(e,"select")&&(e.options.length=0)}return this},clone:function(e,t){return e=null==e?!1:e,t=null==t?e:t,this.map(function(){return pe.clone(this,e,t)})},html:function(e){return Fe(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e)return 1===t.nodeType?t.innerHTML.replace(Ze,""):void 0;if("string"==typeof e&&!nt.test(e)&&(fe.htmlSerialize||!et.test(e))&&(fe.leadingWhitespace||!He.test(e))&&!$e[(Ve.exec(e)||["",""])[1].toLowerCase()]){e=pe.htmlPrefilter(e);try{for(;r>n;n++)t=this[n]||{},1===t.nodeType&&(pe.cleanData(h(t,!1)),t.innerHTML=e);t=0}catch(s){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=[];return S(this,arguments,function(t){var n=this.parentNode;pe.inArray(this,e)<0&&(pe.cleanData(h(this)),n&&n.replaceChild(t,this))},e)}}),pe.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){pe.fn[e]=function(e){for(var n,r=0,s=[],i=pe(e),a=i.length-1;a>=r;r++)n=r===a?this:this.clone(!0),pe(i[r])[t](n),ae.apply(s,n.get());return this.pushStack(s)}});var ct,lt={HTML:"block",BODY:"block"},ut=/^margin/,ft=new RegExp("^("+Ie+")(?!px)[a-z%]+$","i"),dt=function(e,t,n,r){var s,i,a={};for(i in t)a[i]=e.style[i],e.style[i]=t[i];s=n.apply(e,r||[]);for(i in t)e.style[i]=a[i];return s},pt=re.documentElement;!function(){function t(){var t,u,f=re.documentElement;f.appendChild(c),l.style.cssText="-webkit-box-sizing:border-box;box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",n=s=o=!1,r=a=!0,e.getComputedStyle&&(u=e.getComputedStyle(l),n="1%"!==(u||{}).top,o="2px"===(u||{}).marginLeft,s="4px"===(u||{width:"4px"}).width,l.style.marginRight="50%",r="4px"===(u||{marginRight:"4px"}).marginRight,t=l.appendChild(re.createElement("div")),t.style.cssText=l.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",t.style.marginRight=t.style.width="0",l.style.width="1px",a=!parseFloat((e.getComputedStyle(t)||{}).marginRight),l.removeChild(t)),l.style.display="none",i=0===l.getClientRects().length,i&&(l.style.display="",l.innerHTML="<table><tr><td></td><td>t</td></tr></table>",t=l.getElementsByTagName("td"),t[0].style.cssText="margin:0;border:0;padding:0;display:none",i=0===t[0].offsetHeight,i&&(t[0].style.display="",t[1].style.display="none",i=0===t[0].offsetHeight)),f.removeChild(c)}var n,r,s,i,a,o,c=re.createElement("div"),l=re.createElement("div");l.style&&(l.style.cssText="float:left;opacity:.5",fe.opacity="0.5"===l.style.opacity,fe.cssFloat=!!l.style.cssFloat,l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",fe.clearCloneStyle="content-box"===l.style.backgroundClip,c=re.createElement("div"),c.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",l.innerHTML="",c.appendChild(l),fe.boxSizing=""===l.style.boxSizing||""===l.style.MozBoxSizing||""===l.style.WebkitBoxSizing,pe.extend(fe,{reliableHiddenOffsets:function(){return null==n&&t(),i},boxSizingReliable:function(){return null==n&&t(),s},pixelMarginRight:function(){return null==n&&t(),r},pixelPosition:function(){return null==n&&t(),n},reliableMarginRight:function(){return null==n&&t(),a},reliableMarginLeft:function(){return null==n&&t(),o}}))}();var ht,mt,vt=/^(top|right|bottom|left)$/;e.getComputedStyle?(ht=function(t){var n=t.ownerDocument.defaultView;return n.opener||(n=e),n.getComputedStyle(t)},mt=function(e,t,n){var r,s,i,a,o=e.style;return n=n||ht(e),a=n?n.getPropertyValue(t)||n[t]:void 0,n&&(""!==a||pe.contains(e.ownerDocument,e)||(a=pe.style(e,t)),!fe.pixelMarginRight()&&ft.test(a)&&ut.test(t)&&(r=o.width,s=o.minWidth,i=o.maxWidth,o.minWidth=o.maxWidth=o.width=a,a=n.width,o.width=r,o.minWidth=s,o.maxWidth=i)),void 0===a?a:a+""}):pt.currentStyle&&(ht=function(e){return e.currentStyle},mt=function(e,t,n){var r,s,i,a,o=e.style;return n=n||ht(e),a=n?n[t]:void 0,null==a&&o&&o[t]&&(a=o[t]),ft.test(a)&&!vt.test(t)&&(r=o.left,s=e.runtimeStyle,i=s&&s.left,i&&(s.left=e.currentStyle.left),o.left="fontSize"===t?"1em":a,a=o.pixelLeft+"px",o.left=r,i&&(s.left=i)),void 0===a?a:a+""||"auto"});var _t=/alpha\([^)]*\)/i,gt=/opacity\s*=\s*([^)]*)/i,yt=/^(none|table(?!-c[ea]).+)/,bt=new RegExp("^("+Ie+")(.*)$","i"),xt={position:"absolute",visibility:"hidden",display:"block"},wt={letterSpacing:"0",fontWeight:"400"},kt=["Webkit","O","Moz","ms"],Et=re.createElement("div").style;pe.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=mt(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":fe.cssFloat?"cssFloat":"styleFloat"},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var s,i,a,o=pe.camelCase(t),c=e.style;if(t=pe.cssProps[o]||(pe.cssProps[o]=R(o)||o),a=pe.cssHooks[t]||pe.cssHooks[o],void 0===n)return a&&"get"in a&&void 0!==(s=a.get(e,!1,r))?s:c[t];if(i=typeof n,"string"===i&&(s=Me.exec(n))&&s[1]&&(n=d(e,t,s),i="number"),null!=n&&n===n&&("number"===i&&(n+=s&&s[3]||(pe.cssNumber[o]?"":"px")),fe.clearCloneStyle||""!==n||0!==t.indexOf("background")||(c[t]="inherit"),!(a&&"set"in a&&void 0===(n=a.set(e,n,r)))))try{c[t]=n}catch(l){}}},css:function(e,t,n,r){var s,i,a,o=pe.camelCase(t);return t=pe.cssProps[o]||(pe.cssProps[o]=R(o)||o),a=pe.cssHooks[t]||pe.cssHooks[o],a&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=mt(e,t,r)),"normal"===i&&t in wt&&(i=wt[t]),""===n||n?(s=parseFloat(i),n===!0||isFinite(s)?s||0:i):i}}),pe.each(["height","width"],function(e,t){pe.cssHooks[t]={get:function(e,n,r){return n?yt.test(pe.css(e,"display"))&&0===e.offsetWidth?dt(e,xt,function(){return M(e,t,r)}):M(e,t,r):void 0},set:function(e,n,r){var s=r&&ht(e);return P(e,n,r?I(e,t,r,fe.boxSizing&&"border-box"===pe.css(e,"boxSizing",!1,s),s):0)}}}),fe.opacity||(pe.cssHooks.opacity={get:function(e,t){return gt.test((t&&e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var n=e.style,r=e.currentStyle,s=pe.isNumeric(t)?"alpha(opacity="+100*t+")":"",i=r&&r.filter||n.filter||"";n.zoom=1,(t>=1||""===t)&&""===pe.trim(i.replace(_t,""))&&n.removeAttribute&&(n.removeAttribute("filter"),""===t||r&&!r.filter)||(n.filter=_t.test(i)?i.replace(_t,s):i+" "+s)}}),pe.cssHooks.marginRight=B(fe.reliableMarginRight,function(e,t){return t?dt(e,{display:"inline-block"},mt,[e,"marginRight"]):void 0}),pe.cssHooks.marginLeft=B(fe.reliableMarginLeft,function(e,t){return t?(parseFloat(mt(e,"marginLeft"))||(pe.contains(e.ownerDocument,e)?e.getBoundingClientRect().left-dt(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}):0))+"px":void 0}),pe.each({margin:"",padding:"",border:"Width"},function(e,t){pe.cssHooks[e+t]={expand:function(n){for(var r=0,s={},i="string"==typeof n?n.split(" "):[n];4>r;r++)s[e+De[r]+t]=i[r]||i[r-2]||i[0];return s}},ut.test(e)||(pe.cssHooks[e+t].set=P)}),pe.fn.extend({css:function(e,t){return Fe(this,function(e,t,n){var r,s,i={},a=0;if(pe.isArray(t)){for(r=ht(e),s=t.length;s>a;a++)i[t[a]]=pe.css(e,t[a],!1,r);return i}return void 0!==n?pe.style(e,t,n):pe.css(e,t)},e,t,arguments.length>1)},show:function(){return L(this,!0)},hide:function(){return L(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){je(this)?pe(this).show():pe(this).hide()})}}),pe.Tween=D,D.prototype={constructor:D,init:function(e,t,n,r,s,i){this.elem=e,this.prop=n,this.easing=s||pe.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=i||(pe.cssNumber[n]?"":"px")},cur:function(){var e=D.propHooks[this.prop];return e&&e.get?e.get(this):D.propHooks._default.get(this)},run:function(e){var t,n=D.propHooks[this.prop];return this.options.duration?this.pos=t=pe.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):D.propHooks._default.set(this),this}},D.prototype.init.prototype=D.prototype,D.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=pe.css(e.elem,e.prop,""),t&&"auto"!==t?t:0)},set:function(e){pe.fx.step[e.prop]?pe.fx.step[e.prop](e):1!==e.elem.nodeType||null==e.elem.style[pe.cssProps[e.prop]]&&!pe.cssHooks[e.prop]?e.elem[e.prop]=e.now:pe.style(e.elem,e.prop,e.now+e.unit)}}},D.propHooks.scrollTop=D.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},pe.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},pe.fx=D.prototype.init,pe.fx.step={};var Tt,Ct,St=/^(?:toggle|show|hide)$/,Ot=/queueHooks$/;pe.Animation=pe.extend(H,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return d(n.elem,e,Me.exec(t),n),n}]},tweener:function(e,t){pe.isFunction(e)?(t=e,e=["*"]):e=e.match(Ae);for(var n,r=0,s=e.length;s>r;r++)n=e[r],H.tweeners[n]=H.tweeners[n]||[],H.tweeners[n].unshift(t)},prefilters:[V],prefilter:function(e,t){t?H.prefilters.unshift(e):H.prefilters.push(e)}}),pe.speed=function(e,t,n){var r=e&&"object"==typeof e?pe.extend({},e):{complete:n||!n&&t||pe.isFunction(e)&&e,duration:e,easing:n&&t||t&&!pe.isFunction(t)&&t};return r.duration=pe.fx.off?0:"number"==typeof r.duration?r.duration:r.duration in pe.fx.speeds?pe.fx.speeds[r.duration]:pe.fx.speeds._default,(null==r.queue||r.queue===!0)&&(r.queue="fx"),r.old=r.complete,r.complete=function(){pe.isFunction(r.old)&&r.old.call(this),r.queue&&pe.dequeue(this,r.queue)},r},pe.fn.extend({fadeTo:function(e,t,n,r){return this.filter(je).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var s=pe.isEmptyObject(e),i=pe.speed(t,n,r),a=function(){var t=H(this,pe.extend({},e),i);(s||pe._data(this,"finish"))&&t.stop(!0)};return a.finish=a,s||i.queue===!1?this.each(a):this.queue(i.queue,a)},stop:function(e,t,n){var r=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=void 0),t&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,s=null!=e&&e+"queueHooks",i=pe.timers,a=pe._data(this);if(s)a[s]&&a[s].stop&&r(a[s]);else for(s in a)a[s]&&a[s].stop&&Ot.test(s)&&r(a[s]);for(s=i.length;s--;)i[s].elem!==this||null!=e&&i[s].queue!==e||(i[s].anim.stop(n),t=!1,i.splice(s,1));(t||!n)&&pe.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,n=pe._data(this),r=n[e+"queue"],s=n[e+"queueHooks"],i=pe.timers,a=r?r.length:0;for(n.finish=!0,pe.queue(this,e,[]),s&&s.stop&&s.stop.call(this,!0),t=i.length;t--;)i[t].elem===this&&i[t].queue===e&&(i[t].anim.stop(!0),i.splice(t,1));for(t=0;a>t;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}}),pe.each(["toggle","show","hide"],function(e,t){var n=pe.fn[t];pe.fn[t]=function(e,r,s){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(F(t,!0),e,r,s)}}),pe.each({slideDown:F("show"),slideUp:F("hide"),slideToggle:F("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){pe.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),pe.timers=[],pe.fx.tick=function(){var e,t=pe.timers,n=0;for(Tt=pe.now();n<t.length;n++)e=t[n],e()||t[n]!==e||t.splice(n--,1);t.length||pe.fx.stop(),Tt=void 0},pe.fx.timer=function(e){pe.timers.push(e),e()?pe.fx.start():pe.timers.pop()},pe.fx.interval=13,pe.fx.start=function(){Ct||(Ct=e.setInterval(pe.fx.tick,pe.fx.interval))},pe.fx.stop=function(){e.clearInterval(Ct),Ct=null},pe.fx.speeds={slow:600,fast:200,_default:400},pe.fn.delay=function(t,n){return t=pe.fx?pe.fx.speeds[t]||t:t,n=n||"fx",this.queue(n,function(n,r){var s=e.setTimeout(n,t);r.stop=function(){e.clearTimeout(s)}})},function(){var e,t=re.createElement("input"),n=re.createElement("div"),r=re.createElement("select"),s=r.appendChild(re.createElement("option"));n=re.createElement("div"),n.setAttribute("className","t"),n.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",e=n.getElementsByTagName("a")[0],t.setAttribute("type","checkbox"),n.appendChild(t),e=n.getElementsByTagName("a")[0],e.style.cssText="top:1px",fe.getSetAttribute="t"!==n.className,fe.style=/top/.test(e.getAttribute("style")),fe.hrefNormalized="/a"===e.getAttribute("href"),fe.checkOn=!!t.value,fe.optSelected=s.selected,fe.enctype=!!re.createElement("form").enctype,r.disabled=!0,fe.optDisabled=!s.disabled,t=re.createElement("input"),t.setAttribute("value",""),fe.input=""===t.getAttribute("value"),t.value="t",t.setAttribute("type","radio"),fe.radioValue="t"===t.value}();var At=/\r/g;pe.fn.extend({val:function(e){var t,n,r,s=this[0];return arguments.length?(r=pe.isFunction(e),this.each(function(n){var s;1===this.nodeType&&(s=r?e.call(this,n,pe(this).val()):e,null==s?s="":"number"==typeof s?s+="":pe.isArray(s)&&(s=pe.map(s,function(e){return null==e?"":e+""})),t=pe.valHooks[this.type]||pe.valHooks[this.nodeName.toLowerCase()],t&&"set"in t&&void 0!==t.set(this,s,"value")||(this.value=s))})):s?(t=pe.valHooks[s.type]||pe.valHooks[s.nodeName.toLowerCase()],t&&"get"in t&&void 0!==(n=t.get(s,"value"))?n:(n=s.value,"string"==typeof n?n.replace(At,""):null==n?"":n)):void 0}}),pe.extend({valHooks:{option:{get:function(e){var t=pe.find.attr(e,"value");return null!=t?t:pe.trim(pe.text(e))}},select:{get:function(e){for(var t,n,r=e.options,s=e.selectedIndex,i="select-one"===e.type||0>s,a=i?null:[],o=i?s+1:r.length,c=0>s?o:i?s:0;o>c;c++)if(n=r[c],(n.selected||c===s)&&(fe.optDisabled?!n.disabled:null===n.getAttribute("disabled"))&&(!n.parentNode.disabled||!pe.nodeName(n.parentNode,"optgroup"))){if(t=pe(n).val(),i)return t;a.push(t)}return a},set:function(e,t){for(var n,r,s=e.options,i=pe.makeArray(t),a=s.length;a--;)if(r=s[a],pe.inArray(pe.valHooks.option.get(r),i)>=0)try{r.selected=n=!0}catch(o){r.scrollHeight}else r.selected=!1;return n||(e.selectedIndex=-1),s}}}}),pe.each(["radio","checkbox"],function(){pe.valHooks[this]={set:function(e,t){return pe.isArray(t)?e.checked=pe.inArray(pe(e).val(),t)>-1:void 0}},fe.checkOn||(pe.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Nt,Bt,Rt=pe.expr.attrHandle,Lt=/^(?:checked|selected)$/i,Pt=fe.getSetAttribute,It=fe.input;pe.fn.extend({attr:function(e,t){return Fe(this,pe.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){pe.removeAttr(this,e)})}}),pe.extend({attr:function(e,t,n){var r,s,i=e.nodeType;return 3!==i&&8!==i&&2!==i?"undefined"==typeof e.getAttribute?pe.prop(e,t,n):(1===i&&pe.isXMLDoc(e)||(t=t.toLowerCase(),s=pe.attrHooks[t]||(pe.expr.match.bool.test(t)?Bt:Nt)),void 0!==n?null===n?void pe.removeAttr(e,t):s&&"set"in s&&void 0!==(r=s.set(e,n,t))?r:(e.setAttribute(t,n+""),n):s&&"get"in s&&null!==(r=s.get(e,t))?r:(r=pe.find.attr(e,t),null==r?void 0:r)):void 0},attrHooks:{type:{set:function(e,t){if(!fe.radioValue&&"radio"===t&&pe.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r,s=0,i=t&&t.match(Ae);if(i&&1===e.nodeType)for(;n=i[s++];)r=pe.propFix[n]||n,pe.expr.match.bool.test(n)?It&&Pt||!Lt.test(n)?e[r]=!1:e[pe.camelCase("default-"+n)]=e[r]=!1:pe.attr(e,n,""),e.removeAttribute(Pt?n:r)}}),Bt={set:function(e,t,n){return t===!1?pe.removeAttr(e,n):It&&Pt||!Lt.test(n)?e.setAttribute(!Pt&&pe.propFix[n]||n,n):e[pe.camelCase("default-"+n)]=e[n]=!0,n}},pe.each(pe.expr.match.bool.source.match(/\w+/g),function(e,t){var n=Rt[t]||pe.find.attr;It&&Pt||!Lt.test(t)?Rt[t]=function(e,t,r){var s,i;return r||(i=Rt[t],Rt[t]=s,s=null!=n(e,t,r)?t.toLowerCase():null,Rt[t]=i),s}:Rt[t]=function(e,t,n){return n?void 0:e[pe.camelCase("default-"+t)]?t.toLowerCase():null}}),It&&Pt||(pe.attrHooks.value={set:function(e,t,n){return pe.nodeName(e,"input")?void(e.defaultValue=t):Nt&&Nt.set(e,t,n)}}),Pt||(Nt={set:function(e,t,n){var r=e.getAttributeNode(n);return r||e.setAttributeNode(r=e.ownerDocument.createAttribute(n)),r.value=t+="","value"===n||t===e.getAttribute(n)?t:void 0}},Rt.id=Rt.name=Rt.coords=function(e,t,n){var r;return n?void 0:(r=e.getAttributeNode(t))&&""!==r.value?r.value:null},pe.valHooks.button={get:function(e,t){var n=e.getAttributeNode(t);return n&&n.specified?n.value:void 0},set:Nt.set},pe.attrHooks.contenteditable={set:function(e,t,n){Nt.set(e,""===t?!1:t,n)}},pe.each(["width","height"],function(e,t){pe.attrHooks[t]={set:function(e,n){return""===n?(e.setAttribute(t,"auto"),n):void 0}}})),fe.style||(pe.attrHooks.style={get:function(e){return e.style.cssText||void 0},set:function(e,t){return e.style.cssText=t+""}});var Mt=/^(?:input|select|textarea|button|object)$/i,Dt=/^(?:a|area)$/i;pe.fn.extend({prop:function(e,t){return Fe(this,pe.prop,e,t,arguments.length>1)},removeProp:function(e){return e=pe.propFix[e]||e,this.each(function(){try{this[e]=void 0,delete this[e]}catch(t){}})}}),pe.extend({prop:function(e,t,n){var r,s,i=e.nodeType;return 3!==i&&8!==i&&2!==i?(1===i&&pe.isXMLDoc(e)||(t=pe.propFix[t]||t,s=pe.propHooks[t]),void 0!==n?s&&"set"in s&&void 0!==(r=s.set(e,n,t))?r:e[t]=n:s&&"get"in s&&null!==(r=s.get(e,t))?r:e[t]):void 0},propHooks:{tabIndex:{get:function(e){var t=pe.find.attr(e,"tabindex");return t?parseInt(t,10):Mt.test(e.nodeName)||Dt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),fe.hrefNormalized||pe.each(["href","src"],function(e,t){pe.propHooks[t]={get:function(e){return e.getAttribute(t,4)}}}),fe.optSelected||(pe.propHooks.selected={get:function(e){var t=e.parentNode;return t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex),null}}),pe.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){pe.propFix[this.toLowerCase()]=this}),fe.enctype||(pe.propFix.enctype="encoding");var jt=/[\t\r\n\f]/g;pe.fn.extend({addClass:function(e){var t,n,r,s,i,a,o,c=0;if(pe.isFunction(e))return this.each(function(t){pe(this).addClass(e.call(this,t,U(this)))});if("string"==typeof e&&e)for(t=e.match(Ae)||[];n=this[c++];)if(s=U(n),r=1===n.nodeType&&(" "+s+" ").replace(jt," ")){for(a=0;i=t[a++];)r.indexOf(" "+i+" ")<0&&(r+=i+" ");o=pe.trim(r),s!==o&&pe.attr(n,"class",o)}return this},removeClass:function(e){var t,n,r,s,i,a,o,c=0;if(pe.isFunction(e))return this.each(function(t){pe(this).removeClass(e.call(this,t,U(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof e&&e)for(t=e.match(Ae)||[];n=this[c++];)if(s=U(n),r=1===n.nodeType&&(" "+s+" ").replace(jt," ")){for(a=0;i=t[a++];)for(;r.indexOf(" "+i+" ")>-1;)r=r.replace(" "+i+" "," ");o=pe.trim(r),s!==o&&pe.attr(n,"class",o)}return this},toggleClass:function(e,t){var n=typeof e;return"boolean"==typeof t&&"string"===n?t?this.addClass(e):this.removeClass(e):pe.isFunction(e)?this.each(function(n){pe(this).toggleClass(e.call(this,n,U(this),t),t)}):this.each(function(){var t,r,s,i;if("string"===n)for(r=0,s=pe(this),i=e.match(Ae)||[];t=i[r++];)s.hasClass(t)?s.removeClass(t):s.addClass(t);else(void 0===e||"boolean"===n)&&(t=U(this),t&&pe._data(this,"__className__",t),pe.attr(this,"class",t||e===!1?"":pe._data(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;for(t=" "+e+" ";n=this[r++];)if(1===n.nodeType&&(" "+U(n)+" ").replace(jt," ").indexOf(t)>-1)return!0;return!1}}),pe.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){pe.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),pe.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}});var Ft=e.location,qt=pe.now(),Vt=/\?/,zt=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;pe.parseJSON=function(t){if(e.JSON&&e.JSON.parse)return e.JSON.parse(t+"");var n,r=null,s=pe.trim(t+"");return s&&!pe.trim(s.replace(zt,function(e,t,s,i){return n&&t&&(r=0),0===r?e:(n=s||t,r+=!i-!s,"")}))?Function("return "+s)():pe.error("Invalid JSON: "+t)},pe.parseXML=function(t){var n,r;if(!t||"string"!=typeof t)return null;try{e.DOMParser?(r=new e.DOMParser,n=r.parseFromString(t,"text/xml")):(n=new e.ActiveXObject("Microsoft.XMLDOM"),n.async="false",n.loadXML(t))}catch(s){n=void 0}return n&&n.documentElement&&!n.getElementsByTagName("parsererror").length||pe.error("Invalid XML: "+t),n};var Ht=/#.*$/,Ut=/([?&])_=[^&]*/,$t=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Wt=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Kt=/^(?:GET|HEAD)$/,Xt=/^\/\//,Qt=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,Jt={},Gt={},Yt="*/".concat("*"),Zt=Ft.href,en=Qt.exec(Zt.toLowerCase())||[];pe.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Zt,type:"GET",isLocal:Wt.test(en[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Yt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":pe.parseJSON,"text xml":pe.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?K(K(e,pe.ajaxSettings),t):K(pe.ajaxSettings,e)},ajaxPrefilter:$(Jt),ajaxTransport:$(Gt),ajax:function(t,n){function r(t,n,r,s){var i,f,g,y,x,k=n;2!==b&&(b=2,c&&e.clearTimeout(c),u=void 0,o=s||"",w.readyState=t>0?4:0,i=t>=200&&300>t||304===t,r&&(y=X(d,w,r)),y=Q(d,y,w,i),i?(d.ifModified&&(x=w.getResponseHeader("Last-Modified"),x&&(pe.lastModified[a]=x),x=w.getResponseHeader("etag"),x&&(pe.etag[a]=x)),204===t||"HEAD"===d.type?k="nocontent":304===t?k="notmodified":(k=y.state,f=y.data,g=y.error,i=!g)):(g=k,(t||!k)&&(k="error",0>t&&(t=0))),w.status=t,w.statusText=(n||k)+"",i?m.resolveWith(p,[f,k,w]):m.rejectWith(p,[w,k,g]),w.statusCode(_),_=void 0,l&&h.trigger(i?"ajaxSuccess":"ajaxError",[w,d,i?f:g]),v.fireWith(p,[w,k]),l&&(h.trigger("ajaxComplete",[w,d]),--pe.active||pe.event.trigger("ajaxStop")))}"object"==typeof t&&(n=t,t=void 0),n=n||{};var s,i,a,o,c,l,u,f,d=pe.ajaxSetup({},n),p=d.context||d,h=d.context&&(p.nodeType||p.jquery)?pe(p):pe.event,m=pe.Deferred(),v=pe.Callbacks("once memory"),_=d.statusCode||{},g={},y={},b=0,x="canceled",w={readyState:0,getResponseHeader:function(e){var t;if(2===b){if(!f)for(f={};t=$t.exec(o);)f[t[1].toLowerCase()]=t[2];t=f[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===b?o:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return b||(e=y[n]=y[n]||e,g[e]=t),this},overrideMimeType:function(e){return b||(d.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>b)for(t in e)_[t]=[_[t],e[t]];else w.always(e[w.status]);return this},abort:function(e){var t=e||x;return u&&u.abort(t),r(0,t),this}};if(m.promise(w).complete=v.add,w.success=w.done,w.error=w.fail,d.url=((t||d.url||Zt)+"").replace(Ht,"").replace(Xt,en[1]+"//"),d.type=n.method||n.type||d.method||d.type,d.dataTypes=pe.trim(d.dataType||"*").toLowerCase().match(Ae)||[""],null==d.crossDomain&&(s=Qt.exec(d.url.toLowerCase()),d.crossDomain=!(!s||s[1]===en[1]&&s[2]===en[2]&&(s[3]||("http:"===s[1]?"80":"443"))===(en[3]||("http:"===en[1]?"80":"443")))),d.data&&d.processData&&"string"!=typeof d.data&&(d.data=pe.param(d.data,d.traditional)),W(Jt,d,n,w),2===b)return w;l=pe.event&&d.global,l&&0===pe.active++&&pe.event.trigger("ajaxStart"),d.type=d.type.toUpperCase(),d.hasContent=!Kt.test(d.type),a=d.url,d.hasContent||(d.data&&(a=d.url+=(Vt.test(a)?"&":"?")+d.data,delete d.data),d.cache===!1&&(d.url=Ut.test(a)?a.replace(Ut,"$1_="+qt++):a+(Vt.test(a)?"&":"?")+"_="+qt++)),d.ifModified&&(pe.lastModified[a]&&w.setRequestHeader("If-Modified-Since",pe.lastModified[a]),pe.etag[a]&&w.setRequestHeader("If-None-Match",pe.etag[a])),(d.data&&d.hasContent&&d.contentType!==!1||n.contentType)&&w.setRequestHeader("Content-Type",d.contentType),w.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+("*"!==d.dataTypes[0]?", "+Yt+"; q=0.01":""):d.accepts["*"]);for(i in d.headers)w.setRequestHeader(i,d.headers[i]);if(d.beforeSend&&(d.beforeSend.call(p,w,d)===!1||2===b))return w.abort();x="abort";for(i in{success:1,error:1,complete:1})w[i](d[i]);if(u=W(Gt,d,n,w)){if(w.readyState=1,l&&h.trigger("ajaxSend",[w,d]),2===b)return w;d.async&&d.timeout>0&&(c=e.setTimeout(function(){w.abort("timeout")},d.timeout));try{b=1,u.send(g,r)}catch(k){if(!(2>b))throw k;r(-1,k)}}else r(-1,"No Transport");
return w},getJSON:function(e,t,n){return pe.get(e,t,n,"json")},getScript:function(e,t){return pe.get(e,void 0,t,"script")}}),pe.each(["get","post"],function(e,t){pe[t]=function(e,n,r,s){return pe.isFunction(n)&&(s=s||r,r=n,n=void 0),pe.ajax(pe.extend({url:e,type:t,dataType:s,data:n,success:r},pe.isPlainObject(e)&&e))}}),pe._evalUrl=function(e){return pe.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,"throws":!0})},pe.fn.extend({wrapAll:function(e){if(pe.isFunction(e))return this.each(function(t){pe(this).wrapAll(e.call(this,t))});if(this[0]){var t=pe(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstChild&&1===e.firstChild.nodeType;)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return pe.isFunction(e)?this.each(function(t){pe(this).wrapInner(e.call(this,t))}):this.each(function(){var t=pe(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=pe.isFunction(e);return this.each(function(n){pe(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){pe.nodeName(this,"body")||pe(this).replaceWith(this.childNodes)}).end()}}),pe.expr.filters.hidden=function(e){return fe.reliableHiddenOffsets()?e.offsetWidth<=0&&e.offsetHeight<=0&&!e.getClientRects().length:G(e)},pe.expr.filters.visible=function(e){return!pe.expr.filters.hidden(e)};var tn=/%20/g,nn=/\[\]$/,rn=/\r?\n/g,sn=/^(?:submit|button|image|reset|file)$/i,an=/^(?:input|select|textarea|keygen)/i;pe.param=function(e,t){var n,r=[],s=function(e,t){t=pe.isFunction(t)?t():null==t?"":t,r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(void 0===t&&(t=pe.ajaxSettings&&pe.ajaxSettings.traditional),pe.isArray(e)||e.jquery&&!pe.isPlainObject(e))pe.each(e,function(){s(this.name,this.value)});else for(n in e)Y(n,e[n],t,s);return r.join("&").replace(tn,"+")},pe.fn.extend({serialize:function(){return pe.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=pe.prop(this,"elements");return e?pe.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!pe(this).is(":disabled")&&an.test(this.nodeName)&&!sn.test(e)&&(this.checked||!qe.test(e))}).map(function(e,t){var n=pe(this).val();return null==n?null:pe.isArray(n)?pe.map(n,function(e){return{name:t.name,value:e.replace(rn,"\r\n")}}):{name:t.name,value:n.replace(rn,"\r\n")}}).get()}}),pe.ajaxSettings.xhr=void 0!==e.ActiveXObject?function(){return this.isLocal?ee():re.documentMode>8?Z():/^(get|post|head|put|delete|options)$/i.test(this.type)&&Z()||ee()}:Z;var on=0,cn={},ln=pe.ajaxSettings.xhr();e.attachEvent&&e.attachEvent("onunload",function(){for(var e in cn)cn[e](void 0,!0)}),fe.cors=!!ln&&"withCredentials"in ln,ln=fe.ajax=!!ln,ln&&pe.ajaxTransport(function(t){if(!t.crossDomain||fe.cors){var n;return{send:function(r,s){var i,a=t.xhr(),o=++on;if(a.open(t.type,t.url,t.async,t.username,t.password),t.xhrFields)for(i in t.xhrFields)a[i]=t.xhrFields[i];t.mimeType&&a.overrideMimeType&&a.overrideMimeType(t.mimeType),t.crossDomain||r["X-Requested-With"]||(r["X-Requested-With"]="XMLHttpRequest");for(i in r)void 0!==r[i]&&a.setRequestHeader(i,r[i]+"");a.send(t.hasContent&&t.data||null),n=function(e,r){var i,c,l;if(n&&(r||4===a.readyState))if(delete cn[o],n=void 0,a.onreadystatechange=pe.noop,r)4!==a.readyState&&a.abort();else{l={},i=a.status,"string"==typeof a.responseText&&(l.text=a.responseText);try{c=a.statusText}catch(u){c=""}i||!t.isLocal||t.crossDomain?1223===i&&(i=204):i=l.text?200:404}l&&s(i,c,l,a.getAllResponseHeaders())},t.async?4===a.readyState?e.setTimeout(n):a.onreadystatechange=cn[o]=n:n()},abort:function(){n&&n(void 0,!0)}}}}),pe.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),pe.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return pe.globalEval(e),e}}}),pe.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET",e.global=!1)}),pe.ajaxTransport("script",function(e){if(e.crossDomain){var t,n=re.head||pe("head")[0]||re.documentElement;return{send:function(r,s){t=re.createElement("script"),t.async=!0,e.scriptCharset&&(t.charset=e.scriptCharset),t.src=e.url,t.onload=t.onreadystatechange=function(e,n){(n||!t.readyState||/loaded|complete/.test(t.readyState))&&(t.onload=t.onreadystatechange=null,t.parentNode&&t.parentNode.removeChild(t),t=null,n||s(200,"success"))},n.insertBefore(t,n.firstChild)},abort:function(){t&&t.onload(void 0,!0)}}}});var un=[],fn=/(=)\?(?=&|$)|\?\?/;pe.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=un.pop()||pe.expando+"_"+qt++;return this[e]=!0,e}}),pe.ajaxPrefilter("json jsonp",function(t,n,r){var s,i,a,o=t.jsonp!==!1&&(fn.test(t.url)?"url":"string"==typeof t.data&&0===(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&fn.test(t.data)&&"data");return o||"jsonp"===t.dataTypes[0]?(s=t.jsonpCallback=pe.isFunction(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,o?t[o]=t[o].replace(fn,"$1"+s):t.jsonp!==!1&&(t.url+=(Vt.test(t.url)?"&":"?")+t.jsonp+"="+s),t.converters["script json"]=function(){return a||pe.error(s+" was not called"),a[0]},t.dataTypes[0]="json",i=e[s],e[s]=function(){a=arguments},r.always(function(){void 0===i?pe(e).removeProp(s):e[s]=i,t[s]&&(t.jsonpCallback=n.jsonpCallback,un.push(s)),a&&pe.isFunction(i)&&i(a[0]),a=i=void 0}),"script"):void 0}),fe.createHTMLDocument=function(){if(!re.implementation.createHTMLDocument)return!1;var e=re.implementation.createHTMLDocument("");return e.body.innerHTML="<form></form><form></form>",2===e.body.childNodes.length}(),pe.parseHTML=function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||(fe.createHTMLDocument?re.implementation.createHTMLDocument(""):re);var r=we.exec(e),s=!n&&[];return r?[t.createElement(r[1])]:(r=_([e],t,s),s&&s.length&&pe(s).remove(),pe.merge([],r.childNodes))};var dn=pe.fn.load;pe.fn.load=function(e,t,n){if("string"!=typeof e&&dn)return dn.apply(this,arguments);var r,s,i,a=this,o=e.indexOf(" ");return o>-1&&(r=pe.trim(e.slice(o,e.length)),e=e.slice(0,o)),pe.isFunction(t)?(n=t,t=void 0):t&&"object"==typeof t&&(s="POST"),a.length>0&&pe.ajax({url:e,type:s||"GET",dataType:"html",data:t}).done(function(e){i=arguments,a.html(r?pe("<div>").append(pe.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(a,i||[e.responseText,t,e])})}),this},pe.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){pe.fn[t]=function(e){return this.on(t,e)}}),pe.expr.filters.animated=function(e){return pe.grep(pe.timers,function(t){return e===t.elem}).length},pe.offset={setOffset:function(e,t,n){var r,s,i,a,o,c,l,u=pe.css(e,"position"),f=pe(e),d={};"static"===u&&(e.style.position="relative"),o=f.offset(),i=pe.css(e,"top"),c=pe.css(e,"left"),l=("absolute"===u||"fixed"===u)&&pe.inArray("auto",[i,c])>-1,l?(r=f.position(),a=r.top,s=r.left):(a=parseFloat(i)||0,s=parseFloat(c)||0),pe.isFunction(t)&&(t=t.call(e,n,pe.extend({},o))),null!=t.top&&(d.top=t.top-o.top+a),null!=t.left&&(d.left=t.left-o.left+s),"using"in t?t.using.call(e,d):f.css(d)}},pe.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){pe.offset.setOffset(this,e,t)});var t,n,r={top:0,left:0},s=this[0],i=s&&s.ownerDocument;return i?(t=i.documentElement,pe.contains(t,s)?("undefined"!=typeof s.getBoundingClientRect&&(r=s.getBoundingClientRect()),n=te(i),{top:r.top+(n.pageYOffset||t.scrollTop)-(t.clientTop||0),left:r.left+(n.pageXOffset||t.scrollLeft)-(t.clientLeft||0)}):r):void 0},position:function(){if(this[0]){var e,t,n={top:0,left:0},r=this[0];return"fixed"===pe.css(r,"position")?t=r.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),pe.nodeName(e[0],"html")||(n=e.offset()),n.top+=pe.css(e[0],"borderTopWidth",!0)-e.scrollTop(),n.left+=pe.css(e[0],"borderLeftWidth",!0)-e.scrollLeft()),{top:t.top-n.top-pe.css(r,"marginTop",!0),left:t.left-n.left-pe.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&!pe.nodeName(e,"html")&&"static"===pe.css(e,"position");)e=e.offsetParent;return e||pt})}}),pe.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,t){var n=/Y/.test(t);pe.fn[e]=function(r){return Fe(this,function(e,r,s){var i=te(e);return void 0===s?i?t in i?i[t]:i.document.documentElement[r]:e[r]:void(i?i.scrollTo(n?pe(i).scrollLeft():s,n?s:pe(i).scrollTop()):e[r]=s)},e,r,arguments.length,null)}}),pe.each(["top","left"],function(e,t){pe.cssHooks[t]=B(fe.pixelPosition,function(e,n){return n?(n=mt(e,t),ft.test(n)?pe(e).position()[t]+"px":n):void 0})}),pe.each({Height:"height",Width:"width"},function(e,t){pe.each({padding:"inner"+e,content:t,"":"outer"+e},function(n,r){pe.fn[r]=function(r,s){var i=arguments.length&&(n||"boolean"!=typeof r),a=n||(r===!0||s===!0?"margin":"border");return Fe(this,function(t,n,r){var s;return pe.isWindow(t)?t.document.documentElement["client"+e]:9===t.nodeType?(s=t.documentElement,Math.max(t.body["scroll"+e],s["scroll"+e],t.body["offset"+e],s["offset"+e],s["client"+e])):void 0===r?pe.css(t,n,a):pe.style(t,n,r,a)},t,i?r:void 0,i,null)}})}),pe.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}}),pe.fn.size=function(){return this.length},pe.fn.andSelf=pe.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return pe});var pn=e.jQuery,hn=e.$;return pe.noConflict=function(t){return e.$===pe&&(e.$=hn),t&&e.jQuery===pe&&(e.jQuery=pn),pe},t||(e.jQuery=e.$=pe),pe}),function(){"use strict";/**
     * @preserve FastClick: polyfill to remove click delays on browsers with touch UIs.
     *
     * @codingstandard ftlabs-jsv2
     * @copyright The Financial Times Limited [All Rights Reserved]
     * @license MIT License (see LICENSE.txt)
     */
function e(t,r){function s(e,t){return function(){return e.apply(t,arguments)}}var i;if(r=r||{},this.trackingClick=!1,this.trackingClickStart=0,this.targetElement=null,this.touchStartX=0,this.touchStartY=0,this.lastTouchIdentifier=0,this.touchBoundary=r.touchBoundary||10,this.layer=t,this.tapDelay=r.tapDelay||200,this.tapTimeout=r.tapTimeout||700,!e.notNeeded(t)){for(var a=["onMouse","onClick","onTouchStart","onTouchMove","onTouchEnd","onTouchCancel"],o=this,c=0,l=a.length;l>c;c++)o[a[c]]=s(o[a[c]],o);n&&(t.addEventListener("mouseover",this.onMouse,!0),t.addEventListener("mousedown",this.onMouse,!0),t.addEventListener("mouseup",this.onMouse,!0)),t.addEventListener("click",this.onClick,!0),t.addEventListener("touchstart",this.onTouchStart,!1),t.addEventListener("touchmove",this.onTouchMove,!1),t.addEventListener("touchend",this.onTouchEnd,!1),t.addEventListener("touchcancel",this.onTouchCancel,!1),Event.prototype.stopImmediatePropagation||(t.removeEventListener=function(e,n,r){var s=Node.prototype.removeEventListener;"click"===e?s.call(t,e,n.hijacked||n,r):s.call(t,e,n,r)},t.addEventListener=function(e,n,r){var s=Node.prototype.addEventListener;"click"===e?s.call(t,e,n.hijacked||(n.hijacked=function(e){e.propagationStopped||n(e)}),r):s.call(t,e,n,r)}),"function"==typeof t.onclick&&(i=t.onclick,t.addEventListener("click",function(e){i(e)},!1),t.onclick=null)}}var t=navigator.userAgent.indexOf("Windows Phone")>=0,n=navigator.userAgent.indexOf("Android")>0&&!t,r=/iP(ad|hone|od)/.test(navigator.userAgent)&&!t,s=r&&/OS 4_\d(_\d)?/.test(navigator.userAgent),i=r&&/OS [6-7]_\d/.test(navigator.userAgent),a=navigator.userAgent.indexOf("BB10")>0;e.prototype.needsClick=function(e){switch(e.nodeName.toLowerCase()){case"button":case"select":case"textarea":if(e.disabled)return!0;break;case"input":if(r&&"file"===e.type||e.disabled)return!0;break;case"label":case"iframe":case"video":return!0}return/\bneedsclick\b/.test(e.className)},e.prototype.needsFocus=function(e){switch(e.nodeName.toLowerCase()){case"textarea":return!0;case"select":return!n;case"input":switch(e.type){case"button":case"checkbox":case"file":case"image":case"radio":case"submit":return!1}return!e.disabled&&!e.readOnly;default:return/\bneedsfocus\b/.test(e.className)}},e.prototype.sendClick=function(e,t){var n,r;document.activeElement&&document.activeElement!==e&&document.activeElement.blur(),r=t.changedTouches[0],n=document.createEvent("MouseEvents"),n.initMouseEvent(this.determineEventType(e),!0,!0,window,1,r.screenX,r.screenY,r.clientX,r.clientY,!1,!1,!1,!1,0,null),n.forwardedTouchEvent=!0,e.dispatchEvent(n)},e.prototype.determineEventType=function(e){return n&&"select"===e.tagName.toLowerCase()?"mousedown":"click"},e.prototype.focus=function(e){var t;r&&e.setSelectionRange&&0!==e.type.indexOf("date")&&"time"!==e.type&&"month"!==e.type?(t=e.value.length,e.setSelectionRange(t,t)):e.focus()},e.prototype.updateScrollParent=function(e){var t,n;if(t=e.fastClickScrollParent,!t||!t.contains(e)){n=e;do{if(n.scrollHeight>n.offsetHeight){t=n,e.fastClickScrollParent=n;break}n=n.parentElement}while(n)}t&&(t.fastClickLastScrollTop=t.scrollTop)},e.prototype.getTargetElementFromEventTarget=function(e){return e.nodeType===Node.TEXT_NODE?e.parentNode:e},e.prototype.onTouchStart=function(e){var t,n,i;if(e.targetTouches.length>1)return!0;if(t=this.getTargetElementFromEventTarget(e.target),n=e.targetTouches[0],r){if(i=window.getSelection(),i.rangeCount&&!i.isCollapsed)return!0;if(!s){if(n.identifier&&n.identifier===this.lastTouchIdentifier)return e.preventDefault(),!1;this.lastTouchIdentifier=n.identifier,this.updateScrollParent(t)}}return this.trackingClick=!0,this.trackingClickStart=e.timeStamp,this.targetElement=t,this.touchStartX=n.pageX,this.touchStartY=n.pageY,e.timeStamp-this.lastClickTime<this.tapDelay&&e.preventDefault(),!0},e.prototype.touchHasMoved=function(e){var t=e.changedTouches[0],n=this.touchBoundary;return Math.abs(t.pageX-this.touchStartX)>n||Math.abs(t.pageY-this.touchStartY)>n?!0:!1},e.prototype.onTouchMove=function(e){return this.trackingClick?((this.targetElement!==this.getTargetElementFromEventTarget(e.target)||this.touchHasMoved(e))&&(this.trackingClick=!1,this.targetElement=null),!0):!0},e.prototype.findControl=function(e){return void 0!==e.control?e.control:e.htmlFor?document.getElementById(e.htmlFor):e.querySelector("button, input:not([type=hidden]), keygen, meter, output, progress, select, textarea")},e.prototype.onTouchEnd=function(e){var t,a,o,c,l,u=this.targetElement;if(!this.trackingClick)return!0;if(e.timeStamp-this.lastClickTime<this.tapDelay)return this.cancelNextClick=!0,!0;if(e.timeStamp-this.trackingClickStart>this.tapTimeout)return!0;if(this.cancelNextClick=!1,this.lastClickTime=e.timeStamp,a=this.trackingClickStart,this.trackingClick=!1,this.trackingClickStart=0,i&&(l=e.changedTouches[0],u=document.elementFromPoint(l.pageX-window.pageXOffset,l.pageY-window.pageYOffset)||u,u.fastClickScrollParent=this.targetElement.fastClickScrollParent),o=u.tagName.toLowerCase(),"label"===o){if(t=this.findControl(u)){if(this.focus(u),n)return!1;u=t}}else if(this.needsFocus(u))return e.timeStamp-a>100||r&&window.top!==window&&"input"===o?(this.targetElement=null,!1):(this.focus(u),this.sendClick(u,e),r&&"select"===o||(this.targetElement=null,e.preventDefault()),!1);return r&&!s&&(c=u.fastClickScrollParent,c&&c.fastClickLastScrollTop!==c.scrollTop)?!0:(this.needsClick(u)||(e.preventDefault(),this.sendClick(u,e)),!1)},e.prototype.onTouchCancel=function(){this.trackingClick=!1,this.targetElement=null},e.prototype.onMouse=function(e){return this.targetElement?e.forwardedTouchEvent?!0:e.cancelable&&(!this.needsClick(this.targetElement)||this.cancelNextClick)?(e.stopImmediatePropagation?e.stopImmediatePropagation():e.propagationStopped=!0,e.stopPropagation(),e.preventDefault(),!1):!0:!0},e.prototype.onClick=function(e){var t;return this.trackingClick?(this.targetElement=null,this.trackingClick=!1,!0):"submit"===e.target.type&&0===e.detail?!0:(t=this.onMouse(e),t||(this.targetElement=null),t)},e.prototype.destroy=function(){var e=this.layer;n&&(e.removeEventListener("mouseover",this.onMouse,!0),e.removeEventListener("mousedown",this.onMouse,!0),e.removeEventListener("mouseup",this.onMouse,!0)),e.removeEventListener("click",this.onClick,!0),e.removeEventListener("touchstart",this.onTouchStart,!1),e.removeEventListener("touchmove",this.onTouchMove,!1),e.removeEventListener("touchend",this.onTouchEnd,!1),e.removeEventListener("touchcancel",this.onTouchCancel,!1)},e.notNeeded=function(e){var t,r,s,i;if("undefined"==typeof window.ontouchstart)return!0;if(r=+(/Chrome\/([0-9]+)/.exec(navigator.userAgent)||[,0])[1]){if(!n)return!0;if(t=document.querySelector("meta[name=viewport]")){if(-1!==t.content.indexOf("user-scalable=no"))return!0;if(r>31&&document.documentElement.scrollWidth<=window.outerWidth)return!0}}if(a&&(s=navigator.userAgent.match(/Version\/([0-9]*)\.([0-9]*)/),s[1]>=10&&s[2]>=3&&(t=document.querySelector("meta[name=viewport]")))){if(-1!==t.content.indexOf("user-scalable=no"))return!0;if(document.documentElement.scrollWidth<=window.outerWidth)return!0}return"none"===e.style.msTouchAction||"manipulation"===e.style.touchAction?!0:(i=+(/Firefox\/([0-9]+)/.exec(navigator.userAgent)||[,0])[1],i>=27&&(t=document.querySelector("meta[name=viewport]"),t&&(-1!==t.content.indexOf("user-scalable=no")||document.documentElement.scrollWidth<=window.outerWidth))?!0:"none"===e.style.touchAction||"manipulation"===e.style.touchAction?!0:!1)},e.attach=function(t,n){return new e(t,n)},"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return e}):"undefined"!=typeof module&&module.exports?(module.exports=e.attach,module.exports.FastClick=e):window.FastClick=e}();const abc2svg={version:"1.4.9",vdate:"2016-01-18"};var Abcdf_Parser=function(){"use strict";function e(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n}function t(e,n,r,s){this.message=e,this.expected=n,this.found=r,this.location=s,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,t)}function n(e){function n(t){var n,r,s=ie[t];if(s)return s;for(n=t-1;!ie[n];)n--;for(s=ie[n],s={line:s.line,column:s.column,seenCR:s.seenCR};t>n;)r=e.charAt(n),"\n"===r?(s.seenCR||s.line++,s.column=1,s.seenCR=!1):"\r"===r||"\u2028"===r||"\u2029"===r?(s.line++,s.column=1,s.seenCR=!0):(s.column++,s.seenCR=!1),n++;return ie[t]=s,s}function r(e,t){var r=n(e),s=n(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:s.line,column:s.column}}}function s(e){ae>re||(re>ae&&(ae=re,oe=[]),oe.push(e))}function i(e,n,r,s){function i(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}function a(e,t){function n(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0100-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1000-\uFFFF]/g,function(e){return"\\u"+t(e)})}var r,s,i,a=new Array(e.length);for(i=0;i<e.length;i++)a[i]=e[i].description;return r=e.length>1?a.slice(0,-1).join(", ")+" or "+a[e.length-1]:a[0],s=t?'"'+n(t)+'"':"end of input","Expected "+r+" but "+s+" found."}return null!==n&&i(n),new t(null!==e?e:a(n,r),n,r,s)}function a(){var t,n,r,i,a;return t=re,n=o(),n!==x?(r=re,64===e.charCodeAt(re)?(i=E,re++):(i=x,0===ce&&s(T)),i!==x?(a=o(),a!==x?(i=[i,a],r=i):(re=r,r=x)):(re=r,r=x),r===x&&(r=null),r!==x?(se=t,n=C(n,r),t=n):(re=t,t=x)):(re=t,t=x),t}function o(){var t,n,r,i;return t=re,n=c(),n!==x?(38===e.charCodeAt(re)?(r=S,re++):(r=x,0===ce&&s(O)),r!==x?(i=o(),i!==x?(n=[n,r,i],t=n):(re=t,t=x)):(re=t,t=x)):(re=t,t=x),t===x&&(t=c(),t===x&&(t=A)),t}function c(){var e,t,n;for(e=re,t=[],n=l();n!==x;)t.push(n),n=l();return t!==x&&(se=e,t=N(t)),e=t}function l(){var t,n,r,i,a;return t=re,n=u(),n!==x?(r=re,47===e.charCodeAt(re)?(i=B,re++):(i=x,0===ce&&s(R)),i!==x?(a=u(),a!==x?(i=[i,a],r=i):(re=r,r=x)):(re=r,r=x),r===x&&(r=null),r!==x?(se=t,n=L(n,r),t=n):(re=t,t=x)):(re=t,t=x),t===x&&(t=re,n=f(),n!==x?(r=re,47===e.charCodeAt(re)?(i=B,re++):(i=x,0===ce&&s(R)),i!==x?(a=f(),a!==x?(i=[i,a],r=i):(re=r,r=x)):(re=r,r=x),r===x&&(r=null),r!==x?(se=t,n=P(n,r),t=n):(re=t,t=x)):(re=t,t=x),t===x&&(t=re,n=d(),n!==x?(r=re,47===e.charCodeAt(re)?(i=B,re++):(i=x,0===ce&&s(R)),i!==x?(a=d(),a!==x?(i=[i,a],r=i):(re=r,r=x)):(re=r,r=x),r===x&&(r=null),r!==x?(se=t,n=I(n,r),t=n):(re=t,t=x)):(re=t,t=x))),t}function u(){var t,n,r,i,a;if(t=re,n=re,40===e.charCodeAt(re)?(r=M,re++):(r=x,0===ce&&s(D)),r!==x){if(i=[],a=f(),a!==x)for(;a!==x;)i.push(a),a=f();else i=x;i!==x?(41===e.charCodeAt(re)?(a=j,re++):(a=x,0===ce&&s(F)),a!==x?(r=[r,i,a],n=r):(re=n,n=x)):(re=n,n=x)}else re=n,n=x;return n!==x&&(se=t,n=q(n)),t=n}function f(){var e,t,n,r;return e=re,t=v(),t===x&&(t=null),t!==x?(n=p(),n!==x?(r=m(),r===x&&(r=null),r!==x?(se=e,t=V(t,n,r),e=t):(re=e,e=x)):(re=e,e=x)):(re=e,e=x),e}function d(){var t,n,r,i;return t=re,n=v(),n===x&&(n=null),n!==x?(120===e.charCodeAt(re)?(r=z,re++):(r=x,0===ce&&s(H)),r!==x?(i=m(),i===x&&(i=null),i!==x?(se=t,n=U(n,i),t=n):(re=t,t=x)):(re=t,t=x)):(re=t,t=x),t}function p(){var t,n,r,i,a;return t=re,n=h(),n!==x?(r=re,45===e.charCodeAt(re)?(i=$,re++):(i=x,0===ce&&s(W)),i!==x?(a=h(),a!==x?(i=[i,a],r=i):(re=r,r=x)):(re=r,r=x),r===x&&(r=null),r!==x?(se=t,n=K(n,r),t=n):(re=t,t=x)):(re=t,t=x),t}function h(){var e,t,n;return e=re,t=_(),t===x&&(t=null),t!==x?(n=g(),n!==x?(se=e,t=X(t,n),e=t):(re=e,e=x)):(re=e,e=x),e}function m(){var t;return Q.test(e.charAt(re))?(t=e.charAt(re),re++):(t=x,0===ce&&s(J)),t}function v(){var t;return G.test(e.charAt(re))?(t=e.charAt(re),re++):(t=x,0===ce&&s(Y)),t}function _(){var t;return Z.test(e.charAt(re))?(t=e.charAt(re),re++):(t=x,0===ce&&s(ee)),t}function g(){var t;return te.test(e.charAt(re))?(t=e.charAt(re),re++):(t=x,0===ce&&s(ne)),t}var y,b=arguments.length>1?arguments[1]:{},x={},w={sequence:a},k=a,E="@",T={type:"literal",value:"@",description:'"@"'},C=function(e,t){var n={upper:e};return t&&(n.lower=t[1]),n},S="&",O={type:"literal",value:"&",description:'"&"'},A="",N=function(e){return{score_fingerings:e}},B="/",R={type:"literal",value:"/",description:'"/"'},L=function(e,t){var n={first:e,last:null};return t&&(n.last=t[1]),n},P=function(e,t){var n={first:e,last:null};return t&&(n.last=t[1]),n},I=function(e,t){var n={first:e,last:null};return t&&(n.last=t[1]),n},M="(",D={type:"literal",value:"(",description:'"("'},j=")",F={type:"literal",value:")",description:'")"'},q=function(e){return e.pop(),e.shift(),{ornaments:e}},V=function(e,t,n){return{soft:e,fingering:t,damper:n}},z="x",H={type:"literal",value:"x",description:'"x"'},U=function(e,t){var n={strike:null,release:null};return{soft:e,fingering:n,damper:t}},$="-",W={type:"literal",value:"-",description:'"-"'},K=function(e,t){var n={strike:e,release:null};return t&&(n.release=t[1]),n},X=function(e,t){return{hand:e,digit:t}},Q=/^[_\^]/,J={type:"class",value:"[_^]",description:"[_^]"},G=/^[pf]/,Y={type:"class",value:"[pf]",description:"[pf]"},Z=/^[<>]/,ee={type:"class",value:"[<>]",description:"[<>]"},te=/^[1-5]/,ne={type:"class",value:"[1-5]",description:"[1-5]"},re=0,se=0,ie=[{line:1,column:1,seenCR:!1}],ae=0,oe=[],ce=0;if("startRule"in b){if(!(b.startRule in w))throw new Error("Can't start parsing from rule \""+b.startRule+'".');k=w[b.startRule]}if(y=k(),y!==x&&re===e.length)return y;throw y!==x&&re<e.length&&s({type:"end",description:"end of input"}),i(null,oe,ae<e.length?e.charAt(ae):null,ae<e.length?r(ae,ae+1):r(ae,ae))}return e(t,Error),{SyntaxError:t,parse:n}}();!function(){Downloadify=window.Downloadify={queue:{},uid:(new Date).getTime(),getTextForSave:function(e){var t=Downloadify.queue[e];return t?t.getData():""},getFileNameForSave:function(e){var t=Downloadify.queue[e];return t?t.getFilename():""},getDataTypeForSave:function(e){var t=Downloadify.queue[e];return t?t.getDataType():""},saveComplete:function(e){var t=Downloadify.queue[e];return t&&t.complete(),!0},saveCancel:function(e){var t=Downloadify.queue[e];return t&&t.cancel(),!0},saveError:function(e){var t=Downloadify.queue[e];return t&&t.error(),!0},addToQueue:function(e){Downloadify.queue[e.queue_name]=e},getUID:function(e){return""==e.id&&(e.id="downloadify_"+Downloadify.uid++),e.id}},Downloadify.create=function(e,t){var n="string"==typeof e?document.getElementById(e):e;return new Downloadify.Container(n,t)},Downloadify.Container=function(e,t){var n=this;n.el=e,n.enabled=!0,n.dataCallback=null,n.filenameCallback=null,n.data=null,n.filename=null;var r=function(){n.options=t,n.options.append||(n.el.innerHTML=""),n.flashContainer=document.createElement("span"),n.el.appendChild(n.flashContainer),n.queue_name=Downloadify.getUID(n.flashContainer),"function"==typeof n.options.filename?n.filenameCallback=n.options.filename:n.options.filename&&(n.filename=n.options.filename),"function"==typeof n.options.data?n.dataCallback=n.options.data:n.options.data&&(n.data=n.options.data);var e={queue_name:n.queue_name,width:n.options.width,height:n.options.height},r={allowScriptAccess:"always"},s={id:n.flashContainer.id,name:n.flashContainer.id};n.options.enabled===!1&&(n.enabled=!1),n.options.transparent===!0&&(r.wmode="transparent"),n.options.downloadImage&&(e.downloadImage=n.options.downloadImage),swfobject.embedSWF(n.options.swf,n.flashContainer.id,n.options.width,n.options.height,"10",null,e,r,s),Downloadify.addToQueue(n)};n.enable=function(){var e=document.getElementById(n.flashContainer.id);e.setEnabled(!0),n.enabled=!0},n.disable=function(){var e=document.getElementById(n.flashContainer.id);e.setEnabled(!1),n.enabled=!1},n.getData=function(){return n.enabled?n.dataCallback?n.dataCallback():n.data?n.data:"":""},n.getFilename=function(){return n.filenameCallback?n.filenameCallback():n.filename?n.filename:""},n.getDataType=function(){return n.options.dataType?n.options.dataType:"string"},n.complete=function(){"function"==typeof n.options.onComplete&&n.options.onComplete()},n.cancel=function(){"function"==typeof n.options.onCancel&&n.options.onCancel()},n.error=function(){"function"==typeof n.options.onError&&n.options.onError()},r()},Downloadify.defaultOptions={swf:"media/downloadify.swf",downloadImage:"images/download.png",width:100,height:30,transparent:!0,append:!1,dataType:"string"}}(),"undefined"!=typeof jQuery&&!function(e){e.fn.downloadify=function(t){return this.each(function(){t=e.extend({},Downloadify.defaultOptions,t);var n=Downloadify.create(this,t);e(this).data("Downloadify",n)})}}(jQuery),"undefined"!=typeof MooTools&&Element.implement({downloadify:function(e){return e=$merge(Downloadify.defaultOptions,e),this.store("Downloadify",Downloadify.create(this,e))}}),!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.JSZip=e()}}(function(){return function e(t,n,r){function s(a,o){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!o&&c)return c(a,!0);if(i)return i(a,!0);throw new Error("Cannot find module '"+a+"'")}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){var n=t[a][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)s(r[a]);return s}({1:[function(e,t,n){"use strict";var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.encode=function(e,t){for(var n,s,i,a,o,c,l,u="",f=0;f<e.length;)n=e.charCodeAt(f++),s=e.charCodeAt(f++),i=e.charCodeAt(f++),a=n>>2,o=(3&n)<<4|s>>4,c=(15&s)<<2|i>>6,l=63&i,isNaN(s)?c=l=64:isNaN(i)&&(l=64),u=u+r.charAt(a)+r.charAt(o)+r.charAt(c)+r.charAt(l);return u},n.decode=function(e,t){var n,s,i,a,o,c,l,u="",f=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");f<e.length;)a=r.indexOf(e.charAt(f++)),o=r.indexOf(e.charAt(f++)),c=r.indexOf(e.charAt(f++)),l=r.indexOf(e.charAt(f++)),n=a<<2|o>>4,s=(15&o)<<4|c>>2,i=(3&c)<<6|l,u+=String.fromCharCode(n),64!=c&&(u+=String.fromCharCode(s)),64!=l&&(u+=String.fromCharCode(i));return u}},{}],2:[function(e,t,n){"use strict";function r(){this.compressedSize=0,this.uncompressedSize=0,this.crc32=0,this.compressionMethod=null,this.compressedContent=null}r.prototype={getContent:function(){return null},getCompressedContent:function(){return null}},t.exports=r},{}],3:[function(e,t,n){"use strict";n.STORE={magic:"\x00\x00",compress:function(e,t){return e},uncompress:function(e){return e},compressInputType:null,uncompressInputType:null},n.DEFLATE=e("./flate")},{"./flate":8}],4:[function(e,t,n){"use strict";var r=e("./utils"),s=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];t.exports=function(e,t){if("undefined"==typeof e||!e.length)return 0;var n="string"!==r.getTypeOf(e);"undefined"==typeof t&&(t=0);var i=0,a=0,o=0;t=-1^t;for(var c=0,l=e.length;l>c;c++)o=n?e[c]:e.charCodeAt(c),a=255&(t^o),i=s[a],t=t>>>8^i;return-1^t}},{"./utils":21}],5:[function(e,t,n){"use strict";function r(e){this.data=null,this.length=0,this.index=0}var s=e("./utils");r.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<e||0>e)throw new Error("End of data reached (data length = "+this.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(e){},readInt:function(e){var t,n=0;for(this.checkOffset(e),t=this.index+e-1;t>=this.index;t--)n=(n<<8)+this.byteAt(t);return this.index+=e,n},readString:function(e){return s.transformTo("string",this.readData(e))},readData:function(e){},lastIndexOfSignature:function(e){},readDate:function(){var e=this.readInt(4);return new Date((e>>25&127)+1980,(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(31&e)<<1)}},t.exports=r},{"./utils":21}],6:[function(e,t,n){"use strict";n.base64=!1,n.binary=!1,n.dir=!1,n.createFolders=!1,n.date=null,n.compression=null,n.compressionOptions=null,n.comment=null,n.unixPermissions=null,n.dosPermissions=null},{}],7:[function(e,t,n){"use strict";var r=e("./utils");n.string2binary=function(e){return r.string2binary(e)},n.string2Uint8Array=function(e){return r.transformTo("uint8array",e)},n.uint8Array2String=function(e){return r.transformTo("string",e)},n.string2Blob=function(e){var t=r.transformTo("arraybuffer",e);return r.arrayBuffer2Blob(t)},n.arrayBuffer2Blob=function(e){return r.arrayBuffer2Blob(e)},n.transformTo=function(e,t){return r.transformTo(e,t)},n.getTypeOf=function(e){return r.getTypeOf(e)},n.checkSupport=function(e){return r.checkSupport(e)},n.MAX_VALUE_16BITS=r.MAX_VALUE_16BITS,n.MAX_VALUE_32BITS=r.MAX_VALUE_32BITS,n.pretty=function(e){return r.pretty(e)},n.findCompression=function(e){return r.findCompression(e)},n.isRegExp=function(e){return r.isRegExp(e)}},{"./utils":21}],8:[function(e,t,n){"use strict";var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,s=e("pako");n.uncompressInputType=r?"uint8array":"array",n.compressInputType=r?"uint8array":"array",n.magic="\b\x00",n.compress=function(e,t){return s.deflateRaw(e,{level:t.level||-1})},n.uncompress=function(e){return s.inflateRaw(e)}},{pako:24}],9:[function(e,t,n){"use strict";function r(e,t){return this instanceof r?(this.files={},this.comment=null,this.root="",e&&this.load(e,t),void(this.clone=function(){var e=new r;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e})):new r(e,t)}var s=e("./base64");r.prototype=e("./object"),r.prototype.load=e("./load"),r.support=e("./support"),r.defaults=e("./defaults"),r.utils=e("./deprecatedPublicUtils"),r.base64={encode:function(e){return s.encode(e)},decode:function(e){return s.decode(e)}},r.compressions=e("./compressions"),t.exports=r},{"./base64":1,"./compressions":3,"./defaults":6,"./deprecatedPublicUtils":7,"./load":10,"./object":13,"./support":17}],10:[function(e,t,n){"use strict";var r=e("./base64"),s=e("./zipEntries");t.exports=function(e,t){var n,i,a,o;for(t=t||{},t.base64&&(e=r.decode(e)),i=new s(e,t),n=i.files,a=0;a<n.length;a++)o=n[a],this.file(o.fileName,o.decompressed,{binary:!0,optimizedBinaryString:!0,date:o.date,dir:o.dir,comment:o.fileComment.length?o.fileComment:null,unixPermissions:o.unixPermissions,dosPermissions:o.dosPermissions,createFolders:t.createFolders});return i.zipComment.length&&(this.comment=i.zipComment),this}},{"./base64":1,"./zipEntries":22}],11:[function(e,t,n){(function(e){"use strict";t.exports=function(t,n){return new e(t,n)},t.exports.test=function(t){return e.isBuffer(t)}}).call(this,"undefined"!=typeof Buffer?Buffer:void 0)},{}],12:[function(e,t,n){"use strict";function r(e){this.data=e,this.length=this.data.length,this.index=0}var s=e("./uint8ArrayReader");r.prototype=new s,r.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.index,this.index+e);return this.index+=e,t},t.exports=r},{"./uint8ArrayReader":18}],13:[function(e,t,n){"use strict";var r=e("./support"),s=e("./utils"),i=e("./crc32"),a=e("./signature"),o=e("./defaults"),c=e("./base64"),l=e("./compressions"),u=e("./compressedObject"),f=e("./nodeBuffer"),d=e("./utf8"),p=e("./stringWriter"),h=e("./uint8ArrayWriter"),m=function(e){if(e._data instanceof u&&(e._data=e._data.getContent(),e.options.binary=!0,e.options.base64=!1,"uint8array"===s.getTypeOf(e._data))){var t=e._data;e._data=new Uint8Array(t.length),0!==t.length&&e._data.set(t,0)}return e._data},v=function(e){var t=m(e),n=s.getTypeOf(t);return"string"===n?!e.options.binary&&r.nodebuffer?f(t,"utf-8"):e.asBinary():t},_=function(e){var t=m(this);return null===t||"undefined"==typeof t?"":(this.options.base64&&(t=c.decode(t)),t=e&&this.options.binary?N.utf8decode(t):s.transformTo("string",t),e||this.options.binary||(t=s.transformTo("string",N.utf8encode(t))),t)},g=function(e,t,n){this.name=e,this.dir=n.dir,this.date=n.date,this.comment=n.comment,this.unixPermissions=n.unixPermissions,this.dosPermissions=n.dosPermissions,this._data=t,this.options=n,this._initialMetadata={dir:n.dir,date:n.date}};g.prototype={asText:function(){return _.call(this,!0)},asBinary:function(){return _.call(this,!1)},asNodeBuffer:function(){var e=v(this);return s.transformTo("nodebuffer",e)},asUint8Array:function(){var e=v(this);return s.transformTo("uint8array",e)},asArrayBuffer:function(){return this.asUint8Array().buffer}};var y=function(e,t){var n,r="";for(n=0;t>n;n++)r+=String.fromCharCode(255&e),e>>>=8;return r},b=function(){var e,t,n={};for(e=0;e<arguments.length;e++)for(t in arguments[e])arguments[e].hasOwnProperty(t)&&"undefined"==typeof n[t]&&(n[t]=arguments[e][t]);return n},x=function(e){return e=e||{},e.base64!==!0||null!==e.binary&&void 0!==e.binary||(e.binary=!0),e=b(e,o),e.date=e.date||new Date,null!==e.compression&&(e.compression=e.compression.toUpperCase()),e},w=function(e,t,n){var r,i=s.getTypeOf(t);if(n=x(n),"string"==typeof n.unixPermissions&&(n.unixPermissions=parseInt(n.unixPermissions,8)),n.unixPermissions&&16384&n.unixPermissions&&(n.dir=!0),n.dosPermissions&&16&n.dosPermissions&&(n.dir=!0),n.dir&&(e=E(e)),n.createFolders&&(r=k(e))&&T.call(this,r,!0),n.dir||null===t||"undefined"==typeof t)n.base64=!1,n.binary=!1,t=null,i=null;else if("string"===i)n.binary&&!n.base64&&n.optimizedBinaryString!==!0&&(t=s.string2binary(t));else{if(n.base64=!1,n.binary=!0,!(i||t instanceof u))throw new Error("The data of '"+e+"' is in an unsupported format !");"arraybuffer"===i&&(t=s.transformTo("uint8array",t))}var a=new g(e,t,n);return this.files[e]=a,a},k=function(e){"/"==e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return t>0?e.substring(0,t):""},E=function(e){return"/"!=e.slice(-1)&&(e+="/"),e},T=function(e,t){return t="undefined"!=typeof t?t:!1,e=E(e),this.files[e]||w.call(this,e,null,{dir:!0,createFolders:t}),this.files[e]},C=function(e,t,n){var r,a=new u;return e._data instanceof u?(a.uncompressedSize=e._data.uncompressedSize,a.crc32=e._data.crc32,0===a.uncompressedSize||e.dir?(t=l.STORE,a.compressedContent="",a.crc32=0):e._data.compressionMethod===t.magic?a.compressedContent=e._data.getCompressedContent():(r=e._data.getContent(),a.compressedContent=t.compress(s.transformTo(t.compressInputType,r),n))):(r=v(e),(!r||0===r.length||e.dir)&&(t=l.STORE,r=""),a.uncompressedSize=r.length,a.crc32=i(r),a.compressedContent=t.compress(s.transformTo(t.compressInputType,r),n)),a.compressedSize=a.compressedContent.length,a.compressionMethod=t.magic,a},S=function(e,t){var n=e;return e||(n=t?16893:33204),(65535&n)<<16},O=function(e,t){return 63&(e||0)},A=function(e,t,n,r,o){var c,l,u,f,p=(n.compressedContent,s.transformTo("string",d.utf8encode(t.name))),h=t.comment||"",m=s.transformTo("string",d.utf8encode(h)),v=p.length!==t.name.length,_=m.length!==h.length,g=t.options,b="",x="",w="";u=t._initialMetadata.dir!==t.dir?t.dir:g.dir,f=t._initialMetadata.date!==t.date?t.date:g.date;var k=0,E=0;u&&(k|=16),"UNIX"===o?(E=798,k|=S(t.unixPermissions,u)):(E=20,k|=O(t.dosPermissions,u)),c=f.getHours(),c<<=6,c|=f.getMinutes(),c<<=5,c|=f.getSeconds()/2,l=f.getFullYear()-1980,l<<=4,l|=f.getMonth()+1,l<<=5,l|=f.getDate(),v&&(x=y(1,1)+y(i(p),4)+p,b+="up"+y(x.length,2)+x),_&&(w=y(1,1)+y(this.crc32(m),4)+m,b+="uc"+y(w.length,2)+w);var T="";T+="\n\x00",T+=v||_?"\x00\b":"\x00\x00",T+=n.compressionMethod,T+=y(c,2),T+=y(l,2),T+=y(n.crc32,4),T+=y(n.compressedSize,4),T+=y(n.uncompressedSize,4),T+=y(p.length,2),T+=y(b.length,2);var C=a.LOCAL_FILE_HEADER+T+p+b,A=a.CENTRAL_FILE_HEADER+y(E,2)+T+y(m.length,2)+"\x00\x00\x00\x00"+y(k,4)+y(r,4)+p+b+m;return{fileRecord:C,dirRecord:A,compressedObject:n}},N={load:function(e,t){throw new Error("Load method is not defined. Is the file jszip-load.js included ?")},filter:function(e){var t,n,r,s,i=[];for(t in this.files)this.files.hasOwnProperty(t)&&(r=this.files[t],s=new g(r.name,r._data,b(r.options)),n=t.slice(this.root.length,t.length),t.slice(0,this.root.length)===this.root&&e(n,s)&&i.push(s));return i},file:function(e,t,n){if(1===arguments.length){if(s.isRegExp(e)){var r=e;return this.filter(function(e,t){return!t.dir&&r.test(e)})}return this.filter(function(t,n){return!n.dir&&t===e})[0]||null}return e=this.root+e,w.call(this,e,t,n),this},folder:function(e){if(!e)return this;if(s.isRegExp(e))return this.filter(function(t,n){return n.dir&&e.test(t)});var t=this.root+e,n=T.call(this,t),r=this.clone();return r.root=n.name,r},remove:function(e){e=this.root+e;var t=this.files[e];if(t||("/"!=e.slice(-1)&&(e+="/"),t=this.files[e]),t&&!t.dir)delete this.files[e];else for(var n=this.filter(function(t,n){return n.name.slice(0,e.length)===e}),r=0;r<n.length;r++)delete this.files[n[r].name];return this},generate:function(e){e=b(e||{},{base64:!0,compression:"STORE",compressionOptions:null,type:"base64",platform:"DOS",comment:null,mimeType:"application/zip"}),s.checkSupport(e.type),("darwin"===e.platform||"freebsd"===e.platform||"linux"===e.platform||"sunos"===e.platform)&&(e.platform="UNIX"),"win32"===e.platform&&(e.platform="DOS");
var t,n,r=[],i=0,o=0,u=s.transformTo("string",this.utf8encode(e.comment||this.comment||""));for(var f in this.files)if(this.files.hasOwnProperty(f)){var d=this.files[f],m=d.options.compression||e.compression.toUpperCase(),v=l[m];if(!v)throw new Error(m+" is not a valid compression method !");var _=d.options.compressionOptions||e.compressionOptions||{},g=C.call(this,d,v,_),x=A.call(this,f,d,g,i,e.platform);i+=x.fileRecord.length+g.compressedSize,o+=x.dirRecord.length,r.push(x)}var w="";w=a.CENTRAL_DIRECTORY_END+"\x00\x00\x00\x00"+y(r.length,2)+y(r.length,2)+y(o,4)+y(i,4)+y(u.length,2)+u;var k=e.type.toLowerCase();for(t="uint8array"===k||"arraybuffer"===k||"blob"===k||"nodebuffer"===k?new h(i+o+w.length):new p(i+o+w.length),n=0;n<r.length;n++)t.append(r[n].fileRecord),t.append(r[n].compressedObject.compressedContent);for(n=0;n<r.length;n++)t.append(r[n].dirRecord);t.append(w);var E=t.finalize();switch(e.type.toLowerCase()){case"uint8array":case"arraybuffer":case"nodebuffer":return s.transformTo(e.type.toLowerCase(),E);case"blob":return s.arrayBuffer2Blob(s.transformTo("arraybuffer",E),e.mimeType);case"base64":return e.base64?c.encode(E):E;default:return E}},crc32:function(e,t){return i(e,t)},utf8encode:function(e){return s.transformTo("string",d.utf8encode(e))},utf8decode:function(e){return d.utf8decode(e)}};t.exports=N},{"./base64":1,"./compressedObject":2,"./compressions":3,"./crc32":4,"./defaults":6,"./nodeBuffer":11,"./signature":14,"./stringWriter":16,"./support":17,"./uint8ArrayWriter":19,"./utf8":20,"./utils":21}],14:[function(e,t,n){"use strict";n.LOCAL_FILE_HEADER="PK",n.CENTRAL_FILE_HEADER="PK",n.CENTRAL_DIRECTORY_END="PK",n.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",n.ZIP64_CENTRAL_DIRECTORY_END="PK",n.DATA_DESCRIPTOR="PK\b"},{}],15:[function(e,t,n){"use strict";function r(e,t){this.data=e,t||(this.data=i.string2binary(this.data)),this.length=this.data.length,this.index=0}var s=e("./dataReader"),i=e("./utils");r.prototype=new s,r.prototype.byteAt=function(e){return this.data.charCodeAt(e)},r.prototype.lastIndexOfSignature=function(e){return this.data.lastIndexOf(e)},r.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.index,this.index+e);return this.index+=e,t},t.exports=r},{"./dataReader":5,"./utils":21}],16:[function(e,t,n){"use strict";var r=e("./utils"),s=function(){this.data=[]};s.prototype={append:function(e){e=r.transformTo("string",e),this.data.push(e)},finalize:function(){return this.data.join("")}},t.exports=s},{"./utils":21}],17:[function(e,t,n){(function(e){"use strict";if(n.base64=!0,n.array=!0,n.string=!0,n.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,n.nodebuffer="undefined"!=typeof e,n.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)n.blob=!1;else{var t=new ArrayBuffer(0);try{n.blob=0===new Blob([t],{type:"application/zip"}).size}catch(r){try{var s=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,i=new s;i.append(t),n.blob=0===i.getBlob("application/zip").size}catch(r){n.blob=!1}}}}).call(this,"undefined"!=typeof Buffer?Buffer:void 0)},{}],18:[function(e,t,n){"use strict";function r(e){e&&(this.data=e,this.length=this.data.length,this.index=0)}var s=e("./dataReader");r.prototype=new s,r.prototype.byteAt=function(e){return this.data[e]},r.prototype.lastIndexOfSignature=function(e){for(var t=e.charCodeAt(0),n=e.charCodeAt(1),r=e.charCodeAt(2),s=e.charCodeAt(3),i=this.length-4;i>=0;--i)if(this.data[i]===t&&this.data[i+1]===n&&this.data[i+2]===r&&this.data[i+3]===s)return i;return-1},r.prototype.readData=function(e){if(this.checkOffset(e),0===e)return new Uint8Array(0);var t=this.data.subarray(this.index,this.index+e);return this.index+=e,t},t.exports=r},{"./dataReader":5}],19:[function(e,t,n){"use strict";var r=e("./utils"),s=function(e){this.data=new Uint8Array(e),this.index=0};s.prototype={append:function(e){0!==e.length&&(e=r.transformTo("uint8array",e),this.data.set(e,this.index),this.index+=e.length)},finalize:function(){return this.data}},t.exports=s},{"./utils":21}],20:[function(e,t,n){"use strict";for(var r=e("./utils"),s=e("./support"),i=e("./nodeBuffer"),a=new Array(256),o=0;256>o;o++)a[o]=o>=252?6:o>=248?5:o>=240?4:o>=224?3:o>=192?2:1;a[254]=a[254]=1;var c=function(e){var t,n,r,i,a,o=e.length,c=0;for(i=0;o>i;i++)n=e.charCodeAt(i),55296===(64512&n)&&o>i+1&&(r=e.charCodeAt(i+1),56320===(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),c+=128>n?1:2048>n?2:65536>n?3:4;for(t=s.uint8array?new Uint8Array(c):new Array(c),a=0,i=0;c>a;i++)n=e.charCodeAt(i),55296===(64512&n)&&o>i+1&&(r=e.charCodeAt(i+1),56320===(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),128>n?t[a++]=n:2048>n?(t[a++]=192|n>>>6,t[a++]=128|63&n):65536>n?(t[a++]=224|n>>>12,t[a++]=128|n>>>6&63,t[a++]=128|63&n):(t[a++]=240|n>>>18,t[a++]=128|n>>>12&63,t[a++]=128|n>>>6&63,t[a++]=128|63&n);return t},l=function(e,t){var n;for(t=t||e.length,t>e.length&&(t=e.length),n=t-1;n>=0&&128===(192&e[n]);)n--;return 0>n?t:0===n?t:n+a[e[n]]>t?n:t},u=function(e){var t,n,s,i,o=e.length,c=new Array(2*o);for(n=0,t=0;o>t;)if(s=e[t++],128>s)c[n++]=s;else if(i=a[s],i>4)c[n++]=65533,t+=i-1;else{for(s&=2===i?31:3===i?15:7;i>1&&o>t;)s=s<<6|63&e[t++],i--;i>1?c[n++]=65533:65536>s?c[n++]=s:(s-=65536,c[n++]=55296|s>>10&1023,c[n++]=56320|1023&s)}return c.length!==n&&(c.subarray?c=c.subarray(0,n):c.length=n),r.applyFromCharCode(c)};n.utf8encode=function(e){return s.nodebuffer?i(e,"utf-8"):c(e)},n.utf8decode=function(e){if(s.nodebuffer)return r.transformTo("nodebuffer",e).toString("utf-8");e=r.transformTo(s.uint8array?"uint8array":"array",e);for(var t=[],n=0,i=e.length,a=65536;i>n;){var o=l(e,Math.min(n+a,i));s.uint8array?t.push(u(e.subarray(n,o))):t.push(u(e.slice(n,o))),n=o}return t.join("")}},{"./nodeBuffer":11,"./support":17,"./utils":21}],21:[function(e,t,n){"use strict";function r(e){return e}function s(e,t){for(var n=0;n<e.length;++n)t[n]=255&e.charCodeAt(n);return t}function i(e){var t=65536,r=[],s=e.length,i=n.getTypeOf(e),a=0,o=!0;try{switch(i){case"uint8array":String.fromCharCode.apply(null,new Uint8Array(0));break;case"nodebuffer":String.fromCharCode.apply(null,l(0))}}catch(c){o=!1}if(!o){for(var u="",f=0;f<e.length;f++)u+=String.fromCharCode(e[f]);return u}for(;s>a&&t>1;)try{"array"===i||"nodebuffer"===i?r.push(String.fromCharCode.apply(null,e.slice(a,Math.min(a+t,s)))):r.push(String.fromCharCode.apply(null,e.subarray(a,Math.min(a+t,s)))),a+=t}catch(c){t=Math.floor(t/2)}return r.join("")}function a(e,t){for(var n=0;n<e.length;n++)t[n]=e[n];return t}var o=e("./support"),c=e("./compressions"),l=e("./nodeBuffer");n.string2binary=function(e){for(var t="",n=0;n<e.length;n++)t+=String.fromCharCode(255&e.charCodeAt(n));return t},n.arrayBuffer2Blob=function(e,t){n.checkSupport("blob"),t=t||"application/zip";try{return new Blob([e],{type:t})}catch(r){try{var s=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,i=new s;return i.append(e),i.getBlob(t)}catch(r){throw new Error("Bug : can't construct the Blob.")}}},n.applyFromCharCode=i;var u={};u.string={string:r,array:function(e){return s(e,new Array(e.length))},arraybuffer:function(e){return u.string.uint8array(e).buffer},uint8array:function(e){return s(e,new Uint8Array(e.length))},nodebuffer:function(e){return s(e,l(e.length))}},u.array={string:i,array:r,arraybuffer:function(e){return new Uint8Array(e).buffer},uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return l(e)}},u.arraybuffer={string:function(e){return i(new Uint8Array(e))},array:function(e){return a(new Uint8Array(e),new Array(e.byteLength))},arraybuffer:r,uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return l(new Uint8Array(e))}},u.uint8array={string:i,array:function(e){return a(e,new Array(e.length))},arraybuffer:function(e){return e.buffer},uint8array:r,nodebuffer:function(e){return l(e)}},u.nodebuffer={string:i,array:function(e){return a(e,new Array(e.length))},arraybuffer:function(e){return u.nodebuffer.uint8array(e).buffer},uint8array:function(e){return a(e,new Uint8Array(e.length))},nodebuffer:r},n.transformTo=function(e,t){if(t||(t=""),!e)return t;n.checkSupport(e);var r=n.getTypeOf(t),s=u[r][e](t);return s},n.getTypeOf=function(e){return"string"==typeof e?"string":"[object Array]"===Object.prototype.toString.call(e)?"array":o.nodebuffer&&l.test(e)?"nodebuffer":o.uint8array&&e instanceof Uint8Array?"uint8array":o.arraybuffer&&e instanceof ArrayBuffer?"arraybuffer":void 0},n.checkSupport=function(e){var t=o[e.toLowerCase()];if(!t)throw new Error(e+" is not supported by this browser")},n.MAX_VALUE_16BITS=65535,n.MAX_VALUE_32BITS=-1,n.pretty=function(e){var t,n,r="";for(n=0;n<(e||"").length;n++)t=e.charCodeAt(n),r+="\\x"+(16>t?"0":"")+t.toString(16).toUpperCase();return r},n.findCompression=function(e){for(var t in c)if(c.hasOwnProperty(t)&&c[t].magic===e)return c[t];return null},n.isRegExp=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)}},{"./compressions":3,"./nodeBuffer":11,"./support":17}],22:[function(e,t,n){"use strict";function r(e,t){this.files=[],this.loadOptions=t,e&&this.load(e)}var s=e("./stringReader"),i=e("./nodeBufferReader"),a=e("./uint8ArrayReader"),o=e("./utils"),c=e("./signature"),l=e("./zipEntry"),u=e("./support"),f=e("./object");r.prototype={checkSignature:function(e){var t=this.reader.readString(4);if(t!==e)throw new Error("Corrupted zip or bug : unexpected signature ("+o.pretty(t)+", expected "+o.pretty(e)+")")},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2),this.zipComment=this.reader.readString(this.zipCommentLength),this.zipComment=f.utf8decode(this.zipComment)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.versionMadeBy=this.reader.readString(2),this.versionNeeded=this.reader.readInt(2),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var e,t,n,r=this.zip64EndOfCentralSize-44,s=0;r>s;)e=this.reader.readInt(2),t=this.reader.readInt(4),n=this.reader.readString(t),this.zip64ExtensibleData[e]={id:e,length:t,value:n}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),this.disksCount>1)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var e,t;for(e=0;e<this.files.length;e++)t=this.files[e],this.reader.setIndex(t.localHeaderOffset),this.checkSignature(c.LOCAL_FILE_HEADER),t.readLocalPart(this.reader),t.handleUTF8(),t.processAttributes()},readCentralDir:function(){var e;for(this.reader.setIndex(this.centralDirOffset);this.reader.readString(4)===c.CENTRAL_FILE_HEADER;)e=new l({zip64:this.zip64},this.loadOptions),e.readCentralPart(this.reader),this.files.push(e)},readEndOfCentral:function(){var e=this.reader.lastIndexOfSignature(c.CENTRAL_DIRECTORY_END);if(-1===e){var t=!0;try{this.reader.setIndex(0),this.checkSignature(c.LOCAL_FILE_HEADER),t=!1}catch(n){}throw t?new Error("Can't find end of central directory : is this a zip file ? If it is, see http://stuk.github.io/jszip/documentation/howto/read_zip.html"):new Error("Corrupted zip : can't find end of central directory")}if(this.reader.setIndex(e),this.checkSignature(c.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===o.MAX_VALUE_16BITS||this.diskWithCentralDirStart===o.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===o.MAX_VALUE_16BITS||this.centralDirRecords===o.MAX_VALUE_16BITS||this.centralDirSize===o.MAX_VALUE_32BITS||this.centralDirOffset===o.MAX_VALUE_32BITS){if(this.zip64=!0,e=this.reader.lastIndexOfSignature(c.ZIP64_CENTRAL_DIRECTORY_LOCATOR),-1===e)throw new Error("Corrupted zip : can't find the ZIP64 end of central directory locator");this.reader.setIndex(e),this.checkSignature(c.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(c.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}},prepareReader:function(e){var t=o.getTypeOf(e);"string"!==t||u.uint8array?"nodebuffer"===t?this.reader=new i(e):this.reader=new a(o.transformTo("uint8array",e)):this.reader=new s(e,this.loadOptions.optimizedBinaryString)},load:function(e){this.prepareReader(e),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},t.exports=r},{"./nodeBufferReader":12,"./object":13,"./signature":14,"./stringReader":15,"./support":17,"./uint8ArrayReader":18,"./utils":21,"./zipEntry":23}],23:[function(e,t,n){"use strict";function r(e,t){this.options=e,this.loadOptions=t}var s=e("./stringReader"),i=e("./utils"),a=e("./compressedObject"),o=e("./object"),c=0,l=3;r.prototype={isEncrypted:function(){return 1===(1&this.bitFlag)},useUTF8:function(){return 2048===(2048&this.bitFlag)},prepareCompressedContent:function(e,t,n){return function(){var r=e.index;e.setIndex(t);var s=e.readData(n);return e.setIndex(r),s}},prepareContent:function(e,t,n,r,s){return function(){var e=i.transformTo(r.uncompressInputType,this.getCompressedContent()),t=r.uncompress(e);if(t.length!==s)throw new Error("Bug : uncompressed data size mismatch");return t}},readLocalPart:function(e){var t,n;if(e.skip(22),this.fileNameLength=e.readInt(2),n=e.readInt(2),this.fileName=e.readString(this.fileNameLength),e.skip(n),-1==this.compressedSize||-1==this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize == -1 || uncompressedSize == -1)");if(t=i.findCompression(this.compressionMethod),null===t)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+this.fileName+")");if(this.decompressed=new a,this.decompressed.compressedSize=this.compressedSize,this.decompressed.uncompressedSize=this.uncompressedSize,this.decompressed.crc32=this.crc32,this.decompressed.compressionMethod=this.compressionMethod,this.decompressed.getCompressedContent=this.prepareCompressedContent(e,e.index,this.compressedSize,t),this.decompressed.getContent=this.prepareContent(e,e.index,this.compressedSize,t,this.uncompressedSize),this.loadOptions.checkCRC32&&(this.decompressed=i.transformTo("string",this.decompressed.getContent()),o.crc32(this.decompressed)!==this.crc32))throw new Error("Corrupted zip : CRC32 mismatch")},readCentralPart:function(e){if(this.versionMadeBy=e.readInt(2),this.versionNeeded=e.readInt(2),this.bitFlag=e.readInt(2),this.compressionMethod=e.readString(2),this.date=e.readDate(),this.crc32=e.readInt(4),this.compressedSize=e.readInt(4),this.uncompressedSize=e.readInt(4),this.fileNameLength=e.readInt(2),this.extraFieldsLength=e.readInt(2),this.fileCommentLength=e.readInt(2),this.diskNumberStart=e.readInt(2),this.internalFileAttributes=e.readInt(2),this.externalFileAttributes=e.readInt(4),this.localHeaderOffset=e.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");this.fileName=e.readString(this.fileNameLength),this.readExtraFields(e),this.parseZIP64ExtraField(e),this.fileComment=e.readString(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var e=this.versionMadeBy>>8;this.dir=16&this.externalFileAttributes?!0:!1,e===c&&(this.dosPermissions=63&this.externalFileAttributes),e===l&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileName.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(e){if(this.extraFields[1]){var t=new s(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=t.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=t.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=t.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=t.readInt(4))}},readExtraFields:function(e){var t,n,r,s=e.index;for(this.extraFields=this.extraFields||{};e.index<s+this.extraFieldsLength;)t=e.readInt(2),n=e.readInt(2),r=e.readString(n),this.extraFields[t]={id:t,length:n,value:r}},handleUTF8:function(){if(this.useUTF8())this.fileName=o.utf8decode(this.fileName),this.fileComment=o.utf8decode(this.fileComment);else{var e=this.findExtraFieldUnicodePath();null!==e&&(this.fileName=e);var t=this.findExtraFieldUnicodeComment();null!==t&&(this.fileComment=t)}},findExtraFieldUnicodePath:function(){var e=this.extraFields[28789];if(e){var t=new s(e.value);return 1!==t.readInt(1)?null:o.crc32(this.fileName)!==t.readInt(4)?null:o.utf8decode(t.readString(e.length-5))}return null},findExtraFieldUnicodeComment:function(){var e=this.extraFields[25461];if(e){var t=new s(e.value);return 1!==t.readInt(1)?null:o.crc32(this.fileComment)!==t.readInt(4)?null:o.utf8decode(t.readString(e.length-5))}return null}},t.exports=r},{"./compressedObject":2,"./object":13,"./stringReader":15,"./utils":21}],24:[function(e,t,n){"use strict";var r=e("./lib/utils/common").assign,s=e("./lib/deflate"),i=e("./lib/inflate"),a=e("./lib/zlib/constants"),o={};r(o,s,i,a),t.exports=o},{"./lib/deflate":25,"./lib/inflate":26,"./lib/utils/common":27,"./lib/zlib/constants":30}],25:[function(e,t,n){"use strict";function r(e,t){var n=new g(t);if(n.push(e,!0),n.err)throw n.msg;return n.result}function s(e,t){return t=t||{},t.raw=!0,r(e,t)}function i(e,t){return t=t||{},t.gzip=!0,r(e,t)}var a=e("./zlib/deflate.js"),o=e("./utils/common"),c=e("./utils/strings"),l=e("./zlib/messages"),u=e("./zlib/zstream"),f=0,d=4,p=0,h=1,m=-1,v=0,_=8,g=function(e){this.options=o.assign({level:m,method:_,chunkSize:16384,windowBits:15,memLevel:8,strategy:v,to:""},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var n=a.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==p)throw new Error(l[n]);t.header&&a.deflateSetHeader(this.strm,t.header)};g.prototype.push=function(e,t){var n,r,s=this.strm,i=this.options.chunkSize;if(this.ended)return!1;r=t===~~t?t:t===!0?d:f,"string"==typeof e?s.input=c.string2buf(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;do{if(0===s.avail_out&&(s.output=new o.Buf8(i),s.next_out=0,s.avail_out=i),n=a.deflate(s,r),n!==h&&n!==p)return this.onEnd(n),this.ended=!0,!1;(0===s.avail_out||0===s.avail_in&&r===d)&&("string"===this.options.to?this.onData(c.buf2binstring(o.shrinkBuf(s.output,s.next_out))):this.onData(o.shrinkBuf(s.output,s.next_out)))}while((s.avail_in>0||0===s.avail_out)&&n!==h);return r===d?(n=a.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===p):!0},g.prototype.onData=function(e){this.chunks.push(e)},g.prototype.onEnd=function(e){e===p&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=o.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},n.Deflate=g,n.deflate=r,n.deflateRaw=s,n.gzip=i},{"./utils/common":27,"./utils/strings":28,"./zlib/deflate.js":32,"./zlib/messages":37,"./zlib/zstream":39}],26:[function(e,t,n){"use strict";function r(e,t){var n=new d(t);if(n.push(e,!0),n.err)throw n.msg;return n.result}function s(e,t){return t=t||{},t.raw=!0,r(e,t)}var i=e("./zlib/inflate.js"),a=e("./utils/common"),o=e("./utils/strings"),c=e("./zlib/constants"),l=e("./zlib/messages"),u=e("./zlib/zstream"),f=e("./zlib/gzheader"),d=function(e){this.options=a.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0===(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var n=i.inflateInit2(this.strm,t.windowBits);if(n!==c.Z_OK)throw new Error(l[n]);this.header=new f,i.inflateGetHeader(this.strm,this.header)};d.prototype.push=function(e,t){var n,r,s,l,u,f=this.strm,d=this.options.chunkSize;if(this.ended)return!1;r=t===~~t?t:t===!0?c.Z_FINISH:c.Z_NO_FLUSH,"string"==typeof e?f.input=o.binstring2buf(e):f.input=e,f.next_in=0,f.avail_in=f.input.length;do{if(0===f.avail_out&&(f.output=new a.Buf8(d),f.next_out=0,f.avail_out=d),n=i.inflate(f,c.Z_NO_FLUSH),n!==c.Z_STREAM_END&&n!==c.Z_OK)return this.onEnd(n),this.ended=!0,!1;f.next_out&&(0===f.avail_out||n===c.Z_STREAM_END||0===f.avail_in&&r===c.Z_FINISH)&&("string"===this.options.to?(s=o.utf8border(f.output,f.next_out),l=f.next_out-s,u=o.buf2string(f.output,s),f.next_out=l,f.avail_out=d-l,l&&a.arraySet(f.output,f.output,s,l,0),this.onData(u)):this.onData(a.shrinkBuf(f.output,f.next_out)))}while(f.avail_in>0&&n!==c.Z_STREAM_END);return n===c.Z_STREAM_END&&(r=c.Z_FINISH),r===c.Z_FINISH?(n=i.inflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===c.Z_OK):!0},d.prototype.onData=function(e){this.chunks.push(e)},d.prototype.onEnd=function(e){e===c.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},n.Inflate=d,n.inflate=r,n.inflateRaw=s,n.ungzip=r},{"./utils/common":27,"./utils/strings":28,"./zlib/constants":30,"./zlib/gzheader":33,"./zlib/inflate.js":35,"./zlib/messages":37,"./zlib/zstream":39}],27:[function(e,t,n){"use strict";var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;n.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r])}}return e},n.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var s={arraySet:function(e,t,n,r,s){if(t.subarray&&e.subarray)return void e.set(t.subarray(n,n+r),s);for(var i=0;r>i;i++)e[s+i]=t[n+i]},flattenChunks:function(e){var t,n,r,s,i,a;for(r=0,t=0,n=e.length;n>t;t++)r+=e[t].length;for(a=new Uint8Array(r),s=0,t=0,n=e.length;n>t;t++)i=e[t],a.set(i,s),s+=i.length;return a}},i={arraySet:function(e,t,n,r,s){for(var i=0;r>i;i++)e[s+i]=t[n+i]},flattenChunks:function(e){return[].concat.apply([],e)}};n.setTyped=function(e){e?(n.Buf8=Uint8Array,n.Buf16=Uint16Array,n.Buf32=Int32Array,n.assign(n,s)):(n.Buf8=Array,n.Buf16=Array,n.Buf32=Array,n.assign(n,i))},n.setTyped(r)},{}],28:[function(e,t,n){"use strict";function r(e,t){if(65537>t&&(e.subarray&&a||!e.subarray&&i))return String.fromCharCode.apply(null,s.shrinkBuf(e,t));for(var n="",r=0;t>r;r++)n+=String.fromCharCode(e[r]);return n}var s=e("./common"),i=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch(o){i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(o){a=!1}for(var c=new s.Buf8(256),l=0;256>l;l++)c[l]=l>=252?6:l>=248?5:l>=240?4:l>=224?3:l>=192?2:1;c[254]=c[254]=1,n.string2buf=function(e){var t,n,r,i,a,o=e.length,c=0;for(i=0;o>i;i++)n=e.charCodeAt(i),55296===(64512&n)&&o>i+1&&(r=e.charCodeAt(i+1),56320===(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),c+=128>n?1:2048>n?2:65536>n?3:4;for(t=new s.Buf8(c),a=0,i=0;c>a;i++)n=e.charCodeAt(i),55296===(64512&n)&&o>i+1&&(r=e.charCodeAt(i+1),56320===(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),128>n?t[a++]=n:2048>n?(t[a++]=192|n>>>6,t[a++]=128|63&n):65536>n?(t[a++]=224|n>>>12,t[a++]=128|n>>>6&63,t[a++]=128|63&n):(t[a++]=240|n>>>18,t[a++]=128|n>>>12&63,t[a++]=128|n>>>6&63,t[a++]=128|63&n);return t},n.buf2binstring=function(e){return r(e,e.length)},n.binstring2buf=function(e){for(var t=new s.Buf8(e.length),n=0,r=t.length;r>n;n++)t[n]=e.charCodeAt(n);return t},n.buf2string=function(e,t){var n,s,i,a,o=t||e.length,l=new Array(2*o);for(s=0,n=0;o>n;)if(i=e[n++],128>i)l[s++]=i;else if(a=c[i],a>4)l[s++]=65533,n+=a-1;else{for(i&=2===a?31:3===a?15:7;a>1&&o>n;)i=i<<6|63&e[n++],a--;a>1?l[s++]=65533:65536>i?l[s++]=i:(i-=65536,l[s++]=55296|i>>10&1023,l[s++]=56320|1023&i)}return r(l,s)},n.utf8border=function(e,t){var n;for(t=t||e.length,t>e.length&&(t=e.length),n=t-1;n>=0&&128===(192&e[n]);)n--;return 0>n?t:0===n?t:n+c[e[n]]>t?n:t}},{"./common":27}],29:[function(e,t,n){"use strict";function r(e,t,n,r){for(var s=65535&e|0,i=e>>>16&65535|0,a=0;0!==n;){a=n>2e3?2e3:n,n-=a;do s=s+t[r++]|0,i=i+s|0;while(--a);s%=65521,i%=65521}return s|i<<16|0}t.exports=r},{}],30:[function(e,t,n){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],31:[function(e,t,n){"use strict";function r(){for(var e,t=[],n=0;256>n;n++){e=n;for(var r=0;8>r;r++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}function s(e,t,n,r){var s=i,a=r+n;e=-1^e;for(var o=r;a>o;o++)e=e>>>8^s[255&(e^t[o])];return-1^e}var i=r();t.exports=s},{}],32:[function(e,t,n){"use strict";function r(e,t){return e.msg=R[t],t}function s(e){return(e<<1)-(e>4?9:0)}function i(e){for(var t=e.length;--t>=0;)e[t]=0}function a(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(O.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function o(e,t){A._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,a(e.strm)}function c(e,t){e.pending_buf[e.pending++]=t}function l(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function u(e,t,n,r){var s=e.avail_in;return s>r&&(s=r),0===s?0:(e.avail_in-=s,O.arraySet(t,e.input,e.next_in,s,n),1===e.state.wrap?e.adler=N(e.adler,t,s,n):2===e.state.wrap&&(e.adler=B(e.adler,t,s,n)),e.next_in+=s,e.total_in+=s,s)}function f(e,t){var n,r,s=e.max_chain_length,i=e.strstart,a=e.prev_length,o=e.nice_match,c=e.strstart>e.w_size-le?e.strstart-(e.w_size-le):0,l=e.window,u=e.w_mask,f=e.prev,d=e.strstart+ce,p=l[i+a-1],h=l[i+a];e.prev_length>=e.good_match&&(s>>=2),o>e.lookahead&&(o=e.lookahead);do if(n=t,l[n+a]===h&&l[n+a-1]===p&&l[n]===l[i]&&l[++n]===l[i+1]){i+=2,n++;do;while(l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&l[++i]===l[++n]&&d>i);if(r=ce-(d-i),i=d-ce,r>a){if(e.match_start=t,a=r,r>=o)break;p=l[i+a-1],h=l[i+a]}}while((t=f[t&u])>c&&0!==--s);return a<=e.lookahead?a:e.lookahead}function d(e){var t,n,r,s,i,a=e.w_size;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=a+(a-le)){O.arraySet(e.window,e.window,a,a,0),e.match_start-=a,e.strstart-=a,e.block_start-=a,n=e.hash_size,t=n;do r=e.head[--t],e.head[t]=r>=a?r-a:0;while(--n);n=a,t=n;do r=e.prev[--t],e.prev[t]=r>=a?r-a:0;while(--n);s+=a}if(0===e.strm.avail_in)break;if(n=u(e.strm,e.window,e.strstart+e.lookahead,s),e.lookahead+=n,e.lookahead+e.insert>=oe)for(i=e.strstart-e.insert,e.ins_h=e.window[i],e.ins_h=(e.ins_h<<e.hash_shift^e.window[i+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[i+oe-1])&e.hash_mask,e.prev[i&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=i,i++,e.insert--,!(e.lookahead+e.insert<oe)););}while(e.lookahead<le&&0!==e.strm.avail_in)}function p(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(d(e),0===e.lookahead&&t===L)return ge;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var r=e.block_start+n;if((0===e.strstart||e.strstart>=r)&&(e.lookahead=e.strstart-r,e.strstart=r,o(e,!1),0===e.strm.avail_out))return ge;if(e.strstart-e.block_start>=e.w_size-le&&(o(e,!1),0===e.strm.avail_out))return ge}return e.insert=0,t===M?(o(e,!0),0===e.strm.avail_out?be:xe):e.strstart>e.block_start&&(o(e,!1),0===e.strm.avail_out)?ge:ge}function h(e,t){for(var n,r;;){if(e.lookahead<le){if(d(e),e.lookahead<le&&t===L)return ge;if(0===e.lookahead)break}if(n=0,e.lookahead>=oe&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+oe-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-le&&(e.match_length=f(e,n)),e.match_length>=oe)if(r=A._tr_tally(e,e.strstart-e.match_start,e.match_length-oe),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=oe){e.match_length--;do e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+oe-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(0!==--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else r=A._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(o(e,!1),0===e.strm.avail_out))return ge}return e.insert=e.strstart<oe-1?e.strstart:oe-1,t===M?(o(e,!0),0===e.strm.avail_out?be:xe):e.last_lit&&(o(e,!1),0===e.strm.avail_out)?ge:ye}function m(e,t){for(var n,r,s;;){if(e.lookahead<le){if(d(e),e.lookahead<le&&t===L)return ge;if(0===e.lookahead)break}if(n=0,e.lookahead>=oe&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+oe-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=oe-1,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-le&&(e.match_length=f(e,n),e.match_length<=5&&(e.strategy===U||e.match_length===oe&&e.strstart-e.match_start>4096)&&(e.match_length=oe-1)),e.prev_length>=oe&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-oe,r=A._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-oe),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=s&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+oe-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(0!==--e.prev_length);if(e.match_available=0,e.match_length=oe-1,e.strstart++,r&&(o(e,!1),0===e.strm.avail_out))return ge}else if(e.match_available){if(r=A._tr_tally(e,0,e.window[e.strstart-1]),r&&o(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return ge}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=A._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<oe-1?e.strstart:oe-1,t===M?(o(e,!0),0===e.strm.avail_out?be:xe):e.last_lit&&(o(e,!1),0===e.strm.avail_out)?ge:ye}function v(e,t){for(var n,r,s,i,a=e.window;;){if(e.lookahead<=ce){if(d(e),e.lookahead<=ce&&t===L)return ge;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=oe&&e.strstart>0&&(s=e.strstart-1,r=a[s],r===a[++s]&&r===a[++s]&&r===a[++s])){i=e.strstart+ce;do;while(r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&i>s);e.match_length=ce-(i-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=oe?(n=A._tr_tally(e,1,e.match_length-oe),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=A._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(o(e,!1),0===e.strm.avail_out))return ge}return e.insert=0,t===M?(o(e,!0),0===e.strm.avail_out?be:xe):e.last_lit&&(o(e,!1),0===e.strm.avail_out)?ge:ye}function _(e,t){for(var n;;){if(0===e.lookahead&&(d(e),0===e.lookahead)){if(t===L)return ge;break}if(e.match_length=0,n=A._tr_tally(e,0,e.window[e.strstart]),
e.lookahead--,e.strstart++,n&&(o(e,!1),0===e.strm.avail_out))return ge}return e.insert=0,t===M?(o(e,!0),0===e.strm.avail_out?be:xe):e.last_lit&&(o(e,!1),0===e.strm.avail_out)?ge:ye}function g(e){e.window_size=2*e.w_size,i(e.head),e.max_lazy_match=S[e.level].max_lazy,e.good_match=S[e.level].good_length,e.nice_match=S[e.level].nice_length,e.max_chain_length=S[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=oe-1,e.match_available=0,e.ins_h=0}function y(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=J,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new O.Buf16(2*ie),this.dyn_dtree=new O.Buf16(2*(2*re+1)),this.bl_tree=new O.Buf16(2*(2*se+1)),i(this.dyn_ltree),i(this.dyn_dtree),i(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new O.Buf16(ae+1),this.heap=new O.Buf16(2*ne+1),i(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new O.Buf16(2*ne+1),i(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function b(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=Q,t=e.state,t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?fe:ve,e.adler=2===t.wrap?0:1,t.last_flush=L,A._tr_init(t),j):r(e,q)}function x(e){var t=b(e);return t===j&&g(e.state),t}function w(e,t){return e&&e.state?2!==e.state.wrap?q:(e.state.gzhead=t,j):q}function k(e,t,n,s,i,a){if(!e)return q;var o=1;if(t===H&&(t=6),0>s?(o=0,s=-s):s>15&&(o=2,s-=16),1>i||i>G||n!==J||8>s||s>15||0>t||t>9||0>a||a>K)return r(e,q);8===s&&(s=9);var c=new y;return e.state=c,c.strm=e,c.wrap=o,c.gzhead=null,c.w_bits=s,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=i+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+oe-1)/oe),c.window=new O.Buf8(2*c.w_size),c.head=new O.Buf16(c.hash_size),c.prev=new O.Buf16(c.w_size),c.lit_bufsize=1<<i+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new O.Buf8(c.pending_buf_size),c.d_buf=c.lit_bufsize>>1,c.l_buf=3*c.lit_bufsize,c.level=t,c.strategy=a,c.method=n,x(e)}function E(e,t){return k(e,t,J,Y,Z,X)}function T(e,t){var n,o,u,f;if(!e||!e.state||t>D||0>t)return e?r(e,q):q;if(o=e.state,!e.output||!e.input&&0!==e.avail_in||o.status===_e&&t!==M)return r(e,0===e.avail_out?z:q);if(o.strm=e,n=o.last_flush,o.last_flush=t,o.status===fe)if(2===o.wrap)e.adler=0,c(o,31),c(o,139),c(o,8),o.gzhead?(c(o,(o.gzhead.text?1:0)+(o.gzhead.hcrc?2:0)+(o.gzhead.extra?4:0)+(o.gzhead.name?8:0)+(o.gzhead.comment?16:0)),c(o,255&o.gzhead.time),c(o,o.gzhead.time>>8&255),c(o,o.gzhead.time>>16&255),c(o,o.gzhead.time>>24&255),c(o,9===o.level?2:o.strategy>=$||o.level<2?4:0),c(o,255&o.gzhead.os),o.gzhead.extra&&o.gzhead.extra.length&&(c(o,255&o.gzhead.extra.length),c(o,o.gzhead.extra.length>>8&255)),o.gzhead.hcrc&&(e.adler=B(e.adler,o.pending_buf,o.pending,0)),o.gzindex=0,o.status=de):(c(o,0),c(o,0),c(o,0),c(o,0),c(o,0),c(o,9===o.level?2:o.strategy>=$||o.level<2?4:0),c(o,we),o.status=ve);else{var d=J+(o.w_bits-8<<4)<<8,p=-1;p=o.strategy>=$||o.level<2?0:o.level<6?1:6===o.level?2:3,d|=p<<6,0!==o.strstart&&(d|=ue),d+=31-d%31,o.status=ve,l(o,d),0!==o.strstart&&(l(o,e.adler>>>16),l(o,65535&e.adler)),e.adler=1}if(o.status===de)if(o.gzhead.extra){for(u=o.pending;o.gzindex<(65535&o.gzhead.extra.length)&&(o.pending!==o.pending_buf_size||(o.gzhead.hcrc&&o.pending>u&&(e.adler=B(e.adler,o.pending_buf,o.pending-u,u)),a(e),u=o.pending,o.pending!==o.pending_buf_size));)c(o,255&o.gzhead.extra[o.gzindex]),o.gzindex++;o.gzhead.hcrc&&o.pending>u&&(e.adler=B(e.adler,o.pending_buf,o.pending-u,u)),o.gzindex===o.gzhead.extra.length&&(o.gzindex=0,o.status=pe)}else o.status=pe;if(o.status===pe)if(o.gzhead.name){u=o.pending;do{if(o.pending===o.pending_buf_size&&(o.gzhead.hcrc&&o.pending>u&&(e.adler=B(e.adler,o.pending_buf,o.pending-u,u)),a(e),u=o.pending,o.pending===o.pending_buf_size)){f=1;break}f=o.gzindex<o.gzhead.name.length?255&o.gzhead.name.charCodeAt(o.gzindex++):0,c(o,f)}while(0!==f);o.gzhead.hcrc&&o.pending>u&&(e.adler=B(e.adler,o.pending_buf,o.pending-u,u)),0===f&&(o.gzindex=0,o.status=he)}else o.status=he;if(o.status===he)if(o.gzhead.comment){u=o.pending;do{if(o.pending===o.pending_buf_size&&(o.gzhead.hcrc&&o.pending>u&&(e.adler=B(e.adler,o.pending_buf,o.pending-u,u)),a(e),u=o.pending,o.pending===o.pending_buf_size)){f=1;break}f=o.gzindex<o.gzhead.comment.length?255&o.gzhead.comment.charCodeAt(o.gzindex++):0,c(o,f)}while(0!==f);o.gzhead.hcrc&&o.pending>u&&(e.adler=B(e.adler,o.pending_buf,o.pending-u,u)),0===f&&(o.status=me)}else o.status=me;if(o.status===me&&(o.gzhead.hcrc?(o.pending+2>o.pending_buf_size&&a(e),o.pending+2<=o.pending_buf_size&&(c(o,255&e.adler),c(o,e.adler>>8&255),e.adler=0,o.status=ve)):o.status=ve),0!==o.pending){if(a(e),0===e.avail_out)return o.last_flush=-1,j}else if(0===e.avail_in&&s(t)<=s(n)&&t!==M)return r(e,z);if(o.status===_e&&0!==e.avail_in)return r(e,z);if(0!==e.avail_in||0!==o.lookahead||t!==L&&o.status!==_e){var h=o.strategy===$?_(o,t):o.strategy===W?v(o,t):S[o.level].func(o,t);if((h===be||h===xe)&&(o.status=_e),h===ge||h===be)return 0===e.avail_out&&(o.last_flush=-1),j;if(h===ye&&(t===P?A._tr_align(o):t!==D&&(A._tr_stored_block(o,0,0,!1),t===I&&(i(o.head),0===o.lookahead&&(o.strstart=0,o.block_start=0,o.insert=0))),a(e),0===e.avail_out))return o.last_flush=-1,j}return t!==M?j:o.wrap<=0?F:(2===o.wrap?(c(o,255&e.adler),c(o,e.adler>>8&255),c(o,e.adler>>16&255),c(o,e.adler>>24&255),c(o,255&e.total_in),c(o,e.total_in>>8&255),c(o,e.total_in>>16&255),c(o,e.total_in>>24&255)):(l(o,e.adler>>>16),l(o,65535&e.adler)),a(e),o.wrap>0&&(o.wrap=-o.wrap),0!==o.pending?j:F)}function C(e){var t;return e&&e.state?(t=e.state.status,t!==fe&&t!==de&&t!==pe&&t!==he&&t!==me&&t!==ve&&t!==_e?r(e,q):(e.state=null,t===ve?r(e,V):j)):q}var S,O=e("../utils/common"),A=e("./trees"),N=e("./adler32"),B=e("./crc32"),R=e("./messages"),L=0,P=1,I=3,M=4,D=5,j=0,F=1,q=-2,V=-3,z=-5,H=-1,U=1,$=2,W=3,K=4,X=0,Q=2,J=8,G=9,Y=15,Z=8,ee=29,te=256,ne=te+1+ee,re=30,se=19,ie=2*ne+1,ae=15,oe=3,ce=258,le=ce+oe+1,ue=32,fe=42,de=69,pe=73,he=91,me=103,ve=113,_e=666,ge=1,ye=2,be=3,xe=4,we=3,ke=function(e,t,n,r,s){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=r,this.func=s};S=[new ke(0,0,0,0,p),new ke(4,4,8,4,h),new ke(4,5,16,8,h),new ke(4,6,32,32,h),new ke(4,4,16,16,m),new ke(8,16,32,32,m),new ke(8,16,128,128,m),new ke(8,32,128,256,m),new ke(32,128,258,1024,m),new ke(32,258,258,4096,m)],n.deflateInit=E,n.deflateInit2=k,n.deflateReset=x,n.deflateResetKeep=b,n.deflateSetHeader=w,n.deflate=T,n.deflateEnd=C,n.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":27,"./adler32":29,"./crc32":31,"./messages":37,"./trees":38}],33:[function(e,t,n){"use strict";function r(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}t.exports=r},{}],34:[function(e,t,n){"use strict";var r=30,s=12;t.exports=function(e,t){var n,i,a,o,c,l,u,f,d,p,h,m,v,_,g,y,b,x,w,k,E,T,C,S,O;n=e.state,i=e.next_in,S=e.input,a=i+(e.avail_in-5),o=e.next_out,O=e.output,c=o-(t-e.avail_out),l=o+(e.avail_out-257),u=n.dmax,f=n.wsize,d=n.whave,p=n.wnext,h=n.window,m=n.hold,v=n.bits,_=n.lencode,g=n.distcode,y=(1<<n.lenbits)-1,b=(1<<n.distbits)-1;e:do{15>v&&(m+=S[i++]<<v,v+=8,m+=S[i++]<<v,v+=8),x=_[m&y];t:for(;;){if(w=x>>>24,m>>>=w,v-=w,w=x>>>16&255,0===w)O[o++]=65535&x;else{if(!(16&w)){if(0===(64&w)){x=_[(65535&x)+(m&(1<<w)-1)];continue t}if(32&w){n.mode=s;break e}e.msg="invalid literal/length code",n.mode=r;break e}k=65535&x,w&=15,w&&(w>v&&(m+=S[i++]<<v,v+=8),k+=m&(1<<w)-1,m>>>=w,v-=w),15>v&&(m+=S[i++]<<v,v+=8,m+=S[i++]<<v,v+=8),x=g[m&b];n:for(;;){if(w=x>>>24,m>>>=w,v-=w,w=x>>>16&255,!(16&w)){if(0===(64&w)){x=g[(65535&x)+(m&(1<<w)-1)];continue n}e.msg="invalid distance code",n.mode=r;break e}if(E=65535&x,w&=15,w>v&&(m+=S[i++]<<v,v+=8,w>v&&(m+=S[i++]<<v,v+=8)),E+=m&(1<<w)-1,E>u){e.msg="invalid distance too far back",n.mode=r;break e}if(m>>>=w,v-=w,w=o-c,E>w){if(w=E-w,w>d&&n.sane){e.msg="invalid distance too far back",n.mode=r;break e}if(T=0,C=h,0===p){if(T+=f-w,k>w){k-=w;do O[o++]=h[T++];while(--w);T=o-E,C=O}}else if(w>p){if(T+=f+p-w,w-=p,k>w){k-=w;do O[o++]=h[T++];while(--w);if(T=0,k>p){w=p,k-=w;do O[o++]=h[T++];while(--w);T=o-E,C=O}}}else if(T+=p-w,k>w){k-=w;do O[o++]=h[T++];while(--w);T=o-E,C=O}for(;k>2;)O[o++]=C[T++],O[o++]=C[T++],O[o++]=C[T++],k-=3;k&&(O[o++]=C[T++],k>1&&(O[o++]=C[T++]))}else{T=o-E;do O[o++]=O[T++],O[o++]=O[T++],O[o++]=O[T++],k-=3;while(k>2);k&&(O[o++]=O[T++],k>1&&(O[o++]=O[T++]))}break}}break}}while(a>i&&l>o);k=v>>3,i-=k,v-=k<<3,m&=(1<<v)-1,e.next_in=i,e.next_out=o,e.avail_in=a>i?5+(a-i):5-(i-a),e.avail_out=l>o?257+(l-o):257-(o-l),n.hold=m,n.bits=v}},{}],35:[function(e,t,n){"use strict";function r(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function s(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new _.Buf16(320),this.work=new _.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function i(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=M,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new _.Buf32(he),t.distcode=t.distdyn=new _.Buf32(me),t.sane=1,t.back=-1,O):B}function a(e){var t;return e&&e.state?(t=e.state,t.wsize=0,t.whave=0,t.wnext=0,i(e)):B}function o(e,t){var n,r;return e&&e.state?(r=e.state,0>t?(n=0,t=-t):(n=(t>>4)+1,48>t&&(t&=15)),t&&(8>t||t>15)?B:(null!==r.window&&r.wbits!==t&&(r.window=null),r.wrap=n,r.wbits=t,a(e))):B}function c(e,t){var n,r;return e?(r=new s,e.state=r,r.window=null,n=o(e,t),n!==O&&(e.state=null),n):B}function l(e){return c(e,_e)}function u(e){if(ge){var t;for(m=new _.Buf32(512),v=new _.Buf32(32),t=0;144>t;)e.lens[t++]=8;for(;256>t;)e.lens[t++]=9;for(;280>t;)e.lens[t++]=7;for(;288>t;)e.lens[t++]=8;for(x(k,e.lens,0,288,m,0,e.work,{bits:9}),t=0;32>t;)e.lens[t++]=5;x(E,e.lens,0,32,v,0,e.work,{bits:5}),ge=!1}e.lencode=m,e.lenbits=9,e.distcode=v,e.distbits=5}function f(e,t,n,r){var s,i=e.state;return null===i.window&&(i.wsize=1<<i.wbits,i.wnext=0,i.whave=0,i.window=new _.Buf8(i.wsize)),r>=i.wsize?(_.arraySet(i.window,t,n-i.wsize,i.wsize,0),i.wnext=0,i.whave=i.wsize):(s=i.wsize-i.wnext,s>r&&(s=r),_.arraySet(i.window,t,n-r,s,i.wnext),r-=s,r?(_.arraySet(i.window,t,n-r,r,0),i.wnext=r,i.whave=i.wsize):(i.wnext+=s,i.wnext===i.wsize&&(i.wnext=0),i.whave<i.wsize&&(i.whave+=s))),0}function d(e,t){var n,s,i,a,o,c,l,d,p,h,m,v,he,me,ve,_e,ge,ye,be,xe,we,ke,Ee,Te,Ce=0,Se=new _.Buf8(4),Oe=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return B;n=e.state,n.mode===K&&(n.mode=X),o=e.next_out,i=e.output,l=e.avail_out,a=e.next_in,s=e.input,c=e.avail_in,d=n.hold,p=n.bits,h=c,m=l,ke=O;e:for(;;)switch(n.mode){case M:if(0===n.wrap){n.mode=X;break}for(;16>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(2&n.wrap&&35615===d){n.check=0,Se[0]=255&d,Se[1]=d>>>8&255,n.check=y(n.check,Se,2,0),d=0,p=0,n.mode=D;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){e.msg="incorrect header check",n.mode=fe;break}if((15&d)!==I){e.msg="unknown compression method",n.mode=fe;break}if(d>>>=4,p-=4,we=(15&d)+8,0===n.wbits)n.wbits=we;else if(we>n.wbits){e.msg="invalid window size",n.mode=fe;break}n.dmax=1<<we,e.adler=n.check=1,n.mode=512&d?$:K,d=0,p=0;break;case D:for(;16>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(n.flags=d,(255&n.flags)!==I){e.msg="unknown compression method",n.mode=fe;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=fe;break}n.head&&(n.head.text=d>>8&1),512&n.flags&&(Se[0]=255&d,Se[1]=d>>>8&255,n.check=y(n.check,Se,2,0)),d=0,p=0,n.mode=j;case j:for(;32>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}n.head&&(n.head.time=d),512&n.flags&&(Se[0]=255&d,Se[1]=d>>>8&255,Se[2]=d>>>16&255,Se[3]=d>>>24&255,n.check=y(n.check,Se,4,0)),d=0,p=0,n.mode=F;case F:for(;16>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&n.flags&&(Se[0]=255&d,Se[1]=d>>>8&255,n.check=y(n.check,Se,2,0)),d=0,p=0,n.mode=q;case q:if(1024&n.flags){for(;16>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}n.length=d,n.head&&(n.head.extra_len=d),512&n.flags&&(Se[0]=255&d,Se[1]=d>>>8&255,n.check=y(n.check,Se,2,0)),d=0,p=0}else n.head&&(n.head.extra=null);n.mode=V;case V:if(1024&n.flags&&(v=n.length,v>c&&(v=c),v&&(n.head&&(we=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),_.arraySet(n.head.extra,s,a,v,we)),512&n.flags&&(n.check=y(n.check,s,v,a)),c-=v,a+=v,n.length-=v),n.length))break e;n.length=0,n.mode=z;case z:if(2048&n.flags){if(0===c)break e;v=0;do we=s[a+v++],n.head&&we&&n.length<65536&&(n.head.name+=String.fromCharCode(we));while(we&&c>v);if(512&n.flags&&(n.check=y(n.check,s,v,a)),c-=v,a+=v,we)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=H;case H:if(4096&n.flags){if(0===c)break e;v=0;do we=s[a+v++],n.head&&we&&n.length<65536&&(n.head.comment+=String.fromCharCode(we));while(we&&c>v);if(512&n.flags&&(n.check=y(n.check,s,v,a)),c-=v,a+=v,we)break e}else n.head&&(n.head.comment=null);n.mode=U;case U:if(512&n.flags){for(;16>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(d!==(65535&n.check)){e.msg="header crc mismatch",n.mode=fe;break}d=0,p=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=K;break;case $:for(;32>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}e.adler=n.check=r(d),d=0,p=0,n.mode=W;case W:if(0===n.havedict)return e.next_out=o,e.avail_out=l,e.next_in=a,e.avail_in=c,n.hold=d,n.bits=p,N;e.adler=n.check=1,n.mode=K;case K:if(t===C||t===S)break e;case X:if(n.last){d>>>=7&p,p-=7&p,n.mode=ce;break}for(;3>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}switch(n.last=1&d,d>>>=1,p-=1,3&d){case 0:n.mode=Q;break;case 1:if(u(n),n.mode=te,t===S){d>>>=2,p-=2;break e}break;case 2:n.mode=Y;break;case 3:e.msg="invalid block type",n.mode=fe}d>>>=2,p-=2;break;case Q:for(d>>>=7&p,p-=7&p;32>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if((65535&d)!==(d>>>16^65535)){e.msg="invalid stored block lengths",n.mode=fe;break}if(n.length=65535&d,d=0,p=0,n.mode=J,t===S)break e;case J:n.mode=G;case G:if(v=n.length){if(v>c&&(v=c),v>l&&(v=l),0===v)break e;_.arraySet(i,s,a,v,o),c-=v,a+=v,l-=v,o+=v,n.length-=v;break}n.mode=K;break;case Y:for(;14>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(n.nlen=(31&d)+257,d>>>=5,p-=5,n.ndist=(31&d)+1,d>>>=5,p-=5,n.ncode=(15&d)+4,d>>>=4,p-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=fe;break}n.have=0,n.mode=Z;case Z:for(;n.have<n.ncode;){for(;3>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}n.lens[Oe[n.have++]]=7&d,d>>>=3,p-=3}for(;n.have<19;)n.lens[Oe[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,Ee={bits:n.lenbits},ke=x(w,n.lens,0,19,n.lencode,0,n.work,Ee),n.lenbits=Ee.bits,ke){e.msg="invalid code lengths set",n.mode=fe;break}n.have=0,n.mode=ee;case ee:for(;n.have<n.nlen+n.ndist;){for(;Ce=n.lencode[d&(1<<n.lenbits)-1],ve=Ce>>>24,_e=Ce>>>16&255,ge=65535&Ce,!(p>=ve);){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(16>ge)d>>>=ve,p-=ve,n.lens[n.have++]=ge;else{if(16===ge){for(Te=ve+2;Te>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(d>>>=ve,p-=ve,0===n.have){e.msg="invalid bit length repeat",n.mode=fe;break}we=n.lens[n.have-1],v=3+(3&d),d>>>=2,p-=2}else if(17===ge){for(Te=ve+3;Te>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}d>>>=ve,p-=ve,we=0,v=3+(7&d),d>>>=3,p-=3}else{for(Te=ve+7;Te>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}d>>>=ve,p-=ve,we=0,v=11+(127&d),d>>>=7,p-=7}if(n.have+v>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=fe;break}for(;v--;)n.lens[n.have++]=we}}if(n.mode===fe)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=fe;break}if(n.lenbits=9,Ee={bits:n.lenbits},ke=x(k,n.lens,0,n.nlen,n.lencode,0,n.work,Ee),n.lenbits=Ee.bits,ke){e.msg="invalid literal/lengths set",n.mode=fe;break}if(n.distbits=6,n.distcode=n.distdyn,Ee={bits:n.distbits},ke=x(E,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,Ee),n.distbits=Ee.bits,ke){e.msg="invalid distances set",n.mode=fe;break}if(n.mode=te,t===S)break e;case te:n.mode=ne;case ne:if(c>=6&&l>=258){e.next_out=o,e.avail_out=l,e.next_in=a,e.avail_in=c,n.hold=d,n.bits=p,b(e,m),o=e.next_out,i=e.output,l=e.avail_out,a=e.next_in,s=e.input,c=e.avail_in,d=n.hold,p=n.bits,n.mode===K&&(n.back=-1);break}for(n.back=0;Ce=n.lencode[d&(1<<n.lenbits)-1],ve=Ce>>>24,_e=Ce>>>16&255,ge=65535&Ce,!(p>=ve);){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(_e&&0===(240&_e)){for(ye=ve,be=_e,xe=ge;Ce=n.lencode[xe+((d&(1<<ye+be)-1)>>ye)],ve=Ce>>>24,_e=Ce>>>16&255,ge=65535&Ce,!(p>=ye+ve);){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}d>>>=ye,p-=ye,n.back+=ye}if(d>>>=ve,p-=ve,n.back+=ve,n.length=ge,0===_e){n.mode=oe;break}if(32&_e){n.back=-1,n.mode=K;break}if(64&_e){e.msg="invalid literal/length code",n.mode=fe;break}n.extra=15&_e,n.mode=re;case re:if(n.extra){for(Te=n.extra;Te>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,p-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=se;case se:for(;Ce=n.distcode[d&(1<<n.distbits)-1],ve=Ce>>>24,_e=Ce>>>16&255,ge=65535&Ce,!(p>=ve);){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(0===(240&_e)){for(ye=ve,be=_e,xe=ge;Ce=n.distcode[xe+((d&(1<<ye+be)-1)>>ye)],ve=Ce>>>24,_e=Ce>>>16&255,ge=65535&Ce,!(p>=ye+ve);){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}d>>>=ye,p-=ye,n.back+=ye}if(d>>>=ve,p-=ve,n.back+=ve,64&_e){e.msg="invalid distance code",n.mode=fe;break}n.offset=ge,n.extra=15&_e,n.mode=ie;case ie:if(n.extra){for(Te=n.extra;Te>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,p-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=fe;break}n.mode=ae;case ae:if(0===l)break e;if(v=m-l,n.offset>v){if(v=n.offset-v,v>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=fe;break}v>n.wnext?(v-=n.wnext,he=n.wsize-v):he=n.wnext-v,v>n.length&&(v=n.length),me=n.window}else me=i,he=o-n.offset,v=n.length;v>l&&(v=l),l-=v,n.length-=v;do i[o++]=me[he++];while(--v);0===n.length&&(n.mode=ne);break;case oe:if(0===l)break e;i[o++]=n.length,l--,n.mode=ne;break;case ce:if(n.wrap){for(;32>p;){if(0===c)break e;c--,d|=s[a++]<<p,p+=8}if(m-=l,e.total_out+=m,n.total+=m,m&&(e.adler=n.check=n.flags?y(n.check,i,m,o-m):g(n.check,i,m,o-m)),m=l,(n.flags?d:r(d))!==n.check){e.msg="incorrect data check",n.mode=fe;break}d=0,p=0}n.mode=le;case le:if(n.wrap&&n.flags){for(;32>p;){if(0===c)break e;c--,d+=s[a++]<<p,p+=8}if(d!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=fe;break}d=0,p=0}n.mode=ue;case ue:ke=A;break e;case fe:ke=R;break e;case de:return L;case pe:default:return B}return e.next_out=o,e.avail_out=l,e.next_in=a,e.avail_in=c,n.hold=d,n.bits=p,(n.wsize||m!==e.avail_out&&n.mode<fe&&(n.mode<ce||t!==T))&&f(e,e.output,e.next_out,m-e.avail_out)?(n.mode=de,L):(h-=e.avail_in,m-=e.avail_out,e.total_in+=h,e.total_out+=m,n.total+=m,n.wrap&&m&&(e.adler=n.check=n.flags?y(n.check,i,m,e.next_out-m):g(n.check,i,m,e.next_out-m)),e.data_type=n.bits+(n.last?64:0)+(n.mode===K?128:0)+(n.mode===te||n.mode===J?256:0),(0===h&&0===m||t===T)&&ke===O&&(ke=P),ke)}function p(e){if(!e||!e.state)return B;var t=e.state;return t.window&&(t.window=null),e.state=null,O}function h(e,t){var n;return e&&e.state?(n=e.state,0===(2&n.wrap)?B:(n.head=t,t.done=!1,O)):B}var m,v,_=e("../utils/common"),g=e("./adler32"),y=e("./crc32"),b=e("./inffast"),x=e("./inftrees"),w=0,k=1,E=2,T=4,C=5,S=6,O=0,A=1,N=2,B=-2,R=-3,L=-4,P=-5,I=8,M=1,D=2,j=3,F=4,q=5,V=6,z=7,H=8,U=9,$=10,W=11,K=12,X=13,Q=14,J=15,G=16,Y=17,Z=18,ee=19,te=20,ne=21,re=22,se=23,ie=24,ae=25,oe=26,ce=27,le=28,ue=29,fe=30,de=31,pe=32,he=852,me=592,ve=15,_e=ve,ge=!0;n.inflateReset=a,n.inflateReset2=o,n.inflateResetKeep=i,n.inflateInit=l,n.inflateInit2=c,n.inflate=d,n.inflateEnd=p,n.inflateGetHeader=h,n.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":27,"./adler32":29,"./crc32":31,"./inffast":34,"./inftrees":36}],36:[function(e,t,n){"use strict";var r=e("../utils/common"),s=15,i=852,a=592,o=0,c=1,l=2,u=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],f=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],d=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],p=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,n,h,m,v,_,g){var y,b,x,w,k,E,T,C,S,O=g.bits,A=0,N=0,B=0,R=0,L=0,P=0,I=0,M=0,D=0,j=0,F=null,q=0,V=new r.Buf16(s+1),z=new r.Buf16(s+1),H=null,U=0;for(A=0;s>=A;A++)V[A]=0;for(N=0;h>N;N++)V[t[n+N]]++;for(L=O,R=s;R>=1&&0===V[R];R--);if(L>R&&(L=R),0===R)return m[v++]=20971520,m[v++]=20971520,g.bits=1,0;for(B=1;R>B&&0===V[B];B++);for(B>L&&(L=B),M=1,A=1;s>=A;A++)if(M<<=1,M-=V[A],0>M)return-1;if(M>0&&(e===o||1!==R))return-1;for(z[1]=0,A=1;s>A;A++)z[A+1]=z[A]+V[A];for(N=0;h>N;N++)0!==t[n+N]&&(_[z[t[n+N]]++]=N);if(e===o?(F=H=_,E=19):e===c?(F=u,q-=257,H=f,U-=257,E=256):(F=d,H=p,E=-1),j=0,N=0,A=B,k=v,P=L,I=0,x=-1,D=1<<L,w=D-1,e===c&&D>i||e===l&&D>a)return 1;for(var $=0;;){$++,T=A-I,_[N]<E?(C=0,S=_[N]):_[N]>E?(C=H[U+_[N]],S=F[q+_[N]]):(C=96,S=0),y=1<<A-I,b=1<<P,B=b;do b-=y,m[k+(j>>I)+b]=T<<24|C<<16|S|0;while(0!==b);for(y=1<<A-1;j&y;)y>>=1;if(0!==y?(j&=y-1,j+=y):j=0,N++,0===--V[A]){if(A===R)break;A=t[n+_[N]]}if(A>L&&(j&w)!==x){for(0===I&&(I=L),k+=B,P=A-I,M=1<<P;R>P+I&&(M-=V[P+I],!(0>=M));)P++,M<<=1;if(D+=1<<P,e===c&&D>i||e===l&&D>a)return 1;x=j&w,m[x]=L<<24|P<<16|k-v|0}}return 0!==j&&(m[k+j]=A-I<<24|64<<16|0),g.bits=L,0}},{"../utils/common":27}],37:[function(e,t,n){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],38:[function(e,t,n){"use strict";function r(e){for(var t=e.length;--t>=0;)e[t]=0}function s(e){return 256>e?ae[e]:ae[256+(e>>>7)]}function i(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function a(e,t,n){e.bi_valid>K-n?(e.bi_buf|=t<<e.bi_valid&65535,i(e,e.bi_buf),e.bi_buf=t>>K-e.bi_valid,e.bi_valid+=n-K):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function o(e,t,n){a(e,n[2*t],n[2*t+1])}function c(e,t){var n=0;do n|=1&e,e>>>=1,n<<=1;while(--t>0);return n>>>1}function l(e){16===e.bi_valid?(i(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}function u(e,t){var n,r,s,i,a,o,c=t.dyn_tree,l=t.max_code,u=t.stat_desc.static_tree,f=t.stat_desc.has_stree,d=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,h=t.stat_desc.max_length,m=0;for(i=0;W>=i;i++)e.bl_count[i]=0;for(c[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;$>n;n++)r=e.heap[n],i=c[2*c[2*r+1]+1]+1,i>h&&(i=h,m++),c[2*r+1]=i,r>l||(e.bl_count[i]++,a=0,r>=p&&(a=d[r-p]),o=c[2*r],e.opt_len+=o*(i+a),f&&(e.static_len+=o*(u[2*r+1]+a)));if(0!==m){do{for(i=h-1;0===e.bl_count[i];)i--;e.bl_count[i]--,e.bl_count[i+1]+=2,e.bl_count[h]--,m-=2}while(m>0);for(i=h;0!==i;i--)for(r=e.bl_count[i];0!==r;)s=e.heap[--n],s>l||(c[2*s+1]!==i&&(e.opt_len+=(i-c[2*s+1])*c[2*s],c[2*s+1]=i),r--)}}function f(e,t,n){var r,s,i=new Array(W+1),a=0;for(r=1;W>=r;r++)i[r]=a=a+n[r-1]<<1;for(s=0;t>=s;s++){var o=e[2*s+1];0!==o&&(e[2*s]=c(i[o]++,o))}}function d(){var e,t,n,r,s,i=new Array(W+1);for(n=0,r=0;q-1>r;r++)for(ce[r]=n,e=0;e<1<<Z[r];e++)oe[n++]=r;for(oe[n-1]=r,s=0,r=0;16>r;r++)for(le[r]=s,e=0;e<1<<ee[r];e++)ae[s++]=r;for(s>>=7;H>r;r++)for(le[r]=s<<7,e=0;e<1<<ee[r]-7;e++)ae[256+s++]=r;for(t=0;W>=t;t++)i[t]=0;for(e=0;143>=e;)se[2*e+1]=8,e++,i[8]++;for(;255>=e;)se[2*e+1]=9,e++,i[9]++;for(;279>=e;)se[2*e+1]=7,e++,i[7]++;for(;287>=e;)se[2*e+1]=8,e++,i[8]++;for(f(se,z+1,i),e=0;H>e;e++)ie[2*e+1]=5,ie[2*e]=c(e,5);ue=new pe(se,Z,V+1,z,W),fe=new pe(ie,ee,0,H,W),de=new pe(new Array(0),te,0,U,X)}function p(e){var t;for(t=0;z>t;t++)e.dyn_ltree[2*t]=0;for(t=0;H>t;t++)e.dyn_dtree[2*t]=0;for(t=0;U>t;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*Q]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function h(e){e.bi_valid>8?i(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function m(e,t,n,r){h(e),r&&(i(e,n),i(e,~n)),N.arraySet(e.pending_buf,e.window,t,n,e.pending),e.pending+=n}function v(e,t,n,r){var s=2*t,i=2*n;return e[s]<e[i]||e[s]===e[i]&&r[t]<=r[n]}function _(e,t,n){for(var r=e.heap[n],s=n<<1;s<=e.heap_len&&(s<e.heap_len&&v(t,e.heap[s+1],e.heap[s],e.depth)&&s++,!v(t,r,e.heap[s],e.depth));)e.heap[n]=e.heap[s],n=s,s<<=1;e.heap[n]=r}function g(e,t,n){var r,i,c,l,u=0;if(0!==e.last_lit)do r=e.pending_buf[e.d_buf+2*u]<<8|e.pending_buf[e.d_buf+2*u+1],i=e.pending_buf[e.l_buf+u],u++,0===r?o(e,i,t):(c=oe[i],o(e,c+V+1,t),l=Z[c],0!==l&&(i-=ce[c],a(e,i,l)),r--,c=s(r),o(e,c,n),l=ee[c],0!==l&&(r-=le[c],a(e,r,l)));while(u<e.last_lit);o(e,Q,t)}function y(e,t){var n,r,s,i=t.dyn_tree,a=t.stat_desc.static_tree,o=t.stat_desc.has_stree,c=t.stat_desc.elems,l=-1;for(e.heap_len=0,e.heap_max=$,n=0;c>n;n++)0!==i[2*n]?(e.heap[++e.heap_len]=l=n,e.depth[n]=0):i[2*n+1]=0;for(;e.heap_len<2;)s=e.heap[++e.heap_len]=2>l?++l:0,i[2*s]=1,e.depth[s]=0,e.opt_len--,o&&(e.static_len-=a[2*s+1]);for(t.max_code=l,n=e.heap_len>>1;n>=1;n--)_(e,i,n);s=c;do n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],_(e,i,1),r=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=r,i[2*s]=i[2*n]+i[2*r],e.depth[s]=(e.depth[n]>=e.depth[r]?e.depth[n]:e.depth[r])+1,i[2*n+1]=i[2*r+1]=s,e.heap[1]=s++,_(e,i,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],u(e,t),f(i,l,e.bl_count)}function b(e,t,n){var r,s,i=-1,a=t[1],o=0,c=7,l=4;for(0===a&&(c=138,l=3),t[2*(n+1)+1]=65535,r=0;n>=r;r++)s=a,a=t[2*(r+1)+1],++o<c&&s===a||(l>o?e.bl_tree[2*s]+=o:0!==s?(s!==i&&e.bl_tree[2*s]++,e.bl_tree[2*J]++):10>=o?e.bl_tree[2*G]++:e.bl_tree[2*Y]++,o=0,i=s,0===a?(c=138,l=3):s===a?(c=6,l=3):(c=7,l=4))}function x(e,t,n){var r,s,i=-1,c=t[1],l=0,u=7,f=4;for(0===c&&(u=138,f=3),r=0;n>=r;r++)if(s=c,c=t[2*(r+1)+1],!(++l<u&&s===c)){if(f>l){do o(e,s,e.bl_tree);while(0!==--l)}else 0!==s?(s!==i&&(o(e,s,e.bl_tree),l--),o(e,J,e.bl_tree),a(e,l-3,2)):10>=l?(o(e,G,e.bl_tree),a(e,l-3,3)):(o(e,Y,e.bl_tree),a(e,l-11,7));l=0,i=s,0===c?(u=138,f=3):s===c?(u=6,f=3):(u=7,f=4)}}function w(e){var t;for(b(e,e.dyn_ltree,e.l_desc.max_code),b(e,e.dyn_dtree,e.d_desc.max_code),y(e,e.bl_desc),t=U-1;t>=3&&0===e.bl_tree[2*ne[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}function k(e,t,n,r){var s;for(a(e,t-257,5),a(e,n-1,5),a(e,r-4,4),s=0;r>s;s++)a(e,e.bl_tree[2*ne[s]+1],3);x(e,e.dyn_ltree,t-1),x(e,e.dyn_dtree,n-1)}function E(e){var t,n=4093624447;for(t=0;31>=t;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return R;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return L;for(t=32;V>t;t++)if(0!==e.dyn_ltree[2*t])return L;return R}function T(e){me||(d(),me=!0),e.l_desc=new he(e.dyn_ltree,ue),e.d_desc=new he(e.dyn_dtree,fe),e.bl_desc=new he(e.bl_tree,de),e.bi_buf=0,e.bi_valid=0,p(e)}function C(e,t,n,r){a(e,(I<<1)+(r?1:0),3),m(e,t,n,!0)}function S(e){a(e,M<<1,3),o(e,Q,se),l(e)}function O(e,t,n,r){var s,i,o=0;e.level>0?(e.strm.data_type===P&&(e.strm.data_type=E(e)),y(e,e.l_desc),y(e,e.d_desc),o=w(e),s=e.opt_len+3+7>>>3,i=e.static_len+3+7>>>3,s>=i&&(s=i)):s=i=n+5,s>=n+4&&-1!==t?C(e,t,n,r):e.strategy===B||i===s?(a(e,(M<<1)+(r?1:0),3),g(e,se,ie)):(a(e,(D<<1)+(r?1:0),3),k(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),g(e,e.dyn_ltree,e.dyn_dtree)),p(e),r&&h(e)}function A(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(oe[n]+V+1)]++,e.dyn_dtree[2*s(t)]++),e.last_lit===e.lit_bufsize-1}var N=e("../utils/common"),B=4,R=0,L=1,P=2,I=0,M=1,D=2,j=3,F=258,q=29,V=256,z=V+1+q,H=30,U=19,$=2*z+1,W=15,K=16,X=7,Q=256,J=16,G=17,Y=18,Z=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ee=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],te=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],ne=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],re=512,se=new Array(2*(z+2));r(se);var ie=new Array(2*H);r(ie);var ae=new Array(re);r(ae);var oe=new Array(F-j+1);r(oe);var ce=new Array(q);r(ce);var le=new Array(H);r(le);var ue,fe,de,pe=function(e,t,n,r,s){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=r,this.max_length=s,this.has_stree=e&&e.length},he=function(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t},me=!1;n._tr_init=T,n._tr_stored_block=C,n._tr_flush_block=O,n._tr_tally=A,n._tr_align=S},{"../utils/common":27}],39:[function(e,t,n){"use strict";function r(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}t.exports=r},{}]},{},[9])(9)}),function(){function e(e,t){for(var n=[];e;)n.push(t),--e;return n}function t(e,t){for(var n=0,r={};n<e.length;++n)r[e[n]]=t[n];return r}function n(e,t){var n=e.split(/%[ds]/);return n.length>t.length&&t.push(""),t.map(function(e,t){return n[t]+e}).join("")}function r(e,t){O.info(n(e,t))}function s(e,t){return-1!==e.indexOf(t,e.length-t.length)}function i(e){return Object.keys(e).map(function(e){return parseInt(e)})}function a(e,t){var n,r=[];if(Array.isArray(e))for(n=0;n<e.length;++n)n in e&&r.push([n,e[n]]);else for(n in e)r.push([n,e[n]]);return r.sort(t?function(e,t){return e[0]-t[0]}:function(e,t){return e[1]-t[1]||t[0]-e[0]}),r}function o(e){this.reset(),this.ixp=e,this.divs=this.mdur=this.ixm=0}function c(e,t){this.tijd=0,this.dur=e,this.fact=null,this.tup=[""],this.tupabc="",this.grace=this.beam=0,this.after=this.before="",this.ns=t?[t]:[],this.lyrs={},this.pos=0}function l(e){this.tijd=0,this.str=e,this.pos=0}function u(){}function f(e){this.maxtime=this.tijd=0,this.gMaten=[],this.gLyrics=[],this.vnums={},this.cnt=new u,this.vceCnt=1,this.lastnote=null,this.bpl=e.b,this.cpl=e.n,this.repbra=0,this.nvlt=e.v}function d(e,t,n,r){this.fnmext=e,this.outlist=[],this.infolist=[],this.title="T:Title",this.key="none",this.clefs={},this.mtr="none",this.tempo=0,this.pad=t,this.X=n+1,this.denL=r.d,this.volpan=r.m,this.cmpL=[],this.rightmargin=this.leftmargin=this.pagewidth=this.scale="",4==r.p.length&&(this.scale=""!=r.p[0]?parseFloat(r.p[0]):"",this.pagewidth=""!=r.p[1]?parseFloat(r.p[1]):"",this.leftmargin=""!=r.p[2]?parseFloat(r.p[2]):"",this.rightmargin=""!=r.p[3]?parseFloat(r.p[3]):"")}function p(e,t){if(!e.join(""))return["",0];for(var n=[],r=0;r<e.length;++r){var i=e[r];""==i?i=t?"_":"*":s(i,"_")&&!s(i,"\\_")?(i=i.replace("_",""),t=1):t=0,n.push(i)}return[n.join(" "),t]}function h(e,t){for(var n,r=e,s=t;t;)n=e%t,e=t,t=n;return[r/e,s/e]}function m(e,t,n){if(0==e.dur)return"";var s;return s=h(n*e.dur,4*t),t=s[0],n=s[1],e.fact&&(s=e.fact[0],e=e.fact[1],s=h(t*s,n*e),t=s[0],n=s[1]),n>64&&(s=h(Math.round(64*t/n)||1,64),r("denominator too small: %d/%d rounded to %d/%d",[t,n,s[0],s[1]]),t=s[0],n=s[1]),1==t?1==n?"":2==n?"/":"/"+n:1==n?""+t:t+"/"+n}function v(e){var t=e.match(/([_^]*)([A-Ga-g])([',]*)/);if(!t)return-1;
e=t[1];var n,r=t[2],t=t[3];return n=r.toUpperCase(),r=60+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(n)]+(n!=r?12:0),e&&(r+=("^"==e[0]?1:-1)*e.length),t&&(r+=("'"==t[0]?12:-12)*t.length),r}function _(e,t,n,r){var s;return s=0,0<=n.indexOf("stafflines=1")&&(s+=4),!r&&0<=n.indexOf("bass")&&(s+=12),s&&(n="CDEFGAB".split(""),s=n.indexOf(e)+s,e=n[s%7],t+=Math.floor(s/7)),t>4&&(e=e.toLowerCase()),t>5&&(e+=Array(t-5+1).join("'")),4>t&&(e+=Array(4-t+1).join(",")),e}function g(e,t,r){var s,i,a=0,o=t[e];i=o.tup.indexOf("start"),i>-1&&o.tup.splice(i,1);var c=e;for(r=[o.fact[0]/r[0],o.fact[1]/r[1]];e<t.length;){if(o=t[e],!(o instanceof l||o.grace)){if(-1<o.tup.indexOf("start")?(i=g(e,t,r),e=i[0],i=i[1],a+=i):o.fact&&(a+=1),i=o.tup.indexOf("stop"),i>-1){o.tup.splice(i,1);break}if(!o.fact){e=s;break}s=e}e+=1}return s=[r[0],r[1],a],s="3,2,3"==s.toString()?"(3":n("(%d:%d:%d",s),t[c].tupabc=s+t[c].tupabc,[e,a]}function y(e){e=e.filter(function(e){return e instanceof c});for(var t=0;t<e.length-1;){var n=e[t],r=e[t+1];!n.fact&&!r.fact&&0<n.dur&&r.beam&&(3*n.dur==r.dur?(r.dur=2*r.dur/3,n.dur*=2,n.after="<"+n.after,t+=1):3*r.dur==n.dur&&(n.dur=2*n.dur/3,r.dur*=2,n.after=">"+n.after,t+=1)),t+=1}}function b(e,t,n,r,i){for(r=0;r<e.length;)n=e[r],n instanceof c&&n.fact&&(n=g(r,e,[1,1]),r=n[0]),r+=1;r=[];for(var a,o=0;o<e.length;++o){if(n=e[o],n instanceof c){var l=m(n,t,i),u=1<n.ns.length;a=n.ns.filter(function(e){return s(e,"-")}),a=a.map(function(e){return e.slice(0,-1)});var f="";u&&a.length==n.ns.length&&(n.ns=a,f="-"),a=n.tupabc+n.before,u&&(a+="["),a+=n.ns.join(""),u&&(a+="]"+f),s(a,"-")&&(a=a.slice(0,-1),f="-"),a+=l+f,a+=n.after,n=n.beam}else a=n.str,n=1;n?r.push(a):r.push(" "+a)}return r.join("")}function x(e,t){e.map(function(e,t){e.pos=t}),e.sort(function(e,t){return e.tijd-t.tijd||e.pos-t.pos});for(var n=0,s=[],i=0;i<e.length;++i){var a=e[i];if(a.tijd>n&&s.push(new c(a.tijd-n,"x")),a instanceof l)a.tijd<n&&(a.tijd=n),s.push(a),n=a.tijd;else{if(a.tijd<n){if("z"==a.ns[0])continue;var o=s[s.length-1];if(!(o.tijd<=a.tijd)){r("overlapping notes in one voice! part %d, measure %d, note %s discarded",[t.ixp+1,t.ixm+1,a instanceof c?a.ns:a.str]);continue}if("z"==o.ns[0])o.dur=a.tijd-o.tijd,0==o.dur&&pop(s),r("overlap in part %d, measure %d: rest shortened",[t.ixp+1,t.ixm+1]);else{if(o.ns=o.ns.concat(a.ns),r("overlap in part %d, measure %d: added chord",[t.ixp+1,t.ixm+1]),a.dur=a.tijd+a.dur-n,0>=a.dur)continue;a.tijd=n}}s.push(a),n=a.tijd+a.dur}}return 0==n&&r("empty measure in part %d, measure %d, it should contain at least a rest to advance the time!",[t.ixp+1,t.ixm+1]),s}function w(e){function t(e){return e=n('<part-group number="%d" type="%s"></part-group>',[e,"stop"]),e=$.parseXML(e).firstChild,$(e)}var r,s,i,a,o,c,l;for(r=[],s=[],c=e.children(),o=0;o<c.length;o++)e=$(c[o]),"part-group"==e[0].nodeName?(i=e.attr("number"),a=e.attr("type"),l=s.indexOf(i),"start"==a?l>-1?(r.push(t(i)),r.push(e)):(r.push(e),s.push(i)):l>-1&&(s.splice(l,1),r.push(e))):r.push(e);for(o=s.length-1;o>=0;--o)i=s[o],r.push(t(i));return r}function k(e,t,n){var r,s,i,a;if(0==e.length)return[[],[]];if(r=e.shift(),"part-group"==r[0].nodeName){if(s=r.attr("number"),i=r.attr("type"),"start"==i){i=[];for(a in{"group-symbol":0,"group-barline":0,"group-name":0,"group-abbreviation":0})i.push(r.find(a).text()||"");return t[s]=i,n.push(s),a=k(e,t,n),e=a[0],r=a[1],a=k(r,t,n),t=a[0],n=a[1],[[e].concat(t),n]}return n=n.pop(),e.length&&"stop"==e[0].attr("type")&&s!=n&&(a=t[n],t[n]=t[s],t[s]=a),t=t[s],[[t],e]}return a=k(e,t,n),t=a[0],e=a[1],[[["name_tuple",r.find("part-name").text()||"",r.find("part-abbreviation").text()||""]].concat(t),e]}function E(e){var t,n,r,s;if(0==e.length)return[];for(t=[],r=0;r<e.length;++r){if(n=e[r],1==n.length)t.push(""+n[0]);else{for(t.push("("),s=0;s<n.length;++s)t.push(""+n[s]);t.push(")")}t.push("|")}return t.splice(-1,1),1<e.length&&(t=["{"].concat(t).concat(["}"])),t}function T(e,t,n,r,s,i){if("name_tuple"==e[0])r=r.shift(),t[0]&&(e[1]=t[0]+":"+e[1],e[2]=t[1]+":"+e[2]),s.push(e),i.push.apply(i,E(r));else if(2==e.length)r=r.shift(),n=["name_tuple","",""],n[1]=e[0][1]+":"+e[1][2],n[2]=e[0][2]+":"+e[1][3],s.push(n),i.push.apply(i,E(r));else{var a,o,c;for(c=e[e.length-1],t=c[0],a=c[1],o=c[2],c=c[3],a="yes"==a||n,i.push("brace"==t?"{":"["),n=0;n<e.length-1;++n)T(e[n],[o,c],a,r,s,i),a&&i.push("|");a&&i.splice(-1,1),i.push("brace"==t?"}":"]")}}function C(e){for(var t="",n=e.children(),r=0;r<n.length;++r){var s=n[r];switch(s.nodeName){case"elision":t+="~";break;case"text":t+=$(s).text().replace(/_/g,"\\_").replace(/-/g,"\\-").replace(/ /g,"~")}}return t?(n=e.find("syllabic").text(),("begin"==n||"middle"==n)&&(t+="-"),e.find("extend").length&&(t+="_"),t):t}function S(e){this.slurBuf={},this.wedge_type="",this.ingrace=0,this.msc=new f(e),this.unfold=e.u,this.ctf=e.c,this.gStfMap=[],this.midiMap=[],this.drumInst={},this.drumNotes={},this.instMid=[],this.midDflt=[-1,-1,-1,-91],this.msralts={},this.curalts={},this.stfMap={},this.clefMap={},this.curClef={},this.clefOct={},this.curStf={},this.nolbrk=e.x,this.doPageFmt=1==e.p.length,this.tstep=e.t}var O,A=Math.pow(2,53),N={"ornaments>trill-mark":"T","ornaments>mordent":"M","ornaments>inverted-mordent":"P","ornaments>turn":"!turn!","ornaments>inverted-turn":"!invertedturn!","ornaments>tremolo":"!///!","technical>up-bow":"u","technical>down-bow":"v","technical>harmonic":"!open!","technical>open-string":"!open!","technical>stopped":"!plus!","articulations>accent":"!>!","articulations>strong-accent":"!>!","articulations>staccato":".","articulations>staccatissimo":"!wedge!",fermata:"!fermata!",arpeggiate:"!arpeggio!","articulations>tenuto":"!tenuto!","articulations>staccatissimo":"!wedge!","articulations>spiccato":"!wedge!","articulations>breath-mark":"!breath!","articulations>detached-legato":"!tenuto!."},B={p:"!p!",pp:"!pp!",ppp:"!ppp!",f:"!f!",ff:"!ff!",fff:"!fff!",mp:"!mp!",mf:"!mf!",sfz:"!sfz!"};xml2abc_VERSION=62,o.prototype.reset=function(){this.lline=this.attr="",this.rline="|",this.lnum=""},u.prototype.inc=function(e,t){this.counters[e][t]=(this.counters[e][t]||0)+1},u.prototype.clear=function(n){n=Object.keys(n);var r=e(n.length,0);this.counters={note:t(n,r),nopr:t(n,r),nopt:t(n,r)}},u.prototype.getv=function(e,t){return this.counters[e][t]},u.prototype.prcnt=function(e){for(var t in this.counters.note)0!=this.getv("nopr",t)&&r("part %d, voice %d has %d skipped non printable notes",[e,t,this.getv("nopr",t)]),0!=this.getv("nopt",t)&&r("part %d, voice %d has %d notes without pitch",[e,t,this.getv("nopt",t)]),0==this.getv("note",t)&&r("part %d, skipped empty voice %d",[e,t])},f.prototype.initVoices=function(e){this.vtimes={},this.voices={},this.lyrics={};for(var t in this.vnums)this.vtimes[t]=0,this.voices[t]=[],this.lyrics[t]=[];e&&this.cnt.clear(this.vnums)},f.prototype.incTime=function(e){this.tijd+=e,this.tijd>this.maxtime&&(this.maxtime=this.tijd)},f.prototype.appendElemCv=function(e,t){for(var n in e)this.appendElem(n,t)},f.prototype.insertElem=function(e,t){var n=new l(t);n.tijd=0,this.voices[e].unshift(n)},f.prototype.appendObj=function(e,t,n){t.tijd=this.tijd,this.voices[e].push(t),this.incTime(n),this.tijd>this.vtimes[e]&&(this.vtimes[e]=this.tijd)},f.prototype.appendElem=function(e,t){this.appendObj(e,new l(t),0)},f.prototype.appendNote=function(e,t,n){t.ns.push(n),this.appendObj(e,t,parseInt(t.dur)),"z"!=n&&(this.lastnote=t,this.cnt.inc("note",e),t.grace||this.lyrics[e].push(t.lyrs))},f.prototype.getLastRec=function(e){return this.gMaten.length?(e=this.gMaten[this.gMaten.length-1][e],e[e.length-1]):null},f.prototype.getLastMelis=function(e,t){if(this.gLyrics.length){var n=this.gLyrics[this.gLyrics.length-1][e];if(t in n)return n[t][1]}return 0},f.prototype.addChord=function(e){this.lastnote.ns.push(e)},f.prototype.addBar=function(e,t){t.mdur&&this.maxtime>t.mdur&&r("measure %d in part %d longer than metre",[t.ixm+1,t.ixp+1]),this.tijd=this.maxtime;for(var n in this.vnums){if(t.lline||t.lnum){var s=this.getLastRec(n);if(s){var a=s.str;t.lline&&(a=(a+t.lline).replace(/:\|:/g,"::").replace(/\|\|/g,"|")),3==this.nvlt?t.ixp+parseInt(n)==Math.min.apply(null,i(this.vnums))&&(a+=t.lnum):4==this.nvlt?parseInt(n)==Math.min.apply(null,i(this.vnums))&&(a+=t.lnum):t.lnum&&(a+=t.lnum,this.repbra=1),s.str=a}else t.lline&&this.insertElem(n,"|:")}e&&(s=this.getLastRec(n))&&(s.str+=e),t.attr&&this.insertElem(n,""+t.attr),this.appendElem(n," "+t.rline),this.voices[n]=x(this.voices[n],t);for(var s=this.lyrics[n],a={},o=s.reduce(function(e,t){return e.concat(i(t))},[]),c=Math.max.apply(null,o.concat([0]));c>0;--c){var o=s.map(function(e){return e[c]||""}),l=this.getLastMelis(n,c);a[c]=p(o,l)}this.lyrics[n]=a,y(this.voices[n])}this.gMaten.push(this.voices),this.gLyrics.push(this.lyrics),this.tijd=this.maxtime=0,this.initVoices()},f.prototype.outVoices=function(t,n){var r,s,o,u,f,d,p,h,v;f={},p=Math.min.apply(null,i(this.vnums));for(h in this.vnums)if(0!=this.cnt.getv("note",h)){if(O.denL)d=O.denL;else{var _=h,g=this.gMaten;d=t,v=0,u=A,s=r=void 0;for(var y=[4,8,16];y.length;){var x=y.shift(),w=0;for(r=0;r<g.length;++r){var k=g[r][_];for(s=0;s<k.length;++s){var E=k[s];E instanceof l||0==E.dur||(w+=m(E,d,x).length)}}u>w&&(v=x,u=w)}d=v}for(O.cmpL.push(d),_=[],g={},v=0;v<this.gMaten.length;++v){if(u=this.gMaten[v][h],_.push(b(u,t,v,n,d)),s=this.gLyrics,0!=v)for(y in u=this.gMaten[v][h],r=s[v][h],s=s[v-1][h],x=x=y=void 0,s)if(x=s[y][1],!(y in r)&&x){for(x=u,w=[],k=0;k<x.length;++k)if(E=x[k],E instanceof c&&!E.grace){if("z"==E.ns[0])break;w.push("_")}(x=w.join(" "))&&(r[y]=[x,0])}r=this.gLyrics[v][h];for(o in r)if(u=r[o],u=u[0],o in g){for(;g[o].length<v;)g[o].push("");g[o].push(u)}else g[o]=e(v,"").concat([u])}for(o in g)u=g[o],d=_.length-u.length,g[o]=u.concat(e(d,""));for(O.add("V:"+this.vceCnt),this.repbra&&(1==this.nvlt&&1<this.vceCnt&&O.add("I:repbra 0"),2==this.nvlt&&parseInt(h)>p&&O.add("I:repbra 0")),0<this.cpl?this.bpl=0:0==this.bpl&&(this.cpl=100),d=0;_.length;){for(v=1,u=_[0];v<_.length&&!(0<this.cpl&&u.length+_[v].length>=this.cpl)&&!(0<this.bpl&&v>=this.bpl);)u+=_[v],v+=1;for(d+=v,O.add(u+" %"+d),_.splice(0,v),r=a(g,1),s=0;s<r.length;++s)u=r[s],o=u[0],u=u[1],O.add("w: "+u.slice(0,v).join("|")+"|"),u.splice(0,v)}f[h]=this.vceCnt,this.vceCnt+=1}return this.gMaten=[],this.gLyrics=[],this.cnt.prcnt(n+1),f},d.prototype.add=function(e){this.outlist.push(e+"\n")},d.prototype.info=function(e,t){this.infolist.push(("undefined"==typeof t||t?"-- ":"")+e)},d.prototype.mkHeader=function(e,t,s){var i,o,c,l,u,f,d=[],p=[];for(l=e.slice(),f=0;f<t.length;++f){i=t[f];try{T(i,["",""],"",e,d,p)}catch(h){r("lousy musicxml: error in part-list",[])}}for(t=p.join(" "),e={},f=0;f<l.length;++f)o=l[f],i=d[f],c=i[1],i=i[2],0!=o.length&&(o=o[0][0],c=c.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),i=i.replace(/\n/g,"\\n").replace(/\.:/g,".").replace(/^:|:$/g,""),e[o]=(c?'nm="'+c+'"':"")+(i?' snm="'+i+'"':""));for(d=[n("X:%d\n%s\n",[this.X,this.title])],""!==this.scale&&d.push("%%scale "+this.scale+"\n"),""!==this.pagewidth&&d.push("%%pagewidth "+this.pagewidth+"cm\n"),""!==this.leftmargin&&d.push("%%leftmargin "+this.leftmargin+"cm\n"),""!==this.rightmargin&&d.push("%%rightmargin "+this.rightmargin+"cm\n"),t&&1<p.length&&d.push("%%score "+t+"\n"),l=this.tempo?"Q:1/4="+this.tempo+"\n":"",p=[],f=0;f<this.cmpL.length;++f)i=this.cmpL[f],p[i]=(p[i]||0)+1;p=a(p),p=p[p.length-1][0],p=this.denL?this.denL:p,d.push(n("L:1/%d\n%sM:%s\n",[p,l,this.mtr])),d.push(n("I:linebreak $\nK:%s\n",[this.key]));for(u in this.clefs){for(i=s[u-1],f=i[0],t=i[1],c=i[1],o=i[3],l=i.slice(4),i=this.clefs[u],l.length&&0>i.indexOf("perc")&&(i=(i+" map=perc").trim()),d.push(n("V:%d %s %s\n",[u,i,e[u]||""])),1<this.volpan?(f>0&&f!=u&&d.push("%%MIDI channel "+f+"\n"),t>0&&d.push("%%MIDI program "+(t-1)+"\n"),c>=0&&d.push("%%MIDI control 7 "+c+"\n"),o>=0&&d.push("%%MIDI control 10 "+o+"\n")):0<this.volpan&&(l.length&&f>0&&d.push("%%MIDI channel "+f+"\n"),t>0&&d.push("%%MIDI program "+(t-1)+"\n")),f=0;f<l.length;++f)i=l[f].nt,c=l[f].step,t=l[f].midi,(o=l[f].nhd)||(o="normal"),(v(i)!=t||i!=c)&&(0<this.volpan&&d.push("%%MIDI drummap "+i+" "+t+"\n"),d.push("I:percmap "+i+" "+c+" "+t+" "+o+"\n"));p!=this.cmpL[u-1]&&d.push("L:1/"+this.cmpL[u-1]+"\n")}this.outlist=d.concat(this.outlist)},S.prototype.matchSlur=function(e,t,n,s,i,a){if(-1!=["start","stop"].indexOf(e))if(t||(t="1"),t in this.slurBuf){var o=this.slurBuf[t],c=o[0],l=o[1],u=o[2],o=o[3];e!=c?(n!=l||"start"!=c||o&&a||(u.before="("+u.before,s.after+=")"),delete this.slurBuf[t]):(r("double slur numbers %s-%s in part %d, measure %d, voice %d note %s, first discarded",[e,t,this.msr.ixp+1,this.msr.ixm+1,n,s.ns]),this.slurBuf[t]=[e,n,s,i])}else this.slurBuf[t]=[e,n,s,i]},S.prototype.doNotations=function(e,t){for(var n=Object.keys(N).sort(),r=0;r<n.length;++r){var s=n[r],i=N[s];t.find(s).length&&(e.before+=i)}if(n=t.find("technical>fingering"),n.length&&(e.before+="!"+n.text()+"!"),n=t.find("ornaments>wavy-line"),n.length)switch(n.attr("type")){case"start":e.before="!trill(!"+e.before;break;case"stop":e.after+="!trill)!"}},S.prototype.ntAbc=function(e,t,n,s){var i={"double-flat":-2,"flat-flat":-2,flat:-1,natural:0,sharp:1,"sharp-sharp":2,"double-sharp":2};t+=this.clefOct[this.curStf[s]]||0;var a=e;t>4&&(a=e.toLowerCase()),t>5&&(a+=Array(t-5+1).join("'")),4>t&&(a+=Array(4-t+1).join(",")),t=n.find("accidental").text();var o=n.find("pitch>alter").text();!o&&this.msralts[e]&&(o=0);var c=a+"#"+s;if(""===t&&""===o)return a;if(""!=t)o=i[t];else{if(o=parseInt(o),c in this.curalts){if(o==this.curalts[c])return a}else if(o==(this.msralts[e]||0))return a;if(n.find("tie").map(function(){return $(this).attr("type")}).get().some(function(e){return"stop"==e}))return a;r("accidental %d added in part %d, measure %d, voice %d note %s",[o,this.msr.ixp+1,this.msr.ixm+1,s+1,a])}return this.curalts[c]=o,a=["__","_","=","^","^^"][o+2]+a},S.prototype.doNote=function(e){var t=new c(0,null),n=parseInt(e.find("voice").text()||"1");this.isSib&&(n+=100*(e.find("staff").text()||1));var r=0<e.find("chord").length,s=e.find("pitch>step").text()||e.find("unpitched>display-step").text(),i=e.find("pitch>octave").text()||e.find("unpitched>display-octave").text(),a=0<e.find("rest").length,o=e.find("time-modification>actual-notes").text();if(o){var l=e.find("time-modification>normal-notes").text();t.fact=[parseInt(o),parseInt(l)]}if(t.tup=e.find("notations>tuplet").map(function(){return $(this).attr("type")}).get(),l=e.find("duration").text(),o=e.find("grace"),t.grace=0<o.length,t.before="",t.after="",t.grace&&!this.ingrace&&(this.ingrace=1,t.before="{","yes"==o.attr("slash")&&(t.before+="/")),(o=!t.grace&&this.ingrace)&&(this.ingrace=0,this.msc.lastnote.after+="}"),a||"no"!=e.attr("print-object")){if((!l||t.grace)&&(l=0),t.dur=parseInt(l),a||s&&i||(this.msc.cnt.inc("nopt",n),i=5,s="E"),l=e.find("notations"),l.length&&this.doNotations(t,l),a=a?"z":this.ntAbc(s,parseInt(i),e,n),e.find("unpitched").length){var l=this.curClef[this.curStf[n]],s=_(s,parseInt(i),l,this.tstep),i=e.find("instrument"),i=i.length?i.attr("id"):"dummyId",i=this.drumInst[i]||v(a),l=e.find("notehead"),u=l.text().replace(" ","-");"yes"==l.attr("filled")&&(u+="+"),"x"==u&&(a="^"+a.replace(/\^/g,"").replace(/_/g,"")),("circle-x"==u||"diamond"==u)&&(a="_"+a.replace(/\^/g,"").replace(/_/g,"")),this.drumNotes[n+";"+a]=[s,i,u]}for(s=e.find("tie").map(function(){return $(this).attr("type")}).get(),-1<s.indexOf("start")&&(a+="-"),s=e.find("beam").map(function(){return $(this).text()}).get(),t.beam=-1<s.indexOf("continue")||-1<s.indexOf("end")||t.grace,s=e.find("lyric"),i=l=0;i<s.length;++i){var u=$(s[i]),f=parseInt((u.attr("number")||"1").replace(/^.*verse/,""));0==f?f=l+1:l=f,t.lyrs[f]=C(u)}for(r?this.msc.addChord(a):(r=parseInt(e.find("staff").text()||"1"),this.curStf[n]!=r&&(s=r-this.curStf[n],this.curStf[n]=r,this.msc.appendElem(n,"[I:staff "+(s>0?"+":"")+s+"]")),this.msc.appendNote(n,t,a)),s=e.find("notations>slur"),i=0;i<s.length;++i)e=$(s[i]),this.matchSlur(e.attr("type"),e.attr("number"),n,this.msc.lastnote,t.grace,o)}else this.msc.cnt.inc("nopr",n)},S.prototype.doAttr=function(n){var r,s,i,a,o,c,l,u,f,d,p,h;for(r={C1:"alto1",C2:"alto2",C3:"alto",C4:"tenor",F4:"bass",F3:"bass3",G2:"treble",TAB:"",percussion:"perc"},(s=n.find("divisions").text())&&(this.msr.divs=parseInt(s)),s=parseInt(n.find("transpose>chromatic").text()||"0"),i=n.find("key>fifths").first().text(),a=0==this.msc.tijd&&0==this.msr.ixm,i&&(o=parseInt(i),c=n.find("key>mode").first().text()||"major",f="FCGDAEB".split(""),u="Cb Gb Db Ab Eb Bb F C G D A E B F# C#".split(" "),l="Ab Eb Bb F C G D A E B F# C# G# D# A#".split(" "),i="","major"==c&&(i=u[7+o]),"minor"==c&&(i=l[7+o]+"min"),o=o>=0?t(f.slice(0,o),e(o,1)):t(f.slice(o),e(-o,-1)),o=[i,o],i=o[0],this.msralts=o[1],a&&!s&&"none"==O.key?O.key=i:i==O.key&&a||(this.msr.attr+="[K:"+i+"]")),(i=n.find("time>beats").text())&&(o=n.find("time>beat-type").text(),c=i+"/"+o,a?O.mtr=c:this.msr.attr+="[M:"+c+"]",this.msr.mdur=this.msr.divs*parseInt(i)*4/parseInt(o)),(i=n.find("transpose>octave-change").text()||"")&&(s+=12*parseInt(i)),c=n.find("clef"),o=0;o<c.length;o++)if(l=$(c[o]),i=parseInt(l.attr("number")||"1"),u=l.find("sign").text(),f="percussion"!=u?l.find("line").text()||"":"",f=r[u+f]||"",u=l.find("clef-octave-change").text()||"0",f+={"-2":"-15","-1":"-8",1:"+8",2:"+15"}[u]||"",this.clefOct[i]=-parseInt(u),s&&(f+=" transpose="+s),(u=n.find("staff-details>staff-lines").text())&&(f+=" stafflines="+u),this.curClef[i]=f,a)this.clefMap[i]=f;else for(l=this.stfMap[i],h=0;h<l.length;++h)d=l[h],i!=this.curStf[d]&&(p=i-this.curStf[d],this.curStf[d]=i,u=p>0?"+":"",this.msc.appendElem(d,"[I:staff "+u+p+"]")),this.msc.appendElem(d,"[K:"+f+"]")},S.prototype.doDirection=function(e){var t,n,r,s,i,a,o,c,l;if(r=parseInt(e.find("staff").first().text()||"1"),r=this.stfMap[r][0],t=e.attr("placement"),n=e.find("sound"),n.length){if(a=n.find("midi-instrument")){o=n.find("midi-instrument>midi-program").text(),c=n.find("midi-instrument>midi-channel").text();for(l in this.vceInst)this.vceInst[l]==a.attr("id")&&(r=l);(l=(o?o-1:c)+"")&&0<O.volpan&&this.msc.appendElem(r,"[I:MIDI= "+(o?"program":"channel")+" "+l+"]")}(n=n.attr("tempo"))&&(n=-1<n.indexOf(".")?parseFloat(n).toFixed(2):parseInt(n),0==this.msc.tijd&&0==this.msr.ixm?O.tempo=n:this.msc.appendElem(r,"[Q:1/4="+n+"]"))}if(e=e.children("direction-type"),e.length){if(n=e.find("wedge"),n.length){switch(n.attr("type")){case"crescendo":s="!<(!",this.wedge_type="<";break;case"diminuendo":s="!>(!",this.wedge_type=">";break;case"stop":s="<"==this.wedge_type?"!<)!":"!>)!";break;default:raise("wrong wedge type")}this.msc.appendElem(r,s)}s=e.find("words").eq(0),s.length&&(t="below"==t?"_":"^",0>parseFloat(s.attr("default-y")||"0")&&(t="_"),(s=s.text().replace(/"/g,'\\"').replace(/\n/g," ").trim())&&this.msc.appendElem(r,'"'+t+s+'"'));for(i in B)t=B[i],e.find("dynamics>"+i).length&&this.msc.appendElem(r,t);e.find("coda").length&&this.msc.appendElem(r,"O"),e.find("segno").length&&this.msc.appendElem(r,"S")}},S.prototype.doHarmony=function(e){var t,n,r,s,i,a,o,c,l;t=parseInt(e.children("staff").text()||"1"),t=this.stfMap[t][0],n={major:"",minor:"m",augmented:"+",diminished:"dim",dominant:"7","half-diminished":"m7b5"},r={major:"maj",dominant:"",minor:"m",diminished:"dim",augmented:"+",suspended:"sus"},s={second:"2",fourth:"4",seventh:"7",sixth:"6",ninth:"9","11th":"11","13th":"13"},i={1:"#",0:"","-1":"b"},a=e.find("root>root-step","").text(),o=i[e.find("root>root-alter").text()]||"",c="",l=e.find("kind").text(),l in n?l=n[l]:-1<l.indexOf("-")?(n=l.split("-"),l=n[0],n=n[1],l=(r[l]||"")+(s[n]||""),0==l.indexOf("sus")&&(c=l,l="")):"none"==l&&(l=e.find("kind").attr("text")),r=e.find("degree");for(s=0;s<r.length;++s)n=$(r[s]),l+=(i[n.find("degree-alter").text()]||"")+n.find("degree-value").text();l=l.replace("79","9").replace("713","13").replace("maj6","6"),e=e.find("bass>bass-step").text()+(i[e.find("bass>bass-alter").text()]||""),this.msc.appendElem(t,'"'+a+o+l+c+(e&&"/"+e)+'"')},S.prototype.doBarline=function(e){var t=e.find("repeat"),n=0;return t.length&&(n=t.attr("direction")),this.unfold?n?"forward"==n?1:2:0:("right"==e.attr("location")&&(t=e.find("bar-style").text(),"light-light"==t?this.msr.rline="||":"light-heavy"==t&&(this.msr.rline="|]")),n&&("forward"==n?this.msr.lline=":":this.msr.rline=":|"),e=e.find("ending"),e.length&&("start"==e.attr("type")?(e=(e.attr("number")||"1").replace(/\./g,"").replace(/ /g,""),/^[\d,]+$/.test(e)||(e='"'+e.trim()+'"'),this.msr.lnum=e):"|"==this.msr.rline&&(this.msr.rline="||")),0)},S.prototype.doPrint=function(e){return"yes"==e.attr("new-system")||"yes"==e.attr("new-page")?this.nolbrk?"":"$":void 0},S.prototype.doPartList=function(e){var t,n,r,s,i,a,o,c,l,u;for(s=e.find("part-list>score-part"),t=0;t<s.length;++t){for(n=s[t],i={},a=$(n).find("midi-instrument"),n=0;n<a.length;++n){for(o=$(a[n]),l=["midi-channel","midi-program","volume","pan"],c=[],r=0;r<l.length;++r)u=l[r],c.push(o.find(u).text()||this.midDflt[r]);r=c[3],r>=-90&&90>=r&&(r=(r+90)/180*127),i[o.attr("id")]=[parseInt(c[0]),parseInt(c[1]),parseFloat(c[2]),r],(c=o.find("midi-unpitched").text())&&(this.drumInst[o.attr("id")]=c-1)}this.instMid.push(i)}return e=e.find("part-list"),c=w(e),k(c,{},[])[0]},S.prototype.mkTitle=function(e){var t,n,s,i,a,o,c,l=[],u=[],f=[];for(t=e.find("work>work-title").text().trim(),n=e.find("movement-title").text().trim(),s=e.find("identification>creator"),i=0;i<s.length;++i)a=$(s[i]),o=a.text(),a=a.attr("type"),o&&(o=o.split("\n").map(function(e){return e.trim()}),"composer"==a?l.push.apply(l,o):"lyricist"!=a&&"transcriber"!=a||u.push.apply(u,o));for(s=e.find("identification>rights"),i=0;i<s.length;++i)o=$(s[i]).text(),o=o.split("\n").map(function(e){return e.trim()}),u.push.apply(u,o);for(s=e.find("credit"),i=0;i<s.length;++i){for(o="",a=$(s[i]).find("credit-words"),c=0;c<a.length;++c)o+=$(a[c]).text();f.push(o.replace(/\s*[\r\n]\s*/g," "))}f=function(e){function r(e){return e&&-1<s.indexOf(e)}var s,i,a=[];for(i=0;i<f.length;++i)s=f[i],6>e&&(s&&-1<t.indexOf(s)||s&&-1<n.indexOf(s))||5>e&&(s&&-1<l.indexOf(s)||s&&-1<u.indexOf(s))||4>e&&(t&&-1<s.indexOf(t)||n&&-1<s.indexOf(n))||3>e&&(l.some(r)||u.some(r))||2>e&&/^[\d\W]*$/.test(s)||a.push(s);return 0==e&&t+n&&(a=""),a}(this.ctf),t&&(t="T:"+t.replace(/\n/g,"\nT:")+"\n"),n&&(t+="T:"+n.replace(/\n/g,"\nT:")+"\n"),f.length&&(t+=f.map(function(e){return"T:"+e}).join("\n")+"\n"),l.length&&(t+=l.map(function(e){return"C:"+e}).join("\n")+"\n"),u.length&&(t+=u.map(function(e){return"Z:"+e}).join("\n")+"\n"),t&&(O.title=t.substr(0,t.length-1)),(this.isSib=0<=e.find("identification>encoding>software").text().indexOf("Sibelius"))&&r("Sibelius MusicXMl is unreliable",[])},S.prototype.doDefaults=function(e){var t,n,r,s;this.doPageFmt&&(t=e.find("defaults"),t.length&&(e=t.find("scaling>millimeters").text(),n=t.find("scaling>tenths").text(),n=e/n/10,e=t.find("page-layout>page-width").text()*n,r=t.find("page-layout>page-margins").first(),t=r.find("left-margin").text(),r=r.find("right-margin").text(),s=10*n/.2117,!O.scale&&s&&(O.scale=s.toFixed(2)),!O.pagewidth&&e&&(O.pagewidth=e.toFixed(2)),O.leftmargin||""==t||(O.leftmargin=(t*n).toFixed(2)),O.rightmargin||""==r||(O.rightmargin=(r*n).toFixed(2))))},S.prototype.locStaffMap=function(e){var t={};this.vceInst={},this.msc.vnums={},e=e.find("measure>note");for(var n=0;n<e.length;n++){var r=$(e[n]),s=parseInt(r.find("voice").text()||"1");this.isSib&&(s+=100*(r.find("staff").text()||1)),this.msc.vnums[s]=1;var i=parseInt(r.find("staff").text()||"1");if(s in t){var a=t[s];a[i]=(a[i]||0)+1}else a={},a[i]=1,t[s]=a;a=r.find("instrument"),a.length&&(this.vceInst[s]=$(a).attr("id"))}this.stfMap={},this.clefMap={};for(s in t){e=[],n=t[s];for(i in n)e.push([n[i],i]);e.sort(function(e,t){return t[0]-e[0]}),e=e[0][1],this.stfMap[e]=(this.stfMap[e]||[]).concat([s]),this.curStf[s]=e}},S.prototype.addStaffMap=function(e){var t,n,r,s,i,a,o=[],c=Object.keys(this.stfMap).sort();for(n=0;n<c.length;++n){for(i=c[n],s=this.stfMap[i],a=[],t=0;t<s.length;++t)r=s[t],r in e&&a.push(e[r]);if(a.length)for((o.push(a.sort()),s=i in this.clefMap?this.clefMap[i]:"treble",t=0);t<a.length;++t)r=a[t],O.clefs[r]=s}this.gStfMap.push(o)},S.prototype.addMidiMap=function(e,t){var n,r=this.instMid[e],s=Object.keys(r);n=s.length?r[s[0]]:this.midDflt;var i,a,o,c=[],l=this;for(i in t)s=Object.keys(this.drumNotes).sort().filter(function(e){return e.split(";")[0]==i}),o=s.map(function(e){return{nt:e.split(";")[1],step:l.drumNotes[e][0],midi:l.drumNotes[e][1],nhd:l.drumNotes[e][2]}}),s=t[i],a=this.vceInst[i]||"",a in r?c.push([s,r[a].concat(o)]):c.push([s,n.concat(o)]);for(c.sort(function(e,t){return e[0]-t[0]}),r=0;r<c.length;++r)s=c[r][0],n=c[r][1],this.midiMap.push(n)},S.prototype.parse=function(e){var t=$(e);this.mkTitle(t),this.doDefaults(t),partlist=this.doPartList(t),e=t.find("part");for(var n=0;n<e.length;++n){var t=$(e[n]),s=t.find("measure");this.locStaffMap(t),this.drumNotes={},this.clefOct={},this.msc.initVoices(1);var i=0,a=0;for(this.msr=new o(n);this.msr.ixm<s.length;){var c=$(s[this.msr.ixm]),l=0,u="";this.msr.reset(),this.curalts={};for(var f=c.children(),d=0;d<f.length;d++){var p=f[d],t=$(p);switch(p.nodeName){case"note":this.doNote(t);break;case"attributes":this.doAttr(t);break;case"direction":this.doDirection(t);break;case"sound":this.doDirection(c);break;case"harmony":this.doHarmony(t);break;case"barline":l=this.doBarline(t);break;case"backup":t=parseInt(t.find("duration").text()),this.msc.incTime(-t);break;case"forward":t=parseInt(t.find("duration").text()),this.msc.incTime(t);break;case"print":u=this.doPrint(t)}}this.msc.addBar(u,this.msr),1==l?(a=this.msr.ixm,this.msr.ixm+=1):2==l?1>i?(this.msr.ixm=a,i+=1):(i=0,this.msr.ixm+=1):this.msr.ixm+=1}s=this.msc.outVoices(this.msr.divs,n),this.addStaffMap(s),this.addMidiMap(n,s)}Object.keys(s).length?O.mkHeader(this.gStfMap,partlist,this.midiMap):r("nothing written, %s has no notes ...",[O.fnmext])},vertaal=function(e,t){var n,s={u:0,b:0,n:0,c:0,v:0,d:0,m:0,x:0,t:0,p:"f"};for(n in t)s[n]=t[n];s.p=s.p?s.p.split(","):[],O=new d(".abc","",0,s),s=new S(s);try{s.parse(e)}catch(i){r("** exception occurred: %s",[i])}return[O.outlist.join(""),O.infolist.join("\n")]}}(),!function(e){"use strict";function t(e,t){var n=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(n>>16);return r<<16|65535&n}function n(e,t){return e<<t|e>>>32-t}function r(e,r,s,i,a,o){return t(n(t(t(r,e),t(i,o)),a),s)}function s(e,t,n,s,i,a,o){return r(t&n|~t&s,e,t,i,a,o)}function i(e,t,n,s,i,a,o){return r(t&s|n&~s,e,t,i,a,o)}function a(e,t,n,s,i,a,o){return r(t^n^s,e,t,i,a,o)}function o(e,t,n,s,i,a,o){return r(n^(t|~s),e,t,i,a,o)}function c(e,n){e[n>>5]|=128<<n%32,e[(n+64>>>9<<4)+14]=n;var r,c,l,u,f,d=1732584193,p=-271733879,h=-1732584194,m=271733878;for(r=0;r<e.length;r+=16)c=d,l=p,u=h,f=m,d=s(d,p,h,m,e[r],7,-680876936),m=s(m,d,p,h,e[r+1],12,-389564586),h=s(h,m,d,p,e[r+2],17,606105819),p=s(p,h,m,d,e[r+3],22,-1044525330),d=s(d,p,h,m,e[r+4],7,-176418897),m=s(m,d,p,h,e[r+5],12,1200080426),h=s(h,m,d,p,e[r+6],17,-1473231341),p=s(p,h,m,d,e[r+7],22,-45705983),d=s(d,p,h,m,e[r+8],7,1770035416),m=s(m,d,p,h,e[r+9],12,-1958414417),h=s(h,m,d,p,e[r+10],17,-42063),p=s(p,h,m,d,e[r+11],22,-1990404162),d=s(d,p,h,m,e[r+12],7,1804603682),m=s(m,d,p,h,e[r+13],12,-40341101),h=s(h,m,d,p,e[r+14],17,-1502002290),p=s(p,h,m,d,e[r+15],22,1236535329),d=i(d,p,h,m,e[r+1],5,-165796510),m=i(m,d,p,h,e[r+6],9,-1069501632),h=i(h,m,d,p,e[r+11],14,643717713),p=i(p,h,m,d,e[r],20,-373897302),d=i(d,p,h,m,e[r+5],5,-701558691),m=i(m,d,p,h,e[r+10],9,38016083),h=i(h,m,d,p,e[r+15],14,-660478335),p=i(p,h,m,d,e[r+4],20,-405537848),d=i(d,p,h,m,e[r+9],5,568446438),m=i(m,d,p,h,e[r+14],9,-1019803690),h=i(h,m,d,p,e[r+3],14,-187363961),p=i(p,h,m,d,e[r+8],20,1163531501),d=i(d,p,h,m,e[r+13],5,-1444681467),m=i(m,d,p,h,e[r+2],9,-51403784),h=i(h,m,d,p,e[r+7],14,1735328473),p=i(p,h,m,d,e[r+12],20,-1926607734),d=a(d,p,h,m,e[r+5],4,-378558),m=a(m,d,p,h,e[r+8],11,-2022574463),h=a(h,m,d,p,e[r+11],16,1839030562),p=a(p,h,m,d,e[r+14],23,-35309556),d=a(d,p,h,m,e[r+1],4,-1530992060),m=a(m,d,p,h,e[r+4],11,1272893353),h=a(h,m,d,p,e[r+7],16,-155497632),p=a(p,h,m,d,e[r+10],23,-1094730640),d=a(d,p,h,m,e[r+13],4,681279174),m=a(m,d,p,h,e[r],11,-358537222),h=a(h,m,d,p,e[r+3],16,-722521979),p=a(p,h,m,d,e[r+6],23,76029189),d=a(d,p,h,m,e[r+9],4,-640364487),m=a(m,d,p,h,e[r+12],11,-421815835),h=a(h,m,d,p,e[r+15],16,530742520),p=a(p,h,m,d,e[r+2],23,-995338651),d=o(d,p,h,m,e[r],6,-198630844),m=o(m,d,p,h,e[r+7],10,1126891415),h=o(h,m,d,p,e[r+14],15,-1416354905),p=o(p,h,m,d,e[r+5],21,-57434055),d=o(d,p,h,m,e[r+12],6,1700485571),m=o(m,d,p,h,e[r+3],10,-1894986606),h=o(h,m,d,p,e[r+10],15,-1051523),p=o(p,h,m,d,e[r+1],21,-2054922799),d=o(d,p,h,m,e[r+8],6,1873313359),m=o(m,d,p,h,e[r+15],10,-30611744),h=o(h,m,d,p,e[r+6],15,-1560198380),p=o(p,h,m,d,e[r+13],21,1309151649),d=o(d,p,h,m,e[r+4],6,-145523070),m=o(m,d,p,h,e[r+11],10,-1120210379),h=o(h,m,d,p,e[r+2],15,718787259),p=o(p,h,m,d,e[r+9],21,-343485551),d=t(d,c),p=t(p,l),h=t(h,u),m=t(m,f);return[d,p,h,m]}function l(e){var t,n="";for(t=0;t<32*e.length;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function u(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;for(t=0;t<8*e.length;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function f(e){return l(c(u(e),8*e.length))}function d(e,t){var n,r,s=u(e),i=[],a=[];for(i[15]=a[15]=void 0,s.length>16&&(s=c(s,8*e.length)),n=0;16>n;n+=1)i[n]=909522486^s[n],a[n]=1549556828^s[n];return r=c(i.concat(u(t)),512+8*t.length),l(c(a.concat(r),640))}function p(e){var t,n,r="0123456789abcdef",s="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),s+=r.charAt(t>>>4&15)+r.charAt(15&t);return s}function h(e){return unescape(encodeURIComponent(e))}function m(e){return f(h(e))}function v(e){return p(m(e))}function _(e,t){return d(h(e),h(t))}function g(e,t){return p(_(e,t))}function y(e,t,n){return t?n?_(t,e):g(t,e):n?m(e):v(e)}"function"==typeof define&&define.amd?define(function(){return y}):"object"==typeof module&&module.exports?module.exports=y:e.md5=y}(this),!function(e){function t(){var e=arguments[0],n=t.cache;return n[e]&&n.hasOwnProperty(e)||(n[e]=t.parse(e)),t.format.call(null,n[e],arguments)}function n(e){return"number"==typeof e?"number":"string"==typeof e?"string":Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function r(e,t){return t>=0&&7>=t&&a[e]?a[e][t]:Array(t+1).join(e)}var s={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/bcdiefguxX/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};t.format=function(e,i){var a,o,c,l,u,f,d,p=1,h=e.length,m="",v=[],_=!0,g="";for(o=0;h>o;o++)if(m=n(e[o]),"string"===m)v[v.length]=e[o];else if("array"===m){if(l=e[o],l[2])for(a=i[p],c=0;c<l[2].length;c++){if(!a.hasOwnProperty(l[2][c]))throw new Error(t('[sprintf] property "%s" does not exist',l[2][c]));a=a[l[2][c]]}else a=l[1]?i[l[1]]:i[p++];if(s.not_type.test(l[8])&&s.not_primitive.test(l[8])&&"function"==n(a)&&(a=a()),s.numeric_arg.test(l[8])&&"number"!=n(a)&&isNaN(a))throw new TypeError(t("[sprintf] expecting number but found %s",n(a)));switch(s.number.test(l[8])&&(_=a>=0),l[8]){case"b":a=parseInt(a,10).toString(2);break;case"c":a=String.fromCharCode(parseInt(a,10));break;case"d":case"i":a=parseInt(a,10);break;case"j":a=JSON.stringify(a,null,l[6]?parseInt(l[6]):0);break;case"e":a=l[7]?parseFloat(a).toExponential(l[7]):parseFloat(a).toExponential();break;case"f":a=l[7]?parseFloat(a).toFixed(l[7]):parseFloat(a);break;case"g":a=l[7]?parseFloat(a).toPrecision(l[7]):parseFloat(a);break;case"o":a=a.toString(8);break;case"s":a=String(a),a=l[7]?a.substring(0,l[7]):a;break;case"t":a=String(!!a),a=l[7]?a.substring(0,l[7]):a;break;case"T":a=n(a),a=l[7]?a.substring(0,l[7]):a;break;case"u":
a=parseInt(a,10)>>>0;break;case"v":a=a.valueOf(),a=l[7]?a.substring(0,l[7]):a;break;case"x":a=parseInt(a,10).toString(16);break;case"X":a=parseInt(a,10).toString(16).toUpperCase()}s.json.test(l[8])?v[v.length]=a:(!s.number.test(l[8])||_&&!l[3]?g="":(g=_?"+":"-",a=a.toString().replace(s.sign,"")),f=l[4]?"0"===l[4]?"0":l[4].charAt(1):" ",d=l[6]-(g+a).length,u=l[6]&&d>0?r(f,d):"",v[v.length]=l[5]?g+a+u:"0"===f?g+u+a:u+g+a)}return v.join("")},t.cache={},t.parse=function(e){for(var t=e,n=[],r=[],i=0;t;){if(null!==(n=s.text.exec(t)))r[r.length]=n[0];else if(null!==(n=s.modulo.exec(t)))r[r.length]="%";else{if(null===(n=s.placeholder.exec(t)))throw new SyntaxError("[sprintf] unexpected placeholder");if(n[2]){i|=1;var a=[],o=n[2],c=[];if(null===(c=s.key.exec(o)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(a[a.length]=c[1];""!==(o=o.substring(c[0].length));)if(null!==(c=s.key_access.exec(o)))a[a.length]=c[1];else{if(null===(c=s.index_access.exec(o)))throw new SyntaxError("[sprintf] failed to parse named argument key");a[a.length]=c[1]}n[2]=a}else i|=2;if(3===i)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");r[r.length]=n}t=t.substring(n[0].length)}return r};var i=function(e,n,r){return r=(n||[]).slice(0),r.splice(0,0,e),t.apply(null,r)},a={0:["","0","00","000","0000","00000","000000","0000000"]," ":[""," ","  ","   ","    ","     ","      ","       "],_:["","_","__","___","____","_____","______","_______"]};"undefined"!=typeof exports?(exports.sprintf=t,exports.vsprintf=i):(e.sprintf=t,e.vsprintf=i,"function"==typeof define&&define.amd&&define(function(){return{sprintf:t,vsprintf:i}}))}("undefined"==typeof window?this:window);var swfobject=function(){function e(){if(!H){try{var e=M.getElementsByTagName("body")[0].appendChild(v("span"));e.parentNode.removeChild(e)}catch(t){return}H=!0;for(var n=F.length,r=0;n>r;r++)F[r]()}}function t(e){H?e():F[F.length]=e}function n(e){if(typeof I.addEventListener!=O)I.addEventListener("load",e,!1);else if(typeof M.addEventListener!=O)M.addEventListener("load",e,!1);else if(typeof I.attachEvent!=O)_(I,"onload",e);else if("function"==typeof I.onload){var t=I.onload;I.onload=function(){t(),e()}}else I.onload=e}function r(){j?s():i()}function s(){var e=M.getElementsByTagName("body")[0],t=v(A);t.setAttribute("type",R);var n=e.appendChild(t);if(n){var r=0;!function(){if(typeof n.GetVariable!=O){var s=n.GetVariable("$version");s&&(s=s.split(" ")[1].split(","),W.pv=[parseInt(s[0],10),parseInt(s[1],10),parseInt(s[2],10)])}else if(10>r)return r++,void setTimeout(arguments.callee,10);e.removeChild(t),n=null,i()}()}else i()}function i(){var e=q.length;if(e>0)for(var t=0;e>t;t++){var n=q[t].id,r=q[t].callbackFn,s={success:!1,id:n};if(W.pv[0]>0){var i=m(n);if(i)if(!g(q[t].swfVersion)||W.wk&&W.wk<312)if(q[t].expressInstall&&o()){var u={};u.data=q[t].expressInstall,u.width=i.getAttribute("width")||"0",u.height=i.getAttribute("height")||"0",i.getAttribute("class")&&(u.styleclass=i.getAttribute("class")),i.getAttribute("align")&&(u.align=i.getAttribute("align"));for(var f={},d=i.getElementsByTagName("param"),p=d.length,h=0;p>h;h++)"movie"!=d[h].getAttribute("name").toLowerCase()&&(f[d[h].getAttribute("name")]=d[h].getAttribute("value"));c(u,f,n,r)}else l(i),r&&r(s);else b(n,!0),r&&(s.success=!0,s.ref=a(n),r(s))}else if(b(n,!0),r){var v=a(n);v&&typeof v.SetVariable!=O&&(s.success=!0,s.ref=v),r(s)}}}function a(e){var t=null,n=m(e);if(n&&"OBJECT"==n.nodeName)if(typeof n.SetVariable!=O)t=n;else{var r=n.getElementsByTagName(A)[0];r&&(t=r)}return t}function o(){return!U&&g("6.0.65")&&(W.win||W.mac)&&!(W.wk&&W.wk<312)}function c(e,t,n,r){U=!0,E=r||null,T={success:!1,id:n};var s=m(n);if(s){"OBJECT"==s.nodeName?(w=u(s),k=null):(w=s,k=n),e.id=L,(typeof e.width==O||!/%$/.test(e.width)&&parseInt(e.width,10)<310)&&(e.width="310"),(typeof e.height==O||!/%$/.test(e.height)&&parseInt(e.height,10)<137)&&(e.height="137"),M.title=M.title.slice(0,47)+" - Flash Player Installation";var i=W.ie&&W.win?"ActiveX":"PlugIn",a="MMredirectURL="+I.location.toString().replace(/&/g,"%26")+"&MMplayerType="+i+"&MMdoctitle="+M.title;if(typeof t.flashvars!=O?t.flashvars+="&"+a:t.flashvars=a,W.ie&&W.win&&4!=s.readyState){var o=v("div");n+="SWFObjectNew",o.setAttribute("id",n),s.parentNode.insertBefore(o,s),s.style.display="none",function(){4==s.readyState?s.parentNode.removeChild(s):setTimeout(arguments.callee,10)}()}f(e,t,n)}}function l(e){if(W.ie&&W.win&&4!=e.readyState){var t=v("div");e.parentNode.insertBefore(t,e),t.parentNode.replaceChild(u(e),t),e.style.display="none",function(){4==e.readyState?e.parentNode.removeChild(e):setTimeout(arguments.callee,10)}()}else e.parentNode.replaceChild(u(e),e)}function u(e){var t=v("div");if(W.win&&W.ie)t.innerHTML=e.innerHTML;else{var n=e.getElementsByTagName(A)[0];if(n){var r=n.childNodes;if(r)for(var s=r.length,i=0;s>i;i++)1==r[i].nodeType&&"PARAM"==r[i].nodeName||8==r[i].nodeType||t.appendChild(r[i].cloneNode(!0))}}return t}function f(e,t,n){var r,s=m(n);if(W.wk&&W.wk<312)return r;if(s)if(typeof e.id==O&&(e.id=n),W.ie&&W.win){var i="";for(var a in e)e[a]!=Object.prototype[a]&&("data"==a.toLowerCase()?t.movie=e[a]:"styleclass"==a.toLowerCase()?i+=' class="'+e[a]+'"':"classid"!=a.toLowerCase()&&(i+=" "+a+'="'+e[a]+'"'));var o="";for(var c in t)t[c]!=Object.prototype[c]&&(o+='<param name="'+c+'" value="'+t[c]+'" />');s.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+i+">"+o+"</object>",V[V.length]=e.id,r=m(e.id)}else{var l=v(A);l.setAttribute("type",R);for(var u in e)e[u]!=Object.prototype[u]&&("styleclass"==u.toLowerCase()?l.setAttribute("class",e[u]):"classid"!=u.toLowerCase()&&l.setAttribute(u,e[u]));for(var f in t)t[f]!=Object.prototype[f]&&"movie"!=f.toLowerCase()&&d(l,f,t[f]);s.parentNode.replaceChild(l,s),r=l}return r}function d(e,t,n){var r=v("param");r.setAttribute("name",t),r.setAttribute("value",n),e.appendChild(r)}function p(e){var t=m(e);t&&"OBJECT"==t.nodeName&&(W.ie&&W.win?(t.style.display="none",function(){4==t.readyState?h(e):setTimeout(arguments.callee,10)}()):t.parentNode.removeChild(t))}function h(e){var t=m(e);if(t){for(var n in t)"function"==typeof t[n]&&(t[n]=null);t.parentNode.removeChild(t)}}function m(e){var t=null;try{t=M.getElementById(e)}catch(n){}return t}function v(e){return M.createElement(e)}function _(e,t,n){e.attachEvent(t,n),z[z.length]=[e,t,n]}function g(e){var t=W.pv,n=e.split(".");return n[0]=parseInt(n[0],10),n[1]=parseInt(n[1],10)||0,n[2]=parseInt(n[2],10)||0,t[0]>n[0]||t[0]==n[0]&&t[1]>n[1]||t[0]==n[0]&&t[1]==n[1]&&t[2]>=n[2]?!0:!1}function y(e,t,n,r){if(!W.ie||!W.mac){var s=M.getElementsByTagName("head")[0];if(s){var i=n&&"string"==typeof n?n:"screen";if(r&&(C=null,S=null),!C||S!=i){var a=v("style");a.setAttribute("type","text/css"),a.setAttribute("media",i),C=s.appendChild(a),W.ie&&W.win&&typeof M.styleSheets!=O&&M.styleSheets.length>0&&(C=M.styleSheets[M.styleSheets.length-1]),S=i}W.ie&&W.win?C&&typeof C.addRule==A&&C.addRule(e,t):C&&typeof M.createTextNode!=O&&C.appendChild(M.createTextNode(e+" {"+t+"}"))}}}function b(e,t){if($){var n=t?"visible":"hidden";H&&m(e)?m(e).style.visibility=n:y("#"+e,"visibility:"+n)}}function x(e){var t=/[\\\"<>\.;]/,n=null!=t.exec(e);return n&&typeof encodeURIComponent!=O?encodeURIComponent(e):e}var w,k,E,T,C,S,O="undefined",A="object",N="Shockwave Flash",B="ShockwaveFlash.ShockwaveFlash",R="application/x-shockwave-flash",L="SWFObjectExprInst",P="onreadystatechange",I=window,M=document,D=navigator,j=!1,F=[r],q=[],V=[],z=[],H=!1,U=!1,$=!0,W=function(){var e=typeof M.getElementById!=O&&typeof M.getElementsByTagName!=O&&typeof M.createElement!=O,t=D.userAgent.toLowerCase(),n=D.platform.toLowerCase(),r=n?/win/.test(n):/win/.test(t),s=n?/mac/.test(n):/mac/.test(t),i=/webkit/.test(t)?parseFloat(t.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,a=!1,o=[0,0,0],c=null;if(typeof D.plugins!=O&&typeof D.plugins[N]==A)c=D.plugins[N].description,!c||typeof D.mimeTypes!=O&&D.mimeTypes[R]&&!D.mimeTypes[R].enabledPlugin||(j=!0,a=!1,c=c.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),o[0]=parseInt(c.replace(/^(.*)\..*$/,"$1"),10),o[1]=parseInt(c.replace(/^.*\.(.*)\s.*$/,"$1"),10),o[2]=/[a-zA-Z]/.test(c)?parseInt(c.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof I.ActiveXObject!=O)try{var l=new ActiveXObject(B);l&&(c=l.GetVariable("$version"),c&&(a=!0,c=c.split(" ")[1].split(","),o=[parseInt(c[0],10),parseInt(c[1],10),parseInt(c[2],10)]))}catch(u){}return{w3:e,pv:o,wk:i,ie:a,win:r,mac:s}}();(function(){W.w3&&((typeof M.readyState!=O&&"complete"==M.readyState||typeof M.readyState==O&&(M.getElementsByTagName("body")[0]||M.body))&&e(),H||(typeof M.addEventListener!=O&&M.addEventListener("DOMContentLoaded",e,!1),W.ie&&W.win&&(M.attachEvent(P,function(){"complete"==M.readyState&&(M.detachEvent(P,arguments.callee),e())}),I==top&&!function(){if(!H){try{M.documentElement.doScroll("left")}catch(t){return void setTimeout(arguments.callee,0)}e()}}()),W.wk&&!function(){return H?void 0:/loaded|complete/.test(M.readyState)?void e():void setTimeout(arguments.callee,0)}(),n(e)))})(),function(){W.ie&&W.win&&window.attachEvent("onunload",function(){for(var e=z.length,t=0;e>t;t++)z[t][0].detachEvent(z[t][1],z[t][2]);for(var n=V.length,r=0;n>r;r++)p(V[r]);for(var s in W)W[s]=null;W=null;for(var i in swfobject)swfobject[i]=null;swfobject=null})}();return{registerObject:function(e,t,n,r){if(W.w3&&e&&t){var s={};s.id=e,s.swfVersion=t,s.expressInstall=n,s.callbackFn=r,q[q.length]=s,b(e,!1)}else r&&r({success:!1,id:e})},getObjectById:function(e){return W.w3?a(e):void 0},embedSWF:function(e,n,r,s,i,a,l,u,d,p){var h={success:!1,id:n};W.w3&&!(W.wk&&W.wk<312)&&e&&n&&r&&s&&i?(b(n,!1),t(function(){r+="",s+="";var t={};if(d&&typeof d===A)for(var m in d)t[m]=d[m];t.data=e,t.width=r,t.height=s;var v={};if(u&&typeof u===A)for(var _ in u)v[_]=u[_];if(l&&typeof l===A)for(var y in l)typeof v.flashvars!=O?v.flashvars+="&"+y+"="+l[y]:v.flashvars=y+"="+l[y];if(g(i)){var x=f(t,v,n);t.id==n&&b(n,!0),h.success=!0,h.ref=x}else{if(a&&o())return t.data=a,void c(t,v,n,p);b(n,!0)}p&&p(h)})):p&&p(h)},switchOffAutoHideShow:function(){$=!1},ua:W,getFlashPlayerVersion:function(){return{major:W.pv[0],minor:W.pv[1],release:W.pv[2]}},hasFlashPlayerVersion:g,createSWF:function(e,t,n){return W.w3?f(e,t,n):void 0},showExpressInstall:function(e,t,n,r){W.w3&&o()&&c(e,t,n,r)},removeSWF:function(e){W.w3&&p(e)},createCSS:function(e,t,n,r){W.w3&&y(e,t,n,r)},addDomLoadEvent:t,addLoadEvent:n,getQueryParamValue:function(e){var t=M.location.search||M.location.hash;if(t){if(/\?/.test(t)&&(t=t.split("?")[1]),null==e)return x(t);for(var n=t.split("&"),r=0;r<n.length;r++)if(n[r].substring(0,n[r].indexOf("="))==e)return x(n[r].substring(n[r].indexOf("=")+1))}return""},expressInstallCallback:function(){if(U){var e=m(L);e&&w&&(e.parentNode.replaceChild(w,e),k&&(b(k,!0),W.ie&&W.win&&(w.style.display="block")),E&&E(T)),U=!1}}}}();!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Clipboard=e()}}(function(){return function e(t,n,r){function s(a,o){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!o&&c)return c(a,!0);if(i)return i(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var u=n[a]={exports:{}};t[a][0].call(u.exports,function(e){var n=t[a][1][e];return s(n?n:e)},u,u.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)s(r[a]);return s}({1:[function(e,t,n){var r=e("matches-selector");t.exports=function(e,t,n){for(var s=n?e:e.parentNode;s&&s!==document;){if(r(s,t))return s;s=s.parentNode}}},{"matches-selector":5}],2:[function(e,t,n){function r(e,t,n,r,i){var a=s.apply(this,arguments);return e.addEventListener(n,a,i),{destroy:function(){e.removeEventListener(n,a,i)}}}function s(e,t,n,r){return function(n){n.delegateTarget=i(n.target,t,!0),n.delegateTarget&&r.call(e,n)}}var i=e("closest");t.exports=r},{closest:1}],3:[function(e,t,n){n.node=function(e){return void 0!==e&&e instanceof HTMLElement&&1===e.nodeType},n.nodeList=function(e){var t=Object.prototype.toString.call(e);return void 0!==e&&("[object NodeList]"===t||"[object HTMLCollection]"===t)&&"length"in e&&(0===e.length||n.node(e[0]))},n.string=function(e){return"string"==typeof e||e instanceof String},n.fn=function(e){var t=Object.prototype.toString.call(e);return"[object Function]"===t}},{}],4:[function(e,t,n){function r(e,t,n){if(!e&&!t&&!n)throw new Error("Missing required arguments");if(!o.string(t))throw new TypeError("Second argument must be a String");if(!o.fn(n))throw new TypeError("Third argument must be a Function");if(o.node(e))return s(e,t,n);if(o.nodeList(e))return i(e,t,n);if(o.string(e))return a(e,t,n);throw new TypeError("First argument must be a String, HTMLElement, HTMLCollection, or NodeList")}function s(e,t,n){return e.addEventListener(t,n),{destroy:function(){e.removeEventListener(t,n)}}}function i(e,t,n){return Array.prototype.forEach.call(e,function(e){e.addEventListener(t,n)}),{destroy:function(){Array.prototype.forEach.call(e,function(e){e.removeEventListener(t,n)})}}}function a(e,t,n){return c(document.body,e,t,n)}var o=e("./is"),c=e("delegate");t.exports=r},{"./is":3,delegate:2}],5:[function(e,t,n){function r(e,t){if(i)return i.call(e,t);for(var n=e.parentNode.querySelectorAll(t),r=0;r<n.length;++r)if(n[r]==e)return!0;return!1}var s=Element.prototype,i=s.matchesSelector||s.webkitMatchesSelector||s.mozMatchesSelector||s.msMatchesSelector||s.oMatchesSelector;t.exports=r},{}],6:[function(e,t,n){function r(e){var t;if("INPUT"===e.nodeName||"TEXTAREA"===e.nodeName)e.focus(),e.setSelectionRange(0,e.value.length),t=e.value;else{e.hasAttribute("contenteditable")&&e.focus();var n=window.getSelection(),r=document.createRange();r.selectNodeContents(e),n.removeAllRanges(),n.addRange(r),t=n.toString()}return t}t.exports=r},{}],7:[function(e,t,n){function r(){}r.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){function r(){s.off(e,r),t.apply(n,arguments)}var s=this;return r._=t,this.on(e,r,n)},emit:function(e){var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,s=n.length;for(r;s>r;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],s=[];if(r&&t)for(var i=0,a=r.length;a>i;i++)r[i].fn!==t&&r[i].fn._!==t&&s.push(r[i]);return s.length?n[e]=s:delete n[e],this}},t.exports=r},{}],8:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}n.__esModule=!0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("select"),o=r(a),c=function(){function e(t){s(this,e),this.resolveOptions(t),this.initSelection()}return e.prototype.resolveOptions=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.action=e.action,this.emitter=e.emitter,this.target=e.target,this.text=e.text,this.trigger=e.trigger,this.selectedText=""},e.prototype.initSelection=function(){if(this.text&&this.target)throw new Error('Multiple attributes declared, use either "target" or "text"');if(this.text)this.selectFake();else{if(!this.target)throw new Error('Missing required attributes, use either "target" or "text"');this.selectTarget()}},e.prototype.selectFake=function(){var e=this,t="rtl"==document.documentElement.getAttribute("dir");this.removeFake(),this.fakeHandler=document.body.addEventListener("click",function(){return e.removeFake()}),this.fakeElem=document.createElement("textarea"),this.fakeElem.style.fontSize="12pt",this.fakeElem.style.border="0",this.fakeElem.style.padding="0",this.fakeElem.style.margin="0",this.fakeElem.style.position="absolute",this.fakeElem.style[t?"right":"left"]="-9999px",this.fakeElem.style.top=(window.pageYOffset||document.documentElement.scrollTop)+"px",this.fakeElem.setAttribute("readonly",""),this.fakeElem.value=this.text,document.body.appendChild(this.fakeElem),this.selectedText=o["default"](this.fakeElem),this.copyText()},e.prototype.removeFake=function(){this.fakeHandler&&(document.body.removeEventListener("click"),this.fakeHandler=null),this.fakeElem&&(document.body.removeChild(this.fakeElem),this.fakeElem=null)},e.prototype.selectTarget=function(){this.selectedText=o["default"](this.target),this.copyText()},e.prototype.copyText=function(){var e=void 0;try{e=document.execCommand(this.action)}catch(t){e=!1}this.handleResult(e)},e.prototype.handleResult=function(e){e?this.emitter.emit("success",{action:this.action,text:this.selectedText,trigger:this.trigger,clearSelection:this.clearSelection.bind(this)}):this.emitter.emit("error",{action:this.action,trigger:this.trigger,clearSelection:this.clearSelection.bind(this)})},e.prototype.clearSelection=function(){this.target&&this.target.blur(),window.getSelection().removeAllRanges()},e.prototype.destroy=function(){this.removeFake()},i(e,[{key:"action",set:function(){var e=arguments.length<=0||void 0===arguments[0]?"copy":arguments[0];if(this._action=e,"copy"!==this._action&&"cut"!==this._action)throw new Error('Invalid "action" value, use either "copy" or "cut"')},get:function(){return this._action}},{key:"target",set:function(e){if(void 0!==e){if(!e||"object"!=typeof e||1!==e.nodeType)throw new Error('Invalid "target" value, use a valid Element');this._target=e}},get:function(){return this._target}}]),e}();n["default"]=c,t.exports=n["default"]},{select:6}],9:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){var n="data-clipboard-"+e;return t.hasAttribute(n)?t.getAttribute(n):void 0}n.__esModule=!0;var o=e("./clipboard-action"),c=r(o),l=e("tiny-emitter"),u=r(l),f=e("good-listener"),d=r(f),p=function(e){function t(n,r){s(this,t),e.call(this),this.resolveOptions(r),this.listenClick(n)}return i(t,e),t.prototype.resolveOptions=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.action="function"==typeof e.action?e.action:this.defaultAction,this.target="function"==typeof e.target?e.target:this.defaultTarget,this.text="function"==typeof e.text?e.text:this.defaultText},t.prototype.listenClick=function(e){var t=this;this.listener=d["default"](e,"click",function(e){return t.onClick(e)})},t.prototype.onClick=function(e){var t=e.delegateTarget||e.currentTarget;this.clipboardAction&&(this.clipboardAction=null),this.clipboardAction=new c["default"]({action:this.action(t),target:this.target(t),text:this.text(t),trigger:t,emitter:this})},t.prototype.defaultAction=function(e){return a("action",e)},t.prototype.defaultTarget=function(e){var t=a("target",e);return t?document.querySelector(t):void 0},t.prototype.defaultText=function(e){return a("text",e)},t.prototype.destroy=function(){this.listener.destroy(),this.clipboardAction&&(this.clipboardAction.destroy(),this.clipboardAction=null)},t}(u["default"]);n["default"]=p,t.exports=n["default"]},{"./clipboard-action":8,"good-listener":4,"tiny-emitter":7}]},{},[9])(9)});var Survey;!function(e){var t=function(){function e(e,t){void 0===t&&(t=null),this.text=t,this.value=e}return e.setData=function(t,n){t.length=0;for(var r=0;r<n.length;r++){var s=n[r],i=new e(null);"undefined"!=typeof s.value?(i.text=s.text,i.value=s.value):i.value=s,t.push(i)}},e.getData=function(e){for(var t=new Array,n=0;n<e.length;n++){var r=e[n];r.hasText?t.push({value:r.value,text:r.text}):t.push(r.value)}return t},e.prototype.getType=function(){return"itemvalue"},Object.defineProperty(e.prototype,"value",{get:function(){return this.itemValue},set:function(t){if(this.itemValue=t,this.itemValue){var n=this.itemValue.toString(),r=n.indexOf(e.Separator);r>-1&&(this.itemValue=n.slice(0,r),this.text=n.slice(r+1))}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasText",{get:function(){return this.itemText?!0:!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"text",{get:function(){return this.hasText?this.itemText:this.value?this.value.toString():null},set:function(e){this.itemText=e},enumerable:!0,configurable:!0}),e.Separator="|",e}();e.ItemValue=t;var n=function(){function e(){this.isKO="undefined"!=typeof ko}return e.prototype.getType=function(){throw new Error("This method is abstract")},e}();e.Base=n;var r=function(){function e(){}return e.prototype.getText=function(){throw new Error("This method is abstract")},e}();e.SurveyError=r;var s=function(){function e(){}return Object.defineProperty(e.prototype,"isEmpty",{get:function(){return null==this.callbacks||0==this.callbacks.length},enumerable:!0,configurable:!0}),e.prototype.fire=function(e,t){if(null!=this.callbacks)for(var n=0;n<this.callbacks.length;n++){this.callbacks[n](e,t)}},e.prototype.add=function(e){null==this.callbacks&&(this.callbacks=new Array),this.callbacks.push(e)},e.prototype.remove=function(e){if(null!=this.callbacks){var t=this.callbacks.indexOf(e,0);void 0!=t&&this.callbacks.splice(t,1)}},e}();e.Event=s}(Survey||(Survey={}));var Survey;!function(e){var t=function(){function e(){}return e.prototype.loadSurvey=function(t,n){var r=new XMLHttpRequest;r.open("GET",e.serviceUrl+"/getSurvey?surveyId="+t),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.onload=function(){var e=JSON.parse(r.response);n(200==r.status,e,r.response)},r.send()},e.prototype.sendResult=function(t,n,r,s,i){void 0===s&&(s=null),void 0===i&&(i=!1);var a=new XMLHttpRequest;a.open("POST",e.serviceUrl+"/post/"),a.setRequestHeader("Content-Type","application/json; charset=utf-8");var o={postId:t,surveyResult:JSON.stringify(n)};s&&(o.clientId=s),i&&(o.isPartialCompleted=!0);var c=JSON.stringify(o);a.setRequestHeader("Content-Length",c.length.toString());a.onload=function(){r(200==a.status,a.response)},a.send(c)},e.prototype.getResult=function(t,n,r){var s=new XMLHttpRequest,i="resultId="+t+"&name="+n;s.open("GET",e.serviceUrl+"/getResult?"+i),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded");s.onload=function(){var e=null,t=null;if(200==s.status){e=JSON.parse(s.response),t=[];for(var n in e.QuestionResult){var i={name:n,value:e.QuestionResult[n]};t.push(i)}}r(200==s.status,e,t,s.response)},s.send()},e.prototype.isCompleted=function(t,n,r){var s=new XMLHttpRequest,i="resultId="+t+"&clientId="+n;s.open("GET",e.serviceUrl+"/isCompleted?"+i),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded");s.onload=function(){var e=null;200==s.status&&(e=JSON.parse(s.response)),r(200==s.status,e,s.response)},s.send()},e.serviceUrl="https://dxsurveyapi.azurewebsites.net/api/Survey",e}();e.dxSurveyService=t}(Survey||(Survey={}));var Survey;!function(e){e.surveyStrings={pagePrevText:"Previous",pageNextText:"Next",completeText:"Complete",otherItemText:"Other (describe)",optionsCaption:"Choose...",requiredError:"Please answer the question.",numericError:"The value should be a numeric.",textMinLength:"Please enter at least {0} symblos.",minSelectError:"Please select at least {0} variants.",maxSelectError:"Please select not more than {0} variants.",numericMinMax:"The '{0}' should be equal or more than {1} and equal or less than {2}",numericMin:"The '{0}' should be equal or more than {1}",numericMax:"The '{0}' should be equal or less than {1}"},String.prototype.format||(String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,n){return"undefined"!=typeof e[n]?e[n]:t})})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(t){function n(){t.call(this)}return __extends(n,t),n.prototype.getText=function(){return e.surveyStrings.requiredError},n}(e.SurveyError);e.AnswerRequiredError=t;var n=function(t){function n(){t.call(this)}return __extends(n,t),n.prototype.getText=function(){return e.surveyStrings.numericError},n}(e.SurveyError);e.RequreNumericError=n;var r=function(e){function t(t){e.call(this),this.text=t}return __extends(t,e),t.prototype.getText=function(){return this.text},t}(e.SurveyError);e.CustomError=r}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(){function e(e){this.name=e,this.typeValue=null,this.className=null,this.classNamePart=null,this.baseClassName=null,this.defaultValue=null,this.choices=null,this.onGetValue=null}return Object.defineProperty(e.prototype,"type",{get:function(){return this.typeValue?this.typeValue:"string"},set:function(e){this.typeValue=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasToUseGetValue",{get:function(){return this.onGetValue},enumerable:!0,configurable:!0}),e.prototype.isDefaultValue=function(e){return this.defaultValue?this.defaultValue==e:!e},e.prototype.getValue=function(e){return this.onGetValue?this.onGetValue(e):null},Object.defineProperty(e.prototype,"hasToUseSetValue",{get:function(){return this.onSetValue},enumerable:!0,configurable:!0}),e.prototype.setValue=function(e,t,n){this.onSetValue&&this.onSetValue(e,t,n)},e.prototype.getObjType=function(e){return this.classNamePart?e.replace(this.classNamePart,""):e},e.prototype.getClassName=function(e){return this.classNamePart&&e.indexOf(this.classNamePart)<0?e+this.classNamePart:e},e}();e.JsonObjectProperty=t;var n=function(){function e(n,r,s,i){void 0===s&&(s=null),void 0===i&&(i=null),this.name=n,this.creator=s,this.parentName=i,this.properties=null,this.requiredProperties=null,this.properties=new Array;for(var a=0;a<r.length;a++){var o=r[a],c=null,l=o.indexOf(e.typeSymbol);l>-1&&(c=o.substring(l+1),o=o.substring(0,l));var o=this.getPropertyName(o),u=new t(o);c&&(u.type=c),this.properties.push(u)}}return e.prototype.find=function(e){for(var t=0;t<this.properties.length;t++)if(this.properties[t].name==e)return this.properties[t];return null},e.prototype.getPropertyName=function(t){return 0==t.length||t[0]!=e.requiredSymbol?t:(t=t.slice(1),this.requiredProperties||(this.requiredProperties=new Array),this.requiredProperties.push(t),t)},e.requiredSymbol="!",e.typeSymbol=":",e}();e.JsonMetadataClass=n;var r=function(){function e(){this.classes={},this.childrenClasses={},this.classProperties={},this.classRequiredProperties={}}return e.prototype.addClass=function(e,t,r,s){void 0===r&&(r=null),void 0===s&&(s=null);var i=new n(e,t,r,s);if(this.classes[e]=i,s){var a=this.childrenClasses[s];a||(this.childrenClasses[s]=[]),this.childrenClasses[s].push(i)}return i},e.prototype.overrideClassCreatore=function(e,t){var n=this.findClass(e);n&&(n.creator=t)},e.prototype.setPropertyValues=function(e,t,n,r,s,i){void 0===r&&(r=null),void 0===s&&(s=null),void 0===i&&(i=null);var a=this.findProperty(e,t);a&&(a.className=n,a.defaultValue=r,a.onGetValue=s,a.onSetValue=i)},e.prototype.setPropertyChoices=function(e,t,n){var r=this.findProperty(e,t);r&&(r.choices=n)},e.prototype.setPropertyClassInfo=function(e,t,n,r){void 0===r&&(r=null);var s=this.findProperty(e,t);s&&(s.baseClassName=n,s.classNamePart=r)},e.prototype.getProperties=function(e){var t=this.classProperties[e];return t||(t=new Array,this.fillProperties(e,t),this.classProperties[e]=t),t},e.prototype.createClass=function(e){var t=this.findClass(e);return t?t.creator():null},e.prototype.getChildrenClasses=function(e,t){void 0===t&&(t=!1);var n=[];return this.fillChildrenClasses(e,t,n),n},e.prototype.getRequiredProperties=function(e){var t=this.classRequiredProperties[e];return t||(t=new Array,this.fillRequiredProperties(e,t),this.classRequiredProperties[e]=t),t},e.prototype.fillChildrenClasses=function(e,t,n){var r=this.childrenClasses[e];if(r)for(var s=0;s<r.length;s++)(!t||r[s].creator)&&n.push(r[s]),this.fillChildrenClasses(r[s].name,t,n)},e.prototype.findClass=function(e){return this.classes[e]},e.prototype.findProperty=function(e,t){var n=this.findClass(e);return n?n.find(t):null},e.prototype.fillProperties=function(e,t){var n=this.findClass(e);if(n){n.parentName&&this.fillProperties(n.parentName,t);for(var r=0;r<n.properties.length;r++)this.addProperty(n.properties[r],t,t.length)}},e.prototype.addProperty=function(e,t,n){for(var r=-1,s=0;n>s;s++)if(t[s].name==e.name){r=s;break}0>r?t.push(e):t[r]=e},e.prototype.fillRequiredProperties=function(e,t){var n=this.findClass(e);n&&(n.requiredProperties&&Array.prototype.push.apply(t,n.requiredProperties),n.parentName&&this.fillRequiredProperties(n.parentName,t))},e}();e.JsonMetadata=r;var s=function(){function e(e,t){this.type=e,this.message=t,this.description="",this.at=-1}return e.prototype.getFullDescription=function(){return this.message+(this.description?"\n"+this.description:"")},e}();e.JsonError=s;var i=function(e){function t(t,n){e.call(this,"unknownproperty","The property '"+t+"' in class '"+n+"' is unknown."),this.propertyName=t,this.className=n;var r=u.metaData.getProperties(n);if(r){this.description="The list of available properties are: ";for(var s=0;s<r.length;s++)s>0&&(this.description+=", "),this.description+=r[s].name;this.description+="."}}return __extends(t,e),t}(s);e.JsonUnknownPropertyError=i;var a=function(e){function t(t,n,r){e.call(this,n,r),this.baseClassName=t,this.type=n,this.message=r,this.description="The following types are available: ";for(var s=u.metaData.getChildrenClasses(t,!0),i=0;i<s.length;i++)i>0&&(this.description+=", "),this.description+="'"+s[i].name+"'";this.description+="."}return __extends(t,e),t}(s);e.JsonMissingTypeErrorBase=a;var o=function(e){function t(t,n){e.call(this,n,"missingtypeproperty","The property type is missing in the object. Please take a look at property: '"+t+"'."),this.propertyName=t,this.baseClassName=n}return __extends(t,e),t}(a);e.JsonMissingTypeError=o;var c=function(e){function t(t,n){e.call(this,n,"incorrecttypeproperty","The property type is incorrect in the object. Please take a look at property: '"+t+"'."),this.propertyName=t,this.baseClassName=n}return __extends(t,e),t}(a);e.JsonIncorrectTypeError=c;var l=function(e){function t(t,n){e.call(this,"requiredproperty","The property '"+t+"' is required in class '"+n+"'."),this.propertyName=t,this.className=n}return __extends(t,e),t}(s);e.JsonRequiredPropertyError=l;var u=function(){function e(){this.errors=new Array}return Object.defineProperty(e,"metaData",{get:function(){return e.metaDataValue},enumerable:!0,configurable:!0}),e.prototype.toJsonObject=function(e){return this.toJsonObjectCore(e,null)},e.prototype.toObject=function(t,n){if(t){var r=null;if(n.getType&&(r=e.metaData.getProperties(n.getType())),r)for(var s in t)if(s!=e.typePropertyName)if(s!=e.positionPropertyName){var a=this.findProperty(r,s);a?this.valueToObj(t[s],n,s,a):this.addNewError(new i(s.toString(),n.getType()),t)}else n[s]=t[s]}},e.prototype.toJsonObjectCore=function(t,n){if(!t.getType)return t;var r={};null==n||n.className||(r[e.typePropertyName]=n.getObjType(t.getType()));for(var s=e.metaData.getProperties(t.getType()),i=0;i<s.length;i++)this.valueToJson(t,r,s[i]);return r;
},e.prototype.valueToJson=function(e,t,n){var r=null;if(r=n.hasToUseGetValue?n.getValue(e):e[n.name],!n.isDefaultValue(r)){if(this.isValueArray(r)){for(var s=[],i=0;i<r.length;i++)s.push(this.toJsonObjectCore(r[i],n));r=s.length>0?s:null}else r=this.toJsonObjectCore(r,n);n.isDefaultValue(r)||(t[n.name]=r)}},e.prototype.valueToObj=function(e,t,n,r){if(null!=r&&r.hasToUseSetValue)return void r.setValue(t,e,this);if(this.isValueArray(e))return void this.valueToArray(e,t,n,r);var s=this.createNewObj(e,r);s.newObj&&(this.toObject(e,s.newObj),e=s.newObj),s.error||(t[n]=e)},e.prototype.isValueArray=function(e){return e.constructor.toString().indexOf("Array")>-1},e.prototype.createNewObj=function(t,n){var r={newObj:null,error:null},s=t[e.typePropertyName];return!s&&null!=n&&n.className&&(s=n.className),s=n.getClassName(s),r.newObj=s?e.metaData.createClass(s):null,r.error=this.checkNewObjectOnErrors(r.newObj,t,n,s),r},e.prototype.checkNewObjectOnErrors=function(t,n,r,s){var i=null;if(t){var a=e.metaData.getRequiredProperties(s);if(a)for(var u=0;u<a.length;u++)if(!n[a[u]]){i=new l(a[u],s);break}}else r.baseClassName&&(i=s?new c(r.name,r.baseClassName):new o(r.name,r.baseClassName));return i&&this.addNewError(i,n),i},e.prototype.addNewError=function(t,n){n&&n[e.positionPropertyName]&&(t.at=n[e.positionPropertyName].start),this.errors.push(t)},e.prototype.valueToArray=function(e,t,n,r){this.isValueArray(t[n])||(t[n]=[]);for(var s=0;s<e.length;s++){var i=this.createNewObj(e[s],r);i.newObj?(t[n].push(i.newObj),this.toObject(e[s],i.newObj)):i.error||t[n].push(e[s])}},e.prototype.findProperty=function(e,t){if(!e)return null;for(var n=0;n<e.length;n++)if(e[n].name==t)return e[n];return null},e.typePropertyName="type",e.positionPropertyName="pos",e.metaDataValue=new r,e}();e.JsonObject=u}(Survey||(Survey={}));var Survey;!function(e){var t=function(){function e(){this.creatorHash={}}return e.prototype.registerQuestion=function(e,t){this.creatorHash[e]=t},e.prototype.getAllTypes=function(){var e=new Array;for(var t in this.creatorHash)e.push(t);return e.sort()},e.prototype.createQuestion=function(e,t){var n=this.creatorHash[e];return null==n?null:n(t)},e.Instance=new e,e.DefaultChoices=["one","two|second value",{value:3,text:"third value"}],e}();e.QuestionFactory=t}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(){function e(e,t){void 0===t&&(t=null),this.value=e,this.error=t}return e}();e.ValidatorResult=t;var n=function(e){function t(){e.call(this),this.text=null}return __extends(t,e),t.prototype.getErrorText=function(e){return this.text?this.text:this.getDefaultErrorText(e)},t.prototype.getDefaultErrorText=function(e){return""},t.prototype.validate=function(e,t){return void 0===t&&(t=null),null},t}(e.Base);e.SurveyValidator=n;var r=function(){function e(){}return e.prototype.run=function(e){for(var t=0;t<e.validators.length;t++){var n=e.validators[t].validate(e.value,e.getValidatorTitle());if(null!=n){if(n.error)return n.error;n.value&&(e.value=n.value)}}return null},e}();e.ValidatorRunner=r;var s=function(n){function r(e,t){void 0===e&&(e=null),void 0===t&&(t=null),n.call(this),this.minValue=e,this.maxValue=t}return __extends(r,n),r.prototype.getType=function(){return"numericvalidator"},r.prototype.validate=function(n,r){if(void 0===r&&(r=null),!n||!this.isNumber(n))return new t(null,new e.RequreNumericError);var s=new t(parseFloat(n));return this.minValue&&this.minValue>s.value?(s.error=new e.CustomError(this.getErrorText(r)),s):this.maxValue&&this.maxValue<s.value?(s.error=new e.CustomError(this.getErrorText(r)),s):"number"==typeof n?null:s},r.prototype.getDefaultErrorText=function(t){var n=t?t:"value";return this.minValue&&this.maxValue?e.surveyStrings.numericMinMax.format(n,this.minValue,this.maxValue):this.minValue?e.surveyStrings.numericMin.format(n,this.minValue):e.surveyStrings.numericMax.format(n,this.maxValue)},r.prototype.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},r}(n);e.NumericValidator=s;var i=function(n){function r(e){void 0===e&&(e=0),n.call(this),this.minLength=e}return __extends(r,n),r.prototype.getType=function(){return"textvalidator"},r.prototype.validate=function(n,r){return void 0===r&&(r=null),this.minLength<=0?void 0:n.length<this.minLength?new t(null,new e.CustomError(this.getErrorText(r))):null},r.prototype.getDefaultErrorText=function(t){return e.surveyStrings.textMinLength.format(this.minLength)},r}(n);e.TextValidator=i;var a=function(n){function r(e,t){void 0===e&&(e=null),void 0===t&&(t=null),n.call(this),this.minCount=e,this.maxCount=t}return __extends(r,n),r.prototype.getType=function(){return"answercountvalidator"},r.prototype.validate=function(n,r){if(void 0===r&&(r=null),null==n||n.constructor!=Array)return null;var s=n.length;return this.minCount&&s<this.minCount?new t(null,new e.CustomError(this.getErrorText(e.surveyStrings.minSelectError.format(this.minCount)))):this.maxCount&&s>this.maxCount?new t(null,new e.CustomError(this.getErrorText(e.surveyStrings.maxSelectError.format(this.maxCount)))):null},r.prototype.getDefaultErrorText=function(e){return e},r}(n);e.AnswerCountValidator=a,e.JsonObject.metaData.addClass("surveyvalidator",["text"]),e.JsonObject.metaData.addClass("numericvalidator",["minValue:number","maxValue:number"],function(){return new s},"surveyvalidator"),e.JsonObject.metaData.addClass("textvalidator",["minLength:number"],function(){return new i},"surveyvalidator"),e.JsonObject.metaData.addClass("answercountvalidator",["minCount:number","maxCount:number"],function(){return new a},"surveyvalidator")}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(t){function n(e){if(t.call(this),this.name=e,this.titleValue=null,this.isRequiredValue=!1,this.hasCommentValue=!1,this.hasOtherValue=!1,this.visibleValue=!0,this.visibleIndexValue=-1,this.errors=[],this.validators=new Array,this.width="100%",this.isValueChangedInSurvey=!1,this.isKO){this.koValue=this.createkoValue(),this.koComment=ko.observable(this.comment),this.koErrors=ko.observableArray(this.errors),this.dummyObservable=ko.observable(0);var n=this;this.koVisible=ko.computed(function(){return n.dummyObservable(),n.visibleValue}),this.koNo=ko.computed(function(){return n.dummyObservable(),n.visibleIndexValue>-1?n.visibleIndexValue+1+". ":""}),this.koValue.subscribe(function(e){n.setNewValue(e)}),this.koComment.subscribe(function(e){n.setNewComment(e)}),this.onCreating()}}return __extends(n,t),n.prototype.createkoValue=function(){return ko.observable(this.value)},n.prototype.setkoValue=function(e){this.koValue(e)},Object.defineProperty(n.prototype,"title",{get:function(){return this.titleValue?this.titleValue:this.name},set:function(e){this.titleValue=e},enumerable:!0,configurable:!0}),n.prototype.supportComment=function(){return!1},n.prototype.supportOther=function(){return!1},Object.defineProperty(n.prototype,"isRequired",{get:function(){return this.isRequiredValue},set:function(e){this.isRequiredValue=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visible",{get:function(){return this.visibleValue},set:function(e){e!=this.visible&&(this.visibleValue=e,this.isKO&&this.dummyObservable(this.dummyObservable()+1),this.data&&this.data.questionVisibilityChanged(this,this.visible))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visibleIndex",{get:function(){return this.visibleIndexValue},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"hasComment",{get:function(){return this.hasCommentValue},set:function(e){this.supportComment()&&(this.hasCommentValue=e,this.hasComment&&(this.hasOther=!1))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"hasOther",{get:function(){return this.hasOtherValue},set:function(e){this.supportOther()&&(this.hasOtherValue=e,this.hasOther&&(this.hasComment=!1))},enumerable:!0,configurable:!0}),n.prototype.setData=function(e){this.data=e,this.onSurveyValueChanged(this.value)},Object.defineProperty(n.prototype,"value",{get:function(){return null!=this.data?this.data.getValue(this.name):this.questionValue},set:function(e){this.setNewValue(e),this.isKO&&this.setkoValue(this.value)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"comment",{get:function(){return null!=this.data?this.data.getComment(this.name):""},set:function(e){this.setNewComment(e),this.isKO&&this.koComment(this.comment)},enumerable:!0,configurable:!0}),n.prototype.isEmpty=function(){return null==this.value},n.prototype.hasErrors=function(){return this.checkForErrors(),this.errors.length>0},n.prototype.checkForErrors=function(){if(this.errors=[],this.onCheckForErrors(this.errors),0==this.errors.length){var e=this.runValidators();e&&this.errors.push(e)}if(this.data&&0==this.errors.length){var e=this.data.validateQuestion(this.name);e&&this.errors.push(e)}this.isKO&&this.koErrors(this.errors)},n.prototype.onCheckForErrors=function(t){this.isRequired&&this.isEmpty()&&this.errors.push(new e.AnswerRequiredError)},n.prototype.runValidators=function(){return(new e.ValidatorRunner).run(this)},n.prototype.setNewValue=function(e){this.isValueChangedInSurvey||(null!=this.data&&this.data.setValue(this.name,e),this.questionValue=e,this.onValueChanged())},n.prototype.onValueChanged=function(){},n.prototype.setNewComment=function(e){null!=this.data&&this.data.setComment(this.name,e)},n.prototype.onCreating=function(){},n.prototype.onSurveyValueChanged=function(e){this.isValueChangedInSurvey=!0,this.value=e,this.isValueChangedInSurvey=!1},n.prototype.setVisibleIndex=function(e){this.visibleIndexValue!=e&&(this.visibleIndexValue=e,this.isKO&&this.dummyObservable(this.dummyObservable()+1))},n.prototype.getValidatorTitle=function(){return null},n}(e.Base);e.Question=t,e.JsonObject.metaData.addClass("question",["!name","title","isRequired:boolean","visible:boolean","validators:validators","width"]),e.JsonObject.metaData.setPropertyValues("question","visible",null,!0),e.JsonObject.metaData.setPropertyValues("question","title",null,null,function(e){return e.titleValue}),e.JsonObject.metaData.setPropertyValues("question","width",null,"100%"),e.JsonObject.metaData.setPropertyClassInfo("question","validators","surveyvalidator","validator")}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(t){function n(e){void 0===e&&(e=""),t.call(this),this.name=e,this.questions=new Array,this.data=null,this.visible=!0,this.title="",this.visibleIndex=-1,this.numValue=-1;var n=this;this.questions.push=function(e){return null!=n.data&&e.setData(n.data),Array.prototype.push.call(this,e)},this.isKO&&(this.koNo=ko.observable(""),this.onCreating())}return __extends(n,t),Object.defineProperty(n.prototype,"num",{get:function(){return this.numValue},set:function(e){this.numValue!=e&&(this.numValue=e,this.isKO&&this.koNo(this.numValue>0?this.numValue+". ":""))},enumerable:!0,configurable:!0}),n.prototype.getType=function(){return"page"},Object.defineProperty(n.prototype,"isVisible",{get:function(){if(!this.visible)return!1;for(var e=0;e<this.questions.length;e++)if(this.questions[e].visible)return!0;return!1},enumerable:!0,configurable:!0}),n.prototype.addQuestion=function(e,t){void 0===t&&(t=-1),null!=e&&(0>t||t>=this.questions.length?this.questions.push(e):this.questions.splice(t,0,e),null!=this.data&&(e.setData(this.data),this.data.questionAdded(e,t)))},n.prototype.addNewQuestion=function(t,n){var r=e.QuestionFactory.Instance.createQuestion(t,n);return this.addQuestion(r),r},n.prototype.removeQuestion=function(e){var t=this.questions.indexOf(e);0>t||(this.questions.splice(t,1),null!=this.data&&this.data.questionRemoved(e))},n.prototype.hasErrors=function(){for(var e=!1,t=0;t<this.questions.length;t++)this.questions[t].visible&&this.questions[t].hasErrors()&&(e=!0);return e},n.prototype.addQuestionsToList=function(e,t){if(void 0===t&&(t=!1),!t||this.visible)for(var n=0;n<this.questions.length;n++)(!t||this.questions[n].visible)&&e.push(this.questions[n])},n.prototype.onCreating=function(){},n}(e.Base);e.Page=t,e.JsonObject.metaData.addClass("page",["name","questions","visible:boolean","title"],function(){return new t}),e.JsonObject.metaData.setPropertyValues("page","visible",null,!0),e.JsonObject.metaData.setPropertyClassInfo("page","questions","question")}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(t){function n(n){if(t.call(this,n),this.otherItem=new e.ItemValue("other",e.surveyStrings.otherItemText),this.choicesValues=new Array,this.otherErrorText=null,this.choicesOrderValue="none",this.isKO){var r=this;this.koOtherVisible=ko.computed(function(){return r.koValue(),r.isOtherSelected()})}}return __extends(n,t),n.prototype.isOtherSelected=function(){return this.value==this.otherItem.value},Object.defineProperty(n.prototype,"choices",{get:function(){return this.choicesValues},set:function(t){e.ItemValue.setData(this.choicesValues,t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"choicesOrder",{get:function(){return this.choicesOrderValue},set:function(e){e!=this.choicesOrderValue&&(this.choicesOrderValue=e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"otherText",{get:function(){return this.otherItem.text},set:function(e){this.otherItem.text=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visibleChoices",{get:function(){if(!this.hasOther&&"none"==this.choicesOrder)return this.choices;var e=this.sortVisibleChoices(this.choices.slice());return this.hasOther&&e.push(this.otherItem),e},enumerable:!0,configurable:!0}),n.prototype.supportComment=function(){return!0},n.prototype.supportOther=function(){return!0},n.prototype.onCheckForErrors=function(n){if(t.prototype.onCheckForErrors.call(this,n),this.isOtherSelected()&&!this.comment){var r=this.otherErrorText;r||(r="Please enter the others value."),n.push(new e.CustomError(r))}},n.prototype.sortVisibleChoices=function(e){var t=this.choicesOrder.toLowerCase();return"asc"==t?this.sortArray(e,1):"desc"==t?this.sortArray(e,-1):"random"==t?this.randomizeArray(e):e},n.prototype.sortArray=function(e,t){return e.sort(function(e,n){return e.text<n.text?-1*t:e.text>n.text?1*t:0})},n.prototype.randomizeArray=function(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[n],e[n]=r}return e},n}(e.Question);e.QuestionSelectBase=t;var n=function(e){function t(t){if(e.call(this,t),this.name=t,this.colCountValue=1,this.isKO){var n=this;this.koWidth=ko.computed(function(){return n.dummyObservable(),n.colCount>0?100/n.colCount+"%":""})}}return __extends(t,e),Object.defineProperty(t.prototype,"colCount",{get:function(){return this.colCountValue},set:function(e){0>e||e>4||(this.colCountValue=e,this.isKO&&this.dummyObservable(this.dummyObservable()+1))},enumerable:!0,configurable:!0}),t.prototype.koAfterRender=function(e,t){var n=e[0];"#text"==n.nodeName&&(n.data=""),n=e[e.length-1],"#text"==n.nodeName&&(n.data="")},t}(t);e.QuestionCheckboxBase=n,e.JsonObject.metaData.addClass("selectbase",["hasComment:boolean","hasOther:boolean","!choices:itemvalues","choicesOrder","otherText","otherErrorText"],null,"question"),e.JsonObject.metaData.setPropertyValues("selectbase","choices",null,null,function(t){return e.ItemValue.getData(t.choices)},function(t,n){e.ItemValue.setData(t.choices,n)}),e.JsonObject.metaData.setPropertyValues("selectbase","choicesOrder",null,"none"),e.JsonObject.metaData.setPropertyChoices("selectbase","choicesOrder",["none","asc","desc","random"]),e.JsonObject.metaData.setPropertyValues("selectbase","otherText",null,e.surveyStrings.otherItemText),e.JsonObject.metaData.addClass("checkboxbase",["colCount:number"],null,"selectbase"),e.JsonObject.metaData.setPropertyValues("checkboxbase","colCount",null,1),e.JsonObject.metaData.setPropertyChoices("checkboxbase","colCount",[0,1,2,3,4])}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(e){function t(t){e.call(this,t),this.name=t}return __extends(t,e),t.prototype.createkoValue=function(){return this.value?ko.observableArray(this.value):ko.observableArray()},t.prototype.setkoValue=function(e){e?this.koValue([].concat(e)):this.koValue([])},t.prototype.isOtherSelected=function(){return this.value?this.value.indexOf(this.otherItem.value)>=0:!1},t.prototype.getType=function(){return"checkbox"},t}(e.QuestionCheckboxBase);e.QuestionCheckbox=t,e.JsonObject.metaData.addClass("checkbox",[],function(){return new t("")},"checkboxbase"),e.QuestionFactory.Instance.registerQuestion("checkbox",function(n){var r=new t(n);return r.choices=e.QuestionFactory.DefaultChoices,r})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(e){function t(t){e.call(this,t),this.name=t,this.rows=4,this.cols=50}return __extends(t,e),t.prototype.getType=function(){return"comment"},t.prototype.isEmpty=function(){return e.prototype.isEmpty.call(this)||""==this.value},t}(e.Question);e.QuestionComment=t,e.JsonObject.metaData.addClass("comment",["cols:number","rows:number"],function(){return new t("")},"question"),e.JsonObject.metaData.setPropertyValues("comment","cols",null,50),e.JsonObject.metaData.setPropertyValues("comment","rows",null,4),e.QuestionFactory.Instance.registerQuestion("comment",function(e){return new t(e)})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(t){function n(e){t.call(this,e),this.name=e}return __extends(n,t),Object.defineProperty(n.prototype,"optionsCaption",{get:function(){return this.optionsCaptionValue?this.optionsCaptionValue:e.surveyStrings.optionsCaption},set:function(e){this.optionsCaptionValue=e},enumerable:!0,configurable:!0}),n.prototype.getType=function(){return"dropdown"},n}(e.QuestionSelectBase);e.QuestionDropdown=t,e.JsonObject.metaData.addClass("dropdown",["optionsCaption"],function(){return new t("")},"selectbase"),e.JsonObject.metaData.setPropertyValues("dropdown","optionsCaption",null,null,function(e){return e.optionsCaptionValue}),e.QuestionFactory.Instance.registerQuestion("dropdown",function(n){var r=new t(n);return r.choices=e.QuestionFactory.DefaultChoices,r})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(e){function t(t,n,r,s,i){if(e.call(this),this.name=t,this.text=n,this.fullName=r,this.data=s,this.rowValue=i,this.isKO){this.koValue=ko.observable(this.rowValue);var a=this;this.koValue.subscribe(function(e){a.value=e})}}return __extends(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.rowValue},set:function(e){this.rowValue=e,this.data&&this.data.onMatrixRowChanged(this)},enumerable:!0,configurable:!0}),t}(e.Base);e.MatrixRow=t;var n=function(n){function r(e){n.call(this,e),this.name=e,this.columnsValue=[],this.rowsValue=[]}return __extends(r,n),r.prototype.getType=function(){return"matrix"},Object.defineProperty(r.prototype,"hasRows",{get:function(){return this.rowsValue.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"columns",{get:function(){return this.columnsValue},set:function(t){e.ItemValue.setData(this.columnsValue,t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rows",{get:function(){return this.rowsValue},set:function(t){e.ItemValue.setData(this.rowsValue,t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"visibleRows",{get:function(){var e=new Array,n=this.value;n||(n={});for(var r=0;r<this.rows.length;r++)this.rows[r].value&&e.push(new t(this.rows[r].value,this.rows[r].text,this.name+"_"+this.rows[r].value.toString(),this,n[this.rows[r].value]));return 0==e.length&&e.push(new t(null,"",this.name,this,n)),e},enumerable:!0,configurable:!0}),r.prototype.onMatrixRowChanged=function(e){if(this.hasRows){var t=this.value;t||(t={}),t[e.name]=e.value,this.setNewValue(t)}else this.setNewValue(e.value)},r}(e.Question);e.QuestionMatrix=n,e.JsonObject.metaData.addClass("matrix",["columns:itemvalues","rows:itemvalues"],function(){return new n("")},"question"),e.JsonObject.metaData.setPropertyValues("matrix","columns",null,null,function(t){return e.ItemValue.getData(t.columns)},function(t,n){e.ItemValue.setData(t.columns,n)}),e.JsonObject.metaData.setPropertyValues("matrix","rows",null,null,function(t){return e.ItemValue.getData(t.rows)},function(t,n){e.ItemValue.setData(t.rows,n)}),e.QuestionFactory.Instance.registerQuestion("matrix",function(e){var t=new n(e);return t.rows=["Row 1","Row 2"],t.columns=["Column 1","Column 2","Column 3"],t})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(e){function t(t,n){if(void 0===t&&(t=null),void 0===n&&(n=null),e.call(this),this.name=t,this.isKOValueUpdating=!1,this.validators=new Array,this.title=n,this.isKO){this.koValue=ko.observable(this.value);var r=this;this.koValue.subscribe(function(e){r.isKOValueUpdating||(r.value=e)})}}return __extends(t,e),t.prototype.getType=function(){return"multipletextitem"},t.prototype.setData=function(e){this.data=e},Object.defineProperty(t.prototype,"title",{get:function(){return this.titleValue?this.titleValue:this.name},set:function(e){this.titleValue=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){return this.data?this.data.getMultipleTextValue(this.name):null},set:function(e){null!=this.data&&this.data.setMultipleTextValue(this.name,e)},enumerable:!0,configurable:!0}),t.prototype.onValueChanged=function(e){this.isKO&&(this.isKOValueUpdating=!0,this.koValue(e),this.isKOValueUpdating=!1)},t.prototype.getValidatorTitle=function(){return this.title},t}(e.Base);e.MultipleTextItem=t;var n=function(n){function r(e){n.call(this,e),this.name=e,this.itemSize=25,this.items=new Array,this.isMultipleItemValueChanging=!1;var t=this;this.items.push=function(e){return e.setData(t),Array.prototype.push.call(this,e)}}return __extends(r,n),r.prototype.getType=function(){return"multipletext"},r.prototype.AddItem=function(e,n){void 0===n&&(n=null);var r=new t(e,n);return this.items.push(r),r},r.prototype.onValueChanged=function(){n.prototype.onValueChanged.call(this),this.onItemValueChanged()},r.prototype.setkoValue=function(e){n.prototype.setkoValue.call(this,e),this.onItemValueChanged()},r.prototype.onItemValueChanged=function(){if(!this.isMultipleItemValueChanging)for(var e=0;e<this.items.length;e++){var t=null;this.value&&this.items[e].name in this.value&&(t=this.value[this.items[e].name]),this.items[e].onValueChanged(t)}},r.prototype.runValidators=function(){var t=n.prototype.runValidators.call(this);if(null!=t)return t;for(var r=0;r<this.items.length;r++)if(t=(new e.ValidatorRunner).run(this.items[r]),null!=t)return t;return null},r.prototype.getMultipleTextValue=function(e){return this.value?this.value[e]:null},r.prototype.setMultipleTextValue=function(e,t){this.isMultipleItemValueChanging=!0;var n=this.value;n||(n={}),n[e]=t,this.setNewValue(n),this.isMultipleItemValueChanging=!1},r}(e.Question);e.QuestionMultipleText=n,e.JsonObject.metaData.addClass("multipletextitem",["name","title","validators:validators"],function(){return new t("")}),e.JsonObject.metaData.setPropertyClassInfo("multipletextitem","validators","surveyvalidator","validator"),e.JsonObject.metaData.setPropertyValues("multipletextitem","title",null,null,function(e){return e.titleValue}),e.JsonObject.metaData.addClass("multipletext",["!items:textitems","itemSize:number"],function(){return new n("")},"question"),e.JsonObject.metaData.setPropertyValues("multipletext","items","multipletextitem"),e.JsonObject.metaData.setPropertyValues("multipletext","itemSize",null,25),e.QuestionFactory.Instance.registerQuestion("multipletext",function(e){var t=new n(e);return t.AddItem("text1"),t.AddItem("text2"),t})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(e){function t(t){e.call(this,t),this.name=t}return __extends(t,e),t.prototype.getType=function(){return"radiogroup"},t}(e.QuestionCheckboxBase);e.QuestionRadiogroup=t,e.JsonObject.metaData.addClass("radiogroup",[],function(){return new t("")},"checkboxbase"),e.QuestionFactory.Instance.registerQuestion("radiogroup",function(n){var r=new t(n);return r.choices=e.QuestionFactory.DefaultChoices,r})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(t){function n(e){if(t.call(this,e),this.name=e,this.rates=[],this.mininumRateDescription=null,this.maximumRateDescription=null,this.isKO){var n=this;this.koVisibleRateValues=ko.computed(function(){return n.dummyObservable(),n.visibleRateValues})}}return __extends(n,t),Object.defineProperty(n.prototype,"rateValues",{get:function(){return this.rates},set:function(t){e.ItemValue.setData(this.rates,t),this.isKO&&this.dummyObservable(this.dummyObservable()+1)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visibleRateValues",{get:function(){return this.rateValues.length>0?this.rateValues:n.defaultRateValues},enumerable:!0,configurable:!0}),n.prototype.getType=function(){return"rating"},n.prototype.supportComment=function(){return!0},n.prototype.supportOther=function(){return!0},n.defaultRateValues=[],n}(e.Question);e.QuestionRating=t,e.ItemValue.setData(t.defaultRateValues,[1,2,3,4,5]),e.JsonObject.metaData.addClass("rating",["hasComment:boolean","rateValues:itemvalues","mininumRateDescription","maximumRateDescription"],function(){return new t("")},"question"),e.JsonObject.metaData.setPropertyValues("rating","rateValues",null,null,function(t){return e.ItemValue.getData(t.rateValues)},function(t,n){e.ItemValue.setData(t.rateValues,n)}),e.QuestionFactory.Instance.registerQuestion("rating",function(e){return new t(e)})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(e){function t(t){e.call(this,t),this.name=t,this.size=25}return __extends(t,e),t.prototype.getType=function(){return"text"},t.prototype.isEmpty=function(){return e.prototype.isEmpty.call(this)||""==this.value},t}(e.Question);e.QuestionText=t,e.JsonObject.metaData.addClass("text",["size:number"],function(){return new t("")},"question"),e.JsonObject.metaData.setPropertyValues("text","size",null,25),e.QuestionFactory.Instance.registerQuestion("text",function(e){return new t(e)})}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(e){function t(){e.call(this),this.opValue="equal"}return __extends(t,e),Object.defineProperty(t,"operators",{get:function(){return null!=t.operatorsValue?t.operatorsValue:(t.operatorsValue={empty:function(e,t){return!e},notempty:function(e,t){return!!e},equal:function(e,t){return e==t},notequal:function(e,t){return e!=t},contains:function(e,t){return e&&e.indexOf&&e.indexOf(t)>-1},notcontains:function(e,t){return!e||!e.indexOf||-1==e.indexOf(t)},greater:function(e,t){return e>t},less:function(e,t){return t>e},greaterorequal:function(e,t){return e>=t},lessorequal:function(e,t){return t>=e}},t.operatorsValue)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"operator",{get:function(){return this.opValue},set:function(e){e&&(e=e.toLowerCase(),t.operators[e]&&(this.opValue=e))},enumerable:!0,configurable:!0}),t.prototype.check=function(e){t.operators[this.operator](e,this.value)?this.onSuccess():this.onFailure()},t.prototype.onSuccess=function(){},t.prototype.onFailure=function(){},t.operatorsValue=null,t}(e.Base);e.Trigger=t;var n=function(e){function t(){e.call(this),this.pages=[],this.questions=[],this.owner=null}return __extends(t,e),t.prototype.setOwner=function(e){this.owner=e},t.prototype.onSuccess=function(){this.onTrigger(this.onItemSuccess)},t.prototype.onFailure=function(){this.onTrigger(this.onItemFailure)},t.prototype.onTrigger=function(e){if(this.owner)for(var t=this.owner.getObjects(this.pages,this.questions),n=0;n<t.length;n++)e(t[n])},t.prototype.onItemSuccess=function(e){},t.prototype.onItemFailure=function(e){},t}(t);e.SurveyTrigger=n;var r=function(e){function t(){e.call(this)}return __extends(t,e),t.prototype.getType=function(){return"visibletrigger"},t.prototype.onItemSuccess=function(e){e.visible=!0},t.prototype.onItemFailure=function(e){e.visible=!1},t}(n);e.SurveyTriggerVisible=r,e.JsonObject.metaData.addClass("trigger",["operator","!value"]),e.JsonObject.metaData.addClass("surveytrigger",["!name","pages","questions"],null,"trigger"),e.JsonObject.metaData.addClass("visibletrigger",[],function(){return new r},"surveytrigger")}(Survey||(Survey={}));var template;!function(e){var t;!function(e){e.html='<script type="text/html" id="survey-comment">  <input data-bind="value:$data.question.koComment, visible:$data.visible" /></script><div class="sv_main">    <h2 data-bind="visible: (title.length > 0) && showTitle, text: title"></h2>    <!-- ko if: koCurrentPage() -->    <div data-bind="template: { name: \'survey-page\', data: koCurrentPage }"></div>    <p />    <div class="sv_nav" data-bind="visible: showNavigationButtons && !isDesignMode">        <input type="button" data-bind="value: pagePrevText, click: prevPage, visible: !koIsFirstPage()" />  <input type="button" value="Next" data-bind="value: pageNextText, click: nextPage, visible: !koIsLastPage()" />  <input type="button" value="Submit" data-bind="value: completeText, click: completeLastPage, visible: koIsLastPage()" />    </div>    <!-- /ko -->    <!-- ko if: koCurrentPage() == null -->    There is no any visible page or visible question in the survey.    <!-- /ko --></div><script type="text/html" id="survey-page">    <div class="sv_p_title" data-bind="visible: (title.length > 0) && data.showPageTitles, text: koNo() + title"></div>    <!-- ko foreach: { data: questions, as: \'question\' } -->        <!-- ko template: { name: \'survey-question\', data: question } -->        <!-- /ko -->    <!-- /ko --></script><script type="text/html" id="survey-question-checkbox">    <!-- ko foreach: { data: question.visibleChoices, as: \'item\', afterRender: question.koAfterRender}  -->    <div class="sv_qcbc"  data-bind="style:{width: question.koWidth}">            <label class="sv_q_checkbox">                <input type="checkbox"                       data-bind="value: item.value, checked: question.koValue" />                <span data-bind="text: item.text"></span>            </label>    </div>    <!-- /ko -->    <div data-bind="if:question.hasOther">        <div data-bind="template: { name: \'survey-comment\', data: {\'question\': question, \'visible\': question.koOtherVisible } }"></div>    </div></script><script type="text/html" id="survey-question-comment">    <textarea type="text" data-bind="attr: {cols: question.cols, rows: question.rows}, value:question.koValue" /></script><script type="text/html" id="survey-question-dropdown">    <select data-bind="options: question.visibleChoices, optionsText: \'text\', optionsValue: \'value\', value: question.koValue, optionsCaption: question.optionsCaption"></select>    <div data-bind="visible: question.hasOther">        <div data-bind="template: { name: \'survey-comment\', data: {\'question\': question, \'visible\': question.koOtherVisible } }"></div>    </div></script><script type="text/html" id="survey-question-matrix">    <table class="sv_q_matrix">        <thead>            <tr>                <th data-bind="visible: question.hasRows"></th>                <!-- ko foreach: question.columns -->                <th data-bind="text:$data.text"></th>                <!-- /ko -->            </tr>        </thead>        <tbody>            <!-- ko foreach: { data: question.visibleRows, as: \'row\' } -->            <tr>                <td data-bind="visible: question.hasRows, text:row.text"></td>                <!-- ko foreach: question.columns -->                <td>                    <input type="radio" data-bind="attr: {name: row.fullName, value: $data.value}, checked: row.koValue"/>                </td>                <!-- /ko -->            </tr>            <!-- /ko -->        </tbody>    </table></script><script type="text/html" id="survey-question-multipletext">    <table data-bind="foreach: { data:  question.items, as: \'item\' }">        <tr>            <td data-bind="text: item.title"></td>            <td><input type="text" data-bind="attr: {size: question.itemSize}, value: item.koValue" /></td>        </tr>    </table></script><script type="text/html" id="survey-question-radiogroup">    <!-- ko foreach: { data: question.visibleChoices, as: \'item\', afterRender: question.koAfterRender}  -->    <div class="sv_qcbc"  data-bind="style:{width: question.koWidth}">        <label class="sv_q_radiogroup">            <input type="radio" data-bind="name: question.name, attr: {value: item.value}, checked: question.koValue" />            <span data-bind="text: item.text"></span>        </label>    </div>    <!-- /ko -->    <div data-bind="if:question.hasOther">        <div data-bind="template: { name: \'survey-comment\', data: {\'question\': question, \'visible\': question.koOtherVisible } }"></div>    </div></script><script type="text/html" id="survey-question-rating">    <table class="sv_q_rating">        <thead>            <tr>                <th></th>                <!-- ko foreach: question.koVisibleRateValues -->                <th data-bind="text:$data.text"></th>                <!-- /ko -->                <th></th>            </tr>        </thead>        <tbody>            <tr>                <td data-bind="text:question.mininumRateDescription"></td>                <!-- ko foreach: question.koVisibleRateValues -->                <td>                    <input type="radio" data-bind="attr: {name: question.name, value: $data.value}, checked: question.koValue" />                </td>                <!-- /ko -->                <td data-bind="text:question.maximumRateDescription"></td>            </tr>        </tbody>    </table>    <div data-bind="visible: question.hasOther">        <div data-bind="template: { name: \'survey-comment\', data: {\'question\': question } }"></div>    </div></script><script type="text/html" id="survey-question-text">    <input type="text" data-bind="attr: {size: question.size}, value:question.koValue"/></script><script type="text/html" id="survey-question">    <div class="sv_q" data-bind="visible: question.koVisible()">        <div class="sv_q_erbox" data-bind="visible: koErrors().length > 0, foreach: koErrors">            <div data-bind="text:$data.getText()"></div>        </div>        <div class="sv_q_title" data-bind="text: question.koNo() +  (question.isRequired ? question.data.requiredText : \'\') + question.title"></div>        <!-- ko template: { name: \'survey-question-\' + question.getType(), data: question } -->        <!-- /ko -->        <div data-bind="visible: question.hasComment">            Other (please describe)            <div data-bind="template: { name: \'survey-comment\', data: {\'question\': question, \'visible\': true } }"></div>        </div>    </div></script>';
}(t=e.ko||(e.ko={}))}(template||(template={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(t){function n(n,r){void 0===n&&(n=null),void 0===r&&(r=null),t.call(this),this.surveyId=null,this.surveyPostId=null,this.clientId=null,this.sendResultOnPageNext=!1,this.commentPrefix="-Comment",this.title="",this.showNavigationButtons=!0,this.showTitle=!0,this.showPageTitles=!0,this.showPageNumbers=!1,this.showQuestionNumbers="on",this.requiredText="* ",this.pages=new Array,this.triggers=new Array,this.currentPageValue=null,this.valuesHash={},this.onComplete=new e.Event,this.onRendered=new e.Event,this.onCurrentPageChanged=new e.Event,this.onValueChanged=new e.Event,this.onVisibleChanged=new e.Event,this.onQuestionAdded=new e.Event,this.onQuestionRemoved=new e.Event,this.onValidateQuestion=new e.Event,this.onSendResult=new e.Event,this.onGetResult=new e.Event,this.jsonErrors=null,this.mode="normal";var s=this;this.pages.push=function(e){return e.data=s,Array.prototype.push.call(this,e)},this.triggers.push=function(e){return e.setOwner(s),Array.prototype.push.call(this,e)},ko&&(this.dummyObservable=ko.observable(0),this.koCurrentPage=ko.computed(function(){return s.dummyObservable(),s.currentPage}),this.koIsFirstPage=ko.computed(function(){return s.dummyObservable(),s.isFirstPage}),this.koIsLastPage=ko.computed(function(){return s.dummyObservable(),s.isLastPage})),n&&(this.setJsonObject(n),this.surveyId&&this.loadSurveyFromService(this.surveyId,r)),this.onCreating(),this.render(r)}return __extends(n,t),n.prototype.getType=function(){return"survey"},Object.defineProperty(n.prototype,"pagePrevText",{get:function(){return this.pagePrevTextValue?this.pagePrevTextValue:e.surveyStrings.pagePrevText},set:function(e){this.pagePrevTextValue=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pageNextText",{get:function(){return this.pageNextTextValue?this.pageNextTextValue:e.surveyStrings.pageNextText},set:function(e){this.pageNextTextValue=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"completeText",{get:function(){return this.completeTextValue?this.completeTextValue:e.surveyStrings.completeText},set:function(e){this.completeTextValue=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"data",{get:function(){var e={};for(var t in this.valuesHash)e[t]=this.valuesHash[t];return e},set:function(e){if(this.valuesHash={},e)for(var t in e)this.valuesHash[t]=e[t],this.checkTriggers(t,e[t]);this.notifyAllQuestionsOnValueChanged()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"comments",{get:function(){var e={};for(var t in this.valuesHash)t.indexOf(this.commentPrefix)>0&&(e[t]=this.valuesHash[t]);return e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visiblePages",{get:function(){if(this.isDesignMode)return this.pages;for(var e=new Array,t=0;t<this.pages.length;t++)this.pages[t].isVisible&&e.push(this.pages[t]);return e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isEmpty",{get:function(){return 0==this.pages.length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"PageCount",{get:function(){return this.pages.length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"visiblePageCount",{get:function(){return this.visiblePages.length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentPage",{get:function(){var e=this.visiblePages;return null!=this.currentPageValue&&e.indexOf(this.currentPageValue)<0&&(this.currentPage=null),null==this.currentPageValue&&e.length>0&&(this.currentPage=e[0]),this.currentPageValue},set:function(e){var t=this.visiblePages;if(!(null!=e&&t.indexOf(e)<0)&&e!=this.currentPageValue){var n=this.currentPageValue;this.currentPageValue=e,this.updateKoCurrentPage(),this.onCurrentPageChanged.fire(this,{oldCurrentPage:n,newCurrentPage:e})}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isDesignMode",{get:function(){return"designer"==this.mode},enumerable:!0,configurable:!0}),n.prototype.updateKoCurrentPage=function(){this.isKO&&this.dummyObservable(this.dummyObservable()+1)},n.prototype.nextPage=function(){if(this.isLastPage)return!1;if(this.isCurrentPageHasErrors)return!1;this.sendResultOnPageNext&&this.clientId&&this.sendResult(this.surveyPostId,this.clientId,!0);var e=this.visiblePages,t=e.indexOf(this.currentPage);return this.currentPage=e[t+1],!0},Object.defineProperty(n.prototype,"isCurrentPageHasErrors",{get:function(){return null==this.currentPage?!0:this.currentPage.hasErrors()},enumerable:!0,configurable:!0}),n.prototype.prevPage=function(){if(this.isFirstPage)return!1;var e=this.visiblePages,t=e.indexOf(this.currentPage);this.currentPage=e[t-1]},n.prototype.completeLastPage=function(){return this.isCurrentPageHasErrors?!1:(this.onComplete.fire(this,null),this.surveyPostId&&this.sendResult(),!0)},Object.defineProperty(n.prototype,"isFirstPage",{get:function(){return null==this.currentPage?!0:0==this.visiblePages.indexOf(this.currentPage)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLastPage",{get:function(){if(null==this.currentPage)return!0;var e=this.visiblePages;return e.indexOf(this.currentPage)==e.length-1},enumerable:!0,configurable:!0}),n.prototype.getPage=function(e){return this.pages[e]},n.prototype.addPage=function(e){null!=e&&this.pages.push(e)},n.prototype.addNewPage=function(t){var n=new e.Page(t);return this.addPage(n),n},n.prototype.removePage=function(e){var t=this.pages.indexOf(e);0>t||(this.pages.splice(t,1),this.currentPageValue==e&&(this.currentPage=this.pages.length>0?this.pages[0]:null))},n.prototype.getQuestionByName=function(e){for(var t=this.getAllQuestions(),n=0;n<t.length;n++)if(t[n].name==e)return t[n];return null},n.prototype.getQuestionsByNames=function(e){var t=[];if(!e)return t;for(var n=0;n<e.length;n++)if(e[n]){var r=this.getQuestionByName(e[n]);r&&t.push(r)}return t},n.prototype.getPageByQuestion=function(e){for(var t=0;t<this.pages.length;t++){var n=this.pages[t];if(n.questions.indexOf(e)>-1)return n}return null},n.prototype.getPageByName=function(e){for(var t=0;t<this.pages.length;t++)if(this.pages[t].name==e)return this.pages[t];return null},n.prototype.getPagesByNames=function(e){var t=[];if(!e)return t;for(var n=0;n<e.length;n++)if(e[n]){var r=this.getPageByName(e[n]);r&&t.push(r)}return t},n.prototype.getAllQuestions=function(e){void 0===e&&(e=!1);for(var t=new Array,n=0;n<this.pages.length;n++)this.pages[n].addQuestionsToList(t,e);return t},n.prototype.notifyQuestionOnValueChanged=function(e,t){for(var n=this.getAllQuestions(),r=0;r<n.length;r++)n[r].name==e&&n[r].onSurveyValueChanged(t);this.onValueChanged.fire(this,{name:e,value:t})},n.prototype.notifyAllQuestionsOnValueChanged=function(){for(var e=this.getAllQuestions(),t=0;t<e.length;t++)e[t].onSurveyValueChanged(this.getValue(e[t].name))},n.prototype.checkTriggers=function(e,t){for(var n=0;n<this.triggers.length;n++)this.triggers[n].name==e&&this.triggers[n].check(t)},n.prototype.render=function(e){void 0===e&&(e=null);var t=this;e&&"string"==typeof e&&(e=document.getElementById(e)),e&&(this.renderedElement=e),e=this.renderedElement,e&&!this.isEmpty&&(this.onBeforeRender(),this.isKO&&(e.innerHTML=template.ko.html,t.applyBinding()),t.onRendered.fire(t,{}))},n.prototype.sendResult=function(t,n,r){if(void 0===t&&(t=null),void 0===n&&(n=null),void 0===r&&(r=!1),!t&&this.surveyPostId&&(t=this.surveyPostId),t){n&&(this.clientId=n);var s=this;(new e.dxSurveyService).sendResult(t,this.data,function(e,t){s.onSendResult.fire(s,{success:e,response:t})},this.clientId,r)}},n.prototype.getResult=function(t,n){var r=this;(new e.dxSurveyService).getResult(t,n,function(e,t,n,s){r.onGetResult.fire(r,{success:e,data:t,dataList:n,response:s})})},n.prototype.loadSurveyFromService=function(t,n){void 0===t&&(t=null),void 0===n&&(n=null),t&&(this.surveyId=t);var r=this;(new e.dxSurveyService).loadSurvey(this.surveyId,function(e,t,s){e&&t&&(r.setJsonObject(t),r.render(n))})},n.prototype.onBeforeRender=function(){this.updateVisibleIndexes()},n.prototype.applyBinding=function(){this.isKO&&null!=this.renderedElement&&(this.updateKoCurrentPage(),ko.cleanNode(this.renderedElement),ko.applyBindings(this,this.renderedElement))},n.prototype.updateVisibleIndexes=function(){if(this.updatePageVisibleIndexes(this.showPageNumbers),"onPage"==this.showQuestionNumbers)for(var e=this.visiblePages,t=0;t<e.length;t++)this.updateQuestionVisibleIndexes(e[t].questions,!0);else this.updateQuestionVisibleIndexes(this.getAllQuestions(!1),"on"==this.showQuestionNumbers)},n.prototype.updatePageVisibleIndexes=function(e){for(var t=0,n=0;n<this.pages.length;n++)this.pages[n].visibleIndex=this.pages[n].visible?t++:-1,this.pages[n].num=e&&this.pages[n].visible?this.pages[n].visibleIndex+1:-1},n.prototype.updateQuestionVisibleIndexes=function(e,t){for(var n=0,r=0;r<e.length;r++)e[r].setVisibleIndex(t&&e[r].visible?n++:-1)},n.prototype.setJsonObject=function(t){if(t){this.jsonErrors=null;var n=new e.JsonObject;n.toObject(t,this),n.errors.length>0&&(this.jsonErrors=n.errors)}},n.prototype.onCreating=function(){},n.prototype.getValue=function(e){return e&&0!=e.length?this.valuesHash[e]:null},n.prototype.setValue=function(e,t){""==t||null==t?delete this.valuesHash[e]:this.valuesHash[e]=t,this.notifyQuestionOnValueChanged(e,t),this.checkTriggers(e,t)},n.prototype.getComment=function(e){var t=this.data[e+this.commentPrefix];return null==t&&(t=""),t},n.prototype.setComment=function(e,t){e+=this.commentPrefix,""==t||null==t?delete this.valuesHash[e]:this.valuesHash[e]=t},n.prototype.questionVisibilityChanged=function(e,t){this.updateVisibleIndexes(),this.onVisibleChanged.fire(this,{question:e,name:e.name,visible:t})},n.prototype.questionAdded=function(e,t){this.onQuestionAdded.fire(this,{question:e,name:e.name,index:t})},n.prototype.questionRemoved=function(e){this.onQuestionRemoved.fire(this,{question:e,name:e.name})},n.prototype.validateQuestion=function(t){if(this.onValidateQuestion.isEmpty)return null;var n={name:t,value:this.getValue(t),error:null};return this.onValidateQuestion.fire(this,n),n.error?new e.CustomError(n.error):null},n.prototype.getObjects=function(e,t){var n=[];return Array.prototype.push.apply(n,this.getPagesByNames(e)),Array.prototype.push.apply(n,this.getQuestionsByNames(t)),n},n}(e.Base);e.Survey=t,e.JsonObject.metaData.addClass("survey",["title","pages","questions","triggers:triggers","surveyId","surveyPostId","sendResultOnPageNext:boolean","showNavigationButtons:boolean","showTitle:boolean","showPageTitles:boolean","showPageNumbers:boolean","showQuestionNumbers","requiredText","pagePrevText","pageNextText","completeText"]),e.JsonObject.metaData.setPropertyValues("survey","pages","page"),e.JsonObject.metaData.setPropertyValues("survey","questions",null,null,function(e){return null},function(e,t,n){var r=e.addNewPage("");n.toObject({questions:t},r)}),e.JsonObject.metaData.setPropertyValues("survey","showNavigationButtons",null,!0),e.JsonObject.metaData.setPropertyValues("survey","showTitle",null,!0),e.JsonObject.metaData.setPropertyValues("survey","showPageTitles",null,!0),e.JsonObject.metaData.setPropertyValues("survey","showQuestionNumbers",null,"on"),e.JsonObject.metaData.setPropertyChoices("survey","showQuestionNumbers",["on","onPage","off"]),e.JsonObject.metaData.setPropertyValues("survey","requiredText",null,"* "),e.JsonObject.metaData.setPropertyValues("survey","pagePrevText",null,null,function(e){return e.pagePrevTextValue}),e.JsonObject.metaData.setPropertyValues("survey","pageNextText",null,null,function(e){return e.pageNextTextValue}),e.JsonObject.metaData.setPropertyValues("survey","completeText",null,null,function(e){return e.completeTextValue}),e.JsonObject.metaData.setPropertyClassInfo("survey","triggers","surveytrigger","trigger"),e.JsonObject.metaData.setPropertyClassInfo("survey","questions","question")}(Survey||(Survey={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(t){function n(n){t.call(this);var r=this;this.surveyValue=new e.Survey(n),this.surveyValue.showTitle=!1,this.survey.onComplete.add(function(e){r.onComplete()}),this.windowElement=document.createElement("div"),this.isKO&&(this.koExpanded=ko.observable(!1),this.doExpand=function(){r.changeExpanded()})}return __extends(n,t),n.prototype.getType=function(){return"window"},Object.defineProperty(n.prototype,"survey",{get:function(){return this.surveyValue},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isShowing",{get:function(){return this.isShowingValue},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isExpanded",{get:function(){return this.isExpandedValue},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"title",{get:function(){return this.titleValue?this.titleValue:this.survey.title},set:function(e){this.titleValue=e},enumerable:!0,configurable:!0}),n.prototype.show=function(){this.windowElement.innerHTML=this.template,this.isKO&&(ko.cleanNode(this.windowElement),ko.applyBindings(this,this.windowElement)),document.body.appendChild(this.windowElement),this.survey.render(n.surveyElementName),this.isShowingValue=!0},n.prototype.hide=function(){document.body.removeChild(this.windowElement),this.windowElement.innerHTML="",this.isShowingValue=!1},n.prototype.expand=function(){this.expandcollapse(!0)},n.prototype.collapse=function(){this.expandcollapse(!1)},Object.defineProperty(n.prototype,"template",{get:function(){return this.templateValue?this.templateValue:template.window.ko.html},set:function(e){this.templateValue=e},enumerable:!0,configurable:!0}),n.prototype.expandcollapse=function(e){this.isExpandedValue=e,this.isKO&&this.koExpanded(this.isExpandedValue)},n.prototype.changeExpanded=function(){this.expandcollapse(!this.isExpanded)},n.prototype.onComplete=function(){this.hide()},n.surveyElementName="windowSurveyJS",n}(e.Base);e.SurveyWindow=t}(Survey||(Survey={}));var template;!function(e){var t;!function(e){var t;!function(e){e.html='<div class="sv_window">    <div class="sv_window_title"><a href="#" data-bind="click:doExpand" style="width:100%"><span data-bind="text:title"></span></a></div>    <div data-bind="visible:koExpanded">        <div class="sv_window_content" id="windowSurveyJS"></div>    </div></div>'}(t=e.ko||(e.ko={}))}(t=e.window||(e.window={}))}(template||(template={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},Survey;!function(e){var t=function(){function e(){}return e.prototype.replaceText=function(e,t,n){void 0===n&&(n=null),t=this.getId(t,n);var r=this.text.indexOf(t);if(!(0>r||(r=this.text.indexOf(">",r),0>r))){var s=r+1,i="</script>";r=this.text.indexOf(i,s),0>r||(this.text=this.text.substr(0,s)+e+this.text.substr(r))}},e.prototype.getId=function(e,t){var n='id="survey-'+e;return t&&(n+="-"+t),n+'"'},Object.defineProperty(e.prototype,"text",{get:function(){return""},set:function(e){},enumerable:!0,configurable:!0}),e}();e.SurveyTemplateTextBase=t;var n=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),Object.defineProperty(t.prototype,"text",{get:function(){return template.ko.html},set:function(e){template.ko.html=e},enumerable:!0,configurable:!0}),t}(t);e.SurveyTemplateText=n}(Survey||(Survey={}));
//# sourceMappingURL=http://nlp.cs.uic.edu/didactyl/abcde/lib