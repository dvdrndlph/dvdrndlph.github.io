/* abcDE_min.js v5.0.76 */
function AbcDE(){"use strict";function e(){$t&&clearInterval($t),Gt="",Ut="noname.abc",qt=void 0,Lt="",Ft=void 0,Vt=[],Ht=!1,jt=!1,Yt=[],Pt=void 0,Zt=0,Wt=[],Jt=[],Kt={},Qt={},en=[],tn=!1,nn={},rn={},an=[],on=0,Mt=void 0,ln=[]}function t(e){var t,n=nn[e],r=[];for(t in n)n.hasOwnProperty(t)&&r.push(t);return r.sort(function(e,t){return parseInt(e)-parseInt(t)}),r}function n(e,t){if(!e)return console.log("MISSING fingers have no hands."),"";if("x"===e)return e;for(var n=t,r=[],a=e.split(""),i=0;i<a.length;i++){var o=a[i];"<"===o||">"===o?n=o:o.match(/\d/)?r.push(n+o):r.push(o)}return r.join("")}function r(){return"undefined"==typeof Storage?!1:!0}function a(e,t){Gt||(Gt=md5(Lt));var n=e+"_"+t+"_"+Gt;return n}function i(e){if(!r())return{};var t={sequence:""},n=a("sequence",e),i=localStorage.getItem(n)||"";i.match(/[^x&@]/)&&(t.sequence=i),n=a("authority",e);var o=localStorage.getItem(n)||"";t.authority=o,n=a("authority_year",e);var c=localStorage.getItem(n)||"";t.authority_year=c,n=a("transcriber",e);var l=localStorage.getItem(n)||"";t.transcriber=l,n=a("comments",e);var s=localStorage.getItem(n)||"";return t.comments=s,t}function o(e){var t=document.getElementById(e);return t.value?t.value:""}function c(){var e=new Date,t=e.getFullYear()+"-"+sprintf("%02d",e.getMonth()+1)+"-"+sprintf("%02d",e.getDate())+" "+sprintf("%02d",e.getHours())+":"+sprintf("%02d",e.getMinutes())+":"+sprintf("%02d",e.getSeconds()),n={sequence:kt(),authority:o("authority"),authority_year:o("authority_year"),transcriber:o("transcriber"),transcription_date:t,comments:o("comments")};return n}function l(e,t){var n=document.getElementById(e),r=n.value,i=a(e,t);localStorage.setItem(i,r)}function s(e){for(var t=document.getElementsByName(e),n=0;n<t.length;n++){var r=t[n];if(r.checked)return r.id}}function d(e){var t="";if("preset"===e||"output"===e||"keypad"===e||"restore"==e)t=s(e);else{var n=document.getElementById(e);t=n.value}zt[e]=t,localStorage.setItem(e,t)}function u(){var e=document.getElementById("sequence_spinner");return e?e.value:(alert("Sequence DOM element has gone missing."),"1")}function f(){if(!r())return void clearInterval($t);var e=document.getElementById("sequence_spinner");if(!e)return void clearInterval($t);var t=u(),n=a("sequence",t),i=kt();localStorage.setItem(n,i),l("authority",t),l("authority_year",t),l("transcriber",t),l("comments",t)}function p(e){if(St&&St[e])return St[e];var t=s(e);return t?t:""}function g(){var e=p("preset"),t=1;return"last"===e&&(t=Ot.length||1),t}function m(e){for(var t,n=e.split("\n"),r=!1,a={},i=[],o="",c=0;c<n.length;c++){var l=n[c];if(!o&&(t=In.exec(l),t&&t[1]))o=t[1],r=!0;else if(r)if(t=kn.exec(l),t&&t[1]&&t[2])a={sequence:t[2],comments:""},i.push(a);else{if(t=xn.exec(l))break;if(t=Bn.exec(l),t&&t[1]){a.authority=t[1],t[2]&&(a.authority_year=t[2]);continue}if(t=Dn.exec(l),t&&t[1]){a.transcriber=t[1];continue}if(t=Tn.exec(l),t&&t[1]){a.transcription_date=t[1];continue}t=An.exec(l),t&&t[1]&&(a.comments+=t[1]+"\n")}}return i}function v(){var e=document.getElementById("sequence_spinner");e.min=1,e.max=Ot.length||1;var t=g();e.value=t}function h(){var e=p("preset");return e&&"none"!==e?"first"===e?Ot[0]:"last"===e?Ot[Ot.length-1]:"":""}function y(e){if(e){var t=e-1;return parseInt(e)<=Ot.length?Ot[t]:""}return h()}function b(e,t){for(var n=document.getElementsByName(e),r=0;r<n.length;r++){var a=n[r];a.id===t&&(a.checked=!0)}}function E(e,t){var n=document.getElementById(e);t?n.value=t:n.value=""}function _(){b("preset",localStorage.getItem("preset")),b("output",localStorage.getItem("output")),b("restore",localStorage.getItem("restore")),b("keypad",localStorage.getItem("keypad")),E("default_authority",localStorage.getItem("default_authority")),E("default_authority_year",localStorage.getItem("default_authority_year")),E("default_transcriber",localStorage.getItem("default_transcriber"))}function C(e){E("authority",e.authority),E("authority_year",e.authority_year),E("transcriber",e.transcriber),E("comments",e.comments)}function w(e,r){if(e){console.log("Setting fingers: ",e);var a,i,o,c={},l=e.split("@");for(a=0;a<l.length;a++){var s=Me(a);c=[];var d=l[a].split("&");for(i=0;i<d.length;i++){var u=d[i];c=c.concat(B(yn,u))}for(var f=t(a),p=0;p<f.length;p++){var g=f[p],m=nn[a][g];if(m.sort(ue),m[0].grace){m[0][r]="";for(var v=0;v<m[0].size;v++)o=c.shift(),o||(console.log("Preset fingering MISSING for note:"),ce("preset grace note",m[0])),o=n(o,s),s=yt(o,s),m[0][r]+=o}var h=Ee(m),y=be(h);for(v=0;v<y.length;v++)for(var b=y[v],E=0;E<h[b].length;E++){var _=h[b][E];_[r]=""}for(v=0;v<y.length;v++)for(var b=y[v],E=0;E<h[b].length;E++){var _=h[b][E];_.grace||(_[r]||(_[r]=""),o=c.shift(),o||(console.log("Preset fingering MISSING for note:"),ce("preset pit note",_)),o=n(o,s),s=yt(o,s),_[r]+=o)}}}}}function I(e,t){var n=t.sequence,r=t.sequence,a=!0,i=p("preset");i&&"none"!==i||(a=!1,n="");var o=!1;if(e&&e.sequence&&e.sequence!==n){var c=p("restore");o="always"===c?!0:"never"===c?!1:confirm("You have previously entered data for this piece. Do you want to restore them?"),o&&(n=e.sequence)}o?C(e):a&&C(t),w(n,"fingering"),w(r,"preset_fingering"),$t=setInterval(function(){f()},qn)}function k(){var e=u(),t=i(e),n=y(e);I(t,n)}function x(){if(Lt){var e=confirm("All changes you have made to this fingering sequence will be discarded, and the initial sequence will be restored. Are you sure you want to proceed?");if(e){var t=u(),n=y(t);I(void 0,n),Ae(),Pt=Jt[0][0][0],ft(Pt)}}}function B(e,t){if(!t)return[];for(var n,r=[],a=0,i=0;null!=(n=e.exec(t));){i=e.lastIndex;var o;o=a===i?t.substr(a):t.substr(a,i-a),r.push(o),a=e.lastIndex}var c=t.substr(a);if(c){var l="";r.length>0&&(l=r.pop()),l+=c,r.push(l)}return r}function D(){var e=window.open(gn,"_blank");e.focus()}function T(e){et();var t=document.getElementById("modal_wrapper"),n=document.getElementById("modal_window");t.className="overlay";var r=n.offsetHeight-document.documentElement.clientHeight;r>0&&(n.style.maxHeight=parseInt(window.getComputedStyle(n).height)-r+"px"),n.style.marginTop=-n.offsetHeight/2+"px",n.style.marginLeft=-n.offsetWidth/2+"px",e.preventDefault?e.preventDefault():e.returnValue=!1}function A(){Rt>Xn&&(Rt-=Gn,Ae())}function S(){Un>Rt&&(Rt+=Gn,Ae())}function q(e){d("preset"),d("output"),d("restore"),d("keypad"),d("default_authority"),d("default_authority_year"),d("default_transcriber");var t=document.getElementById("modal_wrapper");t.className="",V(),Qe(),e.preventDefault?e.preventDefault():e.returnValue=!1}function N(e){var t=e.slice(0,100);if(-1==t.indexOf("<?xml"))return!1;var n=t.match(/encoding="([^"]+)"/),r="utf-8";return n&&2==n.length&&(r=n[1]),r}function L(e){var t={},n=$.parseXML(e),r=vertaal(n,t),a=r[0],i=r[1];return i&&console.log("xml2abc ERROR: "+i),a||alert("Unable to open MusicXML file: "+i),a}function F(e,t){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,t,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(e,t)):n=null,n}function P(e){var t=e.split(".");return t[t.length-1]}function M(e){var t="";try{var n=new JSZip(e);$.each(n.files,function(e,n){t=n.asText()})}catch(r){return alert("Could not open compressed MusicXML file: "+r.message),""}var a=N(t);return"UTF-8"!==a?(alert("Input mxl is not UTF-8 encoded. Cannot open."),""):t=L(t)}function H(e){var t=P(e),n='The server hosting file does not allow access from this domain. Please download the file outside abcDE and then "Choose file" to work with it.',r=F("GET",e);return r?("mxl"===t&&(r.responseType="arraybuffer"),r.onload=function(){console.log("File has been retrieved.");var e="";if("mxl"===t){if(e=M(r.response),!e)return}else{e=r.responseText;var n=N(e);if(n){if(!/^utf/i.test(n))return void alert("Input xml is not UTF-8 encoded. Cannot open.");e=L(e)}}e&&(document.getElementById(Ln).value=e,nt())},r.onerror=function(){alert(n)},void r.send()):void alert(n)}function R(){var e="Please enter URL for file to open.",t=fn+"/abc/OpenWTC/pf02.abc",n=window.prompt(e,t);null!==n&&H(n)}function z(e){var t=new FileReader,n="";t.onload=function(e){try{var t=new JSZip(e.target.result);$.each(t.files,function(e,t){n=t.asText()})}catch(e){return void alert("Could not open compressed MusicXML file: "+e.message)}var r=N(n);return"UTF-8"!==r?void alert("Input xml is not UTF-8 encoded. Cannot open."):(n=L(n),document.getElementById(Ln).value=n,nt(),void 0)},t.readAsArrayBuffer(e)}function O(){var e=document.getElementById("file_input"),t=e.files;if(!t.length)return void alert("Please select a valid abc file.");var n=t[0],r=P(n.name);if("mxl"===r)return void z(n);var a=!1,i=new FileReader;i.onload=function(e){var t=N(i.result),r=new FileReader;t?a=!0:t="UTF-8",r.onload=function(e){var t="";t=a?L(r.result):e.target.result,document.getElementById(Ln).value=t,nt()},r.readAsText(n,t)},i.readAsText(n,"UTF-8")}function G(){sn=sn?!1:!0}function U(){dn?(dn=!1,Qe()):(dn=!0,et()),j()}function X(e,t){for(var n=e.children,r=0;r<n.length;r++)n[r].style.display=t}function V(){var e=document.getElementById(Rn),t=document.getElementById("number_div"),n=document.getElementById("symbol_div"),r=p("keypad");if("show"===r)e.style.display="block",t.style.display="block",n.style.display="block",X(t,"inline"),X(n,"inline");else{X(n,"none"),X(t,"none");var a=p("qualtrics");if(a){var i=document.getElementById("q_next");i.style.display="inline";var o=document.getElementById("q_back");o.style.display="inline"}else t.style.display="block",n.style.display="block",e.style.display="none"}}function j(){var e=document.getElementById(Hn);dn?e.style.display="block":e.style.display="none"}function Y(e){var t=e.keyCode||e.which;t=String.fromCharCode(t);var n=/[0-9]/;n.test(t)||(e.returnValue=!1,e.preventDefault&&e.preventDefault())}function Z(e,t,n,r,a,i){var o=document.createElement("input");o.type="text",o["class"]=r,o.id=t,a&&(o.onkeypress=a),"year"===r&&(o.size="4");var c=document.createElement("label");c.htmlFor=t,c.appendChild(document.createTextNode(n)),e.appendChild(c),e.appendChild(o),i&&e.appendChild(document.createElement("br"))}function W(e,t,n,r,a){var i=document.createElement("textarea");i["class"]=r,i.id=t,i.rows=a;var o=document.createElement("label");o.htmlFor=t,o.appendChild(document.createTextNode(n)),e.appendChild(o),e.appendChild(i)}function J(e,t,n){var r=document.createElement("label");r["class"]=n;var a=document.createTextNode(t);r.appendChild(a),e.appendChild(r)}function K(e,t,n,r,a,i,o){var c=document.createElement("div");c["class"]="radio_div",J(e,t,"prompt");for(var l=0;l<r.length;l++){var s=document.createElement("input");s.type="radio",s.id=r[l],s.id===i&&(s.checked=!0),s.name=n,c.appendChild(s),J(c,a[l],"radio_label");var d=document.createElement("span");d.innerHTML="&nbsp;&nbsp",c.appendChild(d)}e.appendChild(c),o&&e.appendChild(document.createElement("br"))}function Q(){var e=document.getElementById(Pn),t=document.createElement("div");t.id="modal_wrapper",e.appendChild(t);var n=document.createElement("div");n.id="modal_window",t.appendChild(n);var r=document.createElement("div");r.style.textAlign="right";var a=document.createElement("a");a.id="modal_close",a.href="#",a.innerHTML="Close <b>X</b>",r.appendChild(a),a.addEventListener("click",q,!1),n.appendChild(r);var i=document.createElement("h3");i.innerText="Preferences",n.appendChild(i);var o="restore",c=["always","never","ask"],l=["Always","Never","Ask"];K(n,"Restore Data",o,c,l,"ask",!0);var o="output",c=["append","replace"],l=["Append","Replace"];K(n,"Output",o,c,l,"append",!0),o="preset";var c=["first","last","none"],l=["First","Last","None"];K(n,"Preset",o,c,l,"first",!0),o="keypad";var c=["show","hide"],l=["Show","Hide"],s="hide",d="ontouchstart"in window;d&&(s="show"),K(n,"Keypad",o,c,l,s,!0),Z(n,"default_authority","Default Authority","name",void 0,!0),Z(n,"default_authority_year","Year","year",Y,!0),Z(n,"default_transcriber","Transcriber Name","name",void 0,!0)}function ee(e,t,n){var r=document.createElement("input");r.type="button",r["class"]="keypad-button",r.id=t,r.value=n,r.onclick=function(){Ve(n)},e.appendChild(r)}function te(e){var t=p("qualtrics"),n=pt(Lt),r="abcDF_"+n,a="abcD_"+n,i=kt();Qualtrics.SurveyEngine.setEmbeddedData(r,i);var o=Tt();Qualtrics.SurveyEngine.setEmbeddedData(a,o),f();for(var c=document.getElementById(Nn);c.firstChild;)c.removeChild(c.firstChild);c.remove(),un=!1,$t&&clearInterval($t),t.enableNextButton(),t.enablePreviousButton(),"q_next"===e?t.clickNextButton():t.clickPreviousButton()}function ne(e,t,n){var r=document.createElement("input");r.type="button",r["class"]="keypad-button",r.id=t,r.value=n,r.onclick=function(){te(t)},e.appendChild(r)}function re(e,t,n,r){var a=document.createElement("input");a.id=t,a["class"]="keypad_button",a.type="image",a.src=mn+"/"+n,a.alt=r,a.onclick=function(){Le(t)},e.appendChild(a)}function ae(){var e=document.getElementById(Rn),t=document.createElement("number_div");t.id="number_div";var n=document.createElement("symbol_div");n.id="symbol_div",e.appendChild(n),e.appendChild(document.createElement("br")),e.appendChild(t),re(t,"undo","action-undo.svg","undo"),re(t,"redo","action-redo.svg","redo"),ee(t,"one","1"),ee(t,"two","2"),ee(t,"three","3"),ee(t,"four","4"),ee(t,"five","5"),re(t,"pencil","target.svg","...");var r=p("qualtrics");r&&(ne(t,"q_back","BACK"),ne(t,"q_next","NEXT")),re(n,"previous","arrow-circle-left.svg","<-"),re(n,"next","arrow-circle-right.svg","->"),ee(n,"comma",","),ee(n,"slash","/"),ee(n,"open_paren","("),ee(n,"close_paren",")"),ee(n,"toggle","T"),re(n,"backspace","delete.svg","<]")}function ie(){var e=document.getElementById(Hn);e["class"]="right_aligned",e.align="center",Z(e,"authority","Authority","name",void 0,!1),Z(e,"authority_year","Year","year",Y,!0),Z(e,"transcriber","Transcriber","name",void 0,!0),W(e,"comments","Comments","comments",5,!0)}function oe(){if(!un){Q(),ie(),j();var e=mn+"/download_36_x4.png",t="36",n=document.getElementById(Mn),r=document.createElement("table"),a=document.createElement("tbody"),i=document.createElement("tr");n.appendChild(r),r.appendChild(a),r.style.backgroundColor="LightGray",r.align="center",a.appendChild(i);var o=document.createElement("p");o.setAttribute("id","downloadify");var c=document.createElement("td");c.appendChild(o),i.appendChild(c);var l=document.createElement("input");l.id="sequence_spinner",l.min="1",l.max="999",l.size=3,l.type="number",l.alt="fingering_number",l.value=1,l.onchange=_t,c=document.createElement("td"),J(c,"Sequence","sequence_prompt"),c.appendChild(l),i.appendChild(c),St.preset_select||(c.style.display="none");var s=document.createElement("input");s.type="image",s.src=mn+"/eye.svg",s.width=t,s.alt="View",s.onclick=Ct,c=document.createElement("td"),c.appendChild(s),i.appendChild(c);var d=document.createElement("input");d.type="image",d.src=mn+"/print.svg",d.width=t,d.alt="Print...",d.onclick=Et;var c=document.createElement("td");c.appendChild(d),i.appendChild(c),c=document.createElement("td");var u=document.createElement("input");u.type="checkbox",u.value="annotated",u.checked=sn,u.id="view_annotated",u.onclick=G;var f=document.createElement("label");f.htmlFor="view_annotated",f.appendChild(document.createTextNode("Annotated")),c.appendChild(u),c.appendChild(f),i.appendChild(c);var p=document.createElement("input");p.type="image",p.src=mn+"/reload.svg",p.width=t,p.alt="reset",p.onclick=x,c=document.createElement("td"),c.appendChild(p),i.appendChild(c);var g=document.createElement("input");g.type="image",g.src=mn+"/globe.svg",g.width=t,g.alt="URL",g.onclick=R,c=document.createElement("td"),c.appendChild(g),i.appendChild(c),St.url_input||(g.style.visibility="hidden");var m=document.createElement("input");m.setAttribute("type","file"),m.setAttribute("accept","text/vnd.abc"),m.onchange=O,m.setAttribute("id","file_input"),c=document.createElement("td"),c.appendChild(m),i.appendChild(c),St.file_input||(m.style.visibility="hidden"),c=document.createElement("td"),u=document.createElement("input"),u.type="checkbox",u.value="comment",u.checked=dn,u.id="show_metadata",u.onclick=U,f=document.createElement("label"),f.htmlFor="show_metadata",f.appendChild(document.createTextNode("Comment")),c.appendChild(u),c.appendChild(f),i.appendChild(c);var v=document.createElement("input");v.type="image",v.src=mn+"/zoom-out.svg",v.alt="Zoom In",v.width=t,v.onclick=A,c=document.createElement("td"),c.appendChild(v),i.appendChild(c);var h=document.createElement("input");h.type="image",h.src=mn+"/zoom-in.svg",h.alt="Zoom In",h.width=t,h.onclick=S,c=document.createElement("td"),c.appendChild(h),i.appendChild(c);var y=document.createElement("input");y.type="image",y.src=mn+"/cog.svg",y.alt="Preferences...",y.width=t,y.onclick=T,c=document.createElement("td"),c.appendChild(y),i.appendChild(c);var b=document.createElement("input");b.type="image",b.src=mn+"/info.svg",b.alt="Help",b.width=t,b.onclick=D,c=document.createElement("td"),c.appendChild(b),i.appendChild(c),Downloadify.create("downloadify",{filename:function(){return Ut},data:function(){var e=Te(),t=Ke(e);return t},onComplete:function(){alert("Your file has been saved.")},onCancel:function(){alert("File save has been cancelled.")},onError:function(){alert("File save failed!")},transparent:!1,swf:vn+"/downloadify.swf",downloadImage:e,width:t,height:t,append:!1}),ae(),un=!0}}function ce(e,t){console.log(e+" Line: "+t.line+" Start: "+t.start+" Time: "+t.time+" String: "+t.string+" Size: "+t.size+" Pitch: "+t.pitches.join(",")+" Voice: "+t.voice+" Staff: "+t.staff+" Grace: "+t.grace)}function le(e,t){if("note"!=e[t.type]&&"grace"!=e[t.type])return{};var n={};n.line=-1,n.grace=!1,n.anno_start=t.istart;var r=0,a=[];if("note"===e[t.type]){r=t.notes.length;for(var i=0;r>i;i++)a.push(t.notes[i].pit);a.sort(function(e,t){return parseInt(e)-parseInt(t)}),n.start=t.istart,n.end=t.iend}else{var o=[],c=[];n.grace=!0,n.start=t.extra.istart,r=1;var l=t.extra;if(!l.notes)return alert("Who turned off the notes?!"),{};for(;;){if(l.notes.length>1&&alert('Chords not supported in a grace "note."'),o.push(l.istart),c.push(l.iend),a.push(l.notes[0].pit),!l.next){n.end=l.iend;break}l=l.next,r++}n.starts=o,n.stops=c}return n.time=t.time,n.size=r,n.pitches=a,n.string=Lt.substring(n.start,n.end),n.voice=t.v,n.staff=t.st,Wt.push(n),Kt[t.istart]=n,n.staff in nn||(nn[n.staff]={}),n.time in nn[n.staff]||(nn[n.staff][n.time]=[]),nn[n.staff][n.time].push(n),n}function se(){var e=8.5;1!==Rt&&(e*=Rt);var t='width="'+e+'in"';return t}function de(){this.read_file=function(e){return""},this.errmsg=function(e,t,n){var r=document.getElementById($n);t?r.innerHTML+='<b onclick="gotoabc('+t+","+n+')" style="cursor: pointer; display: inline-block">'+e+"</b><br/>\n":r.innerHTML+=e+"<br/>\n"},this.img_out=function(e){var t=/<svg /;e.match(t)&&Zt++,Nt+=e},this.anno_start=function(e,t,n,r,a,i,o){!tn&&t in Kt?Kt[t].line=Zt:"grace"===e&&console.log(e+" ANNO_START start: "+t+" stop: "+n),an.push([t,n]),Ft.out_svg('<g class="e_'+t+'">\n')},this.anno_stop=function(e,t,n,r,a,i,o){"grace"===e&&console.log(e+" ANNO_STOP start: "+t+" stop: "+n),Ft.out_svg("</g>\n"),Ft.out_svg('<rect class="abcr _'+t+'" x="'),Ft.out_sxsy(r,'" y="',a),Ft.out_svg('" width="'+i.toFixed(2)+'" height="'+o.toFixed(2)+'"/>\n')},this.get_abcmodel=function(e,t,n){if(!tn){console.log(n);for(var r=0;r<t.length;r++){console.log("Voice: "+r);var a=t[r].st;rn[r]=a}for(var i=e;i;)le(n,i),i=i.ts_next}},this.page_format=!1,this.imagesize=se()}function ue(e,t){var n=parseInt(e.time)-parseInt(t.time);return 0!==n?n:(e.grace&&t.grace&&alert("Conflicting grace notes."),e.grace?-1:t.grace?1:e.pitches[e.pitches.length-1]<t.pitches[0]?-1:e.pitches[0]>t.pitches[t.pitches.length-1]?1:e.voice<t.voice?(console.log("NOTES SORTED BY VOICE!"),-1):1)}function fe(){for(var e,t,n,r=0;r<Wt.length;r++)e=Wt[r],t=e.line,n=e.staff,t in Jt||(Jt[t]=[],Jt[t][0]=[],Jt[t][1]=[]),Jt[t][n].push(e);for(t=0;t<Jt.length;t++)for(n=0;2>n;n++){var a=Jt[t][n];a.sort(ue)}var i,o;for(n=0;2>n;n++)for(t=0;t<Jt.length;t++){var a=Jt[t][n];for(r=0;r<a.length;r++)i=a[r],o?(o.next_note=i,i.prior_note=o,o=i):(o=i,i.prior_note=void 0)}i.next_note=void 0}function pe(){var e;for(e in Kt)Kt.hasOwnProperty(e)&&en.push(e);en.sort(function(e,t){return parseInt(e)-parseInt(t)})}function ge(e){var t="$1";return e.match(_n)&&(t="$1"),e.match(En)&&(t="$2"),t}function me(e,t){for(var n=ge("<"),r=ge(">"),a=e.replace(/[\)\(]/g,""),i=B(hn,a),o=ve(t),c='"'+o,l=0;l<i.length;l++)i[l]=i[l].replace(En,n),i[l]=i[l].replace(_n,r),c+=i[l];return c+='"'}function ve(e){var t="^";return 1==e&&(t="_"),t}function he(e,t,n){for(var r=!1,a=ge("<"),i=ge(">"),o=[],c=0;c<e.length;c++){var l="",s="x";if(e[c]&&"x"!==e[c])r=!0,s=e[c];else if(!n)break;if(s.match(/^\(/))l=me(s,t);else{s=s.replace(En,a),s=s.replace(_n,i);var d=ve(t);l='"'+d+s+'"'}o.unshift(l)}var u="";return r&&(u=o.join("")),u}function ye(e){var t=e.fingering;if("x"===t)return"";t=t.replace(bn,"");var n=B(hn,t),r=he(n,e.staff,!1);return r}function be(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t.sort(function(e,t){return parseInt(e)-parseInt(t)}),t}function Ee(e){for(var t=[],n={},r=0;r<e.length;r++){var a=e[r];if(!a.grace)for(var i=0;i<a.pitches.length;i++){var o=a.pitches[i];t.push(o),o in n||(n[o]=[]),n[o].push(a)}}for(r=0;r<n.length;r++)n[r].sort(ue);return n}function _e(e){for(var t=Ee(e),n=be(t),r=[],a=0;a<n.length;a++)for(var i=n[a],o=0;o<t[i].length;o++)for(var c=t[i][o],l=c.fingering,s=B(hn,l),d=0;d<c.pitches.length;d++){var u=c.pitches[d];u===parseInt(i)&&("x"!==s[d]?r.push(s[d]):r.push(""))}return r}function Ce(e){for(var t=0,n=0;n<e.length;n++)e[n].grace&&t++;return t}function we(e){if(e.size>1&&console.log("BIGGIE"),e.grace)return ye(e);var t=nn[e.staff][e.time],n=Ce(t),r=t.length-n;if(2>r)return ye(e);t.sort(ue);var a=t[0];if(t[0].grace&&(a=t[1]),e!==a)return"";var i=_e(t);return he(i,e.staff,!0)}function Ie(e){for(var t=[],n=e.string,r=e.starts,a=e.stops,i=[],o=[],c=0;c<r.length;c++)i.push(r[c]-r[0]),o.push(a[c]-r[0]);for(var l=0;l<i.length;l++){var s=n.substring(i[l],o[l]);t.push(s)}return t}function ke(e){var t="{",n=Ie(e),r=[];e.fingering&&(r=B(hn,e.fingering));for(var a=0;a<n.length;a++){if(r[a]){var i=r[a];i=i.replace(Cn,""),t+="!"+i+"!"}t+=n[a]}return t+="}"}function xe(e){if(e.fingering)return!0;for(var t=nn[e.staff][e.time],n=0;n<t.length;n++)if(!t[n].grace&&t[n].fingering)return!0;return!1}function Be(){if(void 0!==Mt)return Mt;Mt=!1;for(var e=!1,t=!1,n=Lt.split("\n"),r=0;r<n.length;r++){var a=n[r];if(a.match(/^%%setfont-1/)&&(e=!0),a.match(/^%%setfont-2/)&&(t=!0),e&&t){Mt=!0;break}}return Mt}function De(){if(void 0!==qt)return qt;qt=!1;for(var e=0;e<en.length;e++){var t=en[e],n=Kt[t];if(n.grace){qt=!0;break}}return qt}function Te(){var e="";Be()||(e+=Jn+"\n",De()&&(e+=Kn+"\n"));for(var t=0,n=0;n<en.length;n++){var r=en[n],a=Kt[r],i="";if(a.grace){if(i=Lt.substring(parseInt(t),parseInt(a.start-1)),t=a.end+1,e+=i,a.fingered_start=e.length+a.anno_start-a.start+1,a.fingering&&"x"!==a.fingering){var o=B(hn,a.fingering);a.fingered_start+=3*o.length}e+=ke(a)}else{var c=parseInt(a.start),l=parseInt(a.end);i=Lt.substring(parseInt(t),c),e+=i,t=l,xe(a)&&(e+=we(a)),a.fingered_start=e.length,e+=a.string}Qt[a.fingered_start]=a}return e+=Lt.substring(t)}function Ae(){on++,console.log("RERENDERING NUMBER "+on);var e=(new Date).getTime(),t=document.getElementById(On),n=document.getElementById($n),r=new de;Ft=new Abc(r);var a=Te(),i=(new Date).getTime(),o=i-e;console.log("MY LAG: "+o),document.getElementById(Ln).value=a,e=(new Date).getTime(),Nt="",Ft.tosvg("edit",'%%bgcolor white\n%%beginsvg\n<style type="text/css">\n	rect.abcr {fill:#a08000; fill-opacity:0}\n	rect.abcr:hover {fill-opacity:0.3}\n</style>\n%%endsvg\n'),Zt=0,n.innerHTML="",an=[];try{Ft.tosvg(Ut,document.getElementById(Ln).value)}catch(c){return void alert(c.message+"\nabc2svg tosvg bug - stack:\n"+c.stack)}try{t.innerHTML=Nt}catch(c){return void alert(c.message+"\nabc2svg image bug - abort:\n"+c.stack)}setTimeout(function(){for(var e,t=document.getElementsByClassName("abcr"),n=t.length;--n>=0;)e=t[n],e.onclick=function(){it(this)},e.ondblclick=function(){lt(this)}},300),i=(new Date).getTime(),o=i-e,console.log("LIB LAG: "+o),V()}function Se(e){return null==e.which?String.fromCharCode(e.keyCode):0!=e.which&&0!=e.charCode?String.fromCharCode(e.which):null}function qe(e){if(console.log(String.fromCharCode(e)+" --> "+e),e===jn){$e(),Yt=[];var t=Ge();t.length>0?(Pt.fingering="",Ae()):Pt.prior_note&&(Pt=Pt.prior_note),ft(Pt)}else if(e==Yn||e==Wn)Xe(),Yt=[],Pt.next_note&&(Pt=Pt.next_note);else if(e==Zn)Xe(),Yt=[],Pt.prior_note&&(Pt=Pt.prior_note);else{if(e!=Vn)return!1;ct()}return ft(Pt),!0}function Ne(e){var t=e.keyCode,n=qe(t);return n&&e.preventDefault(),n}function Le(e){var t=Yn;switch(e){case"previous":t=Zn;break;case"next":t=Wn;break;case"backspace":t=jn;break;case"pencil":t=Vn}return qe(t)}function Fe(){cn?(cn=!1,document.body.style.backgroundColor="white"):(cn=!0,document.body.style.backgroundColor="black"),ft(Pt)}function Pe(e){return cn?0==e.staff?"<":">":Me(e.staff)}function Me(e){return 0==e?">":"<"}function He(e,t){var n=Pe(t),r=e.fingering.strike.hand||n,a=r+e.fingering.strike.digit;return e.fingering.release&&(r=e.fingering.release.hand||n,a+=","+r+e.fingering.release.digit),a}function Re(e,t){var n,r,a="",i=[];if(e.first.ornaments){for(i=e.first.ornaments[0],a+="(",r=0;r<i.length;r++)n=i[r],a+=He(n,t);a+=")"}else a+=He(e.first,t);if(e.last&&e.last.ornaments){for(i=e.last.ornaments[0],a+="(",r=0;r<i.length;r++)n=e.last.ornaments[r],a+="/"+He(n,t);a+=")"}else e.last&&(a+="/"+He(e.last,t));return a}function ze(e){Pt.fingering="";for(var t=0;t<Pt.size;){var n=e.shift(),r=Re(n,Pt);if(Pt.fingering+=r,t++,0===e.length)break}if(t===Pt.size)return!0;for(;t<Pt.size;t++)Pt.fingering+="x";return!1}function Oe(e){for(var t=e.upper.score_fingerings;t.length>0;)ze(t)&&Pt.next_note&&(Pt=Pt.next_note);jt&&(Pt=Pt.prior_note)}function $e(){jt=!1,Vt=[],Yt=[],Ae(),ft(Pt)}function Ge(){for(var e=Pt.fingering.split(""),t=[],n=0;n<e.length;n++){var r=e[n];"x"===r?t.push(""):t.push(r)}return t}function Ue(){for(var e=Ge();e.length;){var t=e.pop();t&&Vt.unshift(t)}}function Xe(){var e=!1;Yt.length>0&&(Array.prototype.unshift.apply(Vt,Yt),e=!0),Yt=[];for(var t=Vt.length-1;t>=0&&/[,\/\(]/.test(Vt[t]);t--)Yt.unshift(Vt.pop());if(0!==Vt.length){if(/[,\/]/.test(Vt[0])&&(e=!0),jt){var n=Ge();")"===n[n.length-1]?n.pop():(alert("Something wonky with parentheses."),$e()),Array.prototype.unshift.apply(Vt,n),jt=!1}e?Pt.prior_note?(Pt=Pt.prior_note,Ue()):Vt.pop():Pt.fingering.match(/x/)&&Ue();for(var r=Vt.join(""),a=0,i=1;;)try{var o=Abcdf_Parser.parse(r);jt=!1,2===i&&(jt=!0),Oe(o);break}catch(c){if(1===i?Vt.push(")"):2===i?(Vt.pop(),Vt.pop(),a++):3===i&&(i=0),0==Vt.length)break;r=Vt.join(""),i++}Vt=[],Ae(),ft(Pt)}}function Ve(e){clearTimeout(Xt);var t=!1;return/[\(\)\/,1-5]/.test(e)&&(Vt.push(e),t=!0),("t"===e||"T"===e)&&(Xe(),Fe(),t=!0),Xt=setTimeout(Xe,Sn),console.log("Done "+Xt),t}function je(e){var t=Se(e).toLowerCase();return Ve(t)}function Ye(e){St||(St=e)}function Ze(){return 5}function We(){var e="% abcDidactyl v"+Ze();return e}function Je(e){var t="% abcD fingering "+e+": ";return t}function Ke(e){var t=[],n=[];n.push(We());for(var r,a=m(e),i=e.split("\n"),o="",l=!1,s=0;s<i.length;s++){var d=i[s];o?l?t.push(d):(r=xn.exec(d),r&&(l=!0)):(r=In.exec(d),r&&r[1]?o=r[1]:t.push(d))}var f=u(),g=c();if("replace"===p("output")){var v=f-1;a[v]=g}else a.push(g);for(var h,y,b,E,_,s=0;s<a.length;s++){var C=s+1;try{Abcdf_Parser.parse(a[s].sequence)}catch(w){alert("Bad abcDF parse of fingering string: "+w.message+w.stack)}h=Je(C)+a[s].sequence,n.push(h),a[s].authority&&(y="% Authority: "+a[s].authority,a[s].authority_year&&(y+=" ("+a[s].authority_year+")"),n.push(y)),a[s].transcriber&&(b="% Transcriber: "+a[s].transcriber,n.push(b)),a[s].transcription_date&&(E="% Transcription date: "+a[s].transcription_date,n.push(E));for(var _=a[s].comments.split("\n"),I=0;I<_.length;I++)(I!==_.length-1||_[I])&&n.push("% "+_[I])}n.push("% abcDidactyl END");var k=n.join("\n"),x=t.join("\n");return k+"\n"+x}function Qe(){document.body.addEventListener("keydown",Ne),document.body.addEventListener("keypress",je)}function et(){document.body.removeEventListener("keydown",Ne),document.body.removeEventListener("keypress",je)}function tt(){if(!un){var e=document.getElementById(Nn);e.align="center";var t=document.getElementById(Ln);t||(t=document.createElement("div"),t.id=Ln,t.style.display="none",e.appendChild(t)),t["class"]=Fn;var n=document.createElement(Pn);n.id=Pn,e.appendChild(n);var r=document.createElement(Mn);r.id=Mn,e.appendChild(r);var a=document.createElement(Hn);a.id=Hn,e.appendChild(a);var i=document.createElement(zn);i.id=zn,e.appendChild(i);var o=document.createElement(On);o.id=On,i.appendChild(o);var c=document.createElement($n);c.id=$n,i.appendChild(c);for(var l=0;7>l;l++)i.appendChild(document.createElement("br"));var s=document.createElement(Rn);s.id=Rn,e.appendChild(s)}}function nt(){tt(),e(),oe(),_(),Lt=document.getElementById(Ln).value,Lt&&(Ot=m(Lt),v(),st(),Pt=Jt[0][0][0],ft(Pt),Qe()),V()}function rt(e){Ht||(Ye(e),nt());var t=p("qualtrics");t&&(t.disableNextButton(),t.disablePreviousButton())}function at(){e(),Lt=document.getElementById(Ln).value,st(),Pt=Jt[0][0][0],ft(Pt),Qe()}function it(e){console.log("Processing note click....");var t=e.getAttribute("class");console.log("Click "+t);var n=t.split("_"),r=n[1];if(r in Qt){var a=Qt[r];ce("process_note_click",a),ft(a),Pt=a}}function ot(e){Pt=Jt[0][0][0];var t=u(),n=c();n.sequence=e;var r=i(t);I(r,n),Ae(),ft(Pt)}function ct(){$e();var e="";Pt.preset_fingering&&(e+="Preset (recommended) fingering: "+Pt.preset_fingering+"\n\n"),e+="Please enter abcD fingering string for the selected note.";var t=Pt.fingering,n=window.prompt(e,t);try{if(null===n)return;var r=Abcdf_Parser.parse(n);Oe(r),Ae(),ft(Pt)}catch(a){alert("Bad abcDF parse of fingering string: "+a.message+a.stack)}}function lt(e){console.log("Processing note double-click...."),it(e),ct()}function st(){var e=new de,t=document.getElementById(On),n=document.getElementById($n);t.align="center",Ft=new Abc(e),Nt="",Ft.tosvg("edit",'%%bgcolor white\n%%beginsvg\n<style type="text/css">\n	rect.abcr {fill:#a08000; fill-opacity:0}\n	rect.abcr:hover {fill-opacity:0.3}\n</style>\n%%endsvg\n'),n.innerHTML="",an=[];try{Lt&&Ft.tosvg(Ut,Lt)}catch(r){return void alert(r.message+"\nabc2svg tosvg bug - stack:\n"+r.stack)}try{Lt&&(t.innerHTML=Nt,fe(),pe(),tn=!0,Zt=0,k(),Ae())}catch(r){return void alert(r.message+"\nabc2svg image bug - abort:\n"+r.stack)}}function dt(e,t){for(var n,r=document.getElementsByClassName(e),a=r.length;--a>=0;)n=r[a],n.setAttribute("color",t)}function ut(e){var t,n=ln.length;for(t=0;n>t;t++)dt(ln[t],e)}function ft(e){var t=e.fingered_start;console.log("HIGHLIGHT note at "+t),0!=ln.length&&(ut("black"),ln=[]),ln.push("e_"+t),ut(cn?"blue":"red")}function pt(e){for(var t=e.split("\n"),n=0;n<t.length;n++){var r=t[n];if(/^\s*X:/.test(r)){var a=r.split(":");if(2!=a.length)return"";var i=a[1].trim();return i}}return""}function gt(e,t){var n=[];if(e.fingering)n=B(hn,e.fingering);else if(t)return"";if(t&&n.length!=e.size)return"";for(var r=e.fingering||"",a=n.length;a<e.size;a++)r+="x";return r}function mt(e,t){if(e.grace)return gt(e,t);var n=nn[e.staff][e.time],r=Ce(n),a=n.length-r;if(2>a)return gt(e,t);n.sort(ue);var i=n[0];if(n[0].grace&&(i=n[1]),e!==i)return"";for(var o=_e(n),c="",l=0;l<o.length;l++)c+=o[l]?o[l]:"x";return c}function vt(e,t){for(var n=[],r=t,a=e.split(""),i=0;i<a.length;i++){var o=a[i];o.match(Cn)?o!==r&&(n.push(o),r=o):n.push(o)}return n.join("")}function ht(e,t,n){for(var r=Jt[t][e],a="",i=0;i<r.length;i++){var o=r[i],c=mt(o,!1);a+=c}return a}function yt(e,t){var n=wn.exec(e);return n&&n[1]?n[1]:t}function bt(){for(var e="",t="",n=Me(0),r=Me(1),a=0;a<Jt.length;a++){var i=ht(0,a);if(i&&(i=vt(i,n),n=yt(i,n),e+=i,a<Jt.length-1&&(e+="&")),Jt[a][1]){var o=ht(1,a);o&&(o=vt(o,r),r=yt(o,r),t+=o,a<Jt.length-1&&(t+="&"))}}var c=e+"@"+t;return c}function Et(){
console.log("Print that score.");var e=window.open("","print_window");e.document.write(Nt),e.document.close(),e.focus(),e.print(),e.close()}function _t(){var e=document.getElementById(Ln);e.value=Lt,at()}function Ct(){var e,t;sn?(e=Te(),t=Ke(e)):t=Ke(Lt),window.open("data:text/vnd.abc;charset=utf-8,"+encodeURI(t),"view_window")}function wt(){return p("include_pii")?o("authority"):""}function It(){return o("comments")}function kt(){return bt()}function xt(e){try{Abcdf_Parser.parse(e)}catch(t){return"Bad abcDF parse of fingering string: "+t.message+t.stack}var n=0,r=p("validate");if("complete"===r)n=e.split("x").length-1;else if("none"===r)n=0;else if("auto"===r)return"Validation of autofill is not yet implemented.";return 1===n?"One note is missing a fingering annotation.":n+" notes are missing fingering annotations."}function Bt(e){var t=xt(e);return t?(alert(t),!1):!0}function Dt(){var e=bt();return Bt(e)?e:""}function Tt(){return Ke(Lt)}function At(){var e=bt();if(Bt(e)){var t=Ke();return/^\s*X:/g.test(t)?/^% abcDidactyl/.test(t)?t:(alert("File is not valid abcD."),""):(alert("File is not valid abc."),"")}return""}var St,qt,Nt,Lt,Ft,Pt,Mt,Ht=!1,Rt=1,zt={},Ot=[],$t=void 0,Gt="",Ut="noname.abc",Xt=0,Vt=[],jt=!1,Yt=[],Zt=0,Wt=[],Jt=[],Kt={},Qt={},en=[],tn=!1,nn={},rn={},an=[],on=0,cn=!1,ln=[],sn=!0,dn=!1,un=!1,fn="https://dvdrndlph.github.io/didactyl",pn=fn+"/abcde",gn=pn+"/view/abcde_help.html",mn=pn+"/image",vn=pn+"/lib/media",hn=/\(([<>]\d)+\)|[<>]\d,[<>]\d\/[<>]\d,[<>]\d|[<>]\d\/[<>]\d,[<>]\d|[<>]\d,[<>]\d\/[<>]\d|[<>]\d,[<>]\d|[<>]\d\/[<>]\d|[<>]\d|x/g,yn=/\(([<>]?\d)+\)|[<>]?\d,[<>]?\d\/[<>]?\d,[<>]?\d|[<>]?\d\/[<>]?\d,[<>]?\d|[<>]?\d,[<>]?\d\/[<>]?\d|[<>]?\d,[<>]?\d|[<>]?\d\/[<>]?\d|[<>]?\d|x/g,bn=/\s/g,En=/</g,_n=/>/g,Cn=/[><]/g,wn=/.*([<>])[^<>]+$/,In=/^% abcDidactyl v([\d\.]+)$/,kn=/^% abcD fingering (\d+): ([<>1-5,\/\(\)@&x]+)$/,xn=/^% abcDidactyl END$/,Bn=/^% Authority: (.*)\s+\((\d\d\d\d)\)$/,Dn=/^% Transcriber: (.*)$/,Tn=/^% Transcription date: ((\d\d\d\d\-[01]\d\-[0-3]\d)\s?([0-2]\d:[0-5]\d:[0-5]\d)?)$/,An=/^% (.*)$/,Sn=300,qn=4e3,Nn="abcde",Ln="abc_source",Fn="source",Pn="abcde_prefs",Mn="abcde_controls",Hn="abcde_metadata",Rn="abcde_keypad",zn="abcde_rendering",On="abcde_target",$n="abcde_error",Gn=.1,Un=3,Xn=.3,Vn=13,jn=8,Yn=9,Zn=37,Wn=39,Jn="%%setfont-1 Bookman 11\n%%setfont-2 Helvetica-Bold 11",Kn="%%deco 1 3 fng 8 1 1 1\n%%deco 2 3 fng 8 1 1 2\n%%deco 3 3 fng 8 1 1 3\n%%deco 4 3 fng 8 1 1 4\n%%deco 5 3 fng 8 1 1 5";return AbcDE.prototype.renderUI=rt,AbcDE.prototype.getXValue=pt,AbcDE.prototype.getAuthority=wt,AbcDE.prototype.getComments=It,AbcDE.prototype.getEnteredCollection=kt,AbcDE.prototype.getEnteredAbcD=Tt,AbcDE.prototype.getValidatedCollection=Dt,AbcDE.prototype.getValidatedAbcD=At,AbcDE.prototype.setEnteredCollection=ot,this}
//# sourceMappingURL=http://nlp.cs.uic.edu/didactyl/abcde/lib