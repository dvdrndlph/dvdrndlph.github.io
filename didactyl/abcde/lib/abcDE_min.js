/* abcDE_min.js v5.0.91 */
function AbcDE(){"use strict";function e(){Zt&&clearInterval(Zt),Ut=[],Xt=[],Jt="",Kt="noname.abc",Ht=void 0,Rt="",$t=void 0,en=[],Gt=!1,tn=!1,nn=[],Ot=void 0,rn=0,an=[],on=[],cn={},sn={},ln=[],dn=!1,un={},fn={},pn=[],gn=0,Vt=void 0,mn=[]}function t(e){var t,n=un[e],r=[];for(t in n)n.hasOwnProperty(t)&&r.push(t);return r.sort(function(e,t){return parseInt(e)-parseInt(t)}),r}function n(e,t){if(!e)return console.log("MISSING fingers have no hands."),"";if("x"===e)return e;for(var n=t,r=[],i=e.split(""),a=0;a<i.length;a++){var o=i[a];"<"===o||">"===o?n=o:o.match(/\d/)?r.push(n+o):r.push(o)}return r.join("")}function r(){return"undefined"==typeof Storage?!1:!0}function i(e,t){Jt||(Jt=md5(Rt));var n=e+"_"+t+"_"+Jt;return n}function a(e){if(!r())return{};var t={sequence:""},n=i("sequence",e),a=localStorage.getItem(n)||"";a.match(/[^x&@]/)&&(t.sequence=a),n=i("authority",e);var o=localStorage.getItem(n)||"";t.authority=o,n=i("authority_year",e);var c=localStorage.getItem(n)||"";t.authority_year=c,n=i("transcriber",e);var s=localStorage.getItem(n)||"";t.transcriber=s,n=i("comments",e);var l=localStorage.getItem(n)||"";return t.comments=l,t}function o(e){var t=document.getElementById(e);return t.value?t.value:""}function c(){var e=new Date,t=e.getFullYear()+"-"+sprintf("%02d",e.getMonth()+1)+"-"+sprintf("%02d",e.getDate())+" "+sprintf("%02d",e.getHours())+":"+sprintf("%02d",e.getMinutes())+":"+sprintf("%02d",e.getSeconds()),n={sequence:St(),authority:o("authority"),authority_year:o("authority_year"),transcriber:o("transcriber"),transcription_date:t,comments:o("comments")};return n}function s(e,t){var n=document.getElementById(e),r=n.value,a=i(e,t);localStorage.setItem(a,r)}function l(e){for(var t=document.getElementsByName(e),n=0;n<t.length;n++){var r=t[n];if(r.checked)return r.id}}function d(e){var t="";if("preset"===e||"output"===e||"keypad"===e||"restore"==e)t=l(e);else{var n=document.getElementById(e);t=n.value}Yt[e]=t,localStorage.setItem(e,t)}function u(){var e=document.getElementById("sequence_spinner");return e?e.value:(alert("Sequence DOM element has gone missing."),"1")}function f(){if(!r())return void clearInterval(Zt);var e=document.getElementById("sequence_spinner");if(!e)return void clearInterval(Zt);var t=u(),n=i("sequence",t),a=St();localStorage.setItem(n,a),s("authority",t),s("authority_year",t),s("transcriber",t),s("comments",t)}function p(e){if(Pt&&Pt[e])return Pt[e];var t=l(e);return t?t:""}function g(){var e=p("preset"),t=1;return"last"===e&&(t=Wt.length||1),t}function h(e){for(var t,n=e.split("\n"),r=!1,i={},a=[],o="",c=0;c<n.length;c++){var s=n[c];if(!o&&(t=Sn.exec(s),t&&t[1]))o=t[1],r=!0;else if(r)if(t=qn.exec(s),t&&t[1]&&t[2])i={sequence:t[2],comments:""},a.push(i);else{if(t=Nn.exec(s))break;if(t=Ln.exec(s),t&&t[1]){i.authority=t[1],t[2]&&(i.authority_year=t[2]);continue}if(t=Fn.exec(s),t&&t[1]){i.transcriber=t[1];continue}if(t=Mn.exec(s),t&&t[1]){i.transcription_date=t[1];continue}t=Pn.exec(s),t&&t[1]&&(i.comments+=t[1]+"\n")}}return a}function m(){var e=document.getElementById("sequence_spinner");e.min=1,e.max=Wt.length||1;var t=g();e.value=t}function v(){var e=p("preset");return e&&"none"!==e?"first"===e?Wt[0]:"last"===e?Wt[Wt.length-1]:"":""}function y(e){if(e){var t=e-1;return parseInt(e)<=Wt.length?Wt[t]:""}return v()}function b(e,t){for(var n=document.getElementsByName(e),r=0;r<n.length;r++){var i=n[r];i.id===t&&(i.checked=!0)}}function _(e,t){var n=document.getElementById(e);t?n.value=t:n.value=""}function E(){b("preset",localStorage.getItem("preset")),b("output",localStorage.getItem("output")),b("restore",localStorage.getItem("restore")),b("keypad",localStorage.getItem("keypad")),_("default_authority",localStorage.getItem("default_authority")),_("default_authority_year",localStorage.getItem("default_authority_year")),_("default_transcriber",localStorage.getItem("default_transcriber"))}function w(e){_("authority",e.authority),_("authority_year",e.authority_year),_("transcriber",e.transcriber),_("comments",e.comments)}function C(e,r){if(e){console.log("Setting fingers: ",e);var i,a,o,c={},s=e.split("@");for(i=0;i<s.length;i++){var l=He(i);c=[];var d=s[i].split("&");for(a=0;a<d.length;a++){var u=d[a];c=c.concat(B(xn,u))}for(var f=t(i),p=0;p<f.length;p++){var g=f[p],h=un[i][g];if(h.sort(fe),h[0].grace){h[0][r]="";for(var m=0;m<h[0].size;m++)o=c.shift(),o||(console.log("Preset fingering MISSING for note:"),ce("preset grace note",h[0])),o=n(o,l),l=Ct(o,l),h[0][r]+=o}var v=Ee(h),y=_e(v);for(m=0;m<y.length;m++)for(var b=y[m],_=0;_<v[b].length;_++){var E=v[b][_];E[r]=""}for(m=0;m<y.length;m++)for(var b=y[m],_=0;_<v[b].length;_++){var E=v[b][_];E.grace||(E[r]||(E[r]=""),o=c.shift(),o||(console.log("Preset fingering MISSING for note:"),ce("preset pit note",E)),o=n(o,l),l=Ct(o,l),E[r]+=o)}}}}}function I(e,t){var n=t.sequence,r=t.sequence,i=!0,a=p("preset");a&&"none"!==a||(i=!1,n="");var o=!1;if(e&&e.sequence&&e.sequence!==n){var c=p("restore");o="always"===c?!0:"never"===c?!1:confirm("You have previously entered data for this piece. Do you want to restore them?"),o&&(n=e.sequence)}o?w(e):i&&w(t),C(n,"fingering"),C(r,"preset_fingering"),Zt=setInterval(function(){f()},zn)}function x(){var e=u(),t=a(e),n=y(e);I(t,n)}function k(){if(Rt){var e=confirm("All changes you have made to this fingering sequence will be discarded, and the initial sequence will be restored. Are you sure you want to proceed?");if(e){var t=u(),n=y(t);I(void 0,n),Se(),Ot=on[0][0][0],vt(Ot)}}}function B(e,t){if(!t)return[];for(var n,r=[],i=0,a=0;null!=(n=e.exec(t));){a=e.lastIndex;var o;o=i===a?t.substr(i):t.substr(i,a-i),r.push(o),i=e.lastIndex}var c=t.substr(i);if(c){var s="";r.length>0&&(s=r.pop()),s+=c,r.push(s)}return r}function D(){var e=window.open(En,"_blank");e.focus()}function T(e){nt();var t=document.getElementById("prefs_modal_wrapper"),n=document.getElementById("prefs_modal_window");t.className="overlay";var r=n.offsetHeight-document.documentElement.clientHeight;r>0&&(n.style.maxHeight=parseInt(window.getComputedStyle(n).height)-r+"px"),n.style.marginTop=-n.offsetHeight/2+"px",n.style.marginLeft=-n.offsetWidth/2+"px",e.preventDefault?e.preventDefault():e.returnValue=!1}function A(e){nt();var t=document.getElementById("metadata_modal_wrapper"),n=document.getElementById("metadata_modal_window");t.className="overlay";var r=n.offsetHeight-document.documentElement.clientHeight;r>0&&(n.style.maxHeight=parseInt(window.getComputedStyle(n).height)-r+"px"),n.style.marginTop=-n.offsetHeight/2+"px",n.style.marginLeft=-n.offsetWidth/2+"px",e.preventDefault?e.preventDefault():e.returnValue=!1}function S(e){var t=document.getElementById("metadata_modal_wrapper");t.className="",j(),tt(),e.preventDefault?e.preventDefault():e.returnValue=!1}function q(){jt>Kn&&(jt-=Zn,Se())}function N(){Jn>jt&&(jt+=Zn,Se())}function L(e){d("preset"),d("output"),d("restore"),d("keypad"),d("default_authority"),d("default_authority_year"),d("default_transcriber");var t=document.getElementById("prefs_modal_wrapper");t.className="",j(),tt(),e.preventDefault?e.preventDefault():e.returnValue=!1}function F(e){var t=e.slice(0,100);if(-1==t.indexOf("<?xml"))return!1;var n=t.match(/encoding="([^"]+)"/),r="utf-8";return n&&2==n.length&&(r=n[1]),r}function M(e){var t={},n=$.parseXML(e),r=vertaal(n,t),i=r[0],a=r[1];return a&&console.log("xml2abc ERROR: "+a),i||alert("Unable to open MusicXML file: "+a),i}function P(e,t){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,t,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(e,t)):n=null,n}function H(e){var t=e.split(".");return t[t.length-1]}function z(e){var t="";try{var n=new JSZip(e);$.each(n.files,function(e,n){t=n.asText()})}catch(r){return alert("Could not open compressed MusicXML file: "+r.message),""}var i=F(t);return"UTF-8"!==i?(alert("Input mxl is not UTF-8 encoded. Cannot open."),""):t=M(t)}function R(e){var t=H(e),n='The server hosting file does not allow access from this domain. Please download the file outside abcDE and then "Choose file" to work with it.',r=P("GET",e);return r?("mxl"===t&&(r.responseType="arraybuffer"),r.onload=function(){console.log("File has been retrieved.");var e="";if("mxl"===t){if(e=z(r.response),!e)return}else{e=r.responseText;var n=F(e);if(n){if(!/^utf/i.test(n))return void alert("Input xml is not UTF-8 encoded. Cannot open.");e=M(e)}}e&&(document.getElementById($n).value=e,it())},r.onerror=function(){alert(n)},void r.send()):void alert(n)}function O(){var e="Please enter URL for file to open.",t=bn+"/abc/OpenWTC/pf02.abc",n=window.prompt(e,t);null!==n&&R(n)}function V(e){var t=new FileReader,n="";t.onload=function(e){try{var t=new JSZip(e.target.result);$.each(t.files,function(e,t){n=t.asText()})}catch(e){return void alert("Could not open compressed MusicXML file: "+e.message)}var r=F(n);return"UTF-8"!==r?void alert("Input xml is not UTF-8 encoded. Cannot open."):(n=M(n),document.getElementById($n).value=n,it(),void 0)},t.readAsArrayBuffer(e)}function U(){var e=document.getElementById("file_input"),t=e.files;if(!t.length)return void alert("Please select a valid abc file.");var n=t[0],r=H(n.name);if("mxl"===r)return void V(n);var i=!1,a=new FileReader;a.onload=function(e){var t=F(a.result),r=new FileReader;t?i=!0:t="UTF-8",r.onload=function(e){var t="";t=i?M(r.result):e.target.result,document.getElementById($n).value=t,it()},r.readAsText(n,t)},a.readAsText(n,"UTF-8")}function X(){vn=vn?!1:!0}function G(e,t){for(var n=e.children,r=0;r<n.length;r++)n[r].style.display=t}function j(){var e=document.getElementById(Gn),t=document.getElementById("number_div"),n=document.getElementById("symbol_div"),r=p("keypad");if("show"===r)e.style.display="block",t.style.display="block",n.style.display="block",G(t,"inline"),G(n,"inline");else{G(n,"none"),G(t,"none");var i=p("qualtrics");if(i){var a=document.getElementById("q_next");a.style.display="inline";var o=document.getElementById("q_back");o.style.display="inline"}else t.style.display="block",n.style.display="block",e.style.display="none"}}function Y(e){var t=e.keyCode||e.which;t=String.fromCharCode(t);var n=/[0-9]/;n.test(t)||(e.returnValue=!1,e.preventDefault&&e.preventDefault())}function W(e,t,n,r,i,a){var o=document.createElement("input");o.type="text",o["class"]=r,o.id=t,i&&(o.onkeypress=i),"year"===r&&(o.size="4");var c=document.createElement("label");c.htmlFor=t,c.appendChild(document.createTextNode(n)),e.appendChild(c),e.appendChild(o),a&&e.appendChild(document.createElement("br"))}function Z(e,t,n,r,i,a){var o=document.createElement("textarea");o["class"]=r,o.id=t,o.rows=i,o.cols=a;var c=document.createElement("label");c.htmlFor=t,c.appendChild(document.createTextNode(n)),e.appendChild(c),e.appendChild(o)}function J(e,t,n){var r=document.createElement("label");r["class"]=n;var i=document.createTextNode(t);r.appendChild(i),e.appendChild(r)}function K(e,t,n,r,i,a,o){var c=document.createElement("div");c["class"]="radio_div",J(e,t,"prompt");for(var s=0;s<r.length;s++){var l=document.createElement("input");l.type="radio",l.id=r[s],l.id===a&&(l.checked=!0),l.name=n,c.appendChild(l),J(c,i[s],"radio_label");var d=document.createElement("span");d.innerHTML="&nbsp;&nbsp",c.appendChild(d)}return e.appendChild(c),o&&e.appendChild(document.createElement("br")),c}function Q(){var e=document.getElementById(Xn),t=document.createElement("div");t.id="metadata_modal_wrapper",e.appendChild(t);var n=document.createElement("div");n.id="metadata_modal_window",t.appendChild(n);var r=document.createElement("div");r.style.textAlign="right";var i=document.createElement("a");i.id="metadata_modal_close",i.href="#",i.innerHTML="Close <b>X</b>",r.appendChild(i),i.addEventListener("click",S,!1),n.appendChild(r),W(n,"authority","Authority","name",void 0,!1),W(n,"authority_year","Year","year",Y,!0),W(n,"transcriber","Transcriber","name",void 0,!0),Z(n,"comments","Comments","comments",10,55)}function ee(){var e=document.getElementById(Vn),t=document.createElement("div");t.id="prefs_modal_wrapper",e.appendChild(t);var n=document.createElement("div");n.id="prefs_modal_window",t.appendChild(n);var r=document.createElement("div");r.style.textAlign="right";var i=document.createElement("a");i.id="prefs_modal_close",i.href="#",i.innerHTML="Close <b>X</b>",r.appendChild(i),i.addEventListener("click",L,!1),n.appendChild(r);var a=document.createElement("h3");a.innerText="Preferences",n.appendChild(a);var o="restore",c=["always","never","ask"],s=["Always","Never","Ask"];Pt&&Pt[o]||K(n,"Restore Data",o,c,s,"ask",!0),o="output",Pt&&Pt[o]||(c=["append","replace"],s=["Append","Replace"],K(n,"Output",o,c,s,"append",!0)),o="preset",Pt&&Pt[o]||(c=["first","last","none"],s=["First","Last","None"],K(n,"Preset",o,c,s,"first",!0)),o="keypad",c=["show","hide"],s=["Show","Hide"];var l="hide",d="ontouchstart"in window;d&&(l="show"),K(n,"Keypad",o,c,s,l,!0),W(n,"default_authority","Default Authority","name",void 0,!0),W(n,"default_authority_year","Year","year",Y,!0),W(n,"default_transcriber","Transcriber Name","name",void 0,!0)}function te(e,t,n){var r=document.createElement("input");r.type="button",r["class"]="keypad-button",r.id=t,r.value=n,r.onclick=function(){Ye(n)},e.appendChild(r)}function ne(e){var t=p("qualtrics"),n=yt(Rt),r="abcDF_"+n,i="abcD_"+n,a=St();Qualtrics.SurveyEngine.setEmbeddedData(r,a);var o=Ft();Qualtrics.SurveyEngine.setEmbeddedData(i,o),f();for(var c=document.getElementById(Rn);c.firstChild;)c.removeChild(c.firstChild);c.remove(),yn=!1,Zt&&clearInterval(Zt),t.enableNextButton(),t.enablePreviousButton(),"q_next"===e?t.clickNextButton():t.clickPreviousButton()}function re(e,t,n){var r=document.createElement("input");r.type="button",r["class"]="keypad-button",r.id=t,r.value=n,r.onclick=function(){ne(t)},e.appendChild(r)}function ie(e,t,n,r){var i=document.createElement("input");i.id=t,i["class"]="keypad_button",i.type="image",i.src=wn+"/"+n,i.alt=r,i.onclick=function(){Fe(t)},e.appendChild(i)}function ae(){var e=document.getElementById(Gn),t=document.createElement("number_div");t.id="number_div";var n=document.createElement("symbol_div");n.id="symbol_div",e.appendChild(n),e.appendChild(document.createElement("br")),e.appendChild(t),ie(t,"undo","action-undo.svg","undo"),ie(t,"redo","action-redo.svg","redo"),te(t,"one","1"),te(t,"two","2"),te(t,"three","3"),te(t,"four","4"),te(t,"five","5"),ie(t,"pencil","target.svg","...");var r=p("qualtrics");r&&(re(t,"q_back","BACK"),re(t,"q_next","NEXT")),ie(n,"previous","arrow-circle-left.svg","<-"),ie(n,"next","arrow-circle-right.svg","->"),te(n,"comma",","),te(n,"slash","/"),te(n,"open_paren","("),te(n,"close_paren",")"),te(n,"toggle","T"),ie(n,"backspace","delete.svg","<]")}function oe(){if(!yn){ee(),Q();var e=wn+"/download_36_x4.png",t="36",n=document.getElementById(Un),r=document.createElement("table"),i=document.createElement("tbody"),a=document.createElement("tr");n.appendChild(r),r.appendChild(i),r.style.backgroundColor="LightGray",r.align="center",i.appendChild(a);var o=document.createElement("p");o.setAttribute("id","downloadify");var c=document.createElement("td");c.appendChild(o),a.appendChild(c);var s=document.createElement("input");s.id="sequence_spinner",s.min="1",s.max="999",s.size=3,s.type="number",s.alt="fingering_number",s.value=1,s.onchange=kt,c=document.createElement("td"),J(c,"Sequence","sequence_prompt"),c.appendChild(s),a.appendChild(c),Pt.preset_select||(c.style.display="none");var l=document.createElement("input");l.type="image",l.src=wn+"/eye.svg",l.width=t,l.alt="View",l.onclick=Dt,c=document.createElement("td"),c.appendChild(l),a.appendChild(c);var d=document.createElement("input");d.type="image",d.src=wn+"/print.svg",d.width=t,d.alt="Print...",d.onclick=xt;var c=document.createElement("td");c.appendChild(d),a.appendChild(c),c=document.createElement("td");var u=document.createElement("input");u.type="checkbox",u.value="annotated",u.checked=vn,u.id="view_annotated",u.onclick=X;var f=document.createElement("label");f.htmlFor="view_annotated",f.appendChild(document.createTextNode("Annotated")),c.appendChild(u),c.appendChild(f),a.appendChild(c);var p=document.createElement("input");p.type="image",p.src=wn+"/reload.svg",p.width=t,p.alt="reset",p.onclick=k,c=document.createElement("td"),c.appendChild(p),a.appendChild(c);var g=document.createElement("input");g.type="image",g.src=wn+"/globe.svg",g.width=t,g.alt="URL",g.onclick=O,c=document.createElement("td"),c.appendChild(g),a.appendChild(c),Pt.url_input||(g.style.visibility="hidden");var h=document.createElement("input");h.setAttribute("type","file"),h.setAttribute("accept","text/vnd.abc"),h.onchange=U,h.setAttribute("id","file_input"),c=document.createElement("td"),c.appendChild(h),a.appendChild(c),Pt.file_input||(h.style.visibility="hidden");var m=document.createElement("input");m.type="image",m.src=wn+"/tags.svg",m.alt="Metadata...",m.width=t,m.onclick=A,c=document.createElement("td"),c.appendChild(m),a.appendChild(c);var v=document.createElement("input");v.type="image",v.src=wn+"/zoom-out.svg",v.alt="Zoom In",v.width=t,v.onclick=q,c=document.createElement("td"),c.appendChild(v),a.appendChild(c);var y=document.createElement("input");y.type="image",y.src=wn+"/zoom-in.svg",y.alt="Zoom In",y.width=t,y.onclick=N,c=document.createElement("td"),c.appendChild(y),a.appendChild(c);var b=document.createElement("input");b.type="image",b.src=wn+"/cog.svg",b.alt="Preferences...",b.width=t,b.onclick=T,c=document.createElement("td"),c.appendChild(b),a.appendChild(c);var _=document.createElement("input");_.type="image",_.src=wn+"/info.svg",_.alt="Help",_.width=t,_.onclick=D,c=document.createElement("td"),c.appendChild(_),a.appendChild(c),Downloadify.create("downloadify",{filename:function(){return Kt},data:Bt,onComplete:function(){alert("Your file has been saved.")},onCancel:function(){alert("File save has been cancelled.")},onError:function(){alert("File save failed!")},transparent:!1,swf:Cn+"/downloadify.swf",downloadImage:e,width:t,height:t,append:!1}),ae(),yn=!0}}function ce(e,t){console.log(e+" Line: "+t.line+" Start: "+t.start+" Time: "+t.time+" String: "+t.string+" Size: "+t.size+" Pitch: "+t.pitches.join(",")+" Voice: "+t.voice+" Staff: "+t.staff+" Grace: "+t.grace)}function se(){for(var e=0;e<an.length;e++){var t=an[e];t.undone_fingerings=[]}Ut=[]}function le(e,t){if("note"!=e[t.type]&&"grace"!=e[t.type])return{};if(this.line=-1,this.grace=!1,this.anno_start=t.istart,this.size=0,this.pitches=[],this.start=-1,this.end=-1,this.starts=[],this.stops=[],"note"===e[t.type]){this.size=t.notes.length;for(var n=0;n<this.size;n++)this.pitches.push(t.notes[n].pit);this.pitches.sort(function(e,t){return parseInt(e)-parseInt(t)}),this.start=t.istart,this.end=t.iend}else{this.grace=!0,this.start=t.extra.istart,this.size=1;var r=t.extra;if(!r.notes)return alert("Who turned off the notes?!"),{};for(;;){if(r.notes.length>1&&alert('Chords not supported in a grace "note."'),this.starts.push(r.istart),this.stops.push(r.iend),this.pitches.push(r.notes[0].pit),!r.next){this.end=r.iend;break}r=r.next,this.size++}}return this.istart=t.istart,this.time=t.time,this.string=Rt.substring(this.start,this.end),this.voice=t.v,this.staff=t.st,this.prior_fingerings=[],this.undone_fingerings=[],this.init_fingering=function(){this.fingering="";for(var e=0;e<this.size;e++)this.fingering+="x"},this.init_fingering(),this.set_fingering=function(e){se(),this.fingering&&this.prior_fingerings.push(this.fingering),e?this.fingering=e:this.init_fingering(),Xt.push(this)},this.undo_fingering_change=function(){this.prior_fingerings.length>0&&(this.undone_fingerings.push(this.fingering),this.fingering=this.prior_fingerings.pop()),Ut.push(this)},this.redo_fingering_change=function(){this.undone_fingerings.length>0&&(this.fingering&&this.prior_fingerings.push(this.fingering),this.fingering=this.undone_fingerings.pop()),Xt.push(this)},this.get_fingering=function(){return this.fingering?this.fingering:void 0},this}function de(){var e=8.5;1!==jt&&(e*=jt);var t='width="'+e+'in"';return t}function ue(){this.read_file=function(e){return""},this.errmsg=function(e,t,n){var r=document.getElementById(Wn);t?r.innerHTML+='<b onclick="gotoabc('+t+","+n+')" style="cursor: pointer; display: inline-block">'+e+"</b><br/>\n":r.innerHTML+=e+"<br/>\n"},this.img_out=function(e){var t=/<svg /;e.match(t)&&(e=e.replace(t,'<svg id="line_'+rn+'" '),rn++,console.log("SVG: "+e)),zt+=e},this.anno_start=function(e,t,n,r,i,a,o){!dn&&t in cn?cn[t].line=rn:"grace"===e&&console.log(e+" ANNO_START start: "+t+" stop: "+n),pn.push([t,n]),$t.out_svg('<g class="e_'+t+'">\n')},this.anno_stop=function(e,t,n,r,i,a,o){"grace"===e&&console.log(e+" ANNO_STOP start: "+t+" stop: "+n),$t.out_svg("</g>\n"),$t.out_svg('<rect class="abcr _'+t+'" x="'),$t.out_sxsy(r,'" y="',i),$t.out_svg('" width="'+a.toFixed(2)+'" height="'+o.toFixed(2)+'"/>\n')},this.get_abcmodel=function(e,t,n){if(!dn){console.log(n);for(var r=0;r<t.length;r++){console.log("Voice: "+r);var i=t[r].st;fn[r]=i}for(var a=e;a;){var o=new le(n,a);o.istart&&(an.push(o),cn[o.istart]=o,o.staff in un||(un[o.staff]={}),o.time in un[o.staff]||(un[o.staff][o.time]=[]),un[o.staff][o.time].push(o)),a=a.ts_next}}},this.page_format=!1,this.imagesize=de()}function fe(e,t){var n=parseInt(e.time)-parseInt(t.time);return 0!==n?n:(e.grace&&t.grace&&alert("Conflicting grace notes."),e.grace?-1:t.grace?1:e.pitches[e.pitches.length-1]<t.pitches[0]?-1:e.pitches[0]>t.pitches[t.pitches.length-1]?1:e.voice<t.voice?(console.log("NOTES SORTED BY VOICE!"),-1):1)}function pe(){for(var e,t,n,r=0;r<an.length;r++)e=an[r],t=e.line,n=e.staff,t in on||(on[t]=[],on[t][0]=[],on[t][1]=[]),on[t][n].push(e);for(t=0;t<on.length;t++)for(n=0;2>n;n++){var i=on[t][n];i.sort(fe)}var a,o;for(n=0;2>n;n++)for(t=0;t<on.length;t++){var i=on[t][n];for(r=0;r<i.length;r++)a=i[r],o?(o.next_note=a,a.prior_note=o,o=a):(o=a,a.prior_note=void 0)}a.next_note=void 0}function ge(){var e;for(e in cn)cn.hasOwnProperty(e)&&ln.push(e);ln.sort(function(e,t){return parseInt(e)-parseInt(t)})}function he(e){var t="$1";return e.match(Dn)&&(t="$1"),e.match(Bn)&&(t="$2"),t}function me(e){var t="^";return/^</.test(e)&&(t="_"),t}function ve(e,t){for(var n=he("<"),r=he(">"),i=e.replace(/[\)\(]/g,""),a=B(In,i),o="",c=0;c<a.length;c++)a[c]=a[c].replace(Bn,n),a[c]=a[c].replace(Dn,r),o+=a[c];o+='"';var s=me(i);return o='"'+s+o}function ye(e,t,n){for(var r=!1,i=he("<"),a=he(">"),o=[],c=0;c<e.length;c++){var s="",l="x";if(e[c]&&"x"!==e[c])r=!0,l=e[c];else{if(!n)break;if(!e[c]||e[c]&&"x"===e[c])continue}if(l.match(/^\(/))s=ve(l,t);else{var d=me(l);l=l.replace(Bn,i),l=l.replace(Dn,a),s='"'+d+l+'"'}o.unshift(s)}var u="";return r&&(u=o.join("")),u}function be(e){var t=e.fingering;if("x"===t)return"";t=t.replace(kn,"");var n=B(In,t),r=ye(n,e.staff,!1);return r}function _e(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t.sort(function(e,t){return parseInt(e)-parseInt(t)}),t}function Ee(e){for(var t=[],n={},r=0;r<e.length;r++){var i=e[r];if(!i.grace)for(var a=0;a<i.pitches.length;a++){var o=i.pitches[a];t.push(o),o in n||(n[o]=[]),n[o].push(i)}}for(r=0;r<n.length;r++)n[r].sort(fe);return n}function we(e){for(var t=Ee(e),n=_e(t),r=[],i=0;i<n.length;i++)for(var a=n[i],o=0;o<t[a].length;o++)for(var c=t[a][o],s=c.fingering,l=B(In,s),d=0;d<c.pitches.length;d++){var u=c.pitches[d];u===parseInt(a)&&("x"!==l[d]?r.push(l[d]):r.push(""))}return r}function Ce(e){for(var t=0,n=0;n<e.length;n++)e[n].grace&&t++;return t}function Ie(e){if(e.size>1&&console.log("BIGGIE"),e.grace)return be(e);var t=un[e.staff][e.time],n=Ce(t),r=t.length-n;if(2>r)return be(e);t.sort(fe);var i=t[0];if(t[0].grace&&(i=t[1]),e!==i)return"";var a=we(t);return ye(a,e.staff,!0)}function xe(e){for(var t=[],n=e.string,r=e.starts,i=e.stops,a=[],o=[],c=0;c<r.length;c++)a.push(r[c]-r[0]),o.push(i[c]-r[0]);for(var s=0;s<a.length;s++){var l=n.substring(a[s],o[s]);t.push(l)}return t}function ke(e){var t="{",n=xe(e),r=[];e.fingering&&(r=B(In,e.fingering));for(var i=0;i<n.length;i++){if(r[i]){var a=r[i];a=a.replace(Tn,""),t+="!"+a+"!"}t+=n[i]}return t+="}"}function Be(e){if(e.fingering)return!0;for(var t=un[e.staff][e.time],n=0;n<t.length;n++)if(!t[n].grace&&t[n].fingering)return!0;return!1}function De(){if(void 0!==Vt)return Vt;Vt=!1;for(var e=!1,t=!1,n=Rt.split("\n"),r=0;r<n.length;r++){var i=n[r];if(i.match(/^%%setfont-1/)&&(e=!0),i.match(/^%%setfont-2/)&&(t=!0),e&&t){Vt=!0;break}}return Vt}function Te(){if(void 0!==Ht)return Ht;Ht=!1;for(var e=0;e<ln.length;e++){var t=ln[e],n=cn[t];if(n.grace){Ht=!0;break}}return Ht}function Ae(){var e="";De()||(e+=or+"\n",Te()&&(e+=cr+"\n"));for(var t=0,n=0;n<ln.length;n++){var r=ln[n],i=cn[r],a="";if(i.grace){if(a=Rt.substring(parseInt(t),parseInt(i.start-1)),t=i.end+1,e+=a,i.fingered_start=e.length+i.anno_start-i.start+1,i.fingering&&"x"!==i.fingering){var o=B(In,i.fingering);i.fingered_start+=3*o.length}e+=ke(i)}else{var c=parseInt(i.start),s=parseInt(i.end);a=Rt.substring(parseInt(t),c),e+=a,t=s,Be(i)&&(e+=Ie(i)),i.fingered_start=e.length,e+=i.string}sn[i.fingered_start]=i}return e+=Rt.substring(t)}function Se(){gn++,console.log("RERENDERING NUMBER "+gn);var e=(new Date).getTime(),t=document.getElementById(Yn),n=document.getElementById(Wn),r=new ue;$t=new Abc(r);var i=Ae(),a=(new Date).getTime(),o=a-e;console.log("MY LAG: "+o),document.getElementById($n).value=i,e=(new Date).getTime(),zt="",$t.tosvg("edit",'%%bgcolor white\n%%beginsvg\n<style type="text/css">\n	rect.abcr {fill:#a08000; fill-opacity:0}\n	rect.abcr:hover {fill-opacity:0.3}\n</style>\n%%endsvg\n'),rn=0,n.innerHTML="",pn=[];try{$t.tosvg(Kt,document.getElementById($n).value)}catch(c){return void alert(c.message+"\nabc2svg tosvg bug - stack:\n"+c.stack)}try{t.innerHTML=zt}catch(c){return void alert(c.message+"\nabc2svg image bug - abort:\n"+c.stack)}setTimeout(function(){for(var e,t=document.getElementsByClassName("abcr"),n=t.length;--n>=0;)e=t[n],e.onclick=function(){ct(this)},e.ondblclick=function(){ft(this)}},300),a=(new Date).getTime(),o=a-e,console.log("LIB LAG: "+o),j()}function qe(e){return null==e.which?String.fromCharCode(e.keyCode):0!=e.which&&0!=e.charCode?String.fromCharCode(e.which):null}function Ne(e){if(console.log(String.fromCharCode(e)+" --> "+e),e===nr){Ve();var t=Ue();t.length>0&&t[0]?(Ot.set_fingering(""),Se()):Ot.prior_note&&(Ot=Ot.prior_note,Ot.set_fingering(""),Se()),vt(Ot)}else if(e==rr||e==ar)je(),nn=[],Ot.next_note&&(Ot=Ot.next_note);else if(e==ir)je(),nn=[],Ot.prior_note&&(Ot=Ot.prior_note);else if(e==tr)ut();else if(e==Qn)lt();else{if(e!=er)return!1;dt()}return vt(Ot),!0}function Le(e){var t=e.keyCode,n=Ne(t);return n&&e.preventDefault(),n}function Fe(e){var t=rr;switch(e){case"previous":t=ir;break;case"next":t=ar;break;case"backspace":t=nr;break;case"pencil":t=tr;break;case"undo":t=Qn;break;case"redo":t=er}return Ne(t)}function Me(){hn?(hn=!1,document.body.style.backgroundColor="white"):(hn=!0,document.body.style.backgroundColor="black"),vt(Ot)}function Pe(e){return hn?0==e.staff?"<":">":He(e.staff)}function He(e){return 0==e?">":"<"}function ze(e,t){var n=Pe(t),r=e.fingering.strike.hand||n,i=r+e.fingering.strike.digit;return e.fingering.release&&(r=e.fingering.release.hand||n,i+=","+r+e.fingering.release.digit),i}function Re(e,t){var n,r,i="",a=[];if(e.first.ornaments){for(a=e.first.ornaments[0],i+="(",r=0;r<a.length;r++)n=a[r],i+=ze(n,t);i+=")"}else i+=ze(e.first,t);if(e.last&&e.last.ornaments){for(a=e.last.ornaments[0],i+="(",r=0;r<a.length;r++)n=e.last.ornaments[r],i+="/"+ze(n,t);i+=")"}else e.last&&(i+="/"+ze(e.last,t));return i}function $e(e){for(var t="",n=0;n<Ot.size;){var r=e.shift(),i=Re(r,Ot);if(t+=i,n++,0===e.length)break}if(n===Ot.size)return Ot.set_fingering(t),!0;for(;n<Ot.size;n++)t+="x";return Ot.set_fingering(t),!1}function Oe(e){for(var t=e.upper.score_fingerings;t.length>0;)$e(t)&&Ot.next_note&&(Ot=Ot.next_note);tn&&(Ot=Ot.prior_note)}function Ve(){tn=!1,en=[],nn=[],Se(),vt(Ot)}function Ue(){for(var e=[],t=Ot.get_fingering(),n=t.split(""),r=0;r<n.length;r++){var i=n[r];"x"===i?e.push(""):e.push(i)}return e}function Xe(){for(var e=Ue();e.length;){var t=e.pop();t&&en.unshift(t)}}function Ge(){for(var e=0;e<nn.length;e++)if("("===nn[e])return!0;return!1}function je(){var e=!1;nn.length>0&&(Array.prototype.unshift.apply(en,nn),Ge()||(e=!0)),nn=[];for(var t=en.length-1;t>=0&&/[,\/\(]/.test(en[t]);t--)nn.unshift(en.pop());if(0!==en.length){if(/[,\/]/.test(en[0])&&(e=!0),tn){var n=Ue();")"===n[n.length-1]?n.pop():(alert("Something wonky with parentheses."),Ve()),Array.prototype.unshift.apply(en,n),tn=!1}e?Ot.prior_note?(Ot=Ot.prior_note,Xe()):en.pop():Ot.fingering&&Ot.fingering.match(/x/)&&Xe();for(var r=en.join(""),i=0,a=1;;)try{var o=Abcdf_Parser.parse(r);tn=!1,2===a&&(tn=!0),Oe(o);break}catch(c){if(1===a?en.push(")"):2===a?(en.pop(),en.pop(),i++):3===a&&(a=0),0==en.length)break;r=en.join(""),a++}en=[],Se(),vt(Ot)}}function Ye(e){clearTimeout(Qt);var t=!1;return/[\(\)\/,1-5]/.test(e)&&(en.push(e),t=!0),("t"===e||"T"===e)&&(je(),Me(),t=!0),Qt=setTimeout(je,Hn),console.log("Done "+Qt),t}function We(e){var t=qe(e).toLowerCase();return Ye(t)}function Ze(e){Pt||(Pt=e)}function Je(){return 5}function Ke(){var e="% abcDidactyl v"+Je();return e}function Qe(e){var t="% abcD fingering "+e+": ";return t}function et(e){var t=[],n=[];n.push(Ke());for(var r,i=h(e),a=e.split("\n"),o="",s=!1,l=0;l<a.length;l++){var d=a[l];o?s?t.push(d):(r=Nn.exec(d),r&&(s=!0)):(r=Sn.exec(d),r&&r[1]?o=r[1]:t.push(d))}var f=u(),g=c();if("replace"===p("output")){var m=f-1;i[m]=g}else i.push(g);for(var v,y,b,_,E,l=0;l<i.length;l++){var w=l+1;try{Abcdf_Parser.parse(i[l].sequence)}catch(C){alert("Bad abcDF parse of fingering string: "+C.message+C.stack)}v=Qe(w)+i[l].sequence,n.push(v),i[l].authority&&(y="% Authority: "+i[l].authority,i[l].authority_year&&(y+=" ("+i[l].authority_year+")"),n.push(y)),i[l].transcriber&&(b="% Transcriber: "+i[l].transcriber,n.push(b)),i[l].transcription_date&&(_="% Transcription date: "+i[l].transcription_date,n.push(_));for(var E=i[l].comments.split("\n"),I=0;I<E.length;I++)(I!==E.length-1||E[I])&&n.push("% "+E[I])}n.push("% abcDidactyl END");var x=n.join("\n"),k=t.join("\n");return x+"\n"+k}function tt(){document.body.addEventListener("keydown",Le),document.body.addEventListener("keypress",We)}function nt(){document.body.removeEventListener("keydown",Le),document.body.removeEventListener("keypress",We)}function rt(){if(!yn){var e=document.getElementById(Rn);e.align="center";var t=document.getElementById($n);t||(t=document.createElement("div"),t.id=$n,t.style.display="none",e.appendChild(t)),t["class"]=On;var n=document.createElement(Vn);n.id=Vn,e.appendChild(n);var r=document.createElement(Un);r.id=Un,e.appendChild(r);var i=document.createElement(Xn);i.id=Xn,e.appendChild(i);var a=document.createElement(jn);a.id=jn,e.appendChild(a);var o=document.createElement(Yn);o.id=Yn,a.appendChild(o);var c=document.createElement(Wn);c.id=Wn,a.appendChild(c);for(var s=0;7>s;s++)a.appendChild(document.createElement("br"));var l=document.createElement(Gn);l.id=Gn,e.appendChild(l)}}function it(){rt(),e(),oe(),E(),Rt=document.getElementById($n).value,Rt&&(Wt=h(Rt),m(),pt(),Ot=on[0][0][0],vt(Ot),tt()),j()}function at(e){Gt||(Ze(e),it());var t=p("qualtrics");t&&(t.disableNextButton(),t.disablePreviousButton())}function ot(){e(),Rt=document.getElementById($n).value,pt(),Ot=on[0][0][0],vt(Ot),tt()}function ct(e){console.log("Processing note click....");var t=e.getAttribute("class");console.log("Click "+t);var n=t.split("_"),r=n[1];if(r in sn){var i=sn[r];ce("process_note_click",i),vt(i),Ot=i}}function st(e){Ot=on[0][0][0];var t=u(),n=c();n.sequence=e;var r=a(t);I(r,n),Se(),vt(Ot)}function lt(){Ve();var e=Xt.pop();e&&(e.undo_fingering_change(),Ot=e,Se(),vt(Ot))}function dt(){Ve();var e=Ut.pop();e&&(e.redo_fingering_change(),Ot=e.next_note?e.next_note:e,Se(),vt(Ot))}function ut(){Ve();var e="";Ot.preset_fingering&&(e+="Preset (recommended) fingering: "+Ot.preset_fingering+"\n\n"),e+="Please enter a fingering string for the selected note.";var t=Ot.fingering,n=window.prompt(e,t);
try{if(null===n)return;var r=Abcdf_Parser.parse(n);Oe(r),Se(),vt(Ot)}catch(i){alert("Bad abcDF parse of fingering string: "+i.message+i.stack)}}function ft(e){console.log("Processing note double-click...."),ct(e),ut()}function pt(){var e=new ue,t=document.getElementById(Yn),n=document.getElementById(Wn);t.align="center",$t=new Abc(e),zt="",$t.tosvg("edit",'%%bgcolor white\n%%beginsvg\n<style type="text/css">\n	rect.abcr {fill:#a08000; fill-opacity:0}\n	rect.abcr:hover {fill-opacity:0.3}\n</style>\n%%endsvg\n'),n.innerHTML="",pn=[];try{Rt&&$t.tosvg(Kt,Rt)}catch(r){return void alert(r.message+"\nabc2svg tosvg bug - stack:\n"+r.stack)}try{Rt&&(t.innerHTML=zt,pe(),ge(),dn=!0,rn=0,x(),Se())}catch(r){return void alert(r.message+"\nabc2svg image bug - abort:\n"+r.stack)}}function gt(e,t){for(var n,r=document.getElementsByClassName(e),i=r.length;--i>=0;)n=r[i],n.setAttribute("color",t)}function ht(e){var t,n=mn.length;for(t=0;n>t;t++)gt(mn[t],e)}function mt(e){var t=$(e),n=$(window),r=document.getElementById(Gn),i=n.scrollTop(),a=i+n.height()-r.offsetHeight,o=t.offset().top,c=o+t.height();return a>=c&&o>=i}function vt(e){var t=e.fingered_start;0!=mn.length&&(ht("black"),mn=[]),mn.push("e_"+t),ht(hn?"blue":"red");var n="line_"+e.line,r=document.getElementById(n);if(!mt(r)){r.scrollIntoView(!1);var i=document.getElementById(Gn),a=document.body.scrollTop;window.scrollTo(0,a+i.offsetHeight)}}function yt(e){for(var t=e.split("\n"),n=0;n<t.length;n++){var r=t[n];if(/^\s*X:/.test(r)){var i=r.split(":");if(2!=i.length)return"";var a=i[1].trim();return a}}return""}function bt(e,t){var n=[];if(e.fingering)n=B(In,e.fingering);else if(t)return"";if(t&&n.length!=e.size)return"";for(var r=e.fingering||"",i=n.length;i<e.size;i++)r+="x";return r}function _t(e,t){if(e.grace)return bt(e,t);var n=un[e.staff][e.time],r=Ce(n),i=n.length-r;if(2>i)return bt(e,t);n.sort(fe);var a=n[0];if(n[0].grace&&(a=n[1]),e!==a)return"";for(var o=we(n),c="",s=0;s<o.length;s++)c+=o[s]?o[s]:"x";return c}function Et(e,t){for(var n=[],r=t,i=e.split(""),a=0;a<i.length;a++){var o=i[a];o.match(Tn)?o!==r&&(n.push(o),r=o):n.push(o)}return n.join("")}function wt(e,t,n){for(var r=on[t][e],i="",a=0;a<r.length;a++){var o=r[a],c=_t(o,!1);i+=c}return i}function Ct(e,t){var n=An.exec(e);return n&&n[1]?n[1]:t}function It(){for(var e="",t="",n=He(0),r=He(1),i=0;i<on.length;i++){var a=wt(0,i);if(a&&(a=Et(a,n),n=Ct(a,n),e+=a,i<on.length-1&&(e+="&")),on[i][1]){var o=wt(1,i);o&&(o=Et(o,r),r=Ct(o,r),t+=o,i<on.length-1&&(t+="&"))}}var c=e+"@"+t;return c}function xt(){console.log("Print that score.");var e=window.open("","print_window");e.document.write(zt),e.document.close(),e.focus(),e.print(),e.close()}function kt(){var e=document.getElementById($n);e.value=Rt,ot()}function Bt(){var e,t;return vn?(e=Ae(),t=et(e)):t=et(Rt),t}function Dt(){var e=Bt();window.open("data:text/vnd.abc;charset=utf-8,"+encodeURI(e),"view_window")}function Tt(){return p("include_pii")?o("authority"):""}function At(){return o("comments")}function St(){return It()}function qt(e){try{Abcdf_Parser.parse(e)}catch(t){return"Bad abcDF parse of fingering string: "+t.message+t.stack}var n=0,r=p("validate");if("complete"===r)n=e.split("x").length-1;else if("none"===r)n=0;else if("auto"===r)return"Validation of autofill is not yet implemented.";return 1===n?"One note is missing a fingering annotation.":n+" notes are missing fingering annotations."}function Nt(e){var t=qt(e);return t?(alert(t),!1):!0}function Lt(){var e=It();return Nt(e)?e:""}function Ft(){return et(Rt)}function Mt(){var e=It();if(Nt(e)){var t=et();return/^\s*X:/g.test(t)?/^% abcDidactyl/.test(t)?t:(alert("File is not valid abcD."),""):(alert("File is not valid abc."),"")}return""}var Pt,Ht,zt,Rt,$t,Ot,Vt,Ut=[],Xt=[],Gt=!1,jt=1,Yt={},Wt=[],Zt=void 0,Jt="",Kt="noname.abc",Qt=0,en=[],tn=!1,nn=[],rn=0,an=[],on=[],cn={},sn={},ln=[],dn=!1,un={},fn={},pn=[],gn=0,hn=!1,mn=[],vn=!0,yn=!1,bn="https://dvdrndlph.github.io/didactyl",_n=bn+"/abcde",En=_n+"/view/abcde_help.html",wn=_n+"/image",Cn=_n+"/lib/media",In=/\(([<>]\d)+\)|[<>]\d,[<>]\d\/[<>]\d,[<>]\d|[<>]\d\/[<>]\d,[<>]\d|[<>]\d,[<>]\d\/[<>]\d|[<>]\d,[<>]\d|[<>]\d\/[<>]\d|[<>]\d|x/g,xn=/\(([<>]?\d)+\)|[<>]?\d,[<>]?\d\/[<>]?\d,[<>]?\d|[<>]?\d\/[<>]?\d,[<>]?\d|[<>]?\d,[<>]?\d\/[<>]?\d|[<>]?\d,[<>]?\d|[<>]?\d\/[<>]?\d|[<>]?\d|x/g,kn=/\s/g,Bn=/</g,Dn=/>/g,Tn=/[><]/g,An=/.*([<>])[^<>]+$/,Sn=/^% abcDidactyl v([\d\.]+)$/,qn=/^% abcD fingering (\d+): ([<>1-5,\/\(\)@&x]+)$/,Nn=/^% abcDidactyl END$/,Ln=/^% Authority: (.*)\s+\((\d\d\d\d)\)$/,Fn=/^% Transcriber: (.*)$/,Mn=/^% Transcription date: ((\d\d\d\d\-[01]\d\-[0-3]\d)\s?([0-2]\d:[0-5]\d:[0-5]\d)?)$/,Pn=/^% (.*)$/,Hn=300,zn=4e3,Rn="abcde",$n="abc_source",On="source",Vn="abcde_prefs",Un="abcde_controls",Xn="abcde_metadata",Gn="abcde_keypad",jn="abcde_rendering",Yn="abcde_target",Wn="abcde_error",Zn=.1,Jn=3,Kn=.3,Qn=90,er=89,tr=13,nr=8,rr=9,ir=37,ar=39,or="%%setfont-1 Bookman 11\n%%setfont-2 Helvetica-Bold 11",cr="%%deco 1 3 fng 8 1 1 1\n%%deco 2 3 fng 8 1 1 2\n%%deco 3 3 fng 8 1 1 3\n%%deco 4 3 fng 8 1 1 4\n%%deco 5 3 fng 8 1 1 5";return AbcDE.prototype.renderUI=at,AbcDE.prototype.getXValue=yt,AbcDE.prototype.getAuthority=Tt,AbcDE.prototype.getComments=At,AbcDE.prototype.getEnteredCollection=St,AbcDE.prototype.getEnteredAbcD=Ft,AbcDE.prototype.getValidatedCollection=Lt,AbcDE.prototype.getValidatedAbcD=Mt,AbcDE.prototype.setEnteredCollection=st,this}
//# sourceMappingURL=http://nlp.cs.uic.edu/didactyl/abcde/lib